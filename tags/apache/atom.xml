<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: apache | Francis's Octopress Blog]]></title>
  <link href="http://jhjguxin.github.io/tags/apache/atom.xml" rel="self"/>
  <link href="http://jhjguxin.github.io/"/>
  <updated>2013-11-12T19:23:30+08:00</updated>
  <id>http://jhjguxin.github.io/</id>
  <author>
    <name><![CDATA[Francis Jiang]]></name>
    <email><![CDATA[864248765@qq.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[开源许可协议]]></title>
    <link href="http://jhjguxin.github.io/blog/2012/04/11/kai-yuan-xu-ke-xie-yi/"/>
    <updated>2012-04-11T12:37:00+08:00</updated>
    <id>http://jhjguxin.github.io/blog/2012/04/11/kai-yuan-xu-ke-xie-yi</id>
    <content type="html"><![CDATA[<h2>开源许可协议</h2>

<h1>1       目的</h1>


<p align="left">为了让开发人员能够正确合法的使用开源软件，避免因为不小心而触犯到相关法律法规，产生不必要的法律纠纷，现对开源界的几大开原协议进行了翻译和整理。</p>




<h1>2       开源许可协议定义</h1>


<p align="left">自由软件/开源软件是自由的，免费的，源代码开放的，我们可自由下载安装和使用。同时，为了维护作者和贡献者的合法权利，保证这些软件不被一些商业机构或个人窃取，影响软件的发展，开源社区开发出了各种的开源许可协议。其中主要分三大类。</p>


<p align="left">OSI-Approved Open Source：被开放源码组织（www.opensource.org）所批准的开放源码授权协议。如常见的Apache，GPL，LGPL，MIT Licence，都属于OSI-Approved的授权协议，OSI 的要求之一是二进制文件和源代码的自由发放。</p>


<p align="left">Other/Proprietary License：其他的，私有的授权协议。指软件作者提供源代码，但是对软件的分发和发布有其他的限制。</p>


<p align="left">Public Domain：公共域授权。将软件授权为公共域，表示作者完全放弃版权，任何人都可以随意使用。</p>


<p align="left">大部分开源工程都属于OSI-Approved Open Source，下面对常见的License做简单的介绍。</p>




<h1>3       开源许可协议介绍</h1>


<h2>3.1              GNU GPL</h2>


<p align="left">GNU有两种协议其中一种为 General Public Licence (GPL) ，该协议有可能是开源界最常用的许可模式。GPL 保证了所有开发者的权利，同时为使用者提供了足够的复制，分发，修改的权利。主要条款如下：</p>




<ol>
    <li>使用者可以将软件自由的复制到任何地方。</li>
    <li>使用者可以以任何方式自由的分发，下载。注意分发的时候需要提供源代码和二进制文件。</li>
    <li>使用者可以盈利，基于 GPL 的软件允许商业化销售，但不允许封闭源代码。</li>
    <li>如果使用者对遵循 GPL 的软件进行任何改动和/或再次开发并予以发布，则使用者的产品必须继承 GPL 协议，不允许封闭源代码。</li>
</ol>


<p align="left">GPL的出发点是代码的开源/免费使用和引用/修改/衍生代码的开源/免费使用，但不允许修改后和衍生的代码做为闭源的商业软件发布和销售。这也就是为什么我们能用免费的各种linux，包括商业公司的linux和linux上各种各样的由个人，组织，以及商 业软件公司开发的免费软件了。但对于使用GPL协议的开源代码，商业软件或者对代码有保密要求的部门就不适合集成/采用作为类库和二次开发的基础。GPL3.0详见附录<a href="http://jhjguxin.sinaapp.com/wp-admin/post-new.php?post_type=post#_GPL3.0协议">4.1GPL3.0协议</a>。</p>




<h2>3.2              GNU LGPL</h2>


<p align="left">GNU 还有另外一种协议，叫做LGPL（Lesser General Public Licence），它对产品所保留的权利比GPL少，总的来说，LGPL适合那些用于非GPL或非开源产品的开源类库或框架。因为GPL要求，使用了GPL代码的产品必须也使用GPL协议，开发者不允许将GPL代码用于商业产品。而LGPL绕过了这一限制。</p>




<ol>
    <li>基于LGPL的软件也允许商业化销售，但不允许封闭源代码。</li>
    <li>如果您对遵循LGPL的软件进行任何改动和/或再次开发并予以发布，则您的产品必须继承LGPL协议，不允许封闭源代码。但是如果您的程序对遵循LGPL 的软件进行任何连接、调用而不是包含，则允许封闭源代码。</li>
</ol>


<p align="left">如果修改LGPL协议的代码或者衍生，则所有修改的代码，涉及修改部分的额外代码和衍生的代码都必须采用LGPL协议。因此LGPL协议的开源代码很适合作为第三方类库被商业软件引用，但不适合希望以LGPL协议代码为基础，通过修改和衍生的方式做二次开发的商业软件采用。具体条款详见<a href="http://jhjguxin.sinaapp.com/wp-admin/post-new.php?post_type=post#_LGPL_2.1协议">LGPL 2.1协议</a>。</p>




<h2>3.3              BSD</h2>


<p align="left">BSD授权许可证(FreeBSD Copyright Information)具有多种授权许可证。其中BSD 在软件分发方面的限制比别的开源协议（如GNU GPL）要少。该协议有多种版本，最主要的版本有两个，新BSD协议与简单BSD协议，这两种协议经过修正，都和 GPL 兼容，并为开源组织所认可。简单BSD协议主要条款如下：</p>




<ol>
    <li>使用者可以自由的使用，修改源代码，也可以将修改后的代码作为开源或者专有软件再发布。</li>
    <li>如果再发布的产品中包含源代码，则在源代码中必须带有原来代码中的BSD协议。</li>
    <li>如果再发布的只是二进制类库/软件，则需要在类库/软件的文档和版权声明中包含原来代码中的BSD协议。</li>
    <li>不可以用开源代码的作者/机构名字和原来产品的名字做市场推广。</li>
</ol>


<p align="left">新版（也称“三句版”）BSD许可证规定，只要软件的版权申明和许可证的免责条款得以保存，软件可以以任何目的不受限制地分发。该许可证还包含如下条款：即未经许可，不得以软件贡献者的名字为软件的衍生产品做代言。这一条款正是新版BSD许可证与简版BSD许可证之间的主要区别。</p>




<h2>3.4              Apache license. 2.0</h2>


<p align="left">Apache Licence是著名的非盈利开源组织Apache采用的协议。Apache协议 2.0和别的开源协议相比，除了为用户提供版权许可之外，还有专利许可，对于那些涉及专利内容的开发者而言，该协议最适合。以下为Apache Licence的详细介绍：</p>




<ol>
    <li>需要授予使用代码的用户一份Apache Licence。一旦被授予许可，使用者可以无限期的使用。</li>
    <li>如果使用者修改了代码，需要再被修改的文件中说明。</li>
    <li>在延伸的代码中（修改和有源代码衍生的代码中）需要带有原来代码中的协议，商标，专利声明和其他原来作者规定需要包含的说明。</li>
    <li>如果再发布的产品中包含一个Notice文件，则在Notice文件中需要带有Apache Licence。你可以在Notice中增加自己的许可，但不可以表现为对Apache Licence构成更改。</li>
</ol>


<p align="left">以下是该授权关于对工作中使用的说明和限制：</p>


<p align="left">如果在工作中需要应用该授权，请附上如下样板式说明，以[]围起来，来替换你自己的说明信息。（不要包含括弧）文本通常被适当的文件语法格式所包围。我们也建议，一个文件或者类名和特定目的的描述，一起被包含在印刷页上，该印刷页作为一个简单的第三方文档授权证明。下为授权的文档格式。</p>




<blockquote> <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" alt="知识共享许可协议" /></a>
dreamcamp by <a href="http://jhjguxin.github.com/dreamcamp" rel="cc:attributionURL">Francis Jiang</a> is licensed under a <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license">Creative Commons 署名-非商业性使用-相同方式共享 3.0 Unported License</a>.
基于<a href="https://github.com/jhjguxin/dreamcamp" rel="dct:source">github.com</a>上的作品创作。

&nbsp;

## License
(The MIT License)

Copyright © 2009-2012 Francis Jiang

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the ‘Software’), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED ‘AS IS’, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

#### If you want to be awesome.
- Proudly display the 'Powered by Francis Jiang' credit in the footer.
- Add your site to the wiki so we can watch the communi</blockquote>


<h2>3.5    MIT许可协议（MIT License）</h2>


<p align="left">在所有常用的开源许可协议中，MIT许可协议最为简短，可能也最为广泛。它的条款非常松散，比起大部分其它许可协议来说更加宽松。其基本条款如下：</p>




<ol>
    <li>使用者可以随意使用，复制，修改这个软件。没有人能够阻止你在任何工程里使用它，你可以复制任意次数、以任何形式，或按你的愿望修改它。</li>
    <li>使用者可以向外免费发放，或出售。你可以随意的分发它，没有任何限制。</li>
    <li>唯一的限制是使用者必须接受协议条款。即软件必须附带版权和许可协议。</li>
    <li>MIT 协议是目前最少限制的协议。它基本上就是任何人可以对这个协议下的软件的做任何的事情，只要你能认可这个协议。</li>
</ol>


<h2>3.6    知识共享协议</h2>


<p align="left">知识共享（Creative Commons，简称CC）许可协议并非完全的开源许可协议，但设计类项目也常常使用。有各种不同的CC许可协议可供使用，每种授予特定的权利。一个CC许可证包含四个基本部分，每部分即可单独生效，又可联合使用。简述如下：</p>




<ol>
    <li>署名,使用者必须按照作者指定的方式对作品进行署名。除此之外，作品可被复制、分发、拷贝以及以其它方式使用。</li>
    <li>相同方式共享，即只能基于相同的CC许可证对作品进行修改、分发等。</li>
    <li>非商业性，作品可被修改、分发等，但不得以商业为目的进行。关于什么构成商业行为，许可证条款并未提供清晰的定义，因此使用者可能需要在自己的项目里给予澄清。比如说，有人认为“非商业”只是简单地意味着你不能出售作品，也有人认为你不能把作品放到一个带广告的网站上，还有人认为只有当牟利发生时才能称为“商业”。</li>
    <li>禁止衍生，即使用者可以拷贝和分发授权作品，但不得以任何方式修改、或基于原作进行创作。</li>
</ol>


<p align="left">如上所述，CC许可证的各个部分可以联合使用。最为严格的许可证为“署名-非商业-禁止衍生”许可证，即使用者可以自由分享作品，但不得修改或收费，同时必须按照作者指定的方式为作品署名。这对那些一方面希望发布作品，另一方面又希望多多少少保留对作品使用方式的控制权的作者来说，颇为不错。限制最少的CC许可证是“署名”许可证，即只要按照作者指定的方式为作品署名，就可以用作品做任何事。</p>


<p align="left">CC许可证在设计类作品中的应用要比在开发中的应用多，但并没有限制你在开发中使用它，只是要清楚各部分条款的细节。</p>




<h2>3.7    CPL(Common Public Liecense) vesion 1.0</h2>


<p align="left">CPL是IBM 提出的并通过了OSI（Open Source Initiative）批准的开源协议。主要用于一些IBM或跟IBM相关的开源软件 /项目中。如很著名的Java开发环境Eclipse、RIA开发平台Open Laszlo等。</p>


<p align="left">CPL也是一项对商业应用友好的协议。它允许使用者对源码进行任意的使用、复制、分发、传播、展示、修改以及改后做闭源的二次商业发布，这点跟BSD 很类似，也属于自由度比较高的开源协议。但是，需要遵循以下条款：</p>




<ol>
    <li>当使用者将源码的整体或部分再次开源发布的时候，必须继续遵循CPL 开源协议来发布，而不能改用其他协议发布。除非你得到了原“源码”Owner 的 授权。</li>
    <li>CPL协议下，使用者可以将源码不做任何修改来商业发布。但如果要将修改后的源码开源，而且当你再发布的是ObjectCode 的时候，你必须声明它的Source Code是可以获取的，而且要告知获取方法。</li>
    <li>当使用者需要将 CPL 下的源码作为一部分跟其他私有的源码混和着成为一个项目发布的时候，可以将整个项目/产品以私人的协议发布，但要声明哪一部分代码是CPL下的，而且声明那部分代码继续遵循CPL。独立的模块（Separate Module），不需要开源。</li>
</ol>


<h2>3.8              MPL协议</h2>


<p align="left">MPL是The Mozilla Public License的简写，是1998年初Netscape的 Mozilla小组为其开源软件项目设计的软件许可证。MPL许可证出现的最重要原因就是，Netscape公司认为GPL许可证没有很好地平衡开发者对源代码的需求和他们利用源代码获得的利益。同著名的GPL许可证和BSD许可证相比，MPL在许多权利与义务的约定方面与它们相同（因为都是符合OSIA认定的开源软件许可证）。但是，相比而言MPL还有以下几个显著的不同之处:</p>




<ol>
    <li>MPL允许免费重发布、免费修改，但要求修改后的代码版权归软件的发起者。这种授权维护了商业软件的利益，它要求基于这种软件得修改无偿贡献版权给该软件。这样，围绕该软件得所有代码得版权都集中在发起开发人得手中。但MPL是无偿使用得。MPL软件对链接没有要求。</li>
    <li>MPL要求对于经MPL许可证发布的源代码的修改也要以MPL许可证的方式再许可出来，以保证其他人可以在MPL的条款下共享源代码。但是，在MPL许可证中对“发布”的定义是“以源代码方式发布的文件”，这就意味着MPL允许一个企业在自己已有的源代码库上加一个接口，除了接口程序的源代码以MPL许可证的形式对外许可外，源代码库中的源代码就可以不用MPL许可证的方式强制对外许可。这些，就为借鉴别人的源代码用做自己商业软件开的行为留了一个豁口。</li>
    <li>MPL许可证第三条第7款中允许使用者将经过MPL许可证获得的源代码同自己其他类型的代码混合得到自己的软件程序。</li>
    <li>对软件专利的态度，MPL许可证不像GPL许可证那样明确表示反对软件专利，但是却明确要求源代码的提供者不能提供已经受专利保护的源代码（除非他本人是专利权人，并书面向公众免费许可这些源代码），也不能在将这些源代码以开放源代码许可证形式许可后再去申请与这些源代码有关的专利。</li>
    <li>MPL许可证第3条有专门的一款是关于对源代码修改进行描述的规定，就是要求所有再发布者都得有一个专门的文件就对源代码程序修改的时间和修改的方式有描述。</li>
</ol>


<h2>3.9              CDDL协议</h2>


<p align="left">CDDL全称Common Development and Distribution License.它是一个开源许可证书，采用著名的Mozilla公共许可证(MPL)，使其在未做任何改动的情况下可重用。CDDL满足 Open Source Definition 的要求并且已经获得开放源码促进会的认可作为开放源代码的许可证。</p>




<ol>
    <li>MPL作为CDDL的基础。除了保留所有所希望的MPL特性以外(参考前面)，CDDL许可证被设计成可重用的，并做了一些改进使其更加通用。</li>
    <li>对于任何遵守CDDL许可的源文件，以及使用者所做的任何修改都需要共享。但是不必将私有源文件共享。</li>
    <li>CDDL为在此许可下发布的代码提供了清楚的专利许可。这意味着使用者可以使用、修改并且重新发布CDDL授权的代码而不需要担心代码开发者(包括Sun)的任何技术专利。许可证同时包括了一项条款如果有任何人因为他们所提供的代码而对一个开发者进行专利起诉的话，该条款通过废除代码所有权来阻止任何对于开发者的专利指控。</li>
    <li>可以修改，然后遵守CDDL许可将代码重新发布，并可以进行收费。但是，需要遵循CDDL的条款，包括遵守CDDL许可将修改的代码共享。</li>
</ol>


<h1>4       附录</h1>


<h2>4.1     GPL3.0协议</h2>


<h3>4.1.1    导言</h3>


<p align="left">GNU通用公共授权是一份针对软件和其他种类作品的自由的、公共的授权文件。</p>


<p align="left">大多数软件授权申明被设计为剥夺您共享和修改软件的自由。相反地，GNU通用公共授权力图保护您分享和修改自由软件地自由——以确保软件对所有使用者都是自由的。我们，自由软件基金会，对我们的大多数软件使用GNU通用公共授权；本授权同样适用于任何其作者以这种方式发布的软件。您也可以让您的软件使用本授权。</p>


<p align="left">当我们谈论自由软件时，我们指的是行为的自由，而非价格免费。GNU通用公共授权被设计为确保您拥有发布自由软件副本(以及为此收费，如果您希望的话)的自由,确保您能收到源代码或者在您需要时能获取源代码，确保您能修改软件或者将它的一部分用于新的自由软件，并且确保您知道您能做这些事情。</p>


<p align="left">为了保护您的权利，我们需要做出要求，禁止任何人否认您的这些权利或者要求您放弃这些权利。因此，如果您发布此软件的副本或者修改它，您就需要肩负起尊重他人自由的责任。</p>


<p align="left">例如，如果您发布自由软件的副本，无论以免费还是以收费的模式，您都必须把您获得的自由同样的给予副本的接收者。您必须确保他们也能收到或者得到源代码。而且您必须向他们展示这些条款，以使他们知道自己享有这样的权利。</p>


<p align="left">使用GNU通用公共授权的开发者通过两项措施来保护您的权利：（1）声明软件的版权；（2）向您提供本授权文件以给您复制、发布并且/或者修改软件的法律许可。</p>


<p align="left">为了保护软件开发者和作者，通用公共授权明确阐释自由软件没有任何担保责任。如用户和软件作者所希望的，通用公共授权要求软件被修改过的版本必须明确标示，从而避免它们的问题被错误地归咎于先前的版本。</p>


<p align="left">某些设备被设计成拒绝用户安装或运行其内部软件的修改版本，尽管制造商可以安装和运行它们。这从根本上违背了通用公共授权保护用户能修改软件的自由的宗旨。此类滥用本授权的系统模式出现在了最让人无法接受的个人用户产品领域。因此，我们设计了这个版本的通用公共授权来禁止那些产品的侵权行为。如果此类问题在其他领域大量出现，我们准备好了在将来的通用公共授权版本里扩展这项规定，以保护用户的自由。</p>


<p align="left">最后，每个程序都经常受到软件专利的威胁。政府不应该允许专利权限制通用计算机软件的发展和使用，但是在政府确实允许这种事情的地区，我们希望避免应用于自由软件的专利权使该软件有效私有化的危险。为了阻止这样的事情的发生，通用公共授权确保没有人能够使用专利权使得自由软件非自由化。</p>


<p align="left">以下是复制，发布和修改软件的详细条款和条件。</p>




<h3>4.1.2    条款和条件</h3>


<h4>4.1.2.1 定义</h4>


<p align="left">“本授权”指GNU通用公共授权第三版。</p>


<p align="left">“版权”一词同样指适用于其他产品如半导体防护罩等的保护版权的法律。</p>


<p align="left">“本程序”指任何在本授权下发布的受版权保护的作品。被授权人称为“您”。“被授权人”和“版权接受者”可以是个人或组织。</p>


<p align="left">“修改”作品是指从软件中拷贝或者做出全部或一丁点儿的修改，这不同于逐字逐句的复制，是需要版权许可的。修改成果被称为先前作品的“修改版本”或者“基于”先前作品的软件。</p>


<p align="left">“覆盖程序”指未被修改过的本程序或者基于本程序的程序。</p>


<p align="left">“传播”程序指使用该程序做任何如果没有许可就会在适用的版权法下直接或间接侵权的事情，不包括在电脑上执行程序或者是做出您不与人共享的修改。传播包括复制，分发（无论修改与否），向公众共享，以及在某些国家的其他行为。</p>


<p align="left">“发布”作品指任何让其他组织制作或者接受副本的传播行为。仅仅通过电脑网络和一个用户交流，且没有发送程序拷贝的行为不是发布。</p>


<p align="left">一个显示“适当的法律通告”的交互的用户接口应包括这样一个方便而显著的可视部件，它具有以下功能：（1）显示一个合适的版权通告；（2）告诉用户对本程序没有任何担保责任（除非有担保明确告知），受权人可以在本授权下发布本程序，以及如果阅读本授权协议的副本。如果该接口显示了一个用户命令或选项列表，比如菜单，该列表中的选项需要符合上述规范。</p>




<h4>4.1.2.2  源代码</h4>


<p align="left">“源代码”指修改程序常用的形式。“目标代码”指程序的任何非源代码形式。</p>


<p align="left">“标准接口”有两种含义,一是由标准组织分支定义的官方标准；二是针对某种语言专门定义的众多接口中，在该类语言的开发者中广为使用的那种接口。</p>


<p align="left">可执行程序的“系统库”不是指整个程序，而是指任何包含于主要部件但不属于该部件的部分，并且只是为了使能该部件而开发，或者为了实现某些已有公开源代码的标准接口。“主要部件”在这里指的是执行程序的特定操作系统（如果有的话）的主要的关键部件（内核，窗口系统等），或者生成该可执行程序时使用的编译器，或者运行该程序的目标代码解释器。</p>


<p align="left">目标代码中的程序“对应的源代码”指所有生成，安装，（对可执行程序而言）运行该目标代码和修改该程序所需要的源代码，包括控制这些行为的脚本。但是，它不包括程序需要的系统库，通用目的的工具，以及程序在完成某些功能时不经修改地使用的那些不包括在程序中的普遍可用的自由软件。例如，对应的源代码包括与程序的源文件相关的接口定义文件，以及共享库中的源代码和该程序设计需要的通过如频繁的数据交互或者这些子程序和该程序其他部分之间的控制流等方式获得的动态链接子程序。</p>


<p align="left">对应的源代码不需要包含任何拥护可以从这些资源的其他部分自动再生的资源。</p>


<p align="left">源代码形式的程序对应的源代码定义同上。</p>




<h4>4.1.2.3 基本的许可</h4>


<p align="left">所有在本授权协议下授予的权利都是对本程序的版权而言，并且只要所述的条件都满足了，这些授权是不能收回的。本授权明确的确认您可以不受任何限制地运行本程序的未修改版本。运行一个本授权覆盖的程序获得的结果只有在该结果的内容构成一个覆盖程序的时候才由本授权覆盖。本授权承认您正当使用或版权法规定的其它类似行为的权利。</p>


<p align="left">只要您的授权仍然有效，您可以无条件地制作，运行和传播那些您不发布的覆盖程序。只要您遵守本授权中关于发布您不具有版权的资料的条款，您可以向别人发布覆盖程序，以要求他们为您做出专门的修改或者向您提供运行这些程序的简易设备。那些为您制作或运行覆盖程序的人作为您专门的代表也必须在您的指示和控制下做到这些，请禁止他们在他们和您的关系之外制作任何您拥有版权的程序的副本。当下述条件满足的时候，在任何其他情况下的发布都是允许的。转授许可证授权是不允许的，第10节让它变的没有必要了。</p>




<h4>4.1.2.4 保护用户的合法权利不受反破解法侵犯</h4>


<p align="left">在任何实现1996年通过的世界知识产权组织版权条约第11章中所述任务的法律，或者是禁止或限制这种破解方法的类似法律下，覆盖程序都不会被认定为有效的技术手段的一部分。</p>


<p align="left">当您发布一个覆盖程序时，您将放弃任何禁止技术手段破解的法律力量，甚至在本授权关于覆盖程序的条款下执行权利也能完成破解。同时，您放弃任何限制用户操作或修改该覆盖程序以执行您禁止技术手段破解的合法权利的企图。</p>




<h4>4.1.2.5 发布完整副本</h4>


<p align="left">你可以通过任何媒介发布本程序源代码的未被修改过的完整副本，只要您显著而适当地在每个副本上发布一个合适的版权通告；保持完整所有叙述本授权和任何按照第7节加入的非许可的条款；保持完整所有的免责申明；并随程序给所有的接受者一份本授权。</p>


<p align="left">您可以为您的副本收取任何价格的费用或者免费，你也可以提供技术支持或者责任担保来收取费用。</p>




<h4>4.1.2.6 发布修改过的源码版本</h4>


<p align="left">您可以在第4节的条款下以源码形式发布一个基于本程序的软件，或者从本程序中制作该软件需要进行的修改，只要您同时满足所有以下条件：</p>




<ol>
    <li>制作的软件必须包含明确的通告说明您修改了它，并给出相应的修改日期。</li>
    <li>制作的软件必须包含明确的通告，陈述它在本授权下发布并指出任何按照第7节加入的条件。这条要求修改了第4节的“保持所有通知完整”的要求。</li>
    <li>您必须把整个软件作为一个整体向任何获取副本的人按照本授权协议授权。本授权因此会和任何按照第7节加入的条款一起，对整个软件及其所有部分，无论是以什么形式打包的，起法律效力。本授权不允许以其他任何形式授权该软件，但如果您个别地收到这样的许可，本授权并不否定该许可。</li>
    <li>如果您制作的软件包含交互的用户接口，每个用户接口都必须显示适当的法律通告；但是，如果本程序包含没有显示适当的法律通告的交互接口，您的软件没有必要修改他们让他们显示。如果一个覆盖程序和其他本身不是该程序的扩展的程序的联合体，这样的联合的目的不是为了在某个存储或发布媒体上生成更大的程序，且联合体程序和相应产生的版权没有用来限制程序的使用或限制单个程序赋予的联合程序的用户的合法权利的时候，这样的联合体就被称为“聚集体”。在聚集体中包含覆盖程序并不会使本授权应用于该聚集体的其他部分。</li>
</ol>


<h4>4.1.2.7 发布非源码形式的副本</h4>


<p align="left">您可以在第4,5节条款下以目标代码形式发布程序，只要您同时以一下的一种方式在本授权条款下发布机器可读的对应的源代码：</p>




<ol>
    <li>在物理产品（包括一个物理的发布媒介）中或作为其一部分发布目标代码，并在通常用于软件交换的耐用的物理媒介中发布对应的源代码。</li>
    <li>在物理产品（包括一个物理的发布媒介）中或作为其一部分发布目标代码，并附上有效期至少3年且与您为该产品模型提供配件或客户服务的时间等长的书面承诺，给予每个拥有该目标代码的人（1）要么在通常用于软件交换的耐用物理媒介中，以不高于您执行这种源码的发布行为所花费的合理费用的价格，一份该产品中所有由本授权覆盖的软件的对应的源代码的拷贝；（2）要么通过网络服务器免费提供这些对应源代码的访问。</li>
    <li>单独地发布目标代码的副本，并附上一份提供对应源代码的书面承诺。这种行为只允许偶尔发生并不能盈利，且在您收到的目标代码附有第6节b规定的承诺的时候。</li>
    <li>在指定的地点（免费或收费地）提供发布的目标代码的访问并在同样的地点以不增加价格的方式提供对应源代码的同样的访问权。您不需要要求接收者在复制目标代码的时候一道复制对应的源代码。如果复制目标代码的地点是网络服务器，对应的源代码可以在另外一个支持相同复制功能的服务器上（由您或者第三方运作），只要您在目标代码旁边明确指出在哪里可以找到对应的源代码。无论什么样的服务器提供这些对应的源代码，您都有义务保证它在任何有需求的时候都可用，从而满足本条规定。</li>
    <li>用点对点传输发布目标代码，您需要告知其他的节点目标代码和对应的源代码在哪里按照第6节d的条款向大众免费提供。</li>
</ol>


<p align="left">目标代码中可分离的部分，其源代码作为系统库不包含在对应的源代码中，不需要包含在发布目标代码的行为中。</p>


<p align="left">“用户产品”指（1）“消费品”，即通常用于个人的、家庭的或日常目的的有形个人财产；或者（2）任何为公司设计或销售却卖给了个人的东西。在判断一个产品是否消费品时，有疑点的案例将以有利于覆盖面的结果加以判断。对特定用户接收到的特定产品，“正常使用”指该类产品的典型的或通常的使用，无论该用户的特殊情况，或者该用户实际使用该产品的情况，或者该产品要求的使用方式如何。一个产品是否是消费品与该产品是否具有实质的经济上的、工业的或非消费品的用处无关，除非该用处是此类产品唯一的重要使用模式。</p>


<p align="left">用户产品的“安装信息”指从对应源码的修改版本安装和运行该用户产品中包含的覆盖程序的修改版本所需要的任何方法、过程、授权密钥或其他信息。这些信息必须足以保证修改后的目标代码不会仅仅因为被修改过而不能继续运行。</p>


<p align="left">如果您在本节条款下在用户产品中，或随同，或专门为了其中的使用，发布目标代码程序，而在发布过程中用户产品的所有权和使用权都永久地或在一定时期内（无论此项发布的特点如何）传递给了接收者，在本节所述的条款下发布的对应的源代码必须包含安装信息。但是如果您或者任何第三方组织都没有保留在用户产品上安装修改过的目标代码的能力（比如程序被安装在了ROM上），那么这项要求不会生效。</p>


<p align="left">提供安装信息的要求并没有要求为接收者修改或安装过的程序，或者修改或安装该程序的用户产品，继续提供支持服务、担保或升级。当修改本身实际上相反地影响了网络的运行，或者违反了网络通信的规则和协议时，网络访问可以被拒绝。</p>


<p align="left">根据本节发布的对应源代码和提供的安装信息必须以公共的文件格式发布（并附加一个该类型文档的实现方法以源码形式向公众共享），解压缩、阅读或复制这些信息不能要求任何密码。</p>




<h4>4.1.2.8 附加条款</h4>


<p align="left">“附加许可”是通过允许一些本授权的特例来补充本授权的条款。只要它们在使用法律下合法，对整个程序都生效的附加许可就应当被认为是本授权的内容。如果附加许可只是对本程序的一部分生效，那么该部分可以在那些许可下独立使用，但整个程序是在本授权管理下，无论附加许可如何。</p>


<p align="left">当您发布覆盖程序的副本时，您可以选择删除该副本或其部分的任何附加许可。（当您修改程序时，附加许可可能要求在某些情况下将自身删除）。您可以把附加许可放在材料上，加入到您拥有或能授予版权许可的覆盖程序中。</p>


<p align="left">尽管本授权在别处有提供，对于您加入到程序中的材料，您可以（如果您由该材料的版权所有者授权的话）用以下条款补充本授权：</p>




<ol>
    <li>拒绝担保责任或以与本授权第15和16小节条款不同的方式限制责任；</li>
    <li> 要求保留特定的合理法律通告，或者该材料中或包含于适当法律通告中的该程序的作者贡献；</li>
    <li>禁止误传该材料的来源，或者要求该材料的修改版本以合理的方式标志为与原版本不同的版本；</li>
    <li>限制以宣传为目的的使用该材料作者或授权人的姓名；</li>
    <li>降低授权级别以在商标法下使用一些商品名称，商标或服务标记；</li>
    <li>要求任何发布该材料（或其修改版本）的人用对接收者的责任假设合同对授权人和材料作者进行保护，避免任何这样的假设合同直接造成授权人和作者的责任。</li>
</ol>


<p align="left">所有其他不许可的附加条款都被认为是第10节中的“进一步的约束”。如果您收到的程序或者其部分，声称自己由本授权管理，并补充了进一步约束，那么您可以删除这些约束。如果一个授权文件包含进一步约束，但是允许再次授权或者在本授权下发布，只要这样的进一步的约束在这样的再次授权或发布中无法保留下来，您就可以在覆盖程序中加入该授权文件条款管理下的材料。</p>


<p align="left">如果您依据本小节向覆盖程序添加条款,您必须在相关的源码文件中加入一个应用于那些文件的附加条款的声明或者指明在哪里可以找到这些条款的通告。</p>


<p align="left">附加的条款，无论是许可的还是非许可的条款，都可以写在一个单独的书面授权中，或者申明为例外情况；这两种方法都可以实现上述要求。</p>




<h4>4.1.2.9 终止授权</h4>


<p align="left">您只有在本授权的明确授权下才能传播或修改覆盖程序。任何其它的传播或修改覆盖程序的尝试都是非法的，并将自动终止您在本授权下获取的权利（包括依据第11节第三段条款授予的任何专利授权）。</p>


<p align="left">然而，如果您停止违反本授权，那么您从某个特定版权所有者处获取的授权许可能够以以下方式恢复（a）您可以暂时地拥有授权，直到版权所有者明确地终止您的授权；（b）如果在您停止违反本授权后的60天内，版权所有者没有以某种合理的方式告知您的违背行为，那么您可以永久地获取该授权。</p>


<p align="left">进一步地，如果某个版权所有者以某种合理的方式告知您违反本授权的行为，而这是您第一次收到来自该版权所有者的违反本授权的通知（对任何软件），并且在收到通知后30天内修正了违反行为，那么您从该版权所有者处获取的授权将永久地恢复。</p>


<p align="left">当您的授权在本节条款下被终止时，那些从您那获取授权的组织只要保持不违反本授权协议，其授权就不会被终止。您只有在授权被版权所有者恢复了之后才有资格依据第10节的条款获取该材料的新的授权。</p>




<h4>4.1.2.10         获取副本不需要接受本授权</h4>


<p align="left">您不需要为了接收或运行本程序的副本而接受本授权协议。仅仅是因为点对点传输获取副本引起传播行为，也不要求您接受本授权协议。然而，除了本授权外，任何授权协议都不能授予您传播或修改覆盖程序的许可。因此，如果您修改或者传播了本程序的副本，那么您就默认地接受了本授权。</p>




<h4>4.1.2.11         下游接收者的自动授权</h4>


<p align="left">每次您发布覆盖程序，接收者都自动获得一份来自原授权人的依照本授权协议运行、修改和传播该程序的授权。依据本授权，您不为执行任何第三方组织的要求负责。</p>


<p align="left">“实体事务”指转移一个组织的控制权或全部资产，或者拆分组织，或者合并组织的事务。如果覆盖程序的传播是实体事务造成的，该事务中每一个接收本程序副本的组织都将获取一份其前身拥有的或者能够依据前面的条款提供的任何授权，以及从其前身获取程序对应的源代码的权利，如果前身拥有或以合理的努力能够获取这些源代码的话。</p>


<p align="left">您不可以对从本授权协议获取或确认的权利的执行强加任何约束。比如，您不可以要求授权费用，版税要求或对从本授权获取的权利的执行收取任何费用。您不可以发起诉讼（包括联合诉讼和反诉）声称由于制作、使用、销售、批发或者引进本程序或其任何一部分而侵犯了任何专利权。</p>




<h4>4.1.2.12         专利权</h4>


<p align="left">“贡献者”是在本授权下授予本程序或者本程序所基于的程序的使用权的版权所有者。这样的程序被成为贡献者的“贡献者版本”。</p>


<p align="left">一个贡献者的“实质的专利申明”是该贡献者所占有和控制的全部专利，无论已经获得的还是在将来获得的，那些可能受到某种方式侵犯的专利权。本授权允许制作、使用和销售其贡献者版本，但不包括那些只会由于对贡献者版本进一步的修改而受到侵犯的专利的申明。为此，“控制”一词包括以同本授权要求一致的方式给予从属授权的权利。</p>


<p align="left">每个贡献者在该贡献者的实质的专利申明下授予您非独家的，全世界的，不需要版税的专利授权，允许您制作、使用、销售、批发、进口以及运行、修改和传播其贡献者版本内容。</p>


<p align="left">在以下三个自然段中，“专利授权”指任何形式表达的不执行专利权的协议或承诺（例如使用专利权的口头许可，或者不为侵犯专利而起诉的契约）。向一个组织授予专利授权指做出这样的不向该组织提出强制执行专利权的承诺。</p>


<p align="left">如果您在自己明确知道的情况下发布基于某个专利授权的覆盖程序，而这个程序的对应的源代码并不能在本授权条款下通过网络服务器或其他有效途径免费地向公众提供访问，您必须做到：（1）使对应的源代码按照上述方法可访问；或者（2）放弃从该程序的专利授权获取任何利益；或者（3）以某种与本授权要求一致的方法使该专利授权延伸到下游的接收者。“在自己明确知道的情况下”指您明确地知道除了获取专利授权外，在某个国家您传播覆盖程序的行为，或者接收者使用覆盖程序的行为，会由于该专利授权而侵犯一个或多个在该国可确认的专利权，而这些专利权您有足够的理由相信它们是有效的。</p>


<p align="left">在依照或者涉及某一次事务或安排时，如果您通过获取发布或传播覆盖程序的传输版本，并给予接收该覆盖程序的某些组织专利授权，允许他们使用，传播，修改或者发布该覆盖程序的特殊版本，那么您赋予这些组织的专利授权将自动延伸到所有该覆盖程序及基于该程序的作品的接收者。</p>


<p align="left">一份专利授权是“有偏见的”，如果它没有在自身所覆盖的范围内包含，禁止行使，或者要求不执行一个或多个本授权下明确认可的权利。以下情况，您不可以发布一个覆盖程序：如果您与软件发布行业的第三方组织有协议，而该协议要求您根据该程序的发布情况向该组织付费，同时该组织在你们的协议中赋予任何从您那里获得覆盖软件的组织一份有偏见的专利授权，要么（a）连同您所发布的副本（或者从这些副本制作的副本）；要么（b）主要为了并连同某个的产品或者包含该覆盖程序的联合体。如果您签署该协议或获得该专利授权的日期早于2007年3月28日，那么您不受本条款约束。</p>


<p align="left">本授权的任何部分不会被解释为拒绝或者限制任何暗含的授权或其他在适用专利权法下保护您的专利不受侵犯的措施。</p>




<h4>4.1.2.13         不要放弃别人的自由</h4>


<p align="left">如果您遇到了与本授权向矛盾的情况（无论是法庭判决，合同或者其他情况），它们不能使您免去本授权的要求。如果您不能同时按照本授权中的义务和其他相关义务来发布覆盖程序，那么您将不能发布它们。比如，如果您接受了要求您向从您这里或许本程序的人收取版税的条款，您唯一能够同时满足本授权和那些条款的方法是完全不要发布本程序。</p>




<h4>4.1.2.14         和GNU Affero通用公共授权一起使用</h4>


<p align="left">尽管本协议有其他防备条款，您有权把任何覆盖程序和基于第三版GNU Affero通用公共授权的程序链接起来，并且发布该联合程序。本授权的条款仍然对您的覆盖程序有效，但是GNU Affero通用公共授权第13节关于通过网络交互的要求会对整个联合体有效。</p>




<h4>4.1.2.15         本授权的修订版</h4>


<p align="left">自由软件基金会有时候可能会发布GNU通用软件授权的修订版本和/或新版本。这样的新版本将会和现行版本保持精神上的一致性，但是可能会在细节上有所不同，以处理新的问题和情况。</p>


<p align="left">每个版本都有一个单独的版本号。如果本程序指出了应用于本程序的一个特定的GNU通用公共授权版本号“以及后续版本”，您将拥有选择该版本或任何由自由软件基金会发布的后续版本中的条款和条件的权利。如果本程序没有指定特定的GNU通用公共授权版本号，那么您可以选择任何自由软件基金会已发布的版本。</p>


<p align="left">如果本程序指出某个代理可以决定将来的GNU通用公共授权是否可以应用于本程序，那么该代理的接受任何版本的公开称述都是您选择该版本应用于本程序的永久认可。</p>


<p align="left">后续的授权版本可能会赋予您额外的或者不同的许可。但是，您对后续版本的选择不会对任何作者和版权所有者强加任何义务。</p>




<h4>4.1.2.16         免责申明</h4>


<p align="left">在适用法律许可下，本授权不对本程序承担任何担保责任。除非是书面申明，否则版权所有者和/或提供本程序的第三方组织，“照旧”不承担任何形式的担保责任，无论是承诺的还是暗含的，包括但不限于就适售性和为某个特殊目的的适用性的默认担保责任。有关本程序质量与效能的全部风险均由您承担。如本程序被证明有瑕疵，您应承担所有必要的服务、修复或更正的费用。</p>




<h4>4.1.2.17         责任范围</h4>


<p align="left">除非受适用法律要求或者书面同意，任何版权所有者，或任何依前述方式修改和/或发布本程序者，对于您因为使用或不能使用本程序所造成的一般性、特殊性、意外性或间接性损失，不负任何责任（包括但不限于，资料损失，资料执行不精确，或应由您或第三人承担的损失，或本程序无法与其他程序运作等），即便该版权所有者或其他组织已经被告知程序有此类损失的可能性也是如此。</p>




<h4>4.1.2.18         第15和16节的解释</h4>


<p align="left">如果上述免责申明和责任范围不能按照地方法律条款获得法律效力，复审法庭应该采用最接近于完全放弃关于本程序的民事责任的法律，除非随同本程序的责任担保或责任假设合同是收费的。</p>




<h3>4.1.3    如何在您的新程序中应用这些条款？</h3>


<p align="left">如果您开发了一个新程序，并且希望能够让它尽可能地被大众使用，达成此目的的最好方式就是让它成为自由软件。任何人都能够依据这些条款对该软件再次发布和修改。</p>


<p align="left">为了做到这一点，请将以下声明附加到程序上。最安全的作法，是将声明放在每份源码文件的起始处，以有效传达无担保责任的讯息；且每份文件至少应有「版权」列以及本份声明全文位置的提示。</p>


<p align="left">&lt;用一行描述程序的名称与其用途简述&gt;</p>


<p align="left">版权所有(C) &lt;年份&gt;&lt;作者姓名&gt;</p>


<p align="left">本程序为自由软件；您可依据自由软件基金会所发表的GNU通用公共授权条款，对本程序再次发布和/或修改；无论您依据的是本授权的第三版，或（您可选的）任一日后发行的版本。</p>


<p align="left">本程序是基于使用目的而加以发布，然而不负任何担保责任；亦无对适售性或特定目的适用性所为的默示性担保。详情请参照GNU通用公共授权。</p>


<p align="left">您应已收到附随于本程序的GNU通用公共授权的副本；如果没有，请参照&lt;http://www.gnu.org/licenses/&gt;.同时附上如何以电子及书面信件与您联系的资料。</p>


<p align="left">如果程序进行终端交互方式运作，请在交互式模式开始时，输出以下提示：</p>


<p align="left">&lt;程序&gt; 版权所有(C) &lt;年份&gt; &lt;作者姓名&gt;</p>


<p align="left">本程序不负任何担保责任，欲知详情请键入'show w'。</p>


<p align="left">这是一个自由软件，欢迎您在特定条件下再发布本程序；欲知详情请键入'show c'。</p>


<p align="left">所假设的指令'show w'与'show c'应显示通用公共授权的相对应条款。当然，您可以使用'show w'与'show c'以外的指令名称；对于图形用户界面，您可以用“关于”项代实现此功能。</p>


<p align="left">如有需要，您还应该取得您的雇主（若您的工作为程序设计師）或学校就本程序所签署的“版权放弃承诺书”。欲知这方面的详情，以及如何应用和遵守GNU通用公共授权，请参考&lt;http://www.gnu.org/licenses/&gt;</p>


<p align="left">GNU通用公共授权并不允许您将本程序合并到私有的程序中。若您的程序是一个子程序库，您可能认为允许私有的应用程序链接该库会更有用。如果这是您所想做的，请使用GNU松弛通用公共授权代替本授权。但这样做之前，请阅读&lt;http://www.gnu.org/philosophy/why-not-lgpl.html&gt;</p>




<h2>4.2     LGPL 2.1协议</h2>


<h3>4.2.1    导言</h3>


<p>大多数软体许可证决意剥夺您共享和修改软体的自由。相反的，GNU 通用公共许可证力图保证您共享和修改自由软体的自由 —— 保证自由软体对所有使用者都是自由的。</p>

<p>这个许可证，较宽松公共许可证，适用于一些由自由软体基金会与其他决定使用此许可证的软体作者，所特殊设计的软体套件 —— 象是函数库。您也可以使用它，但我们建议您事先仔细考虑，基于以下的说明是否此许可证或原来的通用公共许可证在任何特殊情况下均为较好的方案。</p>

<p>当我们谈到自由软体时，我们所指的是自由，而不是价格。我们的 GNU 通用公共许可证是设计用以确保使您有发布自由软体备份的自由（如果您愿意，您可以对此项服务收取一定的费用）；确保您能收到程式原始码或者在您需要时能得到它；确保您能修改软体或将它的一部分用于新的自由软体；而且还确保您知道您可以做上述的这些事情。</p>

<p>为了保护您的权利，我们需要作出限制：禁止任何人否认您上述的权利，或者要求您放弃这些权利。如果您发布软件的副本，或者对之加以修改，这些规定就转化为您的责任。</p>

<p>例如，如果您发布此函数库的副本，不管是免费还是收取费用，您必须将您享有的一切权利给予接受者；您必须确保他们也能收到或得到原始程式码；如果您将此函数库与其他的程式码连结，您必须提供完整的目的对象文件和程序(object file)给接受者，则当他们修改此函数库并重新编译过后，可以重新与目的档连结。您并且要将这些条款给他们看，使他们知道他们有这样的权利。</p>

<p>我们采取两项措施来保护您的权利: （1）用版权来保护函数库。并且，（2）我们提供您这份许可证，赋予您复制，发布和（或）修改这些函数库的法律许可。</p>

<p>为了保护每个发布者，我们需要非常清楚地让每个人明白，自由函数库是没有担保责任的。如果由于某人修改了函数库，并继续加以传播，我们需要它的接受者明白：他们所得到的并不是原始的版本。故由其他人引入的任何问题，对原作者的声誉将不会有任何的影响。</p>

<p>最后，由于软体专利不断地威胁自由软体的存在，我们希望商业公司无法藉由自专利持有者取得一个受限的许可证，而有效地限制自由软体的使用者。因此，我们坚持一个函数库所能取得的任何专利，必须与本许可证所声明的“完全自由使用”一致。</p>

<p>大部分的 GNU 软体，包括一些函数库，是受到原来的 GNU 通用公共许可证的保护。本许可证， GNU 较宽松通用公共许可证，适用于特殊设计的函数库，且与原来的通用公共许可证有很大的不同。我们在特定的函数库中使用它，以准许非自由的程式可以与这些函数库连结。当一个程式与一个函数库连结，不论是静态连结或使用共享函数库，二者的结合可以合理地说是结合的作品，一个原来的函数库的衍生品。因此，原来的通用公共许可证只有在整个结合品满足其自由的标准时，才予许连结。较宽松通用公共许可证则以更宽松的标准允许其他程式码与本函数库连结。</p>

<p>我们称此许可证 &ldquo;较宽松&rdquo; 通用公共许可证，是因为它比起原来的通用公共许可证对使用者的自由做到较少的保护。在与非自由软体竞争时，它也提供其他自由软体的写作者较少的优势。这些不利之处正是我们使用原来的通用公共许可证于许多函数库的理由。然而，较宽松的许可证可在某些特殊场合下带来好处。例如，在少数情况下，可能会有特殊的需要而鼓励大家尽可能广泛地使用特定的函数库，因而使它成为实际上的标准。为了达到此目标，必须允许非自由的程式使用此函数库。一个较常发生的情况是一个自由的函数库与一个被广泛使用的非自由函数库做相同的工作，在此情况下，限制只有自由软体可以使用此自由函数库不会有多少好处，故我们如用了较宽松通用公共许可证。</p>

<p>在其他情况下，允许非自由程式使用特定的函数库，可以让更多的人们使用自由软体的大部分。例如，允许非自由程式使用 GNU C 函数库可以让更多的人们使用整个 GNU 作业系统，以及它的变形，GNU/Linux 作业系统。</p>

<p>尽管较宽松通用共公许可证对使用者的自由是较少的保护的，它却能确保与此函数库连结的程式的使用者拥有自由，而且具有使用修改过的函数库版本来执行该程式的必要方法。</p>

<p>以下是复制、发布、以及修改的精确条款与条件。请注意 &ldquo;基于函数库的作品&rdquo; 以及 &ldquo;使用函数库的作品&rdquo; 之间的差异：前者包含来自函数库修改过的原始码；而后者则必须与函数库结合才能执行。</p>

<h3>4.2.2    条款和条件</h3>


<h4>4.2.2.1 定义</h4>


<ol>
    <li>本许可证适用于任何软体函数库，或其他包含了由版权所有者加入的注意事项的程式，或其他有公信力的团体宣称其程式可以在较宽松通用公共许可证 (也称之为 "本许可证") 的条款下发布。每一位许可证接受者以 "您" 来称呼。</li>
    <li>一个 "函数库" 意指一些软体函数的集合，以及或准备好的资料以方便与应用程式 (其使用了其中某些函数与资料) 连结形成可执行的程式。以下，"函数库" 一词指的是任何在本条款下发布的这一类软体函数库或作品，个 "基于本函数库的作品" 意指函数库或任何在版权法下的衍生作品：也就是说，一个包含了本函数库或其一部分的作品，可以是原封不动的，或经过修改的，和/或直接翻译成其他语言的。 (在下文中，翻译是不受限地包含在 "修改" 的条款中。)</li>
    <li>作品的 "原始码" 意指对作品进行修改最优先择取的形式。对函数库而言，完整的原始码意指所有模组的所有原始程式，加上有关的介面的定义，加上控制函数库的安装和编译的 script。</li>
    <li>本许可证条款不适用于复制，发布和修改以外的活动。这些活动超出这些条款的范围。使用本函数库来执行本程式的动作不受条款的限制，而程式的输出只有在其内容所构成的作品是基于本函数库时 (与在什么样的工具中使用本函数库来输出无关) ，这一条款才适用。以上是否为真则取决于本函数库具体用来做什么。</li>
    <li>只要您在每一程式副本上明显和恰当地宣告版权声明和不承担担保的声明，并保持此许可证的声明和没有担保的声明完整无损，并和程式一起给其他每位程式接受者一份许可证的副本，您就可以用任何媒体复制和发布您收到的函数库的完整原始码。您可以为转让副本的实际行动收取一定费用。您也可以选择提供担保以换取一定的费用。</li>
    <li>只要您同时满足下面的所有条件，您就可以按前面第一款的要求修改函数库的一个或几个副本或它的任何部分，以此形成基于此函数库的作品，并且复制和发布这一经过修改的程式或作品:</li>
</ol>


<h4>4.2.2.2  条款</h4>


<p>1)     被修改的作品本身必须是一个软体函数库。</p>

<p>2)     您必须在修改过的档案中附有明确的说明：</p>

<p>3)     您修改了此一档案及任何修改的日期。您必须让整个作品允许第三方在此许可证条款下可以免费使用。</p>

<p>4)     如果修改过的函数库其某个设备使用到了「使用本函数库的应用程式」所提供的函数或资料表格，却不是当此设备被呼叫时以参数列传入时，则您必须确实做到，当应用程式不提供这样的函数或表格时，则此设备依旧能工作，且其执行的任何目的仍然有意义。</p>

<p>5)     (例如，一个函数库的函数用来计算平方根，其目的是有完整的定义且与应用程式是无关的。因此， 2d 小节要求任何本函数会使用的，由应用程式所提供的函数或表格必须是选择性的：如果应用程式不提供的话，则计算平方根的函数必须依旧能计算平方根)</p>

<p>这些要求适用于整个修改过的作品。如果能够确定作品的一部分并非本函数库的衍生产品，且可以合理地单独考虑并将它与原作品分开的话，则当您将它作为独立的作品发布时，它不受此许可证和其条款的约束。但是当您将这部分与基于本函数库的作品一同发布时，则整个套件将受到本许可证条款约束，其对于其他许可证持有人的使用范围扩大到整个产品，也就是套件的每个部分，不管它是谁写的。</p>

<p>因此，本条款的意图不在于索取权利，或剥夺完全由您完成的作品的权利，而是履行权利来控制基于本函数库的集体作品或衍生作品的发布。 此外，将与本函数库无关的作品和本函数库 (或基于本函数库的作品) 一起放在贮存媒体或发布媒体的同一卷上，并不导致将其他作品置于此许可证的约束范围之内。</p>

<ol>
    <li>对于一个函数库的副本，您可以选择性地使用原来的 GNU 通用公共许可证上的条款来取代本许可证上的条款。如果您要这么做，您必须修改所有的参考到本许可证的注意事项，使它们指向原来的 GNU 通用公共许可证，第二版，以取代本许可证(如果有比第二版的原来的 GNU 通用公共许可证更新的版本出现的话，则如果您愿意的话可以特别指明使用新版)。请不要对这些注意事项做出其他的改变。一旦在一个副本上做了这样的改变，则该副本就无法撤回这样的改变，故原来的 GNU 通用公共许可证将适用于所有后续的副本以及由此副本衍生出来的作品。此一选择性适用于当您想要将一部分的函数库原始码复制到一个非函数库的程式使用时。</li>
    <li>您可以以目标码或可执行形式复制或发布本函数库 (或符合第 2 款，基于本函数库的作品)，只要您遵守前面的第 1、2 款，并同时提供完整的相关机器可读的原始码，而这些原始码必须在前面的第 1 与第 2 款条件下，在一般习惯上用来做软体交换的媒体上发布。如果所发布的目标码是由指定的地点提供拷贝索取，那么由同一地点所提供等价的原始码拷贝索取可以算作原始码的发布，即使第三方不强求与目标码一起复制原始码。</li>
    <li>一个程式若包含不经任何部分修改的函数库，但却是设计经由编译或连结的方式与本函数库一同工作者，称之为 "使用函数库的作品"。这样的一个作品，严格地说，并非本函数库的衍生作品，因而不在本许可证的范围之内。然而，将 "使用函数库的作品" 与本函数库连结而产生可执行程式，则是本函数库的衍生品 (因为它包函了本函数库的一部分)，而不是 "使用函数库的作品"，因此其可执行程式包含在本许可证的范围内。第 7 款说明了发布此可执行程式的条款。</li>
</ol>


<p>当 &ldquo;使用函数库的作品&rdquo; 使用了函数库部分的标头档内容时，则此作品即使其原始码不属于本函数库的衍生品，但其目标码仍然是。这一点是否为真特别在是否本作品可以在不需要本函数库即可连结，或者是否该作品本身也是一个函数库时特别明显。</p>

<p>如果这样的目标档只使用数字参数、资料结构层级与附属品、以及小巨集和小内□式 (小于或等于十行) ，则此目标档的使用是不受限的，不论是否它是合法的衍生作品。 (但可执行程式若包函此目标档以及一部分的函数库，仍然将在第 7款的规定下)</p>

<p>否则的话，如果本作品是本函数库的衍生品，您必须在第 6 款的规定下发布该作品的目标码。任何包含该作品的可执行程式也在第 6 款的范围内，不论它们是否直接与本函数库连结。</p>

<ol>
    <li>做为上述条款的例外情况，您也可以将 "使用函数库的作品" 与本函数库结合或连结，以产生包含部分本函数库的作品，并在允许使用者自身使用时可以修改该作品，以及在对修改进行反组译除错的情况下，您可以依照您的选择发布该作品。</li>
</ol>


<p>您必须在每个作品的副本突显出如下的注意事项：本函数库在作品中被使用，以及本函数库以及它的使用是在本许可证的规定下。您必须提供本许可证的副本。如果该作品在执行时显示版权声明，您必须在其中包含本函数库的版权声明，以及指引使用者取得本许可证的副本。同时，您必须做到以下其中一件事：</p>

<p>必须将完整的机器可读的函数库原始码包含在该作品中，包括任何该作品使用到的改变 (这些改变必须在前述第 1 与第 2 款的要求下发布)；而且，如果该作品是一个与函数库连结的「完整的、机器可□的 &ldquo;使用函数库的作品"」，则要有目标码和/或原始码，如此使用者可以修改本函数库且可以重新连结，以产生包函修改过的函数库的修改过的可执行程式。 (理所当然的若使用者修改了函数库的档案定义内容时，则该作品不必然可以重新编译以使用修改过的定义。)</p>

<p>在与函数库连结时使用适当的分享函数库连结机制。一个适当的机制是： (1) 在执行时使用已存在于使用者的电脑中的函数库副本，而不是将函数库的函数复制到可执行程式里，以及 (2) 如果使用者安装了一份修改过的函数库，只要修改过的版本在介面上与该作品在编译连结时所用的版本是相容的，则该执行程式可以与修改过的函数库运作良好。</p>

<p>在该作品内提供书面报价，有效期不少于三年，以提供同样的使用者上述第 7a 款中的内容，费用不得超过该程式发布的实际成本。 如果所发布的作品是由指定的地点提供拷贝索取，则由同一地点提供上述内容的等价拷贝索取。</p>

<p>确定使用者已经收到该作品的一份复制，或是您已经寄给该使用者一份复制品。</p>

<p>对于一个可执行程式，其所需的 &ldquo;使用函数库的作品&rdquo; 的形式必须包括任何要从中再产生可执行程式时所需的资料与工具程式。然而，有一个特殊例外，其所发布的内容不需要包括任何一般与「可执行本程式的作业系统」的主要部分 (如编译器、核心等) 一起发布的部分 (不论是原始码或可执行码)，除非这些组成部分和可执行作品结合在一起。</p>

<p>有一个可能情况是，这些要求与其他通常不与作业系统在一起的私有函数库的版权限制相抵触，这样的抵触表示您不能将它们与本函数库一起用于您发布的可执行程式中。</p>

<ol>
    <li>您可以将使用本函数库的函数库设备，以及其他不在本许可证范围内的函数库，对等地放入一个单独的函数库中，并在基于本函数库的作品以及其他函数库在其他状态下同意可以个别发布，以及您做到以下两点的情况下，您可以发布此结合的函数库：将基于本函数库的作品单独不与其他函数库设备结合地，与此结合的函数库一同发布。该作品必须在上述条款的规定下发布。在此结合的函数库中明显地指出其中一部分的作品是基于本函数库，并且说明那里可以找到同样不具结合形式的作品。</li>
    <li>除非您明确按许可证提出的要求去做，否则您不能复制、修改、转发许可证、与本函数库连结、和发布本函数库。任何试图用其他方式复制、修改、转发许可证、与本函数库连结、和发布本函数库是无效的，而且将自动结束许可证赋予您的权利。然而，对那些从您那里按许可证条款得到副本和权利的人们，只要他们继续全面履行条款，许可证赋予他们的权利仍然有效。</li>
    <li>您没有在许可证上签字，因而您没有必要一定接受此一许可证。然而，没有任何其他东西赋予您修改和发布本函数库及其衍生作品的权利。如果您不接受许可证，这些行为是法律禁止的。因此，如果您修改或发布函数库 (或任何基于函数库的作品) ，您就表明您接受这一许可证以及它的所有有关复制、发布和修改本函数库或基于它的作品的条款和条件。</li>
    <li>每当您重新发布函数库 (或任何基于函数库的作品) 时，接受者自动从原始许可证颁发者那里接到受这些条款和条件支配的复制、发布、连结或修改本函数库的许可。您不可以强迫接受者履行除了这里赋予他们的权利之外的其他限制。您也没有强求第三方履行许可证条款的义务。</li>
    <li>如果由于法院判决或违反专利的指控或任何其他原因 (不限于专利问题) 的结果，使得强加于您的条件 (不管是法院判决，协议书或其他) 和许可证的条件有冲突时，他们也不能令您背离许可证的条款。在您不能同时满足本许可证规定的义务及其他相关的义务来发布函数库时，则结果您只能够根本不发布函数库。例如，如果某一专利许可证不允许所有直接或间接从您那里接受副本的人们，在不付专利费的情况下重新发布函数库，唯一能同时满足两方面要求的办法是停止发布函数库。</li>
</ol>


<p>如果本条款的任何部分在特定的环境下无效或无法实施，就使用条款的其余部分，并将这部分条款作为整体用于其他环境。本条款的目的不在于引诱您侵犯专利或其他财产权的要求，或争论这种要求的有效性。本条款的主要目的在于保护自由软体发布系统的完整性。它是通过公共许可证的应用来实现的。许多人已依赖同是出自此系统的应用程式，经由此系统发布大量自由软体而做出慷慨的供献。作者/捐献者有权决定他/她是否通过任何其他系统发布软体，许可证持有人不能强加这种选择。</p>

<p>本节的目的在于明确说明许可证其余部分可能产生的结果。</p>

<ol>
    <li>如果由于专利或者由于有版权的介面问题使函数库在某些国家的发布和使用受到限制，则在许可证约束下的原始版权拥有者可以增加发布地区的限制条款，将这些国家明确排除在外，并在这些国家以外的地区发布函数库。在这种情况下，许可证套件含的限制条款和许可证正文一样有效。 13. 自由软体基金会可能随时出版较宽松通用公共许可证的修改版或新版。新版和当前的版本在原则上保持一致，但在提到新问题时或有关事项时，在细节上可能出现差别。</li>
</ol>


<p>每一版本都有不同的版本号。如果函数库指定可适用的许可证版本号以及 &ldquo;任何更新的版本&rdquo; ，您有权选择遵循指定的版本或自由软体基金会以后出版的新版本。如果函数库未指定许可证版本，您可选择自由软体基金会已经出版的任何版本。</p>

<ol>
    <li>如果您愿意将函数库的一部分结合到其他自由程式中，而它们的发布条件不同，请写信给作者，要求准予使用。如果是自由软体基金会加以版权保护的软体，写信给自由软体基金会，我们有时会作为例外的情况处理。我们的决定受两个主要目标的指导，这两个主要目标是：我们的自由软体的衍生作品继续保持自由状态，以及从整体上促进软体的共享和重复利用。</li>
    <li>没有担保</li>
</ol>


<p>1)     由于函数库准予免费使用，在适用法准许的范围内，对函数库没有担保。除非另有书面说明，版权所有者和/或其他提供函数库的人们 &ldquo;一样&rdquo; 不提供任何类型的担保，不论是明确的，还是隐含的，包括但不限于可销售和适合特定用途的隐含保证。全部的风险，如函数库的质量和性能问题都由您来承担。如果函数库出现缺陷，您应当承担所有必要的服务、修复和改正的费用。</p>

<p>2)     除非适用法或书面协议的要求，在任何情况下，任何版权所有者或任何按许可证条款修改和发布函数库的人们都不对您的损失负有任何责任。包括由于使用或不能使用函数库引起的任何一般的、特殊的、偶然发生的或重大的损失 (包括但不限于数据的损失，或者数据变得不精确，或者您或第三方的持续的损失，或者函数库不能和其他软体协调运行等) 。即使版权所有者和其他人提到这种损失的可能性也不例外。</p>

<p><a href="http://image.beekka.com/blog/201105/free_software_licenses.png" target="_blank"><img src="http://image.beekka.com/blog/201105/bg2011050101.png" alt="" /></a></p>

<p align="center"> </p>


<p>&nbsp;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tracking Rails 3.1 and asset pipeline problems with Apache ]]></title>
    <link href="http://jhjguxin.github.io/blog/2012/02/10/tracking-rails-3-dot-1-and-asset-pipeline-problems-with-apache/"/>
    <updated>2012-02-10T14:30:00+08:00</updated>
    <id>http://jhjguxin.github.io/blog/2012/02/10/tracking-rails-3-dot-1-and-asset-pipeline-problems-with-apache</id>
    <content type="html"><![CDATA[<h2>Tracking Rails 3.1 and asset pipeline problems with Apache</h2>

<p>ubuneu install apache module
<code>sudo apt-get install libapache2-mod-xsendfile</code></p>

<h1>enki_apache_passenger.conf</h1>

<pre>
<code>
LoadModule rewrite_module /usr/lib/apache2/modules/mod_rewrite.so
LoadModule passenger_module /usr/share/ruby-rvm/gems/ruby-1.8.7-p357/gems/passenger-3.0.11/ext/apache2/mod_passenger.so
#sudo apt-get install libapache2-mod-xsendfile
LoadModule xsendfile_module /usr/lib/apache2/modules/mod_xsendfile.so
PassengerRoot /usr/share/ruby-rvm/gems/ruby-1.8.7-p357/gems/passenger-3.0.11
PassengerRuby /usr/share/ruby-rvm/rubies/ruby-1.8.7-p357/bin/ruby</code>

# PassengerMaxPoolSize 10

#ServerName www.yourhost.com
# DocumentRoot /var/www/enki/public
XSendFile On

RewriteEngine On

# AllowOverride all
# Options -MultiViews
# THIS IS REALLY IMPORTANT
XSendFilePath /var/www/enki

LoadModule headers_module /usr/lib/apache2/modules/mod_headers.so
LoadModule expires_module /usr/lib/apache2/modules/mod_expires.so

# Some browsers still send conditional-GET requests if there's a
# Last-Modified header or an ETag header even if they haven't
# reached the expiry date sent in the Expires header.
Header unset Last-Modified
Header unset ETag
# This required etag module to be enabled. Comment out
FileETag None
# RFC says only cache for 1 year
ExpiresActive On
ExpiresDefault "access plus 1 year"
</code>
</pre>


<p>If you have a module version &lt; 0.10, add this to the virtual host config that needs to send files:
<code>
XSendFile On
XSendFileAllowAbove On
</code>
This allows any file path (not only those below your VHost root) to be sent through X-Sendfile, which is sort of bad practice. You can either live with it or compile a newer version of the module.</p>

<p>If you got a module version &gt;= 0.10 you can whitelist the allowed paths instead:
<code>
XSendFile On
XSendFilePath /opt/www/awesome-project
</code></p>

<p><h2>Migrating my blog over to Rails 3.1 beta<h2></p>

<h1>Enable the asset pipeline</h1>

<p>config.assets.enabled = true</p>

<p>config/environments/development.rb (remove or comment out the following line)
<pre>
<code>#config.action_view.debug_rjs             = true
</code>
</pre></p>

<p>config/environments/production.rb (add these lines)
<pre>
<code># Compress both stylesheets and JavaScripts
config.assets.js_compressor  = :uglifier
config.assets.css_compressor = :scss
</code>
</pre></p>

<p><pre>
<code>mkdir app/assets
git mv public/images app/assets/images
git mv public/javascripts app/assets/javascripts
git mv public/stylesheets app/assets/stylesheets
</code>
</pre></p>

<p>Finally, in your production environment, don’t forget to statically generate your compiled assets with this Rake task:
<pre>
<code>RAILS_ENV=production bundle exec rake assets:precompile
</code>
</pre>
It will create files such as these:</p>

<p><pre>
<code>
public/assets/application-2a8947193a591b79c885c52fbc6b01d3.css
</code>
</pre></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Phusion Passenger users guide]]></title>
    <link href="http://jhjguxin.github.io/blog/2012/01/09/phusion-passenger-users-guide/"/>
    <updated>2012-01-09T14:26:00+08:00</updated>
    <id>http://jhjguxin.github.io/blog/2012/01/09/phusion-passenger-users-guide</id>
    <content type="html"><![CDATA[<h2>Phusion Passenger users guide</h2>

<div>

Phusion Passenger is an Apache module, which makes deploying Ruby and Ruby on Rails applications on Apache a breeze. It follows the usual Ruby on Rails conventions, such as "Don’t-Repeat-Yourself" and ease of setup, while at the same time providing enough flexibility.

</div>


<div>

This users guide will teach you:

</div>


<div>
<ul>
    <li>How to install Phusion Passenger.</li>
    <li>How to configure Phusion Passenger.</li>
    <li>How to deploy a Ruby on Rails application.</li>
    <li>How to deploy a <a href="http://rack.rubyforge.org/">Rack</a>-based Ruby application.</li>
    <li>How to solve common problems.</li>
</ul>
</div>


<div>

This guide assumes that the reader is somewhat familiar with Apache and with using the commandline.

</div>


<div>
<h2 id="_support_information">1. Support information</h2>
<div>
<div>
<h3 id="_supported_operating_systems">1.1. Supported operating systems</h3>
<div>

Phusion Passenger works on any POSIX-compliant operating system. In other words: practically any operating system on earth, except Microsoft Windows.

</div>
<div>

Phusion Passenger is confirmed on a large number of operating systems and Linux distributions, including, but not limited to, Ubuntu, Debian, CentOS/Fedora/RHEL, Gentoo, Mac OS X, FreeBSD and Solaris. Both 32-bit and 64-bit platforms are supported.

</div>
<div>

The only POSIX-compliant operating system on which Phusion Passenger for Apache is known not to work at this time, is OpenBSD. Please use Phusion Passenger for Nginx instead.

</div>
<div>

Please <a href="http://code.google.com/p/phusion-passenger/issues/list">report a bug</a> or <a href="http://groups.google.com/group/phusion-passenger">join our discussion forum</a> if it doesn’t work on your POSIX-compliant operating system.

</div>
</div>
<div>
<h3 id="_where_to_get_support">1.2. Where to get support</h3>
<div>
<ul>
    <li><a href="http://code.google.com/p/phusion-passenger/issues/list">Issue tracker</a> - report bugs here.</li>
    <li><a href="http://groups.google.com/group/phusion-passenger">Discussion forum</a> - post a message here if you’re experiencing problems.</li>
</ul>
</div>
</div>
</div>
</div>


<div>
<h2 id="_installing_upgrading_and_uninstalling_phusion_passenger">2. Installing, upgrading and uninstalling Phusion Passenger</h2>
<div>
<div>
<h3 id="_generic_installation_instructions">2.1. Generic installation instructions</h3>
<div>
<h4 id="install_passenger">2.1.1. Overview of installation methods</h4>
<div>

There are three ways to install Phusion Passenger:

</div>
<div>
<ol>
    <li>By installing the Phusion Passenger gem, as instructed on the <a href="http://www.modrails.com/install.html">“Install” page on the Phusion Passenger website</a>.</li>
    <li>By downloading the source tarball from the Phusion Passenger website (<em>passenger-x.x.x.tar.gz</em>).</li>
    <li>By installing a native Linux package (e.g. Debian package).</li>
</ol>
</div>
<div>

The following sections will explain each installation method. Please read the section for the installation method that you prefer. In our opinion, installing the gem or the native package is easiest. For these two installation methods, Phusion Passenger provides an easy-to-use installer.

</div>
</div>
<div>
<h4 id="_preparation_gem_and_source_tarball_only">2.1.2. Preparation (gem and source tarball only)</h4>
<div>

If you want to install Phusion Passenger via the gem or the source tarball, then some preparations might be required. You can skip this subsection if you’re installing Phusion Passenger via a native Linux package, because no compilation is necessary.

</div>
<div>
<h5 id="_switching_to_a_root_command_prompt">Switching to a root command prompt</h5>
<div>

Before installing, you will probably need to switch to the root user first. When you install Phusion Passenger via a gem or a source tarball, some Phusion Passenger files have to be compiled, which requires write access to the directory in which the Phusion Passenger files are located. On Unix systems, the root user is the user who has write access to the entire system. So unless you know that your normal user account has write access to the Phusion Passenger directory, you should switch to root before installing Phusion Passenger.

</div>
<div>

You can switch to root by typing the following command:

</div>
<div>
<div>
<pre>sudo -s</pre>
</div>
</div>
<div>

This will open a command prompt as the root user, from which you can proceed with installing Phusion Passenger.

</div>
<div>

If your system does not have <em>sudo</em> installed, please type the following command instead, which should do the same thing:

</div>
<div>
<div>
<pre>su</pre>
</div>
</div>
</div>
<div>
<h5 id="specifying_correct_apache_install">Specifying the correct Apache installation</h5>
<div>

The Phusion Passenger installer will attempt to automatically detect Apache, and compile Phusion Passenger against that Apache version. It does this by looking for the apxs or apxs2 command in the PATH environment variable. Apxs is an integral part of any Apache installation.

</div>
<div>

However, some systems have multiple Apache installations. This is likely the case on MacOS X: the OS ships with Apache, but users tend to install another Apache version seperately, e.g. via MacPorts. If your system has multiple Apache installations, then you will need to tell the Phusion Passenger installer which one to use. It is very important that you specify the correct Apache installation, because if you load Phusion Passenger in an Apache installation that it wasn’t compiled against, then it will likely crash.

</div>
<div>

On yet other systems, Apache is installed in a non-standard location, preventing the Phusion Passenger installer from detecting Apache. This is most likely the case on systems on which Apache was installed by hand from source, i.e. as opposed to installed through the system’s native package manager. If this is the case, then you will also have to tell the installer where it can find Apache.

</div>
<div>

To do so, set the APXS2 environment variable to the full path of the correct apxs or apxs2 command. Suppose that you want to use the Apache installation in <em>/opt/apache2</em>. Then, assuming that the corresponding apxs program’s path is <em>/opt/apache2/bin/apxs</em>, type:

</div>
<div>
<div>
<pre>export APXS2=/opt/apache2/bin/apxs</pre>
</div>
</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>On some systems, the apxs program might be called apxs2, and it might be located in the sbin folder instead of the bin folder.</td>
</tr>
</tbody>
</table>
</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>
<div>Environment variables and <em>sudo</em></div>
By default, the <em>sudo</em> command will erase any environment variables that it doesn’t recognize, prior to executing the given command. So if you set APXS2 as a normal user, then run sudo passenger-install-apache2-module (which is the command for the Phusion Passenger installer), then the installer will not receive the environment variable value that you set. To solve this problem, please become root prior to setting any environment variables, as described in the previous subsection.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h5 id="specifying_ruby_installation">Specifying the correct Ruby installation</h5>
<div>

If your system has multiple Ruby installations — which is likely the case on MacOS X, or if you’ve also installed <a href="http://www.rubyenterpriseedition.com/">Ruby Enterprise Edition</a>  — then you will need to tell the operating system which Ruby installation to use, prior to running the Phusion Passenger installer. If you only have one Ruby installation (the case on most Linux systems), then you can skip this section because Phusion Passenger will automatically detect it.

</div>
<div>

To specify a Ruby installation, prepend your Ruby installation’s bin directory to the PATH environment variable. For example, if you have the following Ruby installations:

</div>
<div>
<ul>
    <li>/usr/bin/ruby</li>
    <li>/opt/myruby/bin/ruby</li>
</ul>
</div>
<div>

and you want to use the latter, then type:

</div>
<div>
<div>
<pre>export PATH=/opt/myruby/bin:$PATH</pre>
</div>
</div>
</div>
</div>
<div>
<h4 id="_installing_via_the_gem">2.1.3. Installing via the gem</h4>
<div>

Please install the gem and then run the Phusion Passenger installer, by typing the following commands:

</div>
<div>
<div>
<pre>gem install passenger-x.x.x.gem
passenger-install-apache2-module</pre>
</div>
</div>
<div>

Please follow the instructions given by the installer.

</div>
</div>
<div>
<h4 id="_installing_via_the_source_tarball">2.1.4. Installing via the source tarball</h4>
<div>

Extract the tarball to whatever location you prefer. <strong>The Phusion Passenger files are to reside in that location permanently.</strong> For example, if you would like Phusion Passenger to reside in /opt/passenger-x.x.x:

</div>
<div>
<div>
<pre>cd /opt
tar xzvf ~/YourDownloadsFolder/passenger-x.x.x.tar.gz</pre>
</div>
</div>
<div>

Next, run the included installer:

</div>
<div>
<div>
<pre>/opt/passenger-x.x.x/bin/passenger-install-apache2-module</pre>
</div>
</div>
<div>

Please follow the instructions given by the installer.

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/important.png" alt="Important" /></td>
<td>Please do not remove the <em>passenger-x.x.x</em> folder after installation. Furthermore, the <em>passenger-x.x.x</em> folder must be accessible by Apache.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h4 id="_installing_via_a_native_linux_package">2.1.5. Installing via a native Linux package</h4>
<div>

John Leach from Brightbox has kindly provided an Ubuntu Hardy package for Phusion Passenger. The package is available from the <a href="http://apt.brightbox.net/">Brightbox repository</a>.

</div>
<div>

Please install the native Linux package, e.g.:

</div>
<div>
<div>
<pre>sudo sh -c 'echo "deb http://apt.brightbox.net hardy main" &gt; /etc/apt/sources.list.d/brightbox.list'
sudo sh -c 'wget -q -O - http://apt.brightbox.net/release.asc | apt-key add -'
sudo apt-get update
sudo apt-get install libapache2-mod-passenger</pre>
</div>
</div>
</div>
<div>
<h4 id="_what_does_the_installer_do">2.1.6. What does the installer do?</h4>
<div>

Although we call it an “installer”, it doesn’t actually install anything. The installer checks whether all required dependencies are installed, compiles Phusion Passenger for you, and tells you how to modify the Apache configuration file, but it doesn’t copy any files around.

</div>
<div>

passenger-install-apache2-module is actually just a user-friendly frontend around the command rake apache2, which performs the actual compilation of Phusion Passenger.

</div>
</div>
</div>
<div>
<h3 id="_operating_system_specific_instructions_and_information">2.2. Operating system-specific instructions and information</h3>
<div>
<h4 id="_macos_x">2.2.1. MacOS X</h4>
<div>

Ben Ruebenstein has written an excellent <a href="http://benr75.com/articles/2008/04/12/setup-mod_rails-phusion-mac-os-x-leopard">tutorial on installing Phusion Passenger on OS X</a>.

</div>
</div>
<div>
<h4 id="_ubuntu_linux">2.2.2. Ubuntu Linux</h4>
<div>

Ben Hughes has written an <a href="http://www.railsgarden.com/2008/04/12/configurating-passenger-mod_rails-on-slicehost-with-ubuntu-710/">article on installing Phusion Passenger on Ubuntu</a>.

</div>
</div>
<div>
<h4 id="_opensolaris">2.2.3. OpenSolaris</h4>
<div>

J Aaron Farr has written a <a href="http://cubiclemuses.com/cm/articles/2009/04/09/rails-passenger-open-solaris-ec2/">guide</a> about setting up Ruby on Rails and Phusion Passenger on OpenSolaris and EC2.

</div>
</div>
</div>
<div>
<h3 id="_upgrading_or_downgrading_phusion_passenger">2.3. Upgrading or downgrading Phusion Passenger</h3>
<div>
<h4 id="_via_a_gem_or_a_source_tarball">2.3.1. Via a gem or a source tarball</h4>
<div>

To upgrade or downgrade Phusion Passenger via the gem or the source tarball, install the newer or older version as you normally would; that is, install the gem or unpack the tarball, and run passenger-install-apache2-module. Eventually passenger-install-apache2-module will tell you to copy &amp; paste some settings into the Apache configuration file; something that looks along the lines of:

</div>
<div>
<div>
<pre>LoadModule passenger_module ...
PassengerRoot ...
PassengerRuby ...</pre>
</div>
</div>
<div>

Because you already had Phusion Passenger installed, you already had similar settings in your Apache configuration file, just with different values. <strong>Replace</strong> the old settings with the new ones that the installer outputs. It is important that the old settings are removed, otherwise Phusion Passenger may malfunction.

</div>
<div>

When you’re done, restart Apache.

</div>
</div>
<div>
<h4 id="_via_a_native_linux_package">2.3.2. Via a native Linux package</h4>
<div>

There are no special instructions required to upgrade or downgrade Phusion Passenger via a native Linux package.

</div>
</div>
</div>
<div>
<h3 id="_unloading_disabling_phusion_passenger_from_apache_without_uninstalling_it">2.4. Unloading (disabling) Phusion Passenger from Apache without uninstalling it</h3>
<div>

You can temporarily unload (disable) Phusion Passenger from Apache, without uninstalling the Phusion Passenger files, so that Apache behaves as if Phusion Passenger was never installed in the first place. This might be useful to you if, for example, you seem to be experiencing a problem caused by Phusion Passenger, but you want to make sure whether that’s actually the case, without having to through the hassle of uninstalling Phusion Passenger completely. When disabled, Phusion Passenger will not occupy any memory or CPU or otherwise interfere with Apache.

</div>
<div>

To unload Phusion Passenger from Apache, edit your Apache configuration file(s) and comment out:

</div>
<div>
<ul>
    <li>all Phusion Passenger configuration directives.</li>
    <li>the <em>LoadModule passenger_module</em> directive.</li>
</ul>
</div>
<div>

For example, if your configuration file looks like this…

</div>
<div>
<div>
<pre>Listen *:80
NameVirtualHosts *:80
....

LoadModule passenger_module /somewhere/passenger-x.x.x/ext/apache2/mod_passenger.so

PassengerRuby /usr/bin/ruby
PassengerRoot /somewhere/passenger/x.x.x
PassengerMaxPoolSize 10

&lt;VirtualHost *:80&gt;
    ServerName www.foo.com
    DocumentRoot /webapps/foo/public
    RailsBaseURI /rails
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

…then comment out the relevant directives, so that it looks like this:

</div>
<div>
<div>
<pre>Listen *:80
NameVirtualHosts *:80
....

# LoadModule passenger_module /somewhere/passenger-x.x.x/ext/apache2/mod_passenger.so

# PassengerRuby /usr/bin/ruby
# PassengerRoot /somewhere/passenger/x.x.x
# PassengerMaxPoolSize 10

&lt;VirtualHost *:80&gt;
    ServerName www.foo.com
    DocumentRoot /webapps/foo/public
    # RailsBaseURI /rails
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

After you’ve done this, save the file and restart Apache.

</div>
</div>
<div>
<h3 id="_uninstalling_phusion_passenger">2.5. Uninstalling Phusion Passenger</h3>
<div>

To uninstall Phusion Passenger, please first remove all Phusion Passenger configuration directives from your Apache configuration file(s). After you’ve done this, you need to remove the Phusion Passenger files.

</div>
<div>
<ul>
    <li>If you installed Phusion Passenger via a gem, then type gem uninstall passenger. You might have to run this as root.</li>
    <li>If you installed Phusion Passenger via a source tarball, then remove the directory in which you placed the extracted Phusion Passenger files. This directory is the same as the one pointed to the by <em>PassengerRoot</em> configuration directive.</li>
    <li>If you installed Phusion Passenger via a Debian package, then remove type sudo apt-get remove libapache2-mod-passenger.</li>
</ul>
</div>
</div>
</div>
</div>


<div>
<h2 id="_deploying_a_ruby_on_rails_1_x_or_2_x_but_not_rails_gt_3_x_application">3. Deploying a Ruby on Rails 1.x or 2.x (but NOT Rails &gt;= 3.x) application</h2>
<div>
<div>

Suppose you have a Ruby on Rails application in <em>/webapps/mycook</em>, and you own the domain <em>www.mycook.com</em>. You can either deploy your application to the virtual host’s root (i.e. the application will be accessible from the root URL, <em>http://www.mycook.com/</em>), or in a sub URI (i.e. the application will be accessible from a sub URL, such as <em>http://www.mycook.com/railsapplication</em>).

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>The default RAILS_ENV environment in which deployed Rails applications are run, is “production”. You can change this by changing the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#rails_env"><em>RailsEnv</em></a> configuration option.</td>
</tr>
</tbody>
</table>
</div>
<div>
<h3 id="_deploying_to_a_virtual_host_8217_s_root">3.1. Deploying to a virtual host’s root</h3>
<div>

Add a virtual host entry to your Apache configuration file. Make sure that the following conditions are met:

</div>
<div>
<ul>
    <li>The virtual host’s document root must point to your Ruby on Rails application’s <em>public</em> folder.</li>
    <li>The Apache per-directory permissions must allow access to this folder.</li>
    <li>MultiViews must be disabled for this folder.</li>
</ul>
</div>
<div>

For example:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.mycook.com
    DocumentRoot /webapps/mycook/public
    &lt;Directory /webapps/mycook/public&gt;
        Allow from all
        Options -MultiViews
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

You may also need to tweak your file/folder permissions. Make sure that the following folders are readable and executable by Apache:

</div>
<div>
<ul>
    <li>this <em>public</em> folder.</li>
    <li>the application’s <em>config</em> folder.</li>
    <li>all parent folders. That is, /webapps/mycook and /webapps must also be readable and executable by Apache.</li>
</ul>
</div>
<div>

Then restart Apache. The application has now been deployed.

</div>
</div>
<div>
<h3 id="deploying_rails_to_sub_uri">3.2. Deploying to a sub URI</h3>
<div>

Suppose that you already have a virtual host:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.phusion.nl
    DocumentRoot /websites/phusion
    &lt;Directory /websites/phusion&gt;
        Allow from all
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

And you want your Ruby on Rails application to be accessible from the URL <em>http://www.phusion.nl/rails</em>.

</div>
<div>

To do this, make a symlink in the virtual host’s document root, and have it point to your Ruby on Rails application’s <em>public</em> folder. For example:

</div>
<div>
<div>
<pre>ln -s /webapps/mycook/public /websites/phusion/rails</pre>
</div>
</div>
<div>

Next, add a <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#RailsBaseURI">RailsBaseURI</a> option to the virtual host configuration, and also make sure that:

</div>
<div>
<ul>
    <li>The Apache per-directory permissions allow access to this folder.</li>
    <li>MultiViews is disabled for this folder.</li>
</ul>
</div>
<div>

For example:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.phusion.nl
    DocumentRoot /websites/phusion
    &lt;Directory /websites/phusion&gt;
        Allow from all
    &lt;/Directory&gt;

    RailsBaseURI /rails                   # &lt;-- These lines have
    &lt;Directory /websites/phusion/rails&gt;   # &lt;-- been added.
        Options -MultiViews               # &lt;--
    &lt;/Directory&gt;                          # &lt;--
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

Then restart Apache. The application has now been deployed.

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>If you’re deploying to a sub-URI then please make sure that your view templates correctly handles references to sub-URI static assets! Otherwise you may find broken links to images, CSS files, JavaScripts, etc. Please read <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#sub_uri_deployment_uri_fix">How to fix broken images/CSS/JavaScript URIs in sub-URI deployments</a> for more information.</td>
</tr>
</tbody>
</table>
</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/tip.png" alt="Tip" /></td>
<td>
<div>

You can deploy multiple Rails applications under a virtual host, by specifying <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#RailsBaseURI">RailsBaseURI</a> multiple times. For example:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ....
    RailsBaseURI /app1
    RailsBaseURI /app2
    RailsBaseURI /app3
&lt;/VirtualHost&gt;</pre>
</div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h3 id="_redeploying_restarting_the_ruby_on_rails_application">3.3. Redeploying (restarting the Ruby on Rails application)</h3>
<div>

Deploying a new version of a Ruby on Rails application is as simple as re-uploading the application files, and restarting the application.

</div>
<div>

There are two ways to restart the application:

</div>
<div>
<ol>
    <li>By restarting Apache.</li>
    <li>By creating or modifying the file <em>tmp/restart.txt</em> in the Rails application’s <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#application_root">root folder</a>. Phusion Passenger will automatically restart the application during the next request.</li>
</ol>
</div>
<div>

For example, to restart our example MyCook application, we type this in the command line:

</div>
<div>
<div>
<pre>touch /webapps/mycook/tmp/restart.txt</pre>
</div>
</div>
<div>

Please note that, unlike earlier versions of Phusion Passenger, <em>restart.txt</em> is not automatically deleted. Phusion Passenger checks whether the timestamp of this file has changed in order to determine whether the application should be restarted.

</div>
</div>
<div>
<h3 id="_migrations">3.4. Migrations</h3>
<div>

Phusion Passenger is not related to Ruby on Rails migrations in any way. To run migrations on your deployment server, please login to your deployment server (e.g. with <em>ssh</em>) and type rake db:migrate RAILS_ENV=production in a shell console, just like one would normally run migrations.

</div>
</div>
<div>
<h3 id="_capistrano_integration">3.5. Capistrano integration</h3>
<div>

See <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#capistrano">Capistrano recipe</a>.

</div>
</div>
</div>
</div>


<div>
<h2 id="_deploying_a_rack_based_ruby_application_including_rails_gt_3">4. Deploying a Rack-based Ruby application (including Rails &gt;= 3)</h2>
<div>
<div>

Phusion Passenger supports arbitrary Ruby web applications that follow the <a href="http://rack.rubyforge.org/">Rack</a> interface.

</div>
<div>

Phusion Passenger assumes that Rack application directories have a certain layout. Suppose that you have a Rack application in <em>/webapps/rackapp</em>. Then that folder must contain at least three entries:

</div>
<div>
<ul>
    <li><em>config.ru</em>, a Rackup file for starting the Rack application. This file must contain the complete logic for initializing the application.</li>
    <li><em>public/</em>, a folder containing public static web assets, like images and stylesheets.</li>
    <li><em>tmp/</em>, used for <em>restart.txt</em> (our application restart mechanism). This will be explained in a following subsection.</li>
</ul>
</div>
<div>

So <em>/webapps/rackapp</em> must, at minimum, look like this:

</div>
<div>
<div>
<pre>/webapps/rackapp
  |
  +-- config.ru
  |
  +-- public/
  |
  +-- tmp/</pre>
</div>
</div>
<div>

Suppose you own the domain <em>www.rackapp.com</em>. You can either deploy your application to the virtual host’s root (i.e. the application will be accessible from the root URL, <em>http://www.rackapp.com/</em>), or in a sub URI (i.e. the application will be accessible from a sub URL, such as <em>http://www.rackapp.com/rackapp</em>).

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>The default RACK_ENV environment in which deployed Rack applications are run, is “production”. You can change this by changing the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#rack_env"><em>RackEnv</em></a> configuration option.</td>
</tr>
</tbody>
</table>
</div>
<div>
<h3 id="_tutorial_example_writing_and_deploying_a_hello_world_rack_application">4.1. Tutorial/example: writing and deploying a Hello World Rack application</h3>
<div>

First we create a Phusion Passenger-compliant Rack directory structure:

</div>
<div>
<div>
<pre>$ mkdir /webapps/rack_example
$ mkdir /webapps/rack_example/public
$ mkdir /webapps/rack_example/tmp</pre>
</div>
</div>
<div>

Next, we write a minimal "hello world" Rack application:

</div>
<div>
<div>
<pre>$ cd /webapps/rack_example
$ some_awesome_editor config.ru
...type in some source code...
$ cat config.ru
app = proc do |env|
    [200, { "Content-Type" =&gt; "text/html" }, ["hello &lt;b&gt;world&lt;/b&gt;"]]
end
run app</pre>
</div>
</div>
<div>

Finally, we deploy it by adding the following configuration options to the Apache configuration file:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.rackexample.com
    DocumentRoot /webapps/rack_example/public
    &lt;Directory /webapps/rack_example/public&gt;
        Allow from all
        Options -MultiViews
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

And we’re done! After an Apache restart, the above Rack application will be available under the URL <em>http://www.rackexample.com/</em>.

</div>
</div>
<div>
<h3 id="_deploying_to_a_virtual_host_8217_s_root_2">4.2. Deploying to a virtual host’s root</h3>
<div>

Add a virtual host entry to your Apache configuration file. Make sure that the following conditions are met:

</div>
<div>
<ul>
    <li>The virtual host’s document root must point to your Rack application’s <em>public</em> folder.</li>
    <li>The Apache per-directory permissions must allow access to this folder.</li>
    <li>MultiViews must be disabled for this folder.</li>
</ul>
</div>
<div>

For example:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.rackapp.com
    DocumentRoot /webapps/rackapp/public
    &lt;Directory /webapps/rackapp/public&gt;
        Allow from all
        Options -MultiViews
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

You may also need to tweak your file/folder permissions. Make sure that the following folders are readable and executable by Apache:

</div>
<div>
<ul>
    <li>this <em>public</em> folder.</li>
    <li>the application’s <em>config</em> folder.</li>
    <li>all parent folders. That is, /webapps/rackapp and /webapps must also be readable and executable by Apache.</li>
</ul>
</div>
<div>

Then restart Apache. The application has now been deployed.

</div>
</div>
<div>
<h3 id="deploying_rack_to_sub_uri">4.3. Deploying to a sub URI</h3>
<div>

Suppose that you already have a virtual host:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.phusion.nl
    DocumentRoot /websites/phusion
    &lt;Directory /websites/phusion&gt;
        Allow from all
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

And you want your Rack application to be accessible from the URL <em>http://www.phusion.nl/rack</em>.

</div>
<div>

To do this, make a symlink in the virtual host’s document root, and have it point to your Rack application’s <em>public</em> folder. For example:

</div>
<div>
<div>
<pre>ln -s /webapps/rackapp/public /websites/phusion/rack</pre>
</div>
</div>
<div>

Next, add a <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#RackBaseURI">RackBaseURI</a> option to the virtual host configuration, and also make sure that:

</div>
<div>
<ul>
    <li>The Apache per-directory permissions allow access to this folder.</li>
    <li>MultiViews is disabled for this folder.</li>
</ul>
</div>
<div>

For example:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.phusion.nl
    DocumentRoot /websites/phusion
    &lt;Directory /websites/phusion&gt;
        Allow from all
    &lt;/Directory&gt;

    RackBaseURI /rails                    # &lt;-- These lines have
    &lt;Directory /websites/phusion/rails&gt;   # &lt;-- been added.
        Options -MultiViews               # &lt;--
    &lt;/Directory&gt;                          # &lt;--
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

Then restart Apache. The application has now been deployed.

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/tip.png" alt="Tip" /></td>
<td>
<div>

You can deploy multiple Rack applications under a virtual host, by specifying <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#RackBaseURI">RackBaseURI</a> multiple times. For example:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ....
    RackBaseURI /app1
    RackBaseURI /app2
    RackBaseURI /app3
&lt;/VirtualHost&gt;</pre>
</div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h3 id="_redeploying_restarting_the_rack_application">4.4. Redeploying (restarting the Rack application)</h3>
<div>

Deploying a new version of a Rack application is as simple as re-uploading the application files, and restarting the application.

</div>
<div>

There are two ways to restart the application:

</div>
<div>
<ol>
    <li>By restarting Apache.</li>
    <li>By creating or modifying the file <em>tmp/restart.txt</em> in the Rack application’s <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#application_root">root folder</a>. Phusion Passenger will automatically restart the application.</li>
</ol>
</div>
<div>

For example, to restart our example application, we type this in the command line:

</div>
<div>
<div>
<pre>touch /webapps/rackapp/tmp/restart.txt</pre>
</div>
</div>
</div>
<div>
<h3 id="_rackup_specifications_for_various_web_frameworks">4.5. Rackup specifications for various web frameworks</h3>
<div>

This subsection shows example <em>config.ru</em> files for various web frameworks.

</div>
<div>
<h4 id="_camping">4.5.1. Camping</h4>
<div>
<div>
<pre>require 'rubygems'
require 'rack'
require 'camping'

##### Begin Camping application
Camping.goes :Blog

...your application code here...
##### End Camping application

run Rack::Adapter::Camping.new(Blog)</pre>
</div>
</div>
<div>

For Camping versions 2.0 and up, using run Blog as the final line will do.

</div>
</div>
<div>
<h4 id="_halcyon">4.5.2. Halcyon</h4>
<div>
<div>
<pre>require 'rubygems'
require 'halcyon'
$LOAD_PATH.unshift(Halcyon.root / 'lib')
Halcyon::Runner.load_config Halcyon.root/'config'/'config.yml'
run Halcyon::Runner.new</pre>
</div>
</div>
</div>
<div>
<h4 id="_mack">4.5.3. Mack</h4>
<div>
<div>
<pre>ENV["MACK_ENV"] = ENV["RACK_ENV"]
load("Rakefile")
require 'rubygems'
require 'mack'
run Mack::Utils::Server.build_app</pre>
</div>
</div>
</div>
<div>
<h4 id="_merb">4.5.4. Merb</h4>
<div>
<div>
<pre>require 'rubygems'
require 'merb-core'

Merb::Config.setup(
  :merb_root   =&gt; ::File.expand_path(::File.dirname(__FILE__)),
  :environment =&gt; ENV['RACK_ENV']
)
Merb.environment = Merb::Config[:environment]
Merb.root = Merb::Config[:merb_root]
Merb::BootLoader.run

run Merb::Rack::Application.new</pre>
</div>
</div>
</div>
<div>
<h4 id="_ramaze">4.5.5. Ramaze</h4>
<div>
<div>
<pre>require "rubygems"
require "ramaze"
Ramaze.trait[:essentials].delete Ramaze::Adapter
require "start"
Ramaze.start!
run Ramaze::Adapter::Base</pre>
</div>
</div>
</div>
<div>
<h4 id="_sinatra">4.5.6. Sinatra</h4>
<div>
<div>
<pre>require 'rubygems'
require 'sinatra'
require 'app.rb'

run Sinatra::Application</pre>
</div>
</div>
</div>
</div>
</div>
</div>


<div>
<h2 id="_configuring_phusion_passenger">5. Configuring Phusion Passenger</h2>
<div>
<div>

After installation, Phusion Passenger does not need any further configurations. Nevertheless, the system administrator may be interested in changing Phusion Passenger’s behavior. Phusion Passenger’s Apache module supports the following configuration options:

</div>
<div>
<h3 id="_passengerroot_lt_directory_gt">5.1. PassengerRoot &lt;directory&gt;</h3>
<div>

The location to the Phusion Passenger root directory. This configuration option is essential to Phusion Passenger, and allows Phusion Passenger to locate its own data files. The correct value is given by the installer.

</div>
<div>

If you’ve moved Phusion Passenger to a different directory then you need to update this option as well. Please read <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#moving_phusion_passenger">Moving Phusion Passenger to a different directory</a> for more information.

</div>
<div>

This required option may only occur once, in the global server configuration.

</div>
</div>
<div>
<h3 id="PassengerRuby">5.2. PassengerRuby &lt;filename&gt;</h3>
<div>

This option allows one to specify the Ruby interpreter to use.

</div>
<div>

This option may only occur once, in the global server configuration. The default is <em>ruby</em>.

</div>
</div>
<div>
<h3 id="PassengerAppRoot">5.3. PassengerAppRoot &lt;path/to/root&gt;</h3>
<div>

By default, Phusion Passenger assumes that the application’s root directory is the parent directory of the <em>public</em> directory. This option allows one to specify the application’s root independently from the DocumentRoot, which is useful if the <em>public</em> directory lives in a non-standard place.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Options is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once.

</div>
<div>

Example:

</div>
<div>
<div>
<pre>&lt;VirtualHost test.host&gt;
    DocumentRoot /var/rails/zena/sites/example.com/public
    PassengerAppRoot /var/rails/zena   # &lt;-- normally Phusion Passenger would
                                       #     have assumed that the application
                                       #     root is "/var/rails/zena/sites/example.com"
&lt;/VirtualHost&gt;</pre>
</div>
</div>
</div>
<div>
<h3 id="PassengerSpawnMethod">5.4. PassengerSpawnMethod &lt;string&gt;</h3>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/tip.png" alt="Tip" /></td>
<td>
<div>"What spawn method should I use?"</div>
<div>

This subsection attempts to describe spawn methods, but it’s okay if you don’t (want to) understand it, as it’s mostly a technical detail. You can basically follow this rule of thumb:

</div>
<div>
<div>
<div>

If your application works on Mongrel, but not on Phusion Passenger, then set PassengerSpawnMethod to <em>conservative</em>. Otherwise, leave it at <em>smart-lv2</em> (the default).

</div>
</div>
</div>
<div>

However, we do recommend you to try to understand it. The <em>smart</em> and <em>smart-lv2</em> spawn methods bring many benefits.

</div></td>
</tr>
</tbody>
</table>
</div>
<div>

Internally, Phusion Passenger spawns multiple Ruby application processes in order to handle requests. But there are multiple ways with which processes can be spawned, each having its own set of pros and cons. Supported spawn methods are:

</div>
<div><dl><dt><em>smart</em></dt><dd>When this spawn method is used, Phusion Passenger will attempt to cache any framework code (e.g. Ruby on Rails itself) and application code for a limited period of time. Please read <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#spawning_methods_explained">Spawning methods explained</a> for a more detailed explanation of what smart spawning exactly does.
<div>

<strong>Pros:</strong> This can significantly decrease spawn time (by as much as 90%). And, when Ruby Enterprise Edition is used, <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#reducing_memory_usage">memory usage can be reduced by 33% on average</a>.

</div>
<div>

<strong>Cons:</strong> Some applications and libraries are not compatible with smart spawning. If that’s the case for your application, then you should use <em>conservative</em> as spawning method. Please read <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#spawning_methods_explained">Spawning methods explained</a> for possible compatibility issues.

</div>
</dd><dt><em>smart-lv2</em></dt><dd>This spawning method is similar to <em>smart</em> but it skips the framework spawner and uses the application spawner directly. This means the framework code is not cached between multiple applications, although it is still cached within instances of the same application. Please read <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#spawning_methods_explained">Spawning methods explained</a> for a more detailed explanation of what smart-lv2 spawning exactly does.
<div>

<strong>Pros:</strong> It is compatible with a larger number of applications when compared to the <em>smart</em> method, and still performs some caching.

</div>
<div>

<strong>Cons:</strong> It is slower than smart spawning if you have many applications which use the same framework version. It is therefore advised that shared hosts use the <em>smart</em> method instead.

</div>
</dd><dt><em>conservative</em></dt><dd>This spawning method is similar to the one used in Mongrel Cluster. It does not perform any code caching at all. Please read <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#spawning_methods_explained">Spawning methods explained</a> for a more detailed explanation of what conservative spawning exactly does.
<div>

<strong>Pros:</strong> Conservative spawning is guaranteed to be compatible with all applications and libraries.

</div>
<div>

<strong>Cons:</strong> Much slower than smart spawning. Every spawn action will be equally slow, though no slower than the startup time of a single server in Mongrel Cluster. Conservative spawning will also render <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#reducing_memory_usage">Ruby Enterprise Edition’s memory reduction technology</a> useless.

</div>
</dd></dl></div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>smart-lv2</em>.

</div>
</div>
<div>
<h3 id="PassengerUseGlobalQueue">5.5. PassengerUseGlobalQueue &lt;on|off&gt;</h3>
<div>

Turns the use of global queuing on or off.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>on</em>.

</div>
<div>

<em>This feature is sponsored by <a href="http://www.37signals.com/">37signals</a>.</em>

</div>
<div>
<div>What does this option do?</div>
Recall that Phusion Passenger spawns multiple backend processes (e.g. multiple Ruby on Rails processes), each which processes HTTP requests serially. One of Phusion Passenger’s jobs is to forward HTTP requests to a suitable backend process. A backend process may take an arbitrary amount of time to process a specific HTTP request. If the websites are (temporarily) under high load, and the backend processes cannot process the requests fast enough, then some requests may have to be queued.

</div>
<div>

If global queuing is turned off, then Phusion Passenger will use <em>fair load balancing</em>. This means that each backend process will have its own private queue. Phusion Passenger will forward an HTTP request to the backend process that has the least amount of requests in its queue.

</div>
<div>

If global queuing is turned on, then Phusion Passenger will use a global queue that’s shared between all backend processes. If an HTTP request comes in, and all the backend processes are still busy, then Phusion Passenger will wait until at least one backend process is done, and will then forward the request to that process.

</div>
<div>
<div>When to turn on global queuing?</div>
You should turn on global queuing if one of your web applications may have long-running requests.

</div>
<div>

For example suppose that:

</div>
<div>
<ul>
    <li>global queuing is turned off.</li>
    <li>we’re currently in a state where all backend processes have 3 requests in their queue, except for a single backend process, which has 1 request in its queue.</li>
</ul>
</div>
<div>

The situation looks like this:

</div>
<div>
<div>
<pre>Backend process A:  [*     ]  (1 request in queue)
Backend process B:  [***   ]  (3 requests in queue)
Backend process C:  [***   ]  (3 requests in queue)
Backend process D:  [***   ]  (3 requests in queue)</pre>
</div>
</div>
<div>

Each process is currently serving short-running requests.

</div>
<div>

Phusion Passenger will forward the next request to backend process A. A will now have 2 items in its queue. We’ll mark this new request with an X:

</div>
<div>
<div>
<pre>Backend process A:  [*X    ]  (2 request in queue)
Backend process B:  [***   ]  (3 requests in queue)
Backend process C:  [***   ]  (3 requests in queue)
Backend process D:  [***   ]  (3 requests in queue)</pre>
</div>
</div>
<div>

Assuming that B, C and D still aren’t done with their current request, the next HTTP request - let’s call this Y - will be forwarded to backend process A as well, because it has the least number of items in its queue:

</div>
<div>
<div>
<pre>Backend process A:  [*XY   ]  (3 requests in queue)
Backend process B:  [***   ]  (3 requests in queue)
Backend process C:  [***   ]  (3 requests in queue)
Backend process D:  [***   ]  (3 requests in queue)</pre>
</div>
</div>
<div>

But if request X happens to be a long-running request that needs 60 seconds to complete, then we’ll have a problem. Y won’t be processed for at least 60 seconds. It would have been a better idea if Y was forward to processes B, C or D instead, because they only have short-living requests in their queues.

</div>
<div>

This problem will be avoided entirely if you turn global queuing on. With global queuing, all backend processes will share the same queue. The first backend process that becomes available will take from the queue, and so this “queuing-behind-long-running-request” problem will never occur.

</div>
</div>
<div>
<h3 id="_passengerenabled_lt_on_off_gt">5.6. PassengerEnabled &lt;on|off&gt;</h3>
<div>

You can set this option to <em>off</em> to completely disable Phusion Passenger for a certain location. This is useful if, for example, you want to integrate a PHP application into the same virtual host as a Rails application.

</div>
<div>

Suppose that you have a Rails application in <em>/apps/foo</em>. Suppose that you’ve dropped Wordpress — a blogging application written in PHP — in <em>/apps/foo/public/wordpress</em>. You can then configure Phusion Passenger as follows:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.foo.com
    DocumentRoot /apps/foo/public
    &lt;Directory /apps/foo/public/wordpress&gt;
        PassengerEnabled off
        AllowOverride all      # &lt;-- Makes Wordpress's .htaccess file work.
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

This way, Phusion Passenger will not interfere with Wordpress.

</div>
<div>

<em>PassengerEnabled</em> may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>on</em>.

</div>
</div>
<div>
<h3 id="PassengerTempDir">5.7. PassengerTempDir &lt;directory&gt;</h3>
<div>

Specifies the directory that Phusion Passenger should use for storing temporary files. This includes things such as Unix socket files, buffered file uploads (see also <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerUploadBufferDir">PassengerUploadBufferDir</a>), etc.

</div>
<div>

This option may be specified once, in the global server configuration. The default temp directory that Phusion Passenger uses is <em>/tmp</em>.

</div>
<div>

This option is especially useful if Apache is not allowed to write to /tmp (which is the case on some systems with strict SELinux policies) or if the partition that /tmp lives on doesn’t have enough disk space.

</div>
<div>
<div>Command line tools</div>
Some Phusion Passenger command line administration tools, such as passenger-status, must know what Phusion Passenger’s temp directory is in order to function properly. You can pass the directory through the PASSENGER_TMPDIR environment variable, or the TMPDIR environment variable (the former will be used if both are specified).

</div>
<div>

For example, if you set <em>PassengerTempDir</em> to <em>/my_temp_dir</em>, then invoke passenger-status after you’ve set the PASSENGER_TMPDIR or TMPDIR environment variable, like this:

</div>
<div>
<div>
<pre>export PASSENGER_TMPDIR=/my_temp-dir
sudo -E passenger-status
# The -E option tells 'sudo' to preserve environment variables.</pre>
</div>
</div>
</div>
<div>
<h3 id="PassengerUploadBufferDir">5.8. PassengerUploadBufferDir &lt;directory&gt;</h3>
<div>

Phusion Passenger buffers large file uploads to disk in order prevent slow file uploads from blocking web applications. By default, a subdirectory in the system’s temporary files directory (or a subdirectory in the directory specified in <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerTempDir">PassengerTempDir</a>, if set) is automatically created for storing these buffered file uploads.

</div>
<div>

This configuration directive allows you to specify a different directory for storing buffered file uploads. If you’ve specified such a directory (as opposed to using Phusion Passenger’s default) then you <strong>must</strong> ensure that this directory exists.

</div>
<div>

This configuration directive is also useful if you’re using apache2-mpm-itk. The buffered file upload directory that Phusion Passenger creates by default has very strict permissions: it can only be accessed by the Apache worker processes. However, Phusion Passenger assumes that all Apache worker processes are running as the same user. apache2-mpm-itk breaks this assumption by running multiple Apache worker processes as different users. So if you’re using apace2-mpm-itk, you should set this option to a directory that is writable by all Apache worker processes, such as <em>/tmp</em>.

</div>
<div>

You may specify <em>PassengerUploadBufferDir</em> in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverrides Options is enabled.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once.

</div>
</div>
<div>
<h3 id="_passengerrestartdir_lt_directory_gt">5.9. PassengerRestartDir &lt;directory&gt;</h3>
<div>

As described in the deployment chapters of this document, Phusion Passenger checks the file <em>tmp/restart.txt</em> in the applications' <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#application_root">root directory</a> for restarting applications. Sometimes it may be desirable for Phusion Passenger to look in a different directory instead, for example for security reasons (see below). This option allows you to customize the directory in which <em>restart.txt</em> is searched for.

</div>
<div>

You may specify <em>PassengerRestartDir</em> in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverrides Options is enabled.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once.

</div>
<div>

You can either set it to an absolute directory, or to a directory relative to the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#application_root">application root</a>. Examples:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.foo.com
    # Phusion Passenger will check for /apps/foo/public/tmp/restart.txt
    DocumentRoot /apps/foo/public
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    ServerName www.bar.com
    DocumentRoot /apps/bar/public
    # An absolute filename is given; Phusion Passenger will
    # check for /restart_files/bar/restart.txt
    PassengerRestartDir /restart_files/bar
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    ServerName www.baz.com
    DocumentRoot /apps/baz/public
    # A relative filename is given; Phusion Passenger will
    # check for /apps/baz/restart_files/restart.txt
    #
    # Note that this directory is relative to the APPLICATION ROOT, *not*
    # the value of DocumentRoot!
    PassengerRestartDir restart_files
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>
<div>What are the security reasons for wanting to customize PassengerRestartDir?</div>
Touching restart.txt will cause Phusion Passenger to restart the application. So anybody who can touch restart.txt can effectively cause a Denial-of-Service attack by touching restart.txt over and over. If your web server or one of your web applications has the permission to touch restart.txt, and one of them has a security flaw which allows an attacker to touch restart.txt, then that will allow the attacker to cause a Denial-of-Service.

</div>
<div>

You can prevent this from happening by pointing PassengerRestartDir to a directory that’s readable by Apache, but only writable by administrators.

</div>
</div>
<div>
<h3 id="PassengerBufferResponse">5.10. PassengerBufferResponse &lt;on|off&gt;</h3>
<div>

When turned on, application-generated responses are buffered in memory. By buffering responses, protection is provided against slow HTTP clients that can not read your response immediately.

</div>
<div>

For example, consider an HTTP client that’s on a dial-up modem link, and your application instance generates a 2 MB response. If response buffering is turned off then your application instance will be blocked until the entire 2 MB has been sent out to the HTTP client. This disallows your application instance to do any useful work in the mean time. By enabling response buffering, Phusion Passenger will read the application response as quickly as possible and will take care of slow clients.

</div>
<div>

However, keep in mind that enabling this option will make streaming responses impossible. Consider for example this piece of Rails code:

</div>
<div>
<div>
<pre>render :text =&gt; lambda { |response, output|
    10.times do |i|
        output.write("entry #{i}\n")
        output.flush
        sleep 1
    end
}</pre>
</div>
</div>
<div>

…or this piece of Rack code:

</div>
<div>
<div>
<pre>class Response
    def each
        10.times do |i|
            yield("entry #{i}\n")
            sleep 1
        end
    end
end

app = lambda do |env|
    [200, { "Content-Type" =&gt; "text/plain" }, Response.new]
end</pre>
</div>
</div>
<div>

When response buffering is turned on, Phusion Passenger will wait until the application is done sending the entire response before forwarding it to the client. The client will not receive anything for 10 seconds, after which it receives the entire response at once. When response buffering is turned off, it works as expected: the client receives an "entry X" message every second for 10 seconds.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>on</em>.

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>
<div>

The <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerBufferResponse">PassengerBufferResponse</a> directive should be turned off if responses can be huge. Because entire responses are buffered in memory when turned on.

</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h3 id="_security_options">5.11. Security options</h3>
<div>
<h4 id="PassengerUserSwitching">5.11.1. PassengerUserSwitching &lt;on|off&gt;</h4>
<div>

Whether to enable <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#user_switching">user switching support</a>.

</div>
<div>

This option may only occur once, in the global server configuration. The default value is <em>on</em>.

</div>
</div>
<div>
<h4 id="_passengeruser_lt_username_gt">5.11.2. PassengerUser &lt;username&gt;</h4>
<div>

If <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#user_switching">user switching support</a> is enabled, then Phusion Passenger will by default run the web application as the owner of the file <em>config/environment.rb</em> (for Rails apps) or <em>config.ru</em> (for Rack apps). This option allows you to override that behavior and explicitly set a user to run the web application as, regardless of the ownership of <em>environment.rb</em>/<em>config.ru</em>.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once.

</div>
</div>
<div>
<h4 id="_passengergroup_lt_group_name_gt">5.11.3. PassengerGroup &lt;group name&gt;</h4>
<div>

If <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#user_switching">user switching support</a> is enabled, then Phusion Passenger will by default run the web application as the primary group of the owner of the file <em>config/environment.rb</em> (for Rails apps) or <em>config.ru</em> (for Rack apps). This option allows you to override that behavior and explicitly set a group to run the web application as, regardless of the ownership of <em>environment.rb</em>/<em>config.ru</em>.

</div>
<div>

<em>&lt;group name&gt;</em> may also be set to the special value <em>!STARTUP_FILE!</em>, in which case the web application’s group will be set to <em>environment.rb</em>/<em>config.ru</em>'s group.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once.

</div>
</div>
<div>
<h4 id="PassengerDefaultUser">5.11.4. PassengerDefaultUser &lt;username&gt;</h4>
<div>

Phusion Passenger enables <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#user_switching">user switching support</a> by default. This configuration option allows one to specify the user that applications must run as, if user switching fails or is disabled.

</div>
<div>

This option may only occur once, in the global server configuration. The default value is <em>nobody</em>.

</div>
</div>
<div>
<h4 id="PassengerDefaultGroup">5.11.5. PassengerDefaultGroup &lt;group name&gt;</h4>
<div>

Phusion Passenger enables <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#user_switching">user switching support</a> by default. This configuration option allows one to specify the group that applications must run as, if user switching fails or is disabled.

</div>
<div>

This option may only occur once, in the global server configuration. The default value is the primary group of the user specifified by <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerDefaultUser">PassengerDefaultUser</a>.

</div>
</div>
<div>
<h4 id="_passengerfriendlyerrorpages_lt_on_off_gt">5.11.6. PassengerFriendlyErrorPages &lt;on|off&gt;</h4>
<div>

Phusion Passenger can display friendly error pages whenever an application fails to start. This friendly error page presents the startup error message, some suggestions for solving the problem, and a backtrace. This feature is very useful during application development and useful for less experienced system administrators, but the page might reveal potentially sensitive information, depending on the application. Experienced system administrators who are using Phusion Passenger on serious production servers should consider turning this feature off.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Options is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>on</em>.

</div>
</div>
</div>
<div>
<h3 id="_resource_control_and_optimization_options">5.12. Resource control and optimization options</h3>
<div>
<h4 id="_passengermaxpoolsize_lt_integer_gt">5.12.1. PassengerMaxPoolSize &lt;integer&gt;</h4>
<div>

The maximum number of Ruby on Rails or Rack application instances that may be simultaneously active. A larger number results in higher memory usage, but improved ability to handle concurrent HTTP clients.

</div>
<div>

The optimal value depends on your system’s hardware and the server’s average load. You should experiment with different values. But generally speaking, the value should be at least equal to the number of CPUs (or CPU cores) that you have. If your system has 2 GB of RAM, then we recommend a value of <em>30</em>. If your system is a Virtual Private Server (VPS) and has about 256 MB RAM, and is also running other services such as MySQL, then we recommend a value of <em>2</em>.

</div>
<div>

If you find that your server is unable to handle the load on your Rails/Rack websites (i.e. running out of memory) then you should lower this value. (Though if your sites are really that popular, then you should strongly consider upgrading your hardware or getting more servers.)

</div>
<div>

This option may only occur once, in the global server configuration. The default value is <em>6</em>.

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/tip.png" alt="Tip" /></td>
<td>We strongly recommend you to <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#reducing_memory_usage">use Ruby Enterprise Edition</a>. This allows you to reduce the memory usage of your Ruby on Rails applications by about 33%. And it’s not hard to install.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h4 id="PassengerMinInstances">5.12.2. PassengerMinInstances &lt;integer&gt;</h4>
<div>

This specifies the minimum number of application instances that must be kept around whenever Phusion Passenger cleans up idle instances. You should set this option to a non-zero value if you want to avoid potentially long startup times after a website has been idle for an extended period.

</div>
<div>

Please note that this option does <strong>not</strong> pre-start application instances during Apache startup. It just makes sure that when the application is first accessed:

</div>
<div>
<ol>
    <li>at least the given number of instances will be spawned.</li>
    <li>the given number of processes will be kept around even when instances are being idle cleaned (see <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerPoolIdleTime">PassengerPoolIdleTime</a>).</li>
</ol>
</div>
<div>

If you want to pre-start application instances during Apache startup, then you should use the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerPreStart">PassengerPreStart</a> directive, possibly in combination with <em>PassengerMinInstances</em>. This behavior might seem counter-intuitive at first sight, but <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerPreStart">PassengerPreStart</a> explains the rationale behind it.

</div>
<div>

For example, suppose that you have the following configuration:

</div>
<div>
<div>
<pre>PassengerMaxPoolSize 15
PassengerPoolIdleTime 10

&lt;VirtualHost *:80&gt;
    ServerName foobar.com
    DocumentRoot /webapps/foobar/public
    PassengerMinInstances 3
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

When you start Apache, there are 0 application instances for <em>foobar.com</em>. Things will stay that way until someone visits <em>foobar.com</em>. Suppose that there is only 1 visitor. 1 application instance will be started immediately to serve the visitor, while 2 will be spawned in the background. After 10 seconds, when the idle timeout has been reached, these 3 application instances will not be cleaned up.

</div>
<div>

Now suppose that there’s a sudden spike of traffic, and 100 users visit <em>foobar.com</em> simultanously. Phusion Passenger will start 12 more application instances. After the idle timeout of 10 seconds have passed, Phusion Passenger will clean up 12 application instances, keeping 3 instances around.

</div>
<div>

The PassengerMinInstances option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Limits is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>1</em>.

</div>
</div>
<div>
<h4 id="_passengermaxinstancesperapp_lt_integer_gt">5.12.3. PassengerMaxInstancesPerApp &lt;integer&gt;</h4>
<div>

The maximum number of application instances that may be simultaneously active for a single application. This helps to make sure that a single application will not occupy all available slots in the application pool.

</div>
<div>

This value must be less than <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerMaxPoolSize">PassengerMaxPoolSize</a>. A value of 0 means that there is no limit placed on the number of instances a single application may use, i.e. only the global limit of <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerMaxPoolSize">PassengerMaxPoolSize</a> will be enforced.

</div>
<div>

This option may only occur once, in the global server configuration. The default value is <em>0</em>.

</div>
</div>
<div>
<h4 id="PassengerPoolIdleTime">5.12.4. PassengerPoolIdleTime &lt;integer&gt;</h4>
<div>

The maximum number of seconds that an application instance may be idle. That is, if an application instance hasn’t received any traffic after the given number of seconds, then it will be shutdown in order to conserve memory.

</div>
<div>

Decreasing this value means that applications will have to be spawned more often. Since spawning is a relatively slow operation, some visitors may notice a small delay when they visit your Rails/Rack website. However, it will also free up resources used by applications more quickly.

</div>
<div>

The optimal value depends on the average time that a visitor spends on a single Rails/Rack web page. We recommend a value of 2 * x, where x is the average number of seconds that a visitor spends on a single Rails/Rack web page. But your mileage may vary.

</div>
<div>

When this value is set to <em>0</em>, application instances will not be shutdown unless it’s really necessary, i.e. when Phusion Passenger is out of worker processes for a given application and one of the inactive application instances needs to make place for another application instance. Setting the value to 0 is recommended if you’re on a non-shared host that’s only running a few applications, each which must be available at all times.

</div>
<div>

This option may only occur once, in the global server configuration. The default value is <em>300</em>.

</div>
</div>
<div>
<h4 id="PassengerMaxRequests">5.12.5. PassengerMaxRequests &lt;integer&gt;</h4>
<div>

The maximum number of requests an application instance will process. After serving that many requests, the application instance will be shut down and Phusion Passenger will restart it. A value of 0 means that there is no maximum: an application instance will thus be shut down when its idle timeout has been reached.

</div>
<div>

This option is useful if your application is leaking memory. By shutting it down after a certain number of requests, all of its memory is guaranteed to be freed by the operating system.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Limits is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>0</em>.

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/caution.png" alt="Caution" /></td>
<td>
<div>

The <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerMaxRequests">PassengerMaxRequests</a> directive should be considered as a workaround for misbehaving applications. It is advised that you fix the problem in your application rather than relying on these directives as a measure to avoid memory leaks.

</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h4 id="_passengerstatthrottlerate_lt_integer_gt">5.12.6. PassengerStatThrottleRate &lt;integer&gt;</h4>
<div>

By default, Phusion Passenger performs several filesystem checks (or, in programmers jargon, <em>stat() calls</em>) each time a request is processed:

</div>
<div>
<ul>
    <li>It checks whether <em>config/environment.rb</em>, <em>config.ru</em> or <em>passenger_wsgi.py</em> is present, in order to autodetect Rails, Rack and WSGI applications.</li>
    <li>It checks whether <em>restart.txt</em> has changed or whether <em>always_restart.txt</em> exists, in order to determine whether the application should be restarted.</li>
</ul>
</div>
<div>

On some systems where disk I/O is expensive, e.g. systems where the harddisk is already being heavily loaded, or systems where applications are stored on NFS shares, these filesystem checks can incur a lot of overhead.

</div>
<div>

You can decrease or almost entirely eliminate this overhead by setting <em>PassengerStatThrottleRate</em>. Setting this option to a value of <em>x</em> means that the above list of filesystem checks will be performed at most once every <em>x</em> seconds. Setting it to a value of <em>0</em> means that no throttling will take place, or in other words, that the above list of filesystem checks will be performed on every request.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Limits is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>0</em>.

</div>
</div>
<div>
<h4 id="PassengerPreStart">5.12.7. PassengerPreStart &lt;url&gt;</h4>
<div>

By default, Phusion Passenger does not start any application instances until said web application is first accessed. The result is that the first visitor of said web application might experience a small delay as Phusion Passenger is starting the web application on demand. If that is undesirable, then this directive can be used to pre-started application instances during Apache startup.

</div>
<div>

A few things to be careful of:

</div>
<div>
<ul>
    <li>This directive accepts the <strong>URL</strong> of the web application you want to pre-start, not a on/off value! This might seem a bit weird, but read on for rationale. As for the specifics of the URL:
<div>
<ul>
    <li>The domain part of the URL must be equal to the value of the <em>ServerName</em> directive of the VirtualHost block that defines the web application.</li>
    <li>Unless the web application is deployed on port 80, the URL should contain the web application’s port number too.</li>
    <li>The path part of the URL must point to some URI that the web application handles.</li>
</ul>
</div></li>
    <li>You will probably want to combine this option with <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerMinInstances">PassengerMinInstances</a> because application instances started with <em>PassengerPreStart</em> are subject to the usual idle timeout rules. See the example below for an explanation.</li>
</ul>
</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
</ul>
</div>
<div>

In each place, it may be specified any number of times.

</div>
<div>
<h5 id="_example_1_basic_usage">Example 1: basic usage</h5>
<div>

Suppose that you have the following web applications.

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
   ServerName foo.com
   DocumentRoot /webapps/foo/public
&lt;/VirtualHost&gt;

&lt;VirtualHost *:3500&gt;
   ServerName bar.com
   DocumentRoot /webapps/bar/public
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

You want both of them to be pre-started during Apache startup. The URL for foo.com is <em>http://foo.com/</em> (or, equivalently, <em>http://foo.com:80/</em>) and the URL for bar.com is <em>http://bar.com:3500/</em>. So we add two PassengerPreStart directives, like this:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
   ServerName foo.com
   DocumentRoot /webapps/foo/public
&lt;/VirtualHost&gt;

&lt;VirtualHost *:3500&gt;
   ServerName bar.com
   DocumentRoot /webapps/bar/public
&lt;/VirtualHost&gt;

PassengerPreStart http://foo.com/           # &lt;--- added
PassengerPreStart http://bar.com:3500/      # &lt;--- added</pre>
</div>
</div>
</div>
<div>
<h5 id="_example_2_pre_starting_apps_that_are_deployed_in_sub_uris">Example 2: pre-starting apps that are deployed in sub-URIs</h5>
<div>

Suppose that you have a web application deployed in a sub-URI <em>/store</em>, like this:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
   ServerName myblog.com
   DocumentRoot /webapps/wordpress
   RailsBaseURI /store
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

Then specify the domain name of its containing virtual host followed by the sub-URI, like this:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
   ServerName myblog.com
   DocumentRoot /webapps/wordpress
   RailsBaseURI /store
&lt;/VirtualHost&gt;

PassengerPreStart http://myblog.com/store    # &lt;----- added</pre>
</div>
</div>
<div>

The sub-URI <strong>must</strong> be included; if you don’t then the directive will have no effect. The following example is wrong and won’t pre-start the store web application:

</div>
<div>
<div>
<pre>PassengerPreStart http://myblog.com/    # &lt;----- WRONG! Missing "/store" part.</pre>
</div>
</div>
</div>
<div>
<h5 id="_example_3_combining_with_passengermininstances">Example 3: combining with PassengerMinInstances</h5>
<div>

Application instances started with PassengerPreStart are also subject to the idle timeout rules as specified by <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerPoolIdleTime">PassengerPoolIdleTime</a>! That means that by default, the pre-started application instances for foo.com are bar.com are shut down after a few minutes of inactivity. If you don’t want that to happen, then you should combine PassengerPreStart with <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerMinInstances">PassengerMinInstances</a>, like this:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
   ServerName foo.com
   DocumentRoot /webapps/foo/public
   PassengerMinInstances 1      # &lt;--- added
&lt;/VirtualHost&gt;

&lt;VirtualHost *:3500&gt;
   ServerName bar.com
   DocumentRoot /webapps/bar/public
   PassengerMinInstances 1      # &lt;--- added
&lt;/VirtualHost&gt;

PassengerPreStart http://foo.com/
PassengerPreStart http://bar.com:3500/</pre>
</div>
</div>
</div>
<div>
<h5 id="_so_why_a_url_why_not_just_an_on_off_flag">So why a URL? Why not just an on/off flag?</h5>
<div>

A directive that accepts a simple on/off flag is definitely more intuitive, but due technical difficulties w.r.t. the way Apache works, it’s very hard to implement it like that:

</div>
<div>
<ul>
    <li>It is very hard to obtain a full list of web applications defined in the Apache configuration file(s). In other words, it’s hard for Phusion Passenger to know which web applications are deployed on Apache until a web application is first accessed, and without such a list Phusion Passenger wouldn’t know which web applications to pre-start. It’s probably not completely impossible to obtain such a list, but this brings us to the following point;</li>
    <li>Users expect things like <em>mod_env</em> to work even in combination with Phusion Passenger. For example some people put “SetEnv PATH=….” in their virtual host block and they expect the web application to pick that environment variable up when it’s started. Information like this is stored in module-specific locations that Phusion Passenger cannot access directly. Even if the previous bullet point is solved and we can obtain a list of web applications, we cannot start the application with the correct mod_env information. mod_env is just one such example; there are probably many other Apache modules, all of which people expect to work, but we cannot answer to those expectations if PassengerPreStart is implemented as a simple on/off flag.</li>
</ul>
</div>
<div>

So as a compromise, we made it accept a URL. This is easier to implement for us and altough it looks weird, it behaves consistently w.r.t. cooperation with other Apache modules.

</div>
</div>
<div>
<h5 id="_what_does_phusion_passenger_do_with_the_url">What does Phusion Passenger do with the URL?</h5>
<div>

During Apache startup, Phusion Passenger will send a dummy HEAD request to the given URL and discard the result. In other words, Phusion Passenger simulates a web access at the given URL. However this simulated request is always sent to localhost, <strong>not</strong> to the IP that the domain resolves to. Suppose that bar.com in example 1 resolves to 209.85.227.99; Phusion Passenger will send the following HTTP request to 127.0.0.1 port 3500 (and not to 209.85.227.99 port 3500):

</div>
<div>
<div>
<pre>HEAD / HTTP/1.1
Host: bar.com
Connection: close</pre>
</div>
</div>
<div>

Similarly, for example 2, Phusion Passenger will send the following HTTP request to 127.0.0.1 port 80:

</div>
<div>
<div>
<pre>HEAD /store HTTP/1.1
Host: myblog.com
Connection: close</pre>
</div>
</div>
</div>
<div>
<h5 id="_do_i_need_to_edit_etc_hosts_and_point_the_domain_in_the_url_to_127_0_0_1">Do I need to edit /etc/hosts and point the domain in the URL to 127.0.0.1?</h5>
<div>

No. See previous subsection.

</div>
</div>
<div>
<h5 id="_my_web_application_consists_of_multiple_web_servers_what_url_do_i_need_to_specify_and_in_which_web_server_8217_s_apache_config_file">My web application consists of multiple web servers. What URL do I need to specify, and in which web server’s Apache config file?</h5>
<div>

Put the web application’s virtual host’s ServerName value and the virtual host’s port in the URL, and put PassengerPreStart on all machines that you want to pre-start the web application on. The simulated web request is always sent to 127.0.0.1, with the domain name in the URL as value for the <em>Host</em> HTTP header, so you don’t need to worry about the request ending up at a different web server in the cluster.

</div>
</div>
<div>
<h5 id="_does_passengerprestart_support_https_urls">Does PassengerPreStart support https:// URLs?</h5>
<div>

Yes. And it does not perform any certificate validation.

</div>
</div>
</div>
<div>
<h4 id="PassengerHighPerformance">5.12.8. PassengerHighPerformance &lt;on|off&gt;</h4>
<div>

By default, Phusion Passenger is compatible with mod_rewrite and most other Apache modules. However, a lot of effort is required in order to be compatible. If you turn <em>PassengerHighPerformance</em> to <em>on</em>, then Phusion Passenger will be a little faster, in return for reduced compatibility with other Apache modules.

</div>
<div>

In places where <em>PassengerHighPerformance</em> is turned on, mod_rewrite rules will likely not work. mod_autoindex (the module which displays a directory index) will also not work. Other Apache modules may or may not work, depending on what they exactly do. We recommend you to find out how other modules behave in high performance mode via testing.

</div>
<div>

This option is <strong>not</strong> an all-or-nothing global option: you can enable high performance mode for certain virtual hosts or certain URLs only. The <em>PassengerHighPerformance</em> option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>off</em>, so high performance mode is disabled by default, and you have to explicitly enable it.

</div>
<div>
<div>When to enable high performance mode?</div>
If you do not use mod_rewrite or other Apache modules then it might make sense to enable high performance mode.

</div>
<div>

It’s likely that some of your applications depend on mod_rewrite or other Apache modules, while some do not. In that case you can enable high performance for only those applications that don’t use other Apache modules. For example:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.foo.com
    DocumentRoot /apps/foo/public
    .... mod_rewrite rules or options for other Apache modules here ...
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    ServerName www.bar.com
    DocumentRoot /apps/bar/public
    PassengerHighPerformance on
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

In the above example, high performance mode is only enabled for www.bar.com. It is disabled for everything else.

</div>
<div>

If your application generally depends on mod_rewrite or other Apache modules, but a certain URL that’s accessed often doesn’t depend on those other modules, then you can enable high performance mode for a certain URL only. For example:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.foo.com
    DocumentRoot /apps/foo/public
    .... mod_rewrite rules or options for other Apache modules here ...

    &lt;Location /chatroom/ajax_update_poll&gt;
        PassengerHighPerformance on
    &lt;/Location&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

This enables high performance mode for <a href="http://www.foo.com/chatroom/ajax_update_poll">http://www.foo.com/chatroom/ajax_update_poll</a> only.

</div>
</div>
</div>
<div>
<h3 id="_compatibility_options">5.13. Compatibility options</h3>
<div>
<h4 id="PassengerResolveSymlinksInDocumentRoot">5.13.1. PassengerResolveSymlinksInDocumentRoot &lt;on|off&gt;</h4>
<div>

Configures whether Phusion Passenger should resolve symlinks in the document root. Please refer to <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#application_detection">How Phusion Passenger detects whether a virtual host is a web application</a> for more information.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Options is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. It is off by default.

</div>
</div>
<div>
<h4 id="_passengerallowencodedslashes_lt_on_off_gt">5.13.2. PassengerAllowEncodedSlashes &lt;on|off&gt;</h4>
<div>

By default, Apache doesn’t support URLs with encoded slashes (%2f), e.g. URLs like this: /users/fujikura%2fyuu. If you access such an URL then Apache will return a 404 Not Found error. This can be solved by turning on PassengerAllowEncodedSlashes as well as Apache’s <a href="http://httpd.apache.org/docs/2.0/mod/core.html#allowencodedslashes">AllowEncodedSlashes</a>.

</div>
<div>

Is it important that you turn on both AllowEncodedSlashes <strong>and</strong> PassengerAllowEncodedSlashes, otherwise this feature will not work properly.

</div>
<div>

PassengerAllowEncodedSlashes may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Options is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. It is off by default.

</div>
<div>

Please note however that turning on support for encoded slashes will break support for mod_rewrite passthrough rules. Because of bugs/limitations in Apache, Phusion Passenger can support either encoded slashes or mod_rewrite passthrough rules, but not both at the same time. Luckily this option can be specified anywhere, so you can enable it only for virtual hosts or URLs that need it:

</div>
<div>
<div>
<pre>&lt;VirtualHost *:80&gt;
    ServerName www.example.com
    DocumentRoot /webapps/example/public
    AllowEncodedSlashes on
    RewriteEngine on

    # Check for maintenance file and redirect all requests
    RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
    RewriteCond %{SCRIPT_FILENAME} !maintenance.html
    RewriteRule ^.*$ /system/maintenance.html [L]

    # Make /about an alias for /info/about.
    RewriteRule ^/about$ /info/about [PT,L]

    &lt;Location ~ "^/users/"&gt;
        # In a location block so that it doesn't interfere with the
        # above /about mod_rewrite rule.
        PassengerAllowEncodedSlashes on
    &lt;/Location&gt;
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

With this, <a href="http://www.example.com/users/fujikura%2fyuu">http://www.example.com/users/fujikura%2fyuu</a> will work properly, and accessing <a href="http://www.example.com/about">http://www.example.com/about</a> will properly display the result of <a href="http://www.example.com/info/about">http://www.example.com/info/about</a>. Notice that PassengerAllowEncodedSlashes only interferes with passthrough rules, not with any other mod_rewrite rules. The rules for displaying maintenance.html will work fine even for URLs starting with "/users".

</div>
</div>
</div>
<div>
<h3 id="_logging_and_debugging_options">5.14. Logging and debugging options</h3>
<div>
<h4 id="_passengerloglevel_lt_integer_gt">5.14.1. PassengerLogLevel &lt;integer&gt;</h4>
<div>

This option allows one to specify how much information Phusion Passenger should write to the Apache error log file. A higher log level value means that more information will be logged.

</div>
<div>

Possible values are:

</div>
<div>
<ul>
    <li><em>0</em>: Show only errors and warnings.</li>
    <li><em>1</em>: Show the most important debugging information. This might be useful for system administrators who are trying to figure out the cause of a problem.</li>
    <li><em>2</em>: Show more debugging information. This is typically only useful for developers.</li>
    <li><em>3</em>: Show even more debugging information.</li>
</ul>
</div>
<div>

This option may only occur once, in the global server configuration. The default is <em>0</em>.

</div>
</div>
<div>
<h4 id="_passengerdebuglogfile_lt_filename_gt">5.14.2. PassengerDebugLogFile &lt;filename&gt;</h4>
<div>

By default Phusion Passenger debugging and error messages are written to the global web server error log. This option allows one to specify the file that debugging and error messages should be written to instead.

</div>
<div>

This option may only occur once, in the global server configuration.

</div>
</div>
</div>
<div>
<h3 id="_ruby_on_rails_specific_options">5.15. Ruby on Rails-specific options</h3>
<div>
<h4 id="_railsautodetect_lt_on_off_gt">5.15.1. RailsAutoDetect &lt;on|off&gt;</h4>
<div>

Whether Phusion Passenger should automatically detect whether a virtual host’s document root is a Ruby on Rails application. The default is <em>on</em>.

</div>
<div>

This option may occur in the global server configuration or in a virtual host configuration block.

</div>
<div>

For example, consider the following configuration:

</div>
<div>
<div>
<pre>RailsAutoDetect off
&lt;VirtualHost *:80&gt;
    ServerName www.mycook.com
    DocumentRoot /webapps/mycook/public
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

If one goes to <em>http://www.mycook.com/</em>, the visitor will see the contents of the <em>/webapps/mycook/public</em> folder, instead of the output of the Ruby on Rails application.

</div>
<div>

It is possible to explicitly specify that the host is a Ruby on Rails application by using the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#RailsBaseURI">RailsBaseURI</a> configuration option:

</div>
<div>
<div>
<pre>RailsAutoDetect off
&lt;VirtualHost *:80&gt;
    ServerName www.mycook.com
    DocumentRoot /webapps/mycook/public
    RailsBaseURI /           # This line has been added.
&lt;/VirtualHost&gt;</pre>
</div>
</div>
</div>
<div>
<h4 id="RailsBaseURI">5.15.2. RailsBaseURI &lt;uri&gt;</h4>
<div>

Used to specify that the given URI is a Rails application. See <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#deploying_rails_to_sub_uri">Deploying Rails to a sub URI</a> for an example.

</div>
<div>

It is allowed to specify this option multiple times. Do this to deploy multiple Rails applications in different sub-URIs under the same virtual host.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Options is on.</li>
</ul>
</div>
</div>
<div>
<h4 id="rails_env">5.15.3. RailsEnv &lt;string&gt;</h4>
<div>

This option allows one to specify the default RAILS_ENV value.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Options is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>production</em>.

</div>
</div>
<div>
<h4 id="_railsframeworkspawneridletime_lt_integer_gt">5.15.4. RailsFrameworkSpawnerIdleTime &lt;integer&gt;</h4>
<div>

The FrameworkSpawner server (explained in <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#spawning_methods_explained">Spawning methods explained</a>) has an idle timeout, just like the backend processes spawned by Phusion Passenger do. That is, it will automatically shutdown if it hasn’t done anything for a given period.

</div>
<div>

This option allows you to set the FrameworkSpawner server’s idle timeout, in seconds. A value of <em>0</em> means that it should never idle timeout.

</div>
<div>

Setting a higher value will mean that the FrameworkSpawner server is kept around longer, which may slightly increase memory usage. But as long as the FrameworkSpawner server is running, the time to spawn a Ruby on Rails backend process only takes about 40% of the time that is normally needed, assuming that you’re using the <em>smart</em> <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerSpawnMethod">spawning method</a>. So if your system has enough memory, is it recommended that you set this option to a high value or to <em>0</em>.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>1800</em> (30 minutes).

</div>
</div>
<div>
<h4 id="_railsappspawneridletime_lt_integer_gt">5.15.5. RailsAppSpawnerIdleTime &lt;integer&gt;</h4>
<div>

The ApplicationSpawner server (explained in <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#spawning_methods_explained">Spawning methods explained</a>) has an idle timeout, just like the backend processes spawned by Phusion Passenger do. That is, it will automatically shutdown if it hasn’t done anything for a given period.

</div>
<div>

This option allows you to set the ApplicationSpawner server’s idle timeout, in seconds. A value of <em>0</em> means that it should never idle timeout.

</div>
<div>

Setting a higher value will mean that the ApplicationSpawner server is kept around longer, which may slightly increase memory usage. But as long as the ApplicationSpawner server is running, the time to spawn a Ruby on Rails backend process only takes about 10% of the time that is normally needed, assuming that you’re using the <em>smart</em> or <em>smart-lv2</em> <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerSpawnMethod">spawning method</a>. So if your system has enough memory, is it recommended that you set this option to a high value or to <em>0</em>.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>600</em> (10 minutes).

</div>
</div>
</div>
<div>
<h3 id="_rack_specific_options">5.16. Rack-specific options</h3>
<div>
<h4 id="_rackautodetect_lt_on_off_gt">5.16.1. RackAutoDetect &lt;on|off&gt;</h4>
<div>

Whether Phusion Passenger should automatically detect whether a virtual host’s document root is a Rack application. The default is <em>on</em>.

</div>
<div>

This option may occur in the global server configuration or in a virtual host configuration block.

</div>
<div>

For example, consider the following configuration:

</div>
<div>
<div>
<pre>RackAutoDetect off
&lt;VirtualHost *:80&gt;
    ServerName www.rackapp.com
    DocumentRoot /webapps/my_rack_app/public
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div>

If one goes to <em>http://www.rackapp.com/</em>, the visitor will see the contents of the <em>/webapps/my_rack_app/public</em> folder, instead of the output of the Rack application.

</div>
<div>

It is possible to explicitly specify that the host is a Rack application by using the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#RackBaseURI">RackBaseURI</a> configuration option:

</div>
<div>
<div>
<pre>RackAutoDetect off
&lt;VirtualHost *:80&gt;
    ServerName www.rackapp.com
    DocumentRoot /webapps/my_rack_app/public
    RackBaseURI /       # This line was added
&lt;/VirtualHost&gt;</pre>
</div>
</div>
</div>
<div>
<h4 id="RackBaseURI">5.16.2. RackBaseURI &lt;uri&gt;</h4>
<div>

Used to specify that the given URI is a Rack application. See <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#deploying_rack_to_sub_uri">Deploying Rack to a sub URI</a> for an example.

</div>
<div>

It is allowed to specify this option multiple times. Do this to deploy multiple Rack applications in different sub-URIs under the same virtual host.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Options is on.</li>
</ul>
</div>
</div>
<div>
<h4 id="rack_env">5.16.3. RackEnv &lt;string&gt;</h4>
<div>

The given value will be accessible in Rack applications in the RACK_ENV environment variable. This allows one to define the environment in which Rack applications are run, very similar to RAILS_ENV.

</div>
<div>

This option may occur in the following places:

</div>
<div>
<ul>
    <li>In the global server configuration.</li>
    <li>In a virtual host configuration block.</li>
    <li>In a &lt;Directory&gt; or &lt;Location&gt; block.</li>
    <li>In <em>.htaccess</em>, if AllowOverride Options is on.</li>
</ul>
</div>
<div>

In each place, it may be specified at most once. The default value is <em>production</em>.

</div>
</div>
</div>
<div>
<h3 id="_deprecated_options">5.17. Deprecated options</h3>
<div>

The following options have been deprecated, but are still supported for backwards compatibility reasons.

</div>
<div>
<h4 id="_railsruby">5.17.1. RailsRuby</h4>
<div>

Deprecated in favor of <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerRuby">PassengerRuby</a>.

</div>
</div>
<div>
<h4 id="_railsuserswitching">5.17.2. RailsUserSwitching</h4>
<div>

Deprecated in favor of <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerUserSwitching">PassengerUserSwitching</a>.

</div>
</div>
<div>
<h4 id="_railsdefaultuser">5.17.3. RailsDefaultUser</h4>
<div>

Deprecated in favor of <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerDefaultUser">PassengerDefaultUser</a>.

</div>
</div>
<div>
<h4 id="_railsallowmodrewrite">5.17.4. RailsAllowModRewrite</h4>
<div>

This option doesn’t do anything anymore in recent versions of Phusion Passenger.

</div>
</div>
<div>
<h4 id="_railsspawnmethod">5.17.5. RailsSpawnMethod</h4>
<div>

Deprecated in favor of <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerSpawnMethod">PassengerSpawnMethod</a>.

</div>
</div>
</div>
</div>
</div>


<div>
<h2 id="_troubleshooting">6. Troubleshooting</h2>
<div>
<div>
<h3 id="_operating_system_specific_problems">6.1. Operating system-specific problems</h3>
<div>
<h4 id="_macos_x_the_installer_cannot_locate_mamp_8217_s_apache">6.1.1. MacOS X: The installer cannot locate MAMP’s Apache</h4>
<div>
<div>
<div>Symptoms</div>
<div>

The installer finds Apache 2 development headers at /Applications/MAMP/Library/bin/apxs. However, Apache cannot be found. The installer also outputs the following error:

</div>
<div>
<div>
<pre>cannot open /Applications/MAMP/Library/build/config_vars.mk:
No such file or directory at /Applications/MAMP/Library/bin/apxs line 218.</pre>
</div>
</div>
</div>
</div>
<div>

Your MAMP installation seems to be broken. In particular, <em>config_vars.mk</em> is missing. Please read <a href="http://forum.mamp.info/viewtopic.php?t=1866">this forum topic</a> to learn how to fix this problem.

</div>
<div>

See also <a href="http://code.google.com/p/phusion-passenger/issues/detail?id=12">this bug report</a>.

</div>
</div>
</div>
<div>
<h3 id="_problems_during_installation">6.2. Problems during installation</h3>
<div>
<h4 id="installing_ruby_dev">6.2.1. Ruby development headers aren’t installed</h4>
<div>
<div>
<div>Symptoms</div>
<div>

Installing Phusion Passenger fails because of one of the following errors:

</div>
<div>
<ul>
    <li>The Phusion Passenger installer tells you that the Ruby development headers aren’t installed.</li>
    <li>The error message “'no such file to load — mkmf”' occurs.</li>
    <li>The error message “'ruby.h: No such file or directory”' occurs.</li>
</ul>
</div>
</div>
</div>
<div>

Phusion Passenger makes use of a native extension, so the Ruby development headers must be installed. On most Linux systems, Ruby and the Ruby development headers are contained in separate packages, so having Ruby installed does not automatically imply having the development headers installed.

</div>
<div>

Here’s how you can install the development headers:

</div>
<div><dl><dt>Ubuntu/Debian</dt><dd>Please type:
<div>
<div>
<pre>sudo apt-get install ruby1.8-dev</pre>
</div>
</div>
</dd><dt>Fedora/CentOS/RHEL</dt><dd>Please type:
<div>
<div>
<pre>su -c 'yum install ruby-devel'</pre>
</div>
</div>
</dd><dt>FreeBSD</dt><dd>Please install Ruby from <em>ports</em> or with pkg_add. If that fails, please install Ruby from source.

</dd><dt>MacOS X</dt><dd>Please install Ruby from source.

</dd><dt>Other operating systems</dt><dd>Please consult your operating system’s native package database. There should be a package containing the Ruby development headers. If that fails, please install Ruby from source.

</dd></dl></div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>If you’ve installed a new Ruby version (i.e. your system now contains multiple Ruby installations), then you will need to tell Phusion Passenger which Ruby installation you want to use. Please read <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#specifying_ruby_installation">Specifying the correct Ruby installation</a>.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h4 id="_apache_development_headers_aren_8217_t_installed">6.2.2. Apache development headers aren’t installed</h4>
<div>
<div>
<div>Symptoms</div>
<div>

Installing Phusion Passenger fails because of one of the following errors:

</div>
<div>
<ul>
    <li>The installer says that the Apache development headers aren’t installed.</li>
    <li>The error message “'httpd.h: No such file or directory”' occurs.
<div>

(Instead of <em>httpd.h</em>, the message might also be <em>http_config.h</em> or something else similar to <em>http_*.h</em>.)

</div></li>
</ul>
</div>
</div>
</div>
<div><dl><dt>Ubuntu</dt><dd>Please type:
<div>
<div>
<pre>sudo apt-get install apache2-prefork-dev</pre>
</div>
</div>
</dd><dt>Debian</dt><dd>Please type:
<div>
<div>
<pre>sudo apt-get install apache2-dev</pre>
</div>
</div>
</dd><dt>Fedora/CentOS/RHEL</dt><dd>Please type:
<div>
<div>
<pre>su -c 'yum install httpd-devel'</pre>
</div>
</div>
</dd><dt>FreeBSD</dt><dd>Please install Apache from <em>ports</em> or with pkg_add. If that fails, please install Apache from source.

</dd><dt>MacOS X</dt><dd>Please install Apache from source.

</dd><dt>Other operating systems</dt><dd>Please consult your operating system’s native package database. There should be a package containing the Apache development headers. If that fails, please install Apache from source.

</dd></dl></div>
</div>
<div>
<h4 id="_apr_development_headers_aren_8217_t_installed">6.2.3. APR development headers aren’t installed</h4>
<div>
<div>
<div>Symptoms</div>
<div>

Installing Phusion Passenger fails because one of the following errors:

</div>
<div>
<ul>
    <li>The installer tells you that APR development headers aren’t installed.</li>
    <li>The error message “'apr_pools.h: No such file or directory”' occurs.</li>
    <li>The error message “'apr_strings.h: No such file or directory”' occurs.</li>
</ul>
</div>
</div>
</div>
<div><dl><dt>Ubuntu</dt><dd>Please type:
<div>
<div>
<pre>sudo apt-get install libapr1-dev</pre>
</div>
</div>
</dd><dt>Debian</dt><dd>Please type:
<div>
<div>
<pre>sudo apt-get install libapr1-dev</pre>
</div>
</div>
</dd><dt>Fedora/CentOS/RHEL</dt><dd>Please type:
<div>
<div>
<pre>su -c 'yum install apr-devel'</pre>
</div>
</div>
</dd><dt>Other Linux distributions</dt><dd>Please consult your distribution’s package database. There should be a package which provides APR development headers.

</dd><dt>Other operating systems</dt><dd>The APR development are bundled with Apache. If the APR headers aren’t, then it probably means that they have been removed after Apache’s been installed. Please reinstall Apache to get back the APR headers.

</dd></dl></div>
</div>
<div>
<h4 id="_phusion_passenger_is_using_the_wrong_apache_during_installation">6.2.4. Phusion Passenger is using the wrong Apache during installation</h4>
<div>

Please <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#specifying_correct_apache_install">Specifying the correct Apache installation</a>, and re-run the Phusion Passenger installer.

</div>
</div>
<div>
<h4 id="_phusion_passenger_is_using_the_wrong_ruby_during_installation">6.2.5. Phusion Passenger is using the wrong Ruby during installation</h4>
<div>

Please <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#specifying_ruby_installation">Specifying the correct Ruby installation</a>, and re-run the Phusion Passenger installer.

</div>
</div>
</div>
<div>
<h3 id="_problems_after_installation">6.3. Problems after installation</h3>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/tip.png" alt="Tip" /></td>
<td>
<div>The golden tip: read your Apache error logs!</div>
<div>

<em>mod_passenger</em> will write all errors to the Apache error log. So if you’re experiencing post-installation problems, please look inside the Apache error logs. It will tell you what exactly went wrong.

</div></td>
</tr>
</tbody>
</table>
</div>
<div>
<h4 id="_my_rails_application_works_on_mongrel_but_not_on_phusion_passenger">6.3.1. My Rails application works on Mongrel, but not on Phusion Passenger</h4>
<div>

Please try setting <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerSpawnMethod">PassengerSpawnMethod</a> to <em>conservative</em>.

</div>
</div>
<div>
<h4 id="_phusion_passenger_has_been_compiled_against_the_wrong_apache_installation">6.3.2. Phusion Passenger has been compiled against the wrong Apache installation</h4>
<div>
<div>
<div>Symptoms</div>
<div>

Apache crashes during startup (after being daemonized). The Apache error log says “'seg fault or similar nasty error detected in the parent process”'.

</div>
</div>
</div>
<div>

This problem is most likely to occur on MacOS X. Most OS X users have multiple Apache installations on their system.

</div>
<div>

To solve this problem, please <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#specifying_correct_apache_install">specify the correct Apache installation</a>, and <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#install_passenger">reinstall Phusion Passenger</a>.

</div>
</div>
<div>
<h4 id="_i_get_a_403_forbidden_error">6.3.3. I get a "403 Forbidden" error</h4>
<div>

See next subsection.

</div>
</div>
<div>
<h4 id="_static_assets_such_as_images_and_stylesheets_aren_8217_t_being_displayed">6.3.4. Static assets such as images and stylesheets aren’t being displayed</h4>
<div>

Static assets are accelerated, i.e. they are served directly by Apache and do not go through the Rails stack. There are two reasons why Apache doesn’t serve static assets correctly:

</div>
<div>
<ol>
    <li>Your Apache configuration is too strict, and does not allow HTTP clients to access static assets. This can be achieved with an Allow from all directive in the correct place. For example:
<div>
<div>
<pre>&lt;Directory "/webapps/mycook/public"&gt;
   Options FollowSymLinks
   AllowOverride None
   Order allow,deny
   Allow from all
&lt;/Directory&gt;</pre>
</div>
</div>
<div>

See also <a href="http://groups.google.com/group/phusion-passenger/browse_thread/thread/9699a639a87f85f4/b9d71a03bf2670a5">this discussion</a>.

</div></li>
    <li>The Apache process doesn’t have permission to access your Rails application’s folder. Please make sure that the Rails application’s folder, as well as all of its parent folders, have the correct permissions and/or ownerships.</li>
</ol>
</div>
</div>
<div>
<h4 id="_the_apache_error_log_says_that_the_spawn_manager_script_does_not_exist_or_that_it_does_not_have_permission_to_execute_it">6.3.5. The Apache error log says that the spawn manager script does not exist, or that it does not have permission to execute it</h4>
<div>

If you are sure that the <em>PassengerRoot</em> configuration option is set correctly, then this problem is most likely caused by the fact that you’re running Apache with SELinux. On Fedora, CentOS and RedHat Enterprise Linux, Apache is locked down by SELinux policies.

</div>
<div>

To solve this problem, you must set some permissions on the Phusion Passenger files and folders, so that Apache can access them.

</div>
<div>
<ul>
    <li>If you’ve installed Phusion Passenger via a gem, then run this command to determine Phusion Passenger’s root folder:
<div>
<div>
<pre>passenger-config --root</pre>
</div>
</div>
<div>

Next, run the following command:

</div>
<div>
<div>
<pre>chcon -R -h -t httpd_sys_content_t /path-to-passenger-root</pre>
</div>
</div>
<div>

where <em>/path-to-passenger-root</em> should be replaced with whatever passenger-config --root printed.

</div></li>
    <li>If you’ve installed Phusion Passenger via the source tarball, then run the following command:
<div>
<div>
<pre>chcon -R -h -t httpd_sys_content_t /path/to/passenger/folder</pre>
</div>
</div></li>
</ul>
</div>
<div>

Once the permissions are fixed, restart Apache.

</div>
</div>
<div>
<h4 id="_the_rails_application_reports_that_it_8217_s_unable_to_start_because_of_a_permission_error">6.3.6. The Rails application reports that it’s unable to start because of a permission error</h4>
<div>

Please check whether your Rails application’s folder has the correct permissions. By default, Rails applications are started as the owner of the file <em>config/environment.rb</em>, except if the file is owned by root. If the file is owned by root, then the Rails application will be started as <em>nobody</em> (or as the user specify by <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#RailsDefaultUser">RailsDefaultUser</a>, if that’s specified).

</div>
<div>

Please read <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#user_switching">User switching (security)</a> for details.

</div>
</div>
<div>
<h4 id="_my_rails_application_8217_s_log_file_is_not_being_written_to">6.3.7. My Rails application’s log file is not being written to</h4>
<div>

There are a couple things that you should be aware of:

</div>
<div>
<ul>
    <li>By default, Phusion Passenger runs Rails applications in <em>production</em> mode, so please be sure to check <em>production.log</em> instead of <em>development.log</em>. See <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#RailsEnv">RailsEnv</a> for configuration.</li>
    <li>By default, Phusion Passenger runs Rails applications as the owner of <em>environment.rb</em>. So the log file can only be written to if that user has write permission to the log file. Please <em>chmod</em> or <em>chown</em> your log file accordingly.
<div>

See <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#User_switching">User switching (security)</a> for details.

</div></li>
</ul>
</div>
<div>

If you’re using a RedHat-derived Linux distribution (such as Fedora or CentOS) then it is <a href="http://code.google.com/p/phusion-passenger/issues/detail?id=4">possible that SELinux is interfering</a>. RedHat’s SELinux policy only allows Apache to read/write directories that have the <em>httpd_sys_content_t</em> security context. Please run the following command to give your Rails application folder that context:

</div>
<div>
<div>
<pre>chcon -R -h -t httpd_sys_content_t /path/to/your/rails/app</pre>
</div>
</div>
</div>
<div>
<h4 id="_i_8217_ve_deployed_my_app_on_ssl_but_the_app_thinks_its_not_on_ssl">6.3.8. I’ve deployed my app on SSL, but the app thinks its not on SSL</h4>
<div>

Rails and many other frameworks infers whether it’s running on SSL through the CGI environment variable HTTPS. Apache always sets this variable when on SSL, except when SSL is incorrectly configured.

</div>
<div>

Most Apache installations already configure SSL by default on port 443 (conf/extra/httpd-ssl.conf). Some people think they can save some typing in subsequent SSL vhost blocks, and omit important options like <em>SSLEngine on</em>, like this:

</div>
<div>
<div>
<pre># httpd-ssl.conf contains something like:
# &lt;VirtualHost _default_:443&gt;
#     SSLEngine on
#     ...
# &lt;/VirtualHost&gt;
Include conf/extra/httpd-ssl.conf

&lt;VirtualHost *:443&gt;
    ServerName www.example.com
    DocumentRoot /webapps/example/public
&lt;/Virtualhost&gt;</pre>
</div>
</div>
<div>

<strong>This is wrong!</strong> In each SSL vhost block you must re-specify all the SSL options. Otherwise Apache won’t properly detect the vhost as an SSL vhost block. Here’s the corrected example:

</div>
<div>
<div>
<pre>Include conf/extra/httpd-ssl.conf

&lt;VirtualHost *:443&gt;
    ServerName www.example.com
    DocumentRoot /webapps/example/public
    SSLEngine on
    ...more SSL options here...
&lt;/Virtualhost&gt;</pre>
</div>
</div>
</div>
</div>
<div>
<h3 id="conflicting_apache_modules">6.4. Conflicting Apache modules</h3>
<div>
<h4 id="_mod_userdir">6.4.1. mod_userdir</h4>
<div>

<em>mod_userdir</em> is not compatible with Phusion Passenger at the moment.

</div>
</div>
<div>
<h4 id="_multiviews_mod_negotiation">6.4.2. MultiViews (mod_negotiation)</h4>
<div>

MultiViews is not compatible with Phusion Passenger. You should disable MultiViews for all Phusion Passenger hosts.

</div>
</div>
<div>
<h4 id="_virtualdocumentroot">6.4.3. VirtualDocumentRoot</h4>
<div>

VirtualDocumentRoot is not compatible with Phusion Passenger at the moment.

</div>
</div>
</div>
</div>
</div>


<div>
<h2 id="_analysis_and_system_maintenance">7. Analysis and system maintenance</h2>
<div>
<div>

Phusion Passenger provides a set of tools, which are useful for system analysis, maintenance and troubleshooting.

</div>
<div>
<h3 id="_inspecting_memory_usage">7.1. Inspecting memory usage</h3>
<div>

Process inspection tools such as ps and top are useful, but they <a href="http://groups.google.com/group/phusion-passenger/msg/1fd1c233456d3180">rarely show the correct memory usage</a>. The real memory usage is usually lower than what ps and top report.

</div>
<div>

There are many technical reasons why this is so, but an explanation is beyond the scope of this Users Guide. We kindly refer the interested reader to operating systems literature about <em>virtual memory</em> and <em>copy-on-write</em>.

</div>
<div>

The tool passenger-memory-stats allows one to easily analyze Phusion Passenger’s and Apache’s real memory usage. For example:

</div>
<div>
<div>
<pre>[bash@localhost root]# passenger-memory-stats
------------- Apache processes --------------.
PID    PPID  Threads  VMSize   Private  Name
---------------------------------------------.
5947   1     9        90.6 MB  0.5 MB   /usr/sbin/apache2 -k start
5948   5947  1        18.9 MB  0.7 MB   /usr/sbin/fcgi-pm -k start
6029   5947  1        42.7 MB  0.5 MB   /usr/sbin/apache2 -k start
6030   5947  1        42.7 MB  0.5 MB   /usr/sbin/apache2 -k start
6031   5947  1        42.5 MB  0.3 MB   /usr/sbin/apache2 -k start
6033   5947  1        42.5 MB  0.4 MB   /usr/sbin/apache2 -k start
6034   5947  1        50.5 MB  0.4 MB   /usr/sbin/apache2 -k start
23482  5947  1        82.6 MB  0.4 MB   /usr/sbin/apache2 -k start
### Processes: 8
### Total private dirty RSS: 3.50 MB

--------- Passenger processes ---------.
PID    Threads  VMSize   Private  Name
---------------------------------------.
6026   1        10.9 MB  4.7 MB   Passenger spawn server
23481  1        26.7 MB  3.0 MB   Passenger FrameworkSpawner: 2.0.2
23791  1        26.8 MB  2.9 MB   Passenger ApplicationSpawner: /var/www/projects/app1-foobar
23793  1        26.9 MB  17.1 MB  Rails: /var/www/projects/app1-foobar
### Processes: 4
### Total private dirty RSS: 27.76 M</pre>
</div>
</div>
<div>

The <em>Private</em> or <em>private dirty RSS</em> field shows the <strong>real</strong> memory usage of processes. Here, we see that all the Apache worker processes only take less than 1 MB memory each. This is a lot less than the 50 MB-ish memory usage as shown in the <em>VMSize</em> column (which is what a lot of people think is the real memory usage, but is actually not).

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>Private dirty RSS reporting only works on Linux. Unfortunately other operating systems don’t provide facilities for determining processes' private dirty RSS. On non-Linux systems, the Resident Set Size is reported instead.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h3 id="_inspecting_phusion_passenger_8217_s_internal_status">7.2. Inspecting Phusion Passenger’s internal status</h3>
<div>

One can inspect Phusion Passenger’s internal status with the tool passenger-status. This tool must typically be run as root. For example:

</div>
<div>
<div>
<pre>[bash@localhost root]# passenger-status
----------- General information -----------
max      = 6
count    = 1
active   = 0
inactive = 1

----------- Domains -----------
/var/www/projects/app1-foobar:
  PID: 9617      Sessions: 0    Processed: 7       Uptime: 2m 23s</pre>
</div>
</div>
<div>

The <em>general information</em> section shows the following information:

</div>
<div><dl><dt>max</dt><dd>The maximum number of application instances that Phusion Passenger will spawn. This equals the value given for <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerMaxPoolSize">PassengerMaxPoolSize</a> (Apache) or <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerMaxPoolSize">passenger_max_pool_size</a> (Nginx).

</dd><dt>count</dt><dd>The number of application instances that are currently alive. This value is always less than or equal to <em>max</em>.

</dd><dt>active</dt><dd>The number of application instances that are currently processing requests. This value is always less than or equal to <em>count</em>.

</dd><dt>inactive</dt><dd>The number of application instances that are currently <strong>not</strong> processing requests, i.e. are idle. Idle application instances will be shutdown after a while, as can be specified with <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerPoolIdleTime">PassengerPoolIdleTime (Apache)</a>/<a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerPoolIdleTime">passenger_pool_idle_time (Nginx)</a> (unless this value is set to 0, in which case application instances are never shut down via idle time). The value of <em>inactive</em> equals count - active.

</dd></dl></div>
<div>

The <em>domains</em> section shows, for each application directory, information about running application instances:

</div>
<div><dl><dt>Sessions</dt><dd>Shows how many HTTP client are currently in the queue of that application Instance, waiting to be processed.

</dd><dt>Processed</dt><dd>Indicates how many requests the instance has served until now. <strong>Tip:</strong> it’s possible to limit this number with the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerMaxRequests">PassengerMaxRequests</a> configuration directive.

</dd><dt>Uptime</dt><dd>Shows for how long the application instance has been running.

</dd></dl></div>
<div>

Since Phusion Passenger uses fair load balancing by default, the number of sessions for the application instances should be fairly close to each other. For example, this is fairly normal:

</div>
<div>
<div>
<pre>  PID: 4281      Sessions: 2      Processed: 7      Uptime: 5m 11s
  PID: 4268      Sessions: 0      Processed: 5      Uptime: 4m 52s
  PID: 4265      Sessions: 1      Processed: 6      Uptime: 5m 38s
  PID: 4275      Sessions: 1      Processed: 7      Uptime: 3m 14s</pre>
</div>
</div>
<div>

But if you see a "spike", i.e. an application instance has an unusually high number of sessions compared to the others, then there might be a problem:

</div>
<div>
<div>
<pre>  PID: 4281      Sessions: 2      Processed: 7      Uptime: 5m 11s
  PID: 17468     Sessions: 8 &lt;-+  Processed: 2      Uptime: 4m 47s
  PID: 4265      Sessions: 1   |  Processed: 6      Uptime: 5m 38s
  PID: 4275      Sessions: 1   |  Processed: 7      Uptime: 3m 14s
                               |
                               +---- "spike"</pre>
</div>
</div>
<div>

Possible reasons why spikes can occur:

</div>
<div>
<ol>
    <li>Your application is busy processing a request that takes a very long time. If this is the case, then you might want to turn <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerUseGlobalQueue">global queuing</a> on.</li>
    <li>Your application is frozen, i.e. has stopped responding. See <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#debugging_frozen">Debugging frozen applications</a> for tips.</li>
</ol>
</div>
</div>
<div>
<h3 id="debugging_frozen">7.3. Debugging frozen applications</h3>
<div>

If one of your application instances is frozen (stopped responding), then you can figure out where it is frozen by killing it with <em>SIGABRT</em>. This will cause the application to raise an exception, with a backtrace.

</div>
<div>

The exception (with full backtrace information) is normally logged into the Apache error log. But if your application or if its web framework has its own exception logging routines, then exceptions might be logged into the application’s log files instead. This is the case with Ruby on Rails. So if you kill a Ruby on Rails application with <em>SIGABRT</em>, please check the application’s <em>production.log</em> first (assuming that you’re running it in a <em>production</em> environment). If you don’t see a backtrace there, check the Apache error log.

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>It is safe to kill application instances, even in live environments. Phusion Passenger will restart killed application instances, as if nothing bad happened.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h3 id="_accessing_individual_application_processes">7.4. Accessing individual application processes</h3>
<div>

When a request is sent to the web server, Phusion Passenger will automatically forward the request to the most suitable application process, but sometimes it is desirable to be able to directly access the individual application processes. Use cases include, but are not limited to:

</div>
<div>
<ul>
    <li>One wants to debug a memory leak or memory bloat problem that only seems to appear on certain URIs. One can send a request to a specific process to see whether that request causes the process’s memory usage to rise.</li>
    <li>The application caches data in local memory, and one wants to tell a specific application process to clear that local data.</li>
    <li>Other debugging use cases.</li>
</ul>
</div>
<div>

All individual application processes are accessible via HTTP, so you can use standard HTTP tools like <em>curl</em>. The exact addresses can be obtained with the command passenger-status --verbose. These sockets are all bound to 127.0.0.1, but the port number is dynamically assigned. As a security measure, the sockets are also protected with a process-specific random password, which you can see in the passenger-status --verbose output. This password must be sent through the “X-Passenger-Connect-Password” HTTP header.

</div>
<div>

Example:

</div>
<div>
<div>
<pre>bash# passenger-status --verbose
----------- General information -----------
max      = 6
count    = 2
active   = 0
inactive = 2
Waiting on global queue: 0

----------- Application groups -----------
/Users/hongli/Sites/rack.test:
  App root: /Users/hongli/Sites/rack.test
  * PID: 24235   Sessions: 0    Processed: 7       Uptime: 17s
      URL     : http://127.0.0.1:58122
      Password: nFfVOX1F8LjZ90HJh28Sd_htJOsgRsNne2QXKf8NIXw
  * PID: 24250   Sessions: 0    Processed: 4       Uptime: 1s
      URL     : http://127.0.0.1:57933
      Password: _RGXlQ9EGDGJKLevQ_qflUtF1KmxEo2UiRzMwIE1sBY</pre>
</div>
</div>
<div>

Here we see that the web application <em>rack.test</em> has two processes. Process 24235 is accessible via <a href="http://127.0.0.1:58122/">http://127.0.0.1:58122</a>, and process 24250 is accessible via <a href="http://127.0.0.1:57933/">http://127.0.0.1:57933</a>.

</div>
<div>

To access 24235 we must send its password, <em>nFfVOX1F8LjZ90HJh28Sd_htJOsgRsNne2QXKf8NIXw</em>, through the <em>X-Passenger-Connect-Password</em> HTTP header, like this:

</div>
<div>
<div>
<pre>bash# curl -H "X-Passenger-Connect-Password: nFfVOX1F8LjZ90HJh28Sd_htJOsgRsNne2QXKf8NIXw" http://127.0.0.1:58122/</pre>
</div>
</div>
</div>
</div>
</div>


<div>
<h2 id="_tips">8. Tips</h2>
<div>
<div>
<h3 id="user_switching">8.1. User switching (security)</h3>
<div>

There is a problem that plagues most PHP web hosts, namely the fact that all PHP applications are run in the same user context as the web server. So for example, Joe’s PHP application will be able to read Jane’s PHP application’s passwords. This is obviously undesirable on many servers.

</div>
<div>

Phusion Passenger solves this problem by implementing <em>user switching</em>. A Rails application is started as the owner of the file <em>config/environment.rb</em>, and a Rack application is started as the owner of the file <em>config.ru</em>. So if <em>/home/webapps/foo/config/environment.rb</em> is owned by <em>joe</em>, then Phusion Passenger will launch the corresponding Rails application as <em>joe</em> as well.

</div>
<div>

This behavior is the default, and you don’t need to configure anything. But there are things that you should keep in mind:

</div>
<div>
<ul>
    <li>The owner of <em>environment.rb</em>/<em>config.ru</em> must have read access to the application’s root directory, and read/write access to the application’s <em>logs</em> directory.</li>
    <li>This feature is only available if Apache is started by <em>root</em>. This is the case on most Apache installations.</li>
    <li>Under no circumstances will applications be run as <em>root</em>. If <em>environment.rb</em>/<em>config.ru</em> is owned as root or by an unknown user, then the Rails/Rack application will run as the user specified by <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerDefaultUser">PassengerDefaultUser</a> and <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerDefaultGroup">PassengerDefaultGroup</a>.</li>
</ul>
</div>
<div>

User switching can be disabled with the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerUserSwitching">PassengerUserSwitching</a> option.

</div>
</div>
<div>
<h3 id="reducing_memory_usage">8.2. Reducing memory consumption of Ruby on Rails applications by 33%</h3>
<div>

Is it possible to reduce memory consumption of your Rails applications by 33% on average, by using <a href="http://www.rubyenterpriseedition.com/">Ruby Enterprise Edition</a>. Please visit the website for details.

</div>
<div>

Note that this feature does not apply to Rack applications.

</div>
</div>
<div>
<h3 id="capistrano">8.3. Capistrano recipe</h3>
<div>

Phusion Passenger can be combined with <a href="http://capify.org/">Capistrano</a>. The following Capistrano recipe demonstrates Phusion Passenger support. It assumes that you’re using Git as version control system.

</div>
<div>
<div>
<pre>set :application, "myapp"
set :domain,      "example.com"
set :repository,  "ssh://#{domain}/path-to-your-git-repo/#{application}.git"
set :use_sudo,    false
set :deploy_to,   "/path-to-your-web-app-directory/#{application}"
set :scm,         "git"

role :app, domain
role :web, domain
role :db,  domain, :primary =&gt; true

namespace :deploy do
  task :start, :roles =&gt; :app do
    run "touch #{current_release}/tmp/restart.txt"
  end

  task :stop, :roles =&gt; :app do
    # Do nothing.
  end

  desc "Restart Application"
  task :restart, :roles =&gt; :app do
    run "touch #{current_release}/tmp/restart.txt"
  end
end</pre>
</div>
</div>
</div>
<div>
<h3 id="bundler_support">8.4. Bundler support</h3>
<div>

Phusion Passenger has automatic support for <a href="http://gembundler.com/git.html">Bundler</a>. It works as follows:

</div>
<div>
<ul>
    <li>If you have a <em>.bundle/environment.rb</em> in your application root, then Phusion Passenger will require that file before loading your application.</li>
    <li>Otherwise, if you have a <em>Gemfile</em>, then Phusion Passenger will automatically call Bundler.setup() before loading your application.</li>
</ul>
</div>
<div>

It’s possible that your application also calls Bundler.setup during loading, e.g. in <em>config.ru</em> or in <em>config/boot.rb</em>. This is the case with Rails 3, and is also the case if you modified your <em>config/boot.rb</em> according to the <a href="http://gembundler.com/rails23.html">Bundler Rails 2.3 instructions</a>. This leads to Bundler.setup being called twice, once before the application startup file is required and once during application startup. However this is harmless and doesn’t have any negative effects.

</div>
<div>

Phusion Passenger assumes that you’re using Bundler &gt;= 0.9.5. If you don’t want Phusion Passenger to run its Bundler support code, e.g. because you need to use an older version of Bundler with an incompatible API or because you use a system other than Bundler, then you can override Phusion Passenger’s Bundler support code by creating a file <em>config/setup_load_paths.rb</em>. If this file exists then it will be required before loading the application startup file. In this file you can do whatever you need to setup Bundler or a similar system.

</div>
</div>
<div>
<h3 id="moving_phusion_passenger">8.5. Moving Phusion Passenger to a different directory</h3>
<div>

It is possible to relocate the Phusion Passenger files to a different directory. It involves two steps:

</div>
<div>
<ol>
    <li>Moving the directory.</li>
    <li>Updating the “PassengerRoot” configuration option in Apache.</li>
</ol>
</div>
<div>

For example, if Phusion Passenger is located in <em>/opt/passenger/</em>, and you’d like to move it to <em>/usr/local/passenger/</em>, then do this:

</div>
<div>
<ol>
    <li>Run the following command:
<div>
<div>
<pre>mv /opt/passenger /usr/local/passenger</pre>
</div>
</div></li>
    <li>Edit your Apache configuration file, and set:
<div>
<div>
<pre>PassengerRoot /usr/local/passenger</pre>
</div>
</div></li>
</ol>
</div>
</div>
<div>
<h3 id="_installing_multiple_ruby_on_rails_versions">8.6. Installing multiple Ruby on Rails versions</h3>
<div>

Each Ruby on Rails applications that are going to be deployed may require a specific Ruby on Rails version. You can install a specific version with this command:

</div>
<div>
<div>
<pre>gem install rails -v X.X.X</pre>
</div>
</div>
<div>

where <em>X.X.X</em> is the version number of Ruby on Rails.

</div>
<div>

All of these versions will exist in parallel, and will not conflict with each other. Phusion Passenger will automatically make use of the correct version.

</div>
</div>
<div>
<h3 id="_making_the_application_restart_after_each_request">8.7. Making the application restart after each request</h3>
<div>

In some situations it might be desirable to restart the web application after each request, for example when developing a non-Rails application that doesn’t support code reloading, or when developing a web framework.

</div>
<div>

To achieve this, simply create the file <em>tmp/always_restart.txt</em> in your application’s root folder. Unlike <em>restart.txt</em>, Phusion Passenger does not check for this file’s timestamp: Phusion Passenger will always restart the application, as long as <em>always_restart.txt</em> exists.

</div>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>If you’re just developing a Rails application then you probably don’t need this feature. If you set <em>RailsEnv development</em> in your Apache configuration, then Rails will automatically reload your application code after each request. <em>always_restart.txt</em> is only useful if you’re working on Ruby on Rails itself, or when you’re not developing a Rails application and your web framework does not support code reloading.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div>
<h3 id="sub_uri_deployment_uri_fix">8.8. How to fix broken images/CSS/JavaScript URIs in sub-URI deployments</h3>
<div>

Some people experience broken images and other broken static assets when they deploy their application to a sub-URI (i.e. <em>http://mysite.com/railsapp/</em>). The reason for this usually is that you used a static URI for your image in the views. This means your <em>img</em> source probably refers to something like <em>/images/foo.jpg</em>. The leading slash means that it’s an absolute URI: you’re telling the browser to always load <em>http://mysite.com/images/foo.jpg</em> no matter what. The problem is that the image is actually at <em>http://mysite.com/railsapp/images/foo.jpg</em>. There are two ways to fix this.

</div>
<div>

The first way (not recommended) is to change your view templates to refer to <em>images/foo.jpg</em>. This is a relative URI: note the lack of a leading slash). What this does is making the path relative to the current URI. The problem is that if you use restful URIs, then your images will probably break again when you add a level to the URI. For example, when you’re at <em>http://mysite.com/railsapp</em> the browser will look for <em>http://mysite.com/railsapp/images/foo.jpg</em>. But when you’re at <em>http://mysite.com/railsapp/controller</em>. the browser will look for <em>http://mysite.com/railsapp/controller/images/foo.jpg</em>. So relative URIs usually don’t work well with layout templates.

</div>
<div>

The second and highly recommended way is to always use Rails helper methods to output tags for static assets. These helper methods automatically take care of prepending the base URI that you’ve deployed the application to. For images there is image_tag, for JavaScript there is javascript_include_tag and for CSS there is stylesheet_link_tag. In the above example you would simply remove the <em>&lt;img&gt;</em> HTML tag and replace it with inline Ruby like this:

</div>
<div>
<div>
<pre>&lt;%= image_tag("foo.jpg") %&gt;</pre>
</div>
</div>
<div>

This will generate the proper image tag to $RAILS_ROOT/public/images/foo.jpg so that your images will always work no matter what sub-URI you’ve deployed to.

</div>
<div>

These helper methods are more valuable than you may think. For example they also append a timestamp to the URI to better facilitate HTTP caching. For more information, please refer to <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/AssetTagHelper.html">the Rails API docs</a>.

</div>
</div>
<div>
<h3 id="_x_sendfile_support">8.9. X-Sendfile support</h3>
<div>

Phusion Passenger does not provide X-Sendfile support by itself. Please install <a href="http://tn123.ath.cx/mod_xsendfile/">mod_xsendfile</a> for X-Sendfile support.

</div>
</div>
<div>
<h3 id="_upload_progress">8.10. Upload progress</h3>
<div>

Phusion Passenger does not provide upload progress support by itself. Please try drogus’s <a href="http://github.com/drogus/apache-upload-progress-module/tree/master"> Apache upload progress module</a> instead.

</div>
</div>
</div>
</div>


<div>
<h2 id="_under_the_hood">9. Under the hood</h2>
<div>
<div>

Phusion Passenger hides a lot of complexity for the end user (i.e. the web server system administrator), but sometimes it is desirable to know what is going on. This section describes a few things that Phusion Passenger does under the hood.

</div>
<div>
<h3 id="_static_assets_serving">9.1. Static assets serving</h3>
<div>

Phusion Passenger accelerates serving of static files. This means that, if an URI maps to a file that exists, then Phusion Passenger will let Apache serve that file directly, without hitting the web application.

</div>
<div>

Phusion Passenger does all this without the need for any mod_rewrite rules. People who are switching from an old Mongrel-based setup might have mod_rewrite rules such as these:

</div>
<div>
<div>
<pre># Check whether this request has a corresponding file; if that
# exists, let Apache serve it, otherwise forward the request to
# Mongrel.
RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
RewriteRule ^(.*)$ balancer://mongrel%{REQUEST_URI} [P,QSA,L]</pre>
</div>
</div>
<div>

These kind of mod_rewrite rules are no longer required, and you can safely remove them.

</div>
</div>
<div>
<h3 id="_page_caching_support">9.2. Page caching support</h3>
<div>

For each HTTP request, Phusion Passenger will automatically look for a corresponding page cache file, and serve that if it exists. It does this by appending ".html" to the filename that the URI normally maps to, and checking whether that file exists. This check occurs after checking whether the original mapped filename exists (as part of static asset serving). All this is done without the need for special mod_rewrite rules.

</div>
<div>

For example, suppose that the browser requests <em>/foo/bar</em>.

</div>
<div>
<ol>
    <li>Phusion Passenger will first check whether this URI maps to a static file, i.e. whether the file <em>foo/bar</em> exists in the web application’s <em>public</em> directory. If it does then Phusion Passenger will serve this file through Apache immediately.</li>
    <li>If that doesn’t exist, then Phusion Passenger will check whether the file <em>foo/bar.html</em> exists. If it does then Phusion Passenger will serve this file through Apache immediately.</li>
    <li>If <em>foo/bar.html</em> doesn’t exist either, then Phusion Passenger will forward the request to the underlying web application.</li>
</ol>
</div>
<div>

Note that Phusion Passenger’s page caching support doesn’t work if your web application uses a non-standard page cache directory, i.e. if it doesn’t cache to the <em>public</em> directory. In that case you’ll need to use mod_rewrite to serve such page cache files.

</div>
</div>
<div>
<h3 id="application_detection">9.3. How Phusion Passenger detects whether a virtual host is a web application</h3>
<div>

After you’ve read the deployment instructions you might wonder how Phusion Passenger knows that the DocumentRoot points to a web application that Phusion Passenger is able to serve, and how it knows what kind of web application it is (e.g. Rails or Rack).

</div>
<div>

Phusion Passenger checks whether the virtual host is a Rails application by checking whether the following file exists:

</div>
<div>
<div>
<pre>dirname(DocumentRoot) + "/config/environment.rb"</pre>
</div>
</div>
<div>

If you’re not a programmer and don’t understand the above pseudo-code snippet, it means that Phusion Passenger will:

</div>
<div>
<ol>
    <li>Extract the parent directory filename from the value of the DocumentRoot directory.</li>
    <li>Append the text "/config/environment.rb" to the result, and check whether the resulting filename exists.</li>
</ol>
</div>
<div>

So suppose that your document root is <em>/webapps/foo/public</em>. Phusion Passenger will check whether the file <em>/webapps/foo/config/environment.rb</em> exists.

</div>
<div>

Note that Phusion Passenger does <strong>not</strong> resolve any symlinks in the document root path by default since version 2.2.0 — in contrast to versions earlier than 2.2.0, which do resolve symlinks. So for example, suppose that your DocumentRoot points to <em>/home/www/example.com</em>, which in turn is a symlink to <em>/webapps/example.com/public</em>. In versions earlier than 2.2.0, Phusion Passenger will check whether <em>/webapps/example.com/config/environment.rb</em> exists because it resolves all symlinks. Phusion Passenger 2.2.0 and later however will check for <em>/home/www/config/environment.rb</em>. This file of course doesn’t exist, and as a result Phusion Passenger will not activate itself for this virtual host, and you’ll most likely see an Apache mod_dirindex directory listing.

</div>
<div>

If you need the old symlink-resolving behavior for whatever reason, then you can turn on <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerResolveSymlinksInDocumentRoot">PassengerResolveSymlinksInDocumentRoot</a>.

</div>
<div>

Another way to solve this situation is to explicitly tell Phusion Passenger what the correct application root is through the <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#PassengerAppRoot">PassengerAppRoot</a> configuration directive.

</div>
<div>

Autodetection of Rack applications happens through the same mechanism, exception that Phusion Passenger will look for <em>config.ru</em> instead of <em>config/environment.rb</em>.

</div>
</div>
</div>
</div>


<div>
<h2 id="_appendix_a_about_this_document">10. Appendix A: About this document</h2>
<div>
<div>

The text of this document is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-Share Alike 3.0 Unported License</a>.

</div>
<div>

<a href="http://creativecommons.org/licenses/by-sa/3.0/"> <img src="http://www.modrails.com/documentation/images/by_sa.png" alt="images/by_sa.png" /> </a>

</div>
<div>

Phusion Passenger is brought to you by <a href="http://www.phusion.nl/">Phusion</a>.

</div>
<div>

<a href="http://www.phusion.nl/"> <img src="http://www.modrails.com/documentation/images/phusion_banner.png" alt="images/phusion_banner.png" /> </a>

</div>
<div>

Phusion Passenger is a trademark of Hongli Lai &amp; Ninh Bui.

</div>
</div>
</div>


<div>
<h2 id="_appendix_b_terminology">11. Appendix B: Terminology</h2>
<div>
<div>
<h3 id="application_root">11.1. Application root</h3>
<div>

The root directory of an application that’s served by Phusion Passenger.

</div>
<div>

In case of Ruby on Rails applications, this is the directory that contains <em>Rakefile</em>, <em>app/</em>, <em>config/</em>, <em>public/</em>, etc. In other words, the directory pointed to by RAILS_ROOT. For example, take the following directory structure:

</div>
<div>
<div>
<pre>/apps/foo/       &lt;------ This is the Rails application's application root!
   |
   +- app/
   |   |
   |   +- controllers/
   |   |
   |   +- models/
   |   |
   |   +- views/
   |
   +- config/
   |   |
   |   +- environment.rb
   |   |
   |   +- ...
   |
   +- public/
   |   |
   |   +- ...
   |
   +- ...</pre>
</div>
</div>
<div>

In case of Rack applications, this is the directory that contains <em>config.ru</em>. For example, take the following directory structure:

</div>
<div>
<div>
<pre>/apps/bar/      &lt;----- This is the Rack application's application root!
   |
   +- public/
   |    |
   |    +- ...
   |
   +- config.ru
   |
   +- ...</pre>
</div>
</div>
<div>

In case of Python (WSGI) applications, this is the directory that contains <em>passenger_wsgi.py</em>. For example, take the following directory structure:

</div>
<div>
<div>
<pre>/apps/baz/      &lt;----- This is the WSGI application's application root!
   |
   +- public/
   |    |
   |    +- ...
   |
   +- passenger_wsgi.py
   |
   +- ...</pre>
</div>
</div>
</div>
</div>
</div>


<div>
<h2 id="spawning_methods_explained">12. Appendix C: Spawning methods explained</h2>
<div>
<div>

At its core, Phusion Passenger is an HTTP proxy and process manager. It spawns Ruby on Rails/Rack/WSGI worker processes (which may also be referred to as <em>backend processes</em>), and forwards incoming HTTP request to one of the worker processes.

</div>
<div>

While this may sound simple, there’s not just one way to spawn worker processes. Let’s go over the different spawning methods. For simplicity’s sake, let’s assume that we’re only talking about Ruby on Rails applications.

</div>
<div>
<h3 id="_the_most_straightforward_and_traditional_way_conservative_spawning">12.1. The most straightforward and traditional way: conservative spawning</h3>
<div>

Phusion Passenger could create a new Ruby process, which will then load the Rails application along with the entire Rails framework. This process will then enter an request handling main loop.

</div>
<div>

This is the most straightforward way to spawn worker processes. If you’re familiar with the Mongrel application server, then this approach is exactly what mongrel_cluster performs: it creates N worker processes, each which loads a full copy of the Rails application and the Rails framework in memory. The Thin application server employs pretty much the same approach.

</div>
<div>

Note that Phusion Passenger’s version of conservative spawning differs slightly from mongrel_cluster. Mongrel_cluster creates entirely new Ruby processes. In programmers jargon, mongrel_cluster creates new Ruby processes by forking the current process and exec()-ing a new Ruby interpreter. Phusion Passenger on the other hand creates processes that reuse the already loaded Ruby interpreter. In programmers jargon, Phusion Passenger calls fork(), but not exec().

</div>
</div>
<div>
<h3 id="_the_smart_spawning_method">12.2. The smart spawning method</h3>
<div>
<table>
<tbody>
<tr>
<td><img src="http://www.modrails.com/documentation/images/icons/note.png" alt="Note" /></td>
<td>Smart spawning is supported for all Ruby applications but not for WSGI applications.</td>
</tr>
</tbody>
</table>
</div>
<div>

While conservative spawning works well, it’s not as efficient as it could be because each worker process has its own private copy of the Rails application as well as the Rails framework. This wastes memory as well as startup time.

</div>
<div>

<img src="http://www.modrails.com/documentation/images/conservative_spawning.png" alt="Worker processes and conservative spawning" />
<em>Figure: Worker processes and conservative spawning. Each worker process has its own private copy of the application code and Rails framework code.</em>

</div>
<div>

It is possible to make the different worker processes share the memory occupied by application and Rails framework code, by utilizing so-called copy-on-write semantics of the virtual memory system on modern operating systems. As a side effect, the startup time is also reduced. This is technique is exploited by Phusion Passenger’s <em>smart</em> and <em>smart-lv2</em> spawn methods.

</div>
<div>
<h4 id="_how_it_works">12.2.1. How it works</h4>
<div>

When the <em>smart-lv2</em> spawn method is being used, Phusion Passenger will first create a so-called <em>ApplicationSpawner server</em> process. This process loads the entire Rails application along with the Rails framework, by loading <em>environment.rb</em>. Then, whenever Phusion Passenger needs a new worker process, it will instruct the ApplicationSpawner server to do so. The ApplicationSpawner server will create a worker new process that reuses the already loaded Rails application/framework. Creating a worker process through an already running ApplicationSpawner server is very fast, about 10 times faster than loading the Rails application/framework from scratch. If the Ruby interpreter is copy-on-write friendly (that is, if you’re running <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#reducing_memory_usage">Ruby Enterprise Edition</a>) then all created worker processes will share as much common memory as possible. That is, they will all share the same application and Rails framework code.

</div>
<div>

<img src="http://www.modrails.com/documentation/images/smart-lv2.png" alt="images/smart-lv2.png" />
<em>Figure: Worker processes and the smart-lv2 spawn method. All worker processes, as well as the ApplicationSpawner, share the same application code and Rails framework code.</em>

</div>
<div>

The <em>smart</em> spawn method goes even further, by caching the Rails framework in another process called the <em>FrameworkSpawner server</em>. This process only loads the Rails framework, not the application. When a FrameworkSpawner server is instructed to create a new worker process, it will create a new ApplicationSpawner to which the instruction will be delegated. All those ApplicationSpawner servers, as well as all worker processes created by those ApplicationSpawner servers, will share the same Rails framework code.

</div>
<div>

The <em>smart-lv2</em> method allows different worker processes that belong to the same application to share memory. The <em>smart</em> method allows different worker processes - that happen to use the same Rails version - to share memory, even if they don’t belong to the same application.

</div>
<div>

Notes:

</div>
<div>
<ul>
    <li>Vendored Rails frameworks cannot be shared by different applications, even if both vendored Rails frameworks are the same version. So for efficiency reasons we don’t recommend vendoring Rails.</li>
    <li>ApplicationSpawner and FrameworkSpawner servers have an idle timeout just like worker processes. If an ApplicationSpawner/FrameworkSpawner server hasn’t been instructed to do anything for a while, it will be shutdown in order to conserve memory. This idle timeout is configurable.</li>
</ul>
</div>
</div>
<div>
<h4 id="_summary_of_benefits">12.2.2. Summary of benefits</h4>
<div>

Suppose that Phusion Passenger needs a new worker process for an application that uses Rails 2.2.1.

</div>
<div>
<ul>
    <li>If the <em>smart-lv2</em> spawning method is used, and an ApplicationSpawner server for this application is already running, then worker process creation time is about 10 times faster than conservative spawning. This worker process will also share application and Rails framework code memory with the ApplicationSpawner server and the worker processes that had been spawned by this ApplicationSpawner server.</li>
    <li>If the <em>smart</em> spawning method is used, and a FrameworkSpawner server for Rails 2.2.1 is already running, but no ApplicationSpawner server for this application is running, then worker process creation time is about 2 times faster than conservative spawning. If there is an ApplicationSpawner server for this application running, then worker process creation time is about 10 times faster. This worker process will also share application and Rails framework code memory with the ApplicationSpawner and FrameworkSpawner servers.</li>
</ul>
</div>
<div>

You could compare ApplicationSpawner and FrameworkSpawner servers with stem cells, that have the ability to quickly change into more specific cells (worker process).

</div>
<div>

In practice, the smart spawning methods could mean a memory saving of about 33%, assuming that your Ruby interpreter is <a href="http://www.modrails.com/documentation/Users%20guide%20Apache.html#reducing_memory_usage">copy-on-write friendly</a>.

</div>
<div>

Of course, smart spawning is not without gotchas. But if you understand the gotchas you can easily reap the benefits of smart spawning.

</div>
</div>
</div>
<div>
<h3 id="_smart_spawning_gotcha_1_unintential_file_descriptor_sharing">12.3. Smart spawning gotcha #1: unintential file descriptor sharing</h3>
<div>

Because worker processes are created by forking from an ApplicationSpawner server, it will share all file descriptors that are opened by the ApplicationSpawner server. (This is part of the semantics of the Unix <em>fork()</em> system call. You might want to Google it if you’re not familiar with it.) A file descriptor is a handle which can be an opened file, an opened socket connection, a pipe, etc. If different worker processes write to such a file descriptor at the same time, then their write calls will be interleaved, which may potentially cause problems.

</div>
<div>

The problem commonly involves socket connections that are unintentially being shared. You can fix it by closing and reestablishing the connection when Phusion Passenger is creating a new worker process. Phusion Passenger provides the API call PhusionPassenger.on_event(:starting_worker_process) to do so. So you could insert the following code in your <em>environment.rb</em>:

</div>
<div>
<div>
<pre><tt>if defined?(PhusionPassenger)
  PhusionPassenger.on_event(:starting_worker_process) do |forked|
    if forked # We're in smart spawning mode. ...
      code to reestablish socket connections here ...
    else # We're in conservative spawning mode. We don't need to do anything.
    end
  end
end</tt></pre>
</div>
</div>
<div>

Note that Phusion Passenger automatically reestablishes the connection to the database upon creating a new worker process, which is why you normally do not encounter any database issues when using smart spawning mode.

</div>
<div>
<h4 id="_example_1_memcached_connection_sharing_harmful">12.3.1. Example 1: Memcached connection sharing (harmful)</h4>
<div>

Suppose we have a Rails application that connects to a Memcached server in <em>environment.rb</em>. This causes the ApplicationSpawner to have a socket connection (file descriptor) to the Memcached server, as shown in the following figure:

</div>
<div>
<div>
<pre>+--------------------+
| ApplicationSpawner |-----------[Memcached server]
+--------------------+</pre>
</div>
</div>
<div>

Phusion Passenger then proceeds with creating a new Rails worker process, which is to process incoming HTTP requests. The result will look like this:

</div>
<div>
<div>
<pre>+--------------------+
| ApplicationSpawner |------+----[Memcached server]
+--------------------+      |
                            |
+--------------------+      |
| Worker process 1   |-----/
+--------------------+</pre>
</div>
</div>
<div>

Since a <em>fork()</em> makes a (virtual) complete copy of a process, all its file descriptors will be copied as well. What we see here is that ApplicationSpawner and Worker process 1 both share the same connection to Memcached.

</div>
<div>

Now supposed that your site gets Slashdotted and Phusion Passenger needs to spawn another worker process. It does so by forking ApplicationSpawner. The result is now as follows:

</div>
<div>
<div>
<pre>+--------------------+
| ApplicationSpawner |------+----[Memcached server]
+--------------------+      |
                            |
+--------------------+      |
| Worker process 1   |-----/|
+--------------------+      |
                            |
+--------------------+      |
| Worker process 2   |-----/
+--------------------+</pre>
</div>
</div>
<div>

As you can see, Worker process 1 and Worker process 2 have the same Memcache connection.

</div>
<div>

Suppose that users Joe and Jane visit your website at the same time. Joe’s request is handled by Worker process 1, and Jane’s request is handled by Worker process 2. Both worker processes want to fetch something from Memcached. Suppose that in order to do that, both handlers need to send a "FETCH" command to Memcached.

</div>
<div>

But suppose that, after worker process 1 having only sent "FE", a context switch occurs, and worker process 2 starts sending a "FETCH" command to Memcached as well. If worker process 2 succeeds in sending only one bye, <em>F</em>, then Memcached will receive a command which begins with "FEF", a command that it does not recognize. In other words: the data from both handlers get interleaved. And thus Memcached is forced to handle this as an error.

</div>
<div>

This problem can be solved by reestablishing the connection to Memcached after forking:

</div>
<div>
<div>
<pre>+--------------------+
| ApplicationSpawner |------+----[Memcached server]
+--------------------+      |                   |
                            |                   |
+--------------------+      |                   |
| Worker process 1   |-----/|                   |
+--------------------+      |                   |  &lt;--- created this
                            X                   |       new
                                                |       connection
                            X &lt;-- closed this   |
+--------------------+      |     old           |
| Worker process 2   |-----/      connection    |
+--------------------+                          |
          |                                     |
          +-------------------------------------+</pre>
</div>
</div>
<div>

Worker process 2 now has its own, separate communication channel with Memcached. The code in <em>environment.rb</em> looks like this:

</div>
<div>
<div>
<pre><tt>if defined?(PhusionPassenger)
  PhusionPassenger.on_event(:starting_worker_process) do |forked|
    if forked # We're in smart spawning mode.
      reestablish_connection_to_memcached
    else # We're in conservative spawning mode. We don't need to do anything.
    end
  end
end</tt></pre>
</div>
</div>
</div>
<div>
<h4 id="_example_2_log_file_sharing_not_harmful">12.3.2. Example 2: Log file sharing (not harmful)</h4>
<div>

There are also cases in which unintential file descriptor sharing is not harmful. One such case is log file file descriptor sharing. Even if two processes write to the log file at the same time, the worst thing that can happen is that the data in the log file is interleaved.

</div>
<div>

To guarantee that the data written to the log file is never interleaved, you must synchronize write access via an inter-process synchronization mechanism, such as file locks. Reopening the log file, like you would have done in the Memcached example, doesn’t help.

</div>
</div>
</div>
<div>
<h3 id="_smart_spawning_gotcha_2_the_need_to_revive_threads">12.4. Smart spawning gotcha #2: the need to revive threads</h3>
<div>

Another part of the <em>fork()</em> system call’s semantics is the fact that threads disappear after a fork call. So if you’ve created any threads in environment.rb, then those threads will no longer be running in newly created worker process. You need to revive them when a new worker process is created. Use the :starting_worker_process event that Phusion Passenger provides, like this:

</div>
<div>
<div>
<pre><tt>if defined?(PhusionPassenger)
  PhusionPassenger.on_event(:starting_worker_process) do |forked|
    if forked # We're in smart spawning mode. ...
      code to revive threads here ...
    else # We're in conservative spawning mode. We don't need to do anything.
    end
  end
end</tt></pre>
</div>
</div>
</div>
<div>
<h3 id="_smart_spawning_gotcha_3_code_load_order">12.5. Smart spawning gotcha #3: code load order</h3>
<div>

This gotcha is only applicable to the <em>smart</em> spawn method, not the <em>smart-lv2</em> spawn method.

</div>
<div>

If your application expects the Rails framework to be not loaded during the beginning of <em>environment.rb</em>, then it can cause problems when an ApplicationSpawner is created from a FrameworkSpawner, which already has the Rails framework loaded. The most common case is when applications try to patch Rails by dropping a modified file that has the same name as Rails’s own file, in a path that comes earlier in the Ruby search path.

</div>
<div>

For example, suppose that we have an application which has a patched version of <em>active_record/base.rb</em> located in <em>RAILS_ROOT/lib/patches</em>, and <em>RAILS_ROOT/lib/patches</em> comes first in the Ruby load path. When conservative spawning is used, the patched version of <em>base.rb</em> is properly loaded. When <em>smart</em> (not <em>smart-lv2</em>) spawning is used, the original <em>base.rb</em> is used because it was already loaded, so a subsequent require "active_record/base" has no effect.

</div>
</div>
</div>
</div>


<div id="footer">
<div id="footer-text">Last updated 2011-11-24 19:06:50 CET</div>
<div>标签： <a href="http://jhjguxin.hwcrazy.com/tag/apache/">apache</a> <a href="http://jhjguxin.hwcrazy.com/tag/passenger/">passenger</a> <a href="http://jhjguxin.hwcrazy.com/tag/phusion/">phusion</a> <a href="http://jhjguxin.hwcrazy.com/tag/rails/">rails</a> <a href="http://jhjguxin.hwcrazy.com/tag/ruby/">ruby</a> <a href="http://jhjguxin.hwcrazy.com/tag/web/">web</a></div>
</div>

]]></content>
  </entry>
  
</feed>
