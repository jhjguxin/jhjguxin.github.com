
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>factory_girl Validation failed - Francis's Octopress Blog</title>
  <meta name="author" content="Francis Jiang">

  
  <meta name="description" content="factory_girl Validation failed You need to use a sequence to prevent the creation of user objects with the same email, since you must have a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jhjguxin.github.io/blog/2012/03/16/factory-girl-validation-failed">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Francis's Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-25901353-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Francis's Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jhjguxin.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/readme">Readme</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Factory_girl Validation Failed</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-16T16:22:00+08:00" pubdate data-updated="true">Mar 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>factory_girl Validation failed</h2>

<p>You need to use a sequence to prevent the creation of user objects with the same email, since you must have a validation for the uniqueness of emails in your User model.</p>

<pre><code>Factory.sequence :email do |n|
  “test#{n}@example.com”
end

Factory.define :user do |user|
  user.name "Testing User"
  user.email { Factory.next(:email) }
  user.password "foobar"
  user.password_confirmation "foobar"
end
</code></pre>


<p>You can read more in the <a href="https://github.com/thoughtbot/factory_girl/wiki/Usage" rel="nofollow">Factory Girl documentation</a>.</p>

<p>&nbsp;</p>

<p>Using factory_girl to create several instances of a class that belongs to another class causes a Validation failed error.</p>

<p>This happens because each instance tries to automatically create the object to which it belongs. However since the first instance creates it, the following instances crash because the object already exists.</p>

<p>I have been struggling to solve this problem and it seems finally I arrived to a satisfactory solution.</p>

<p>The problem arises when there is a one to many relationship between to classes and I try to create several instances of a class.</p>

<p>In my case I have a subdomain which has many users:</p>

<p>class Subdomain &lt; ActiveRecord::Base validates_uniqueness_of :name, :case_sensitive =&gt; false
has_many :users
end
class User &lt; ActiveRecord::Base belongs_to: subdomain endThe factories are as follows: FactoryGirl.define do factory :subdomain do name &lsquo;test-subdomain&rsquo; end factory :user do subdomain email &lsquo;<a href="&#x6d;&#x61;&#x69;&#x6c;&#116;&#111;&#58;&#116;&#x65;&#115;&#116;&#x2d;&#117;&#x73;&#101;&#x72;&#x40;&#x65;&#x78;&#x61;&#x6d;&#x70;&#108;&#x65;&#x2e;&#99;&#x6f;&#x6d;">&#x74;&#101;&#115;&#x74;&#x2d;&#x75;&#115;&#101;&#114;&#64;&#101;&#x78;&#97;&#x6d;&#x70;&#108;&#101;&#x2e;&#x63;&#x6f;&#109;</a>&rsquo; password &lsquo;123456¿ password_confirmation &#8216;123456&rsquo; end endWhen I try to create two users using the following code: FactoryGirl.create(:user, :email =&gt; &ldquo;<a href="&#109;&#x61;&#x69;&#108;&#x74;&#111;&#x3a;&#x66;&#x69;&#114;&#x73;&#116;&#x40;&#101;&#x78;&#97;&#109;&#x70;&#108;&#x65;&#46;&#99;&#x6f;&#x6d;">&#x66;&#105;&#x72;&#115;&#x74;&#64;&#x65;&#120;&#x61;&#109;&#112;&#108;&#x65;&#x2e;&#99;&#111;&#x6d;</a>&rdquo;)
FactoryGirl.create(:user, :email =&gt; &ldquo;<a href="&#x6d;&#97;&#105;&#x6c;&#116;&#x6f;&#x3a;&#x73;&#x65;&#99;&#x6f;&#x6e;&#100;&#64;&#101;&#120;&#x61;&#x6d;&#x70;&#108;&#101;&#x2e;&#x63;&#111;&#x6d;">&#115;&#x65;&#99;&#111;&#110;&#100;&#x40;&#101;&#120;&#97;&#109;&#x70;&#x6c;&#101;&#x2e;&#99;&#x6f;&#109;</a>&rdquo;)I get the following error:</p>

<p>Validation failed: Name has already been taken (ActiveRecord::RecordInvalid)This happens because when the first user is created, the default subdomain is created too and when the second user is created the subdomain already exists.</p>

<p>If we want to use the same subdomain for both users we can do the following:</p>

<p>s = FactoryGirl.create(:subdomain)
FactoryGirl.create(:user, :email =&gt; &ldquo;<a href="&#109;&#97;&#x69;&#108;&#x74;&#111;&#x3a;&#x66;&#105;&#x72;&#x73;&#116;&#64;&#x65;&#120;&#x61;&#x6d;&#112;&#x6c;&#101;&#46;&#x63;&#111;&#x6d;">&#x66;&#x69;&#x72;&#115;&#x74;&#64;&#101;&#x78;&#97;&#x6d;&#x70;&#108;&#x65;&#x2e;&#x63;&#x6f;&#109;</a>&rdquo;, :subdomain =&gt; s)
FactoryGirl.create(:user, :email =&gt; &ldquo;<a href="&#109;&#97;&#105;&#x6c;&#116;&#x6f;&#58;&#115;&#101;&#99;&#111;&#110;&#100;&#x40;&#x65;&#120;&#97;&#x6d;&#x70;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#109;">&#x73;&#101;&#x63;&#x6f;&#110;&#x64;&#x40;&#101;&#120;&#x61;&#109;&#x70;&#x6c;&#101;&#46;&#99;&#111;&#109;</a>&rdquo;, :subdomain =&gt; s)However as our has_many relations become deeper, test data creation becomes more complex.</p>

<p>My solution to this problem is as to change the factory for user:</p>

<p>factory :user do
subdomain { Subdomain.find_by_name(&lsquo;test-subdomain&rsquo;) || FactoryGirl.create(:subdomain) }
email &lsquo;<a href="&#109;&#97;&#x69;&#108;&#116;&#111;&#58;&#x74;&#x65;&#x73;&#x74;&#45;&#x75;&#115;&#x65;&#x72;&#x40;&#x65;&#120;&#x61;&#x6d;&#112;&#108;&#x65;&#46;&#x63;&#x6f;&#109;">&#x74;&#x65;&#115;&#116;&#x2d;&#x75;&#115;&#101;&#x72;&#64;&#x65;&#120;&#x61;&#109;&#x70;&#x6c;&#x65;&#46;&#99;&#111;&#x6d;</a>&rsquo;
password &lsquo;123456&rsquo;
password_confirmation &lsquo;123456&rsquo;
endIn this case the factory uses the default subdomain if it already exists, avoiding the validation problem.</p>

<p>Now if we use the initial code, it works without problem, assigning both users to the default subdomain</p>

<p>FactoryGirl.create(:user, :email =&gt; &ldquo;<a href="&#109;&#x61;&#105;&#x6c;&#x74;&#x6f;&#x3a;&#x66;&#105;&#x72;&#115;&#x74;&#x40;&#101;&#x78;&#97;&#x6d;&#x70;&#x6c;&#x65;&#46;&#x63;&#x6f;&#x6d;">&#102;&#105;&#114;&#115;&#116;&#64;&#x65;&#120;&#97;&#x6d;&#x70;&#x6c;&#101;&#46;&#99;&#111;&#x6d;</a>&rdquo;)
FactoryGirl.create(:user, :email =&gt; &ldquo;<a href="&#x6d;&#97;&#105;&#x6c;&#x74;&#111;&#58;&#115;&#x65;&#99;&#111;&#x6e;&#x64;&#x40;&#x65;&#x78;&#x61;&#109;&#x70;&#108;&#x65;&#x2e;&#99;&#x6f;&#x6d;">&#x73;&#x65;&#x63;&#111;&#110;&#x64;&#x40;&#101;&#x78;&#97;&#x6d;&#112;&#x6c;&#x65;&#x2e;&#x63;&#x6f;&#109;</a>&rdquo;)However this does not limit us to use the same subdomain for all users:</p>

<p>other_subdomain = FactoryGirl.create(:subdomain, :name =&gt; &ldquo;other-subdomain&rdquo;)</p>

<p>FactoryGirl.create(:user, :email =&gt; &ldquo;<a href="&#109;&#x61;&#105;&#x6c;&#116;&#111;&#58;&#102;&#x69;&#x72;&#115;&#116;&#64;&#101;&#120;&#97;&#109;&#112;&#x6c;&#x65;&#46;&#99;&#x6f;&#x6d;">&#102;&#105;&#114;&#115;&#x74;&#x40;&#101;&#x78;&#97;&#109;&#112;&#x6c;&#101;&#46;&#x63;&#111;&#109;</a>&rdquo;, :subdomain =&gt; other_subdomain)
FactoryGirl.create(:user, :email =&gt; &ldquo;<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#x65;&#x63;&#111;&#110;&#100;&#x40;&#101;&#x78;&#x61;&#109;&#112;&#x6c;&#x65;&#46;&#x63;&#x6f;&#109;">&#115;&#101;&#x63;&#111;&#110;&#x64;&#64;&#101;&#x78;&#97;&#x6d;&#112;&#108;&#x65;&#x2e;&#x63;&#111;&#x6d;</a>&rdquo;)In this case, the first user is assigned to other-subdomain and the second user is assigned to test-subdomain.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Francis Jiang</span></span>

      








  


<time datetime="2012-03-16T16:22:00+08:00" pubdate data-updated="true">Mar 16<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://jhjguxin.github.io/blog/2012/03/16/factory-girl-validation-failed/" data-via="jhjguxin" data-counturl="http://jhjguxin.github.io/blog/2012/03/16/factory-girl-validation-failed/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/03/15/tomdoc-for-ruby-version-1-dot-0-0-rc1/" title="Previous Post: TomDoc for Ruby - Version 1.0.0-rc1">&laquo; TomDoc for Ruby - Version 1.0.0-rc1</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/03/19/helper-antipatterns/" title="Next Post: Helper Antipatterns">Helper Antipatterns &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/08/tong-guo-mongodumphe-mongorestoreshi-xian-mongodbbei-fen-he-hui-fu-by-chenzhou123520/">通过mongodump和mongorestore实现Mongodb备份和恢复 --by Chenzhou123520</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/ruby-on-rails-4-dot-0-release-notes/">Ruby on Rails 4.0 Release Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/rails-active-record-named-scopes/">Rails Active Record Named Scopes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/27/shai-shai-wo-men-de-kai-yuan-xiang-mu-iteyekai-yuan-dai-ma/">晒晒我们的开源项目 ITEYE开源代码</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/26/single-sign-on-dan-dian-deng-lu-sso/">Single Sign-on 单点登录 Sso</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/jhjguxin">@jhjguxin</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jhjguxin',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Francis Jiang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
