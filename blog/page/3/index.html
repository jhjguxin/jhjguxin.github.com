
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Francis's Octopress Blog</title>
  <meta name="author" content="Francis Jiang">

  
  <meta name="description" content="My five favorite “hidden” features in Rails 3.2 Rails 3.2 is out with great features on spotlight: faster development reloading, faster router and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jhjguxin.github.io/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Francis's Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-25901353-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Francis's Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jhjguxin.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/readme">Readme</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/10/my-five-favorite-hidden-features-in-rails-3-dot-2/">My Five Favorite “hidden” Features in Rails 3.2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-10T23:23:00+08:00" pubdate data-updated="true">Aug 10<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>My five favorite “hidden” features in Rails 3.2</h2>

<p>Rails 3.2 is out with <a title="Rails 3.2.rc1 announced" href="http://weblog.rubyonrails.org/2011/12/20/rails-3-2-rc1-faster-dev-mode-routing-explain-queries-tagged-logger-store">great features on spotlight</a>: faster development reloading, faster router and explain queries. However, every Rails release ships with minor features that do not get that much attention but still would be a great fit to your application. This blog post is about my five favorites “hidden” features of Rails 3.2.</p>

<h3>1) Smarter <code>content_tag_for</code></h3>


<p><a href="https://github.com/rails/rails/pull/2816">This feature written by Prem Sichanugrist</a> provides a very simple but welcome clean up to your views. Both <code>content_tag_for</code> and <code>div_for</code> now accepts an array of records and automatically loop over each record. Therefore, instead of writing this:</p>

<div>
<div>
<pre>  @posts.each do |post|
    content_tag_for(:li, post) do
      ...
    end
  end</pre>
</div>
</div>


<p>You can simply write:</p>

<div>
<div>
<pre>  content_tag_for(:li, @posts) do |post|
    ...
  end</pre>
</div>
</div>


<h3>2) Smarter migration generators</h3>


<p>It is funny how some parts of Rails as old as the migration generators continue receiving improvements day after day. Rails 3.1 already added a feature that automatically generate indexes for associations, by simply invoking:</p>

<p>&nbsp;</p>

<pre>rails g scaffold Comment post:references title:string body:text</pre>


<p>&nbsp;</p>

<p>With the above, Rails will detect that post is a reference and it will automatically 1) add a <code>post_id</code>integer column, 2) add an association to your model and 3) add an index to that column.</p>

<p>Right after 3.1 came out, I have pushed another small feature to the migration generator that simply makes the type attribute default to string. Therefore, you no longer need to write:</p>

<p>&nbsp;</p>

<pre>rails g scaffold Person name:string email:string</pre>


<p>&nbsp;</p>

<p>You could simply write:</p>

<p>&nbsp;</p>

<pre>rails g scaffold Person name email</pre>


<p>&nbsp;</p>

<p>Oddly enough, the idea for this feature came when I was preparing a presentation and the scaffold command could not fit in a slide (the so-called Presentation Driven Development). Anyhow, this small addition would not be enough to make to the best five “hidden” features of Rails 3.2. That’s when Dmitrii Samoilov comes in.</p>

<p><a href="https://github.com/rails/rails/pull/2555">Dmitrii sent a pull request</a> that allows you to specify which columns should have an (unique) index. So one could write:</p>

<p>&nbsp;</p>

<pre>rails g scaffold Person name:index email:uniq</pre>


<p>&nbsp;</p>

<p>And the generator will automatically generate an index for name and an unique index for e-mail. There are other features there as well, so don’t forget to checkout the CHANGELOG.</p>

<h3>3) Flexible exception handling</h3>


<p>When Rails 3.0 came out, one of the features that people suddenly missed was the ability to better handle exceptions. The issue was: since Rails 3 became a lot more Rack “fluent”, we had to move some features to the middleware stack and this forced us to move the whole exceptions handling as well. Rails 3.2 attempts to bring some customization back to the game by allowing you to set your own exceptions rack application that is invoked when a failure happens. For instance, you could set the exceptions application to your own router in your<code>config/application.rb</code>:</p>

<div>
<div>
<pre>config.exceptions_app = self.routes</pre>
</div>
</div>


<p>Now, every time there is an exception, your router is going to be invoked. Therefore, to render custom 404 pages, you could simply add to your router:</p>

<div>
<div>
<pre>match "/404", :to =&gt; "errors#not_found"</pre>
</div>
</div>


<p>And implement the logic in the controller as you wish! However, there are a few things to keep in mind if you go down this road:</p>

<ol>
    <li>You need to use <code>match</code> in your routes and not <code>get/post/put/delete</code> because such exceptions can happen in any HTTP request;</li>
    <li>You won’t be able to see your custom exceptions in development unless you set<code>config.consider_all_requests_local</code> to false in your <code>config/environments/development.rb</code>. The reason is, if the request is considered local, Rails will always favor to show the debug exceptions page;</li>
    <li>You can always access the original exception in the controller at<code>env["action_dispatch.exception"]</code>;</li>
    <li>It is not possible to set cookies, the session nor the flash after an exception happens. They all were already serialized back to the client;</li>
    <li>Finally, the default exceptions application used by Rails that simply renders a page in<code>public/STATUS.html</code> is available here: <a href="https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/middleware/public_exceptions.rb">action_dispatch/middleware/public_exceptions.rb</a></li>
</ol>


<p>Remember that whatever you do in the errors controller, it should not be anything “fancy”. Keep it simple because something already went wrong with your application!</p>

<h3>4) Custom partial paths</h3>


<p>In order to render a partial for a given model, Rails 3.0 retrieved the partial name by calling:<code>model.class.model_name.partial_path</code>. <a href="https://github.com/rails/rails/commit/bf812074fd55e7dcfa426d6c9bfd4d8d68922194">Grant Hutchins &amp; Peter Jaros noticed that this was not very flexible</a> because the class was responsible to define the partial path and therefore they decided to move this responsibility to the instance. In order to better understand how you can use this feature, let’s consider the following practical example.</p>

<p>Imagine your application have an activity feed and each activity in the feed has a certain type. Usually, each type is rendered differently. For example, if you consider a to-do-list application, activities could be both “marking a list as favorite” or “marking a task as done”. Usually, applications solve this by looping for each item and rendering its respective partial, something like this:</p>

<div>
<div>
<pre>@activities.each do |activity|
  render :partial =&gt; "activities/#{activity.kind}",
    :locals =&gt; { :activity =&gt;  activity }
end</pre>
</div>
</div>


<p>Now, you can solve this problem by defining <code>to_partial_path</code> in the model (the method<code>to_partial_path</code> is part of the ActiveModel API and can be implemented in any object. The example above implements it in the model for convenience, but it could be a presenter, another ORM, etc):</p>

<div>
<div>
<pre>class Activity &lt; ActiveRecord::Base
  def to_partial_path() "activities/#{kind}" end
end</pre>
</div>
</div>


<p>And then invoking:</p>

<div>
<div>
<pre>render :partial =&gt; @activities, :as =&gt; :activity</pre>
</div>
</div>


<p>This will now work on Rails 3.2 because even though all activities are of the same class, each instance is actually responsible for telling Rails which partial should be rendered.</p>

<p>The difference here is not only in brevity, but also in performance. Although the first snippet works fine, it is slow. In the scenario where only one kind of activity happened, the first snippet will go through the render stack 30 times and lookup the same template in your filesystem 30 times. If you read <a title="Crafting Rails Applications" href="http://pragprog.com/book/jvrails/crafting-rails-applications">Crafting Rails Applications</a> you know that this lookup is cached, but even though it would certainly be faster if we didn’t have to do this 30 times, but once.</p>

<p>That’s where <code>render :collection</code> or <code>render :partial</code> with an array comes in. In such cases Rails will retrieve all templates up front skipping duplicates, and this new feature allows us to take advantage of it even if the partial lookup is dynamic. So, in the scenario where all the activities are of the same kind, the template lookup will happen just once and no longer 30 times. In other words, best case scenario becomes <code>O(1)</code>, worst case scenario is still <code>O(n)</code>.</p>

<h3>5) Filtered chain logging is back</h3>


<p>Another very small change that will make development more pleasant is that Rails will now log “Filter chain halted as CALLBACK_NAME rendered or redirected” every time a before/around/after filter in your controller halts the request. This was the case in Rails 2.3 but somehow got lost when Rails 3 came out. It is one of those small things you don’t know how much you missed until you see it again!</p>

<p>And what is your favorite Rails 3.2 “hidden” feature? Don’t forget to take a good look at the CHANGELOGs and check out many others improvements!</p>

<p>&nbsp;</p>

<p>Tags: <a href="http://blog.plataformatec.com.br/tag/crafting-rails-applications/" rel="tag">crafting rails applications</a>, <a href="http://blog.plataformatec.com.br/tag/exception-handling/" rel="tag">exception handling</a>, <a href="http://blog.plataformatec.com.br/tag/rails-3-2/" rel="tag">rails 3.2</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/27/rails-date-select-fields-hidden-and/">Rails Date_select Fields Hidden And</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-27T17:08:00+08:00" pubdate data-updated="true">Jul 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Rails date_select fields hidden and</h2>

<p>Another 2 hours wasted. Today I was trying to use the date_select helper, but I could not figure out why the fields kept showing up as hidden inputs instead of select boxes.</p>

<p>Poked around for a long long long time, before catching this tidbit</p>

<pre>: order – Set to an array containing :day, :month and :year do customize the order in which the select fields are shown. If you leave out any of the symbols, the respective select will not be shown (like when you set :discard_xxx =&gt; true. Defaults to the order defined in the respective locale (e.g. [:year, :month, :day] in the en locale that ships with Rails).</pre>


<p>For some god forsaken reason, the “order” on the date_select field in my app was not set, or is defaulted to something else. I have no idea where this happens, or how it happens. But adding and order param fixed my problem</p>

<pre>f.datetime_select :start_time, :order => [:year, :month, :day]</pre>


<ul>
    <li><code>:discard_day</code> - Set to true if you don&#8217;t want to show a day select. This includes the day as a hidden field instead of showing a select field. Also note that this implicitly sets the day to be the first of the given month in order to not create invalid dates like 31 February.</li>
    <li><code>:discard_month</code> - Set to true if you don&#8217;t want to show a month select. This includes the month as a hidden field instead of showing a select field. Also note that this implicitly sets :discard_day to true.</li>
    <li><code>:discard_year</code> - Set to true if you don&#8217;t want to show a year select. This includes the year as a hidden field instead of showing a select field.</li>
    <li><code>:order</code> - Set to an array containing <code>:day</code>, <code>:month</code> and <code>:year</code> to customize the order in which the select fields are shown. If you leave out any of the symbols, the respective select will not be shown (like when you set <code>:discard_xxx =&gt; true</code>. Defaults to the order defined in the respective locale (e.g. [:year, :month, :day] in the en locale that ships with <a href="http://api.rubyonrails.org/classes/Rails.html">Rails</a>).</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/27/simple-crud-with-mongodb/">Simple CRUD With MongoDB</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-27T12:34:00+08:00" pubdate data-updated="true">Jul 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Simple CRUD with MongoDB</h2>

<p>When I meet a new technology, I like to experience it &ldquo;just as it comes&rdquo;. I&rsquo;m happy at the command line and I like to type actual commands and see man pages before I use any wrappers or helper tools. So when I met <a href="http://www.mongodb.org/">MongoDB</a> for the first time, I did exactly that. This post shows those first steps of creating a database, and inserting, reading, deleting and updating data.</p>

<p><em>Before we begin, you should install mongo. This is painless and for me, on ubuntu, <code>sudo aptitude install mongodb</code> did the trick.</em></p>

<h3>Some Terminology</h3>


<p>Here are some translations from the RDBMS equivalent wording:</p>

<ul>
    <li>&#8220;database&#8221; is still &#8220;database&#8221;</li>
    <li>&#8220;table&#8221; becomes &#8220;collection&#8221;</li>
    <li>&#8220;row&#8221; becomes &#8220;record&#8221;</li>
    <li>try to forget the word &#8220;column&#8221;, we don&#8217;t have those</li>
</ul>


<h3>Let&#8217;s Begin</h3>


<p><strong>Creating a Database</strong></p>

<p>You don&rsquo;t really create a database with mongo, you just kind of start using it. Once you put something in there, it exists. I&rsquo;m going to name my new database <code>pets</code>.</p>

<pre>use pets</pre>


<p><strong>Adding Data</strong></p>

<p>To do anything in mongo, you start your command with <code>db</code> which refers to the database you&rsquo;re using. The different parts of the command are separated by dots. To insert data you use a command like <code>db.[collection].save()</code> and feed in the data to save. The format of the data is JSON-esque &ndash; I read JSON but I don&rsquo;t really write it, however I found it became familiar pretty quickly. To insert some data, you can do:</p>

<pre>&gt; db.animals.save({'animal':'cat', 'name':'fluffy', 'type':'long-haired', 'owner':'Anna'});
&gt; db.animals.save({'animal':'dog', 'type':'spaniel', 'name':'toffee', 'colour':'toffee', 'owner':'Ben'});
&gt; db.animals.save({'owner':'Ben', 'animal':'cat', 'name':'ginger', 'collar':true});</pre>


<p><strong>Fetching Data</strong></p>

<p>Did anything happen? We can check, using <code>db.[collection].find()</code> - this will give us everything in the collection, a bit like <code>select * from [table]</code> does in SQL.</p>

<pre>&gt; db.animals.find();
{ "_id" : ObjectId("4ebb8fd68f7aaffc5d287383"), "animal" : "cat", "name" : "fluffy", "type" : "long-haired", "owner" : "Anna" }
{ "_id" : ObjectId("4ebb90048f7aaffc5d287384"), "animal" : "dog", "type" : "spaniel", "name" : "toffee", "colour" : "toffee", "owner" : "Ben" }
{ "_id" : ObjectId("4ebb90768f7aaffc5d287385"), "owner" : "Ben", "animal" : "cat", "name" : "ginger", "collar" : true }</pre>


<p>We definitely have data! We can also filter this down, the equivalent of adding a &ldquo;where&rdquo; clause, for example, let&rsquo;s only see cats:</p>

<pre>&gt; db.animals.find({'animal':'cat'});
{ "_id" : ObjectId("4ebb8fd68f7aaffc5d287383"), "animal" : "cat", "name" : "fluffy", "type" : "long-haired", "owner" : "Anna" }
{ "_id" : ObjectId("4ebb90768f7aaffc5d287385"), "owner" : "Ben", "animal" : "cat", "name" : "ginger", "collar" : true }</pre>


<p>You can add multiple constraints here, how about cats belonging to Ben?</p>

<pre>&gt; db.animals.find({'animal':'cat', 'owner':'Ben'});
{ "_id" : ObjectId("4ebb90768f7aaffc5d287385"), "owner" : "Ben", "animal" : "cat", "name" : "ginger", "collar" : true }</pre>


<p>If any of the records don&rsquo;t have the field you&rsquo;re searching on, they won&rsquo;t appear in the results. We&rsquo;re not tied to a rigid structure of columns so you can just throw in whichever data seems useful at the time, and search on whatever is there. We can also search on whether we have the field at all, for example, animals where we know what colour they are:</p>

<pre>&gt; db.animals.find({colour: {$exists: true}});
{ "_id" : ObjectId("4ebb90048f7aaffc5d287384"), "animal" : "dog", "type" : "spaniel", "name" : "toffee", "colour" : "toffee", "owner" : "Ben" }</pre>


<p><strong>Updating Data</strong></p>

<p>This confused me for a long time, as mongo does have an <code>update()</code> function, which you can use to update one or many records in a particular way. What I found I really wanted though was to use the <code>save()</code> method again, because if the record has an identifier that exists, mongo will update it, otherwise it will insert it as we saw above. So we can just grab a record and change it, then save it:</p>

<pre>&gt; db.animals.find({'animal':'dog'});
{ "_id" : ObjectId("4ebb90048f7aaffc5d287384"), "animal" : "dog", "type" : "spaniel", "name" : "toffee", "colour" : "toffee", "owner" : "Ben" }
db.animals.save({ "_id" : ObjectId("4ebb90048f7aaffc5d287384"), "animal" : "dog", "breed" : "spaniel", "name" : "toffee", "colour" : "toffee", "owner" : "Ben" });</pre>


<p>I realised that calling a spaniel a &ldquo;type&rdquo; of dog would be better expressed as being a &ldquo;breed&rdquo;, so I simply changed that record and mongo updated it for me. The <code>update() </code>statement is better for working on sets of records &ndash; for example if we decide Ben should be using his Sunday name:</p>

<pre>&gt; db.animals.update({'owner':'Ben'}, {$set: {'owner':'Benjamin'}}, false, true);</pre>


<p>There&rsquo;s a lot going on here, so let&rsquo;s look at the pieces step-by-step. The <a href="http://www.mongodb.org/display/DOCS/Updating">documentation</a> describes the update function as:</p>

<pre>db.collection.update( criteria, objNew, upsert, multi )</pre>


<p>The first part, the <em>criteria</em> is the same as we would use for the <code>find()</code> method. The next argument is what we&rsquo;re changing. I&rsquo;m just setting one field to a given value, so I used the <code>$set</code> modifier (modifiers are an art in themselves, this post is rambling on already so I&rsquo;ll write about those another day if you&rsquo;re interested). The next argument is the <em>upsert</em>, which is whether to insert a new record if we didn&rsquo;t find any matches &ndash; I want to update existing records, not insert anything, so I set this to false. Finally the <em>multi</em> flag tells mongo to update ALL the records it can find that match the<em>criteria</em>, if this is false it will stop after one (lazy thing!).</p>

<p><strong>Deleting Data</strong></p>

<p>If you&rsquo;ve come this far then I&rsquo;m impressed, and deleting is the easy part so we&rsquo;re almost there! Exactly like the <code>find()</code>and <code>update()</code> commands, we just supply a criteria to the <code>remove()</code> command. This could be either one of the fields, as we used already, or the object ID itself, like this:</p>

<pre>&gt; db.animals.remove({_id: ObjectId("4ebb90768f7aaffc5d287385")});</pre>


<p>As with all things mongo, you won&rsquo;t get any feedback about whether it worked, since most of the time we&rsquo;re using this on systems so fast there isn&rsquo;t time for niceties, but if you try to <code>find()</code> this record now, you won&rsquo;t be able to.</p>

<h3>MongoDB</h3>


<p>There&rsquo;s so much that&rsquo;s exciting about mongo, the sheer size and speed of this data store, the support for map reduce, the sharding support &hellip; I could go on. However you still need to be able to have a quick word with your database and check what data it has, maybe tweak something, and I hope that these mongo examples will serve as a quick reference for anyone who needs them, including me of course! I like databases, APIs and command line, so working with mongo is kind of magical for me, are you working with it? I&rsquo;d love to hear how others are getting on and what other tips I need to know, so leave a comment and share, please!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/10/ruby-on-rails-use-endless-loop-when-server-starts/">Ruby-on-rails-use-endless-loop-when-server-starts</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-10T23:04:00+08:00" pubdate data-updated="true">Jul 10<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>ruby-on-rails-use-endless-loop-when-server-starts</h2>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/10/3-zhao-shi-yong-asset-pipeline-jia-su-by-xdite/">3 招实用Asset Pipeline 加速 &#8211;by Xdite</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-10T09:24:00+08:00" pubdate data-updated="true">Jul 10<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>3 招实用Asset Pipeline 加速 &mdash;by xdite</h2>

<p>Asset Pipeline 最让人诟病的就是deploy 时花费速度过久。 在<a href="http://translate.googleusercontent.com/translate_c?hl=zh-CN&amp;prev=/search%3Fq%3D3-way-to-speedup-asset-pipeline/%26hl%3Dzh-CN%26newwindow%3D1%26safe%3Dstrict%26prmd%3Dimvns&amp;rurl=translate.google.com.hk&amp;sl=zh-TW&amp;u=http://www.meetup.com/Ruby-Taiwan-Group/&amp;usg=ALkJrhjELOiQOaWuvMEzLA44bw1JAEHk4Q">社群聚会</a>时发现大家都对这个主题非常不熟。 所以把最近累积了的这方面技巧整理出来分享给大家。</p>

<h2>1. Capistrano deployment speedup</h2>


<h3>使用capistrano 内建task 执行assets:precompie</h3>


<p>capistrano内建了<code>&lsquo;deploy/assets&rsquo;</code>这个task。 只要在<code>Capfile</code>里面</p>

<p>&nbsp;</p>

<figure><figcaption>Capfile</figcaption>
<div>
<table>
<tbody>
<tr>
<td>
<pre>  1</pre>
</td>
<td>
<pre> <code>load 'deploy/assets'</code></pre>
</td>
</tr>
</tbody>
</table>
</div>
</figure>


<p>&nbsp;</p>

<p>deploy 就会自动执行assets precompile 的动作。 由<a href="https://github.com/capistrano/capistrano/blob/master/lib/capistrano/recipes/deploy/assets.rb">原始档</a>可以看到这个task实际执行的是</p>

<p><code>&ldquo;cd /home/apps/APP_NAME/releases/20120708184757 &amp;&amp; bundle exec rake RAILS_ENV=production RAILS_GROUPS=assets assets:precompile&rdquo;</code></p>

<p>而执行的时机是</p>

<p><code>after &lsquo;deploy:update_code&rsquo;, &lsquo;deploy:assets:precompile&rsquo;</code></p>

<p>许多开发者不知道有这一个task 可以用。 手动写task 去compile，造成了两个问题:</p>

<ol>
    <li>时机执行错误。 Compile 时机错误会造成站上出现空白css。</li>
    <li>执行compile 机器负担太重。 如果是手写的task 通常会是load 整个production 的环境去compile。与只load assets 这个group 所吃的系统资源「有可能」差得非常多。</li>
</ol>


<h3>如果没有变更到assets 时，就不compile</h3>


<p>请把这里面的内容贴到你的deploy.rb 档里面</p>

<div>
<div id="gist-3072362">
<div>
<div>
<div>
<table>
<tbody>
<tr>
<td>
<pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre>
</td>
<td>
<div id="LC1"># -*- encoding : utf-8 -*-</div>
<div id="LC3">set :assets_dependencies, %w(app/assets lib/assets vendor/assets Gemfile.lock config/routes.rb)</div>
<div id="LC5">namespace :deploy do</div>
<div id="LC6">  namespace :assets do</div>
<div id="LC8">    desc &lt;&lt;-DESC</div>
<div id="LC9">      Run the asset precompilation rake task. You can specify the full path \</div>
<div id="LC10">      to the rake executable by setting the rake variable. You can also \</div>
<div id="LC11">      specify additional environment variables to pass to rake via the \</div>
<div id="LC12">      asset_env variable. The defaults are:</div>
<div id="LC14">        set :rake, &#8220;rake&#8221;</div>
<div id="LC15">        set :rails_env, &#8220;production&#8221;</div>
<div id="LC16">        set :asset_env, &#8220;RAILS_GROUPS=assets&#8221;</div>
<div id="LC17">        set :assets_dependencies, fetch(:assets_dependencies) + %w(config/locales/js)</div>
<div id="LC18">    DESC</div>
<div id="LC19">    task :precompile, :roles =&gt; :web, :except =&gt; { :no_release =&gt; true } do</div>
<div id="LC20">      from = source.next_revision(current_revision)</div>
<div id="LC21">      if capture(&#8220;cd #{latest_release} &amp;&amp; #{source.local.log(from)} #{assets_dependencies.join &#8217; &#8216;} | wc -l&#8221;).to_i &gt; 0</div>
<div id="LC22">        run %Q{cd #{latest_release} &amp;&amp; #{rake} RAILS_ENV=#{rails_env} #{asset_env} assets:precompile}</div>
<div id="LC23">      else</div>
<div id="LC24">        logger.info &#8220;Skipping asset pre-compilation because there were no asset changes&#8221;</div>
<div id="LC25">      end</div>
<div id="LC26">    end</div>
<div id="LC28">  end</div>
<div id="LC29">end</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div><a href="https://gist.github.com/raw/3072362/20d3c52d670af910096d4e9c41eca0b2675b0ca6/gistfile1.txt">view raw</a><a href="https://gist.github.com/3072362#file_gistfile1.txt">gistfile1.txt</a><a href="https://gist.github.com/3072362">This Gist</a> brought to you by <a href="http://github.com/">GitHub</a>.</div>
</div>
</div>
</div>


<p>这是在Railsconf 2012的<a href="https://speakerdeck.com/u/czarneckid/p/railsconf-2012-stack-smashing-cornflower-blue">Stack Smashing</a>上学到的一招。</p>

<p>如果你的assets 档案没有变动的话，只要执行copy 上一版本的assets 就好了。 这段task 会侦测</p>

<ul>
    <li>app/assets</li>
    <li>lib/assets</li>
    <li>vendor/assets</li>
    <li>Gemfile.lock</li>
    <li>confir/routes.rb</li>
</ul>


<p>是否有变动。 基本上已经含了所有可能assets 会变动的可能性。 有变动才会重新compile。</p>

<p>整体上会加速<strong>非常非常的多</strong> 。</p>

<h2>2. use @import carefully</h2>


<h3>避免使用@import “compass”; 这种写法</h3>


<p><a href="http://translate.googleusercontent.com/translate_c?hl=zh-CN&amp;prev=/search%3Fq%3D3-way-to-speedup-asset-pipeline/%26hl%3Dzh-CN%26newwindow%3D1%26safe%3Dstrict%26prmd%3Dimvns&amp;rurl=translate.google.com.hk&amp;sl=zh-TW&amp;u=http://compass-style.org/&amp;usg=ALkJrhhOJafMffZNoGN_mrKZd66K8IgcBA">compass</a>是大家很爱用的SCSS framework。 大家写gradiant 或者css spriate 很常直接开下去。</p>

<p>但是你知道</p>

<p>&nbsp;</p>

<figure><figcaption></figcaption>
<div>
<table>
<tbody>
<tr>
<td>
<pre>  1</pre>
</td>
<td>
<pre> <code>@import "compass" ;</code></pre>
</td>
</tr>
</tbody>
</table>
</div>
</figure>


<p>&nbsp;</p>

<p>和</p>

<p>&nbsp;</p>

<figure><figcaption></figcaption>
<div>
<table>
<tbody>
<tr>
<td>
<pre>  1</pre>
</td>
<td>
<pre> <code>@import "compass/typography/links/link-colors" ;</code></pre>
</td>
</tr>
</tbody>
</table>
</div>
</figure>


<p>&nbsp;</p>

<p>这两种写法。</p>

<p>前者compile 的速度可能比后者慢到9 倍以上吗？</p>

<p>会这么慢的原因，是因为compass本身即是<a href="https://github.com/chriseppstein/compass/blob/stable/frameworks/compass/stylesheets/_compass.scss">懒人包</a> ， <code>@import &ldquo;compass&rdquo;;</code>会把</p>

<ul>
    <li>“compass/utilities”;</li>
    <li>“compass/typography”;</li>
    <li>“compass/css3”;</li>
</ul>


<p>下面的东西<strong>通通</strong>都挂起来（还跑directory recursive）。</p>

<p>所以自然慢到爆炸。 如果要用什么helper，请直接挂它单支的CSS 就好了，不要整包都挂上来。</p>

<p>全挂其慢无比是正常的。</p>

<h3>避免使用partial</h3>


<p>我知道partial 是SCSS 整理术的大绝招。 但是若非必要，也尽量避免一直单档一路@import 到底。</p>

<p>&nbsp;</p>

<figure><figcaption>common.css.scss</figcaption>
<div>
<table>
<tbody>
<tr>
<td>
<pre>  1
 2
 3</pre>
</td>
<td>
<pre> <code>@import "reset" ; @import "base" ; @import "product" ;</code></pre>
</td>
</tr>
</tbody>
</table>
</div>
</figure>


<figure><figcaption>common.css.scss</figcaption>
<div>
<table>
<tbody>
<tr>
<td>
<pre>  1
 2
 3</pre>
</td>
<td>
<pre> <code>//= require "reset" //= require "base" //= require "product"</code></pre>
</td>
</tr>
</tbody>
</table>
</div>
</figure>


<p>&nbsp;</p>

<p>这两个在asset pipeline 输出结果是一样的。 但后者会比前者快。</p>

<p>如果真的需要用到非得使用partial 的技巧（如需读变数用require 读​​不到，@import 才读得到）再使用即可，因为只要一牵涉到directory recursive compile 就会慢…</p>

<h2>3. don&#8217;t require .scss &amp; .coffee for no reason</h2>


<h3>避免使用require_tree</h3>


<p>使用generator 产生controller 时，rails 会自动帮忙产生</p>

<ul>
    <li>product.css.scss</li>
    <li>product.js.coffee</li>
</ul>


<p>然后application.css 与application.js 会利用</p>

<p>&nbsp;</p>

<figure><figcaption>application.css</figcaption>
<div>
<table>
<tbody>
<tr>
<td>
<pre>  1</pre>
</td>
<td>
<pre> <code>//= require_tree</code></pre>
</td>
</tr>
</tbody>
</table>
</div>
</figure>


<p>&nbsp;</p>

<p>这种技巧来把这些档案挂上去。</p>

<p>但是你知道吗？ 就算这些档案里面只写了这几行注解：</p>

<p>&nbsp;</p>

<figure><figcaption></figcaption>
<div>
<table>
<tbody>
<tr>
<td>
<pre>  1
 2
 3</pre>
</td>
<td>
<pre> <code># Place all the behaviors and hooks related to the matching controller here. # All this logic will automatically be available in application.js. # You can use CoffeeScript in this file: http://jashkenas.github.com/coffee-script/</code></pre>
</td>
</tr>
</tbody>
</table>
</div>
</figure>


<p>&nbsp;</p>

<p>而且实际执行结果也等于空输出。 compile 一支大概也要250ms。 你可以想想，多compile 10 支，就是2.5 秒了。 难怪超耗时。</p>

<h3>可以使用.js 或.css 解决的不要用.scss 与.coffee 当结尾</h3>


<p>&nbsp;</p>

<figure><figcaption></figcaption>
<div>
<table>
<tbody>
<tr>
<td>
<pre>  1
 2
 3
 4
 5</pre>
</td>
<td>
<pre> <code>Compiled jquery-ui-1.8.16.custom.css (0ms) (pid 19108) Compiled jquery.ui.1.8.16.ie.css (0ms) (pid 19108) Compiled jquery.js (5ms) (pid 19108) Compiled jquery_ujs.js (0ms) (pid 19108) Compiled custom.css (14ms) (pid 19108)</code></pre>
</td>
</tr>
</tbody>
</table>
</div>
</figure>


<p>&nbsp;</p>

<p>其中custom.css 的档名是custom.css.scss</p>

<p>这样应该知道为什么不要乱用scss 当档名了吧？</p>

<h2>小结</h2>


<p>为了方便大家调整，我把具体加速assets precompile 过程的步骤罗列在下面。</p>

<h4>1. 换掉deploy.rb 的assets precompile tasks</h4>


<h4>2. 观察logs/product.log。</h4>


<ol>
    <li>找出慢的assets。</li>
    <li>拿掉直接使用import “comppass”; 的SCSS，改用功能针对性写法。</li>
    <li>不需要使用@import 写法的改用require</li>
    <li>拿掉require_tree，改用//=require 一行一行挂上去</li>
    <li>删掉空的scss 与coffeescript</li>
    <li>单纯只是CSS 的不要自作聪明帮忙加上.scss 档名。</li>
</ol>


<p>====</p>

<p>如果有什么问题，欢迎各位在底下留言讨论。</p>

<p>也欢迎大家有空来<a href="http://translate.googleusercontent.com/translate_c?hl=zh-CN&amp;prev=/search%3Fq%3D3-way-to-speedup-asset-pipeline/%26hl%3Dzh-CN%26newwindow%3D1%26safe%3Dstrict%26prmd%3Dimvns&amp;rurl=translate.google.com.hk&amp;sl=zh-TW&amp;u=http://www.meetup.com/Ruby-Taiwan-Group/&amp;usg=ALkJrhjELOiQOaWuvMEzLA44bw1JAEHk4Q">Rails Tuesday</a>坐坐。 我很乐意帮大家解答问题。</p>

<p>PS如果你是要问<a href="http://translate.googleusercontent.com/translate_c?hl=zh-CN&amp;prev=/search%3Fq%3D3-way-to-speedup-asset-pipeline/%26hl%3Dzh-CN%26newwindow%3D1%26safe%3Dstrict%26prmd%3Dimvns&amp;rurl=translate.google.com.hk&amp;sl=zh-TW&amp;u=http://rails-101.logdown.com/&amp;usg=ALkJrhi9o1R7dFefWuKlx-RM98hTzl6FIA">Rails 101</a>书上的问题，请找小蟹。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/09/creating-nested-resources-in-ruby-on-rails-3-and-updating-scaffolding-links-and-redirection/">Creating Nested Resources in Ruby on Rails 3 and Updating Scaffolding Links and Redirection</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-09T12:26:00+08:00" pubdate data-updated="true">Jul 9<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Creating nested resources in ruby on rails 3 and updating scaffolding links and redirection</h2>

<p>In this article, I&rsquo;ll walk through a basic Rails (3.2.x) setup for creating a nested resource for two models. Nested resources work well when you want to build out URL structure between two related models, and still maintain a RESTful convention. This code assumes you are running RVM to manage Ruby/Gem versions, and Git for version control.</p>

<p>Creating a new Rails project
$ mkdir family # create rvm gemset
$ echo &ldquo;rvm use &mdash;create ruby-1.9.2@family&rdquo; > family/.rvmrc
$ cd family # install rails
$ gem install rails # create new rails project
$ rails new . # version control
$ git init
$ git add .
$ git commit -am &ldquo;new rails project&rdquo;
Create two models (Parent &amp; Child)</p>

<h1>Parent model</h1>

<p>$ rails generate scaffold Parent name:string
$ git add .
$ git commit -am &ldquo;rails generate scaffold Parent name:string&rdquo;</p>

<h1>Child model</h1>

<p>$ rails generate scaffold Child name:string parent_id:integer
$ git add .
$ git commit -am &ldquo;rails generate scaffold Child name:string parent_id:integer&rdquo;</p>

<h1>Create db (defaults to SQLite3)</h1>

<p>$ rake db:migrate</p>

<h1>version control</h1>

<p>$ git add db/schema.rb
$ git commit db/schema.rb -m &ldquo;created database schema&rdquo;
Review un-nested routes
$ rake routes
   children GET    /children(.:format)          children#index</p>

<pre><code>        POST   /children(.:format)          children#create
</code></pre>

<p>  new_child GET    /children/new(.:format)      children#new
 edit_child GET    /children/:id/edit(.:format) children#edit</p>

<pre><code>  child GET    /children/:id(.:format)      children#show
        PUT    /children/:id(.:format)      children#update
        DELETE /children/:id(.:format)      children#destroy
parents GET    /parents(.:format)           parents#index
        POST   /parents(.:format)           parents#create
</code></pre>

<p> new_parent GET    /parents/new(.:format)       parents#new
edit_parent GET    /parents/:id/edit(.:format)  parents#edit</p>

<pre><code> parent GET    /parents/:id(.:format)       parents#show
        PUT    /parents/:id(.:format)       parents#update
        DELETE /parents/:id(.:format)       parents#destroy
</code></pre>

<p>Adding model relationships</p>

<h1>file: app/models/parent.rb</h1>

<p>class Parent &lt; ActiveRecord::Base
  attr_accessible :name
  has_many :children
end</p>

<h1>file: app/models/child.rb</h1>

<p>class Child &lt; ActiveRecord::Base
  attr_accessible :name, :parent_id
  belongs_to :parent
end</p>

<h1>version control</h1>

<p>$ git commit app/models -m &ldquo;added relationships to models&rdquo;
Nesting the routes
$ rake routes
  parent_children GET    /parents/:parent_id/children(.:format)          children#index</p>

<pre><code>              POST   /parents/:parent_id/children(.:format)          children#create
</code></pre>

<p> new_parent_child GET    /parents/:parent_id/children/new(.:format)      children#new
edit_parent_child GET    /parents/:parent_id/children/:id/edit(.:format) children#edit</p>

<pre><code> parent_child GET    /parents/:parent_id/children/:id(.:format)      children#show
              PUT    /parents/:parent_id/children/:id(.:format)      children#update
              DELETE /parents/:parent_id/children/:id(.:format)      children#destroy
      parents GET    /parents(.:format)                              parents#index
              POST   /parents(.:format)                              parents#create
   new_parent GET    /parents/new(.:format)                          parents#new
  edit_parent GET    /parents/:id/edit(.:format)                     parents#edit
       parent GET    /parents/:id(.:format)                          parents#show
              PUT    /parents/:id(.:format)                          parents#update
              DELETE /parents/:id(.:format)                          parents#destroy
</code></pre>

<p>Adding test data via Rails console
$ rails c</p>

<blockquote><p>dad = Parent.new(:name => &lsquo;Paul&rsquo;)
 => #<Parent id: nil, name: "Paul", created_at: nil, updated_at: nil></p>

<p>dad.save
   (0.1ms)  begin transaction
  SQL (20.0ms)  INSERT INTO &ldquo;parents&rdquo; (&ldquo;created_at&rdquo;, &ldquo;name&rdquo;, &ldquo;updated_at&rdquo;) VALUES (?, ?, ?)  [[&ldquo;created_at&rdquo;, Fri, 06 Apr 2012 16:13:17 UTC +00:00], [&ldquo;name&rdquo;, &ldquo;Paul&rdquo;], [&ldquo;updated_at&rdquo;, Fri, 06 Apr 2012 16:13:17 UTC +00:00]]
   (2.4ms)  commit transaction
 => true</p>

<p>son = dad.children.new(:name => &lsquo;Eric&rsquo;)
 => #<Child id: nil, name: "Eric", parent_id: 1, created_at: nil, updated_at: nil></p>

<p>daughter = dad.children.new(:name => &lsquo;Mara&rsquo;)
 => #<Child id: nil, name: "Mara", parent_id: 1, created_at: nil, updated_at: nil></p>

<p>exit
Adding a private controller method to load the Parent object for each method</p>

<h1>file: app/controllers/children_controller.rb</h1>

<p>@@ -1,4 +1,7 @@
 class ChildrenController &lt; ApplicationController
+
+  before_filter :load_parent
+
   # GET /children
   # GET /children.json
   def index
@@ -80,4 +83,11 @@ class ChildrenController &lt; ApplicationController</p>

<pre><code>   format.json { head :no_content }
 end
</code></pre>

<p>   end
+
+  private
+
+    def load_parent
+      @parent = Parent.find(params[:parent_id])
+    end
+
 end
At this point, each controller and view for the Child class model needs to be adjusted (links, redirection, form, etc)</p></blockquote>

<p>Method: children#index</p>

<h1>file: app/controllers/children_controller.rb</h1>

<p>   def index
&ndash;    @children = Child.all
+    @children = @parent.children.all</p>

<h1>file: app/views/children/index.html.erb</h1>

<ul>
<li> <td>&lt;%= link_to &lsquo;Show&rsquo;, child %></td></li>
<li> <td>&lt;%= link_to &lsquo;Edit&rsquo;, edit_child_path(child) %></td></li>
<li> <td>&lt;%= link_to &lsquo;Destroy&rsquo;, child, confirm: &lsquo;Are you sure?&rsquo;, method: :delete %></td></li>
<li> <td>&lt;%= link_to &lsquo;Show&rsquo;, parent_child_path(@parent, child) %></td></li>
<li> <td>&lt;%= link_to &lsquo;Edit&rsquo;, edit_parent_child_path(@parent, child) %></td></li>
<li> <td>&lt;%= link_to &lsquo;Destroy&rsquo;, [@parent, child], confirm: &lsquo;Are you sure?&rsquo;, method: :delete %></td></li>
</ul>


<p>&ndash;&lt;%= link_to &lsquo;New Child&rsquo;, new_child_path %>
+&lt;%= link_to &lsquo;New Child&rsquo;, new_parent_child_path(@parent) %>
Method: children#new</p>

<h1>file: app/controllers/children_controller.rb</h1>

<p>   def new
&ndash;    @child = Child.new
+    @child = @parent.children.new</p>

<h1>file: app/views/children/_form.html.erb</h1>

<p>&ndash;&lt;%= form_for(@child) do |f| %>
+&lt;%= form_for([@parent, @child]) do |f| %></p>

<h1>file: app/views/children/new.html.erb</h1>

<p>&ndash;&lt;%= link_to &lsquo;Back&rsquo;, children_path %>
+&lt;%= link_to &lsquo;Back&rsquo;, parent_children_path(@parent) %>
Method: children#create</p>

<h1>file: app/controllers/children_controller.rb</h1>

<p>   def create
&ndash;    @child = Child.new(params[:child])
+    @child = @parent.children.new(params[:child])</p>

<pre><code> respond_to do |format|
   if @child.save
</code></pre>

<ul>
<li><pre><code> format.html { redirect_to @child, notice: 'Child was successfully created.' }
</code></pre></li>
<li><pre><code> format.html { redirect_to [@parent, @child], notice: 'Child was successfully created.' }
</code></pre>

<p>Method: children#show</p></li>
</ul>


<h1>file: app/controllers/children_controller.rb</h1>

<p>   def show
&ndash;    @child = Child.find(params[:id])
+    @child = @parent.children.find(params[:id])</p>

<h1>file: app/views/children/show.html.erb</h1>

<p>&ndash;&lt;%= link_to &lsquo;Edit&rsquo;, edit_child_path(@child) %> |
&ndash;&lt;%= link_to &lsquo;Back&rsquo;, children_path %>
+&lt;%= link_to &lsquo;Edit&rsquo;, edit_parent_child_path(@parent, @child) %> |
+&lt;%= link_to &lsquo;Back&rsquo;, parent_children_path(@parent) %>
Method: children#edit</p>

<h1>file: app/controllers/children_controller.rb</h1>

<p>   def edit
&ndash;    @child = Child.find(params[:id])
+    @child = @parent.children.find(params[:id])</p>

<h1>file: app/views/children/edit.html.erb</h1>

<p>&ndash;&lt;%= link_to &lsquo;Show&rsquo;, @child %> |
&ndash;&lt;%= link_to &lsquo;Back&rsquo;, children_path %>
+&lt;%= link_to &lsquo;Show&rsquo;, parent_child_path(@parent, @child) %> |
+&lt;%= link_to &lsquo;Back&rsquo;, parent_children_path(@parent) %>
Method: children#update</p>

<h1>file: app/controllers/children_controller.rb</h1>

<p>   def update
&ndash;    @child = Child.find(params[:id])
+    @child = @parent.children.find(params[:id])</p>

<pre><code> respond_to do |format|
   if @child.update_attributes(params[:child])
</code></pre>

<ul>
<li><pre><code> format.html { redirect_to @child, notice: 'Child was successfully updated.' }
</code></pre></li>
<li><pre><code> format.html { redirect_to [@parent, @child], notice: 'Child was successfully updated.' }
</code></pre>

<p>Method: children#destroy</p></li>
</ul>


<h1>file: app/controllers/children_controller.rb</h1>

<p>   def destroy
&ndash;    @child = Child.find(params[:id])
+    @child = @parent.children.find(params[:id])</p>

<pre><code> @child.destroy

 respond_to do |format|
</code></pre>

<ul>
<li>   format.html { redirect_to children_url }</li>
<li>   format.html { redirect_to parent_children_path(@parent) }
At this point, the default scaffolding&rsquo;s links and redirection have been updated to work with the nested routes.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/03/actiondispatch-requestid-%3C-object/">ActionDispatch::RequestId < Object</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-03T13:15:00+08:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>ActionDispatch::RequestId &lt; Object</h2>

<p>Makes a unique request id available to the action_dispatch.request_id env variable (which is then accessible through <a href="http://api.rubyonrails.org/classes/ActionDispatch/Request.html#method-i-uuid">ActionDispatch::Request#uuid</a>) and sends the same id to the client via the X-Request-Id header.</p>

<p>The unique request id is either based off the X-Request-Id header in the request, which would typically be generated by a firewall, load balancer, or the web server, or, if this header is not available, a random uuid. If the header is accepted from the outside world, we sanitize it to a max of 255 chars and alphanumeric and dashes only.</p>

<p>The unique request id can be used to trace a request end-to-end and would typically end up being part of log files from multiple pieces of the stack.</p>

<p><a href="http://api.rubyonrails.org/classes/ActionDispatch/RequestId.html"><a href="http://api.rubyonrails.org/classes/ActionDispatch/RequestId.html">http://api.rubyonrails.org/classes/ActionDispatch/RequestId.html</a></a></p>

<p><a href="http://stackoverflow.com/search?q=rails+RequestId"><a href="http://stackoverflow.com/search?q=rails+RequestId">http://stackoverflow.com/search?q=rails+RequestId</a></a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/18/single-table-inheritance-dan-biao-ji-cheng/">Single Table Inheritance (单表继承)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-18T15:40:00+08:00" pubdate data-updated="true">Jun 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Single table inheritance (单表继承)</h2>

<p>Active Record allows inheritance by storing the name of the class in a column that by default is named “type” (can be changed by overwriting <code>Base.inheritance_column</code>). This means that an inheritance looking like this:</p>

<pre data-result="[object Object]">class Company &lt; ActiveRecord::Base; end
class Firm &lt; Company; end
class Client &lt; Company; end
class PriorityClient &lt; Client; end</pre>


<p>When you do <code>Firm.create(:name =&gt; &ldquo;37signals&rdquo;)</code>, this record will be saved in the companies table with type = “Firm”. You can then fetch this row again using <code>Company.where(:name =&gt; &lsquo;37signals&rsquo;).first</code> and it will return a Firm object.</p>

<p>If you don’t have a type column defined in your table, single-table inheritance won’t be triggered. In that case, it’ll work just like normal subclasses with no special magic for differentiating between them or reloading the right type with find.</p>

<p>Note, all the attributes for all the cases are kept in the same table. Read more: <a href="http://www.martinfowler.com/eaaCatalog/singleTableInheritance.html">www.martinfowler.com/eaaCatalog/singleTableInheritance.html</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/16/15-things-for-a-ruby-beginner/">15 Things for a Ruby Beginner</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-16T22:47:00+08:00" pubdate data-updated="true">Jun 16<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>15 Things for a Ruby Beginner</h2>

<p><em>The following is a post I had recently sent the <a href="https://groups.google.com/group/bangalorerug">Bangalore Ruby User Group</a>. It has been slightly modified to address a larger audience.</em></p>

<p>There were many Ruby beginners in last week&rsquo;s meetup, and the common question we heard was &lsquo;after the very basics, what next?&rsquo;</p>

<p>The best way to learn Ruby best practices is to pair with an experienced dev; the way I learned was by inheriting a reasonably small, but well-written codebase from an amazing colleague. In the absence of either, here is a checklist of 15 things (since &lsquo;N things that you need to know about X&rsquo; is the in-thing these days!) that I&rsquo;d recommend a Ruby beginner to consider:</p>

<h3>1. The very basics</h3>


<p>Our very own <a href="http://rubymonk.com/" target="_blank">rubymonk.com</a> has a Ruby primer which was written for exactly this purpose; we open our inbox everyday to gushing feedback from people who&rsquo;ve found it to be a great way to learn Ruby. Try it and let us know how it goes!</p>

<p><a href="http://tryruby.org/" target="_blank">tryruby.org</a> also has a basic introduction to Ruby, and has been around longer. <a href="http://rubykoans.com/" target="_blank">Edgecase&rsquo;s Ruby Koan</a> is an interesting concept, and covers the language both in breadth and depth, and is a very strong recommendation. It should take you anywhere between 5-10 hours to finish all of the Koans. Do try it!</p>

<p>&nbsp;</p>

<p>I have heard good things about <a href="http://ruby.learncodethehardway.org/" target="_blank">Learn Ruby the Hardway</a>, but haven&rsquo;t tried it out myself. Okay, I just skimmed through portions of it and I&rsquo;m not really happy &ndash; LRTH seems to be mostly a line-to-line translation of Python code to Ruby. It uses  &lsquo;while&rsquo; loop in places where equivalent Ruby idioms (Enumerables) would have made more sense. Also there is no mention of blocks, metaprogramming and duck-typing, which pretty much is a deal-breaker for me. But to be fair, the target audience for LRTH seem to be non-programmers for whom the concept of loops and objects would be new, and for them it does the job very well.</p>

<p>Wait, have you read Why&rsquo;s Poignant Guide to Ruby? If this is the first time you&rsquo;re hearing about why the lucky stiff, read <a href="http://www.smashingmagazine.com/2010/05/15/why-a-tale-of-a-post-modern-genius/" target="_blank">this amazing piece on <em>why by the Smashing Magazine</a>. And definitely read The Poignant Guide: <a href="http://mislav.uniqpath.com/poignant-guide/" target="_blank"><a href="http://mislav.uniqpath.com/">http://mislav.uniqpath.com/</a><wbr>poignant-guide/</wbr></a>. It is full of cats, foxes, chunky bacon, cartoons that doesn&rsquo;t always make much sense, space travel and what not. This was one of my first introductions to the Ruby community, and the guide lent the language and the community a fun, quirky and happy aura. You may or may not take away much Ruby knowledge from the guide &ndash; I couldn&rsquo;t when I read it for the first time. However you&rsquo;ll definitely understand some of the quirkiness and philosophies that influence the Ruby community. I&rsquo;m a huge fan of </em>why, and here is my favourite quote:</p>

<p>&nbsp;</p>

<blockquote>when you don&#8217;t create things, you become defined by your tastes rather than ability. your tastes only narrow &amp; exclude people. so create.</blockquote>


<p>&nbsp;</p>

<h3>2. The ecosystem - RVM/rbenv, RubyGems, Bundler, Git and Github</h3>


<p>I think all of these tools are mandatory for being a productive Ruby programmer. You&rsquo;ll encounter them soon enough:</p>

<ul>
<li><p>RVM/rbenv: these are tools used to manage multiple Ruby versions on the same machine. I&rsquo;ve been using RVM without complaint for quite a while, though there are people who will go up in arms against RVM for various reasons. As a beginner, you should be comfortable with either.</p></li>
<li><p>RubyGems: a gem for anything, a gem for everything. If you are using RVM, it will install RubyGems by default for you. <a href="http://docs.rubygems.org/read/chapter/4" target="_blank"><a href="http://docs.rubygems.org/read/chapter/4">http://docs.rubygems.org/read/chapter/4</a></a></p></li>
<li><p>Bundler: You&rsquo;ll learn it easy enough if you are using Rails. But even for non-Rails projects, Bundler is now the de-facto tool to handle gems and dependencies. It is one of those tools that when you see for the first time you would wonder how you ever lived without it.</p></li>
<li><p>Git: You are a git if you don&rsquo;t use git yet. If you are not even using any version control at all, good for you &ndash; there aren&rsquo;t bad practices that you need to unlearn. If you are on SVN, or God forbid CVS, jump now.<a href="http://git-scm.com/book/en/Getting-Started-About-Version-Control" target="_blank"><a href="http://git-scm.com/book/en/">http://git-scm.com/book/en/</a><wbr>Getting-Started-About-Version-<wbr>Control</wbr></wbr></a></p></li>
<li><p>Github: You have a Github handle, right? &lsquo;nuff said.</p></li>
</ul>


<h3>3. Editor</h3>


<p>I don&rsquo;t care. Pick one, use it well. If you&rsquo;re on Vim and is on Insert mode all the time, then use Notepad instead. It would be more productive. Learn your editor.</p>

<p>Here is a list of editors/IDEs people generally use for Ruby development:</p>

<ul>
<li>Sublime Text</li>
<li>Textmate</li>
<li>RubyMine (My favourite, but needs a lot of memory and CPU)</li>
<li>Vim</li>
<li>emacs</li>
<li>Aptana RadRails (recently saw a couple of people using it. don&rsquo;t know how good it is)</li>
<li>Redcar (I&rsquo;ve used it very occassionaly, am yet to see someone using it as a primary editor)</li>
</ul>


<p>If you are using Sublime Text, install and use its corresponding Ruby package. Ditto for Textmate.</p>

<p>If you are on Vim, using the right set of plugins is a requisite to be productive. There is the popular<a href="https://github.com/carlhuda/janus" target="_blank"><a href="https://github.com/carlhuda/janus">https://github.com/carlhuda/janus</a></a> and Srushti&#8217;s <a href="https://github.com/srushti/vim-get" target="_blank"><a href="https://github.com/srushti/vim-get">https://github.com/srushti/vim-get</a></a> which I use when I work with Vim. Even if you don&rsquo;t go for these plugin distributions, spend enough time to find the right plugins for Ruby development.</p>

<p>I don&rsquo;t know about the best plugins for emacs, but there are people who use emacs to develop in Ruby. Even Matz uses emacs; search and you shall find.</p>

<h3>4. Ditch &#8216;while&#8217;, &#8216;for&#8217; and array accumulation</h3>


<p>Read this: <a href="http://martinfowler.com/bliki/CollectionClosureMethod.html" target="_blank"><a href="http://martinfowler.com/bliki/">http://martinfowler.com/bliki/</a><wbr>CollectionClosureMethod.html</wbr></a></p>

<p>An apparent sign of a programmer who does not Ruby well is code that uses &lsquo;for&rsquo; and &lsquo;while&rsquo; loops for iteration and accumulation. I&rsquo;m hardpressed to remember occasions where I had to use them instead of the Enumerable methods #<em>each, #map, #select, #inject, #reject </em>and #<em>detect.</em> Learn these methods, chew on them, and use it everywhere!</p>

<p>(infinite loops are almost always written using the loop do..end construct though. but how often do you write infinite loops anyway?)</p>

<h3>5. Hash</h3>


<p>At the time when I started writing Ruby, the languages that I had written in for a reasonable period of time before were CA-Clipper, Borland Turbo C and some VB 6.</p>

<p>The first two did not have a hash, associative array or dictionary &ndash; whichever you prefer to call it.<strong> </strong>As to VB6, the only thing I can remember is DataGrid and ADODB. Ah, the failed promises of drag and drop programming!</p>

<p>So Hash was a revelation and I started using it anywhere and everywhere. Do you want to build a CRUD app to manage customer info? Forget databases, I&rsquo;ll build a Hash and serialize to and deserialize from a YAML file. There were even more crimes committed using Hash that I dare not mention here. You would have gone through enough exercises that uses Hash when working through RubyMonk or Ruby Koans. But if you haven&rsquo;t, make sure you understand Hashes well enough. Specifically:</p>

<ul>
<li>iterating over a hash</li>
<li>assigning default values for undefined keys in a hash</li>
<li>Hash#keys and Hash#values for extracting just the keys and values</li>
<li>In Ruby 1.8 Hashes are un-ordered: ie, you can&rsquo;t rely on the ordering of the hash to be same as the order in which you added elements. In Ruby 1.9, a Hash is sorted on the basis of order of insertion.</li>
</ul>


<h3>6. JSON and YAML</h3>


<p>These are not Ruby specific concepts, but find great use in the ecosystem. Know them well, they&rsquo;ll come in handy.</p>

<h3>7. Understand Immutability and how Ruby passes object references around</h3>


<p>This has slightly got to do with the above point &ndash; all the Enumerable methods are immutable, and it is a good introduction to how functional Ruby veer towards immutability.  Immutability is more of a good programming practice than a Ruby specific idea &ndash; it helps you write clean predictable code, leave aside concurrent programming and race conditions. A method that mutates its parameter is a vile creature, don&rsquo;t bring it forth into existence.</p>

<p>If you come from a C programming background, building new objects willy-nilly would be a little hard to digest. So much memory put to waste! I remember reading somewhere that programmers who use high level languages leave a higher carbon footprint because their code is inefficient. I leave you to ponder over it.</p>

<p>For understanding some quirks around Ruby&rsquo;s immutability and interesting effects of how Ruby passes object references around, figure out where Array#clone is used. I remember wasting many a debugger breakpoint during my early days of Ruby because I didn&rsquo;t realize this. Don&rsquo;t let that happen to you! Understand the difference between a shallow clone and a deep clone. Even better, go write your own deep_clone routine! (limit yourselves to objects that can have strings, numbers, arrays and hashes)</p>

<p>Also read: <a href="http://ruby-doc.org/docs/Newcomers/ruby.html#objects" target="_blank"><a href="http://ruby-doc.org/docs/Newcomers/ruby.html#objects">http://ruby-doc.org/docs/Newcomers/ruby.html#objects</a></a></p>

<h3>8. Ruby&#8217;s Object Hierarchy</h3>


<p>&nbsp;</p>

<div>
<pre># All objects are instances of the class Object. 
"a string".is_a? BasicObject         # true

# All classes are instances of the class Class.
String.is_a? Class                   # true

# Class is a subclass of BasicObject.
Class.is_a? BasicObject              # true

# Class is not an instance of BasicObject
Class.instance_of? BasicObject       # false

# BasicObject is an instance and a sub-class of Class
BasicObject.is_a? Class              # true
BasicObject.instance_of? Class       # true</pre>
</div>


<p>&nbsp;</p>

<p>Okay, I lost it. It is pretty crazy: <a href="http://stackoverflow.com/questions/4967556/ruby-craziness-class-vs-object" target="_blank"><a href="http://stackoverflow.com/questions/4967556/ruby-craziness-class-vs-object">http://stackoverflow.com/questions/4967556/ruby-craziness-class-vs-object</a></a>. As a beginner, you wouldn&rsquo;t need to understand the nitty-gritties. I&rsquo;ve been programming in Ruby for about three years now, and it still confuses the heck out of me.</p>

<p>For now it is safe to understand that BasicObject is usually the root object of all objects in Ruby. And everything in Ruby is an object. This has a very useful side-effect (try this in IRB):</p>

<div>
<pre>"some random string".methods - Object.methods</pre>
</div>


<p>Also,</p>

<div>
<pre>Array.new.methods - Object.methods</pre>
</div>


<p>&nbsp;</p>

<p>The above commands will show you methods that are specific to just strings and arrays, excluding all methods that are always present in any Ruby object (inherited from Object -like instance_of, is_a? etc.).</p>

<p><strong>Tip:</strong>You might have noticed that the &lsquo;&ndash;&rsquo; operator gives you the difference between two arrays. Whenever you need a general purpose method and wonder whether Ruby comes with it, just try some plausible syntax in IRB. You might be surprised at what you find.</p>

<p>Even though Ruby lets you Object Oriented and procedural code, the language leans toward OO. Ruby treats even methods as objects:</p>

<div>
<pre>"some string".method(:length) # gives you an object of the Method class.</pre>
</div>


<p>The method object can be asked to run by invoking the &lsquo;call&rsquo; method on it.</p>

<p>&nbsp;</p>

<h3>9. Creating your own Objects</h3>


<p>Did you notice that the title wasn&rsquo;t &lsquo;Creating Classes&rsquo;. That was one of the most useful advices I&rsquo;ve ever received: Always think in terms of objects &ndash; not classes. Thinking in terms of Classes can subtly make you evolve your design upfront. Don&rsquo;t. Let your objects guide you in how your class definition should look. As a rough analogy, when building a home, the blueprint is valuable only as a reference for building the actual home. You imagine what your home should look like and draw a blueprint accordingly, not the other way round.</p>

<p>Start with sparse classes, add methods and attributes as your objects demand it. Srushti puts it better: Imagine you&rsquo;re an instance, and think about what you want to do and how you want to do it. You don&rsquo;t want to give up your secrets (encapsulation). You don&rsquo;t ask other people for information so you can do their work for them, you just tell them to do stuff for you (tell, don&rsquo;t ask)</p>

<p>Ruby has a very simple syntax for defining classes and building objects. If you come from a Java/C# background, it&rsquo;d be the first thing you look for. But even if you are a die-hard procedural ninja, trust me, thinking in terms of objects will help you write better programs, tackle complexity and be a more capable programmer.</p>

<p>So, what are the things that are specific to Ruby that you need to be aware of?</p>

<p>&nbsp;</p>

<ul>
<li>Message Passing. &ldquo;abcd&rdquo;.length is in fact &ldquo;abcd&rdquo;.send(:length).</li>
<li>Module vs Classes (hint: they&rsquo;re very similar, but you can&rsquo;t instantiate a Module)</li>
<li>Mixins (Ruby&rsquo;s answer to multiple inheritance and the greatest thing <em>before</em> sliced bread)</li>
<li>attr_reader, attr_writer, attr_accessor.</li>
<li>instance methods and class methods</li>
<li>instance variables and class variables.</li>
</ul>


<p>And we all know that you don&rsquo;t use class variables unless you have a very good reason. Class methods aren&rsquo;t that bad, but are usually a smell. Whenever you find yourselves writing a class method, take a step back and make sure it can&rsquo;t be rephrased as an instance method, perhaps in a child object?</p>

<p>There is a lot more to OO, some less specific to Ruby. As you go deep into the rabbit hole, ponder over these blanket statements:</p>

<ul>
<li>Primitives (Hash, Array etc.) are evil! Build objects.</li>
<li>Inheritance is evil! Use Composition.</li>
<li>Conditions (if..else, switch..case) are evil! Use Polymorphism.</li>
</ul>


<h3>10. Ruby is interpreted. It is malleable. Use that to your advantage.</h3>


<p>Interpreted programs are almost always slower than native code (which includes JIT). By choosing to use such a language, you are accepting a compromise in the speed/efficiency of your programs. But this gives you a great advantage: the flexibility to change your code at runtime. Though we can&rsquo;t claim &lsquo;code is data, data is code&rsquo; like those hipster LISPers do, there is tremendous power in the dynamism (no reference to type systems) of Ruby. Learn it, use it, change the world!</p>

<p>I had briefly mentioned the &lsquo;send&rsquo; method that is available for every object in Ruby:</p>

<div>
<pre>   "abcd".send(:length)</pre>
</div>


<p>is same as</p>

<div>
<pre>   "abcd".length</pre>
</div>


<p>That means you can do things like this:</p>

<p>&nbsp;</p>

<div>
<pre>puts "Hi, which method do you like to invoke on a string today?"
method_name = gets.strip
puts "a random string".send(method_name)</pre>
</div>


<p>&nbsp;</p>

<p>Did you see that? Unlike fully compiled languages like C/C++, Ruby lets you call arbitrary methods during runtime! (you can pass arguments to the method as parameters to the &lsquo;send&rsquo; method)</p>

<p>Leave aside calling arbitrary methods, running arbitrary code during runtime is a breeze:</p>

<div>
<pre>puts "What code do you want to run today, dear sir?"
arbitrary_code = STDIN.read         # press ctrl+d to stop input
eval(arbitrary_code)</pre>
</div>


<p>Try it, type in some short valid Ruby code and see it in action.</p>

<p>&nbsp;</p>

<p>Now that you know &lsquo;eval&rsquo; exists, forget about it. It is too dangerous to be almost ever used. It is unsafe and unscoped, but there are better things to achieve similar and useful results. The point of this exercise though was to see Ruby&rsquo;s dynamic nature in action. Since Ruby is interpreted, there is no limitation on what can be done during runtime. This can be used to great good as we will see in Metaprogramming.</p>

<h3>11. Metaprogramming</h3>


<p>Metaprogramming in Ruby more or less gives you ways to create/remove/redefine methods at runtime. If you have used Rails, you would have seen that you would write something like</p>

<div>
<pre>class User &lt; ActiveRecord::Base
end</pre>
</div>


<p>and magically, the User class gives you methods like user.name, user.find_by_name, user.find_by_name_and_id. Depending on the fields in the database, Rails defines methods for you to use. This uses Metaprogramming where Rails defines the methods at runtime after consulting the table schema.</p>

<p>(talking about &lsquo;magic&rsquo;, usually when someone complain about &lsquo;magic&rsquo; in Ruby code, she is most probably referring to some sort of metaprogramming in the code)</p>

<p>Metaprogramming is one of Ruby&rsquo;s most powerful concepts (anything borrowed from FP is yummy!), but it is open to use and abuse. They say that someone who knows metaprogramming well enough, but not enough to know where not to use it, is a danger to himself and society. The internet is rife with discussions around it and you&rsquo;ll find no shortage of flame wars, opinions and thankfully, documentation.</p>

<p>These are the methods you would want to look up to get a decent overview of metaprogramming in Ruby:</p>

<ul>
<li>define_method</li>
<li>method_missing</li>
<li>instance_eval</li>
<li>class_eval</li>
</ul>


<p>I would also recommend Yehuda Katz&rsquo;s excellent explanation of Metaprogramming by relating it to the context of &lsquo;self&rsquo;: <a href="http://yehudakatz.com/2009/11/15/metaprogramming-in-ruby-its-all-about-the-self/" target="_blank"><a href="http://yehudakatz.com/2009/11/">http://yehudakatz.com/2009/11/</a><wbr>15/metaprogramming-in-ruby-its-all-about-the-self/</wbr></a></p>

<p>Metaprogramming is a bit advanced, and if you don&rsquo;t understand all or any of it the first time, don&rsquo;t worry. Come back and take a look again later. Rinse and repeat. It is an acquired taste, give it time!</p>

<h3>12. Closures (Blocks, Lambdas et al.)</h3>


<p>Blocks are my favourite. They move mountains. Rather, they let you write beautiful DSLs when coupled with the right dose of metaprogramming. Have you seen factory_girl&rsquo;s syntax? It is an unholy mix of method_missing and &lsquo;yield&rsquo;.</p>

<pre><span>Factory :user, aliases: [:author, :commenter] do first_name "John" last_name "Doe" date_of_birth { 18.years.ago } end</span></pre>


<p>It is not really hard to build a DSL that reads like this, and there is no better resource to learn all of this than <a href="http://rubysource.com/functional-programming-techniques-with-ruby-part-ii/" target="_blank"><a href="http://rubysource.com/">http://rubysource.com/</a><wbr>functional-programming-<wbr>techniques-with-ruby-part-ii/</wbr></wbr></a>. The first part of that series looks into the functional and immutable aspects of Ruby, and is also a recommended read:<a href="http://rubysource.com/functional-programming-techniques-with-ruby-part-i/" target="_blank"><a href="http://rubysource.com/">http://rubysource.com/</a><wbr>functional-programming-<wbr>techniques-with-ruby-part-i/</wbr></wbr></a></p>

<h3>13. Styleguides</h3>


<p>Whenever you are in doubt, or the self becomes too much with you, go read the Ruby style guides.</p>

<p>Github&rsquo;s simpler style guide: <a href="https://github.com/styleguide/ruby" target="_blank"><a href="https://github.com/styleguide/">https://github.com/styleguide/</a><wbr>ruby</wbr></a></p>

<p>The comprehensive one: <a href="https://github.com/bbatsov/ruby-style-guide" target="_blank"><a href="https://github.com/bbatsov/">https://github.com/bbatsov/</a><wbr>ruby-style-guide</wbr></a></p>

<h3>14. Simplicity is virtue</h3>


<p>Knowing what constructs to use where is a matter of knowledge and experience. Every approach has trade-offs in terms of readability, maintainability and efficiency. The battle between these have been the recurring theme in the battles programmers fight in their heads for years. Knowing the the trade-offs will help you make more informed decisions, but it might not always be enough. Some things need to be tried, tested and failed, and that is fine.</p>

<p>But be vary of <a href="http://c2.com/cgi/wiki?PrematureOptimization" target="_blank">Premature Optimization</a>. When you have a choice between clever, short and maybe faster code Vs longer but readable code, go for readability.  Ruby makes it easy to write really bad code that people would fear to touch with a long pole. It also lets you write  beautiful and concise code. When you contemplate between the two, remember the joke about the psychopath who&rsquo;ll inherit your codebase, knows where you live, and pings you from your local network! The choice is yours.</p>

<h3>15. None of this matters</h3>


<p>If you are overwhelmed by this document or any links referenced from here, just ignore it. Remember the<a href="http://norvig.com/21-days.html" target="_blank">10,000 hours rule</a>. Happily go about writing code the way you know best! And write a bit more code. Try to pair with someone who knows things a bit more. Go read some well-written Ruby code from Github. Then come back and see what you&rsquo;ve learned.</p>

<p>None of this is rocket science, but it takes time and practice for concepts to sink in, and that is just fine.</p>

<hr />


<p>Have further questions? There are tons of resource on the internet to answer your questions!</p>

<p>Join one of your local Ruby Usergroups. The Ruby community is extremely helpful and accomodating towards newbies. Check this page to locate a usergroup near you: <a href="http://www.rubyinside.com/how-to-find-ruby-user-groups-3067.html">How To Find Ruby User Groups</a></p>

<p>Participate in the usergroups, ask your questions. Also hop on to Ruby&rsquo;s IRC channel <a href="http://irc.lc/freenode/ruby-lang">#ruby-lang on Freenode</a>. Irrespective of the forum, just make sure that you give enough context about your question to help others understand your problem. If you haven&rsquo;t read ESR&rsquo;s &ldquo;<a href="http://www.catb.org/~esr/faqs/smart-questions.html" target="_blank">Ask questions the smart way</a>&rdquo; yet, <em>this</em> is the time. Go read it now and get enlightened on the ways of the interwebs!</p>

<p>And remember to have fun! In Matz&rsquo;s own words:</p>

<blockquote> &#8221;For me the purpose of life is partly to have joy. Programmers often feel joy when they can concentrate on the creative side of programming, So Ruby is designed to make programmers happy.&#8221;</blockquote>


<p>Happy hacking!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/15/using-resque-to-send-mail-for-devise/">Using Resque to Send Mail for Devise</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-15T15:03:00+08:00" pubdate data-updated="true">Jun 15<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Using Resque to send mail for Devise</h2>

<div>
<div id="wiki-body">
<div>

Since sending email synchronously is not a good idea, you&#8217;ll probably want to have Devise enqueuing it&#8217;s notification emails for background processing.

Although Devise doesn&#8217;t support this out of the box you can achieve it easily by using the <a href="https://github.com/mhfs/devise-async">devise-async</a> gem.

To do so, first add it to your Gemfile:
<div>
<pre>gem "devise-async"</pre>
</div>
Then tell Devise to use the proxy mailer in <code>config/initializers/devise.rb</code>:
<div>
<pre># Configure the class responsible to send e-mails.
config.mailer = "Devise::Async::Proxy"</pre>
</div>
And last but not least, set your queuing backend by creating <code>config/initializers/devise_async.rb</code>:
<div>
<pre># Supported options: :resque, :sidekiq, :delayed_job
Devise::Async.backend = :resque</pre>
</div>
Your notification emails should now be gracefully enqueued for background processing.

</div>
</div>
</div>


<h2 id="gollum-footer">## Notice I have jobs in queue but no workers. Do I have to create task, or workers?</h2>


<p>&nbsp;</p>

<p><code>#!/usr/bin/env rake</p>

<h1>Add your own tasks in files placed in lib/tasks ending in .rake,</h1>

<h1>for example lib/tasks/capistrano.rake, and they will automatically be available to Rake.</code></h1>

<p>require File.expand_path(&lsquo;../config/application&rsquo;, <strong>FILE</strong>)
require &lsquo;resque/tasks&rsquo;</p>

<p>Askjane::Application.load_tasks</p>

<p>task &ldquo;resque:setup&rdquo; =&gt; :environment do
ENV[&lsquo;QUEUE&rsquo;] ||= &lsquo;*&rsquo;</p>

<h1>for redistogo on heroku <a href="http://stackoverflow.com/questions/2611747/rails-resque-workers-fail-with-pgerror-server-closed-the-connection-unexpectedl">http://stackoverflow.com/questions/2611747/rails-resque-workers-fail-with-pgerror-server-closed-the-connection-unexpectedl</a></h1>

<p>Resque.before_fork = Proc.new { ActiveRecord::Base.establish_connection }
end</p>

<h4>run below command</h4>

<h1>QUEUE=* rake environment resque:work</h1>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/08/tong-guo-mongodumphe-mongorestoreshi-xian-mongodbbei-fen-he-hui-fu-by-chenzhou123520/">通过mongodump和mongorestore实现Mongodb备份和恢复 &#8211;by Chenzhou123520</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/ruby-on-rails-4-dot-0-release-notes/">Ruby on Rails 4.0 Release Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/rails-active-record-named-scopes/">Rails Active Record Named Scopes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/27/shai-shai-wo-men-de-kai-yuan-xiang-mu-iteyekai-yuan-dai-ma/">晒晒我们的开源项目 ITEYE开源代码</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/26/single-sign-on-dan-dian-deng-lu-sso/">Single Sign-on 单点登录 Sso</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jhjguxin">@jhjguxin</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jhjguxin',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Francis Jiang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
