
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Francis's Octopress Blog</title>
  <meta name="author" content="Francis Jiang">

  
  <meta name="description" content="nginx缓存cache的5种方案 1. 客户端浏览器上的缓存(非Cookie, Cookie中的内容为: 键和值均为string类型的键值对) 我们可以通过在Http回应中增加特定的头部说明来指定浏览器的缓存策略; 添加头部说明的手段既可以通过页面指令声明设置, 也可以通过编程方式设置. & &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jhjguxin.github.io/blog/page/14">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Francis's Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-25901353-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Francis's Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jhjguxin.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/readme">Readme</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/30/nginxhuan-cun-cachede-5chong-fang-an/">Nginx缓存cache的5种方案</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-30T17:54:00+08:00" pubdate data-updated="true">Nov 30<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>nginx缓存cache的5种方案</h2>

<div>

1. 客户端浏览器上的缓存(非Cookie, Cookie中的内容为: 键和值均为string类型的键值对)

我们可以通过在Http回应中增加特定的头部说明来指定浏览器的缓存策略; 添加头部说明的手段既可以通过页面指令声明设置, 也可以通过编程方式设置.

&nbsp;

对于图片、Javascript脚本、CSS等资源, 可以在IIS管理器中, 右击图片等资源, 选择”属性” &#8211;&gt; HttpHeaders后, 勾选Enable Content Expiration并设置时间即可. 一种值得推荐的手段是, 将需要缓存的资源分类, 如: image/dynamic/、image/static/, 这样我们可以再文件夹上, 选择属性中的HttpHeaders进行设置. 否则, 针对每一个静态资源设置HttpHeaders将是件非常痛苦的事情. 此外, 还可以采用一款名为CacheRight的工具可以提供缓存资源的统一配置.

&nbsp;

<strong>查看或设置浏览器缓存位置:</strong>  IE &#8211;&gt; Internet选项 &#8211;&gt; 常规 &#8211;&gt; 临时Internet文件 &#8211;&gt; 设置

<strong> </strong>

<strong>Html</strong><strong>文件的Head</strong><strong>中的缓存设置:</strong>

&lt;meta http-equiv=&#8221;pragma&#8221; content=&#8221;no-cache&#8221; /&gt;

&lt;meta http-equiv=&#8221;Cache-Control&#8221; content=&#8221;no-cache&#8221; /&gt;

&lt;meta http-equiv=&#8221;expires&#8221; content=&#8221;Wed, 26 Feb 1997 08:21:57 GMT&#8221; /&gt;

<strong>浏览器中关于Cache</strong><strong>的3</strong><strong>属性:</strong>

Cache-Control:

设置相对过期时间, max-age指明以秒为单位的缓存时间. 若对静态资源只缓存一次, 可以设置max-age的值为315360000000 (一万年).

<strong>Http</strong><strong>协议的cache-control</strong><strong>的常见取值及其组合释义:</strong>

no-cache: 数据内容不能被缓存, 每次请求都重新访问服务器, 若有max-age, 则缓存期间不访问服务器.

no-store: 不仅不能缓存, 连暂存也不可以(即: 临时文件夹中不能暂存该资源)

private(默认): 只能在浏览器中缓存, 只有在第一次请求的时候才访问服务器, 若有max-age, 则缓存期间不访问服务器.

public: 可以被任何缓存区缓存, 如: 浏览器、服务器、代理服务器等

max-age: 相对过期时间, 即以秒为单位的缓存时间.

no-cache, private: 打开新窗口时候重新访问服务器, 若设置max-age, 则缓存期间不访问服务器.

private, 正数的max-age: 后退时候不会访问服务器

no-cache, 正数的max-age: 后退时会访问服务器

点击刷新: 无论如何都会访问服务器.

Expires:

设置以分钟为单位的绝对过期时间, 优先级比Cache-Control低, 同时设置Expires和Cache-Control则后者生效.

Last-Modified:

该资源的最后修改时间, 在浏览器下一次请求资源时, 浏览器将先发送一个请求到服务器上, 并附上If-Unmodified-Since头来说明浏览器所缓存资源的最后修改时间, 如果服务器发现没有修改, 则直接返回304(Not Modified)回应信息给浏览器(内容很少), 如果服务器对比时间发现修改了, 则照常返回所请求的资源.

&nbsp;

注意:

Last-Modified属性通常和Expires或Cache-Control属性配合使用, 因为即使浏览器设置缓存, 当用户点击”刷新”按钮时, 浏览器会忽略缓存继续向服务器发送请求, 这时Last-Modified将能够很好的减小回应开销.

&nbsp;

ETag将返回给浏览器一个资源ID, 如果有了新版本则正常发送并附上新ID, 否则返回304， 但是在服务器集群情况下, 每个服务器将返回不同的ID, 因此不建议使用ETag.

&nbsp;

以上描述的客户端浏览器缓存是指存储位置在客户端浏览器, 但是对客户端浏览器缓存的实际设置工作是在服务器上的资源中完成的. 虽然刚才我们介绍了有关于客户端浏览器缓存的属性, 但是实际上对这些属性的设置工作都需要在服务器的资源中做设置. 我们有两种操作手段对浏览器缓存进行设置, 一个是通过页面指令声明来设置, 另外一个是通过编程方式来设置.

&nbsp;

浏览器缓存的设置手段:

第一: 通过页面指令声明来设置HTTP的缓存

页面指令&lt;%@ OutputCache Location=”Any” Duration=”10” VaryByParam=”ProductId” VaryByHeader=”Accept-Language”%&gt;中的Location用来设置缓存的位置, 该属性常见的值为:

Any(默认): 输出缓存可以位于任何地点, 对应于HttpCacheability.Public. 如: 客户端浏览器、代理服务器或服务器本身.

Client: 只能位于发出请求的客户端浏览器, 对应于HttpCacheability.Private.

Downstream: 输出缓存可以位于除服务器本身的其他任何地方, 如: 客户端浏览器、代理服务器.

Server: 输出缓存位于Web服务器本身, 对应于HttpCacheability.Server

ServerAndClient: 输出缓存只能位于服务器本身或客户端浏览器, 对应于HttpCacheability.Private和HttpCacheability.Server

None: 禁用输出缓存, 对应于HttpCacheability.NoCache.

VaryByParam属性: 根据请求参数的不同而缓存不同的版本. 多个值用分号(;)分隔, *号表示为任意参数或参数组合缓存不同版本, “none”表示只缓存一个版本.

VaryByHeader属性: 根据请求头来缓存不同的版本, 如同一页面的不同语言版本.

VaryByCustom属性: 根据自定义参数来缓存不同的版本, 如: VaryByCunstom=”browser”是系统已实现的, 根据浏览器名称和版本号缓存不同的版本. 也可以, 根据自定义参数来缓存, 如: VaryByCustom=”happy”, 此时系统不知道如何解释happy, 因此需要在Global.asax或IHttpModule实现类中重写GetVaryByCustomString()方法, 来完成处理逻辑.

VaryByControl属性: 根据用户控件中的服务器控件ID来缓存不同版本.

更高级的方式, 是通过配置文件来设置HTTP的缓存.

页面指令为&lt;%@ OutputCache CacheProfile=”cacheconfig”%&gt;, 其中cacheconfig是配置文件中的缓存配置节中CacheProfile的名称.
<div>View Code
<div id="cnblogs_code_open_c6451953-d048-4c1a-aa1d-39b4e297c264">
<div>&lt;system.web&gt;
&lt;caching&gt;
&lt;outputCacheSettings&gt;
&lt;outputCacheProfiles&gt;
&lt;add name=&#8221;cacheconfig&#8221; duration=&#8221;10&#8221; varyByParam=&#8221;none&#8221;/&gt;
&lt;/outputCacheProfiles&gt;
&lt;/outputCacheSettings&gt;
&lt;/caching&gt;
&lt;/system.web&gt;</div>
<div>
<h1>nginx缓存cache的5种方案</h1>
1、传统缓存之一（404）

这个办法是把nginx的404错误定向到后端，然后用proxy_store把后端返回的页面保存。

配置：

location / {
root /home/html/;#主目录
expires 1d;#网页的过期时间
error_page 404 =200 /fetch$request_uri;#404定向到/fetch目录下
}

location /fetch/ {#404定向到这里
internal;#指明这个目录不能在外部直接访问到
expires 1d;#网页的过期时间
alias /home/html/;#虚拟目录文件系统地址要和locaion /一致，proxy_store会将文件保存到这目录下
proxy_pass ;#后端upstream地址，/fetch同时是一个代理
proxy_set_header Accept-Encoding &#8221;;#让后端不要返回压缩（gzip或deflate）的内容，保存压缩后的内容会引发乱子。
proxy_store on;#指定nginx将代理返回的文件保存
proxy_temp_path /home/tmp;#临时目录，这个目录要和/home/html在同一个硬盘分区内
}

使用的时候还有要注意是nginx要有权限往/home/tmp和/home/html下有写入文件的权限，在linux下nginx一般会配置成nobody用户运行，这样这两个目录就要chown nobody，设成nobody用户专用，当然也可以chmod 777，不过所有有经验的系统管理员都会建议不要随便使用777。

2、传统缓存之二（!-e）

原理和404跳转基本一致，但更简洁一些：

location / {
root /home/html/;
proxy_store on;
proxy_set_header Accept-Encoding &#8221;;
proxy_temp_path /home/tmp;
if ( !-f $request_filename )
{
        proxy_pass ;
}
}

可以看到这个配置比404节约了不少代码，它是用!-f来判断请求的文件在文件系统上存不存在，不存在就proxy_pass到后端，返回同样是用proxy_store保存。

两种传统缓存都有着基本一样的优点和缺点：

缺点1：不支持带参数的动态链接，比如read.php?id=1，因为nginx只保存文件名，所以这个链接只在文件系统下保存为read.php，这样用户访问read.php?id=2时会返回不正确的结果。同时不支持这种形式的首页和二级目录，因为nginx非常老实，会将这样的请求照链接写入文件系统，而这个链接显然是一个目录，所以保存失败。这些情况都需要写rewrite才能正确保存。
缺点2：nginx内部没有缓存过期和清理的任何机制，这些缓存的文件会永久性地保存在机器上，如果要缓存的东西非常多，那就会撑暴整个硬盘空间。为此可以使用一个shell脚本定期清理，同时可以撰写php等动态程序来做实时更新。
缺点3：只能缓存200状态码，因此后端返回301/302/404等状态码都不会缓存，假如恰好有一个访问量很大的伪静态链接被删除，那就会不停穿透导致后端承载不小压力。
缺点4：nginx不会自动选择内存或硬盘作为存储介质，一切由配置决定，当然在当前的操作系统里都会有操作系统级的文件缓存机制，所以存在硬盘上也不需要过分担心大并发读取造成的io性能问题。

nginx传统缓存的缺点也是它和squid等缓存软件的不同之特色，所以也可看作其优点。在生产应用中它常常用作和squid的搭档，squid对于带?的链接往往无法阻挡，而nginx能将其访问拦住，例如：?和在squid上会被当做两个链接，所以会造成两次穿透；而nginx只会保存一次，无论链接变成还是，均不能透过nginx缓存，从而有效地保护了后端主机。

nginx会非常老实地将链接形式保存到文件系统中，这样对于一个链接，可以很方便地查阅它在缓存机器上的缓存状态和内容，也可以很方便地和别的文件管理器如rsync等配合使用，它完完全全就是一个文件系统结构。

这两种传统缓存都可以在linux下将文件保存到/dev/shm里，一般我也是这么做的，这样可以利用系统内存来做缓存，利用内存的话，清理过期内容速度就会快得多。使用/dev/shm/时除了要把tmp目录也指向到/dev/shm这个分区外，如果有大量小文件和目录，还要修改一下这个内存分区的inode数量和最大容量：

mount -o size=2500M -o nr_inodes=480000 -o noatime,nodiratime -o remount /dev/shm

上面的命令在一台有3G内存的机器上使用，因为/dev/shm默认最大内存是系统内存的一半就是1500M，这条命令将其调大成2500M，同时shm系统inode数量默认情况下可能是不够用的，但有趣的是它可以随意调节，这里调节为480000保守了点，但也基本够用了。

3、基于memcached的缓存

nginx对memcached有所支持，但是功能并不是特别之强，性能上还是非常之优秀。

location /mem/ {
    if ( $uri ~ &#8220;^/mem/([0-9A-Za-z_]*)$&#8221; )
    {
     set $memcached_key &#8220;$1&#8221;;
     memcached_pass     192.168.1.2:11211;
    }
    expires 70;
}

这个配置会将指明到memcached的abc这个key去取数据。

nginx目前没有写入memcached的任何机制，所以要往memcached里写入数据得用后台的动态语言完成，可以利用404定向到后端去写入数据。

4、基于第三方插件ncache

ncache是新浪兄弟开发的一个不错的项目，它利用nginx和memcached实现了一部分类似squid缓存的功能，我并没有使用这个插件的经验，可以参考：

&nbsp;

5、nginx新开发的proxy_cache功能

从nginx-0.7.44版开始，nginx支持了类似squid较为正规的cache功能，目前还处于开发阶段，支持相当有限，这个缓存是把链接用md5编码hash后保存，所以它可以支持任意链接，同时也支持404/301/302这样的非200状态。

配置：

首先配置一个cache空间：

proxy_cache_path /path/to/cache levels=1:2 keys_zone=NAME:10m inactive=5m max_size=2m clean_time=1m;

#注意这个配置是在server标签外，levels指定该缓存空间有两层hash目录，第一层目录是1个字母，第二层为2个字母，保存的文件名就会类似/path/to/cache/c/29/b7f54b2df7773722d382f4809d65029c；keys_zone为这个空间起个名字，10m指空间大小为10MB；inactive的5m指缓存默认时长5分钟；max_size的2m是指单个文件超过2m的就不缓存；clean_time指定一分钟清理一次缓存。

location / {
    proxy_pass ;

    proxy_cache NAME;#使用NAME这个keys_zone

    proxy_cache_valid 200 302 1h;#200和302状态码保存1小时
    proxy_cache_valid 301 1d;#301状态码保存一天
    proxy_cache_valid any 1m;#其它的保存一分钟
}

ps：支持cache的0.7.44到0.7.51这几个版本的稳定性均有问题，访问有些链接会出现错误，所以这几个版本最好不要在生产环境中使用。nginx-0.7下目前所知较为稳定的版本是0.7.39。稳定版0.6.36版也是近期更新，如果在配置里没有使用到0.7的一些新标签新功能，也可以使用0.6.36版。

</div>
</div>
</div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/29/rubyonrails-guide-to-active-record-associations/">Rubyonrails Guide to Active Record Associations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-29T15:31:00+08:00" pubdate data-updated="true">Nov 29<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Rubyonrails Guide to Active Record Associations</h2>

<div>
<h1>Active Record</h1>
Active Record（中文名：活动记录）是一种领域模型模式，特点是一个模型类对应关系型数据库中的一个表，而模型类的一个实例对应表中的一行记录。Active Record 和Row Gateway （行记录入口）十分相似，但前者是领域模型，后者是一种数据源模式。关系型数据库往往通过外键来表述实体关系，Active Record 在数据源层面上也将这种关系映射为对象的关联和聚集。

Active Record 适合非常简单的领域需求，尤其在领域模型和数据库模型十分相似的情况下。如果遇到更加复杂的领域模型结构（例如用到继承、策略的领域模型），往往需要使用分离数据源的领域模型，结合Data Mapper （数据映射器）使用。

Active Record 驱动框架一般兼有ORM 框架的功能，但ActivActive Recorde Record 不是简单的ORM，正如和Row Gateway 的区别。著名的例子是全栈（Full Stack）Web 开发框架Ruby on Rails ，其默认使用一个纯Ruby 写成的<strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><strong>框架</strong>来驱动MVC 中的模型层。

对象关系映射（ORM）提供了概念性的、易于理解的模型化数据的方法。ORM方法论基于三个核心原则：简单：以最基本的形式建模数据。传达性：数据库结构被任何人都能理解的语言文档化。精确性：基于数据模型创建正确标准化了的结构。

在Martin Fowler 的《企业应用架构模式》一书中曾详细叙述了本模式。

以下是著名的Active Record 驱动框架：

SQLObject(Python)

Ruby on Rails ActiveRecord (Ruby)

Yii Framework ActiveRecord (PHP)

Castle ActiveRecord (.NET)
<h2>Migrations</h2>
Migrations are a convenient way for you to alter移动your database in a structured and organized manner.Migrations是一种很便捷的方法让你能够以一种结构化的和有组织的方式来迁移你的数据库。You could edit fragments of SQL by hand but you would then be responsible for telling other developers that they need to go and run them.你可以手动编辑SQL片段，而且你有责任把这些告诉其他的开发人员，因为他们需要开发和使用它们。You’d also have to keep track of which changes need to be run against the production machines next time you deploy.你也可以跟踪对你部署的代码在接下来的production机器（将会）发生的变化。

Active Record tracks which migrations have already been run so all you have to do is update your source and run <tt>rake</tt><tt> </tt><tt>db:migrate</tt>.Active Record跟踪并迁移你已经运行过的（代码和数据），而你只需要在更新了你的源代码的时候执行<tt>rake</tt><tt> </tt><tt>db:migrate</tt><tt>。</tt>Active Record will work out which migrations should be run.Active Recor将会计算出那些迁移需要被执行。It will also update your <tt>db/schema.rb</tt> file to match the structure of your database.它还会更新你的<tt>db/schema.rb</tt><tt>文件使其于你的数据库结构相匹配。</tt>

Rails使用的是<strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><strong>框架</strong>来处理数据迁移，这里笔者把ActiveRecord框架放在一个地方学习了，如需了解Migration部分需要直接阅读Migration部分。

&nbsp;
<h2>Active Record Validations and Callbacks 活动记录验证和回调</h2>
This guide teaches you how to hook勾子into the life cycle of your Active Record objects.这个教程指导你怎样挂接到你的Active Record objects的生存周期。You will learn how to validate the state of objects before they go into the database, and how to perform custom operations at certain points in the object life cycle.你将会学习到在将数据对象存入数据库之前怎样验证它们的状态，以及在对象生存周期的一些点上怎样执行定制操作。

Rails使用的是<strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><strong>框架</strong>来处理验证和回调，这里笔者把ActiveRecord框架放在一个地方学习了，如需了解Migration部分需要直接阅读ValidationsandCallbacks部分。
<h2><strong>A</strong><strong> </strong><strong>Guide</strong><strong> </strong><strong>to</strong><strong> </strong><strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><strong>Associations</strong></h2>
This guide covers the association features of Active Record. By referring to this guide, you will be able to:本教程涵盖了Active Record的关系部分的特性。（通过）这个教程提及的，你将能够：
<ul>
    <li>Declare associations between Active Record models 在Active Record的models中声明（它们的）关系</li>
    <li>Understand the various types of Active Record associations 明白各种类型的Active Record关系</li>
    <li>Use the methods added to your models by creating associations 通过添加方法到models（的形式）来创建关系</li>
</ul>
<h3><a name="why-associations"></a>1 Why Associations?为什么（会有）Associations</h3>
Why do we need associations between models? Because they make common operations simpler and easier in your code. For example, consider a simple Rails application that includes a model for customers and a model for orders. Each customer can have many orders. Without associations, the model declarations would look like this:为什么在models之间需要关系？因为它们使得在你的代码中大多数操作更加简单和容易。例如，思考一个简单的Rails应用程序其中包含一个customers的models和一个orders的模型（生产者和消费者模型）。每个消费者可以拥有多个生产者。没有associations（的话），模型声明看起来像这样：

classCustomer&lt;ActiveRecord::Base

end

classOrder&lt;ActiveRecord::Base

end

Now,suppose we wanted to add a new order for an existing customer.We’d need to do something like this:现在假设我们想为一个存在的customer添加一个新的order。我们需要做如下事情：

@order=Order.create(:order_date=&gt;Time.now,

:customer_id=&gt;@customer.id)

Or consider deleting a customer, and ensuring that all of its orders get deleted as well:或者考虑删除一个customer，那么确保它的所有的orders也被删除。

@orders = Order.where(:customer_id =&gt; @customer.id)

@orders.each do |order|

order.destroy

end

@customer.destroy

With Active Record associations, we can streamline these — and other — operations by declaratively声明方式telling Rails that there is a connection between the two models. Here’s the revised code for setting up customers and orders:通过Active Record associations，我们可以精简这样的或者其它（类似的）操作通过声明的方式告诉Rails在两个models之间有一个连接。这里修订代码来设定customers和orders：

class Customer &lt; ActiveRecord::Base

has_many :orders, :dependent =&gt; :destroy

end

&nbsp;

class Order &lt; ActiveRecord::Base

belongs_to :customer

end

With this change, creating a new order for a particular customer is easier:通过这样的修改，创建一个新的order给一个特定的customer更加容易：

<code>@order</code> <code>=</code><code> </code><code>@customer.orders.create(:order_date</code> <code>=&gt;</code><code> </code><code>Time.now)</code>

Deleting a customer and all of its orders is <em>much</em> easier:删除一个customer和它的所有的orders也容易了许多：

@customer.destroy

To learn more about the different types of associations, read the next section of this guide. That’s followed by some tips and tricks for working with associations, and then by a complete reference参考to the methods and options for associations in Rails.想要学习更多不同的类型的associations，阅读guide接下来的部分。这些（内容）伴随这一些在（使用）associations工作发现的tips和tricks，然后是一些Rails的associations的一些方法和options的一些完整的参考。
<h3><a name="the-types-of-associations"></a>2 The Types of Associations</h3>
In Rails, an <em>association</em> is a connection between two Active Record models. Associations are implemented using macro-style calls, so that you can declaratively add features to your models. For example, by declaring that one model <tt>belongs_to</tt> another, you instruct Rails to maintain Primary Key–Foreign Key information between instances of the two models, and you also get a number of utility methods added to your model. Rails supports six types of associations:在Rails，一个<em>association</em><em>是一个在两个</em><em></em><em>Active</em><em></em><em>Record模型之间的连接。</em><em>Associations（通过）使用宏方式的调用实施，以至于你可以（以）声明的方式添加</em><em>features到你的</em><em>models。例如申明一个</em><em>model</em><em></em><tt>belongs_to</tt><tt>另一个（模型）。</tt><tt>Rails</tt><tt>支持六种类型的</tt><tt>associations</tt><tt>：</tt>
<ul>
    <li><tt>belongs_to</tt></li>
    <li><tt>has_one</tt></li>
    <li><tt>has_many</tt></li>
    <li><tt>has_many</tt><tt> </tt><tt>:through</tt></li>
    <li><tt>has_one</tt><tt> </tt><tt>:through</tt></li>
    <li><tt>has_and_belongs_to_many</tt></li>
</ul>
<tt>In </tt><tt>the</tt><tt> remainder</tt><tt> of</tt><tt> this</tt><tt> guide,</tt><tt>you</tt><tt>’</tt><tt>ll </tt><tt>learn </tt><tt>how</tt><tt> to</tt><tt> declare</tt><tt> and</tt><tt> use</tt><tt> the </tt><tt>various</tt><tt> forms</tt><tt> of</tt><tt> associations.</tt><tt> But</tt><tt>first,</tt><tt>a</tt><tt> quick</tt><tt> introduction</tt><tt> to</tt><tt> the </tt><tt>situations </tt><tt>where</tt><tt> each </tt><tt>association</tt><tt> type</tt><tt> is</tt><tt> appropriate.</tt><tt>在这个</tt><tt>guide</tt><tt>的其他的部分，你将会学习到怎样申明和使用各种的形式的</tt><tt>associations</tt><tt>。但是首先，做一个快速的说明：每种类型的</tt><tt>association</tt><tt>在什么情况下出现。</tt>
<h4><a name="the-belongs_to-association1"></a>2.1 The <tt>belongs_to</tt> Association</h4>
A <tt>belongs_to</tt> association sets up a one-to-one connection with another model, such that each instance of the declaring model “belongs to” one instance of the other model. For example, if your application includes customers and orders, and each order can be assigned to exactly one customer, you’d declare the order model this way:一个<tt>belongs_to</tt><tt>关系设立一个</tt><tt>one-to-one</tt><tt>连接到另一个</tt><tt>model</tt><tt>，通过这样声明</tt><tt>model</tt><tt>的每一个实例</tt><tt>“</tt><tt>belongs</tt><tt> </tt><tt>to</tt><tt>” </tt><tt>另一个模型的实例。例如，如果你的应用程序包含</tt><tt>customers</tt><tt>和</tt><tt>orders</tt><tt>，并且每个</tt><tt>order</tt><tt>能够关联到仅仅一个</tt><tt>customer</tt><tt>，你可以这样的方式申明</tt><tt>order</tt><tt>模型：</tt>

<tt>class</tt><tt> </tt><tt>Order</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>belongs_to</tt><tt> </tt><tt>:customer</tt>

<tt>end</tt>
<h4><a name="the-has_one-association"></a>2.2 The <tt>has_one</tt> Association</h4>
A <tt>has_one</tt> association also sets up a one-to-one connection with another model, but with somewhat different semantics语义(and consequences结果). This association indicates that each instance of a model contains or possesses one instance of another model. For example, if each supplier in your application has only one account, you’d declare the supplier model like this:

<a name="the-belongs_to-association"></a> 一个<tt>has_one</tt><tt>关系也设定一个</tt><tt>one-to-one</tt><tt>连接到另一个</tt><tt>model</tt><tt>，但是有某些不同的语义（和结果）。这个关系指出了（声明的）模型的每一个实例包含或拥有一个其他模型的实例。例如你的应用程序中的每一个</tt><tt>supplier</tt><tt>仅仅只有一个</tt><tt>account</tt><tt>，你可以这样声明</tt><tt>supplier</tt><tt>模型：</tt>

<tt>class</tt><tt> </tt><tt>Supplier</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>has_one</tt><tt> </tt><tt>:account</tt>

<tt>end</tt>

&nbsp;
<h4><a name="the-has_many-association"></a>2.3 The <tt>has_many</tt> Association</h4>
A <tt>has_many</tt> association indicates a one-to-many connection with another model. You’ll often find this association on the “other side” of a <tt>belongs_to</tt> association. This association indicates that each instance of the model has zero or more instances of another model. For example, in an application containing customers and orders, the customer model could be declared like this:

一个<tt>has_many</tt><tt>关系指定了一个</tt><tt>one-to-many</tt><tt>连接到另一个</tt><tt>model</tt><tt>。你会经常发现这个关系在</tt><tt>belongs_to</tt><tt>关系的另一个端。这个关系指明了（声明）模型的每一个实例有零个或多个其它模型的实例。例如，在一个应用程序中包含</tt><tt>customers</tt><tt>和</tt><tt>orders</tt><tt>，</tt><tt>customer</tt><tt>模型如下声明：</tt>

<tt>class</tt><tt> </tt><tt>Customer</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>has_many</tt><tt> </tt><tt>:orders</tt>

<tt>end</tt>

The name of the other model is pluralized多元化when declaring a <tt>has_many</tt> association.

&nbsp;
<h4><a name="the-has_many-through-association"></a>2.4 The <tt>has_many</tt><tt> </tt><tt>:through</tt> Association</h4>
A <tt>has_many</tt><tt> </tt><tt>:through</tt> association is often used to set up a many-to-many connection with another model. This association indicates that the declaring model can be matched with zero or more instances of another model by proceeding <em>through</em> a third model. For example, consider a medical practice where patients make appointments to see physicians. The relevant association declarations could look like this:

<tt>一个</tt><tt>has_many</tt><tt> </tt><tt>:through</tt><tt>关系通常用于设定一个</tt><tt>many-to-many</tt><tt>连接到另一个模型。这个关系指定申明的模型可以通过第三个模型（中间模型）匹配零个或多个另一个模型的实例。例如，想想一个医疗实践（例子）其中病人约定时间去看医生。它们的有关关系声明可以如下：</tt>

class Physician &lt; ActiveRecord::Base

has_many :appointments

has_many :patients, :through =&gt; :appointments#通过约会有多个病人

end

&nbsp;

class Appointment &lt; ActiveRecord::Base

belongs_to :physician

belongs_to :patient

end

&nbsp;

class Patient &lt; ActiveRecord::Base

has_many :appointments

has_many :physicians, :through =&gt; :appointments

end

The collection of join models can be managed via通过the API. For example, if you assign加入模型的集合可以通过API管理。例如，如果你指定

physician.patients = patients

new join models are created for newly associated关联的objects, and if some are gone their rows are deleted.

<em><strong>Automatic</strong></em><em><strong> </strong></em><em><strong>deletion</strong></em><em><strong> </strong></em><em><strong>of</strong></em><em><strong> </strong></em><em><strong>join</strong></em><em><strong> </strong></em><em><strong>models</strong></em><em><strong> </strong></em><em><strong>is</strong></em><em><strong> </strong></em><em><strong>direct,</strong></em><em><strong> </strong></em><em><strong>no</strong></em><em><strong> </strong></em><em><strong>destroy</strong></em><em><strong> </strong></em><em><strong>callbacks</strong></em><em><strong> </strong></em><em><strong>are</strong></em><em><strong> </strong></em><em><strong>triggered.</strong></em>

The <tt>has_many</tt><tt> </tt><tt>:through</tt> association is also useful for setting up “shortcuts” through nested <tt>has_many</tt> associations. For example, if a document has many sections, and a section has many paragraphs, you may sometimes want to get a simple collection of all paragraphs in the document. You could set that up this way:

<tt>has_many</tt><tt> </tt><tt>:through</tt><tt>关系也有利于设定</tt><tt>‘</tt><tt>快捷方式</tt><tt>’</tt><tt>通过嵌套</tt><tt>has_many</tt><tt>关系。</tt>

class Document &lt; ActiveRecord::Base

has_many :sections

has_many :paragraphs, :through =&gt; :sections

end

&nbsp;

class Section &lt; ActiveRecord::Base

belongs_to :document

has_many :paragraphs

end

&nbsp;

class Paragraph &lt; ActiveRecord::Base

belongs_to :section

end

With <tt>:through</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:sections</tt> specified, Rails will now understand:因为<tt>:through</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:sections</tt><tt>被指定，</tt><tt>Rails</tt><tt>现在将会明白如下（语句）：</tt>

<code>@document.paragraphs</code>
<h4><a name="the-has_one-through-association"></a>2.5 The <tt>has_one</tt><tt> </tt><tt>:through</tt> Association</h4>
A <tt>has_one</tt><tt> </tt><tt>:through</tt> association sets up a one-to-one connection with another model. This association indicates that the declaring model can be matched with one instance of another model by proceeding <em>through</em> a third model. For example, if each supplier has one account, and each account is associated with one account history, then the customer model could look like this:

一个<tt>has_one</tt><tt> </tt><tt>:through</tt><tt>关系设定一个</tt><tt>one-to-one</tt><tt>连接到另一个模型。这个关系指明声明的模型可以匹配另个模型的一个实例通过第三个模型（中间模型）。例如，如果每个</tt><tt>supplier</tt><tt>（供应商）有一个</tt><tt>account</tt><tt>，并且每个</tt><tt>account</tt><tt>关联一个</tt><tt>account</tt><tt> </tt><tt>history</tt><tt>，那么</tt><tt>customer</tt><tt>模型将会像这样：</tt>

<tt>class</tt><tt> </tt><tt>Supplier</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>has_one</tt><tt> </tt><tt>:account</tt>

<tt> </tt><tt>has_one</tt><tt> </tt><tt>:account_history,</tt><tt> </tt><tt>:through</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:account</tt>

<tt>end</tt>

&nbsp;

<tt>class</tt><tt> </tt><tt>Account</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>belongs_to</tt><tt> </tt><tt>:supplier</tt>

<tt> </tt><tt>has_one</tt><tt> </tt><tt>:account_history</tt>

<tt>end</tt>

&nbsp;

<tt>class</tt><tt> </tt><tt>AccountHistory</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>belongs_to</tt><tt> </tt><tt>:account</tt>

<tt>end</tt>

&nbsp;
<h4><a name="the-has_and_belongs_to_many-association"></a> 2.6 The <tt>has_and_belongs_to_many</tt> Association</h4>
A <tt>has_and_belongs_to_many</tt> association creates a direct many-to-many connection with another model, with no intervening干预model. For example, if your application includes assemblies and parts, with each assembly having many parts and each part appearing in many assemblies, you could declare the models this way:

<tt>一个</tt><tt>has_and_belongs_to_many</tt><tt>关系创建一个直接的</tt><tt>many-to-many</tt><tt>连接到另一个模型，没有干扰模型。例如，如果你的应用程序包含</tt><tt>assemblies</tt><tt>和</tt><tt>parts</tt><tt>，其中每个</tt><tt>assembly</tt><tt>拥有多个</tt><tt>parts</tt><tt>并且每个</tt><tt>part</tt><tt>发生在多个集会中，你可以以这样的方式声明模型：</tt>

<tt>class</tt><tt> </tt><tt>Assembly</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>has_and_belongs_to_many</tt><tt> </tt><tt>:parts</tt>

<tt>end</tt>

&nbsp;

<tt>class</tt><tt> </tt><tt>Part</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>has_and_belongs_to_many</tt><tt> </tt><tt>:assemblies</tt>

<tt>end</tt>

&nbsp;
<h4><a name="choosing-between-belongs_to-and-has_one"></a> 2.7 Choosing Between <tt>belongs_to</tt> and <tt>has_one</tt></h4>
If you want to set up a 1–1 relationship between two models, you’ll need to add <tt>belongs_to</tt> to one, and <tt>has_one</tt> to the other. How do you know which is which?

如果你想在两个模型间设定一个1-1的关系，你将需要添加belongs_to到一个（模型中），以及<tt>has_one</tt><tt>到另一个（模型中）。你是怎么知道谁是谁的呢？</tt>

<tt>The</tt><tt> </tt><tt>distinction</tt><tt>区别</tt><tt>is</tt><tt> </tt><tt>in</tt><tt> </tt><tt>where</tt><tt> </tt><tt>you</tt><tt> </tt><tt>place</tt><tt> </tt><tt>the</tt><tt> </tt><tt>foreign</tt><tt> </tt><tt>key</tt><tt> </tt><tt>(it</tt><tt> </tt><tt>goes</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>table</tt><tt> </tt><tt>for</tt><tt> </tt><tt>the</tt><tt> </tt><tt>class</tt><tt> </tt><tt>declaring</tt><tt> </tt><tt>the</tt><tt> </tt><tt>belongs_to</tt><tt> </tt><tt>association),</tt><tt> </tt><tt>but</tt><tt> </tt><tt>you</tt><tt> </tt><tt>should</tt><tt> </tt><tt>give</tt><tt> </tt><tt>some</tt><tt> </tt><tt>thought</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>actual</tt><tt> </tt><tt>meaning</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>data</tt><tt> </tt><tt>as</tt><tt> </tt><tt>well.</tt><tt> </tt><tt><strong>The</strong></tt><tt><strong> </strong></tt><tt><strong>has_one</strong></tt><tt><strong> </strong></tt><tt><strong>relationship</strong></tt><tt><strong> </strong></tt><tt><strong>says</strong></tt><tt><strong> </strong></tt><tt><strong>that</strong></tt><tt><strong> </strong></tt><tt><strong>one</strong></tt><tt><strong> </strong></tt><tt><strong>of</strong></tt><tt><strong> </strong></tt><tt><strong>something</strong></tt><tt><strong> </strong></tt><tt><strong>is</strong></tt><tt><strong> </strong></tt><tt><strong>yours</strong></tt><tt><strong> – </strong></tt><tt><strong>that</strong></tt><tt><strong> </strong></tt><tt><strong>is,</strong></tt><tt><strong> </strong></tt><tt><strong>that</strong></tt><tt><strong> </strong></tt><tt><strong>something</strong></tt><tt><strong> </strong></tt><tt><strong>points</strong></tt><tt><strong> </strong></tt><tt><strong>back</strong></tt><tt><strong> </strong></tt><tt><strong>to</strong></tt><tt><strong> </strong></tt><tt><strong>you</strong></tt><tt>.</tt><tt> </tt><tt>For</tt><tt> </tt><tt>example,</tt><tt> </tt><tt>it</tt><tt> </tt><tt>makes</tt><tt> </tt><tt>more</tt><tt> </tt><tt>sense</tt><tt> </tt><tt>to</tt><tt> </tt><tt>say</tt><tt> </tt><tt>that</tt><tt> </tt><tt>a</tt><tt> </tt><tt>supplier</tt><tt> </tt><tt>owns</tt><tt> </tt><tt>an</tt><tt> </tt><tt>account</tt><tt> </tt><tt>than</tt><tt> </tt><tt>that</tt><tt> </tt><tt>an</tt><tt> </tt><tt>account</tt><tt> </tt><tt>owns</tt><tt> </tt><tt>a</tt><tt> </tt><tt>supplier.</tt><tt> </tt><tt>This</tt><tt> </tt><tt>suggests</tt><tt> </tt><tt>that</tt><tt> </tt><tt>the</tt><tt> </tt><tt>correct</tt><tt> </tt><tt>relationships</tt><tt> </tt><tt>are</tt><tt> </tt><tt>like</tt><tt> </tt><tt>this:</tt>

class Supplier &lt; ActiveRecord::Base

has_one :account

end

&nbsp;

class Account &lt; ActiveRecord::Base

belongs_to :supplier

end

The corresponding migration might look like this:

class CreateSuppliers &lt; ActiveRecord::Migration

def change

create_table :suppliers do |t|

t.string :name

t.timestamps

end

&nbsp;

create_table :accounts do |t|

t.integer :supplier_id

t.string :account_number

t.timestamps

end

end

end

<em>Using</em><em> </em><tt><em>t.integer</em></tt><tt><em> </em></tt><tt><em>:supplier_id</em></tt><em> </em><em>makes</em><em> </em><em>the</em><em> </em><em>foreign</em><em> </em><em>key</em><em> </em><em>naming</em><em> </em><em>obvious</em><em> </em><em>and</em><em> </em><em>explicit.</em><em> </em><em>In</em><em> </em><em>current</em><em> </em><em>versions</em><em> </em><em>of</em><em> </em><em>Rails,</em><em> </em><em>you</em><em> </em><em>can</em><em> </em><em>abstract</em><em> </em><em>away</em><em> </em><em>this</em><em> </em><em>implementation</em><em> </em><em>detail</em><em> </em><em>by</em><em> </em><em>using</em><em> </em><tt><em>t.references</em></tt><tt><em> </em></tt><tt><em>:supplier</em></tt><em> </em><em>instead.</em><em>使用</em><tt><em>t.integer</em></tt><tt><em> </em></tt><tt><em>:supplier_id</em></tt><tt><em>使得外建命名明显和精确。在当前版本的</em></tt><tt><em>Rails</em></tt><tt><em>，你可以抽象掉这个实施细节通过使用</em></tt><tt><em>t.references</em></tt><tt><em> </em></tt><tt><em>:supplier</em></tt><tt><em>替代。</em></tt>
<h4><a name="choosing-between-has_many-through-and-ha"></a> 2.8 Choosing Between <tt>has_many</tt><tt> </tt><tt>:through</tt> and <tt>has_and_belongs_to_many</tt></h4>
Rails offers two different ways to declare a many-to-many relationship between models. The simpler way is to use <tt>has_and_belongs_to_many</tt>, which allows you to make the association directly:

Rails提供了两种不同的方式来声明一个模型间的many-to-many关系。比较简单的方式使用<tt>has_and_belongs_to_many</tt><tt>，它允许你直接的（创建）关系：</tt>

class Assembly &lt; ActiveRecord::Base

has_and_belongs_to_many :parts

end

&nbsp;

class Part &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies

end

The second way to declare a many-to-many relationship is to use <tt>has_many</tt><tt> </tt><tt>:through</tt>. This makes the association indirectly, through a join model:

第二种方式是声明一个many-to-many关系使用<tt>has_many</tt><tt> </tt><tt>:through</tt><tt>，它可以使得关系间接的，同加入一个模型：</tt>

class Assembly &lt; ActiveRecord::Base

has_many :manifests

has_many :parts, :through =&gt; :manifests

end

&nbsp;

class Manifest &lt; ActiveRecord::Base

belongs_to :assembly

belongs_to :part

end

&nbsp;

class Part &lt; ActiveRecord::Base

has_many :manifests

has_many :assemblies, :through =&gt; :manifests

end

The simplest rule of thumb is that you should set up a <tt>has_many</tt><tt> </tt><tt>:through</tt> relationship if you need to work with the relationship model as an independent entity实体.If you don’t need to do anything with the relationship model, it may be simpler to set up a <tt>has_and_belongs_to_many</tt> relationship (though you’ll need to remember to create the joining table in the database).最简单的使用规则是，如果你需要使用关系模型作为依赖实体来工作你应该设定一个<tt>has_many</tt><tt> </tt><tt>:through</tt><tt>关系</tt>。

<strong>You</strong><strong> </strong><strong>should</strong><strong> </strong><strong>use</strong><strong> </strong><tt><strong>has_many</strong></tt><tt><strong>:through</strong></tt><strong> </strong><strong>if</strong><strong> </strong><strong>you</strong><strong> </strong><strong>need</strong><strong> </strong><strong>validations,</strong><strong> </strong><strong>callbacks,</strong><strong> </strong><strong>or</strong><strong> </strong><strong>extra</strong><strong> </strong><strong>attributes</strong><strong> </strong><strong>on</strong><strong> </strong><strong>the</strong><strong> </strong><strong>join</strong><strong> </strong><strong>model.</strong>
<h4><a name="polymorphic-associations"></a>2.9 Polymorphic Associations多元关系</h4>
A slightly more advanced twist on associations is the <em>polymorphic</em><em> </em><em>association</em>.一个略微先进的关系枢纽是多元关系。With polymorphic associations, a model can belong to more than one other model, on a single association. 通过多态关系，（在单个关系中）一个模型可以属于超过一个其他的模型。For example, you might have a picture model that belongs to either an employee model or a product model. Here’s how this could be declared:例如，你可能有一个picture模型属于一个employee或者一个product模型。这是它们如何被定义的：

class Picture &lt; ActiveRecord::Base

belongs_to :imageable, :polymorphic =&gt; true

end

&nbsp;

class Employee &lt; ActiveRecord::Base

has_many :pictures, :as =&gt; :imageable

end

&nbsp;

class Product &lt; ActiveRecord::Base

has_many :pictures, :as =&gt; :imageable

end

You can think of a polymorphic <tt>belongs_to</tt> declaration as setting up an interface that any other model can use. From an instance of the <tt>Employee</tt> model, you can retrieve a collection of pictures: <tt>@employee.pictures</tt>.

你可以认为一个多元<tt>belongs_to</tt><tt>声明相当于设定一个其它任何模型可以使用的接口。来源于</tt><tt>Employee</tt><tt>模型的实例，你可以检索一个</tt><tt>pictures</tt><tt>的集合：</tt><tt>@employee.pictures</tt><tt>。</tt>

Similarly, you can retrieve <tt>@product.pictures</tt>.相近的，你可以检索<tt>@product.pictures</tt><tt>。</tt>

If you have an instance of the <tt>Picture</tt> model, you can get to its parent via <tt>@picture.imageable</tt>. To make this work, you need to declare both a foreign key column and a type column in the model that declares the polymorphic interface:如果你有一个Picture模型的实例，你可以得到它的父模型通过<tt>@picture.imageable</tt><tt>。要使这些工作，你需要声明一个外键字段和一个什么多元（关系）的接口的字段：</tt>

<tt>class</tt><tt> </tt><tt>CreatePictures</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Migration</tt>

<tt> </tt><tt>def</tt><tt> </tt><tt>change</tt>

<tt> </tt><tt>create_table</tt><tt> </tt><tt>:pictures</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|t|</tt>

<tt> </tt><tt>t.string</tt><tt> </tt><tt>:name</tt>

<tt> </tt><tt>t.integer</tt><tt> </tt><tt>:imageable_id</tt>

<tt> </tt><tt>t.string</tt><tt> </tt><tt>:imageable_type</tt>

<tt> </tt><tt>t.timestamps</tt>

<tt> </tt><tt>end</tt>

<tt> </tt><tt>end</tt>

<tt>end</tt>

<tt>This</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>can</tt><tt> </tt><tt>be</tt><tt> </tt><tt>simplified</tt><tt> </tt><tt>by</tt><tt> </tt><tt>using</tt><tt> </tt><tt>the</tt><tt> </tt><tt>t.references</tt><tt> </tt><tt>form:</tt><tt>这个</tt><tt>migration</tt><tt>可以通过</tt><tt>t.references</tt><tt>形式简洁的（声明）：</tt>

<tt>class</tt><tt> </tt><tt>CreatePictures</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Migration</tt>

<tt> </tt><tt>def</tt><tt> </tt><tt>change</tt>

<tt> </tt><tt>create_table</tt><tt> </tt><tt>:pictures</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|t|</tt>

<tt> </tt><tt>t.string</tt><tt> </tt><tt>:name</tt>

<tt> </tt><tt>t.references</tt><tt> </tt><tt>:imageable,</tt><tt> </tt><tt>:polymorphic</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>

<tt> </tt><tt>t.timestamps</tt>

<tt> </tt><tt>end</tt>

<tt> </tt><tt>end</tt>

<tt>end</tt>
<h4><a name="self-joins"></a><tt>2.10</tt><tt> </tt><tt>Self</tt><tt> </tt><tt>Joins</tt></h4>
In designing a data model, you will sometimes find a model that should have a relation to itself. For example, you may want to store all employees in a single database model, but be able to trace relationships such as between manager and subordinates. This situation can be modeled with self-joining associations:在数据库设计中，有时你会发现一个模型具有一个（关联）到它自己的关系例如，你可能希望保存所有的employees在单个数据库模型中，但是能够跟踪关系比如在manager和subordinates之间。这个情况可以设定self-joining模型：

<tt>class</tt><tt> </tt><tt>Employee</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>has_many</tt><tt> </tt><tt>:subordinates,</tt><tt> </tt><tt>:class_name</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&#8220;Employee&#8221;</tt>

<tt> </tt><tt>belongs_to</tt><tt> </tt><tt>:manager,</tt><tt> </tt><tt>:class_name</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&#8220;Employee&#8221;,</tt>

<tt> </tt><tt>:foreign_key</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&#8220;manager_id&#8221;</tt>

<tt>end</tt>

<tt>With</tt><tt> </tt><tt>this</tt><tt> </tt><tt>setup,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>retrieve</tt><tt> </tt><tt>@employee.subordinates</tt><tt> </tt><tt>and</tt><tt> </tt><tt>@employee.manager.</tt><tt>通过这个设定，你可以检索</tt><tt>@employee.subordinates</tt><tt> </tt><tt>and</tt><tt> </tt><tt>@employee.manager</tt><tt>。</tt>
<h3><a name="tips-tricks-and-warnings"></a><tt>3</tt><tt> </tt><tt>Tips</tt><tt>提示</tt><tt>,</tt><tt> </tt><tt>Tricks</tt><tt>窍门</tt><tt>,</tt><tt> </tt><tt>and</tt><tt> </tt><tt>Warnings</tt><tt>警告</tt></h3>
Here are a few things you should know to make efficient use of Active Record associations in your Rails applications:这里有一些事情你应该知道（它）使得在你的Rails应用程序使用Active Record关系变得高效：
<ul>
    <li><tt>Controlling</tt><tt>caching</tt><tt>控制缓存</tt></li>
    <li>Avoidingnamecollisions避免名称碰撞</li>
    <li>Updating the schema 更新结构</li>
    <li>Controlling association scope 控制关系范围</li>
</ul>
<h4><a name="controlling-caching"></a><tt>3.1</tt><tt> </tt><tt>Controlling</tt><tt> </tt><tt>Caching</tt></h4>
<a name="result_box"></a>All of the association methods are built around caching, which keeps the result of the most recent query available for further operations. The cache is even shared across methods. For example:所有的关系方法都创建在缓存周围，这使的最近的查询，可用于进一步的操作的结果。

customer.orders # retrieves orders from the database

customer.orders.size # uses the cached copy of orders

customer.orders.empty? # uses the cached copy of orders

But what if you want to reload the cache, because data might have been changed by some other part of the application? Just pass <tt>true</tt> to the association call:但是如果你想重载cache，因为数据可能被应用程序的其他部分改变？仅仅通过添加投入额到关系调用：

customer.orders # retrieves orders from the database

customer.orders.size # uses the cached copy of orders

customer.orders(true).empty? # discards the cached copy of orders

# and goes back to the database
<h4><a name="avoiding-name-collisions"></a><tt>3.2</tt><tt> </tt><tt>Avoiding</tt><tt> </tt><tt>Name</tt><tt> </tt><tt>Collisions</tt><tt>避免名称碰撞</tt></h4>
<tt>You</tt><tt> </tt><tt>are</tt><tt> </tt><tt>not</tt><tt> </tt><tt>free</tt><tt> </tt><tt>to</tt><tt> </tt><tt>use</tt><tt> </tt><tt>just</tt><tt> </tt><tt>any</tt><tt> </tt><tt>name</tt><tt> </tt><tt>for</tt><tt> </tt><tt>your</tt><tt> </tt><tt>associations.</tt><tt> </tt><tt>Because</tt><tt> </tt><tt>creating</tt><tt> </tt><tt>an</tt><tt> </tt><tt>association</tt><tt> </tt><tt>adds</tt><tt> </tt><tt>a</tt><tt> </tt><tt>method</tt><tt> </tt><tt>with</tt><tt> </tt><tt>that</tt><tt> </tt><tt>name</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>model,</tt><tt> </tt><tt>it</tt><tt> </tt><tt>is</tt><tt> </tt><tt>a</tt><tt> </tt><tt>bad</tt><tt> </tt><tt>idea</tt><tt> </tt><tt>to</tt><tt> </tt><tt>give</tt><tt> </tt><tt>an</tt><tt> </tt><tt>association</tt><tt> </tt><tt>a</tt><tt> </tt><tt>name</tt><tt> </tt><tt>that</tt><tt> </tt><tt>is</tt><tt> </tt><tt>already</tt><tt> </tt><tt>used</tt><tt> </tt><tt>for</tt><tt> </tt><tt>an</tt><tt> </tt><tt>instance</tt><tt> </tt><tt>method</tt><tt> </tt><tt>of</tt><tt> </tt><tt>ActiveRecord::Base.</tt><tt> </tt><tt>The</tt><tt> </tt><tt>association</tt><tt> </tt><tt>method</tt><tt> </tt><tt>would</tt><tt> </tt><tt>override</tt><tt> </tt><tt>the</tt><tt> </tt><tt>base</tt><tt> </tt><tt>method</tt><tt> </tt><tt>and</tt><tt> </tt><tt>break</tt><tt> </tt><tt>things.</tt><tt> </tt><tt>For</tt><tt> </tt><tt>instance,</tt><tt> </tt><tt>attributes</tt><tt> </tt><tt>or</tt><tt> </tt><tt>connection</tt><tt> </tt><tt>are</tt><tt> </tt><tt>bad</tt><tt> </tt><tt>names</tt><tt> </tt><tt>for</tt><tt> </tt><tt>associations.</tt>

<tt>你不能不限制的给你的关系使用任何名字。因为创建一个关系添加一个方法和你命名的名字到模型，给一个关系取一个在</tt><tt>ActiveRecord::Base</tt><tt>实例方法中已经使用了的方法不是个好主意。这个关系方法将会覆盖原有方法和打断事情。比如实例，</tt><tt>attributes</tt><tt> </tt><tt>or</tt><tt> </tt><tt>connection</tt><tt>是关系的坏名称。</tt>
<h4><a name="updating-the-schema"></a><tt>3.3</tt><tt> </tt><tt>Updating</tt><tt> </tt><tt>the</tt><tt> </tt><tt>Schema</tt></h4>
Associations are extremely useful, but they are not magic. You are responsible for maintaining your database schema to match your associations. In practice, this means two things, depending on what sort of associations you are creating. For <tt>belongs_to</tt> associations you need to create foreign keys, and for <tt>has_and_belongs_to_many</tt> associations you need to create the appropriate join table.

<tt>关系相当有用，但是它们不是魔法。你有责任注意你的数据库结构和你的关系的匹配。在实际中，这意味这两件事，依赖于你创建的何种关系。对于</tt><tt>belongs_to</tt><tt>关系你需要创建外键，对应</tt><tt>has_and_belongs_to_many</tt><tt>关系你需要创建适当的（关系）加入表中。</tt>
<h5><a name="creating-foreign-keys-for-belongs_to-ass"></a> <tt>3.3.1</tt><tt> </tt><tt>Creating</tt><tt> </tt><tt>Foreign</tt><tt> </tt><tt>Keys</tt><tt> </tt><tt>for</tt><tt> </tt><tt>belongs_to</tt><tt> </tt><tt>Associations</tt></h5>
When you declare a <tt>belongs_to</tt> association, you need to create foreign keys as appropriate. For example, consider this model:当你声明一个<tt>belongs_to</tt><tt>关系，你需要创建一个外键（作为合适的方式来更新数据结构）。例如，思考如下模型：</tt>

<tt>class</tt><tt> </tt><tt>Order</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Base</tt>

<tt> </tt><tt>belongs_to</tt><tt> </tt><tt>:customer</tt>

<tt>end</tt>

<tt>This</tt><tt> </tt><tt>declaration</tt><tt> </tt><tt>needs</tt><tt> </tt><tt>to</tt><tt> </tt><tt>be</tt><tt> </tt><tt>backed</tt><tt> </tt><tt>up</tt><tt> </tt><tt>by</tt><tt> </tt><tt>the</tt><tt> </tt><tt>proper</tt><tt> </tt><tt>foreign</tt><tt> </tt><tt>key</tt><tt> </tt><tt>declaration</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>orders</tt><tt> </tt><tt>table:</tt><tt>这个声明需要通过在生产者表单声明适当的外键备份。</tt>

<tt>class</tt><tt> </tt><tt>CreateOrders</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ActiveRecord::Migration</tt>

<tt> </tt><tt>def</tt><tt> </tt><tt>change</tt>

<tt> </tt><tt>create_table</tt><tt> </tt><tt>:orders</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|t|</tt>

<tt> </tt><tt>t.datetime</tt><tt> </tt><tt>:order_date</tt>

<tt> </tt><tt>t.string</tt><tt> </tt><tt>:order_number</tt>

<tt> </tt><tt>t.integer</tt><tt> </tt><tt>:customer_id</tt>

<tt> </tt><tt>end</tt>

<tt> </tt><tt>end</tt>

<tt>end</tt>

If you create an association some time after you build the underlying底层model, you need to remember to create an <tt>add_column</tt> migration to provide the necessary foreign key.<strong>有时你创建的关系在你创建的底层模型之后，你需要记住创建一个</strong><strong>add_column</strong><strong> </strong><strong>migration</strong><strong>提供必须的外键。</strong>

&nbsp;

&nbsp;
<h5><a name="creating-join-tables-for-has_and_belongs"></a> 3.3.2 Creating Join Tables for <tt>has_and_belongs_to_many</tt> Associations</h5>
If you create a <tt>has_and_belongs_to_many</tt> association, you need to explicitly create the joining table. Unless the name of the join table is explicitly specified by using the <tt>:join_table</tt> option, Active Record creates the name by using the lexical order of the class names. So a join between customer and order models will give the default join table name of “customers_orders” because “c” outranks “o” in lexical ordering.

如果你创建了一个<tt>has_and_belongs_to_many</tt><tt>关系，你需要准确的创建</tt><tt>joining</tt><tt>表单。除非</tt><tt>join</tt><tt>表单使用</tt><tt>:join_table</tt><tt>选项准确的指定，（否则）</tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt>就会使用类名提供的的词汇创建表单名称。因此一个在</tt><tt>customer</tt><tt>和</tt><tt>order</tt><tt>模型之间</tt><tt>join</tt><tt>（的表单）将会默认插入表名</tt><tt>“</tt><tt>customers_orders</tt><tt>”</tt><tt>因为</tt><tt>‘</tt><tt>c</tt><tt>’</tt><tt>在</tt><tt>‘</tt><tt>o</tt><tt>’</tt><tt>前面在提供的词汇中。</tt>

The precedence优先between model names is calculated using the <tt><strong>&lt;</strong></tt><strong> </strong><strong>operator</strong><strong> </strong><strong>for</strong><strong> </strong><tt><strong>String</strong></tt>. This means that if the strings are of different lengths, and the strings are equal when compared up to the shortest length, then the longer string is considered of higher lexical precedence than the shorter one. For example, one would expect the tables “<strong>paper</strong><strong>_</strong>boxes” and “<strong>paper</strong><strong>s</strong>” to generate a join table name of “papers_paper_boxes” because of the length of the name “paper_boxes”, but it in fact generates a join table name of “paper_boxes_papers” (because the underscore ‘_’ is lexicographically字典<em>less</em> than ‘s’ in common encodings).

Whatever the name, you must manually手动generate the join table with an appropriate migration. For example, consider these associations:

class Assembly &lt; ActiveRecord::Base

has_and_belongs_to_many :parts

end

&nbsp;

class Part &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies

end

These need to be backed up by a migration to create the <tt>assemblies_parts</tt> table. This table should be created without a primary key:

class CreateAssemblyPartJoinTable &lt; ActiveRecord::Migration

def change

create_table :assemblies_parts, :<strong>id</strong><strong> </strong><strong>=&gt;</strong><strong> </strong><strong>false</strong> do |t|

t.integer :assembly_id

t.integer :part_id

end

end

end

We pass <tt>:id</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>false</tt> to <tt>create_table</tt> because that table does not represent表示a model. That’s required for the association to work properly. If you observe观察any strange behavior in a <tt>has_and_belongs_to_many</tt> association like mangled错误models IDs, or exceptions about conflicting IDs chances are you forgot that bit.
<h4><a name="controlling-association-scope"></a>3.4 Controlling Association Scope控制关系范围</h4>
By default, associations look for objects only within the current module’s scope. This can be important when you declare Active Record models within a module. For example:默认情况，（通过）关系查找对象仅仅在当前模型范围中。这很重要点你在一个module中声明Active Record models例如：

module MyApplication

module Business

class Supplier &lt; ActiveRecord::Base

has_one :account

end

&nbsp;

class Account &lt; ActiveRecord::Base

belongs_to :supplier

end

end

end

This will work fine, because both the <tt>Supplier</tt> and the <tt>Account</tt> class are defined within the same scope.<strong> </strong><strong>But</strong><strong> </strong><strong>the</strong><strong> </strong><strong>following</strong><strong> </strong><strong>will</strong><strong> </strong><em><strong>not</strong></em><strong> </strong><strong>work,</strong><strong> </strong><strong>because</strong><strong> </strong><tt><strong>Supplier</strong></tt><strong> </strong><strong>and</strong><strong> </strong><tt><strong>Account</strong></tt><strong> </strong><strong>are</strong><strong> </strong><strong>defined</strong><strong> </strong><strong>in</strong><strong> </strong><strong>different</strong><strong> </strong><strong>scopes:</strong>

module MyApplication

module Business

class Supplier &lt; ActiveRecord::Base

has_one :account

end

end

&nbsp;

module Billing

class Account &lt; ActiveRecord::Base

belongs_to :supplier

end

end

end

<strong>To</strong><strong> </strong><strong>associate</strong><strong> </strong><strong>a</strong><strong> </strong><strong>model</strong><strong> </strong><strong>with</strong><strong> </strong><strong>a</strong><strong> </strong><strong>model</strong><strong> </strong><strong>in</strong><strong> </strong><strong>a</strong><strong> </strong><strong>different</strong><strong> </strong><strong>namespace,</strong><strong> </strong><strong>you</strong><strong> </strong><strong>must</strong><strong> </strong><strong>specify</strong><strong> </strong><strong>the</strong><strong> </strong><strong>complete</strong><strong> </strong><strong>class</strong><strong> </strong><strong>name</strong><strong> </strong><strong>in</strong><strong> </strong><strong>your</strong><strong> </strong><strong>association</strong><strong> </strong><strong>declaration</strong>:

module MyApplication

module Business

class Supplier &lt; ActiveRecord::Base

has_one :account,

:class_name =&gt; &#8220;MyApplication::Billing::Account&#8221;

end

end

&nbsp;

module Billing

class Account &lt; ActiveRecord::Base

belongs_to :supplier,

:class_name =&gt; &#8220;MyApplication::Business::Supplier&#8221;

end

end

end
<h3><a name="detailed-association-reference"></a>4 Detailed Association Reference具体关系参考</h3>
The following sections give the details of each type of association, including the methods that they add and the options that you can use when declaring an association.接下来的部分给出了每种关系的具体的介绍，包含当你声明一个关系时可以使用的（这些关系）添加的方法和选项。
<h5><a name="methods-added-by-belongs_to"></a>4.1.1 Methods Added by <tt>belongs_to</tt></h5>
When you declare a <tt>belongs_to</tt> association, the declaring class automatically gains受益four methods related to the association:
<ul>
    <li><em>association</em><tt>(force_reload</tt><tt> </tt><tt>=</tt><tt> </tt><tt>false)</tt><em> </em></li>
    <li><em>association</em><tt>=(associate)</tt></li>
    <li><tt>build_</tt><em>association</em><tt>(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></li>
    <li><tt>create_</tt><em>association</em><tt>(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></li>
</ul>
In all of these methods, <em>association</em> is replaced with the symbol passed as the first argument to <tt>belongs_to</tt>. For example, given the declaration:

class Order &lt; ActiveRecord::Base

belongs_to :customer

end

Each instance of the order model生产者模型will have these methods:

<code>customer</code>

<code>customer=</code>

<code>build_customer</code>

<code>create_customer</code>

&nbsp;

When initializing a new <tt>has_one</tt> or <tt>belongs_to</tt> association you must use the <tt>build_</tt> prefix构造前缀to build the association, rather than the <tt>association.</tt><tt> </tt><tt>build</tt> method that would be used for <tt>has_many</tt> or <tt>has_and_belongs_to_many</tt> associations. To create one, use the <tt>create_</tt> prefix新建前缀.
<h6><a name="belongs_to-association"></a>4.1.1.1 <em>association</em><tt>(force_reload</tt><tt> </tt><tt>=</tt><tt> </tt><tt>false)</tt></h6>
<strong>The</strong><strong> </strong><em><strong>association</strong></em><strong> </strong><strong>method</strong><strong> </strong><strong>returns</strong><strong> </strong><strong>the</strong><strong> </strong><strong>associated</strong><strong> </strong><strong>object,</strong> if any. If no associated object is found, it <strong>returns</strong><strong> </strong><tt><strong>nil</strong></tt>.

@customer = @order.customer

If the associated object has already been retrieved检索from the database for this object, the cached version will be returned. <strong>To</strong><strong> </strong><strong>override</strong><strong> </strong><strong>this</strong><strong> </strong><strong>behavior</strong><strong> </strong><strong>(and</strong><strong> </strong><strong>force</strong><strong> </strong><strong>a</strong><strong> </strong><strong>database</strong><strong> </strong><strong>read),</strong><strong> </strong><strong>pass</strong><strong> </strong><tt><strong>true</strong></tt><strong> </strong><strong>as</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>force_reload</strong></tt><strong> </strong><strong>argument.</strong>
<h6><a name="belongs_to-association_equal"></a>4.1.1.2 <em>association</em><tt>=(associate)</tt></h6>
<strong>The</strong><strong> </strong><em><strong>association</strong></em><tt><strong>=</strong></tt><strong> </strong><strong>method</strong><strong> </strong><strong>assigns</strong><strong> </strong><strong>an</strong><strong> </strong><strong>associated</strong><strong> </strong><strong>object</strong><strong> </strong><strong>to</strong><strong> </strong><strong>this</strong><strong> </strong><strong>object.</strong> Behind the scenes, this means <strong>extracting</strong><strong> </strong><strong>the</strong><strong> </strong><strong>primary</strong><strong> </strong><strong>key</strong><strong> </strong><strong>from</strong><strong> </strong><strong>the</strong><strong> </strong><strong>associate</strong><strong> </strong><strong>object</strong><strong> </strong><strong>and</strong><strong> </strong><strong>setting</strong><strong> </strong><strong>this</strong><strong> </strong><strong>object</strong><strong>’</strong><strong>s</strong><strong> </strong><strong>foreign</strong><strong> </strong><strong>key</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><strong>same</strong><strong> </strong><strong>value.</strong>

@order.customer = @customer
<h6><a name="belongs_to-build_association"></a>4.1.1.3 <tt>build_</tt><em>association</em><tt>(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></h6>
The <tt>build_</tt><em>association</em> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through this object’s foreign key will be set, but the associated object will <em>not</em> yet be saved.

@customer = @order.build_customer(:customer_number =&gt; 123,

:customer_name =&gt; &#8220;John Doe&#8221;)
<h6><a name="belongs_to-create_association"></a>4.1.1.4 <tt>create_</tt><em>association</em><tt>(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></h6>
The <tt>create_</tt><em>association</em> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through this object’s foreign key will be set. In addition, the associated object <em>will</em> be saved (assuming that it passes any validations).

@customer = @order.create_customer(:customer_number =&gt; 123,

:customer_name =&gt; &#8220;John Doe&#8221;)
<h5><a name="options-for-belongs_to"></a>4.1.2 Options for <tt>belongs_to</tt></h5>
In many situations, you can use the default behavior of <tt>belongs_to</tt> without any customization. But despite尽管Rails’ emphasis强调of convention公约over customization, you can alter that behavior in a number of ways. This section covers the options that you can pass when you create a <tt>belongs_to</tt> association. For example, an association with several options might look like this:

class Order &lt; ActiveRecord::Base

belongs_to :customer, :counter_cache =&gt; true,

:conditions =&gt; &#8220;active = 1&#8221;

end

The <tt>belongs_to</tt> association supports these options:
<ul>
    <li><tt>:autosave</tt></li>
    <li><tt>:class_name</tt></li>
    <li><tt>:conditions</tt> 条件</li>
    <li><tt>:counter_cache</tt></li>
    <li><tt>:dependent</tt></li>
    <li><tt>:foreign_key</tt></li>
    <li><tt>:include</tt></li>
    <li><tt>:polymorphic</tt> 多元</li>
    <li><tt>:readonly</tt></li>
    <li><tt>:select</tt></li>
    <li><tt>:touch</tt></li>
    <li><tt>:validate</tt></li>
</ul>
<h6><a name="belongs_to-autosave"></a>4.1.2.1 <tt>:autosave</tt></h6>
If you set the <tt>:autosave</tt> option to <tt>true</tt>, Rails will save any loaded members and destroy members that are marked for destruction whenever you save the parent object.
<h6><a name="belongs_to-class_name"></a>4.1.2.2 <tt>:class_name</tt></h6>
If the name of the other model cannot be derived from the association name, you can use the <tt>:class_name</tt> option to supply the model name. For example, if an order belongs to a customer, but the actual name of the model containing customers is <tt>Patron</tt>, you’d set things up this way:
<h6><a name="belongs_to-conditions"></a>4.1.2.3 <tt>:conditions</tt></h6>
The <tt>:conditions</tt> option lets you specify the conditions that the associated object must meet (in the syntax used by an SQL <tt>WHERE</tt> clause).

class Order &lt; ActiveRecord::Base

belongs_to :customer, :conditions =&gt; &#8220;active = 1&#8221;

end
<h6><a name="belongs_to-counter_cache"></a>4.1.2.4 <tt>:counter_cache</tt></h6>
The <tt>:counter_cache</tt> option can be used to make finding the number of belonging objects more efficient. Consider these models:

class Order &lt; ActiveRecord::Base

belongs_to :customer

end

class Customer &lt; ActiveRecord::Base

has_many :orders

end

With these declarations, asking for the value of <tt>@customer.orders.size</tt> requires making a call to the database to perform a <tt>COUNT(*)</tt> query. To avoid this call, you can add a counter cache to the <em>belonging</em> model:

class Order &lt; ActiveRecord::Base

belongs_to :customer, :counter_cache =&gt; true

end

class Customer &lt; ActiveRecord::Base

has_many :orders

end

<strong>With</strong><strong> </strong><strong>this</strong><strong> </strong><strong>declaration,</strong><strong> </strong><strong>Rails</strong><strong> </strong><strong>will</strong><strong> </strong><strong>keep</strong><strong> </strong><strong>the</strong><strong> </strong><strong>cache</strong><strong> </strong><strong>value</strong><strong> </strong><strong>up</strong><strong> </strong><strong>to</strong><strong> </strong><strong>date,</strong><strong> </strong><strong>and</strong><strong> </strong><strong>then</strong><strong> </strong><strong>return</strong><strong> </strong><strong>that</strong><strong> </strong><strong>value</strong><strong> </strong><strong>in</strong><strong> </strong><strong>response</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>size</strong></tt><strong> </strong><strong>method.</strong>

Although the <tt>:counter_cache</tt> option is specified on the model that includes the <tt>belongs_to</tt> declaration, the actual column must be added to the <em>associated</em> model. In the case above, you would need to add a column named <tt>orders_count</tt> to the <tt>Customer</tt> model. You can override the default column name if you need to:

class Order &lt; ActiveRecord::Base

belongs_to :customer, :counter_cache =&gt; :count_of_orders

end

class Customer &lt; ActiveRecord::Base

has_many :orders

end

Counter cache columns are added to the containing model’s list of read-only attributes through <tt>attr_readonly</tt>.
<h6><a name="belongs_to-dependent"></a>4.1.2.5 <tt>:dependent</tt></h6>
<strong>If</strong><strong> </strong><strong>you</strong><strong> </strong><strong>set</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:dependent</strong></tt><strong> </strong><strong>option</strong><strong> </strong><strong>to</strong><strong> </strong><tt><strong>:destroy</strong></tt><strong>,</strong><strong> </strong><strong>then</strong><strong> </strong><strong>deleting</strong><strong> </strong><strong>this</strong><strong> </strong><strong>object</strong><strong> </strong><strong>will</strong><strong> </strong><strong>call</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>destroy</strong></tt><strong> </strong><strong>method</strong><strong> </strong><strong>on</strong><strong> </strong><strong>the</strong><strong> </strong><strong>associated</strong><strong> </strong><strong>object</strong><strong> </strong><strong>to</strong><strong> </strong><strong>delete</strong><strong> </strong><strong>that</strong><strong> </strong><strong>object.</strong><strong> </strong>If <strong>you</strong><strong> </strong><strong>set</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:dependent</strong></tt><strong> </strong><strong>option</strong><strong> </strong><strong>to</strong><strong> </strong><tt><strong>:delete</strong></tt><strong>,</strong><strong> </strong><strong>then</strong><strong> </strong><strong>deleting</strong><strong> </strong><strong>this</strong><strong> </strong><strong>object</strong><strong> </strong><strong>will</strong><strong> </strong><strong>delete</strong><strong> </strong><strong>the</strong><strong> </strong><strong>associated</strong><strong> </strong><strong>object</strong><strong> </strong><em><strong>without</strong></em><strong> </strong><strong>calling</strong><strong> </strong><strong>its</strong><strong> </strong><tt><strong>destroy</strong></tt><strong> </strong><strong>method</strong>.

You should not specify this option on a <tt>belongs_to</tt> association that is connected with a <tt>has_many</tt> association on the other class. Doing so can lead to orphaned records in your database.对应多个的话用了dependent的话删除一个和他的外键的话其他关联就失效了
<h6><a name="belongs_to-foreign_key"></a>4.1.2.6 <tt>:foreign_key</tt></h6>
By convention约定, Rails guesses that the column used to hold the foreign key on this model is the name of the association with the suffix <tt>_id</tt> added. The <tt>:foreign_key</tt> option lets you set the name of the foreign key directly:

class Order &lt; ActiveRecord::Base

belongs_to :customer, :class_name =&gt; &#8220;Patron&#8221;,

:foreign_key =&gt; &#8220;patron_id&#8221;

end

In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.
<h6><a name="belongs_to-includes"></a>4.1.2.7 <tt>:include</tt></h6>
You can use the <tt>:include</tt> option to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:

class LineItem &lt; ActiveRecord::Base

belongs_to :order

end

&nbsp;

class Order &lt; ActiveRecord::Base

belongs_to :customer

has_many :line_items

end

&nbsp;

class Customer &lt; ActiveRecord::Base

has_many :orders

end

If you frequently retrieve customers directly from line items (<tt>@line_item.order.customer</tt>), then you can make your code somewhat more efficient by including customers in the association from line items to orders:如果你频繁的从line_item（<tt>@line_item.order.customer</tt>）直接检索，那么你可以在line_item关系中包含customers，使得你的代码变得更加有效率：

class LineItem &lt; ActiveRecord::Base

belongs_to :order, :include =&gt; :customer

end

&nbsp;

class Order &lt; ActiveRecord::Base

belongs_to :customer

has_many :line_items

end

&nbsp;

class Customer &lt; ActiveRecord::Base

has_many :orders

end

There’s no need to use <tt>:include</tt> for immediate立即（直接）associations – that is, if you have <tt>Order</tt><tt> </tt><tt>belongs_to</tt><tt> </tt><tt>:customer</tt>, then the customer is eager-loaded automatically when it’s needed.
<h6><a name="belongs_to-polymorphic"></a>4.1.2.8 <tt>:polymorphic</tt></h6>
Passing <tt>true</tt> to the <tt>:polymorphic</tt> option indicates that this is a polymorphic association. Polymorphic associations were discussed in detail <a href="http://guides.rubyonrails.org/association_basics.html#polymorphic-associations">earlierinthisguide</a>.
<h6><a name="belongs_to-readonly"></a>4.1.2.9 <tt>:readonly</tt></h6>
If you set the <tt>:readonly</tt> option to <tt>true</tt>, then the associated object will be read-only when retrieved via the association.
<h6><a name="belongs_to-select"></a>4.1.2.10 <tt>:select</tt></h6>
The <tt>:select</tt> option lets you override the SQL <tt>SELECT</tt> clause that is used to retrieve data about the associated object. By default, Rails retrieves all columns.

If you set the <tt>:select</tt> option on a <tt>belongs_to</tt> association, you should also set the <tt>foreign_key</tt> option to guarantee保证the correct results.
<h6><a name="belongs_to-touch"></a>4.1.2.11 <tt>:touch</tt></h6>
<strong>If</strong><strong> </strong><strong>you</strong><strong> </strong><strong>set</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:touch</strong></tt><strong> </strong><strong>option</strong><strong> </strong><strong>to</strong><strong> </strong><tt><strong>:true</strong></tt><strong>,</strong><strong> </strong><strong>then</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>updated_at</strong></tt><strong> </strong><strong>or</strong><strong> </strong><tt><strong>updated_on</strong></tt><strong> </strong><strong>timestamp</strong><strong> </strong><strong>on</strong><strong> </strong><strong>the</strong><strong> </strong><strong>associated</strong><strong> </strong><strong>object</strong><strong> </strong><strong>will</strong><strong> </strong><strong>be</strong><strong> </strong><strong>set</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><strong>current</strong><strong> </strong><strong>time</strong><strong> </strong><strong>whenever</strong><strong> </strong><strong>this</strong><strong> </strong><strong>object</strong><strong> </strong><strong>is</strong><strong> </strong><strong>saved</strong><strong> </strong><strong>or</strong><strong> </strong><strong>destroyed</strong>:

class Order &lt; ActiveRecord::Base

belongs_to :customer, :touch =&gt; true

end

&nbsp;

class Customer &lt; ActiveRecord::Base

has_many :orders

end

In this case, saving or destroying an order will update the timestamp on the associated customer. You can also specify a particular timestamp attribute to update:

class Order &lt; ActiveRecord::Base

belongs_to :customer, :touch =&gt; :orders_updated_at

end
<h6><a name="belongs_to-validate"></a>4.1.2.12 <tt>:validate</tt></h6>
<strong>If</strong><strong> </strong><strong>you</strong><strong> </strong><strong>set</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:validate</strong></tt><strong> </strong><strong>option</strong><strong> </strong><strong>to</strong><strong> </strong><tt><strong>true</strong></tt><strong>,</strong><strong> </strong><strong>then</strong><strong> </strong><strong>associated</strong><strong> </strong><strong>objects</strong><strong> </strong><strong>will</strong><strong> </strong><strong>be</strong><strong> </strong><strong>validated</strong><strong> </strong><strong>whenever</strong><strong> </strong><strong>you</strong><strong> </strong><strong>save</strong><strong> </strong><strong>this</strong><strong> </strong><strong>object.</strong> By default, this is <tt>false</tt>: associated objects will not be validated when this object is saved.
<h5><a name="belongs_to-how_to_know_whether_theres_an"></a> 4.1.3 How To Know Whether There’s an Associated Object?怎样知道这里是否有Associated 对象?</h5>
To know whether there’s and associated object just check <em>association</em><tt>.nil?</tt>:

if @order.customer.nil?

@msg = &#8220;No customer found for this order&#8221;

end
<h5><a name="belongs_to-when_are_objects_saved"></a>4.1.4 When are Objects Saved?</h5>
<strong>Assigning</strong><strong> </strong><strong>an</strong><strong> </strong><strong>object</strong><strong> </strong><strong>to</strong><strong> </strong><strong>a</strong><strong> </strong><tt><strong>belongs_to</strong></tt><strong> </strong><strong>association</strong><strong> </strong><strong>does</strong><strong> </strong><em><strong>not</strong></em><strong> </strong><strong>automatically</strong><strong> </strong><strong>save</strong><strong> </strong><strong>the</strong><strong> </strong><strong>object.</strong> It does not save the associated object either.
<h4><a name="has_one-association-reference"></a>4.2 <tt>has_one</tt> Association Reference <tt>has_one</tt><tt>关系</tt>参考</h4>
The <tt>has_one</tt> association creates a one-to-one match with another model. In database terms, this association says that the other class contains the foreign key. If this class contains the foreign key, then you should use <tt>belongs_to</tt> instead.
<h5><a name="methods-added-by-has_one"></a>4.2.1 Methods Added by <tt>has_one</tt></h5>
When you declare a <tt>has_one</tt> association, the declaring class automatically gains four methods related to the association:
<ul>
    <li><tt>association</tt><tt>(force_reload</tt><tt> </tt><tt>=</tt><tt> </tt><tt>false)</tt><em> </em></li>
    <li><em>association</em><tt>=(associate)</tt></li>
    <li><tt>build_</tt><em>association</em><tt>(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></li>
    <li><tt>create_</tt><em>association</em><tt>(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></li>
</ul>
In all of these methods, <em>association</em> is replaced with the symbol passed as the first argument to <tt>has_one</tt>. For example, given the declaration:

class Supplier &lt; ActiveRecord::Base

has_one :account

end

Each instance of the <tt>Supplier</tt> model will have these methods:每一个Supplier模型的实例将会具有如下方法：

<code>account</code>

<code>account=</code>

<code>build_account</code>

<code>create_account</code>

When initializing a new <tt>has_one</tt> or <tt>belongs_to</tt> association you must use the <tt>build_</tt> prefix to build the association, rather than the <tt>association.build</tt> method that would be used for <tt>has_many</tt> or <tt>has_and_belongs_to_many</tt> associations. To create one, use the <tt>create_</tt> prefix.
<h6><a name="has_one-association"></a>4.2.1.1 <em>association</em><tt>(force_reload</tt><tt> </tt><tt>=</tt><tt> </tt><tt>false)</tt></h6>
The <em>association</em> method returns the associated object, if any. If no associated object is found, it returns <tt>nil</tt>.

@account = @supplier.account

If the associated object has already been retrieved from the database for this object, the cached version will be returned. To override this behavior (and force a database read), pass <tt>true</tt> as the <tt>force_reload</tt> argument.
<h6><a name="has_one-association_equal"></a>4.2.1.2 <em>association</em><tt>=(associate)</tt></h6>
The <em>association</em><tt>=</tt> method assigns an associated object to this object. Behind the scenes, this means extracting the primary key from this object and setting the associate object’s foreign key to the same value.

@supplier.account = @account
<h6><a name="has_one-build_association"></a>4.2.1.3 <tt>build_</tt><em>association</em><tt>(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></h6>
The <tt>build_</tt><em>association</em> method returns a new object of the associated type. <strong>This</strong><strong> </strong><strong>object</strong><strong> </strong><strong>will</strong><strong> </strong><strong>be</strong><strong> </strong><strong>instantiated</strong><strong> </strong><strong>from</strong><strong> </strong><strong>the</strong><strong> </strong><strong>passed</strong><strong> </strong><strong>attributes,</strong><strong> </strong><strong>and</strong><strong> </strong><strong>the</strong><strong> </strong><strong>link</strong><strong> </strong><strong>through</strong><strong> </strong><strong>its</strong><strong> </strong><strong>foreign</strong><strong> </strong><strong>key</strong><strong> </strong><strong>will</strong><strong> </strong><strong>be</strong><strong> </strong><strong>set,</strong><strong> </strong><strong>but</strong><strong> </strong><strong>the</strong><strong> </strong><strong>associated</strong><strong> </strong><strong>object</strong><strong> </strong><strong>will</strong><strong> </strong><em><strong>not</strong></em><strong>yet</strong><strong>be</strong><strong>saved</strong><strong>.</strong>

@account = @supplier.build_account(:terms =&gt; &#8220;Net 30&#8221;)
<h6><a name="has_one-create_association"></a>4.2.1.4 <tt>create_</tt><em>association</em><tt>(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></h6>
The <tt>create_</tt><em>association</em> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through its foreign key will be set. In addition此外, the associated object <em><strong>will</strong></em><strong>be</strong><strong>saved</strong><strong>(assuming</strong><strong>that</strong><strong>it</strong><strong>passes</strong><strong>any</strong><strong>validations)</strong>.

@account = @supplier.create_account(:terms =&gt; &#8220;Net 30&#8221;)
<h5><a name="options-for-has_one"></a>4.2.2 Options for <tt>has_one</tt></h5>
In many situations, you can use the default behavior of <tt>has_one</tt> without any customization. But despite Rails’ emphasis of convention over customization, you can alter that behavior in a number of ways. This section covers the options that you can pass when you create a <tt>has_one</tt> association. For example, an association with several options might look like this:

class Supplier &lt; ActiveRecord::Base

has_one :account, :class_name =&gt; &#8220;Billing&#8221;, :dependent =&gt; :nullify

end

The <tt>has_one</tt> association supports these options:
<ul>
    <li><tt>:as</tt></li>
    <li><tt>:autosave</tt></li>
    <li><tt>:class_name</tt></li>
    <li><tt>:conditions</tt></li>
    <li><tt>:dependent</tt></li>
    <li><tt>:foreign_key</tt></li>
    <li><tt>:include</tt></li>
    <li><tt>:order</tt></li>
    <li><tt>:primary_key</tt></li>
    <li><tt>:readonly</tt></li>
    <li><tt>:select</tt></li>
    <li><tt>:source</tt></li>
    <li><tt>:source_type</tt></li>
    <li><tt>:through</tt></li>
    <li><tt>:validate</tt></li>
</ul>
<h6><a name="has_one-as"></a>4.2.2.1 <tt>:as</tt></h6>
Setting the <tt>:as</tt> option indicates that this is a polymorphic association. Polymorphic associations were discussed in detail <a href="http://guides.rubyonrails.org/association_basics.html#polymorphic-associations">earlierinthisguide</a>.
<h6><a name="has_one-autosave"></a>4.2.2.2 <tt>:autosave</tt></h6>
If you set the <tt>:autosave</tt> option to <tt>true</tt>, Rails will save any loaded members and destroy members that are marked for destruction <strong>whenever</strong><strong> </strong><strong>you</strong><strong> </strong><strong>save</strong><strong> </strong><strong>the</strong><strong> </strong><strong>parent</strong><strong> </strong><strong>object</strong>.
<h6><a name="has_one-class_name"></a>4.2.2.3 <tt>:class_name</tt></h6>
If the name of the other model cannot be derived from the association name, you can use the <tt>:class_name</tt> option to supply the model name. For example, if a supplier has an account, but the actual name of the model containing accounts is <tt>Billing</tt>, you’d set things up this way:

class Supplier &lt; ActiveRecord::Base

has_one :account, :class_name =&gt; &#8220;Billing&#8221;

end
<h6><a name="has_one-conditions"></a>4.2.2.4 <tt>:conditions</tt></h6>
The <tt>:conditions</tt> option lets you specify the conditions that the associated object must meet (in the syntax used by an SQL <tt>WHERE</tt> clause).

class Supplier &lt; ActiveRecord::Base

has_one :account, :conditions =&gt; &#8220;confirmed = 1&#8221;

end
<h6><a name="has_one-dependent"></a>4.2.2.5 <tt>:dependent</tt></h6>
If you set the <tt>:dependent</tt> option to <tt>:destroy</tt>, then deleting this object will call the <tt>destroy</tt> method on the associated object to delete that object. If you set the <tt>:dependent</tt> option to <tt>:delete</tt>, then deleting this object will delete the associated object <em>without</em> calling its <tt>destroy</tt> method. If you set the <tt>:dependent</tt> option to <tt>:nullify</tt>, then deleting this object will set the foreign key in the association object to <tt>NULL</tt>.
<h6><a name="has_one-foreign_key"></a>4.2.2.6 <tt>:foreign_key</tt></h6>
By convention, Rails guesses that the column used to hold the foreign key on the other model is the name of this model with the suffix <tt>_id</tt> added添加id后缀. The <tt>:foreign_key</tt> option lets you set the name of the foreign key directly:

class Supplier &lt; ActiveRecord::Base

has_one :account, :foreign_key =&gt; &#8220;supp_id&#8221;

end

In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.
<h6><a name="has_one-include"></a>4.2.2.7 <tt>:include</tt></h6>
You can use the <tt>:include</tt> option to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:

class Supplier &lt; ActiveRecord::Base

has_one :account

end

&nbsp;

class Account &lt; ActiveRecord::Base

belongs_to :supplier

belongs_to :representative

end

&nbsp;

class Representative &lt; ActiveRecord::Base

has_many :accounts

end

If you frequently retrieve representatives directly from suppliers (<tt>@supplier.account.representative</tt>), then you can make your code somewhat more efficient by including representatives in the association from suppliers to accounts:

class Supplier &lt; ActiveRecord::Base

has_one :account, :include =&gt; :representative

end

&nbsp;

class Account &lt; ActiveRecord::Base

belongs_to :supplier

belongs_to :representative

end

&nbsp;

class Representative &lt; ActiveRecord::Base

has_many :accounts

end
<h6><a name="has_one-order"></a>4.2.2.8 <tt>:order</tt></h6>
The <tt>:order</tt> option dictates the order in which associated objects will be received (in the syntax used by an SQL <tt>ORDER</tt><tt> </tt><tt>BY</tt> clause). Because a <tt>has_one</tt> association will only retrieve a single associated object, this option should not be needed.
<h6><a name="has_one-primary_key"></a>4.2.2.9 <tt>:primary_key</tt></h6>
By convention, Rails guesses that the column used to hold the primary key of this model is <tt>id</tt>. You can override this and explicitly specify the primary key with the <tt>:primary_key</tt> option.
<h6><a name="has_one-readonly"></a>4.2.2.10 <tt>:readonly</tt></h6>
If you set the <tt>:readonly</tt> option to <tt>true</tt>, then the associated object will be read-only when retrieved via the association.
<h6><a name="has_one-select"></a>4.2.2.11 <tt>:select</tt></h6>
The <tt>:select</tt> option lets you override the SQL <tt>SELECT</tt> clause that is used to retrieve data about the associated object. By default, Rails retrieves all columns.
<h6><a name="has_one-source"></a>.2.2.12 <tt>:source</tt></h6>
The <tt>:source</tt> option specifies the source association name for a <tt>has_one</tt><tt> </tt><tt>:through</tt> association.
<h6><a name="has_one-source_type"></a>4.2.2.13 <tt>:source_type</tt></h6>
The <tt>:source_type</tt> option specifies the source association type for a <tt>has_one</tt><tt> </tt><tt>:through</tt> association that proceeds through a polymorphic association.
<h6><a name="has_one-through"></a>4.2.2.14 <tt>:through</tt></h6>
The <tt>:through</tt> option specifies a join model through which to perform the query. <tt>has_one</tt><tt> </tt><tt>:through</tt> associations were discussed in detail <a href="http://guides.rubyonrails.org/association_basics.html#the-has_one-through-association">earlierinthisguide</a>.
<h6><a name="has_one-validate"></a>4.2.2.15 <tt>:validate</tt></h6>
If you set the <tt>:validate</tt> option to <tt>true</tt>, then associated objects will be validated whenever you save this object. By default, this is <tt>false</tt>: associated objects will not be validated when this object is saved.
<h5><a name="has_one-how_to_know_whether_theres_an_as"></a> 4.2.3 How To Know Whether There’s an Associated Object?</h5>
To know whether there’s and associated object just check <em>association</em><tt>.nil?</tt>:

if @supplier.account.nil?

@msg = &#8220;No account found for this supplier&#8221;

end
<h5><a name="has_one-when_are_objects_saved"></a>4.2.4 When are Objects Saved?</h5>
When you assign an object to a <tt>has_one</tt> association, that object is automatically saved (in order to update its foreign key). In addition, any object being replaced is also automatically saved, because its foreign key will change too.

If either of these saves fails due to validation errors, then the assignment statement returns <tt>false</tt> and the assignment itself is cancelled.

If the parent object (the one declaring the <tt>has_one</tt> association) is unsaved (that is, <tt>new_record?</tt> returns <tt>true</tt>) then the child objects are not saved. <strong>They</strong><strong> </strong><strong>will</strong><strong> </strong><strong>automatically</strong><strong> </strong><strong>when</strong><strong> </strong><strong>the</strong><strong> </strong><strong>parent</strong><strong> </strong><strong>object</strong><strong> </strong><strong>is</strong><strong> </strong><strong>saved.</strong>

<strong>If</strong><strong> </strong><strong>you</strong><strong> </strong><strong>want</strong><strong> </strong><strong>to</strong><strong> </strong><strong>assign</strong><strong> </strong><strong>an</strong><strong> </strong><strong>object</strong><strong> </strong><strong>to</strong><strong> </strong><strong>a</strong><strong> </strong><tt><strong>has_one</strong></tt><strong> </strong><strong>association</strong><strong> </strong><strong>without</strong><strong> </strong><strong>saving</strong><strong> </strong><strong>the</strong><strong> </strong><strong>object,</strong><strong> </strong><strong>use</strong><strong> </strong><strong>the</strong><strong> </strong><em><strong>association</strong></em><tt><strong>.build</strong></tt><strong> </strong><strong>method</strong>.
<h4><a name="has_many-association-reference"></a>4.3 <tt>has_many</tt> Association Reference</h4>
<strong>The</strong><strong> </strong><tt><strong>has_many</strong></tt><strong> </strong><strong>association</strong><strong> </strong><strong>creates</strong><strong> </strong><strong>a</strong><strong> </strong><strong>one-to-many</strong><strong> </strong><strong>relationship</strong><strong> </strong><strong>with</strong><strong> </strong><strong>another</strong><strong> </strong><strong>model.</strong><strong> </strong>In database terms, this association says that the other class will have a foreign key that refers to instances of this class.
<h5><a name="methods-added-by-has_many"></a>4.3.1 Methods Added by <tt>has_many</tt></h5>
When you declare a <tt>has_many</tt> association, the declaring class automatically gains 13 methods related to the association:

<em>collection</em><tt>(force_reload</tt><tt> </tt><tt>=</tt><tt> </tt><tt>false)</tt>
<ul>
    <li><em>collection</em><tt>&lt;&lt;(object,</tt><tt> …</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.delete(object,</tt><tt> …</tt><tt>)</tt></li>
    <li><em>collection</em><tt>=objects</tt></li>
    <li><em>collection_singular</em><tt>_ids</tt></li>
    <li><em>collection_singular</em><tt>_ids=ids</tt></li>
    <li><em>collection</em><tt>.clear</tt></li>
    <li><em>collection</em><tt>.empty?</tt></li>
    <li><em>collection</em><tt>.size</tt></li>
    <li><em>collection</em><tt>.find(</tt><tt>…</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.where(</tt><tt>…</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.exists?(</tt><tt>…</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.build(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{},</tt><tt> …</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.create(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></li>
</ul>
In all of these methods, <em>collection</em> is replaced with the symbol passed as the first argument to <tt>has_many</tt>, and <em>collection_singular</em> is replaced with the singularized version of that symbol.. For example, given the declaration:

class Customer &lt; ActiveRecord::Base

has_many :orders

end

Each instance of the customer model will have these methods:

&nbsp;

orders(force_reload = false)

orders&lt;&lt;(object, &#8230;)

orders.delete(object, &#8230;)

orders=objects

order_ids

order_ids=ids

orders.clear

orders.empty?

orders.size

orders.find(&#8230;)

orders.where(&#8230;)

orders.exists?(&#8230;)

orders.build(attributes = {}, &#8230;)

orders.create(attributes = {})
<h6><a name="has_many-collection"></a>4.3.1.1 <em>collection</em><tt>(force_reload</tt><tt> </tt><tt>=</tt><tt> </tt><tt>false)</tt></h6>
The <em>collection</em> method returns an array of all of the associated objects. If there are no associated objects, it returns an empty array.

@orders = @customer.orders
<h6><a name="has_many-collection-lt_lt"></a>4.3.1.2 <em>collection</em><tt>&lt;&lt;(object,</tt><tt> …</tt><tt>)</tt></h6>
The <em>collection</em><tt>&lt;&lt;</tt> method adds one or more objects to the collection by setting their foreign keys to the primary key of the calling model.

@customer.orders &lt;&lt; @order1
<h6><a name="has_many-collection-delete"></a>4.3.1.3 <em>collection</em><tt>.delete(object,</tt><tt> …</tt><tt>)</tt></h6>
The <em>collection</em><tt>.delete</tt> method removes one or more objects from the collection by setting their foreign keys to <tt>NULL</tt>.

@customer.orders.delete(@order1)

Additionally, objects will be destroyed if they’re associated with <tt>:dependent</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:destroy</tt>, and deleted if they’re associated with <tt>:dependent</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:delete_all</tt>.
<h6><a name="has_many-collection-equal"></a>4.3.1.4 <em>collection</em><tt>=objects</tt></h6>
The <em>collection</em><tt>=</tt> method makes the collection contain only the supplied objects, by adding and deleting as appropriate.
<h6><a name="has_many-collection_singular"></a>4.3.1.5 <em>collection_singular</em><tt>_ids</tt></h6>
The <em>collection_singular</em><tt>_ids</tt> method returns an array of the ids of the objects in the collection.

@order_ids = @customer.order_ids
<h6><a name="has_many-collection_singular_ids_ids"></a> 4.3.1.6 <em>collection_singular</em><tt>_ids=ids</tt></h6>
The <em>collection_singular</em><tt>_ids=</tt> method makes the collection contain only the objects identified确定by the supplied primary key values, by adding and deleting as appropriate适当.
<h6><a name="has_many-collection-clear"></a>4.3.1.7 <em>collection</em><tt>.clear</tt></h6>
The <em>collection</em><tt>.clear</tt> method removes every object from the collection. This destroys the associated objects if they are associated with <tt>:dependent</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:destroy</tt>, deletes them directly from the database if <tt>:dependent</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:delete_all</tt>, and otherwise sets their foreign keys to <tt>NULL</tt>.
<h6><a name="has_many-collection-empty"></a>4.3.1.8 <em>collection</em><tt>.empty?</tt></h6>
The <em>collection</em><tt>.empty?</tt> method returns <tt>true</tt> if the collection does not contain any associated objects.

&lt;% if @customer.orders.empty? %&gt;

No Orders Found

&lt;% end %&gt;
<h6><a name="has_many-collection-size"></a>4.3.1.9 <em>collection</em><tt>.size</tt></h6>
The <em>collection</em><tt>.size</tt> method returns the number of objects in the collection.

@order_count = @customer.orders.size
<h6><a name="has_many-collection-find"></a>4.3.1.10 <em>collection</em><tt>.find(</tt><tt>…</tt><tt>)</tt></h6>
The <em>collection</em><tt>.find</tt> method finds objects within the collection. It uses the same syntax and options as <tt>ActiveRecord::Base.find</tt>.

@open_orders = @customer.orders.where(:open =&gt; 1)
<h6><a name="has_many-collection-where"></a>4.3.1.11 <em>collection</em><tt>.where(</tt><tt>…</tt><tt>)</tt></h6>
The <em>collection</em><tt>.where</tt> method finds objects within the collection based on the conditions supplied but the objects are loaded lazily meaning that the database is queried only when the object(s) are accessed.

@open_orders = @customer.orders.where(:open =&gt; true) # No query yet

@open_order = @open_orders.first # Now the database will be queried
<h6><a name="has_many-collection-exists"></a>4.3.1.12 <em>collection</em><tt>.exists?(</tt><tt>…</tt><tt>)</tt></h6>
The <em>collection</em><tt>.exists?</tt> method checks whether an object meeting the supplied conditions exists in the collection. It uses the same syntax and options as <tt>ActiveRecord::Base.exists?</tt>.
<h6><a name="has_many-collection-build"></a>4.3.1.13 <em>collection</em><tt>.build(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{},</tt><tt> …</tt><tt>)</tt></h6>
The <em>collection</em><tt>.build</tt> method returns one or more new objects of the associated type. These objects will be instantiated from the passed attributes, and the link through their foreign key will be created, but the associated objects will <em>not</em> yet be saved.

@order = @customer.orders.build(:order_date =&gt; Time.now,

:order_number =&gt; &#8220;A12345&#8221;)
<h6><a name="has_many-collection-create"></a>4.3.1.14 <em>collection</em><tt>.create(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></h6>
The <em>collection</em><tt>.create</tt> method returns a new object of the associated type. This object will be instantiated from the passed attributes, the link through its foreign key will be created, and the associated object <em>will</em> be saved (assuming that it passes any validations).

@order = @customer.orders.create(:order_date =&gt; Time.now,

:order_number =&gt; &#8220;A12345&#8221;)
<h5><a name="options-for-has_many"></a>4.3.2 Options for <tt>has_many</tt></h5>
In many situations, you can use the default behavior for <tt>has_many</tt> without any customization. But you can alter that behavior in a number of ways. This section covers the options that you can pass when you create a <tt>has_many</tt> association. For example, an association with several options might look like this:

class Customer &lt; ActiveRecord::Base

has_many :orders, :dependent =&gt; :delete_all, :validate =&gt; :false

end

The <tt>has_many</tt> association supports these options:
<ul>
    <li><tt>:as</tt></li>
    <li><tt>:autosave</tt></li>
    <li><tt>:class_name</tt></li>
    <li><tt>:conditions</tt></li>
    <li><tt>:counter_sql</tt></li>
    <li><tt>:dependent</tt></li>
    <li><tt>:extend</tt></li>
    <li><tt>:finder_sql</tt></li>
    <li><tt>:foreign_key</tt></li>
    <li><tt>:group</tt></li>
    <li><tt>:include</tt></li>
    <li><tt>:limit</tt></li>
    <li><tt>:offset</tt></li>
    <li><tt>:order</tt></li>
    <li><tt>:primary_key</tt></li>
    <li><tt>:readonly</tt></li>
    <li><tt>:select</tt></li>
    <li><tt>:source</tt></li>
    <li><tt>:source_type</tt></li>
    <li><tt>:through</tt></li>
    <li><tt>:uniq</tt></li>
    <li><tt>:validate</tt></li>
</ul>
<h6><a name="has_many-as"></a>4.3.2.1 <tt>:as</tt></h6>
Setting the <tt>:as</tt> option indicates that this is a polymorphic association, as discussed <a href="http://guides.rubyonrails.org/association_basics.html#polymorphic-associations">earlierinthisguide</a>.
<h6><a name="has_many-autosave"></a>4.3.2.2 <tt>:autosave</tt></h6>
If you set the <tt>:autosave</tt> option to <tt>true</tt>, Rails will save any loaded members and destroy members that are marked for destruction whenever you save the parent object.
<h6><a name="has_many-class_name"></a>4.3.2.3 <tt>:class_name</tt></h6>
If the name of the other model cannot be derived from the association name, you can use the <tt>:class_name</tt> option to supply the model name. For example, if a customer has many orders, but the actual name of the model containing orders is <tt>Transaction</tt>, you’d set things up this way:

class Customer &lt; ActiveRecord::Base

has_many :orders, :class_name =&gt; &#8220;Transaction&#8221;

end
<h6><a name="has_many-conditions"></a>4.3.2.4 <tt>:conditions</tt></h6>
The <tt>:conditions</tt> option lets you specify the conditions that the associated object must meet (in the syntax used by an SQL <tt>WHERE</tt> clause).

class Customer &lt; ActiveRecord::Base

has_many :confirmed_orders, :class_name =&gt; &#8220;Order&#8221;,

:conditions =&gt; &#8220;confirmed = 1&#8221;

end

You can also set conditions via a hash:

class Customer &lt; ActiveRecord::Base

has_many :confirmed_orders, :class_name =&gt; &#8220;Order&#8221;,

:conditions =&gt; { :confirmed =&gt; true }

end

If you use a hash-style <tt>:conditions</tt> option, then record creation via this association will be automatically scoped using the hash. In this case, using <tt>@customer.confirmed_orders.create</tt> or <tt>@customer.confirmed_orders.build</tt> will create orders where the confirmed column has the value <tt>true</tt>.

if you need to evaluate conditions dynamically at runtime, use a proc:
<h6><a name="has_many-counter_sql"></a>4.3.2.5 <tt>:counter_sql</tt></h6>
Normally Rails automatically generates the proper SQL to count the association members. With the <tt>:counter_sql</tt> option, you can specify a complete SQL statement to count them yourself.

If you specify <tt>:finder_sql</tt> but not <tt>:counter_sql</tt>, then the counter SQL will be generated by substituting <tt>SELECT</tt><tt> </tt><tt>COUNT(*)</tt><tt> </tt><tt>FROM</tt> for the <tt>SELECT</tt><tt> </tt><tt>&#8230;</tt><tt> </tt><tt>FROM</tt> clause of your <tt>:finder_sql</tt> statement.
<h6><a name="has_many-dependent"></a>4.3.2.6 <tt>:dependent</tt></h6>
If you set the <tt>:dependent</tt> option to <tt>:destroy</tt><tt>（删除映射链和映射对象）</tt>, then deleting this object will call the <tt>destroy</tt> method on the associated objects to delete those objects. If you set the <tt>:dependent</tt> option to <tt>:delete_all</tt><tt>（只删除映射链）</tt>, then deleting this object will delete the associated objects <em>without</em> calling their <tt>destroy</tt> method. If you set the <tt>:dependent</tt> option to <tt>:nullify</tt>, then deleting this object will set the foreign key in the associated objects to <tt>NULL</tt>.

This option is ignored when you use the <tt>:through</tt> option on the association.
<h6><a name="has_many-extend"></a>4.3.2.7 <tt>:extend</tt></h6>
The <tt>:extend</tt> option specifies a named module to extend the association proxy. Association extensions are discussed in detail <a href="http://guides.rubyonrails.org/association_basics.html#association-extensions">laterinthisguide</a>.
<h6><a name="has_many-finder_sql"></a>4.3.2.8 <tt>:finder_sql</tt></h6>
Normally Rails automatically generates the proper SQL to fetch the association members. With the <tt>:finder_sql</tt> option, you can specify a complete SQL statement to fetch them yourself. If fetching objects requires complex multi-table SQL, this may be necessary.
<h6><a name="has_many-foreign_key"></a>4.3.2.9 <tt>:foreign_key</tt></h6>
By convention, Rails guesses that the column used to hold the foreign key on the other model is the name of this model with the suffix <tt>_id</tt> added添加前缀. The <tt>:foreign_key</tt> option lets you set the name of the foreign key directly:

In any case, Rails will not create foreign key columns for you. You need to explicitly define them as part of your migrations.
<h6><a name="has_many-group"></a>4.3.2.10 <tt>:group</tt></h6>
The <tt>:group</tt> option supplies an attribute name to group the result set by, using a <tt>GROUP</tt><tt> </tt><tt>BY</tt> clause in the finder SQL.

class Customer &lt; ActiveRecord::Base

has_many :line_items, :through =&gt; :orders, :group =&gt; &#8220;orders.id&#8221;

end
<h6><a name="has_many-include"></a>4.3.2.11 <tt>:include</tt></h6>
You can use the <tt>:include</tt> option to specify second-order associations that should be eager-loaded when this association is used. For example, consider these models:

class Customer &lt; ActiveRecord::Base

has_many :orders

end

&nbsp;

class Order &lt; ActiveRecord::Base

belongs_to :customer

has_many :line_items

end

&nbsp;

class LineItem &lt; ActiveRecord::Base

belongs_to :order

end

If you frequently retrieve line items directly from customers (<tt>@customer.orders.line_items</tt>), then you can make your code somewhat more efficient by including line items in the association from customers to orders:

class Customer &lt; ActiveRecord::Base

has_many :orders, :include =&gt; :line_items

end

&nbsp;

class Order &lt; ActiveRecord::Base

belongs_to :customer

has_many :line_items

end

&nbsp;

class LineItem &lt; ActiveRecord::Base

belongs_to :order

end
<h6><a name="has_many-limit"></a>4.3.2.12 <tt>:limit</tt></h6>
The <tt>:limit</tt> option lets you restrict the total number of objects that will be fetched through an association.

class Customer &lt; ActiveRecord::Base

has_many :recent_orders, :class_name =&gt; &#8220;Order&#8221;,

:order =&gt; &#8220;order_date DESC&#8221;, :limit =&gt; 100

end
<h6><a name="has_many-offset"></a>4.3.2.13 <tt>:offset</tt></h6>
The <tt>:offset</tt> option lets you specify the starting offset for fetching objects via an association. For example, if you set <tt>:offset</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>11</tt>, it will skip the first 11 records.
<h6><a name="has_many-order"></a>4.3.2.14 <tt>:order</tt></h6>
The <tt>:order</tt> option dictates the order in which associated objects will be received (in the syntax used by an SQL <tt>ORDER</tt><tt> </tt><tt>BY</tt> clause).

class Customer &lt; ActiveRecord::Base

has_many :orders, :order =&gt; &#8220;date_confirmed DESC&#8221;

end
<h6><a name="has_many-primary_key"></a>4.3.2.15 <tt>:primary_key</tt></h6>
By convention, Rails guesses that the column used to hold the primary key of the association is <tt>id</tt>. You can override this and explicitly specify the primary key with the <tt>:primary_key</tt> option.
<h6><a name="has_many-readonly"></a>4.3.2.16 <tt>:readonly</tt></h6>
If you set the <tt>:readonly</tt> option to <tt>true</tt>, then the associated objects will be read-only when retrieved via the association.
<h6><a name="has_many-select"></a>4.3.2.17 <tt>:select</tt></h6>
The <tt>:select</tt> option lets you override the SQL <tt>SELECT</tt> clause that is used to retrieve data about the associated objects. By default, Rails retrieves all columns.

If you specify your own <tt>:select</tt>, be sure to include the primary key and foreign key columns of the associated model. If you do not, Rails will throw an error.
<h6><a name="has_many-source"></a>4.3.2.18 <tt>:source</tt></h6>
The <tt>:source</tt> option specifies the source association name for a <tt>has_many</tt><tt> </tt><tt>:through</tt> association. You only need to use this option if the name of the source association cannot be automatically inferred from the association name.
<h6><a name="has_many-source_type"></a>4.3.2.19 <tt>:source_type</tt></h6>
The <tt>:source_type</tt> option specifies the source association type for a <tt>has_many</tt><tt> </tt><tt>:through</tt> association that proceeds through a polymorphic association.
<h6><a name="has_many-through"></a>4.3.2.20 <tt>:through</tt></h6>
The <tt>:through</tt> option specifies a join model through which to perform the query. <tt>has_many</tt><tt> </tt><tt>:through</tt> associations provide a way to implement many-to-many relationships, as discussed <a href="http://guides.rubyonrails.org/association_basics.html#the-has_many-through-association">earlierinthisguide</a>.
<h6><a name="has_many-uniq"></a>4.3.2.21 <tt>:uniq</tt></h6>
Set the <tt>:uniq</tt> option to true to keep the collection free of duplicates. This is mostly useful together with the <tt>:through</tt> option.

class Person &lt; ActiveRecord::Base

has_many :readings

has_many :posts, :through =&gt; :readings

end

&nbsp;

person = Person.create(:name =&gt; &#8216;john&#8217;)

post = Post.create(:name =&gt; &#8216;a1&#8217;)

person.posts &lt;&lt; post

person.posts &lt;&lt; post

person.posts.inspect # =&gt; [#&lt;Post id: 5, name: &#8220;a1&#8221;&gt;, #&lt;Post id: 5, name: &#8220;a1&#8221;&gt;]

Reading.all.inspect # =&gt; [#&lt;Reading id: 12, person_id: 5, post_id: 5&gt;, #&lt;Reading id: 13, person_id: 5, post_id: 5&gt;]

In the above case there are two readings and <tt>person.posts</tt> brings out both of them even though these records are pointing to the same post.

Now let’s set <tt>:uniq</tt> to true:

class Person

has_many :readings

has_many :posts, :through =&gt; :readings, :uniq =&gt; true

end

&nbsp;

person = Person.create(:name =&gt; &#8216;honda&#8217;)

post = Post.create(:name =&gt; &#8216;a1&#8217;)

person.posts &lt;&lt; post

person.posts &lt;&lt; post

person.posts.inspect # =&gt; [#&lt;Post id: 7, name: &#8220;a1&#8221;&gt;]

Reading.all.inspect # =&gt; [#&lt;Reading id: 16, person_id: 7, post_id: 7&gt;, #&lt;Reading id: 17, person_id: 7, post_id: 7&gt;]

In the above case there are still two readings. However <tt>person.posts</tt> shows only one post because the collection loads only unique records.
<h6><a name="has_many-validate"></a>4.3.2.22 <tt>:validate</tt></h6>
If you set the <tt>:validate</tt> option to <tt>false</tt>, then associated objects will not be validated whenever you save this object. By default, this is <tt>true</tt>: associated objects will be validated when this object is saved.
<h5><a name="has_many-when_are_objects_saved"></a>4.3.3 When are Objects Saved?</h5>
When you assign an object to a <tt>has_many</tt> association, that object is automatically saved (in order to update its foreign key). If you assign multiple objects in one statement, then they are all saved.

If any of these saves fails due to validation errors, then the assignment statement returns <tt>false</tt> and the assignment itself is cancelled.

If the parent object (the one declaring the <tt>has_many</tt> association) is unsaved (that is, <tt>new_record?</tt> returns <tt>true</tt>) then the child objects are not saved when they are added. All unsaved members of the association will automatically be saved when the parent is saved.

If you want to assign an object to a <tt>has_many</tt> association without saving the object, use the <em>collection</em><tt>.build</tt> method.
<h4><a name="has_and_belongs_to_many-association-refe"></a> 4.4 <tt>has_and_belongs_to_many</tt> Association Reference</h4>
The <tt>has_and_belongs_to_many</tt> association creates a many-to-many relationship with another model. In database terms, this associates two classes via an intermediate join table that includes foreign keys referring to each of the classes.
<h5><a name="methods-added-by-has_and_belongs_to_many"></a> 4.4.1 Methods Added by <tt>has_and_belongs_to_many</tt></h5>
When you declare a <tt>has_and_belongs_to_many</tt> association, the declaring class automatically gains 13 methods related to the association:
<ul>
    <li><em>collection</em><tt>(force_reload</tt><tt> </tt><tt>=</tt><tt> </tt><tt>false)</tt></li>
    <li><em>collection</em><tt>&lt;&lt;(object,</tt><tt> …</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.delete(object,</tt><tt> …</tt><tt>)</tt></li>
    <li><em>collection</em><tt>=objects</tt></li>
    <li><em>collection_singular</em><tt>_ids</tt></li>
    <li><em>collection_singular</em><tt>_ids=ids</tt></li>
    <li><em>collection</em><tt>.clear</tt></li>
    <li><em>collection</em><tt>.empty?</tt></li>
    <li><em>collection</em><tt>.size</tt></li>
    <li><em>collection</em><tt>.find(</tt><tt>…</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.where(</tt><tt>…</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.exists?(</tt><tt>…</tt><tt>)</tt></li>
    <li><em>collection</em><tt>.build(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></li>
    <li><em>collection</em><tt>.create(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></li>
</ul>
In all of these methods, <em>collection</em> is replaced with the symbol passed as the first argument to <tt>has_and_belongs_to_many</tt>, and <em>collection_singular</em> is replaced with the singularized version of that symbol. For example, given the declaration:

class Part &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies

end

Each instance of the part model will have these methods:

assemblies(force_reload = false)

assemblies&lt;&lt;(object, &#8230;)

assemblies.delete(object, &#8230;)

assemblies=objects

assembly_ids

assembly_ids=ids

assemblies.clear

assemblies.empty?

assemblies.size

assemblies.find(&#8230;)

assemblies.where(&#8230;)

assemblies.exists?(&#8230;)

assemblies.build(attributes = {}, &#8230;)

assemblies.create(attributes = {})
<h6><a name="additional-column-methods"></a>4.4.1.1 Additional Column Methods</h6>
If the join table for a <tt>has_and_belongs_to_many</tt> association has additional columns beyond the two foreign keys, these columns will be added as attributes to records retrieved via that association. Records returned with additional attributes will always be read-only, because Rails cannot save changes to those attributes.

The use of extra attributes on the join table in a <tt>has_and_belongs_to_many</tt> association is deprecated. If you require this sort of complex behavior on the table that joins two models in a many-to-many relationship, you should use a <tt>has_many</tt><tt> </tt><tt>:through</tt> association instead of <tt>has_and_belongs_to_many</tt>.
<h6><a name="has_and_belongs_to_many-collection"></a>4.4.1.2 <em>collection</em><tt>(force_reload</tt><tt> </tt><tt>=</tt><tt> </tt><tt>false)</tt></h6>
The <em>collection</em> method returns an array of all of the associated objects. If there are no associated objects, it returns an empty array.

@assemblies = @part.assemblies
<h6><a name="has_and_belongs_to_many-collection-lt_lt"></a> 4.4.1.3 <em>collection</em><tt>&lt;&lt;(object,</tt><tt> …</tt><tt>)</tt></h6>
The <em>collection</em><tt>&lt;&lt;</tt> method adds one or more objects to the collection by creating records in the join table.

@part.assemblies &lt;&lt; @assembly1

This method is aliased as <em>collection</em><tt>.concat</tt> and <em>collection</em><tt>.push</tt>.
<h6><a name="has_and_belongs_to_many-collection-delet"></a> 4.4.1.4 <em>collection</em><tt>.delete(object,</tt><tt> …</tt><tt>)</tt></h6>
The <em>collection</em><tt>.delete</tt> method removes one or more objects from the collection by deleting records in the join table. This does not destroy the objects.

@part.assemblies.delete(@assembly1)
<h6><a name="has_and_belongs_to_many-collection-equal"></a> 4.4.1.5 <em>collection</em><tt>=objects</tt></h6>
The <em>collection</em><tt>=</tt> method makes the collection contain only the supplied objects, by adding and deleting as appropriate.
<h6><a name="has_and_belongs_to_many-collection_singu"></a> 4.4.1.6 <em>collection_singular</em><tt>_ids</tt></h6>
The <em>collection_singular</em><tt>_ids</tt> method returns an array of the ids of the objects in the collection.

@assembly_ids = @part.assembly_ids
<h6>4.4.1.7 <em>collection_singular</em><tt>_ids=ids</tt></h6>
The <em>collection_singular</em><tt>_ids=</tt> method makes the collection contain only the objects identified by the supplied primary key values, by adding and deleting as appropriate.
<h6><a name="has_and_belongs_to_many-collection-clear"></a> 4.4.1.8 <em>collection</em><tt>.clear</tt></h6>
The <em>collection</em><tt>.clear</tt> method removes every object from the collection by deleting the rows from the joining table. This does not destroy the associated objects.
<h6><a name="has_and_belongs_to_many-collection-empty"></a> 4.4.1.9 <em>collection</em><tt>.empty?</tt></h6>
The <em>collection</em><tt>.empty?</tt> method returns <tt>true</tt> if the collection does not contain any associated objects.

&lt;% if @part.assemblies.empty? %&gt;

This part is not used in any assemblies

&lt;% end %&gt;
<h6><a name="has_and_belongs_to_many-collection-size"></a> 4.4.1.10 <em>collection</em><tt>.size</tt></h6>
The <em>collection</em><tt>.size</tt> method returns the number of objects in the collection.

@assembly_count = @part.assemblies.size
<h6><a name="has_and_belongs_to_many-collection-find"></a> 4.4.1.11 <em>collection</em><tt>.find(</tt><tt>…</tt><tt>)</tt></h6>
The <em>collection</em><tt>.find</tt> method finds objects within the collection. It uses the same syntax and options as <tt>ActiveRecord::Base.find</tt>. It also adds the additional condition that the object must be in the collection.

@new_assemblies = @part.assemblies.all(

:conditions =&gt; [&#8220;created_at &gt; ?&#8221;, 2.days.ago])

Starting Rails 3, supplying options to <tt>ActiveRecord::Base.find</tt> method is discouraged. Use <em>collection</em><tt>.where</tt> instead when you need to pass conditions.
<h6><a name="has_and_belongs_to_many-collection-where"></a> 4.4.1.12 <em>collection</em><tt>.where(</tt><tt>…</tt><tt>)</tt></h6>
The <em>collection</em><tt>.where</tt> method finds objects within the collection based on the conditions supplied but the objects are loaded lazily meaning that the database is queried only when the object(s) are accessed. It also adds the additional condition that the object must be in the collection.

@new_assemblies = @part.assemblies.where(&#8220;created_at &gt; ?&#8221;, 2.days.ago)
<h6><a name="has_and_belongs_to_many-collection-exist"></a> 4.4.1.13 <em>collection</em><tt>.exists?(</tt><tt>…</tt><tt>)</tt></h6>
The <em>collection</em><tt>.exists?</tt> method checks whether an object meeting the supplied conditions exists in the collection. It uses the same syntax and options as <tt>ActiveRecord::Base.exists?</tt>.
<h6><a name="has_and_belongs_to_many-collection-build"></a> 4.4.1.14 <em>collection</em><tt>.build(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></h6>
The <em>collection</em><tt>.build</tt> method returns a new object of the associated type. This object will be instantiated from the passed attributes, and the link through the join table will be created, but the associated object will <em>not</em> yet be saved.

@assembly = @part.assemblies.build(

{:assembly_name =&gt; &#8220;Transmission housing&#8221;})
<h6><a name="has_and_belongs_to_many-create-attribute"></a> 4.4.1.15 <em>collection</em><tt>.create(attributes</tt><tt> </tt><tt>=</tt><tt> </tt><tt>{})</tt></h6>
The <em>collection</em><tt>.create</tt> method returns a new object of the associated type. This object will be instantiated from the passed attributes, the link through the join table will be created, and the associated object <em>will</em> be saved (assuming that it passes any validations).

@assembly = @part.assemblies.create(

{:assembly_name =&gt; &#8220;Transmission housing&#8221;})
<h5><a name="options-for-has_and_belongs_to_many"></a> 4.4.2 Options for <tt>has_and_belongs_to_many</tt></h5>
In many situations, you can use the default behavior for <tt>has_and_belongs_to_many</tt> without any customization. But you can alter that behavior in a number of ways. This section covers the options that you can pass when you create a <tt>has_and_belongs_to_many</tt> association. For example, an association with several options might look like this:

class Parts &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies, :uniq =&gt; true,

:read_only =&gt; true

end

The <tt>has_and_belongs_to_many</tt> association supports these options:
<ul>
    <li><tt>:association_foreign_key</tt></li>
    <li><tt>:autosave</tt></li>
    <li><tt>:class_name</tt></li>
    <li><tt>:conditions</tt></li>
    <li><tt>:counter_sql</tt></li>
    <li><tt>:delete_sql</tt></li>
    <li><tt>:extend</tt></li>
    <li><tt>:finder_sql</tt></li>
    <li><tt>:foreign_key</tt></li>
    <li><tt>:group</tt></li>
    <li><tt>:include</tt></li>
    <li><tt>:insert_sql</tt></li>
    <li><tt>:join_table</tt></li>
    <li><tt>:limit</tt></li>
    <li><tt>:offset</tt></li>
    <li><tt>:order</tt></li>
    <li><tt>:readonly</tt></li>
    <li><tt>:select</tt></li>
    <li><tt>:uniq</tt></li>
    <li><tt>:validate</tt></li>
</ul>
<h6><a name="has_and_belongs_to_many-association_fore"></a> 4.4.2.1 <tt>:association_foreign_key</tt></h6>
By convention, Rails guesses that the column in the join table used to hold the foreign key pointing to the other model is the name of that model with the suffix <tt>_id</tt> added. The <tt>:association_foreign_key</tt> option lets you set the name of the foreign key directly:

The <tt>:foreign_key</tt> and <tt>:association_foreign_key</tt> options are useful when setting up a many-to-many self-join. For example:

class User &lt; ActiveRecord::Base

has_and_belongs_to_many :friends, :class_name =&gt; &#8220;User&#8221;,

:foreign_key =&gt; &#8220;this_user_id&#8221;,

:association_foreign_key =&gt; &#8220;other_user_id&#8221;

end
<h6><a name="has_and_belongs_to_many-autosave"></a>4.4.2.2 <tt>:autosave</tt></h6>
If you set the <tt>:autosave</tt> option to <tt>true</tt>, Rails will save any loaded members and destroy members that are marked for destruction whenever you save the parent object.
<h6><a name="has_and_belongs_to_many-class_name"></a>4.4.2.3 <tt>:class_name</tt></h6>
If the name of the other model cannot be derived from the association name, you can use the <tt>:class_name</tt> option to supply the model name. For example, if a part has many assemblies, but the actual name of the model containing assemblies is <tt>Gadget</tt>, you’d set things up this way:

class Parts &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies, :class_name =&gt; &#8220;Gadget&#8221;

end
<h6><a name="has_and_belongs_to_many-conditions"></a>4.4.2.4 <tt>:conditions</tt></h6>
The <tt>:conditions</tt> option lets you specify the conditions that the associated object must meet (in the syntax used by an SQL <tt>WHERE</tt> clause).

class Parts &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies,

:conditions =&gt; &#8220;factory = &#8216;Seattle&#8217;&#8221;

end

You can also set conditions via a hash:

class Parts &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies,

:conditions =&gt; { :factory =&gt; &#8216;Seattle&#8217; }

end

If you use a hash-style <tt>:conditions</tt> option, then record creation via this association will be automatically scoped using the hash. In this case, using <tt>@parts.assemblies.create</tt> or <tt>@parts.assemblies.build</tt> will create orders where the <tt>factory</tt> column has the value “Seattle”.
<h6><a name="has_and_belongs_to_many-counter_sql"></a> 4.4.2.5 <tt>:counter_sql</tt></h6>
Normally Rails automatically generates the proper SQL to count the association members. With the <tt>:counter_sql</tt> option, you can specify a complete SQL statement to count them yourself.

If you specify <tt>:finder_sql</tt> but not <tt>:counter_sql</tt>, then the counter SQL will be generated by substituting <tt>SELECT</tt><tt> </tt><tt>COUNT(*)</tt><tt> </tt><tt>FROM</tt> for the <tt>SELECT</tt><tt> </tt><tt>&#8230;</tt><tt> </tt><tt>FROM</tt> clause of your <tt>:finder_sql</tt> statement.
<h6><a name="has_and_belongs_to_many-delete_sql"></a>4.4.2.6 <tt>:delete_sql</tt></h6>
Normally Rails automatically generates the proper SQL to remove links between the associated classes. With the <tt>:delete_sql</tt> option, you can specify a complete SQL statement to delete them yourself.
<h6><a name="has_and_belongs_to_many-extend"></a>4.4.2.7 <tt>:extend</tt></h6>
The <tt>:extend</tt> option specifies a named module to extend the association proxy. Association extensions are discussed in detail <a href="http://guides.rubyonrails.org/association_basics.html#association-extensions">laterinthisguide</a>.
<h6><a name="has_and_belongs_to_many-finder_sql"></a>4.4.2.8 <tt>:finder_sql</tt></h6>
Normally Rails automatically generates the proper SQL to fetch the association members. With the <tt>:finder_sql</tt> option, you can specify a complete SQL statement to fetch them yourself. If fetching objects requires complex multi-table SQL, this may be necessary.
<h6><a name="has_and_belongs_to_many-foreign_key"></a> 4.4.2.9 <tt>:foreign_key</tt></h6>
By convention, Rails guesses that the column in the join table used to hold the foreign key pointing to this model is the name of this model with the suffix <tt>_id</tt> added. The <tt>:foreign_key</tt> option lets you set the name of the foreign key directly:

class User &lt; ActiveRecord::Base

has_and_belongs_to_many :friends, :class_name =&gt; &#8220;User&#8221;,

:foreign_key =&gt; &#8220;this_user_id&#8221;,

:association_foreign_key =&gt; &#8220;other_user_id&#8221;

end
<h6><a name="has_and_belongs_to_many-group"></a>4.4.2.10 <tt>:group</tt></h6>
The <tt>:group</tt> option supplies an attribute name to group the result set by, using a <tt>GROUP</tt><tt> </tt><tt>BY</tt> clause in the finder SQL.

class Parts &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies, :group =&gt; &#8220;factory&#8221;

end
<h6><a name="has_and_belongs_to_many-include"></a>4.4.2.11 <tt>:include</tt></h6>
You can use the <tt>:include</tt> option to specify second-order associations that should be eager-loaded when this association is used.
<h6><a name="has_and_belongs_to_many-insert_sql"></a>4.4.2.12 <tt>:insert_sql</tt></h6>
Normally Rails automatically generates the proper SQL to create links between the associated classes. With the <tt>:insert_sql</tt> option, you can specify a complete SQL statement to insert them yourself.
<h6><a name="has_and_belongs_to_many-join_table"></a>4.4.2.13 <tt>:join_table</tt></h6>
If the default name of the join table, based on lexical ordering, is not what you want, you can use the <tt>:join_table</tt> option to override the default.
<h6><a name="has_and_belongs_to_many-limit"></a>4.4.2.14 <tt>:limit</tt></h6>
The <tt>:limit</tt> option lets you restrict the total number of objects that will be fetched through an association.

class Parts &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies, :order =&gt; &#8220;created_at DESC&#8221;,

:limit =&gt; 50

end
<h6><a name="has_and_belongs_to_many-offset"></a>4.4.2.15 <tt>:offset</tt></h6>
The <tt>:offset</tt> option lets you specify the starting offset for fetching objects via an association. For example, if you set <tt>:offset</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>11</tt>, it will skip the first 11 records.
<h6><a name="has_and_belongs_to_many-order"></a>4.4.2.16 <tt>:order</tt></h6>
The <tt>:order</tt> option dictates the order in which associated objects will be received (in the syntax used by an SQL <tt>ORDER</tt><tt> </tt><tt>BY</tt> clause).

class Parts &lt; ActiveRecord::Base

has_and_belongs_to_many :assemblies, :order =&gt; &#8220;assembly_name ASC&#8221;

end
<h6><a name="has_and_belongs_to_many-readonly"></a>4.4.2.17 <tt>:readonly</tt></h6>
If you set the <tt>:readonly</tt> option to <tt>true</tt>, then the associated objects will be read-only when retrieved via the association.
<h6><a name="has_and_belongs_to_many-select"></a>4.4.2.18 <tt>:select</tt></h6>
The <tt>:select</tt> option lets you override the SQL <tt>SELECT</tt> clause that is used to retrieve data about the associated objects. By default, Rails retrieves all columns.
<h6><a name="has_and_belongs_to_many-uniq"></a>4.4.2.19 <tt>:uniq</tt></h6>
Specify the <tt>:uniq</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt> option to remove duplicates from the collection.
<h6><a name="has_and_belongs_to_many-validate"></a>4.4.2.20 <tt>:validate</tt></h6>
If you set the <tt>:validate</tt> option to <tt>false</tt>, then associated objects will not be validated whenever you save this object. By default, this is <tt>true</tt>: associated objects will be validated when this object is saved.
<h5><a name="has_and_belongs_to_many-when_are_objects"></a> 4.4.3 When are Objects Saved?</h5>
When you assign an object to a <tt>has_and_belongs_to_many</tt> association, that object is automatically saved (in order to update the join table). If you assign multiple objects in one statement, then they are all saved.

If any of these saves fails due to validation errors, then the assignment statement returns <tt>false</tt> and the assignment itself is cancelled.

If the parent object (the one declaring the <tt>has_and_belongs_to_many</tt> association) is unsaved (that is, <tt>new_record?</tt> returns <tt>true</tt>) then the child objects are not saved when they are added. All unsaved members of the association will automatically be saved when the parent is saved.

If you want to assign an object to a <tt>has_and_belongs_to_many</tt> association without saving the object, use the <em>collection</em><tt>.build</tt> method.
<h4><a name="association-callbacks"></a>4.5 Association Callbacks</h4>
Normal callbacks hook into the life cycle of Active Record objects, allowing you to work with those objects at various points. For example, you can use a <tt>:before_save</tt> callback to cause something to happen just before an object is saved.

Association callbacks are similar to normal callbacks, but they are triggered by events in the life cycle of a collection. There are four available association callbacks:
<ul>
    <li><tt>before_add</tt></li>
    <li><tt>after_add</tt></li>
    <li><tt>before_remove</tt></li>
    <li><tt>after_remove</tt></li>
</ul>
You define association callbacks by adding options to the association declaration. For example:

class Customer &lt; ActiveRecord::Base

has_many :orders, :before_add =&gt; :check_credit_limit

&nbsp;

def check_credit_limit(order)

&#8230;

end

end

You can stack callbacks on a single event by passing them as an array:

class Customer &lt; ActiveRecord::Base

has_many :orders,

:before_add =&gt; [:check_credit_limit, :calculate_shipping_charges]

&nbsp;

def check_credit_limit(order)

&#8230;

end

&nbsp;

def calculate_shipping_charges(order)

&#8230;

end

end

If a <tt>before_add</tt> callback throws an exception, the object does not get added to the collection. Similarly, if a <tt>before_remove</tt> callback throws an exception, the object does not get removed from the collection.
<h4><a name="association-extensions"></a>4.6 Association Extensions</h4>
You’re not limited to the functionality that Rails automatically builds into association proxy objects. You can also extend these objects through anonymous modules, adding new finders, creators, or other methods. For example:

class Customer &lt; ActiveRecord::Base

has_many :orders do

def find_by_order_prefix(order_number)

find_by_region_id(order_number[0..2])

end

end

end

If you have an extension that should be shared by many associations, you can use a named extension module. For example:

module FindRecentExtension

def find_recent

where(&#8220;created_at &gt; ?&#8221;, 5.days.ago)

end

end

&nbsp;

class Customer &lt; ActiveRecord::Base

has_many :orders, :extend =&gt; FindRecentExtension

end

&nbsp;

class Supplier &lt; ActiveRecord::Base

has_many :deliveries, :extend =&gt; FindRecentExtension

end

To include more than one extension module in a single association, specify an array of modules:

class Customer &lt; ActiveRecord::Base

has_many :orders,

:extend =&gt; [FindRecentExtension, FindActiveExtension]

end

Extensions can refer to the internals of the association proxy using these three accessors访问器:
<ul>
    <li><tt>proxy_owner</tt> returns the object that the association is a part of.</li>
    <li><tt>proxy_reflection</tt> returns the reflection object that describes the association.</li>
    <li><tt>proxy_target</tt> returns the associated object for <tt>belongs_to</tt> or <tt>has_one</tt>, or the collection of associated objects for <tt>has_many</tt> or <tt>has_and_belongs_to_many</tt>.</li>
</ul>
&nbsp;

Now,supposewewantedtoaddaneworderforanexistingcustomer.We’dneedtodosomethinglikethis:现在假设我们想为一个存在的customer添加一个新的order。我们需要做如下事情：

</div>


<div>标签： <a href="http://jhjguxin.hwcrazy.com/tag/guide/">guide</a> <a href="http://jhjguxin.hwcrazy.com/tag/rails/">rails</a> <a href="http://jhjguxin.hwcrazy.com/tag/ruby/">ruby</a></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/24/active-record-validations-and-callbacks-huo-dong-ji-lu-yan-zheng-he-hui-diao/">Active Record Validations and Callbacks 活动记录验证和回调</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-24T13:38:00+08:00" pubdate data-updated="true">Nov 24<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Active Record Validations and Callbacks 活动记录验证和回调</h2>

<h2>Active Record Validations and Callbacks <span style="font-family: WenQuanYi Micro Hei;">活动记录验证和回调</span></h2>


<p>This guide teaches you how to hook<span style="font-family: DejaVu Sans;">勾子</span>into the life cycle of your Active Record objects.<span style="font-family: DejaVu Sans;">这个教程指导你怎样挂接到你的</span>Active Record objects<span style="font-family: DejaVu Sans;">的生存周期。</span>You will learn how to validate the state of objects before they go into the database, and how to perform custom operations at certain points in the object life cycle.<span style="font-family: DejaVu Sans;">你将会学习到在将数据对象存入数据库之前怎样验证它们的状态，以及在对象生存周期的一些点上怎样执行定制操作。</span></p>

<p>After reading this guide and trying out the presented concepts, we hope that you’ll be able to:<span style="font-family: DejaVu Sans;">在阅读了这个教程以及尝试介绍的概念，我们希望你能够：</span></p>

<ul>
    <li>Understand the life cycle of Active Record objects <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">理解 </span></span>Active Record<span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">对象的生存周期</span></span></li>
    <li>Use the built-in Active Record validation helpers <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">使用内建的 </span></span>Active Record<span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">验证</span></span>helpers</li>
    <li>Create your own custom validation methods <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">创建属于你的定制验证方法</span></span></li>
    <li>Work with the error messages generated by the validation process <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">在验证过程中使用错误消息创建器工作</span></span></li>
    <li>Create callback methods that respond to events in the object life cycle <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">新建一个回调方法响应对象生存周期的事件</span></span></li>
    <li>Create special classes that encapsulate<span style="font-family: DejaVu Sans;">封装</span>common behavior for your callbacks <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">创建特殊的类来封装你回调的通常习惯（方法）</span></span></li>
    <li>Create Observers<span style="font-family: DejaVu Sans;">观察员</span>that respond to life cycle events outside of the original class <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">创建 </span></span>Observers<span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">来响应原类以外的生存周期事件</span></span></li>
</ul>


<h3>1 The Object Life Cycle</h3>


<p>During the normal operation of a Rails application, objects may be created, updated, and destroyed. Active Record provides hooks into this <em>object</em><em> </em><em>life</em><em> </em><em>cycle</em> so that you can control your application and its data.<span style="font-family: DejaVu Sans;">一个</span>Rails<span style="font-family: DejaVu Sans;">应用程序的正常操作期间，对象可能被新建，更新，和销毁。</span>Active Record<span style="font-family: DejaVu Sans;">提供挂载到这个对象生存周期，以便你可以控制你的应用程序和数据。</span></p>

<p>Validations allow you to ensure that only valid data is stored in your database. Callbacks and observers allow you to trigger<span style="font-family: DejaVu Sans;">触发</span>logic before or after an alteration<span style="font-family: DejaVu Sans;">改造变动</span>of an object’s state.<span style="font-family: DejaVu Sans;">验证允许你确保只有验证数据被存储到你的数据库。回调和观察员（监视器）允许你在变动一个对象的状态之前或之后触发逻辑。</span></p>

<h3>2 Validations Overview<span style="font-family: WenQuanYi Micro Hei;">验证概述</span></h3>


<p>Before you dive into the detail of validations in Rails, you should understand a bit about how validations fit into the big picture.<span style="font-family: DejaVu Sans;">在你深入</span>Rails <span style="font-family: DejaVu Sans;">验证的详细说明之前，你应该明白一点就是关于怎样让验证适合于（</span>Rails<span style="font-family: DejaVu Sans;">）这幅大画卷。</span></p>

<h4>2.1 Why Use Validations?</h4>


<p>Validations are used to ensure that only valid data is saved into your database. For example, it may be important to your application to ensure that every user provides a valid email address and mailing address.<span style="font-family: DejaVu Sans;">验证用于确保只有通过验证的数据被保存入你的数据库。例如，在你的应用程序中确认每个用户提供了一个有效的</span>Email<span style="font-family: DejaVu Sans;">地址和邮寄地址是非常重要的。</span></p>

<p>There are several ways to validate data before it is saved into your database, including native database constraints, client-side validations, controller-level validations, and model-level validations.<span style="font-family: DejaVu Sans;">在数据被存储到你的数据库中之前这里有几种方法来验证它，包括本地数据库约束，客户端验证，控制层级别的验证和模型层级别的验证。</span></p>

<p>Database constraints and/or stored procedures make the validation mechanisms database-dependent and can make testing and maintenance more difficult. However, if your database is used by other applications, it may be a good idea to use some constraints at the database level. Additionally, database-level validations can safely handle some things (such as uniqueness in heavily-used tables) that can be difficult to implement otherwise.</p>

<ul>
    <li>Client-side validations can be useful, but are generally unreliable if used alone. If they are implemented using JavaScript, they may be bypassed if JavaScript is turned off in the user’s browser. However, if combined with other techniques, client-side validation can be a convenient way to provide users with immediate feedback as they use your site. <span style="font-family: DejaVu Sans;">客户端验证是很有用的，但是一般情况下单独使用是靠不住的。如果他们使用</span>JavaScript<span style="font-family: DejaVu Sans;">来实施（验证），它们可能被绕过如果用户的浏览器中</span>JavaScript<span style="font-family: DejaVu Sans;">被关闭的话。然而，如果联合其他的技术，客户端验证是一种方便的方法来提供用户即使反馈（验证信息）如果他们使用你的的站点。</span></li>
    <li>Controller-level validations can be tempting to use, but often become unwieldy and difficult to test and maintain. Whenever possible, it’s a good idea to <a href="http://weblog.jamisbuck.org/2006/10/18/skinny-controller-fat-model"><span style="color: #000080;"><span style="text-decoration: underline;">keep</span></span><span style="color: #000080;"><span style="text-decoration: underline;">your</span></span><span style="color: #000080;"><span style="text-decoration: underline;">controllers</span></span><span style="color: #000080;"><span style="text-decoration: underline;">skinny</span></span></a>, as it will make your application a pleasure to work with in the long run. <span style="font-family: DejaVu Sans;">控制层的验证的使用是诱人的，但是通常变得笨重和难以测试和维护。只要有可能，它是一个保持你的控制层苗条好主意，它也使得你的应用程序愉快的长时间工作。</span></li>
    <li>Model-level validations are the best way to ensure that only valid data is saved into your database. They are database agnostic, cannot be bypassed by end users, and are convenient to test and maintain. Rails makes them easy to use, provides built-in helpers for common needs, and allows you to create your own validation methods as well. <span style="font-family: DejaVu Sans;">模板层的验证是最好的方式来确保只有有效的数据被保存进了你的数据库。它们与数据库无关，不能被终端用户绕过，并且方便测试和维护。</span>Rails<span style="font-family: DejaVu Sans;">通过提供（基于）常规需要的内建的</span>helpers<span style="font-family: DejaVu Sans;">，使得它们容易使用，并且同样允许你新建属于你的验证方法。</span></li>
</ul>


<h4>2.2 When Does Validation Happen?<span style="font-family: WenQuanYi Micro Hei;">验证在什么时候发生？</span></h4>


<p>There are two kinds of Active Record objects: those that correspond to a row inside your database and those that do not. When you create a fresh object, for example using the <tt>new</tt> method, that object does not belong to the database yet. Once you call <tt>save</tt> upon<span style="font-family: DejaVu Sans;">后</span>that object it will be saved into the appropriate database table. Active Record uses the <tt>new_record?</tt> instance method to determine whether an object is already in the database or not. Consider the following simple Active Record class:<span style="font-family: DejaVu Sans;">这里有两种</span>Active Record<span style="font-family: DejaVu Sans;">对象：一些对应于你数据库中的一行以及一些不是。当你创建一个新鲜的对象，例如使用新的方法，这个对象还不属于数据库。一旦你调用</span>save<span style="font-family: DejaVu Sans;">（函数）之后这个对象将会被适当的保存入数据表单。</span>Active Record<span style="font-family: DejaVu Sans;">使用</span><tt>new_record?</tt><span style="font-family: DejaVu Sans;"><tt>实例方法来决定一个对象是否已经被保存进了数据库。思考下面简单的</tt><tt></tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>类：</tt></span></p>

<p><code>class</code><tt> </tt><code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code>end</code></p>

<p><tt>We</tt><tt> </tt><tt>can</tt><tt> </tt><tt>see</tt><tt> </tt><tt>how</tt><tt> </tt><tt>it</tt><tt> </tt><tt>works</tt><tt> </tt><tt>by</tt><tt> </tt><tt>looking</tt><tt> </tt><tt>at</tt><tt> </tt><tt>some</tt><tt> </tt><tt>rails</tt><tt> </tt><tt>console</tt><tt> </tt><tt>output:</tt><span style="font-family: DejaVu Sans;"><tt>我们通过观察一些</tt></span><tt>rails</tt><span style="font-family: DejaVu Sans;"><tt>的控制台输可以明白它是怎么工作的：</tt></span></p>

<p><tt>$</tt><code>rails</code><code> </code><code>console</code></p>

<p><code>&gt;&gt;</code><code> </code><code>p</code><code> </code><code>=</code><code> </code><code>Person.new(:name</code><code> </code><code>=&gt;</code><code> </code><code>&ldquo;John</code><code> </code><code>Doe&rdquo;)</code></p>

<p><code>=&gt;</code><code> </code><code>#&lt;Person</code><code> </code><code>id:</code><code> </code><code>nil,</code><code> </code><code>name:</code><code> </code><code>&ldquo;John</code><code> </code><code>Doe&rdquo;,</code><code> </code><code>created_at:</code><code> </code><code>nil,</code><code> </code><code>:updated_at:</code><code> </code><code>nil&gt;</code></p>

<p><code>&gt;&gt;</code><code> </code><code>p.new_record?</code></p>

<p><code>=&gt;</code><code> </code><code>true</code></p>

<p><code>&gt;&gt;</code><code> </code><code>p.save</code></p>

<p><code>=&gt;</code><code> </code><code>true</code></p>

<p><code>&gt;&gt;</code><code> </code><code>p.new_record?</code></p>

<p><code>=&gt;</code><code> </code><code>false</code></p>

<p>Creating and saving a new record will send an SQL <tt>INSERT</tt> operation to the database. Updating an existing record will send an SQL <tt>UPDATE</tt> operation instead. Validations are typically run before these commands are sent to the database. If any validations fail, the object will be marked as invalid and Active Record will not perform the <tt>INSERT</tt> or <tt>UPDATE</tt> operation. This helps to avoid storing an invalid object in the database. You can choose to have specific validations run when an object is created, saved, or updated.<span style="font-family: DejaVu Sans;">创建和保存一个新的记录将会发送一个</span>SQL <tt>INSERT</tt><span style="font-family: DejaVu Sans;"><tt>操作到数据库。更新一个存在的记录将会发送一个</tt><tt></tt></span><tt>SQL</tt><tt> </tt><tt>UPDATE</tt><span style="font-family: DejaVu Sans;"><tt>操作。验证通常在这些命令被发送到数据库之前运行。如果任何验证失败，这个对象将会标记为非法并且</tt><tt></tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>将不会执行</tt><tt></tt></span><tt>INSERT</tt><span style="font-family: DejaVu Sans;"><tt>或</tt></span><tt>UPDATE</tt><span style="font-family: DejaVu Sans;"><tt>操作。这有助于避免存储一个非法的数据到数据库。你可以在对象被创建，保存或更新的时候选择指定的验证执行。</tt></span></p>

<p>There are many ways to change the state of an object in the database. Some methods will trigger<span style="font-family: DejaVu Sans;">触发</span>validations, but some will not. This means that it’s possible to save an object in the database in an invalid state if you aren’t careful.<span style="font-family: DejaVu Sans;">这里有很多方法来改变对象在数据库中的状态。一些方法将会触发验证，但是一些却不会。这里的意思是如果你不仔细的话就可能以一种非法的状态保存一个对象到数据库。</span></p>

<p>The following methods trigger validations, and will save the object to the database only if the object is valid:<span style="font-family: DejaVu Sans;">下面的方法触发验证，并且如果对象是合法的话将会保存对象到数据库：</span></p>

<ul>
    <li><tt>create</tt></li>
    <li><tt>create!</tt></li>
    <li><tt>save</tt></li>
    <li><tt>save!</tt></li>
    <li><tt>update</tt></li>
    <li><tt>update_attributes</tt></li>
    <li><tt>update_attributes!</tt></li>
</ul>


<p>The bang versions (e.g. <tt>save!</tt>) raise an exception if the record is invalid. The non-bang versions don’t: <tt>save</tt> and <tt>update_attributes</tt> return <tt>false</tt>, <tt>create</tt> and <tt>update</tt> just return the objects.<span style="font-family: DejaVu Sans;"><span style="color: #800000;">有感叹号的形式（例如</span></span><span style="color: #800000;">save!<span style="font-family: DejaVu Sans;">）在记录是非法的时候会唤起一个异常。没有感叹号形式的就不会：</span></span><tt><span style="color: #800000;">save</span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;">和</span></tt></span><tt><span style="color: #800000;">update_attributes</span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;">返回</span></tt></span><tt><span style="color: #800000;">false</span></tt><span style="color: #800000;">,</span><tt><span style="color: #800000;">create</span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;">和</span></tt></span><tt><span style="color: #800000;">update</span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;">只是返回这个对象</span></tt><tt>。</tt></span></p>

<h4>2.3 Skipping Validations<span style="font-family: WenQuanYi Micro Hei;">忽略验证</span></h4>


<p>The following methods skip validations, and will save the object to the database regardless<span style="font-family: DejaVu Sans;">无论</span>of its validity. They should be used with caution.<span style="font-family: DejaVu Sans;">下面的方法会略过验证，并且将会保存对象到数据库而无论它的有效性。他们应该慎重使用。</span></p>

<ul>
    <li><tt>decrement!</tt> <span style="font-family: DejaVu Sans;">递减</span></li>
    <li><tt>decrement_counter</tt></li>
    <li><tt>increment!</tt></li>
    <li><tt>increment_counter</tt></li>
    <li><tt>toggle!</tt></li>
    <li><tt>touch</tt> <span style="font-family: DejaVu Sans;">切换</span></li>
    <li><tt>update_all</tt></li>
    <li><tt>update_attribute</tt></li>
    <li><tt>update_column</tt></li>
    <li><tt>update_counters</tt></li>
</ul>


<p>Note that <tt>save</tt> also has the ability to skip validations if passed <tt>:validate</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>false</tt> as argument. This technique should be used with caution.<span style="font-family: DejaVu Sans;">注意</span>save<span style="font-family: DejaVu Sans;">也可以略过演奏如果通过使用</span><tt>:validate</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>false</tt><span style="font-family: DejaVu Sans;"><tt>作为参数。这个技术也应该慎重使用。</tt></span></p>

<ul>
    <li><tt>save(:validate</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>false)</tt></li>
</ul>


<h4>2.4 <tt>valid?</tt> and <tt>invalid?</tt></h4>


<ol>
    <li>To verify whether or not an object is valid, Rails uses the <tt>valid?</tt> method. You can also use this method on your own. <tt>valid?</tt> triggers your validations and returns true if no errors were added to the object, and false otherwise.<span style="font-family: DejaVu Sans;">验证一个对象是否有效，</span>Rails<span style="font-family: DejaVu Sans;">使用</span><tt>valid?</tt><span style="font-family: DejaVu Sans;"><tt>方法。你也可以使用属于你的方法。</tt></span><tt>valid?</tt><span style="font-family: DejaVu Sans;"><tt>触发你的验证并且返回</tt></span><tt>True</tt><span style="font-family: DejaVu Sans;"><tt>如果没有错误被添加到对象，否则就返回</tt></span><tt>false</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></li>
</ol>


<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:name,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p>&nbsp;</p>

<p><code>Person.create(:name</code> <code>=&gt;</code><code> </code><code>&ldquo;John</code><code> </code><code>Doe&rdquo;).valid?</code><code> </code><code>#</code><code> </code><code>=&gt;</code><code> </code><code>true</code></p>

<p><code>Person.create(:name</code> <code>=&gt;</code><code> </code><code>nil).valid?</code><code> </code><code>#</code><code> </code><code>=&gt;</code><code> </code><code>false</code></p>

<p>&nbsp;</p>

<p>When Active Record is performing validations, any errors found can be accessed through the <tt>errors</tt> instance method. By definition an object is valid if this collection is empty after running validations.<span style="font-family: DejaVu Sans;">当</span>Active Record<span style="font-family: DejaVu Sans;">在执行验证的时候，任何发现的错误都可以通过</span><tt>errors</tt><span style="font-family: DejaVu Sans;"><tt>实例方法来访问。通过定义一个对象是有效的如果这个集合在运行验证过后是空的。</tt></span></p>

<p>Note that an object instantiated with <tt>new</tt> will not report errors even if it’s technically invalid, because validations are not run when using <tt>new</tt>.<span style="font-family: DejaVu Sans;">注意当实例化一个新的对象的时候将不会报告错误即使假设它的验证技术（得出数据）是非有效的，因为在使用</span>new<span style="font-family: DejaVu Sans;">的时候验证是没有运行的。</span></p>

<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:name,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p>&nbsp;</p>

<p><code>&gt;&gt;</code><code> </code><code>p</code><code> </code><code>=</code><code> </code><code>Person.new</code></p>

<p><code>=&gt;</code><code> </code><code>#&lt;Person</code><code> </code><code>id:</code><code> </code><code>nil,</code><code> </code><code>name:</code><code> </code><code>nil&gt;</code></p>

<p><code>&gt;&gt;</code><code> </code><code>p.errors</code></p>

<p><code>=&gt;</code><code> </code><code>{}</code></p>

<p>&nbsp;</p>

<p><code>&gt;&gt;</code><code> </code><code>p.valid?</code></p>

<p><code>=&gt;</code><code> </code><code>false</code></p>

<p><code>&gt;&gt;</code><code> </code><code>p.errors</code></p>

<p><code>=&gt;</code><code> </code><code>{:name=&gt;[&ldquo;can&rsquo;t</code><code> </code><code>be</code><code> </code><code>blank&rdquo;]}</code></p>

<p>&nbsp;</p>

<p><code>&gt;&gt;</code><code> </code><code>p</code><code> </code><code>=</code><code> </code><code>Person.create</code></p>

<p><code>=&gt;</code><code> </code><code>#&lt;Person</code><code> </code><code>id:</code><code> </code><code>nil,</code><code> </code><code>name:</code><code> </code><code>nil&gt;</code></p>

<p><code>&gt;&gt;</code><code> </code><code>p.errors</code></p>

<p><code>=&gt;</code><code> </code><code>{:name=&gt;[&ldquo;can&rsquo;t</code><code> </code><code>be</code><code> </code><code>blank&rdquo;]}</code></p>

<p>&nbsp;</p>

<p><code>&gt;&gt;</code><code> </code><code>p.save</code></p>

<p><code>=&gt;</code><code> </code><code>false</code></p>

<p>&nbsp;</p>

<p><code>&gt;&gt;</code><code> </code><code>p.save!</code></p>

<p><code>=&gt;</code><code> </code><code>ActiveRecord::RecordInvalid:</code><code> </code><code>Validation</code><code> </code><code>failed:</code><code> </code><code>Name</code><code> </code><code>can&rsquo;t</code><code> </code><code>be</code><code> </code><code>blank</code></p>

<p>&nbsp;</p>

<p><code>&gt;&gt;</code><code> </code><code>Person.create!</code></p>

<p><code>=&gt;</code><code> </code><code>ActiveRecord::RecordInvalid:</code><code> </code><code>Validation</code><code> </code><code>failed:</code><code> </code><code>Name</code><code> </code><code>can&rsquo;t</code><code> </code><code>be</code><code> </code><code>blank</code></p>

<p>&nbsp;</p>

<p><tt>invalid?</tt> is simply the inverse of <tt>valid?</tt>. <tt>invalid?</tt> triggers your validations and returns true if any errors were added to the object, and false otherwise. <tt>invalid?</tt><span style="font-family: DejaVu Sans;"><tt>是</tt></span><tt>valid?</tt><span style="font-family: DejaVu Sans;"><tt>简单的逆。</tt></span><tt>invalid?</tt><span style="font-family: DejaVu Sans;"><tt>触发你的验证如果有任何错误添加到对象中则返回</tt></span><tt>true</tt><span style="font-family: DejaVu Sans;"><tt>，否则返回</tt></span><tt>false</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4>2.5 <tt>errors[]</tt></h4>


<p>To verify whether or not a particular attribute of an object is valid, you can use <tt>errors[:attribute]</tt>. It returns an array of all the errors for <tt>:attribute</tt>. If there are no errors on the specified attribute, an empty array is returned.<span style="font-family: DejaVu Sans;">验证一个对象具体的属性是否有效，你可以使用</span><tt>errors[:attribute]</tt><span style="font-family: DejaVu Sans;"><tt>。它返回有关</tt></span><tt>:attribute</tt><span style="font-family: DejaVu Sans;"><tt>所有错误的数组。如果指定的属性没有错误，将会返回一个空数组。</tt></span></p>

<p>This method is only useful <em>after</em> validations have been run, because it only inspects the errors collection and does not trigger validations itself. It’s different from the <tt>ActiveRecord::Base#invalid?</tt> method explained above because it doesn’t verify the validity of the object as a whole. It only checks to see whether there are errors found on an individual attribute of the object.<span style="font-family: DejaVu Sans;">这个方法只有在验证被执行过后才有用，因为它仅仅检查错误集合却不会自己触发验证。<tt>它和</tt></span><tt>ActiveRecord::Base#invalid?</tt><span style="font-family: DejaVu Sans;"><tt>方法上面解释的不同因为它不会整个验证对象的有效性。它仅仅检查这个对象的个别属性是否有错误被找到。</tt></span></p>

<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:name,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p>&nbsp;</p>

<p><code>&gt;&gt;</code><code> </code><code>Person.new.errors[:name].any?</code><code> </code><code>#</code><code> </code><code>=&gt;</code><code> </code><code>false</code></p>

<p><code>&gt;&gt;</code><code> </code><code>Person.create.errors[:name].any?</code><code> </code><code>#</code><code> </code><code>=&gt;</code><code> </code><code>true</code></p>

<p>We’ll cover validation errors in greater depth in the <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#working-with-validation-errors"><span style="color: #000080;"><span style="text-decoration: underline;">Working</span></span><span style="color: #000080;"><span style="text-decoration: underline;">with</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Validation</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Errors</span></span></a> section. For now, let’s turn to the built-in validation helpers that Rails provides by default.<span style="font-family: DejaVu Sans;">我们将会非常深入的涵盖验证错误在</span><a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#working-with-validation-errors"><span style="color: #000080;"><span style="text-decoration: underline;">Working</span></span><span style="color: #000080;"><span style="text-decoration: underline;">with</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Validation</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Errors</span></span></a><span style="font-family: DejaVu Sans;">。现在，让我们转入</span>Rails<span style="font-family: DejaVu Sans;">默认提供的内建的验证</span>helpers<span style="font-family: DejaVu Sans;">。</span></p>

<p>&nbsp;</p>

<h3>3 Validation Helpers</h3>


<p>Active Record offers many pre-defined validation helpers that you can use directly inside your class definitions. These helpers provide common validation rules. Every time a validation fails, an error message is added to the object’s <tt>errors</tt> collection, and this message is associated with the field being validated.Active Record<span style="font-family: DejaVu Sans;">提供许多预定义的你可以插入你的类中直接使用的验证</span>helpers<span style="font-family: DejaVu Sans;">。这些</span>helpers<span style="font-family: DejaVu Sans;">提供常规验证规则。每次验证失败，一个错误消息会被添加到对象的</span>errors<span style="font-family: DejaVu Sans;">集合中，并且这些消息和被验证的</span>field<span style="font-family: DejaVu Sans;">相关。</span></p>

<p>Each helper accepts an arbitrary number of attribute names, so with a single line of code you can add the same kind of validation to several attributes.<span style="font-family: DejaVu Sans;">每个</span>helper<span style="font-family: DejaVu Sans;">接受一个任意数目的属性名字，因此使用一行代码你可以给一些属性添加相同类型验证。</span></p>

<p>All of them accept the <tt>:on</tt> and <tt>:message</tt> options, which define when the validation should be run and what message should be added to the <tt>errors</tt> collection if it fails, respectively<span style="font-family: DejaVu Sans;">个别的</span>. The <tt>:on</tt> option takes one of the values <tt>:save</tt> (the default), <tt>:create</tt> or <tt>:update</tt>. There is a default error message for each one of the validation helpers. These messages are used when the <tt>:message</tt> option isn’t specified. Let’s take a look at each one of the available helpers.<span style="font-family: DejaVu Sans;">所有的（</span>helpers<span style="font-family: DejaVu Sans;">）接受</span><tt>:on</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>:message</tt><span style="font-family: DejaVu Sans;"><tt>选项，用来对个别的（</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>）定义什么时候运行验证以及如果验证失败什么消息被添加到</tt></span><tt>errors</tt><span style="font-family: DejaVu Sans;"><tt>集合。</tt></span><tt>:on</tt><span style="font-family: DejaVu Sans;"><tt>选项获取</tt></span><tt>:save</tt><tt> </tt><tt>(</tt><span style="font-family: DejaVu Sans;"><tt>默认的</tt></span><tt>),</tt><tt> </tt><tt>:create</tt><span style="font-family: DejaVu Sans;"><tt>或</tt></span><tt>:update</tt><span style="font-family: DejaVu Sans;"><tt>的值。这里每个验证</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>是默认错误消息。这些消息在</tt><tt></tt></span><tt>:message</tt><span style="font-family: DejaVu Sans;"><tt>选项没有被指定时使用。下面我们来看看每个可用的</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><tt>3.1</tt><tt> </tt><tt>acceptance</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>接受承认</tt></span></h4>


<p>Validates that a checkbox on the user interface was checked when a form was submitted. This is typically used when the user needs to agree to your application’s terms of service, confirm reading some text, or any similar concept. This validation is very specific to web applications and this ‘acceptance’ does not need to be recorded anywhere in your database (if you don’t have a field for it, the helper will just create a virtual attribute).<span style="font-family: DejaVu Sans;">这个是很特殊对于</span>web<span style="font-family: DejaVu Sans;">应用程序的验证并且这个<span style="font-family: Liberation Serif,Times New Roman,serif;">‘</span></span>acceptance’ <span style="font-family: DejaVu Sans;">不需要在你的数据库中的任何地方记录（如果没有一个它的</span>field<span style="font-family: DejaVu Sans;">，</span>helper<span style="font-family: DejaVu Sans;">将会仅仅创建一个虚拟属性）。</span></p>

<p><code>class</code><tt> </tt><code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:terms_of_service,</code><code> </code><code>:acceptance</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p><tt>The</tt><tt> </tt><tt>default</tt><tt> </tt><tt>error</tt><tt> </tt><tt>message</tt><tt> </tt><tt>for</tt><tt> </tt><tt>this</tt><tt> </tt><tt>helper</tt><tt> </tt><tt>is</tt><tt> </tt><tt><strong>“</strong></tt><em><strong>must</strong></em><em><strong> </strong></em><em><strong>be</strong></em><em><strong> </strong></em><em><strong>accepted</strong></em><tt><strong>”</strong></tt><tt>.</tt></p>

<p><tt>It</tt><tt> </tt><tt>can</tt><tt> </tt><tt>receive</tt><tt> </tt><tt>an</tt><tt> </tt><tt>:accept</tt><tt> </tt><tt>option,</tt><tt> </tt><tt>which</tt><tt> </tt><tt>determines</tt><tt> </tt><tt>the</tt><tt> </tt><tt>value</tt><tt> </tt><tt>that</tt><tt> </tt><tt>will</tt><tt> </tt><tt>be</tt><tt> </tt><tt>considered</tt><tt> </tt><tt>acceptance.</tt><tt> </tt><tt>It</tt><tt> </tt><tt>defaults</tt><tt> </tt><tt>to</tt><tt> “</tt><tt>1</tt><tt>” </tt><tt>and</tt><tt> </tt><tt>can</tt><tt> </tt><tt>be</tt><tt> </tt><tt>easily</tt><tt> </tt><tt>changed.</tt><span style="font-family: DejaVu Sans;"><tt>它可以接收一个</tt></span><tt>:accept</tt><span style="font-family: DejaVu Sans;"><tt>选项，用来决定哪个值认为是接受。默认是</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">‘</span></tt></span><tt>1</tt><tt>’</tt><span style="font-family: DejaVu Sans;"><tt>并且可以很容易更改成其他的。</tt></span></p>

<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:terms_of_service,</code><code> </code><code>:acceptance</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:accept</code> <code>=&gt;</code><code> </code><code>&lsquo;yes&rsquo;</code> <code>}</code></p>

<p><code>end</code></p>

<p>&nbsp;</p>

<h4>3.2 <tt>validates_associated</tt></h4>


<p>You should use this helper when your model has associations with other models and they also need to be validated. When you try to save your object, <tt>valid?</tt> will be called upon each one of the associated objects.</p>

<p><code>class</code> <code>Library</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>has_many</code><code> </code><code>:books</code></p>

<p><code> </code><code>validates_associated</code><code> </code><code>:books</code></p>

<p><code>end</code></p>

<p>This validation will work with all of the association types.</p>

<p><span style="color: #800000;">Don</span><span style="color: #800000;">’</span><span style="color: #800000;">t</span><span style="color: #800000;">use</span><tt><span style="color: #800000;">validates_associated</span></tt><span style="color: #800000;">on</span><span style="color: #800000;">both</span><span style="color: #800000;">ends</span><span style="color: #800000;">of</span><span style="color: #800000;">your</span><span style="color: #800000;">associations.</span><span style="color: #800000;">They</span><span style="color: #800000;">would</span><span style="color: #800000;">call</span><span style="color: #800000;">each</span><span style="color: #800000;">other</span><span style="color: #800000;">in</span><span style="color: #800000;">an</span><span style="color: #800000;">infinite<span style="font-family: DejaVu Sans;">无限</span></span><span style="color: #800000;">loop.</span></p>

<p>The default error message for <tt>validates_associated</tt> is “<em>is</em><em> </em><em>invalid</em>”. Note that each associated object will contain its own <tt>errors</tt> collection; errors do not bubble up<span style="font-family: DejaVu Sans;">冒泡</span>to the calling model.</p>

<p>&nbsp;</p>

<h4>3.3 <tt>confirmation</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>确认</tt></span></h4>


<p>You should use this helper when you have two text fields that should receive exactly the same content. For example, you may want to confirm an email address or a password. This validation creates a virtual attribute whose name is the name of the field that has to be confirmed with “_confirmation” appended.</p>

<p><span style="font-family: DejaVu Sans;">你应该使用这个</span>helper<span style="font-family: DejaVu Sans;">当你有两个内容完全相同的文本框需要回收。（验证输入）</span></p>

<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:email,</code><code> </code><code>:confirmation</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p>In your view template you could use something like</p>

<p><code>&lt;%=</code> <code>text_field</code><code> </code><code>:person,</code><code> </code><code>:email</code> <code>%&gt;</code></p>

<p><code>&lt;%=</code> <code>text_field</code><code> </code><code>:person,</code><code> </code><code>:email_confirmation</code> <code>%&gt;</code></p>

<p>&nbsp;</p>

<p>This check is performed only if <tt>email_confirmation</tt> is not <tt>nil</tt>. To require confirmation, make sure to add a presence check for the confirmation attribute (we’ll take a look at <tt>presence</tt> later on this guide):</p>

<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:email,</code><code> </code><code>:confirmation</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code> </code><code>validates</code><code> </code><code>:email_confirmation,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p>The default error message for this helper is “<em>doesn</em><em>’</em><em>t</em><em> </em><em>match</em><em> </em><em>confirmation</em>”.</p>

<h4>3.4 <tt>exclusion</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>排除</tt></span></h4>


<p>This helper validates that the attributes’ values are not included in a given set. In fact, this set can be any enumerable<span style="font-family: DejaVu Sans;">列举</span>object.</p>

<p><code>class</code> <code>Account</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:subdomain,</code><code> </code><code>:exclusion</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:in</code> <code>=&gt;</code><code> </code><code>%w(www</code><code> </code><code>us</code><code> </code><code>ca</code><code> </code><code>jp),</code></p>

<p><code> </code><code>:message</code> <code>=&gt;</code><code> </code><code>&ldquo;Subdomain</code><code> </code><code>%{value}</code><code> </code><code>is</code><code> </code><code>reserved.&rdquo;</code> <code>}</code></p>

<p><code>end</code></p>

<p>The <tt>exclusion</tt> helper has an option <tt>:in</tt> that receives the set of values that will not be accepted for the validated attributes. The <tt>:in</tt> option has an alias called <tt>:within</tt> that you can use for the same purpose<span style="font-family: DejaVu Sans;">目的</span>, if you’d like to. This example uses the <tt>:message</tt> option to show how you can include the attribute’s value.</p>

<p>The default error message is “<em>is</em><em> </em><em>reserved</em>”.</p>

<h4>3.5 <tt>format</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>格式（匹配）</tt></span></h4>


<p>This helper validates the attributes’ values by testing whether they match a given regular expression<span style="font-family: DejaVu Sans;"><span style="color: #800000;">正则表达式</span></span>, which is specified using the <tt>:with</tt> option.</p>

<p><code>class</code> <code>Product</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:legacy_code,</code><code> </code><code>:format</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:with</code> <code>=&gt;</code><code> </code><code>/\A[a-zA-Z]+\z/,</code></p>

<p><code> </code><code>:message</code> <code>=&gt;</code><code> </code><code>&ldquo;Only</code><code> </code><code>letters</code><code> </code><code>allowed&rdquo;</code> <code>}</code></p>

<p><code>end</code></p>

<p>The default error message is “<em>is</em><em> </em><em>invalid</em>”.</p>

<h4>3.6 <tt>inclusion</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>列入</tt></span></h4>


<p>This helper validates that the attributes’ values are included in a given set. In fact, this set can be any enumerable object.</p>

<p><code>class</code> <code>Coffee</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:size,</code><code> </code><code>:inclusion</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:in</code> <code>=&gt;</code><code> </code><code>%w(small</code><code> </code><code>medium</code><code> </code><code>large),</code></p>

<p><code> </code><code>:message</code> <code>=&gt;</code><code> </code><code>&ldquo;%{value}</code><code> </code><code>is</code><code> </code><code>not</code><code> </code><code>a</code><code> </code><code>valid</code><code> </code><code>size&rdquo;</code> <code>}</code></p>

<p><code>end</code></p>

<p>The <tt>inclusion</tt> helper has an option <tt>:in</tt> that receives the set of values that will be accepted. The <tt>:in</tt> option has an alias called <tt>:within</tt> that you can use for the same purpose, if you’d like to. The previous example uses the <tt>:message</tt> option to show how you can include the attribute’s value.</p>

<p>The default error message for this helper is “<em>is</em><em> </em><em>not</em><em> </em><em>included</em><em> </em><em>in</em><em> </em><em>the</em><em> </em><em>list</em>”.</p>

<h4>3.7 <tt>length</tt></h4>


<p>This helper validates the length of the attributes’ values. It provides a variety of options, so you can specify length constraints in different ways:</p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates :name, :length =&gt; { :minimum =&gt; 2 }</p>

<p>validates :bio, :length =&gt; { :maximum =&gt; 500 }</p>

<p>validates :password, :length =&gt; { :in =&gt; 6..20 }</p>

<p>validates :registration_number, :length =&gt; { :is =&gt; 6 }</p>

<p>end</p>

<p>The possible length constraint<span style="font-family: DejaVu Sans;">约束</span>options are:</p>

<ul>
    <li><tt>:minimum</tt> – The attribute cannot have less than the specified length.</li>
    <li><tt>:maximum</tt> – The attribute cannot have more than the specified length.</li>
    <li><tt>:in</tt> (or <tt>:within</tt>) – The attribute length must be included in a given interval. The value for this option must be a range.</li>
    <li><tt>:is</tt> – The attribute length must be equal to the given value.</li>
</ul>


<p>The default error messages depend on the type of length validation being performed. <span style="color: #800000;">You</span><span style="color: #800000;">can</span><span style="color: #800000;">personalize</span><span style="color: #800000;">these</span><span style="color: #800000;">messages</span><span style="color: #800000;">using</span><span style="color: #800000;">the</span><tt><span style="color: #800000;">:wrong_length</span></tt><span style="color: #800000;">,</span><tt><span style="color: #800000;">:too_long</span></tt><span style="color: #800000;">,</span><span style="color: #800000;">and</span><tt><span style="color: #800000;">:too_short</span></tt><span style="color: #800000;">options</span><span style="color: #800000;">and</span><tt><span style="color: #800000;">%{count}</span></tt><span style="color: #800000;">as</span><span style="color: #800000;">a</span><span style="color: #800000;">placeholder</span><span style="color: #800000;">for</span><span style="color: #800000;">the</span><span style="color: #800000;">number</span><span style="color: #800000;">corresponding</span><span style="color: #800000;">to</span><span style="color: #800000;">the</span><span style="color: #800000;">length</span><span style="color: #800000;">constraint</span><span style="color: #800000;">being</span><span style="color: #800000;">used.</span>You can still use the <tt>:message</tt> option to specify an error message.</p>

<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:bio,</code><code> </code><code>:length</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:maximum</code> <code>=&gt;</code><code> </code><code>1000,</code></p>

<p><code> </code><code>:too_long</code> <code>=&gt;</code><code> </code><code>&ldquo;%{count}</code><code> </code><code>characters</code><code> </code><code>is</code><code> </code><code>the</code><code> </code><code>maximum</code><code> </code><code>allowed&rdquo;</code> <code>}</code></p>

<p><code>end</code></p>

<p>This helper counts characters by default, but you can split the value in a different way using the <tt>:tokenizer</tt> option:</p>

<p><code>class</code> <code>Essay</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:content,</code><code> </code><code>:length</code> <code>=&gt;</code><code> </code><code>{</code></p>

<p><code> </code><code>:minimum</code><code> </code> <code>=&gt;</code><code> </code><code>300,</code></p>

<p><code> </code><code>:maximum</code><code> </code> <code>=&gt;</code><code> </code><code>400,</code></p>

<p><code> </code><code>:tokenizer</code> <code>=&gt;</code><code> </code><code>lambda</code><code> </code><code>{</code><code> </code><code>|str|</code><code> </code><code>str.scan(/\w+/)</code><code> </code><code>},</code></p>

<p><code> </code><code>:too_short</code> <code>=&gt;</code><code> </code><code>&ldquo;must</code><code> </code><code>have</code><code> </code><code>at</code><code> </code><code>least</code><code> </code><code>%{count}</code><code> </code><code>words&rdquo;,</code></p>

<p><code> </code><code>:too_long</code><code> </code> <code>=&gt;</code><code> </code><code>&ldquo;must</code><code> </code><code>have</code><code> </code><code>at</code><code> </code><code>most</code><code> </code><code>%{count}</code><code> </code><code>words&rdquo;</code></p>

<p><code> </code><code>}</code></p>

<p><code>end</code></p>

<p>Note that the default error messages are plural<span style="font-family: DejaVu Sans;">多元的</span>(e.g., “is too short (minimum is %{count} characters)”). For this reason, when <tt>:minimum</tt> is 1 you should provide a personalized<span style="font-family: DejaVu Sans;">个性化</span>message or use <tt>validates_presence_of</tt> instead. When <tt>:in</tt> or <tt>:within</tt> have a lower limit of 1, you should either provide a personalized message or call <tt>presence</tt> prior<span style="font-family: DejaVu Sans;">前</span>to <tt>length</tt>.<span style="font-family: DejaVu Sans;">（当长度比</span>1<span style="font-family: DejaVu Sans;">还小就为空了应该使用</span><tt>validates_presence_of</tt><span style="font-family: DejaVu Sans;"><tt>来验证</tt>）</span></p>

<p>The <tt>size</tt> helper is an alias for <tt>length</tt>.</p>

<h4>3.8 <tt>numericality</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>只能输入数字</tt></span></h4>


<p>This helper validates that your attributes have only numeric values. By default, it will match an optional sign followed by an integral or floating point number. To specify that only integral numbers are allowed set <tt>:only_integer</tt> to true.</p>

<p>If you set <tt>:only_integer</tt> to <tt>true</tt>, then it will use the</p>

<p><code>/\A[+&ndash;]?\d+\Z/</code></p>

<p>regular expression to validate the attribute’s value. Otherwise, it will try to convert the value to a number using <tt>Float</tt>.</p>

<p><span style="color: #800000;">Note</span><span style="color: #800000;">that</span><span style="color: #800000;">the</span><span style="color: #800000;">regular</span><span style="color: #800000;">expression</span><span style="color: #800000;">above</span><span style="color: #800000;">allows</span><span style="color: #800000;">a</span><span style="color: #800000;">trailing</span><span style="color: #800000;">newline</span><span style="color: #800000;">character.<span style="font-family: DejaVu Sans;">请注意，上面的正则表达式允许一个尾随的换行符</span></span></p>

<p><code>class</code> <code>Player</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:points,</code><code> </code><code>:numericality</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code> </code><code>validates</code><code> </code><code>:games_played,</code><code> </code><code>:numericality</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:only_integer</code> <code>=&gt;</code><code> </code><code>true</code> <code>}</code></p>

<p><code>end</code></p>

<p>Besides <tt>:only_integer</tt>, this helper also accepts the following options to add constraints to acceptable values:</p>

<ul>
    <li><tt>:greater_than</tt> – Specifies the value must be greater than the supplied value. The default error message for this option is “<em>must</em><em> </em><em>be</em><em> </em><em>greater</em><em> </em><em>than</em><em> </em><em>%{count}</em>”. <span style="font-family: DejaVu Sans;">大于</span></li>
    <li><tt>:greater_than_or_equal_to</tt> – Specifies the value must be greater than or equal to the supplied value. The default error message for this option is “<em>must</em><em> </em><em>be</em><em> </em><em>greater</em><em> </em><em>than</em><em> </em><em>or</em><em> </em><em>equal</em><em> </em><em>to</em><em> </em><em>%{count}</em>”.</li>
    <li><tt>:equal_to</tt> – Specifies the value must be equal to the supplied value. The default error message for this option is “<em>must</em><em> </em><em>be</em><em> </em><em>equal</em><em> </em><em>to</em><em> </em><em>%{count}</em>”.</li>
    <li><tt>:less_than</tt> – Specifies the value must be less than the supplied value. The default error message for this option is “<em>must</em><em> </em><em>be</em><em> </em><em>less</em><em> </em><em>than</em><em> </em><em>%{count}</em>”.</li>
    <li><tt>:less_than_or_equal_to</tt> – Specifies the value must be less than or equal the supplied value. The default error message for this option is “<em>must</em><em> </em><em>be</em><em> </em><em>less</em><em> </em><em>than</em><em> </em><em>or</em><em> </em><em>equal</em><em> </em><em>to</em><em> </em><em>%{count}</em>”.</li>
    <li><tt>:odd</tt> – Specifies the value must be an odd number if set to true. The default error message for this option is “<em>must</em><em> </em><em>be</em><em> </em><em>odd</em>”. <span style="font-family: DejaVu Sans;">奇数</span></li>
    <li><tt>:even</tt> – Specifies the value must be an even number if set to true. The default error message for this option is “<em>must</em><em> </em><em>be</em><em> </em><em>even</em>”. <span style="font-family: DejaVu Sans;">偶数</span></li>
</ul>


<p>The default error message is “<em>is</em><em> </em><em>not</em><em> </em><em>a</em><em> </em><em>number</em>”.</p>

<h4>3.9 <tt>presence</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>存在</tt></span></h4>


<p>This helper validates that the specified attributes are not empty. It uses the <tt>blank?</tt> method to check if the value is either <tt>nil</tt> or a blank string, that is, a string that is either empty or consists of whitespace.</p>

<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:name,</code><code> </code><code>:login,</code><code> </code><code>:email,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p>If you want to be sure that an association is present, you’ll need to test whether the foreign key used to map the association is present, and not the associated object itself.</p>

<p><code>class</code> <code>LineItem</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>belongs_to</code><code> </code><code>:order</code></p>

<p><code> </code><code>validates</code><code> </code><code>:order_id,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p>Since <tt>false.blank?</tt> is true, if you want to validate the presence of a boolean field you should use <tt>validates</tt><tt> </tt><tt>:field_name,</tt><tt> </tt><tt>:inclusion</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>{</tt><tt> </tt><tt>:in</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>[true,</tt><tt> </tt><tt>false]</tt><tt> </tt><tt>}</tt>.</p>

<p>The default error message is “<em>can</em><em>’</em><em>t</em><em> </em><em>be</em><em> </em><em>empty</em>”.</p>

<h4>3.10 <tt>uniqueness</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>独特性</tt></span></h4>


<p>This helper validates that the attribute’s value is unique right before the object gets saved. It does not create a uniqueness constraint in the database, so it may happen that two different database connections create two records with the same value for a column that you intend to be unique. To avoid that, you must create a unique index in your database.</p>

<p><code>class</code> <code>Account</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:email,</code><code> </code><code>:uniqueness</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p>The validation happens by performing an SQL query into the model’s table, searching for an existing record with the same value in that attribute.</p>

<p>There is a <tt>:scope</tt><span style="font-family: DejaVu Sans;"><tt>范围</tt></span>option that you can use to specify other attributes that are used to limit the uniqueness check:</p>

<p><code>class</code> <code>Holiday</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:name,</code><code> </code><code>:uniqueness</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:scope</code> <code>=&gt;</code><code> </code><code>:year,</code></p>

<p><code> </code><code>:message</code> <code>=&gt;</code><code> </code><code>&ldquo;should</code><code> </code><code>happen</code><code> </code><code>once</code><code> </code><code>per</code><code> </code><code>year&rdquo;</code> <code>}</code></p>

<p><code>end</code></p>

<p>There is also a <tt>:case_sensitive</tt> option that you can use to define whether the uniqueness constraint<span style="font-family: DejaVu Sans;">约束</span>will be case sensitive<span style="font-family: DejaVu Sans;">敏感</span>or not. This option defaults to true.</p>

<p><code>class</code> <code>Person</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:name,</code><code> </code><code>:uniqueness</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:case_sensitive</code> <code>=&gt;</code><code> </code><code>false</code> <code>}</code></p>

<p><code>end</code></p>

<p>Note that some databases are configured to perform case-insensitive searches anyway.<span style="font-family: DejaVu Sans;">需要注意的是一些数据库配置为执行区分大小写的搜索。</span></p>

<p>The default error message is “<em>has</em><em> </em><em>already</em><em> </em><em>been</em><em> </em><em>taken</em>”.</p>

<h4>3.11 <tt>validates_with</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>通过指定类验证</tt></span></h4>


<p>This helper passes the record to a separate class for validation.</p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates_with GoodnessValidator</p>

<p>end</p>

<p>&nbsp;</p>

<p>class GoodnessValidator &lt; ActiveModel::Validator</p>

<p>def validate(record)</p>

<p>if record.first_name == &ldquo;Evil&rdquo;</p>

<p>record.errors[:base] &lt;&lt; &ldquo;This person is evil&rdquo;</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>The <tt>validates_with</tt> helper takes a class, or a list of classes to use for validation. There is no default error message for <tt>validates_with</tt>. You must manually add errors to the record’s errors collection in the validator class.</p>

<p>To implement the validate method, you must have a <tt>record</tt> parameter defined, which is the record to be validated.</p>

<p>Like all other validations, <tt>validates_with</tt> takes the <tt>:if</tt>, <tt>:unless</tt> and <tt>:on</tt> options. If you pass any other options, it will send those options to the validator class as <tt>options</tt>:</p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates_with GoodnessValidator, :fields =&gt; [:first_name, :last_name]</p>

<p>end</p>

<p>&nbsp;</p>

<p>class GoodnessValidator &lt; ActiveModel::Validator</p>

<p>def validate(record)</p>

<p>if options[:fields].any?{|field| record.send(field) == &ldquo;Evil&rdquo; }</p>

<p>record.errors[:base] &lt;&lt; &ldquo;This person is evil&rdquo;</p>

<p>end</p>

<p>end</p>

<p>end</p>

<h4>3.12 <tt>validates_each</tt></h4>


<p>This helper validates attributes against a block. It doesn’t have a predefined validation function. You should create one using a block, and every attribute passed to <tt>validates_each</tt> will be tested against it. In the following example, we don’t want names and surnames to begin with lower case.</p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates_each :name, :surname do |model, attr, value|</p>

<p>model.errors.add(attr, &lsquo;must start with upper case&rsquo;) if value =~ /\A[a-z]/</p>

<p>end</p>

<p>end</p>

<p>The block receives the model, the attribute’s name and the attribute’s value. You can do anything you like to check for valid data within the block. If your validation fails, you can add an error message to the model, therefore<span style="font-family: DejaVu Sans;">故</span>making it invalid.</p>

<h3>4 Common Validation Options<span style="font-family: WenQuanYi Micro Hei;">常规验证选项</span></h3>


<p>These are common validation options:</p>

<h4>4.1 <tt>:allow_nil</tt></h4>


<p>The <tt>:allow_nil</tt> option skips the validation when the value being validated is <tt>nil</tt>.</p>

<p>class Coffee &lt; ActiveRecord::Base</p>

<p>validates :size, :inclusion =&gt; { :in =&gt; %w(small medium large),</p>

<p>:message =&gt; &ldquo;%{value} is not a valid size&rdquo; }, :allow_nil =&gt; true</p>

<p>end</p>

<p><tt><span style="color: #800000;">:allow_nil</span></tt><span style="color: #800000;">is</span><span style="color: #800000;">ignored</span><span style="color: #800000;">by</span><span style="color: #800000;">the</span><span style="color: #800000;">presence</span><span style="color: #800000;">validator.</span></p>

<h4>4.2 <tt>:allow_blank</tt></h4>


<p>The <tt>:allow_blank</tt> option is similar to the <tt>:allow_nil</tt> option. This option will let validation pass if the attribute’s value is <tt>blank?</tt>, like <tt>nil</tt> or an empty string for example.</p>

<p>class Topic &lt; ActiveRecord::Base</p>

<p>validates :title, :length =&gt; { :is =&gt; 5 }, :allow_blank =&gt; true</p>

<p>end</p>

<p>&nbsp;</p>

<p>Topic.create(&ldquo;title&rdquo; =&gt; &ldquo;&rdquo;).valid? # =&gt; true</p>

<p>Topic.create(&ldquo;title&rdquo; =&gt; nil).valid? # =&gt; true</p>

<p><tt><span style="color: #800000;">:allow_blank</span></tt><span style="color: #800000;">is</span><span style="color: #800000;">ignored</span><span style="color: #800000;">by</span><span style="color: #800000;">the</span><span style="color: #800000;">presence</span><span style="color: #800000;">validator.</span></p>

<h4>4.3 <tt>:message</tt></h4>


<p>As you’ve already seen, the <tt>:message</tt> option lets you specify the message that will be added to the <tt>errors</tt> collection when validation fails. When this option is not used, Active Record will use the respective default error message for each validation helper.</p>

<h4>4.4 <tt>:on</tt></h4>


<p>The <tt>:on</tt> option lets you specify when the validation should happen. The default behavior for all the built-in validation helpers is to be run on save (both when you’re creating a new record and when you’re updating it). If you want to change it, you can use <tt>:on</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:create</tt> to run the validation only when a new record is created or <tt>:on</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:update</tt> to run the validation only when a record is updated.<tt>:on</tt> <span style="font-family: DejaVu Sans;">选项让你指定什么时候产生验证。</span></p>

<p>class Person &lt; ActiveRecord::Base</p>

<h1>it will be possible to update email with a duplicated value</h1>

<p>validates :email, :uniqueness =&gt; true, :on =&gt; :create</p>

<p>&nbsp;</p>

<h1>it will be possible to create the record with a non-numerical age</h1>

<p>validates :age, :numericality =&gt; true, :on =&gt; :update</p>

<p>&nbsp;</p>

<h1>the default (validates on both create and update)</h1>

<p>validates :name, :presence =&gt; true, :on =&gt; :save</p>

<p>end</p>

<h3>5 Conditional Validation<span style="font-family: WenQuanYi Micro Hei;">有附加条件的验证</span></h3>


<p>Sometimes it will make sense<span style="font-family: DejaVu Sans;">感觉</span>to validate an object just when a given predicate is satisfied. You can do that by using the <tt>:if</tt> and <tt>:unless</tt> options, which can take a symbol, a string or a <tt>Proc</tt>. You may use the <tt>:if</tt> option when you want to specify when the validation <strong>should</strong> happen. If you want to specify when the validation <strong>should</strong><strong> </strong><strong>not</strong> happen, then you may use the <tt>:unless</tt> option.</p>

<p><span style="font-family: DejaVu Sans;">有时候验证一个对象的时候如果给你一个判定性的（语句）你会感觉到满足。你可以使用</span>:if<span style="font-family: DejaVu Sans;">和</span>:unless<span style="font-family: DejaVu Sans;">选项达到这样的效果，它可以（判断）一个符号（标记），字符串或者是</span>Proc<span style="font-family: DejaVu Sans;">。</span></p>

<p>&nbsp;</p>

<p><em>Proc</em><em> </em><span style="font-family: DejaVu Sans;"><em>是</em></span><em>Ruby</em><em> </em><span style="font-family: DejaVu Sans;"><em>对</em></span><em>block</em><span style="font-family: DejaVu Sans;"><em>的面向对象的封装。</em></span></p>

<p>&nbsp;</p>

<h4>5.1 Using a Symbol with <tt>:if</tt> and <tt>:unless</tt></h4>


<p>You can associate the <tt>:if</tt> and <tt>:unless</tt> options with a symbol corresponding to the name of a method that will get called right before validation happens. This is the most commonly used option.</p>

<p>class Order &lt; ActiveRecord::Base</p>

<p>validates :card_number, :presence =&gt; true, :if =&gt; :paid_with_card?</p>

<p>&nbsp;</p>

<p>def paid_with_card?</p>

<p>payment_type == &ldquo;card&rdquo;</p>

<p>end</p>

<p>end</p>

<h4>5.2 Using a String with <tt>:if</tt> and <tt>:unless</tt></h4>


<p><span style="color: #800000;">You</span><span style="color: #800000;">can</span><span style="color: #800000;">also</span><span style="color: #800000;">use</span><span style="color: #800000;">a</span><span style="color: #800000;">string</span><span style="color: #800000;">that</span><span style="color: #800000;">will</span><span style="color: #800000;">be</span><span style="color: #800000;">evaluated</span><span style="color: #800000;">using</span><tt><span style="color: #800000;">eval</span></tt><span style="color: #800000;">and</span><span style="color: #800000;">needs</span><span style="color: #800000;">to</span><span style="color: #800000;">contain</span><span style="color: #800000;">valid</span><span style="color: #800000;">Ruby</span><span style="color: #800000;">code.</span>You should use this option only when the string represents a really short condition.</p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates :surname, :presence =&gt; true, :if =&gt; &ldquo;name.nil?&rdquo;</p>

<p>end</p>

<h4>5.3 Using a Proc with <tt>:if</tt> and <tt>:unless</tt></h4>


<p>Finally, it’s possible to associate <tt>:if</tt> and <tt>:unless</tt> with a <tt>Proc</tt> object which will be called. Using a <tt>Proc</tt> object gives you the ability to write an inline condition instead of a separate<span style="font-family: DejaVu Sans;">单独</span>method. This option is best suited for one-liners.</p>

<p>class Account &lt; ActiveRecord::Base</p>

<p>validates :password, :confirmation =&gt; true,</p>

<p>:unless =&gt; Proc.new { |a| a.password.blank? }</p>

<p>end</p>

<h4>5.4 Grouping conditional validations</h4>


<p>Sometimes it is useful to have multiple validations use one condition, it can be easily achieved using <tt>with_options</tt>.</p>

<p>class User &lt; ActiveRecord::Base</p>

<p>with_options :if =&gt; :is_admin? do |admin|</p>

<p>admin.validates :password, :length =&gt; { :minimum =&gt; 10 }</p>

<p>admin.validates :email, :presence =&gt; true</p>

<p>end</p>

<p>end</p>

<p>All validations inside of <tt>with_options</tt> block will have automatically passed the condition <tt>:if</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:is_admin?</tt></p>

<h3><tt>6</tt><tt> </tt><tt>Performing</tt><tt> </tt><tt>Custom</tt><tt> </tt><tt>Validations</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>执行定制验证</tt></span></h3>


<p><tt>When</tt><tt> </tt><tt>the</tt><tt> </tt><tt>built-in</tt><tt> </tt><tt>validation</tt><tt> </tt><tt>helpers</tt><tt> </tt><tt>are</tt><tt> </tt><tt>not</tt><tt> </tt><tt>enough</tt><tt> </tt><tt>for</tt><tt> </tt><tt>your</tt><tt> </tt><tt>needs,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>write</tt><tt> </tt><tt>your</tt><tt> </tt><tt>own</tt><tt> </tt><tt>validators</tt><tt> </tt><tt>or</tt><tt> </tt><tt>validation</tt><tt> </tt><tt>methods</tt><tt> </tt><tt>as</tt><tt> </tt><tt>you</tt><tt> </tt><tt>prefer.</tt></p>

<h4>6.1 Custom Validators<span style="font-family: WenQuanYi Micro Hei;">定制验证器</span></h4>


<p>Custom validators are classes that extend <tt>ActiveModel::Validator</tt>. These classes must implement a <tt>validate</tt> method which takes a record as an argument and performs the validation on it. The custom validator is called using the <tt>validates_with</tt> method.</p>

<p>class MyValidator &lt; ActiveModel::Validator</p>

<p>def validate(record)</p>

<p>if record.name.starts_with? &lsquo;X&rsquo;</p>

<p>record.errors[:name] &lt;&lt; &lsquo;Need a name starting with X please!&rsquo;</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>class Person</p>

<p>include ActiveModel::Validations</p>

<p>validates_with MyValidator</p>

<p>end</p>

<p>The easiest way to add custom validators for validating individual attributes is with the convenient <tt>ActiveModel::EachValidator</tt>. In this case, the custom validator class must implement<span style="font-family: DejaVu Sans;">实施落实</span>a <tt>validate_each</tt> method which takes three arguments: record, attribute and value which correspond<span style="font-family: DejaVu Sans;">对应</span>to the instance, the attribute to be validated and the value of the attribute in the passed instance.</p>

<p><span style="font-family: DejaVu Sans;">最简单的方法添加（需要）验证个别的属性到定制的</span>validatoras<span style="font-family: DejaVu Sans;">是便捷的使用</span><tt>ActiveModel::EachValidator</tt><span style="font-family: DejaVu Sans;"><tt>。在这个案例中，定制的</tt></span><tt>validator</tt><span style="font-family: DejaVu Sans;"><tt>类必须落实</tt><tt></tt></span><tt>validate_each</tt><span style="font-family: DejaVu Sans;"><tt>方法获得三个参数：与实例对应的</tt></span><tt>record,</tt><tt> </tt><tt>attribute</tt><tt> </tt><tt>and</tt><tt> </tt><tt>value</tt><span style="font-family: DejaVu Sans;"><tt>，（它们是）接下来的实例的属性和值</tt></span></p>

<p>class EmailValidator &lt; ActiveModel::EachValidator</p>

<p>def validate_each(record, attribute, value)</p>

<p>unless value =~ /\A([^@\s]+)@((?:[-a-z0-9]+.)+[a-z]{2,})\z/i</p>

<p>record.errors[attribute] &lt;&lt; (options[:message] || &ldquo;is not an email&rdquo;)</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates :email, :presence =&gt; true, :email =&gt; true</p>

<p>end</p>

<p>As shown in the example, you can also combine<span style="font-family: DejaVu Sans;">结合</span>standard validations with your own custom validators.</p>

<p>&nbsp;</p>

<h4>6.2 Custom Methods<span style="font-family: WenQuanYi Micro Hei;">定制（验证）方法</span></h4>


<p>You can also create methods that verify the state of your models and add messages to the <tt>errors</tt> collection when they are invalid. You must then register these methods by using one or more of the <tt>validate</tt>, <tt>validate_on_create</tt> or <tt>validate_on_update</tt> class methods, passing in the symbols<span style="font-family: DejaVu Sans;">符号</span>for the validation methods’ names.</p>

<p><span style="font-family: DejaVu Sans;">你也可以创建方法验证你</span>models<span style="font-family: DejaVu Sans;">的状态以及在被验证的时候添加消息到</span>errors<span style="font-family: DejaVu Sans;">集合。你必须注册这些方法通过使用一个或多个这些方法：</span><tt>validate</tt>, <tt>validate_on_create</tt> or <tt>validate_on_update</tt><span style="font-family: DejaVu Sans;"><tt>类方法加上验证方法的名字。</tt></span></p>

<p>You can pass more than one symbol for each class method and the respective<span style="font-family: DejaVu Sans;">各自的</span>validations will be run in the same order as they were registered.<span style="font-family: DejaVu Sans;">你可以添加一个或多个符号给（对应的）每一个类方法并且各自的验证将会按照与注册相同的顺序运行。</span></p>

<p>class Invoice &lt; ActiveRecord::Base</p>

<p>validate :expiration_date_cannot_be_in_the_past,</p>

<p>:discount_cannot_be_greater_than_total_value</p>

<p>&nbsp;</p>

<p>def expiration_date_cannot_be_in_the_past</p>

<p>if !expiration_date.blank? and expiration_date &lt; Date.today</p>

<p>errors.add(:expiration_date, &ldquo;can&rsquo;t be in the past&rdquo;)</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>def discount_cannot_be_greater_than_total_value</p>

<p>if discount &gt; total_value</p>

<p>errors.add(:discount, &ldquo;can&rsquo;t be greater than total value&rdquo;)</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p><span style="color: #800000;">You</span><span style="color: #800000;">can</span><span style="color: #800000;">even</span><span style="color: #800000;">create</span><span style="color: #800000;">your</span><span style="color: #800000;">own</span><span style="color: #800000;">validation</span><span style="color: #800000;">helpers</span><span style="color: #800000;">and</span><span style="color: #800000;">reuse</span><span style="color: #800000;">them</span><span style="color: #800000;">in</span><span style="color: #800000;">several</span><span style="color: #800000;">different</span><span style="color: #800000;">models.</span> For example, an application that manages surveys<span style="font-family: DejaVu Sans;">调查</span>may find it useful to express that a certain<span style="font-family: DejaVu Sans;">某些</span>field corresponds<span style="font-family: DejaVu Sans;">对应</span>to a set of choices:</p>

<p>ActiveRecord::Base.class_eval do</p>

<p>def self.validates_as_choice(attr_name, n, options={})</p>

<p>validates attr_name, :inclusion =&gt; { {:in =&gt; 1..n}.merge(options) }</p>

<p>end</p>

<p>end</p>

<p>Simply reopen <tt>ActiveRecord::Base</tt> and define a class method like that. You’d typically put this code somewhere in <tt>config/initializers</tt>. You can use this helper like this:</p>

<p>class Movie &lt; ActiveRecord::Base</p>

<p>validates_as_choice :rating, 5</p>

<p>end</p>

<h3>7 Working with Validation Errors<span style="font-family: WenQuanYi Micro Hei;">工作与</span>Validation Errors</h3>


<p>In addition to<span style="font-family: DejaVu Sans;">除了</span>the <tt>valid?</tt> and <tt>invalid?</tt> methods covered earlier, Rails provides a number of methods for working with the <tt>errors</tt> collection and inquiring<span style="font-family: DejaVu Sans;">疑问</span>about the validity of objects.</p>

<p><span style="color: #800000;">The</span><span style="color: #800000;">following</span><span style="color: #800000;">is</span><span style="color: #800000;">a</span><span style="color: #800000;">list</span><span style="color: #800000;">of</span><span style="color: #800000;">the</span><span style="color: #800000;">most</span><span style="color: #800000;">commonly</span><span style="color: #800000;">used</span><span style="color: #800000;">methods.</span><span style="color: #800000;">Please</span><span style="color: #800000;">refer</span><span style="color: #800000;">to</span><span style="color: #800000;">the</span><tt><span style="color: #800000;">ActiveRecord::Errors</span></tt><span style="color: #800000;">documentation</span><span style="color: #800000;">for</span><span style="color: #800000;">a</span><span style="color: #800000;">list</span><span style="color: #800000;">of</span><span style="color: #800000;">all</span><span style="color: #800000;">the</span><span style="color: #800000;">available</span><span style="color: #800000;">methods.</span></p>

<h4>7.1 <tt>errors</tt></h4>


<p>Returns an OrderedHash with all errors. Each<strong> </strong><strong>key</strong><strong> </strong><strong>is</strong><strong> </strong><strong>the</strong><strong> </strong><strong>attribute</strong><strong> </strong><strong>name</strong> and the <strong>value</strong><strong> </strong><strong>is</strong><strong> </strong><strong>an</strong><strong> </strong><strong>array</strong><strong> </strong><strong>of</strong><strong> </strong><strong>strings</strong><strong> </strong><strong>with</strong><strong> </strong><strong>all</strong><strong> </strong><strong>errors.</strong></p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates :name, :presence =&gt; true, :length =&gt; { :minimum =&gt; 3 }</p>

<p>end</p>

<p>&nbsp;</p>

<p>person = Person.new</p>

<p>person.valid? # =&gt; false</p>

<p>person.errors</p>

<h1>=&gt; {:name =&gt; [&ldquo;can&rsquo;t be blank&rdquo;, &ldquo;is too short (minimum is 3 characters)&rdquo;]}</h1>

<p>&nbsp;</p>

<p>person = Person.new(:name =&gt; &ldquo;John Doe&rdquo;)</p>

<p>person.valid? # =&gt; true</p>

<p>person.errors # =&gt; []</p>

<h4>7.2 <tt>errors[]</tt></h4>


<p><tt><strong>errors[]</strong></tt><strong> </strong><strong>is</strong><strong> </strong><strong>used</strong><strong> </strong><strong>when</strong><strong> </strong><strong>you</strong><strong> </strong><strong>want</strong><strong> </strong><strong>to</strong><strong> </strong><strong>check</strong><strong> </strong><strong>the</strong><strong> </strong><strong>error</strong><strong> </strong><strong>messages</strong><strong> </strong><strong>for</strong><strong> </strong><strong>a</strong><strong> </strong><strong>specific</strong><strong> </strong><strong>attribute.</strong><strong> </strong>It returns an array of strings with all error messages for the given attribute, each string with one error message. If there are no errors related to the attribute, it returns an empty array.</p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates :name, :presence =&gt; true, :length =&gt; { :minimum =&gt; 3 }</p>

<p>end</p>

<p>&nbsp;</p>

<p>person = Person.new(:name =&gt; &ldquo;John Doe&rdquo;)</p>

<p>person.valid? # =&gt; true</p>

<p>person.errors[:name] # =&gt; []</p>

<p>&nbsp;</p>

<p>person = Person.new(:name =&gt; &ldquo;JD&rdquo;)</p>

<p>person.valid? # =&gt; false</p>

<p>person.errors[:name] # =&gt; [&ldquo;is too short (minimum is 3 characters)&rdquo;]</p>

<p>&nbsp;</p>

<p>person = Person.new</p>

<p>person.valid? # =&gt; false</p>

<p>person.errors[:name]</p>

<h1>=&gt; [&ldquo;can&rsquo;t be blank&rdquo;, &ldquo;is too short (minimum is 3 characters)&rdquo;]</h1>

<h4>7.3 <tt>errors.add</tt></h4>


<p>The <tt>add</tt> method lets you manually<span style="font-family: DejaVu Sans;">手动</span>add messages that are related to particular attributes. You can use the <tt>errors.full_messages</tt> or <tt>errors.to_a</tt> methods to view the messages in the <strong>form</strong> they <strong>might</strong><strong> </strong><strong>be</strong><strong> </strong><strong>displayed</strong><strong> </strong><strong>to</strong><strong> </strong><strong>a</strong><strong> </strong><strong>user</strong>. Those particular messages get the attribute name prepended<span style="font-family: DejaVu Sans;">前置</span>(and capitalized<span style="font-family: DejaVu Sans;">大写</span>). <tt>add</tt> receives<span style="font-family: DejaVu Sans;">接收</span>the name of the attribute you want to add the message to, and the message itself. #<span style="font-family: DejaVu Sans;">这里只是添加的消息并没有验证</span></p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>def a_method_used_for_validation_purposes</p>

<p>errors.add(:name, &ldquo;cannot contain the characters !@#%*()_&ndash;+=&rdquo;)</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>person = Person.create(:name =&gt; &ldquo;!@#&rdquo;)</p>

<p>&nbsp;</p>

<p>person.errors[:name]</p>

<h1>=&gt; [&ldquo;cannot contain the characters !@#%*()_&ndash;+=&rdquo;]</h1>

<p>&nbsp;</p>

<p>person.errors.full_messages</p>

<h1>=&gt; [&ldquo;Name cannot contain the characters !@#%*()_&ndash;+=&rdquo;]</h1>

<p>&nbsp;</p>

<p>Another way to do this is using <tt>[]=</tt> setter</p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>def a_method_used_for_validation_purposes</p>

<p>errors[:name] = &ldquo;cannot contain the characters !@#%*()_&ndash;+=&rdquo;</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>person = Person.create(:name =&gt; &ldquo;!@#&rdquo;)</p>

<p>&nbsp;</p>

<p>person.errors[:name]</p>

<h1>=&gt; [&ldquo;cannot contain the characters !@#%*()_&ndash;+=&rdquo;]</h1>

<p>&nbsp;</p>

<p>person.errors.to_a</p>

<h1>=&gt; [&ldquo;Name cannot contain the characters !@#%*()_&ndash;+=&rdquo;]</h1>

<h4>7.4 <tt>errors[:base]</tt></h4>


<p>You can add error messages that are related to the object’s state as a whole, instead of being related to a specific attribute. <strong>You</strong><strong> </strong><strong>can</strong><strong> </strong><strong>use</strong><strong> </strong><strong>this</strong><strong> </strong><strong>method</strong><strong> </strong><strong>when</strong><strong> </strong><strong>you</strong><strong> </strong><strong>want</strong><strong> </strong><strong>to</strong><strong> </strong><strong>say</strong><strong> </strong><strong>that</strong><strong> </strong><strong>the</strong><strong> </strong><strong>object</strong><strong> </strong><strong>is</strong><strong> </strong><strong>invalid,</strong><strong> </strong><strong>no</strong><strong> </strong><strong>matter</strong><strong> </strong><strong>the</strong><strong> </strong><strong>values</strong><strong> </strong><strong>of</strong><strong> </strong><strong>its</strong><strong> </strong><strong>attributes.</strong><strong> </strong><strong>Since</strong><strong> </strong><tt><strong>errors[:base]</strong></tt><strong> </strong><strong>is</strong><strong> </strong><strong>an</strong><strong> </strong><strong>array,</strong><strong> </strong><strong>you</strong><strong> </strong><strong>can</strong><strong> </strong><strong>simply</strong><strong> </strong><strong>add</strong><strong> </strong><strong>a</strong><strong> </strong><strong>string</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><strong>array</strong><strong> </strong><strong>and</strong><strong> </strong><strong>uses</strong><strong> </strong><strong>it</strong><strong> </strong><strong>as</strong><strong> </strong><strong>the</strong><strong> </strong><strong>error</strong><strong> </strong><strong>message.</strong></p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>def a_method_used_for_validation_purposes</p>

<p>errors[:base] &lt;&lt; &ldquo;This person is invalid because &hellip;&rdquo;</p>

<p>end</p>

<p>end</p>

<h4>7.5 <tt>errors.clear</tt></h4>


<p>The <tt>clear</tt> method is used when you intentionally<span style="font-family: DejaVu Sans;">有意</span>want to clear all the messages in the <tt>errors</tt> collection. <strong>Of</strong><strong> </strong><strong>course,</strong><strong> </strong><strong>calling</strong><strong> </strong><tt><strong>errors.clear</strong></tt><strong> </strong><strong>upon</strong><span style="font-family: DejaVu Sans;"><strong>在</strong></span><strong>&hellip;</strong><span style="font-family: DejaVu Sans;"><strong>之上</strong></span><strong>an</strong><strong> </strong><strong>invalid</strong><strong> </strong><strong>object</strong><strong> </strong><strong>won</strong><strong>’</strong><strong>t</strong><strong> </strong><strong>actually</strong><strong> </strong><strong>make</strong><strong> </strong><strong>it</strong><strong> </strong><strong>valid:</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>errors</strong></tt><strong> </strong><strong>collection</strong><strong> </strong><strong>will</strong><strong> </strong><strong>now</strong><strong> </strong><strong>be</strong><strong> </strong><strong>empty,</strong><strong> </strong><strong>but</strong><strong> </strong><strong>the</strong><strong> </strong><strong>next</strong><strong> </strong><strong>time</strong><strong> </strong><strong>you</strong><strong> </strong><strong>call</strong><strong> </strong><tt><strong>valid?</strong></tt><strong> </strong><strong>or</strong><strong> </strong><strong>any</strong><strong> </strong><strong>method</strong><strong> </strong><strong>that</strong><strong> </strong><strong>tries</strong><strong> </strong><strong>to</strong><strong> </strong><strong>save</strong><strong> </strong><strong>this</strong><strong> </strong><strong>object</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><strong>database,</strong><strong> </strong><strong>the</strong><strong> </strong><strong>validations</strong><strong> </strong><strong>will</strong><strong> </strong><strong>run</strong><strong> </strong><strong>again.</strong><strong> </strong><span style="color: #800000;">If</span><span style="color: #800000;">any</span><span style="color: #800000;">of</span><span style="color: #800000;">the</span><span style="color: #800000;">validations</span><span style="color: #800000;">fail,</span><span style="color: #800000;">the</span><tt><span style="color: #800000;">errors</span></tt><span style="color: #800000;">collection</span><span style="color: #800000;">will</span><span style="color: #800000;">be</span><span style="color: #800000;">filled</span><span style="color: #800000;">again.</span></p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates :name, :presence =&gt; true, :length =&gt; { :minimum =&gt; 3 }</p>

<p>end</p>

<p>&nbsp;</p>

<p>person = Person.new</p>

<p>person.valid? # =&gt; false</p>

<p>person.errors[:name]</p>

<h1>=&gt; [&ldquo;can&rsquo;t be blank&rdquo;, &ldquo;is too short (minimum is 3 characters)&rdquo;]</h1>

<p>&nbsp;</p>

<p>person.errors.clear</p>

<p>person.errors.empty? # =&gt; true</p>

<p>&nbsp;</p>

<p>p.save # =&gt; false</p>

<p>&nbsp;</p>

<p>p.errors[:name]</p>

<h1>=&gt; [&ldquo;can&rsquo;t be blank&rdquo;, &ldquo;is too short (minimum is 3 characters)&rdquo;]</h1>

<h4>7.6 <tt>errors.size</tt></h4>


<p><tt>The</tt><tt> </tt><tt>size</tt><tt> </tt><tt>method</tt><tt> </tt><tt>returns</tt><tt> </tt><tt>the</tt><tt> </tt><tt>total</tt><tt> </tt><tt>number</tt><tt> </tt><tt>of</tt><tt> </tt><tt>error</tt><tt> </tt><tt>messages</tt><tt> </tt><tt>for</tt><tt> </tt><tt>the</tt><tt> </tt><tt>object.</tt></p>

<p>class Person &lt; ActiveRecord::Base</p>

<p>validates :name, :presence =&gt; true, :length =&gt; { :minimum =&gt; 3 }</p>

<p>end</p>

<p>&nbsp;</p>

<p>person = Person.new</p>

<p>person.valid? # =&gt; false</p>

<p>person.errors.size # =&gt; 3</p>

<p>&nbsp;</p>

<p>person = Person.new(:name =&gt; &ldquo;Andrea&rdquo;, :email =&gt; &ldquo;<a href="&#x6d;&#x61;&#x69;&#108;&#116;&#x6f;&#58;&#x61;&#x6e;&#100;&#114;&#x65;&#x61;&#x40;&#x65;&#x78;&#97;&#109;&#112;&#108;&#101;&#x2e;&#99;&#x6f;&#109;">&#97;&#x6e;&#x64;&#x72;&#x65;&#97;&#64;&#101;&#x78;&#97;&#109;&#112;&#x6c;&#x65;&#x2e;&#x63;&#111;&#109;</a>&rdquo;)</p>

<p>person.valid? # =&gt; true</p>

<p>person.errors.size # =&gt; 0</p>

<h3>8 Displaying Validation Errors in the View<span style="font-family: WenQuanYi Micro Hei;">在视图中显示验证错误（信息）</span></h3>


<p>Rails maintains an official plugin that provides helpers to display the error messages of your models in your view templates. You can install it as a plugin or as a Gem.</p>

<h4>8.1 Installing as a plugin</h4>


<p>$ rails plugin install git://github.com/joelmoss/dynamic_form.git</p>

<h4>8.2 Installing as a Gem</h4>


<p>Add this line in your Gemfile:</p>

<p>gem &ldquo;dynamic_form&rdquo;</p>

<p>Now you will have access to these two methods in your view templates</p>

<h4>8.3 <tt>error_messages</tt> and <tt>error_messages_for</tt></h4>


<p>When creating a form with the <tt>form_for</tt> helper, you can use the <tt>error_messages</tt> method on the form builder to render all failed validation messages for the current model instance.</p>

<p>class Product &lt; ActiveRecord::Base</p>

<p>validates :description, :value, :presence =&gt; true</p>

<p>validates :value, :numericality =&gt; true, :allow_nil =&gt; true</p>

<p>end</p>

<p>&lt;%= form_for(@product) do |f| %&gt;</p>

<p>&lt;%= f.error_messages %&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;%= f.label :description %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_field :description %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;%= f.label :value %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_field :value %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;%= f.submit &ldquo;Create&rdquo; %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;% end %&gt;</p>

<p>To get the idea, if you submit the form with empty fields you typically get this back, though styles are indeed missing by default:</p>

<p>You can also use the <tt>error_messages_for</tt> helper to display the error messages of a model assigned to a view template. It’s very similar to the previous example and will achieve exactly the same result.</p>

<p><code>&lt;%=</code> <code>error_messages_for</code><code> </code><code>:product</code> <code>%&gt;</code></p>

<p>The displayed text for each error message will always be formed by the capitalized name of the attribute that holds the error, followed by the error message itself.<span style="font-family: DejaVu Sans;">大写错误的属性名，后跟错误消息。</span></p>

<p>&lt;%= f.error_messages :header_message =&gt; &ldquo;Invalid product!&rdquo;,</p>

<p>:message =&gt; &ldquo;You&rsquo;ll need to fix the following fields:&rdquo;,</p>

<p>:header_tag =&gt; :h3 %&gt;</p>

<p>Which results in the following content:</p>

<p>If you pass <tt>nil</tt> to any of these options, it will get rid of the respective section of the <tt>div</tt>.</p>

<h4>8.4 Customizing the Error Messages CSS<span style="font-family: WenQuanYi Micro Hei;">定制错误消息的</span>CSS<span style="font-family: WenQuanYi Micro Hei;">样式</span></h4>


<p>The selectors to customize the style of error messages are:<span style="font-family: DejaVu Sans;">定制错误消息的选择器是：</span></p>

<ul>
    <li><tt>field_with_errors</tt><tt> – </tt><tt>Style</tt><tt> </tt><tt>for</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>fields</tt><tt> </tt><tt>and</tt><tt> </tt><tt>labels</tt><tt> </tt><tt>with</tt><tt> </tt><tt>errors.</tt><tt> </tt><tt>Errors</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>form</tt><tt> </tt><tt>fields</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>labels</tt><span style="font-family: DejaVu Sans;"><tt>的样式</tt></span></li>
    <li><tt>#errorExplanation</tt> – Style for the <tt>div</tt> element with the error messages. error<span style="font-family: DejaVu Sans;">消息的</span>div<span style="font-family: DejaVu Sans;">元素样式</span></li>
    <li><tt>#errorExplanation</tt><tt> </tt><tt>h2</tt> – Style for the header of the <tt>div</tt> element. div<span style="font-family: DejaVu Sans;">元素包含的标题样式</span></li>
    <li><tt>#errorExplanation</tt><tt> </tt><tt>p</tt> – Style for the paragraph that holds the message that appears right below the header of the <tt>div</tt> element.div<span style="font-family: DejaVu Sans;">元素中出现在标题下方段落的样式</span></li>
    <li><tt>#errorExplanation</tt><tt> </tt><tt>ul</tt><tt> </tt><tt>li</tt> – Style for the list items with individual error messages. <span style="font-family: DejaVu Sans;">错误消息中个别的项目列表样式</span></li>
</ul>


<p>Scaffolding<span style="font-family: DejaVu Sans;">脚手架</span>for example generates <tt>app/assets/stylesheets/scaffold.css.scss</tt>, which later compiles to <tt>app/assets/stylesheets/scaffold.css</tt> and defines the red-based style you saw above.</p>

<p><strong>The</strong><strong> </strong><strong>name</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><strong>class</strong><strong> </strong><strong>and</strong><strong> </strong><strong>the</strong><strong> </strong><strong>id</strong><strong> </strong><strong>can</strong><strong> </strong><strong>be</strong><strong> </strong><strong>changed</strong><strong> </strong><strong>with</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:class</strong></tt><strong> </strong><strong>and</strong><strong> </strong><tt><strong>:id</strong></tt><strong> </strong><strong>options,</strong><strong> </strong><strong>accepted</strong><strong> </strong><strong>by</strong><strong> </strong><strong>both</strong><strong> </strong><strong>helpers.</strong></p>

<p>Scaffolding — <span style="font-family: DejaVu Sans;">基架</span></p>

<p><span style="font-family: DejaVu Sans;">　　基于数据库架构生成网页模板的过程。在</span>ASP .NET <span style="font-family: DejaVu Sans;">中，动态数据使用基架来简化基于</span>Web <span style="font-family: DejaVu Sans;">的</span>UI <span style="font-family: DejaVu Sans;">的生成过程。用户可以通过这种</span>UI <span style="font-family: DejaVu Sans;">来查看和更新数据库。</span></p>

<h4>8.5 Customizing the Error Messages HTML</h4>


<p>By default, form fields with errors are displayed enclosed by a <tt>div</tt> element with the <tt>field_with_errors</tt> CSS class. However, it’s possible to override that.</p>

<p>The way form fields with errors are treated is defined by <tt>ActionView::Base.field_error_proc</tt>. This is a <tt>Proc</tt> that receives two parameters:</p>

<ul>
    <li>A string with the HTML tag</li>
    <li>An instance of <tt>ActionView::Helpers::InstanceTag</tt>.</li>
</ul>


<p><strong>Here</strong><strong> </strong><strong>is</strong><strong> </strong><strong>a</strong><strong> </strong><strong>simple</strong><strong> </strong><strong>example</strong><strong> </strong><strong>where</strong><strong> </strong><strong>we</strong><strong> </strong><strong>change</strong><strong> </strong><strong>the</strong><strong> </strong><strong>Rails</strong><strong> </strong><strong>behavior</strong><strong> </strong><strong>to</strong><strong> </strong><strong>always</strong><strong> </strong><strong>display</strong><strong> </strong><strong>the</strong><strong> </strong><strong>error</strong><strong> </strong><strong>messages</strong><strong> </strong><strong>in</strong><strong> </strong><strong>front</strong><strong> </strong><strong>of</strong><strong> </strong><strong>each</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><strong>form</strong><strong> </strong><strong>fields</strong><strong> </strong><strong>with</strong><strong> </strong><strong>errors.</strong><strong> </strong>The error messages will be enclosed by a <tt>span</tt> element with a <tt>validation-error</tt> CSS class. There will be no <tt>div</tt> element enclosing the <tt>input</tt> element, so we get rid of that red border around the text field. You can use the <tt>validation-error</tt> CSS class to style it anyway you want.</p>

<p>ActionView::Base.field_error_proc = Proc.new do |html_tag, instance|</p>

<p>if instance.error_message.kind_of?(Array)</p>

<p>%(#{html_tag}&lt;span class=&ldquo;validation-error&rdquo;&gt;&amp;nbsp;</p>

<h1>{instance.error_message.join(&lsquo;,&rsquo;)}&lt;/span&gt;).html_safe</h1>

<p>else</p>

<p>%(#{html_tag}&lt;span class=&ldquo;validation-error&rdquo;&gt;&amp;nbsp;</p>

<h1>{instance.error_message}&lt;/span&gt;).html_safe</h1>

<p>end</p>

<p>end</p>

<p>This will result in something like the following:</p>

<h3>9 Callbacks Overview<span style="font-family: WenQuanYi Micro Hei;">回调概述</span></h3>


<p>Callbacks are methods that get called at certain moments of an object’s life cycle. With callbacks it’s possible to write code that will run whenever an Active Record object is created, saved, updated, deleted, validated, or loaded from the database.</p>

<p><span style="font-family: DejaVu Sans;">回调是一种在对象生存周期中的某些情况中（使得对象）被调用的方法。通过</span>callbacks<span style="font-family: DejaVu Sans;">可以运行编写的代码无论</span>Active Record<span style="font-family: DejaVu Sans;">对象是在数据库被创建，保存，删除，验证或者是导入。</span></p>

<h4>9.1 Callback Registration</h4>


<p><strong>In</strong><strong> </strong><strong>order</strong><strong> </strong><strong>to</strong><strong> </strong><strong>use</strong><strong> </strong><strong>the</strong><strong> </strong><strong>available</strong><strong> </strong><strong>callbacks,</strong><strong> </strong><strong>you</strong><strong> </strong><strong>need</strong><strong> </strong><strong>to</strong><strong> </strong><strong>register</strong><strong> </strong><strong>them.</strong> You can do that by implementing<span style="font-family: DejaVu Sans;">实施</span>them as ordinary<span style="font-family: DejaVu Sans;">一般</span>methods, and then <strong>using</strong><strong> </strong><strong>a</strong><strong> </strong><strong>macro-style</strong><strong> </strong><strong>class</strong><strong> </strong><strong>method</strong><strong> </strong><strong>to</strong><strong> </strong><strong>register</strong><strong> </strong><strong>them</strong><strong> </strong><strong>as</strong><strong> </strong><strong>callbacks.</strong></p>

<p>class User &lt; ActiveRecord::Base</p>

<p>validates :login, :email, :presence =&gt; true</p>

<p>&nbsp;</p>

<p>before_validation :ensure_login_has_a_value</p>

<p>&nbsp;</p>

<p>protected</p>

<p>def ensure_login_has_a_value</p>

<p>if login.nil?</p>

<p>self.login = email unless email.blank?</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>The macro-style class methods can also receive<span style="font-family: DejaVu Sans;">接收</span>a block. Consider using this style if the code inside your block is so short that it fits in just one line.</p>

<p>class User &lt; ActiveRecord::Base</p>

<p>validates :login, :email, :presence =&gt; true</p>

<p>&nbsp;</p>

<p>before_create do |user|</p>

<p>user.name = user.login.capitalize if user.name.blank?</p>

<p>end</p>

<p>end</p>

<p>It’s considered<span style="font-family: DejaVu Sans;">考虑</span>good practice to declare callback methods as being protected or private. If left public, they can be called from outside of the model and violate<span style="font-family: DejaVu Sans;">违反</span>the principle of object encapsulation<span style="font-family: DejaVu Sans;">封装</span>.<span style="font-family: DejaVu Sans;">（基于）周密的考虑声明</span>callback<span style="font-family: DejaVu Sans;">方法为</span>protected<span style="font-family: DejaVu Sans;">或者</span>private<span style="font-family: DejaVu Sans;">。如果是</span>public<span style="font-family: DejaVu Sans;">，他们可以被</span>model<span style="font-family: DejaVu Sans;">外调用这样违反了封装对象的原则。</span></p>

<h3>10 Available Callbacks</h3>


<p><strong>Here</strong><strong> </strong><strong>is</strong><strong> </strong><strong>a</strong><strong> </strong><strong>list</strong><strong> </strong><strong>with</strong><strong> </strong><strong>all</strong><strong> </strong><strong>the</strong><strong> </strong><strong>available</strong><strong> </strong><strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><strong>callbacks</strong>, listed in the same order in which they will get called during the respective operations:</p>

<h4>10.1 Creating an Object</h4>


<ul>
    <li><tt>before_validation</tt></li>
    <li><tt>after_validation</tt></li>
    <li><tt>before_save</tt></li>
    <li><tt>before_create</tt></li>
    <li><tt>around_create</tt></li>
    <li><tt>after_create</tt></li>
    <li><tt>after_save</tt></li>
</ul>


<h4>10.2 Updating an Object</h4>


<ul>
    <li><tt>before_validation</tt></li>
    <li><tt>after_validation</tt></li>
    <li><tt>before_save</tt></li>
    <li><tt>before_update</tt></li>
    <li><tt>around_update</tt></li>
    <li><tt>after_update</tt></li>
    <li><tt>after_save</tt></li>
</ul>


<h4>10.3 Destroying an Object</h4>


<ul>
    <li><tt>before_destroy</tt></li>
    <li><tt>after_destroy</tt></li>
    <li><tt>around_destroy</tt></li>
</ul>


<p><tt>after_save</tt> runs both on create and update, but always <em>after</em> the more specific callbacks <tt>after_create</tt> and <tt>after_update</tt>, no matter the order in which the macro calls were executed.<tt>after_save</tt><span style="font-family: DejaVu Sans;"><tt>总是在</tt><tt></tt></span><tt>after_create</tt><tt> </tt><tt>and</tt><tt> </tt><tt>after_update</tt><span style="font-family: DejaVu Sans;"><tt>的后面不管他们的微调用如何。</tt></span></p>

<h4>10.4 <tt>after_initialize</tt> and <tt>after_find</tt></h4>


<p>The <tt>after_initialize</tt> callback will be called whenever an Active Record object is <strong>instantiated</strong>, either by directly using <tt><strong>new</strong></tt> or when a record is <strong>loaded</strong> from the database. It can be useful to avoid the need to directly override<span style="font-family: DejaVu Sans;">覆盖</span>your Active Record <tt>initialize</tt> method.</p>

<p>&nbsp;</p>

<p>The <tt>after_find</tt> callback will be called whenever <strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><strong>loads</strong><strong> </strong><strong>a</strong><strong> </strong><strong>record</strong><strong> </strong><strong>from</strong><strong> </strong><strong>the</strong><strong> </strong><strong>database</strong>. <tt><strong>after_find</strong></tt><strong> </strong><strong>is</strong><strong> </strong><strong>called</strong><strong> </strong><strong>before</strong><strong> </strong><tt><strong>after_initialize</strong></tt><strong> </strong><strong>if</strong><strong> </strong><strong>both</strong><strong> </strong><strong>are</strong><strong> </strong><strong>defined.</strong></p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>The <tt>after_initialize</tt> and <tt>after_find</tt> callbacks have no <tt>before_*</tt> counterparts<span style="font-family: DejaVu Sans;">同行</span>, but they can be registered just like the other Active Record callbacks.</p>

<p>&nbsp;</p>

<p>class User &lt; ActiveRecord::Base</p>

<p>after_initialize do |user|</p>

<p>puts &ldquo;You have initialized an object!&rdquo;</p>

<p>end</p>

<p>&nbsp;</p>

<p>after_find do |user|</p>

<p>puts &ldquo;You have found an object!&rdquo;</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>&gt;&gt; User.new</p>

<p>You have initialized an object!</p>

<p>=&gt; #&lt;User id: nil&gt;</p>

<p>&nbsp;</p>

<p>&gt;&gt; User.first</p>

<p>You have found an object!</p>

<p>You have initialized an object!</p>

<p>=&gt; #&lt;User id: 1&gt;</p>

<h3>11 Running Callbacks</h3>


<p>The following methods trigger callbacks:<span style="font-family: DejaVu Sans;">下面的方法触发回调：</span></p>

<ul>
    <li><tt>create</tt></li>
    <li><tt>create!</tt></li>
    <li><tt>decrement!</tt> <span style="font-family: DejaVu Sans;">递减</span></li>
    <li><tt>destroy</tt></li>
    <li><tt>destroy_all</tt></li>
    <li><tt>increment!</tt></li>
    <li><tt>save</tt></li>
    <li><tt>save!</tt></li>
    <li><tt>save(false)</tt></li>
    <li><tt>toggle!</tt></li>
    <li><tt>update</tt></li>
    <li><tt>update_attribute</tt></li>
    <li><tt>update_attributes</tt></li>
    <li><tt>update_attributes!</tt></li>
    <li><tt>valid?</tt></li>
</ul>


<p>Additionally, the <tt>after_find</tt> callback is triggered by the following finder methods:<span style="font-family: DejaVu Sans;">此外，</span><tt>after_find</tt><span style="font-family: DejaVu Sans;"><tt>会被下面的查找方法触发：</tt></span></p>

<ul>
    <li><tt>all</tt></li>
    <li><tt>first</tt></li>
    <li><tt>find</tt></li>
    <li><tt>find_all_by_</tt><em>attribute</em></li>
    <li><tt>find_by_</tt><em>attribute</em></li>
    <li><tt>find_by_</tt><em>attribute</em><tt>!</tt></li>
    <li><tt>last</tt></li>
</ul>


<p>The <tt>after_initialize</tt> callback is triggered every time a new object of the class is initialized.<span style="font-family: DejaVu Sans;">当类的一个新的对象被初始化的时候都会触发</span><tt>after_initialize</tt><span style="font-family: DejaVu Sans;"><tt>回调。</tt></span></p>

<h3>12 Skipping Callbacks</h3>


<p>Just as with validations, it’s also possible to skip callbacks. These methods should be used with caution, however, because important business rules and application logic may be kept in callbacks. Bypassing them without understanding the potential<span style="font-family: DejaVu Sans;">潜在</span>implications<span style="font-family: DejaVu Sans;">影响</span>may lead to invalid data.<span style="font-family: DejaVu Sans;">正如验证，它有可能忽略回调。这些方法需要注意使用，然而，由于重要的业务规则和应用程序逻辑可能保持回调。没有明白潜在的影响就绕过它们可能会导致非法数据。</span></p>

<ul>
    <li><tt>decrement</tt></li>
    <li><tt>decrement_counter</tt></li>
    <li><tt>delete</tt></li>
    <li><tt>delete_all</tt></li>
    <li><tt>find_by_sql</tt></li>
    <li><tt>increment</tt></li>
    <li><tt>increment_counter</tt></li>
    <li><tt>toggle</tt></li>
    <li><tt>touch</tt></li>
    <li><tt>update_column</tt></li>
    <li><tt>update_all</tt></li>
    <li><tt>update_counters</tt></li>
</ul>


<h3>13 Halting Execution<span style="font-family: WenQuanYi Micro Hei;">停止执行</span></h3>


<p>As you start registering new callbacks for your models, they will be queued for execution. This queue will include all your model’s validations, the registered callbacks, and the database operation to be executed.</p>

<p>The whole callback chain<span style="font-family: DejaVu Sans;">链</span>is wrapped in a transaction<span style="font-family: DejaVu Sans;">交易</span>. If any <em>before</em> callback method returns exactly <tt>false</tt> or raises an exception the execution chain gets halted and a ROLLBACK is issued; <em>after</em> callbacks can only accomplish<span style="font-family: DejaVu Sans;">完成</span>that by raising an exception.</p>

<p>Raising an arbitrary exception may break code that expects <tt>save</tt> and friends not to fail like that.<span style="font-family: DejaVu Sans;">抛出任意异常可能会打断代码预计的</span>save<span style="font-family: DejaVu Sans;">以及朋友们不想要的失败。</span>The <tt>ActiveRecord::Rollback</tt> exception is thought precisely<span style="font-family: DejaVu Sans;">正是</span>to tell Active Record a rollback is going on. That one is internally captured but not reraised.</p>

<h3>14 Relational Callbacks Callbacks<span style="font-family: WenQuanYi Micro Hei;">相关</span></h3>


<p>Callbacks work through model relationships, and can even be defined by them. Let’s take an example where a user has many posts. In our example, a user’s posts should be destroyed if the user is destroyed. So, we’ll add an <tt>after_destroy</tt> callback to the <tt>User</tt> model by way of its relationship to the <tt>Post</tt> model.</p>

<p>class User &lt; ActiveRecord::Base</p>

<p>has_many :posts, :dependent =&gt; :destroy</p>

<p>end</p>

<p>&nbsp;</p>

<p>class Post &lt; ActiveRecord::Base</p>

<p>after_destroy :log_destroy_action</p>

<p>&nbsp;</p>

<p>def log_destroy_action</p>

<p>puts &lsquo;Post destroyed&rsquo;</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>&gt;&gt; user = User.first</p>

<p>=&gt; #&lt;User id: 1&gt;</p>

<p>&gt;&gt; user.posts.create!</p>

<p>=&gt; #&lt;Post id: 1, user_id: 1&gt;</p>

<p>&gt;&gt; user.destroy</p>

<p>Post destroyed</p>

<p>=&gt; #&lt;User id: 1&gt;</p>

<h3>15 Conditional Callbacks<span style="font-family: WenQuanYi Micro Hei;">有条件的回调</span></h3>


<p>Like in validations, we can also make our callbacks conditional, calling them only when a given predicate is satisfied. You can do that by using the <tt>:if</tt> and <tt>:unless</tt> options, which can take a symbol, a string or a <tt>Proc</tt>. You may use the <tt>:if</tt> option when you want to specify when the callback <strong>should</strong> get called. If you want to specify when the callback <strong>should</strong><strong> </strong><strong>not</strong> be called, then you may use the <tt>:unless</tt> option.</p>

<h4>15.1 Using <tt>:if</tt> and <tt>:unless</tt> with a Symbol</h4>


<p>You can associate the <tt>:if</tt> and <tt>:unless</tt> options with a symbol corresponding to the name of a method that will get called right before the callback. When using the <tt>:if</tt> option, the callback won’t be executed if the method returns false; when using the <tt>:unless</tt> option, the callback won’t be executed if the method returns true. This is the most common option. Using this form of registration it’s also possible to register several different methods that should be called to check if the callback should be executed.</p>

<p>class Order &lt; ActiveRecord::Base</p>

<p>before_save :normalize_card_number, :if =&gt; :paid_with_card?</p>

<p>end</p>

<h4>15.2 Using <tt>:if</tt> and <tt>:unless</tt> with a String</h4>


<p>You can also use a string that will be evaluated using <tt>eval</tt> and needs to contain valid Ruby code. You should use this option only when the string represents a really short condition.</p>

<p>class Order &lt; ActiveRecord::Base</p>

<p>before_save :normalize_card_number, :if =&gt; &ldquo;paid_with_card?&rdquo;</p>

<p>end</p>

<h4>15.3 Using <tt>:if</tt> and <tt>:unless</tt> with a Proc</h4>


<p>Finally, it’s possible to associate <tt>:if</tt> and <tt>:unless</tt> with a <tt>Proc</tt> object. This option is best suited when writing short validation methods, usually one-liners.</p>

<p>class Order &lt; ActiveRecord::Base</p>

<p>before_save :normalize_card_number,</p>

<p>:if =&gt; Proc.new { |order| order.paid_with_card? }</p>

<p>end</p>

<h4>15.4 Multiple Conditions for Callbacks</h4>


<p>When writing conditional callbacks, it’s possible to mix both <tt>:if</tt> and <tt>:unless</tt> in the same callback declaration.</p>

<p>class Comment &lt; ActiveRecord::Base</p>

<p>after_create :send_email_to_author, :if =&gt; :author_wants_emails?,</p>

<p>:unless =&gt; Proc.new { |comment| comment.post.ignore_comments? }</p>

<p>end</p>

<h3>16 Callback Classes</h3>


<p>Sometimes the callback methods that you’ll write will be useful enough to be reused by other models. Active Record makes it possible to create classes that encapsulate the callback methods, so it becomes very easy to reuse them.</p>

<p><strong>Here</strong><strong>’</strong><strong>s</strong><strong> </strong><strong>an</strong><strong> </strong><strong>example</strong><strong> </strong><strong>where</strong><strong> </strong><strong>we</strong><strong> </strong><strong>create</strong><strong> </strong><strong>a</strong><strong> </strong><strong>class</strong><strong> </strong><strong>with</strong><strong> </strong><strong>an</strong><strong> </strong><tt><strong>after_destroy</strong></tt><strong> </strong><strong>callback</strong><strong> </strong><strong>for</strong><strong> </strong><strong>a</strong><strong> </strong><tt><strong>PictureFile</strong></tt><strong> </strong><strong>model.</strong></p>

<p>class PictureFileCallbacks</p>

<p>def after_destroy(picture_file)</p>

<p>if File.exists?(picture_file.filepath)</p>

<p>File.delete(picture_file.filepath)</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>When declared inside a class the callback method will receive the model object as a parameter. We can now use it this way:</p>

<p>class PictureFile &lt; ActiveRecord::Base</p>

<p>after_destroy PictureFileCallbacks.new</p>

<p>end</p>

<p>Note that we needed to instantiate a new <tt>PictureFileCallbacks</tt> object, since we declared our callback as an instance method. Sometimes it will make more sense to have it as a class method.</p>

<p>class PictureFileCallbacks</p>

<p>def self.after_destroy(picture_file)</p>

<p>if File.exists?(picture_file.filepath)</p>

<p>File.delete(picture_file.filepath)</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>If the callback method is declared this way, it won’t be necessary to instantiate a <tt>PictureFileCallbacks</tt> object.</p>

<p>class PictureFile &lt; ActiveRecord::Base</p>

<p>after_destroy PictureFileCallbacks</p>

<p>end</p>

<p>You can declare as many callbacks as you want inside your callback classes.</p>

<h3>17 Observers<span style="font-family: WenQuanYi Micro Hei;">观测者</span></h3>


<p>Observers are similar to callbacks, but with important differences. Whereas callbacks can pollute a model with code that isn’t directly related to its purpose, observers allow you to add the same functionality outside of a model. For example, it could be argued that a <tt>User</tt> model should not include code to send registration confirmation emails. <strong>Whenever</strong><strong> </strong><strong>you</strong><strong> </strong><strong>use</strong><strong> </strong><strong>callbacks</strong><strong> </strong><strong>with</strong><strong> </strong><strong>code</strong><strong> </strong><strong>that</strong><strong> </strong><strong>isn</strong><strong>’</strong><strong>t</strong><strong> </strong><strong>directly</strong><strong> </strong><strong>related</strong><strong> </strong><strong>to</strong><strong> </strong><strong>your</strong><strong> </strong><strong>model,</strong><strong> </strong><strong>you</strong><strong> </strong><strong>may</strong><strong> </strong><strong>want</strong><strong> </strong><strong>to</strong><strong> </strong><strong>consider</strong><strong> </strong><strong>creating</strong><strong> </strong><strong>an</strong><strong> </strong><strong>observer</strong><strong> </strong><strong>instead.</strong></p>

<p>Observers<span style="font-family: DejaVu Sans;">与</span>callbacks<span style="font-family: DejaVu Sans;">很相似，但是有着很大不同。鉴于</span>callbacks<span style="font-family: DejaVu Sans;">能够影响</span>model<span style="font-family: DejaVu Sans;">通过代码那与他的目的并没有直接关联，</span>observers<span style="font-family: DejaVu Sans;">允许你在</span>model<span style="font-family: DejaVu Sans;">外添加相同的功能。</span></p>

<h4>17.1 Creating Observers</h4>


<p>For example, imagine a <tt>User</tt> model where we want to send an email every time a new user is created. Because sending emails is not directly related to our model’s purpose, we could create an observer to contain this functionality.</p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>observer</code><code> </code><code>User</code></p>

<p>&nbsp;</p>

<p>class UserObserver &lt; ActiveRecord::Observer</p>

<p>def after_create(model)</p>

<h1>code to send confirmation email&hellip;</h1>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>As with callback classes, the observer’s methods receive the observed model as a parameter.</p>

<h4>17.2 Registering Observers</h4>


<p>Observers are conventionally placed inside of your <tt>app/models</tt> directory and registered in your application’s <tt>config/application.rb</tt> file. <strong>For</strong><strong> </strong><strong>example,</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>UserObserver</strong></tt><strong> </strong><strong>above</strong><strong> </strong><strong>would</strong><strong> </strong><strong>be</strong><strong> </strong><strong>saved</strong><strong> </strong><strong>as</strong><strong> </strong><tt><strong>app/models/user_observer.rb</strong></tt><strong> </strong><strong>and</strong><strong> </strong><strong>registered</strong><strong> </strong><strong>in</strong><strong> </strong><tt><strong>config/application.rb</strong></tt><strong> </strong><strong>this</strong><strong> </strong><strong>way:</strong></p>

<p><code>#</code><code> </code><code>Activate</code><code> </code><code>observers</code><code> </code><code>that</code><code> </code><code>should</code><code> </code><code>always</code><code> </code><code>be</code><code> </code><code>running</code></p>

<p><code>config.active_record.observers</code><code> </code><code>=</code><code> </code><code>:user_observer</code></p>

<p>As usual, settings in <tt>config/environments</tt> take precedence<span style="font-family: DejaVu Sans;">优先权</span>over those in <tt>config/application.rb</tt>. So, if you prefer that an observer doesn’t run in all environments, you can simply register it in a specific environment instead.</p>

<h4>17.3 Sharing Observers</h4>


<p>By default, Rails will simply strip “Observer” from an observer’s name to find the model it should observe. However, observers can also be used to add behavior to more than one model, and so it’s possible to manually specify the models that our observer should observe.</p>

<p>class MailerObserver &lt; ActiveRecord::Observer</p>

<p>observe :registration, :user</p>

<p>&nbsp;</p>

<p>def after_create(model)</p>

<h1>code to send confirmation email&hellip;</h1>

<p>end</p>

<p>end</p>

<p>In this example, the <tt>after_create</tt> method would be called whenever a <tt>Registration</tt> or <tt>User</tt> was created. Note that this new <tt>MailerObserver</tt> would also need to be registered in <tt>config/application.rb</tt> in order to take effect.</p>

<p><code>config.active_record.observers</code><code> </code><code>=</code><code> </code><code>:mailer_observer#</code><span style="font-family: DejaVu Sans;"><code>与上面的类名相关</code></span></p>

<h3>18 Transaction Callbacks</h3>


<p>There are two additional callbacks that are triggered by the completion of a database transaction: <tt>after_commit</tt> and <tt>after_rollback</tt>. These callbacks are very similar to the <tt>after_save</tt> callback except that they don’t execute until after database changes have either been committed or rolled back. They are most useful when your active record models need to interact with external systems which are not part of the database transaction.</p>

<p>Consider, for example, the previous example where the <tt>PictureFile</tt> model needs to delete a file after a record is destroyed. If anything raises an exception after the <tt>after_destroy</tt> callback is called and the transaction rolls back, the file will have been deleted and the model will be left in an inconsistent state. For example, suppose that <tt>picture_file_2</tt> in the code below is not valid and the <tt>save!</tt> method raises an error.</p>

<p>PictureFile.transaction do</p>

<p>picture_file_1.destroy</p>

<p>picture_file_2.save!</p>

<p>end</p>

<p>By using the <tt>after_commit</tt> callback we can account for this case.</p>

<p>class PictureFile &lt; ActiveRecord::Base</p>

<p>attr_accessor :delete_file</p>

<p>&nbsp;</p>

<p>after_destroy do |picture_file|</p>

<p>picture_file.delete_file = picture_file.filepath</p>

<p>end</p>

<p>&nbsp;</p>

<p>after_commit do |picture_file|</p>

<p>if picture_file.delete_file &amp;&amp; File.exist?(picture_file.delete_file)</p>

<p>File.delete(picture_file.delete_file)</p>

<p>picture_file.delete_file = nil</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>The <tt>after_commit</tt> and <tt>after_rollback</tt> callbacks are guaranteed to be called for all models created, updated, or destroyed within a transaction block. If any exceptions are raised within one of these callbacks, they will be ignored so that they don’t interfere with the other callbacks. As such, if your callback code could raise an exception, you’ll need to rescue it and handle it appropriately within the callback.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/22/markdown-syntax-guide/">Markdown Syntax Guide</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-22T18:13:00+08:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Markdown Syntax Guide</h2>

<p>Markdown Syntax Guide
The Allura code uses markdown syntax everywhere to allow you to create rich
text markup, and extends markdown in several ways to allow for quick linking
to other artifacts in your project.</p>

<p>Markdown was created to be easy to read, easy to write, and still readable in plain text format.</p>

<p>Links
Reference Links
Artifact Links
Text
Blockquotes
Preformatted Text
Lists
Tables
Headers
Horizontal Rules
Images
Escapes
More Headers
Code Highlighting
Includes
Neighborhood Notifications
Download Button
Project Screenshots
Thanks
Links
Most URLs will automatically be turned into links. To be explicit, just write it like this:</p>

<p><a href="http://someurl">http://someurl</a></p>

<p><a href="&#109;&#x61;&#x69;&#108;&#116;&#111;&#x3a;&#115;&#x6f;&#x6d;&#x65;&#98;&#x62;&#x6f;&#98;&#x40;&#101;&#x78;&#x61;&#x6d;&#x70;&#x6c;&#x65;&#46;&#x63;&#111;&#109;">&#x73;&#111;&#x6d;&#x65;&#x62;&#x62;&#111;&#x62;&#x40;&#101;&#120;&#x61;&#109;&#x70;&#x6c;&#101;&#x2e;&#99;&#111;&#109;</a></p>

<p>Output:</p>

<p><a href="http://someurl">http://someurl</a></p>

<p><a href="&#109;&#x61;&#105;&#x6c;&#116;&#x6f;&#x3a;&#115;&#x6f;&#x6d;&#101;&#98;&#98;&#111;&#x62;&#x40;&#x65;&#x78;&#97;&#109;&#112;&#x6c;&#101;&#46;&#99;&#x6f;&#109;">&#x73;&#x6f;&#x6d;&#101;&#x62;&#98;&#111;&#98;&#x40;&#x65;&#x78;&#x61;&#109;&#x70;&#108;&#x65;&#x2e;&#99;&#111;&#109;</a></p>

<p>To use text for the link, write it:</p>

<p><a href="http://someurl">like this</a>Output:</p>

<p>like this</p>

<p>You can add a <em>title</em> (which shows up under the cursor):</p>

<p><a href="http://someurl" title="this title shows up when you hover">like this</a>Output:</p>

<p>like this</p>

<p>Reference Links
You can also put the <a href="http://url">link URL</a> below the current paragraph
like <a href="http://another.url" title="A funky title">this</a>.</p>

<p>Output:</p>

<p>You can also put the link URL below the current paragraph like this.</p>

<p>Here the text &ldquo;link URL&rdquo; gets linked to &ldquo;<a href="http://url">http://url</a>&rdquo;, and the lines showing &ldquo;<a href="http://url">1</a>: <a href="http://url">http://url</a>&rdquo; won&rsquo;t show anything.</p>

<p>Or you can use a <a href="http://goes/with/the/link/name/textOutput:">shortcut</a> reference, which links the text &ldquo;shortcut&rdquo; to the link named &ldquo;<a href="http://goes/with/the/link/name/textOutput:">shortcut</a>&rdquo; on the next paragraph.</p>

<p>Or you can use a <a href="http://goes/with/the/link/name/textOutput:">shortcut</a> reference, which links the text
&ldquo;shortcut&rdquo; to the link named &ldquo;<a href="http://goes/with/the/link/name/textOutput:">shortcut</a>&rdquo; on the next paragraph.</p>

<p>Or you can use a shortcut reference, which links the text &ldquo;shortcut&rdquo; to the link named &ldquo;shortcut&rdquo; on the next paragraph.</p>

<p>Artifact Links
Any existing forge resource can be linked with surrounding square brackets ie [MyPage] or [#123].</p>

<p>Links to resources in other tools can be explicitly referenced by adding a tool identifier prefix to the link. So for instance <code>[developerwiki:MyPage]</code> can refer to a wiki page in a <code>developerwiki</code> instance. You can also link to tickets with <code>[tickets:#123]</code> assuming there&rsquo;s a 123 ticket in a Tracker instance mounted at <code>tickets</code>. The same is true for forums, or any of the other tools you have installed. You can even link to tickets in a subproject with <code>[subproject.tickets:#123]</code>.</p>

<p>[MyPage]
[developerwiki:MyPage]
[#123]
[tickets:#123]
No example output is available for this one because it only works on real artifacts. Try it in your project!</p>

<p>Text
Use * or _ to emphasize things:</p>

<p><em>this is in italic</em>  and <em>so is this</em></p>

<p><strong>this is in bold</strong>  and <strong>so is this</strong></p>

<p><strong><em>this is bold and italic</em></strong>  and <strong><em>so is this</em></strong>
Output:</p>

<p>this is in italic and so is this</p>

<p>this is in bold and so is this</p>

<p>this is bold and italic and so is this</p>

<p>You can strike through text using HTML like this:</p>

<p><s>this is strike through text</s>
Output:</p>

<p>this is strike through text</p>

<p>Just write paragraphs like in a text file and they will display how
you would expect.  A blank line separates paragraphs.</p>

<p>So this is a new paragraph. But any text on adjacent lines
will all end up
in the same paragraph.
Output:</p>

<p>Just write paragraphs like in a text file and they will display how
you would expect. A blank line separates paragraphs.</p>

<p>So this is a new paragraph. But any text on adjacent lines
will all end up
in the same paragraph.</p>

<p>Blockquotes
Use the > character in front of a line, just like in email</p>

<blockquote><p>Use it if you&rsquo;re quoting a person, a song or whatever.</p>

<p>You can use <em>italic</em> or lists inside them also.
And just like with other paragraphs,
all of these lines are still
part of the blockquote, even without the > character in front.</p></blockquote>

<p>To end the blockquote, just put a blank line before the following
paragraph.
Output:</p>

<p>Use it if you&rsquo;re quoting a person, a song or whatever.</p>

<p>You can use italic or lists inside them also. And just like with other paragraphs, all of these lines are still part of the blockquote, even without the > character in front.</p>

<p>To end the blockquote, just put a blank line before the following
paragraph.</p>

<p>Preformatted Text
If you want some text to show up exactly as you write it, without Markdown doing anything to it, just indent every line by at least 4 spaces (or 1 tab).</p>

<pre><code>This line won't *have any markdown* formatting applied.
I can even write &lt;b&gt;HTML&lt;/b&gt; and it will show up as text.
This is great for showing program source code, or HTML or even
Markdown. &lt;b&gt;this won't show up as HTML&lt;/b&gt; but
exactly &lt;i&gt;as you see it in this text file&lt;/i&gt;.
</code></pre>

<p>As a shortcut you can use backquotes to do the same thing while
inside a normal pargraph.  <code>This won't be *italic* or **bold**
at all.</code>
Output:</p>

<p>This line won&rsquo;t <em>have any markdown</em> formatting applied.
I can even write <b>HTML</b> and it will show up as text.
This is great for showing program source code, or HTML or even
Markdown. <b>this won&rsquo;t show up as HTML</b> but
exactly <i>as you see it in this text file</i>.
As a shortcut you can use backquotes to do the same thing while
inside a normal pargraph. This won&rsquo;t be <em>italic</em> or <strong>bold</strong>
at all.</p>

<p>Lists
* an asterisk starts an unordered list
* and this is another item in the list
+ or you can also use the + character
&ndash; or the &ndash; character</p>

<p>To start an ordered list, write this:</p>

<ol>
<li>this starts a list <em>with</em> numbers</li>
<li>this will show as number &ldquo;2&rdquo;</li>
<li>this will show as number &ldquo;3.&rdquo;</li>
<li>any number, +, &ndash;, or * will keep the list going.

<ul>
<li>just indent by 4 spaces (or tab) to make a sub-list

<ol>
<li> keep indenting for more sub lists</li>
</ol>
</li>
<li>here i&rsquo;m back to the second level
Output:</li>
</ul>
</li>
</ol>


<p>an asterisk starts an unordered list
and this is another item in the list
or you can also use the + character
or the &ndash; character
To start an ordered list, write this:</p>

<p>this starts a list with numbers
this will show as number &ldquo;2&rdquo;
this will show as number &ldquo;3.&rdquo;
any number, +, &ndash;, or * will keep the list going.
just indent by 4 spaces (or tab) to make a sub-list
keep indenting for more sub lists
here i&rsquo;m back to the second level
Tables
You can create tables using pipes and dashes like this:</p>

<table>
<thead>
<tr>
<th>  First Header  </th>
<th> Second Header</th>
</tr>
</thead>
<tbody>
<tr>
<td>  Content Cell  </td>
<td> Content Cell</td>
</tr>
<tr>
<td>  Content Cell  </td>
<td> Content Cell</td>
</tr>
</tbody>
</table>


<p>Output:</p>

<p>First Header Second Header
Content Cell Content Cell
Content Cell Content Cell</p>

<p>You can use markdown syntax within table cells for formatting:</p>

<table>
<thead>
<tr>
<th>  First Header   </th>
<th> Second Header</th>
</tr>
</thead>
<tbody>
<tr>
<td>  <em>Content Cell</em> </td>
<td> Content Cell</td>
</tr>
<tr>
<td>  Content Cell   </td>
<td> Content Cell</td>
</tr>
</tbody>
</table>


<p>Output:</p>

<p>First Header Second Header
Content Cell Content Cell
Content Cell Content Cell</p>

<p>You can also create tables using HTML code.</p>

<p>Headers
Just put 1 or more dashes or equals signs (&mdash;&ndash; or ===) below the title.</p>

<h1>This is a huge header</h1>

<h2>this is a smaller header</h2>

<p>Output:</p>

<p>This is a huge header
this is a smaller header
Horizontal Rule
Just put three or more *&rsquo;s or &ndash;&rsquo;s on a line:</p>

<hr />

<p>Output:</p>

<hr />

<p>Or, you can use single spaces between then, like this:</p>

<hr />

<p>Output:</p>

<hr />

<p>or</p>

<hr />

<p>Output:</p>

<hr />

<p>Make sure you have a blank line above the dashes, though, or else:</p>

<h2>you will get a header</h2>

<p>Output:</p>

<p>you will get a header
Images
To include an image, just put a &ldquo;!&rdquo; in front of a text link:</p>

<p><img src="https://sourceforge.net/images/icon_linux.gif" alt="alternate text" />
Output:</p>

<p>The &ldquo;alternate text&rdquo; will show up if the browser can&rsquo;t load the image.</p>

<p>You can also use a title if you want, like this:</p>

<p><img src="https://sourceforge.net/images/icon_linux.gif" title="tiny arrow" alt="tiny arrow" />
Output:</p>

<p>To reference an attached image, just use the img macro. You can add more attributes:</p>

<p>[[img src=attached-image.jpg alt=foobar]]
Output:</p>

<p>Escapes
What if you want to just show asterisks, not italics?</p>

<ul>
<li>this shows up in italics: <em>a happy day</em></li>
<li>this shows the asterisks: *a happy day*
Output:</li>
</ul>


<p>this shows up in italics: a happy day
this shows the asterisks: <em>a happy day</em>
The backslashes will disappear and leave the asterisks.</p>

<p>You can do the same with any of the characters that have a special meaning
for Markdown.</p>

<p>HTML tags may need to be escaped. <b> will be interpreted as a bold tag. Entity codes will be used. <foobar> isn&rsquo;t allowed and will be dropped, so you probably want to escape it:</p>

<p><b>this will be bold</b>
you should escape &lt;unknown&gt; tags
&lt; special entities work
&amp;lt; if you want to escape it
Output:</p>

<p>this will be bold
you should escape <unknown> tags
&lt; special entities work
&lt; if you want to escape it</p>

<p>Individual ampersands (&amp;) and less-than signs (&lt;) are fine, they will be shown as expected.</p>

<p>More Headers
More ways of doing headers:</p>

<h1>this is a huge header</h1>

<h2>this is a smaller header</h2>

<h3>this is even smaller</h3>

<h4>more small</h4>

<h5>even smaller</h5>

<h6>smallest still: <code>&lt;h6&gt;</code> header</h6>

<p>Output:</p>

<p>this is a huge header
this is a smaller header
this is even smaller
more small
even smaller
smallest still: <h6> header
You can use up to 6 # characters at the beginning of the line.</p>

<p>Code Highlighting
The Code highlighting used in the newforge is based on (<a href="http://www.freewisdom.org/projects/python-markdown/CodeHilite">http://www.freewisdom.org/projects/python-markdown/CodeHilite</a>). It follows the same syntax as regular Markdown code blocks, except that there are two ways to tell the highlighter what language to use for the code block.</p>

<p>If the first line of the codeblock contains a shebang, the language is derived from that and line numbers are used.</p>

<pre><code>#!/usr/bin/python
# Code goes here ...
</code></pre>

<p>Output:</p>

<p>1
2 #!/usr/bin/python</p>

<h1>Code goes here &hellip;</h1>

<p>If the first line contains a shebang, but the shebang line does not contain a path (a single / or even a space) or If the first line begins with three or more colons, the text following the colons identifies the language. In both cases, the first line is removed from the code block before processing.</p>

<pre><code>:::python
# Code goes here ...
</code></pre>

<p>Output:</p>

<h1>Code goes here &hellip;</h1>

<p>You can also designate a code block by surrounding it with lines of tildes. The type of code highlighting to apply will be inferred based on the code within, or you can specify like above.</p>

<p><del>
<a href="#">My code</a>
</del>
Output:</p>

<p><a href="#">My code</a>
Includes
You can embed another wiki page directly:</p>

<p>[[include ref=SamplePage]]
No example output is available for this one because it only works on real wiki pages. Try it in your wiki!</p>

<p>Neighborhood Notifications
You can list updates from all projects in a neighborhood by tool type. Max_number (default is 5) and sort (default is pubdate) are optional:</p>

<p>[[neighborhood_feeds tool_name=Wiki max_number=10 sort=pubdate]]
Neighborhood Blog Posts
You can view blog posts from all projects in a neighborhood. Max_number (default is 5) and sort (default is timestamp) are optional:</p>

<p>[[neighborhood_blog_posts max_number=10 sort=timestamp]]
Project Blog Posts
You can view blog posts from all blogs in a project. Max_number (default is 5), mount point (leave empty to view posts from all blog tools in a project), and sort (default is timestamp) are optional:</p>

<p>[[project_blog_posts max_number=10 sort=timestamp mount_point=news]]
Download Button
You can display a download button that links to the best download available for the active project. Please note that if you use this macro and there is no download associated with your project, the button will not appear.</p>

<p>[[download_button]]
Project Screenshots
You can show all the screenshots for the current project as thumbnails that are linked to the full-size image.</p>

<p>[[project_screenshots]]
Thanks
Thanks to John Gruber and Aaron Swartz for creating Markdown.</p>

<p>This page is based on some examples from Greg Schueler, <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#x6f;&#x3a;&#103;&#114;&#101;&#103;&#x40;&#x76;&#x61;&#x72;&#105;&#111;&#x2e;&#x75;&#x73;">&#x67;&#114;&#101;&#x67;&#x40;&#118;&#97;&#114;&#105;&#x6f;&#46;&#x75;&#x73;</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/21/guides-rubyonrails-migrations-en-and-cn/">Guides Rubyonrails Migrations (en and CN)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-21T02:48:00+08:00" pubdate data-updated="true">Nov 21<span>st</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>guides rubyonrails Migrations (EN and CN)</h2>

<h2>Migrations</h2>


<p>Migrations are a convenient way for you to alter<span style="font-family: DejaVu Sans;">移动</span>your database in a structured and organized manner.Migrations<span style="font-family: DejaVu Sans;">是一种很便捷的方法让你能够以一种结构化的和有组织的方式来迁移你的数据库。</span>You could edit fragments of SQL by hand but you would then be responsible for telling other developers that they need to go and run them.<span style="font-family: DejaVu Sans;">你可以手动编辑</span>SQL<span style="font-family: DejaVu Sans;">片段，而且你有责任把这些告诉其他的开发人员，因为他们需要开发和使用它们。</span>You’d also have to keep track of which changes need to be run against the production machines next time you deploy.<span style="font-family: DejaVu Sans;">你也可以跟踪对你部署的代码在接下来的</span>production<span style="font-family: DejaVu Sans;">机器（将会）发生的变化。</span></p>

<p>Active Record tracks which migrations have already been run so all you have to do is update your source and run <tt>rake</tt><tt> </tt><tt>db:migrate</tt>.Active Record<span style="font-family: DejaVu Sans;">跟踪并迁移你已经运行过的（代码和数据），而你只需要在更新了你的源代码的时候执行</span><tt>rake</tt><tt> </tt><tt>db:migrate</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span>Active Record will work out which migrations should be run.Active Recor<span style="font-family: DejaVu Sans;">将会计算出那些迁移需要被执行。</span>It will also update your <tt>db/schema.rb</tt> file to match the structure of your database.<span style="font-family: DejaVu Sans;">它还会更新你的</span><tt>db/schema.rb</tt><span style="font-family: DejaVu Sans;"><tt>文件使其于你的数据库结构相匹配。</tt></span></p>

<p><tt>Migrations</tt><tt> </tt><tt>also</tt><tt> </tt><tt>allow</tt><tt> </tt><tt>you</tt><tt> </tt><tt>to</tt><tt> </tt><tt>describe</tt><tt> </tt><tt>these</tt><tt> </tt><tt>transformations</tt><tt> </tt><tt>using</tt><tt> </tt><tt>Ruby.Migrations</tt><span style="font-family: DejaVu Sans;"><tt>同样允许你使用</tt></span><tt>Ruby</tt><span style="font-family: DejaVu Sans;"><tt>来描述这些转换。</tt><tt></tt></span><tt>The</tt><tt> </tt><tt>great</tt><tt> </tt><tt>thing</tt><tt> </tt><tt>about</tt><tt> </tt><tt>this</tt><tt> </tt><tt>is</tt><tt> </tt><tt>that</tt><tt> </tt><tt>(like</tt><tt> </tt><tt>most</tt><tt> </tt><tt>of</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>functionality)</tt><tt> </tt><tt>it</tt><tt> </tt><tt>is</tt><tt> </tt><tt>database</tt><tt> </tt><tt>independent:</tt><tt> </tt><tt>you</tt><tt> </tt><tt>don</tt><tt>’</tt><tt>t</tt><tt> </tt><tt>need</tt><tt> </tt><tt>to</tt><tt> </tt><tt>worry</tt><tt> </tt><tt>about</tt><tt> </tt><tt>the</tt><tt> </tt><tt>precise</tt><tt> </tt><tt>syntax</tt><tt> </tt><tt>of</tt><tt> </tt><tt>CREATE</tt><tt> </tt><tt>TABLE</tt><tt> </tt><tt>any</tt><tt> </tt><tt>more</tt><tt> </tt><tt>than</tt><tt> </tt><tt>you</tt><tt> </tt><tt>worry</tt><tt> </tt><tt>about</tt><tt> </tt><tt>variations</tt><tt> </tt><tt>on</tt><tt> </tt><tt>SELECT</tt><tt> </tt><tt><em></tt><tt> </tt><tt>(you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>drop</tt><tt> </tt><tt>down</tt><tt> </tt><tt>to</tt><tt> </tt><tt>raw</tt><tt> </tt><tt>SQL</tt><tt> </tt><tt>for</tt><tt> </tt><tt>database</tt><tt> </tt><tt>specific</tt><tt> </tt><tt>features).</tt><span style="font-family: DejaVu Sans;"><tt>值得高兴的事情是（就像大多数的</tt></span><tt>Active</tt><tt> </tt><tt>Record&rsquo;s</tt><span style="font-family: DejaVu Sans;"><tt>工厂）它是与数据独立的：你再也不需要担心准确的语法来</tt><tt></tt></span><tt>CREATE</tt><tt> </tt><tt>TABLE</tt><span style="font-family: DejaVu Sans;"><tt>也不需要担心</tt></span><tt>SELECT</tt><tt> </tt><tt></em></tt><span style="font-family: DejaVu Sans;"><tt>的变化。</tt><tt></tt></span><tt>For</tt><tt> </tt><tt>example</tt><tt> </tt><tt>you</tt><tt> </tt><tt>could</tt><tt> </tt><tt>use</tt><tt> </tt><tt>SQLite3</tt><tt> </tt><tt>in</tt><tt> </tt><tt>development,</tt><tt> </tt><tt>but</tt><tt> </tt><tt>MySQL</tt><tt> </tt><tt>in</tt><tt> </tt><tt>production.</tt><span style="font-family: DejaVu Sans;"><tt>例如你可以使用</tt></span><tt>SQLite3</tt><span style="font-family: DejaVu Sans;"><tt>开发，但是在发布的产品中使用</tt></span><tt>MySQL</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>You</tt><tt>’</tt><tt>ll</tt><tt> </tt><tt>learn</tt><tt> </tt><tt>all</tt><tt> </tt><tt>about</tt><tt> </tt><tt>migrations</tt><tt> </tt><tt>including:</tt><span style="font-family: DejaVu Sans;"><tt>下面你将了解到的</tt></span><tt>migrations</tt><span style="font-family: DejaVu Sans;"><tt>包括：</tt></span></p>

<ul>
    <li>The generators you can use to create them <span style="font-family: DejaVu Sans;">你可以使用</span>generators<span style="font-family: DejaVu Sans;">来创建他们（数据库表单）</span></li>
    <li>The methods Active Record provides to manipulate<span style="font-family: DejaVu Sans;">操纵</span>your database Active Record<span style="font-family: DejaVu Sans;">提供方法来操纵你的数据库</span></li>
    <li>The Rake tasks that manipulate them <span style="font-family: DejaVu Sans;">使用</span>Rake<span style="font-family: DejaVu Sans;">命令操作这些（迁移）</span></li>
    <li>How they relate to <tt>schema.rb</tt> <span style="font-family: DejaVu Sans;">它们是如何映射到</span>schema.rb</li>
</ul>


<h3><a name="anatomy-of-a-migration"></a><tt>1</tt><tt> </tt><tt>Anatomy</tt><tt> </tt><tt>of</tt><tt> </tt><tt>a</tt><tt> </tt><tt>Migration</tt></h3>


<p><tt>Before</tt><tt> </tt><tt>we</tt><tt> </tt><tt>dive</tt><tt> </tt><tt>into</tt><tt> </tt><tt>the</tt><tt> </tt><tt>details</tt><tt> </tt><tt>of</tt><tt> </tt><tt>a</tt><tt> </tt><tt>migration,</tt><tt> </tt><tt>here</tt><tt> </tt><tt>are</tt><tt> </tt><tt>a</tt><tt> </tt><tt>few</tt><tt> </tt><tt>examples</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>sorts</tt><tt> </tt><tt>of</tt><tt> </tt><tt>things</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>do:</tt><span style="font-family: DejaVu Sans;"><tt>在深入</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>的详细介绍之前，下面有一系列的例子你可以尝试一下：</tt></span></p>

<p><code>class</code><tt> </tt><code>CreateProducts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>up</code></p>

<p><code> </code><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:name</code></p>

<p><code> </code><code>t.text</code><code> </code><code>:description</code></p>

<p>&nbsp;</p>

<p><code> </code><code>t.timestamps</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>end</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>down</code></p>

<p><code> </code><code>drop_table</code><code> </code><code>:products</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><tt>This</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>adds</tt><tt> </tt><tt>a</tt><tt> </tt><tt>table</tt><tt> </tt><tt>called</tt><tt> </tt><tt>products</tt><tt> </tt><tt>with</tt><tt> </tt><tt>a</tt><tt> </tt><tt>string</tt><tt> </tt><tt>column</tt><tt> </tt><tt>called</tt><tt> </tt><tt>name</tt><tt> </tt><tt>and</tt><tt> </tt><tt>a</tt><tt> </tt><tt>text</tt><tt> </tt><tt>column</tt><tt> </tt><tt>called</tt><tt> </tt><tt>description.</tt><span style="font-family: DejaVu Sans;"><tt>这次</tt><tt></tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>添加了一个名叫</tt></span><tt>products</tt><span style="font-family: DejaVu Sans;"><tt>的表它有一个叫</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>的字符串的列和一个叫</tt></span><tt>description</tt><span style="font-family: DejaVu Sans;"><tt>的文本框的列。</tt><tt></tt></span><tt>A</tt><tt> </tt><tt>primary</tt><tt> </tt><tt>key</tt><tt> </tt><tt>column</tt><tt> </tt><tt>called</tt><tt> </tt><tt>id</tt><tt> </tt><tt>will</tt><tt> </tt><tt>also</tt><tt> </tt><tt>be</tt><tt> </tt><tt>added,</tt><tt> </tt><tt>however</tt><tt> </tt><tt>since</tt><tt> </tt><tt>this</tt><tt> </tt><tt>is</tt><tt> </tt><tt>the</tt><tt> </tt><tt>default</tt><tt> </tt><tt>we</tt><tt> </tt><tt>do</tt><tt> </tt><tt>not</tt><tt> </tt><tt>need</tt><tt> </tt><tt>to</tt><tt> </tt><tt>ask</tt><tt> </tt><tt>for</tt><tt> </tt><tt>this.</tt><span style="font-family: DejaVu Sans;"><tt>一个名叫</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>的主键列也被添加，然而因为这是默认操作的不需要我们刻意添加。</tt><tt></tt></span><tt>The</tt><tt> </tt><tt>timestamp</tt><tt> </tt><tt>columns</tt><tt> </tt><tt>created_at</tt><tt> </tt><tt>and</tt><tt> </tt><tt>updated_at</tt><tt> </tt><tt>which</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt> </tt><tt>populates</tt><tt> </tt><tt>automatically</tt><tt> </tt><tt>will</tt><tt> </tt><tt>also</tt><tt> </tt><tt>be</tt><tt> </tt><tt>added.</tt><span style="font-family: DejaVu Sans;"><tt>还添加了</tt><tt></tt></span><tt>timestamp</tt><span style="font-family: DejaVu Sans;"><tt>字段，</tt></span><code>products</code><span style="font-family: DejaVu Sans;"><code>表单</code><tt>会在</tt><tt></tt></span><tt>created_at</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>updated_at</tt><span style="font-family: DejaVu Sans;"><tt>的时候通过</tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>自动填充</tt><tt></tt></span><tt>timestamp</tt><span style="font-family: DejaVu Sans;"><tt>字段。</tt><tt></tt></span><tt>Reversing</tt><tt> </tt><tt>this</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>is</tt><tt> </tt><tt>as</tt><tt> </tt><tt>simple</tt><tt> </tt><tt>as</tt><tt> </tt><tt>dropping</tt><tt> </tt><tt>the</tt><tt> </tt><tt>table.</tt><span style="font-family: DejaVu Sans;"><tt>撤销这次</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>就像</tt><tt></tt></span><tt>dropping</tt><span style="font-family: DejaVu Sans;"><tt>这个表。</tt></span></p>

<p>&nbsp;</p>

<p>Migrations are not limited to changing the schema.Migrations<span style="font-family: DejaVu Sans;">不限制更改</span>schema<span style="font-family: DejaVu Sans;">。</span>You can also use them to fix bad data in the database or populate new fields:<span style="font-family: DejaVu Sans;">你可以使用（</span>schema<span style="font-family: DejaVu Sans;">）它们来修复坏的数据或者添加新的字段：</span></p>

<p><code>class</code> <code>AddReceiveNewsletterToUsers</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>up</code></p>

<p><code> </code><code>change_table</code><code> </code><code>:users</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.boolean</code><code> </code><code>:receive_newsletter,</code><code> </code><code>:default</code> <code>=&gt;</code><code> </code><code>false</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>User.update_all</code><code> </code><code>[&ldquo;receive_newsletter</code><code> </code><code>=</code><code> </code><code>?&rdquo;,</code><code> </code><code>true]</code></p>

<p><code> </code><code>end</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>down</code></p>

<p><code> </code><code>remove_column</code><code> </code><code>:users,</code><code> </code><code>:receive_newsletter</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>Some <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/migrations.html#using-models-in-your-migrations">caveats</a></span></span> apply to using models in your migrations.<span style="font-family: DejaVu Sans;">一些在</span>model<span style="font-family: DejaVu Sans;">的</span>migrations<span style="font-family: DejaVu Sans;">中的<span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/migrations.html#using-models-in-your-migrations" target="_blank">注意事项</a></span></span>。</span></p>

<p>This migration adds a <tt>receive_newsletter</tt> column to the <tt>users</tt> table.<span style="font-family: DejaVu Sans;">（上面）这个</span>migration<span style="font-family: DejaVu Sans;">添加一个</span><tt>receive_newsletter</tt><span style="font-family: DejaVu Sans;"><tt>字段到</tt></span><tt>user</tt><span style="font-family: DejaVu Sans;"><tt>表。</tt></span>We want it to default to <tt>false</tt> for new users, but existing users are considered to have already opted in, so we use the User model to set the flag to <tt>true</tt> for existing users.<span style="font-family: DejaVu Sans;">我们希望对于新用户默认设置</span><tt>receive_newsletter</tt><span style="font-family: DejaVu Sans;"><tt>字段为</tt></span><tt>fasle</tt><span style="font-family: DejaVu Sans;"><tt>，但是存在的用户被认为已经有（自己的）选择，因此我们通过在</tt></span><tt>User</tt><tt> </tt><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>中存在的用户设置为</tt></span><tt>True</tt><span style="font-family: DejaVu Sans;"><tt>的标识（来保留以后信息）。</tt></span></p>

<p>Rails 3.1 makes migrations smarter by providing a new <tt>change</tt> method.Rails3.1<span style="font-family: DejaVu Sans;">通过提供一个新的</span>change<span style="font-family: DejaVu Sans;">方法，使得</span>migrations<span style="font-family: DejaVu Sans;">更加智能化。</span>This method is preferred<span style="font-family: DejaVu Sans;">首选</span>for writing constructive migrations (adding columns or tables).<span style="font-family: DejaVu Sans;">这个方法是用来做（数据库）结构迁移（添加或删除字段）的首选。</span>The migration knows how to migrate your database and reverse it when the migration is rolled back without the need to write a separate <tt>down</tt> method.migration<span style="font-family: DejaVu Sans;">知道怎样迁移你的数据库以及不需要单独的编写</span>down<span style="font-family: DejaVu Sans;">方法来处理回滚是的</span>migration<span style="font-family: DejaVu Sans;">。</span></p>

<p><code>class</code> <code>CreateProducts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:name</code></p>

<p><code> </code><code>t.text</code><code> </code><code>:description</code></p>

<p>&nbsp;</p>

<p><code> </code><code>t.timestamps</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<h4><a name="migrations-are-classes"></a>1.1 Migrations are Classes Migrations<span style="font-family: WenQuanYi Micro Hei;">是一个类</span></h4>


<p>A migration is a subclass of <tt>ActiveRecord::Migration</tt> that implements two methods: <tt>up</tt> (perform the required transformations) and <tt>down</tt> (revert them).<span style="font-family: DejaVu Sans;">一个</span>migration<span style="font-family: DejaVu Sans;">类是</span><tt>ActiveRecord::Migration</tt><span style="font-family: DejaVu Sans;">的子类，它实现了两个方法：</span>up<span style="font-family: DejaVu Sans;">（执行所请求的转换）和</span>down<span style="font-family: DejaVu Sans;">（撤销所做的更改）。</span></p>

<p>Active Record provides methods that perform common data definition tasks in a database independent way (you’ll read about them in detail later):Active Record<span style="font-family: DejaVu Sans;">提供了了在数据库中执行常见数据定义的方法（你将会在后面看到详细的介绍）。</span></p>

<ul>
    <li><tt>create_table</tt></li>
    <li><tt>change_table</tt></li>
    <li><tt>drop_table</tt></li>
    <li><tt>add_column</tt></li>
    <li><tt>change_column</tt></li>
    <li><tt>rename_column</tt></li>
    <li><tt>remove_column</tt></li>
    <li><tt>add_index</tt></li>
    <li><tt>remove_index</tt></li>
</ul>


<p>If you need to perform tasks specific to your database (for example create a <a href="http://guides.rubyonrails.org/migrations.html#active-record-and-referential-integrity"><span style="color: #000080;"><span style="text-decoration: underline;">foreign</span></span><span style="color: #000080;"><span style="text-decoration: underline;">key</span></span></a> constraint<span style="font-family: DejaVu Sans;">约束</span>) then the <tt>execute</tt> function allows you to execute arbitrary SQL.<span style="font-family: DejaVu Sans;">如果你在你的数据库中需要处理特殊的任务（例如创建一个</span>foreign key<span style="font-family: DejaVu Sans;">约束）那么</span>execute<span style="font-family: DejaVu Sans;">功能允许你执行任意的</span>SQL<span style="font-family: DejaVu Sans;">（语句）。</span>A migration is just a regular Ruby class so you’re not limited to these functions. migration<span style="font-family: DejaVu Sans;">仅仅是一个</span>Ruby<span style="font-family: DejaVu Sans;">类，因此你不必仅仅局限于现有的这些功能。</span>For example after adding a column you could write code to set the value of that column for existing records (if necessary using your models).<span style="font-family: DejaVu Sans;">例如在添加了一个字段之后你可以添加代码来设置这个字段在存在记录中的值（如果在你的</span>model<span style="font-family: DejaVu Sans;">中需要）。</span></p>

<p>On databases that support transactions<span style="font-family: DejaVu Sans;">处理办理</span>with statements that change the schema (such as PostgreSQL or SQLite3), migrations are wrapped in a transaction.<span style="font-family: DejaVu Sans;">当数据库支持通过声明来改变数据库的结构（例如</span>PostgreSQL<span style="font-family: DejaVu Sans;">和</span>SQLite3<span style="font-family: DejaVu Sans;">），会在包含在</span>migration<span style="font-family: DejaVu Sans;">处理中（直接改变数据库的结构）。</span>If the database does not support this (for example MySQL) then when a migration fails the parts of it that succeeded will not be rolled back. <span style="font-family: DejaVu Sans;">如果数据库不支持这样的功能（比如</span>MySQL<span style="font-family: DejaVu Sans;">）然后</span>migration<span style="font-family: DejaVu Sans;">会有部分失败<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>成功添加的（数据）将不会回滚。</span>You will have to unpick the changes that were made by hand.<span style="font-family: DejaVu Sans;">你必须手动的分开这些改变。</span></p>

<h4><a name="what-s-in-a-name"></a>1.2 What’s in a Name <span style="font-family: WenQuanYi Micro Hei;">（数据库文件）名称中的信息</span></h4>


<p>Migrations are stored in files in <tt>db/migrate</tt>, one for each migration class.Mgirations<span style="font-family: DejaVu Sans;">以单个文件的形式被存放在文件夹</span><tt>db/migrate</tt><span style="font-family: DejaVu Sans;"><tt>中</tt>。</span>The name of the file is of the form <tt>YYYYMMDDHHMMSS_create_products.rb</tt>, that is to say a UTC timestamp<span style="font-family: DejaVu Sans;">时间戳</span>identifying<span style="font-family: DejaVu Sans;">确定</span>the migration followed by an underscore<span style="font-family: DejaVu Sans;">下划线</span>followed by the name of the migration.<span style="font-family: DejaVu Sans;">（</span>migration<span style="font-family: DejaVu Sans;">）文件是以</span>form<span style="font-family: DejaVu Sans;">命名的，还看见了一个在</span>migration<span style="font-family: DejaVu Sans;">完成之时的时间戳接着是下划线接着是</span>migration<span style="font-family: DejaVu Sans;">的名字。</span>The name of the migration class (CamelCased version) should match the latter part of the file name. migraiton<span style="font-family: DejaVu Sans;">类（使用驼峰命名法）的名字应该和</span>migration<span style="font-family: DejaVu Sans;">文件的名称的最后部分相匹配。</span>For example <tt>20080906120000_create_products.rb</tt> should define <tt>CreateProducts</tt> and <tt>20080906120001_add_details_to_products.rb</tt> should define <tt>AddDetailsToProducts</tt>. If you do feel the need to change the file name then you <em>have</em><em> </em><em>to</em> update the name of the class inside or Rails will complain about a missing class.<span style="font-family: DejaVu Sans;">如果你觉得需要改变</span>migration<span style="font-family: DejaVu Sans;">文件的名字你必须同样修改文件里边</span>migration<span style="font-family: DejaVu Sans;">类的名字，不然</span>Rails<span style="font-family: DejaVu Sans;">会找不到</span>migration<span style="font-family: DejaVu Sans;">类。</span></p>

<p>Internally Rails only uses the migration’s number (the timestamp) to identify them.<span style="font-family: DejaVu Sans;">在</span>Rails<span style="font-family: DejaVu Sans;">内部只使用</span>migration<span style="font-family: DejaVu Sans;">编号（时间戳）来确定他们。</span>Prior to Rails 2.1 the migration number started at 1 and was incremented each time a migration was generated.<span style="font-family: DejaVu Sans;">在</span>Rails2.1<span style="font-family: DejaVu Sans;">之前</span>migration<span style="font-family: DejaVu Sans;">编号从</span>1<span style="font-family: DejaVu Sans;">开始然后在每次</span>migration<span style="font-family: DejaVu Sans;">被创建过后增加。</span>With multiple developers it was easy for these to clash requiring you to rollback migrations and renumber them.<span style="font-family: DejaVu Sans;">随着开发人员的增多这样会使的很容易产生冲突这就需要你回滚</span>migrations<span style="font-family: DejaVu Sans;">和重新编号他们。</span>developers With Rails 2.1 this is largely avoided by using the creation time of the migration to identify them.Rails2.1<span style="font-family: DejaVu Sans;">的开发人员通过</span>migraiton<span style="font-family: DejaVu Sans;">文件的创建时间指明每个文件在很大程度上避免了冲突（的发生）。</span>You can revert to the old numbering scheme by adding the following line to <tt>config/application.rb</tt>.<span style="font-family: DejaVu Sans;">你可以还原带旧的版本通过在</span><tt>config/application.rb</tt><span style="font-family: DejaVu Sans;"><tt>文件中添加如下行：</tt></span></p>

<p><code>config.active_record.timestamped_migrations</code><code> </code><code>=</code><code> </code><code>false</code></p>

<p><tt>The</tt><tt> </tt><tt>combination</tt><span style="font-family: DejaVu Sans;"><tt>组合</tt><tt></tt></span><tt>of</tt><tt> </tt><tt>timestamps</tt><tt> </tt><tt>and</tt><tt> </tt><tt>recording</tt><tt> </tt><tt>which</tt><tt> </tt><tt>migrations</tt><tt> </tt><tt>have</tt><tt> </tt><tt>been</tt><tt> </tt><tt>run</tt><tt> </tt><tt>allows</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>to</tt><tt> </tt><tt>handle</tt><tt> </tt><tt>common</tt><tt> </tt><tt>situations</tt><tt> </tt><tt>that</tt><tt> </tt><tt>occur</tt><tt> </tt><tt>with</tt><tt> </tt><tt>multiple</tt><tt> </tt><tt>developers.</tt><span style="font-family: DejaVu Sans;"><tt>时间戳和</tt></span><tt>migrations</tt><span style="font-family: DejaVu Sans;"><tt>的名字的组合使得</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>可以处理多个开发人员的普遍情况。</tt></span></p>

<p><tt>For</tt><tt> </tt><tt>example</tt><tt> </tt><tt>Alice</tt><tt> </tt><tt>adds</tt><tt> </tt><tt>migrations</tt><tt> </tt><tt>20080906120000</tt><tt> </tt><tt>and</tt><tt> </tt><tt>20080906123000</tt><tt> </tt><tt>and</tt><tt> </tt><tt>Bob</tt><tt> </tt><tt>adds</tt><tt> </tt><tt>20080906124500</tt><tt> </tt><tt>and</tt><tt> </tt><tt>runs</tt><tt> </tt><tt>it.</tt><span style="font-family: DejaVu Sans;"><tt>比如</tt></span><tt>Alice</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>添加了</tt></span><tt>migration</tt><tt> </tt><tt>20080906120000</tt><tt> </tt><tt>and</tt><tt> </tt><tt>20080906123000</tt><span style="font-family: DejaVu Sans;"><tt>以及</tt></span><tt>Bob</tt><span style="font-family: DejaVu Sans;"><tt>添加并运行了</tt><tt></tt></span><tt>20080906124500</tt><span style="font-family: DejaVu Sans;"><tt>。</tt><tt></tt></span><tt>Alice</tt><tt> </tt><tt>finishes</tt><tt> </tt><tt>her</tt><tt> </tt><tt>changes</tt><tt> </tt><tt>and</tt><tt> </tt><tt>checks</tt><tt> </tt><tt>in</tt><tt> </tt><tt>her</tt><tt> </tt><tt>migrations</tt><tt> </tt><tt>and</tt><tt> </tt><tt>Bob</tt><tt> </tt><tt>pulls</tt><tt> </tt><tt>down</tt><tt> </tt><tt>the</tt><tt> </tt><tt>latest</tt><tt> </tt><tt>changes.</tt><tt> </tt><tt>Alice</tt><span style="font-family: DejaVu Sans;"><tt>完成了他的更改并提交在他的</tt></span><tt>migrationss</tt><span style="font-family: DejaVu Sans;"><tt>中，并且</tt></span><tt>Bob</tt><tt> </tt><tt>pull</tt><tt> </tt><tt>down</tt><span style="font-family: DejaVu Sans;"><tt>了最新的更改。</tt><tt></tt></span><tt>Rails</tt><tt> </tt><tt>knows</tt><tt> </tt><tt>that</tt><tt> </tt><tt>it</tt><tt> </tt><tt>has</tt><tt> </tt><tt>not</tt><tt> </tt><tt>run</tt><tt> </tt><tt>Alice</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>two</tt><tt> </tt><tt>migrations</tt><tt> </tt><tt>so</tt><tt> </tt><tt>rake</tt><tt> </tt><tt>db:migrate</tt><tt> </tt><tt>would</tt><tt> </tt><tt>run</tt><tt> </tt><tt>them</tt><tt> </tt><tt>(even</tt><tt> </tt><tt>though</tt><tt> </tt><tt>Bob</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>with</tt><tt> </tt><tt>a</tt><tt> </tt><tt>later</tt><tt> </tt><tt>timestamp</tt><tt> </tt><tt>has</tt><tt> </tt><tt>been</tt><tt> </tt><tt>run),</tt><tt> </tt><tt>and</tt><tt> </tt><tt>similarly</tt><tt> </tt><tt>migrating</tt><tt> </tt><tt>down</tt><tt> </tt><tt>would</tt><tt> </tt><tt>not</tt><tt> </tt><tt>run</tt><tt> </tt><tt>their</tt><tt> </tt><tt>down</tt><tt> </tt><tt>methods.</tt></p>

<p><tt>Of</tt><tt> </tt><tt>course</tt><tt> </tt><tt>this</tt><tt> </tt><tt>is</tt><tt> </tt><tt>no</tt><tt> </tt><tt>substitution</tt><tt> </tt><tt>for</tt><tt> </tt><tt>communication</tt><tt> </tt><tt>within</tt><tt> </tt><tt>the</tt><tt> </tt><tt>team.</tt><span style="font-family: DejaVu Sans;"><tt>当然这些在团队交流中是不可避免的。</tt><tt></tt></span><tt>For</tt><tt> </tt><tt>example,</tt><tt> </tt><tt>if</tt><tt> </tt><tt>Alice</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>removed</tt><tt> </tt><tt>a</tt><tt> </tt><tt>table</tt><tt> </tt><tt>that</tt><tt> </tt><tt>Bob</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>assumed</tt><tt> </tt><tt>to</tt><tt> </tt><tt>exist,</tt><tt> </tt><tt>then</tt><tt> </tt><tt>trouble</tt><tt> </tt><tt>would</tt><tt> </tt><tt>certainly</tt><tt> </tt><tt>strike.</tt><span style="font-family: DejaVu Sans;"><tt>例如如果</tt></span><tt>Alice</tt><span style="font-family: DejaVu Sans;"><tt>在</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>中移除了一个表但是</tt></span><tt>Bob&rsquo;s</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>migraion</tt><span style="font-family: DejaVu Sans;"><tt>假设它还在，那么麻烦就来了。</tt></span></p>

<h4><a name="changing-migrations"></a><tt>1.3</tt><tt> </tt><tt>Changing</tt><tt> </tt><tt>Migrations</tt></h4>


<p><tt>Occasionally</tt><tt> </tt><tt>you</tt><tt> </tt><tt>will</tt><tt> </tt><tt>make</tt><tt> </tt><tt>a</tt><tt> </tt><tt>mistake</tt><tt> </tt><tt>when</tt><tt> </tt><tt>writing</tt><tt> </tt><tt>a</tt><tt> </tt><tt>migration.</tt><span style="font-family: DejaVu Sans;"><tt>偶尔你在写入一个</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>的时候犯个错误。</tt><tt></tt></span><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>have</tt><tt> </tt><tt>already</tt><tt> </tt><tt>run</tt><tt> </tt><tt>the</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>then</tt><tt> </tt><tt>you</tt><tt> </tt><tt>cannot</tt><tt> </tt><tt>just</tt><tt> </tt><tt>edit</tt><tt> </tt><tt>the</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>and</tt><tt> </tt><tt>run</tt><tt> </tt><tt>the</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>again:</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>thinks</tt><tt> </tt><tt>it</tt><tt> </tt><tt>has</tt><tt> </tt><tt>already</tt><tt> </tt><tt>run</tt><tt> </tt><tt>the</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>and</tt><tt> </tt><tt>so</tt><tt> </tt><tt>will</tt><tt> </tt><tt>do</tt><tt> </tt><tt>nothing</tt><tt> </tt><tt>when</tt><tt> </tt><tt>you</tt><tt> </tt><tt>run</tt><tt> </tt><tt>rake</tt><tt> </tt><tt>db:migrate.</tt><span style="font-family: DejaVu Sans;"><tt>如果你已经运行了</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>接着你不可能再去编辑和运行这个（错误的）</tt></span><tt>migraion</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>认为（你已经）运行了</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>因此在你运</tt></span><tt>rake</tt><tt> </tt><tt>db:migrate</tt><span style="font-family: DejaVu Sans;"><tt>的时候不会做任何改变。</tt><tt></tt></span><tt>You</tt><tt> </tt><tt>must</tt><tt> </tt><tt>rollback</tt><tt> </tt><tt>the</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>(for</tt><tt> </tt><tt>example</tt><tt> </tt><tt>with</tt><tt> </tt><tt>rake</tt><tt> </tt><tt>db:rollback),</tt><tt> </tt><tt>edit</tt><tt> </tt><tt>your</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>and</tt><tt> </tt><tt>then</tt><tt> </tt><tt>run</tt><tt> </tt><tt>rake</tt><tt> </tt><tt>db:migrate</tt><tt> </tt><tt>to</tt><tt> </tt><tt>run</tt><tt> </tt><tt>the</tt><tt> </tt><tt>corrected</tt><tt> </tt><tt>version.</tt><span style="font-family: DejaVu Sans;"><tt>你必须回滚</tt></span><tt>migation</tt><span style="font-family: DejaVu Sans;"><tt>（例如</tt></span><tt>rake</tt><tt> </tt><tt>db:rollback</tt><span style="font-family: DejaVu Sans;"><tt>），编辑修改你的</tt></span><tt>migraion</tt><span style="font-family: DejaVu Sans;"><tt>然后运行正确的版本</tt><tt></tt></span><tt>rake</tt><tt> </tt><tt>db:migrate</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>In</tt><tt> </tt><tt>general</tt><tt> </tt><tt>editing</tt><tt> </tt><tt>existing</tt><tt> </tt><tt>migrations</tt><tt> </tt><tt>is</tt><tt> </tt><tt>not</tt><tt> </tt><tt>a</tt><tt> </tt><tt>good</tt><tt> </tt><tt>idea:</tt><tt> </tt><tt>you</tt><tt> </tt><tt>will</tt><tt> </tt><tt>be</tt><tt> </tt><tt>creating</tt><tt> </tt><tt>extra</tt><tt> </tt><tt>work</tt><tt> </tt><tt>for</tt><tt> </tt><tt>yourself</tt><tt> </tt><tt>and</tt><tt> </tt><tt>your</tt><tt> </tt><tt>co-workers</tt><tt> </tt><tt>and</tt><tt> </tt><tt>cause</tt><tt> </tt><tt>major</tt><tt> </tt><tt>headaches</tt><tt> </tt><tt>if</tt><tt> </tt><tt>the</tt><tt> </tt><tt>existing</tt><tt> </tt><tt>version</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>has</tt><tt> </tt><tt>already</tt><tt> </tt><tt>been</tt><tt> </tt><tt>run</tt><tt> </tt><tt>on</tt><tt> </tt><tt>production</tt><tt> </tt><tt>machines.</tt><span style="font-family: DejaVu Sans;"><tt>在一般情况下，编辑存在的</tt></span><tt>migrations</tt><span style="font-family: DejaVu Sans;"><tt>不是一个好主意：因为这样你会给你自己或者你的合作成员产生额外的工作，头疼的原因是如果存在的</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>已经在</tt></span><tt>production</tt><span style="font-family: DejaVu Sans;"><tt>机器中运行。</tt><tt></tt></span><tt>Instead</tt><tt> </tt><tt>you</tt><tt> </tt><tt>should</tt><tt> </tt><tt>write</tt><tt> </tt><tt>a</tt><tt> </tt><tt>new</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>that</tt><tt> </tt><tt>performs</tt><tt> </tt><tt>the</tt><tt> </tt><tt>changes</tt><tt> </tt><tt>you</tt><tt> </tt><tt>require.</tt><span style="font-family: DejaVu Sans;"><tt>作为替代你应该编写一个新的</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>来执行你需要的更改。</tt><tt></tt></span><tt>Editing</tt><tt> </tt><tt>a</tt><tt> </tt><tt>freshly</tt><tt> </tt><tt>generated</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>that</tt><tt> </tt><tt>has</tt><tt> </tt><tt>not</tt><tt> </tt><tt>yet</tt><tt> </tt><tt>been</tt><tt> </tt><tt>committed</tt><tt> </tt><tt>to</tt><tt> </tt><tt>source</tt><tt> </tt><tt>control</tt><tt> </tt><tt>(or</tt><tt> </tt><tt>more</tt><tt> </tt><tt>generally</tt><tt> </tt><tt>which</tt><tt> </tt><tt>has</tt><tt> </tt><tt>not</tt><tt> </tt><tt>been</tt><tt> </tt><tt>propagated</tt><tt> </tt><tt>beyond</tt><tt> </tt><tt>your</tt><tt> </tt><tt>development</tt><tt> </tt><tt>machine)</tt><tt> </tt><tt>is</tt><tt> </tt><tt>relatively</tt><tt> </tt><tt>harmless.</tt><span style="font-family: DejaVu Sans;"><tt>编辑一个刚生成的还没有提交到软代码控制</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>（或者更一般的情况还没有传播出你的开发机器）相对危害较轻。</tt></span></p>

<h4><a name="supported-types"></a>1.4 Supported Types<span style="font-family: WenQuanYi Micro Hei;">支持的类型</span></h4>


<p>Active Record supports the following types:Active Record<span style="font-family: DejaVu Sans;">支持如下类型：</span></p>

<ul>
    <li><tt>:primary_key</tt></li>
    <li><tt>:string</tt></li>
    <li><tt>:text</tt></li>
    <li><tt>:integer</tt></li>
    <li><tt>:float</tt></li>
    <li><tt>:decimal</tt> 10<span style="font-family: DejaVu Sans;">进制</span></li>
    <li><tt>:datetime</tt></li>
    <li><tt>:timestamp</tt></li>
    <li><tt>:time</tt></li>
    <li><tt>:date</tt></li>
    <li><tt>:binary</tt></li>
    <li><tt>:boolean</tt></li>
</ul>


<p>These will be mapped onto an appropriate underlying<span style="font-family: DejaVu Sans;">底层</span>database type, for example with MySQL <tt>:string</tt> is mapped to <tt>VARCHAR(255)</tt>.<span style="font-family: DejaVu Sans;">这些将会被映射为合适底层数据库的类型，例如使用</span>MySQL :string<span style="font-family: DejaVu Sans;">类型将会映射成</span><tt>VARCHAR(255)</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span>You can create columns of types not supported by Active Record when using the non-sexy syntax, for example<span style="font-family: DejaVu Sans;">你可以在创建</span>Active Record<span style="font-family: DejaVu Sans;">不支持的字段，使用</span>non-sexy<span style="font-family: DejaVu Sans;">语法，例如</span></p>

<p><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.column</code><code> </code><code>:name,</code><code> </code><code>&lsquo;polygon&rsquo;,</code><code> </code><code>:null</code> <code>=&gt;</code><code> </code><code>false</code></p>

<p><code>end</code></p>

<p>This may however hinder<span style="font-family: DejaVu Sans;">阻碍</span>portability<span style="font-family: DejaVu Sans;">移植</span>to other databases.<span style="font-family: DejaVu Sans;">不过这可能会阻碍移植到其它数据库。</span></p>

<h3><a name="creating-a-migration"></a>2 Creating a Migration<span style="font-family: WenQuanYi Micro Hei;">新建一个</span>Migrateion</h3>


<h4><a name="creating-a-model"></a>2.1 Creating a Model<span style="font-family: WenQuanYi Micro Hei;">新建一个</span>Model</h4>


<p>The model and scaffold generators will create migrations appropriate for adding a new model.model<span style="font-family: DejaVu Sans;">和</span>generators<span style="font-family: DejaVu Sans;">创建器会为添加的新的</span>model<span style="font-family: DejaVu Sans;">创建合适的</span>migrations<span style="font-family: DejaVu Sans;">。</span>This migration will already contain instructions for creating the relevant<span style="font-family: DejaVu Sans;">有关</span>table.<span style="font-family: DejaVu Sans;">这个</span>migration<span style="font-family: DejaVu Sans;">已经包含在有关创建的的表的说明中。</span>If you tell Rails what columns you want then statements<span style="font-family: DejaVu Sans;">声明</span>for adding those will also be created. For example, running<span style="font-family: DejaVu Sans;">如果你告诉</span>Rails<span style="font-family: DejaVu Sans;">将你随后声明的字段添加到创建</span>migrations<span style="font-family: DejaVu Sans;">中，例如，运行</span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>model</code><code> </code><code>Product</code><code> </code><code>name:string</code><code> </code><code>description:text</code></p>

<p><code>will</code><code> </code><code>create</code><code> </code><code>a</code><code> </code><code>migration</code><code> </code><code>that</code><code> </code><code>looks</code><code> </code><code>like</code><code> </code><code>this</code><code> </code><span style="font-family: DejaVu Sans;"><code>（</code></span><code>rails</code><span style="font-family: DejaVu Sans;"><code>）将会新建一个像这样的</code></span><code>migraion</code><span style="font-family: DejaVu Sans;"><code>：</code></span></p>

<p><code>class</code><code> </code><code>CreateProducts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:name</code></p>

<p><code> </code><code>t.text</code><code> </code><code>:description</code></p>

<p>&nbsp;</p>

<p><code> </code><code>t.timestamps</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><code>You</code><code> </code><code>can</code><code> </code><code>append</code><code> </code><code>as</code><code> </code><code>many</code><code> </code><code>column</code><code> </code><code>name/type</code><code> </code><code>pairs</code><code> </code><code>as</code><code> </code><code>you</code><code> </code><code>want.</code><span style="font-family: DejaVu Sans;"><code>你可以随意增加字段或者类型对。</code><code></code></span><code>By</code><code> </code><code>default</code><code> </code><tt>t.timestamps</tt><code> </code><code>(which</code><code> </code><code>creates</code><code> </code><code>the</code><code> </code><tt>updated_at</tt><code> </code><code>and</code><code> </code><tt>created_at</tt><code> </code><code>columns</code><code> </code><code>that</code><code> </code><code>are</code><code> </code><code>automatically</code><code> </code><code>populated</code><code> </code><code>by</code><code> </code><code>Active</code><code> </code><code>Record)</code><code> </code><code>will</code><code> </code><code>be</code><code> </code><code>added</code><code> </code><code>for</code><code> </code><code>you.</code><span style="font-family: DejaVu Sans;"><code>默认的</code><code></code></span><code>t.timestamps</code><span style="font-family: DejaVu Sans;"><code>（</code></span><code>Active</code><code> </code><code>Record</code><code> </code><span style="font-family: DejaVu Sans;"><code>会自动生成</code></span><tt>updated_at</tt><span style="font-family: DejaVu Sans;"><code>和</code></span><tt>created_at</tt><span style="font-family: DejaVu Sans;"><tt>字段</tt><code>）会子添加在你的表中。</code></span></p>

<h4><a name="creating-a-standalone-migration"></a>2.2 Creating a Standalone Migration<span style="font-family: WenQuanYi Micro Hei;">新建一个独立的</span>Migration</h4>


<p>If you are creating migrations for other purposes (for example to add a column to an existing table) then you can use the migration generator:<span style="font-family: DejaVu Sans;">如果你正在因为其他的目的新建</span>migrations<span style="font-family: DejaVu Sans;">（例如添加一个字段到一个存在的表）你可以使用</span>migration<span style="font-family: DejaVu Sans;">创建器：</span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>migration</code><code> </code><code>AddPartNumberToProducts</code></p>

<p>This will create an empty but appropriately named migration:<span style="font-family: DejaVu Sans;">这里会新建一个空的但是合适的</span>migration<span style="font-family: DejaVu Sans;">：</span></p>

<p><code>class</code> <code>AddPartNumberToProducts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>If the migration name is of the form “AddXXXToYYY” or “RemoveXXXFromYYY” and is followed by a list of column names and types then a migration containing the appropriate <tt>add_column</tt> and <tt>remove_column</tt> statements will be created.<span style="font-family: DejaVu Sans;">如果</span>migration<span style="font-family: DejaVu Sans;">命名为<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>AddXXXToYYY”<span style="font-family: DejaVu Sans;">或<span style="font-family: Liberation Serif,Times New Roman,serif;"> “</span></span>RemoveXXXFromYYY”<span style="font-family: DejaVu Sans;">格式并且后跟有一些字段名称或类型，那么一个</span>migration<span style="font-family: DejaVu Sans;">包含合适的</span><tt>add_column</tt><span style="font-family: DejaVu Sans;">和</span><tt>remove_column</tt><span style="font-family: DejaVu Sans;"><tt>将会被新建。</tt></span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>migration</code><code> </code><code>AddPartNumberToProducts</code><code> </code><code>part_number:string</code></p>

<p><code>ps</code><span style="font-family: DejaVu Sans;"><code>：如果已经创建了一个</code></span><code>AddPartNumberToProducts</code><span style="font-family: DejaVu Sans;"><code>那么运行</code></span><code>rails</code><code> </code><code>generate</code><code> </code><code>migration</code><code> </code><code>AddPartNumberToProducts</code><code> </code><code>part_number:string</code><code> </code><code>-f</code><span style="font-family: DejaVu Sans;"><code>进行覆盖新建</code></span></p>

<p><code>will</code><code> </code><code>generate</code><span style="font-family: DejaVu Sans;"><code>将会生成：</code></span></p>

<p><code>class</code><code> </code><code>AddPartNumberToProducts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:part_number,</code><code> </code><code>:string</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><code>Similarly,</code><span style="font-family: DejaVu Sans;"><code>同样，</code></span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>migration</code><code> </code><code>RemovePartNumberFromProducts</code><code> </code><code>part_number:string</code></p>

<p><code>generates</code><span style="font-family: DejaVu Sans;"><code>生成</code></span></p>

<p><code>class</code><code> </code><code>RemovePartNumberFromProducts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>up</code></p>

<p><code> </code><code>remove_column</code><code> </code><code>:products,</code><code> </code><code>:part_number</code></p>

<p><code> </code><code>end</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>down</code></p>

<p><code> </code><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:part_number,</code><code> </code><code>:string</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><code>You</code><code> </code><code>are</code><code> </code><code>not</code><code> </code><code>limited</code><code> </code><code>to</code><code> </code><code>one</code><code> </code><code>magically</code><span style="font-family: DejaVu Sans;"><code>神奇</code><code></code></span><code>generated</code><code> </code><code>column,</code><code> </code><code>for</code><code> </code><code>example</code><span style="font-family: DejaVu Sans;"><code>你不限制于一次只输入一个字段，例如</code></span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>migration</code><code> </code><code>AddDetailsToProducts</code><code> </code><code>part_number:string</code><code> </code><code>price:decimal</code></p>

<p><code>generates</code><span style="font-family: DejaVu Sans;"><code>生成</code></span></p>

<p><code>class</code><code> </code><code>AddDetailsToProducts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:part_number,</code><code> </code><code>:string</code></p>

<p><code> </code><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:price,</code><code> </code><code>:decimal</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><code>As</code><code> </code><code>always,</code><code> </code><code>what</code><code> </code><code>has</code><code> </code><code>been</code><code> </code><code>generated</code><code> </code><code>for</code><code> </code><code>you</code><code> </code><code>is</code><code> </code><code>just</code><code> </code><code>a</code><code> </code><code>starting</code><code> </code><code>point.</code><code> </code><code>You</code><code> </code><code>can</code><code> </code><code>add</code><code> </code><code>or</code><code> </code><code>remove</code><code> </code><code>from</code><code> </code><code>it</code><code> </code><code>as</code><code> </code><code>you</code><code> </code><code>see</code><code> </code><code>fit.</code><span style="font-family: DejaVu Sans;"><code>一如往常，使用</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>创建器生成的</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>只是一个起点，你可以添加或删除其中的字段直到你满意为止。</code></span></p>

<p>&nbsp;</p>

<p><code>The</code><code> </code><code>generated</code><code> </code><code>migration</code><code> </code><code>file</code><code> </code><code>for</code><code> </code><code>destructive</code><code> </code><code>migrations</code><code> </code><code>will</code><code> </code><code>still</code><code> </code><code>be</code><code> </code><code>old-style</code><code> </code><code>using</code><code> </code><code>the</code><code> </code><tt>up</tt><code> </code><code>and</code><code> </code><tt>down</tt><code> </code><code>methods.</code><span style="font-family: DejaVu Sans;"><code>在创建的</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>文件中对</code></span><code>migrations</code><span style="font-family: DejaVu Sans;"><code>进行破坏性的操作仍然使用老式的</code></span><code>up</code><span style="font-family: DejaVu Sans;"><code>和</code></span><code>down</code><span style="font-family: DejaVu Sans;"><code>方法。</code><code></code></span><code>This</code><code> </code><code>is</code><code> </code><code>because</code><code> </code><code>Rails</code><code> </code><code>doesn</code><code>’</code><code>t</code><code> </code><code>know</code><code> </code><code>the</code><code> </code><code>original</code><code> </code><code>data</code><code> </code><code>types</code><code> </code><code>defined</code><code> </code><code>when</code><code> </code><code>you</code><code> </code><code>made</code><code> </code><code>the</code><code> </code><code>original</code><code> </code><code>changes.</code><span style="font-family: DejaVu Sans;"><code>这是因为当你对初始</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>做了更改，</code></span><code>Rails</code><span style="font-family: DejaVu Sans;"><code>不知道原始的数据类型定义。</code></span></p>

<p>&nbsp;</p>

<h3><a name="writing-a-migration"></a>3 Writing a Migration</h3>


<p>Once you have created your migration using one of the generators it’s time to get to work!<span style="font-family: DejaVu Sans;">一旦你已经使用一种创建器创建了你的</span>migration<span style="font-family: DejaVu Sans;">，现在是时候开始工作了。</span></p>

<h4><a name="creating-a-table"></a>3.1 Creating a Table<span style="font-family: WenQuanYi Micro Hei;">创建一个表</span></h4>


<p>Migration method <tt>create_table</tt> will be one of your workhorses. A typical use would be Migration<span style="font-family: DejaVu Sans;">方法</span><tt>create_table</tt><span style="font-family: DejaVu Sans;"><tt>将会是一个你的驮马。下面是他的典型形式</tt></span></p>

<p><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:name</code></p>

<p><code>end</code></p>

<p>which creates a <tt>products</tt> table with a column called <tt>name</tt> (and as discussed below, an implicit <tt>id</tt> column).<span style="font-family: DejaVu Sans;">上面的代码会创建一个</span>products<span style="font-family: DejaVu Sans;">表，其中包含了一个</span>name<span style="font-family: DejaVu Sans;">字段（和下面讨论的一样，一个隐藏的</span>id<span style="font-family: DejaVu Sans;">字段）</span></p>

<p>The object yielded to the block allows you to create columns on the table.<span style="font-family: DejaVu Sans;">这个</span>migration<span style="font-family: DejaVu Sans;">类产生代码块让你创建表中的字段。</span>There are two ways of doing this: The first (traditional) form looks like<span style="font-family: DejaVu Sans;">有两种方法创建字段：首先（传统的）方式看起来像这样</span></p>

<p><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.column</code><code> </code><code>:name,</code><code> </code><code>:string,</code><code> </code><code>:null</code> <code>=&gt;</code><code> </code><code>false</code></p>

<p><code>end</code></p>

<p>the second form, the so called “sexy” migration, drops the somewhat redundant <tt>column</tt> method.<span style="font-family: DejaVu Sans;">第二种方式，也称为<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>sexy” migration<span style="font-family: DejaVu Sans;">，丢掉了有些冗余的</span>column<span style="font-family: DejaVu Sans;">方法。</span>Instead, the <tt>string</tt>, <tt>integer</tt>, etc. methods create a column of that type.<span style="font-family: DejaVu Sans;">作为替代，如</span>string,interger<span style="font-family: DejaVu Sans;">等等方法创建相应类型的字段。</span>Subsequent parameters are the same.<span style="font-family: DejaVu Sans;">其后的参赛也在同一个字段中。</span></p>

<p><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:name,</code><code> </code><code>:null</code> <code>=&gt;</code><code> </code><code>false</code></p>

<p><code>end</code></p>

<p><code>HABTM,</code><code> </code><code>hasAndBelongsToMany</code><code> </code><span style="font-family: DejaVu Sans;"><code>这是</code></span><code>Active</code><code> </code><code>Recored</code><span style="font-family: DejaVu Sans;"><code>功能里面比较</code><code><span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></code><code>复杂</code><code><span style="font-family: Liberation Serif,Times New Roman,serif;">”</span></code><code>的一个东西。简单的来说，就是你有一个帖子，你给这个帖子定义了多个</code></span><code>tag</code><span style="font-family: DejaVu Sans;"><code>，</code><code></code><code>但是实际上</code></span><code>tag</code><span style="font-family: DejaVu Sans;"><code>也是独立的，一个</code></span><code>tag</code><span style="font-family: DejaVu Sans;"><code>会包含很多个不同的帖子。</code></span></p>

<p><code>By</code><code> </code><code>default</code><code> </code><tt>create_table</tt><code> </code><code>will</code><code> </code><code>create</code><code> </code><code>a</code><code> </code><code>primary</code><code> </code><code>key</code><code> </code><code>called</code><code> </code><tt>id</tt><code>.</code><span style="font-family: DejaVu Sans;"><code>通过默认的</code><code></code></span><tt>create_table</tt><span style="font-family: DejaVu Sans;"><tt>将会创建一个叫做</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>的主键。</tt><code></code></span><code>You</code><code> </code><code>can</code><code> </code><code>change</code><code> </code><code>the</code><code> </code><code>name</code><code> </code><code>of</code><code> </code><code>the</code><code> </code><code>primary</code><code> </code><code>key</code><code> </code><code>with</code><code> </code><code>the</code><code> </code><tt>:primary_key</tt><code> </code><code>option</code><code> </code><code>(don</code><code>’</code><code>t</code><code> </code><code>forget</code><code> </code><code>to</code><code> </code><code>update</code><code> </code><code>the</code><code> </code><code>corresponding</code><span style="font-family: DejaVu Sans;"><code>相应的</code><code></code></span><code>model)</code><code> </code><code>or</code><code> </code><code>if</code><code> </code><code>you</code><code> </code><code>don</code><code>’</code><code>t</code><code> </code><code>want</code><code> </code><code>a</code><code> </code><code>primary</code><code> </code><code>key</code><code> </code><code>at</code><code> </code><code>all</code><code> </code><code>(for</code><code> </code><code>example</code><code> </code><code>for</code><code> </code><code>a</code><code> </code><code>HABTM</code><code> </code><code>join</code><code> </code><code>table)</code><code> </code><code>you</code><code> </code><code>can</code><code> </code><code>pass</code><code> </code><tt>:id</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>false</tt><code>.</code><span style="font-family: DejaVu Sans;"><code>你可以更改主键的名字通过使用</code></span><tt>:primary_key</tt><span style="font-family: DejaVu Sans;"><tt>选项（不要忘记更新其相应的</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>）或者你根本不想要主键（例如添加一个</tt></span><tt>HABTM</tt><span style="font-family: DejaVu Sans;"><tt>关系到表中）你可以通过</tt></span><tt>:id</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>false</tt><span style="font-family: DejaVu Sans;"><tt>。</tt><code></code></span><code>If</code><code> </code><code>you</code><code> </code><code>need</code><code> </code><code>to</code><code> </code><code>pass</code><code> </code><code>database</code><code> </code><code>specific</code><code> </code><code>options</code><code> </code><code>you</code><code> </code><code>can</code><code> </code><code>place</code><code> </code><code>an</code><code> </code><code>SQL</code><code> </code><code>fragment</code><code> </code><code>in</code><code> </code><code>the</code><code> </code><tt>:options</tt><code> </code><code>option.</code><code> </code><code>For</code><code> </code><code>example</code><span style="font-family: DejaVu Sans;"><code>如果你需要数据库的特殊选项你可以放置一个</code></span><code>SQL</code><span style="font-family: DejaVu Sans;"><code>片段在</code></span><tt>:options</tt><span style="font-family: DejaVu Sans;"><tt>选项中。例如</tt></span></p>

<p><code>create_table</code><code> </code><code>:products,</code><code> </code><code>:options</code> <code>=&gt;</code><code> </code><code>&ldquo;ENGINE=BLACKHOLE&rdquo;</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:name,</code><code> </code><code>:null</code> <code>=&gt;</code><code> </code><code>false</code></p>

<p><code>end</code></p>

<p>will append <tt>ENGINE=BLACKHOLE</tt> to the SQL statement used to create the table (when using MySQL the default is <tt>ENGINE=InnoDB</tt>).<span style="font-family: DejaVu Sans;">将会添加</span><tt>ENGINE=BLACKHOLE</tt><span style="font-family: DejaVu Sans;"><tt>到</tt></span><tt>SQL</tt><span style="font-family: DejaVu Sans;"><tt>声明中用于创建表单（当使用</tt></span><tt>MySQL</tt><span style="font-family: DejaVu Sans;"><tt>默认的（</tt></span><tt>ENGINE</tt><span style="font-family: DejaVu Sans;"><tt>）是</tt></span><tt>InnoDB</tt><span style="font-family: DejaVu Sans;"><tt>）。</tt></span></p>

<h4><a name="changing-tables"></a><tt>3.2</tt><tt> </tt><tt>Changing</tt><tt> </tt><tt>Tables</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>更改表单</tt></span></h4>


<p>A close cousin of <tt>create_table</tt> is <tt>change_table</tt>, used for changing existing tables. <tt>create_table</tt><span style="font-family: DejaVu Sans;"><tt>的一个近亲是</tt><tt></tt></span><tt>change_table</tt><span style="font-family: DejaVu Sans;"><tt>，用于更改存在的表单。</tt></span>It is used in a similar fashion to <tt>create_table</tt> but the object yielded to the block knows more tricks.<span style="font-family: DejaVu Sans;">它使用的是与</span><tt>create_table</tt><span style="font-family: DejaVu Sans;"><tt>类似的方法，但是其类产生的块能够知道更多的技巧。（如移除字段，重命名字段）</tt></span>For example<span style="font-family: DejaVu Sans;">例如</span></p>

<p><code>change_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.remove</code><code> </code><code>:description,</code><code> </code><code>:name</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:part_number</code></p>

<p><code> </code><code>t.index</code><code> </code><code>:part_number</code></p>

<p><code> </code><code>t.rename</code><code> </code><code>:upccode,</code><code> </code><code>:upc_code</code></p>

<p><code>end</code></p>

<p>removes the <tt>description</tt> and <tt>name</tt> columns, creates a <tt>part_number</tt> column and adds an index on it. Finally it renames the <tt>upccode</tt> column.<span style="font-family: DejaVu Sans;">移除</span><tt>description</tt><span style="font-family: DejaVu Sans;"><tt>字段和</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>字段，创建一个</tt><tt></tt></span><tt>part_number</tt><span style="font-family: DejaVu Sans;"><tt>字段并且添加一个</tt></span><tt>index</tt><span style="font-family: DejaVu Sans;"><tt>（索引）给</tt><tt></tt></span><tt>part_number</tt><span style="font-family: DejaVu Sans;"><tt>。最后它重命名了</tt></span><code>:upccode</code><span style="font-family: DejaVu Sans;"><code>。</code></span>This is the same as doing<span style="font-family: DejaVu Sans;">下面的代码也可以达到同样的效果</span></p>

<p><code>remove_column</code><code> </code><code>:products,</code><code> </code><code>:description</code></p>

<p><code>remove_column</code><code> </code><code>:products,</code><code> </code><code>:name</code></p>

<p><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:part_number,</code><code> </code><code>:string</code></p>

<p><code>add_index</code><code> </code><code>:products,</code><code> </code><code>:part_number</code></p>

<p><code>rename_column</code><code> </code><code>:products,</code><code> </code><code>:upccode,</code><code> </code><code>:upc_code</code></p>

<p>&nbsp;</p>

<p><tt>You</tt><tt> </tt><tt>don</tt><tt>’</tt><tt>t</tt><tt> </tt><tt>have</tt><tt> </tt><tt>to</tt><tt> </tt><tt>keep</tt><tt> </tt><tt>repeating</tt><tt> </tt><tt>the</tt><tt> </tt><tt>table</tt><tt> </tt><tt>name</tt><tt> </tt><tt>and</tt><tt> </tt><tt>it</tt><tt> </tt><tt>groups</tt><tt> </tt><tt>all</tt><tt> </tt><tt>the</tt><tt> </tt><tt>statements</tt><tt> </tt><tt>related</tt><tt> </tt><tt>to</tt><tt> </tt><tt>modifying</tt><tt> </tt><tt>one</tt><tt> </tt><tt>particular</tt><tt> </tt><tt>table.</tt><span style="font-family: DejaVu Sans;"><tt>你不必重复表单名称和组相关的所有声明，（而</tt><tt>只需要重复）修改表的一部分。</tt><tt></tt></span><tt>The</tt><tt> </tt><tt>individual</tt><span style="font-family: DejaVu Sans;"><tt>个别</tt><tt></tt></span><tt>transformation</tt><span style="font-family: DejaVu Sans;"><tt>转换</tt><tt></tt></span><tt>names</tt><tt> </tt><tt>are</tt><tt> </tt><tt>also</tt><tt> </tt><tt>shorter,</tt><tt> </tt><tt>for</tt><tt> </tt><tt>example</tt><tt> </tt><tt>remove_column</tt><tt> </tt><tt>becomes</tt><tt> </tt><tt>just</tt><tt> </tt><tt>remove</tt><tt> </tt><tt>and</tt><tt> </tt><tt>add_index</tt><tt> </tt><tt>becomes</tt><tt> </tt><tt>just</tt><tt> </tt><tt>index.</tt><span style="font-family: DejaVu Sans;"><tt>个别的转换方法的名称也更加简短了，例如</tt><tt></tt></span><tt>remove_column</tt><span style="font-family: DejaVu Sans;"><tt>变成</tt></span><tt>remove</tt><span style="font-family: DejaVu Sans;"><tt>，</tt><tt></tt></span><tt>add_index</tt><span style="font-family: DejaVu Sans;"><tt>变成</tt></span><tt>index</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span><tt>##</tt><span style="font-family: DejaVu Sans;"><tt>这里是说的新旧两种方法比较</tt></span></p>

<h4><a name="special-helpers"></a><tt>3.3</tt><tt> </tt><tt>Special</tt><tt> </tt><tt>Helpers</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>个别的</tt></span><tt>Helpers</tt></h4>


<p><a name="result_box"></a><tt>Active</tt><tt> </tt><tt>Record</tt><tt> </tt><tt>provides</tt><tt> </tt><tt>some</tt><tt> </tt><tt>shortcuts</tt><tt> </tt><tt>for</tt><tt> </tt><tt>common</tt><tt> </tt><tt>functionality.Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>提供了一些一般功能的快捷操作。</tt><tt></tt></span><tt>It</tt><tt> </tt><tt>is</tt><tt> </tt><tt>for</tt><tt> </tt><tt>example</tt><tt> </tt><tt>very</tt><tt> </tt><tt>common</tt><tt> </tt><tt>to</tt><tt> </tt><tt>add</tt><tt> </tt><tt>both</tt><tt> </tt><tt>the</tt><tt> </tt><tt>created_at</tt><tt> </tt><tt>and</tt><tt> </tt><tt>updated_at</tt><tt> </tt><tt>columns</tt><tt> </tt><tt>and</tt><tt> </tt><tt>so</tt><tt> </tt><tt>there</tt><tt> </tt><tt>is</tt><tt> </tt><tt>a</tt><tt> </tt><tt>method</tt><tt> </tt><tt>that</tt><tt> </tt><tt>does</tt><tt> </tt><tt>exactly</tt><tt> </tt><tt>that:</tt><span style="font-family: DejaVu Sans;"><tt>例如很常见的通过</tt></span><tt>created_at</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>updated_at</tt><span style="font-family: DejaVu Sans;"><tt>添加</tt><tt>字段等等</tt><tt>，这里是一个方法的简要例子</tt></span></p>

<p><code>create_table</code><code> </code><code>:products</code><tt> </tt><code>do</code><tt> </tt><code>|t|</code></p>

<p><code> </code><code>t.timestamps</code></p>

<p><code>end</code></p>

<p><tt>will</tt><tt> </tt><tt>create</tt><tt> </tt><tt>a</tt><tt> </tt><tt>new</tt><tt> </tt><tt>products</tt><tt> </tt><tt>table</tt><tt> </tt><tt>with</tt><tt> </tt><tt>those</tt><tt> </tt><tt>two</tt><tt> </tt><tt>columns</tt><tt> </tt><tt>(plus</tt><tt> </tt><tt>the</tt><tt> </tt><tt>id</tt><tt> </tt><tt>column)</tt><tt> </tt><tt>whereas.</tt><span style="font-family: DejaVu Sans;"><tt>将会新建一个</tt></span><tt>products</tt><span style="font-family: DejaVu Sans;"><tt>表单，有两个字段（加上</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>字段）。</tt></span></p>

<p><code>change_table</code><code> </code><code>:products</code><tt> </tt><code>do</code><tt> </tt><code>|t|</code></p>

<p><code> </code><code>t.timestamps</code></p>

<p><code>end</code></p>

<p><tt>adds</tt><tt> </tt><tt>those</tt><tt> </tt><tt>columns</tt><tt> </tt><tt>to</tt><tt> </tt><tt>an</tt><tt> </tt><tt>existing</tt><tt> </tt><tt>table.</tt><span style="font-family: DejaVu Sans;"><tt>添加一些字段到存在的表中。</tt></span></p>

<p>&nbsp;</p>

<p><tt>The</tt><tt> </tt><tt>other</tt><tt> </tt><tt>helper</tt><tt> </tt><tt>is</tt><tt> </tt><tt>called</tt><tt> </tt><tt>references</tt><tt> </tt><tt>(also</tt><tt> </tt><tt>available</tt><tt> </tt><tt>as</tt><tt> </tt><tt>belongs_to).</tt><tt> </tt><tt>In</tt><tt> </tt><tt>its</tt><tt> </tt><tt>simplest</tt><tt> </tt><tt>form</tt><tt> </tt><tt>it</tt><tt> </tt><tt>just</tt><tt> </tt><tt>adds</tt><tt> </tt><tt>some</tt><tt> </tt><tt>readability</tt><span style="font-family: DejaVu Sans;"><tt>另一个</tt></span><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>被称为</tt><tt></tt></span><tt>references</tt><span style="font-family: DejaVu Sans;"><tt>（也可用</tt></span><tt>belongs_to</tt><span style="font-family: DejaVu Sans;"><tt>）。在其最简单的形式，它仅仅增加一些可读性。</tt></span></p>

<p><code>create_table</code><code> </code><code>:products</code><tt> </tt><code>do</code><tt> </tt><code>|t|</code></p>

<p><code> </code><code>t.references</code><code> </code><code>:category</code></p>

<p><code>end</code></p>

<p><tt>will</tt><tt> </tt><tt>create</tt><tt> </tt><tt>a</tt><tt> </tt><tt>category_id</tt><tt> </tt><tt>column</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>appropriate</tt><tt> </tt><tt>type.</tt><span style="font-family: DejaVu Sans;"><tt>将会创建一个适当形式的</tt></span><tt>category_id</tt><span style="font-family: DejaVu Sans;"><tt>字段。</tt><tt></tt></span><tt>Note</tt><tt> </tt><tt>that</tt><tt> </tt><tt>you</tt><tt> </tt><tt>pass</tt><tt> </tt><tt>the</tt><tt> </tt><tt>model</tt><tt> </tt><tt>name,</tt><tt> </tt><tt>not</tt><tt> </tt><tt>the</tt><tt> </tt><tt>column</tt><tt> </tt><tt>name.</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt> </tt><tt>adds</tt><tt> </tt><tt>the</tt><tt> </tt><tt><em>id</tt><tt> </tt><tt>for</tt><tt> </tt><tt>you.</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>注意那是你关联的</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>名称，不是字段名称。</tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>会给你添加</tt></span><tt></em>id</tt><span style="font-family: DejaVu Sans;"><tt>。</tt><tt></tt></span><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>have</tt><tt> </tt><tt>polymorphic</tt><span style="font-family: DejaVu Sans;"><tt>多态性</tt><tt></tt></span><tt>belongs_to</tt><tt> </tt><tt>associations</tt><tt> </tt><tt>then</tt><tt> </tt><tt>references</tt><tt> </tt><tt>will</tt><tt> </tt><tt>add</tt><tt> </tt><tt>both</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>columns</tt><tt> </tt><tt>required:</tt></p>

<p><code>create_table</code><code> </code><code>:products</code><tt> </tt><code>do</code><tt> </tt><code>|t|</code></p>

<p><code> </code><code>t.references</code><code> </code><code>:attachment,</code><code> </code><code>:polymorphic</code> <code>=&gt;</code><code> </code><code>{:default</code> <code>=&gt;</code><code> </code><code>&lsquo;Photo&rsquo;}</code></p>

<p><code>end</code></p>

<p><tt>will</tt><tt> </tt><tt>add</tt><tt> </tt><tt>an</tt><tt> </tt><tt>attachment_id</tt><tt> </tt><tt>column</tt><tt> </tt><tt>and</tt><tt> </tt><tt>a</tt><tt> </tt><tt>string</tt><tt> </tt><tt>attachment_type</tt><tt> </tt><tt>column</tt><tt> </tt><tt>with</tt><tt> </tt><tt>a</tt><tt> </tt><tt>default</tt><tt> </tt><tt>value</tt><tt> </tt><tt>of</tt><tt> ‘</tt><tt>Photo</tt><tt>’</tt><tt>.</tt><span style="font-family: DejaVu Sans;"><tt>将会添加一个</tt></span><tt>attachment_id</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>和一个</tt><tt></tt><tt>默认值是</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">‘</span></tt></span><tt>Photo</tt><tt>’</tt><span style="font-family: DejaVu Sans;"><tt>的字符串</tt></span><tt>attachment_type</tt><span style="font-family: DejaVu Sans;"><tt>字段。</tt></span></p>

<p><tt>The</tt><tt> </tt><tt>references</tt><tt> </tt><tt>helper</tt><tt> </tt><tt>does</tt><tt> </tt><tt>not</tt><tt> </tt><tt>actually</tt><tt> </tt><tt>create</tt><tt> </tt><tt>foreign</tt><tt> </tt><tt>key</tt><tt> </tt><tt>constraints</tt><tt> </tt><tt>for</tt><tt> </tt><tt>you.</tt><tt> </tt><tt>You</tt><tt> </tt><tt>will</tt><tt> </tt><tt>need</tt><tt> </tt><tt>to</tt><tt> </tt><tt>use</tt><tt> </tt><tt>execute</tt><tt> </tt><tt>for</tt><tt> </tt><tt>that</tt><tt> </tt><tt>or</tt><tt> </tt><tt>a</tt><tt> </tt><tt>plugin</tt><tt> </tt><tt>that</tt><tt> </tt><tt>adds</tt><tt> </tt><a href="http://guides.rubyonrails.org/migrations.html#active-record-and-referential-integrity"><span style="color: #000080;"><span style="text-decoration: underline;">foreign</span></span><span style="color: #000080;"><span style="text-decoration: underline;">key</span></span><span style="color: #000080;"><span style="text-decoration: underline;">support</span></span></a><tt>.references</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>没有真正创建外键约束给你。你需要使用</tt></span><tt>execute</tt><span style="font-family: DejaVu Sans;"><tt>或者一个</tt></span><tt>plugin</tt><span style="font-family: DejaVu Sans;"><tt>来添加外键支持。</tt></span></p>

<p><tt>If</tt><tt> </tt><tt>the</tt><tt> </tt><tt>helpers</tt><tt> </tt><tt>provided</tt><tt> </tt><tt>by</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt> </tt><tt>aren</tt><tt>’</tt><tt>t</tt><tt> </tt><tt>enough</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>use</tt><tt> </tt><tt>the</tt><tt> </tt><tt>execute</tt><tt> </tt><tt>function</tt><tt> </tt><tt>to</tt><tt> </tt><tt>execute</tt><tt> </tt><tt>arbitrary</tt><tt> </tt><tt>SQL.</tt><span style="font-family: DejaVu Sans;"><tt>如果</tt><tt></tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>提供的</tt></span><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>不足以满足，你可以使用</tt><tt></tt></span><tt>execute</tt><span style="font-family: DejaVu Sans;"><tt>功能来执行任意</tt></span><tt>SQL</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>For</tt><tt> </tt><tt>more</tt><tt> </tt><tt>details</tt><tt> </tt><tt>and</tt><tt> </tt><tt>examples</tt><tt> </tt><tt>of</tt><tt> </tt><tt>individual</tt><span style="font-family: DejaVu Sans;"><tt>个别</tt><tt></tt></span><tt>methods</tt><tt> </tt><tt>check</tt><tt> </tt><tt>the</tt><tt> </tt><tt>API</tt><tt> </tt><tt>documentation,</tt><tt> </tt><tt>in</tt><tt> </tt><tt>particular</tt><tt> </tt><tt>the</tt><tt> </tt><tt>documentation</tt><tt> </tt><tt>for</tt><tt> </tt><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html">ActiveRecord::ConnectionAdapters::SchemaStatements</a></span></span><tt> </tt><tt>(which</tt><tt> </tt><tt>provides</tt><tt> </tt><tt>the</tt><tt> </tt><tt>methods</tt><tt> </tt><tt>available</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>up</tt><tt> </tt><tt>and</tt><tt> </tt><tt>down</tt><tt> </tt><tt>methods),</tt><tt> </tt><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html">ActiveRecord::ConnectionAdapters::TableDefinition</a></span></span><tt> </tt><tt>(which</tt><tt> </tt><tt>provides</tt><tt> </tt><tt>the</tt><tt> </tt><tt>methods</tt><tt> </tt><tt>available</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>object</tt><tt> </tt><tt>yielded</tt><tt> </tt><tt>by</tt><tt> </tt><tt>create_table)</tt><tt> </tt><tt>and</tt><tt> </tt><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html">ActiveRecord::ConnectionAdapters::Table</a></span></span><tt> </tt><tt>(which</tt><tt> </tt><tt>provides</tt><tt> </tt><tt>the</tt><tt> </tt><tt>methods</tt><tt> </tt><tt>available</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>object</tt><tt> </tt><tt>yielded</tt><tt> </tt><tt>by</tt><tt> </tt><tt>change_table).</tt></p>

<h4><a name="writing-your-change-method"></a><tt>3.4</tt><tt> </tt><tt>Writing</tt><tt> </tt><tt>Your</tt><tt> </tt><tt>change</tt><tt> </tt><tt>Method</tt></h4>


<p>The <tt>change</tt> method removes the need to write both <tt>up</tt> and <tt>down</tt> methods in those cases that Rails know how to revert the changes automatically. <tt>change(migration</tt><span style="font-family: DejaVu Sans;"><tt>类方法</tt></span><tt>)</tt><span style="font-family: DejaVu Sans;"><tt>删除需要写进</tt></span><tt>up</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>down</tt><span style="font-family: DejaVu Sans;"><tt>的方法，那样</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>知道怎样自动撤销更改。</tt></span>Currently, the <tt>change</tt> method supports only these migration definitions:<span style="font-family: DejaVu Sans;">目前，</span>change<span style="font-family: DejaVu Sans;">方法支持如下的</span>migration<span style="font-family: DejaVu Sans;">定义：</span></p>

<ul>
    <li><tt>add_column</tt></li>
    <li><tt>add_index</tt></li>
    <li><tt>add_timestamps</tt></li>
    <li><tt>create_table</tt></li>
    <li><tt>remove_timestamps</tt></li>
    <li><tt>rename_column</tt></li>
    <li><tt>rename_index</tt></li>
    <li><tt>rename_table</tt></li>
</ul>


<p>If you’re going to use other methods, you’ll have to write the <tt>up</tt> and <tt>down</tt> methods normally.<span style="font-family: DejaVu Sans;">如果你打算使用其他方法，你可以常规的写</span>up<span style="font-family: DejaVu Sans;">和</span>down<span style="font-family: DejaVu Sans;">方法。</span></p>

<h4><a name="writing-your-down-method"></a>3.5 Writing Your <tt>down</tt> Method</h4>


<p>The <tt>down</tt> method of your migration should revert the transformations done by the <tt>up</tt> method.<span style="font-family: DejaVu Sans;">迁移的</span>down<span style="font-family: DejaVu Sans;">方法应该撤销</span>up<span style="font-family: DejaVu Sans;">方法做的转换。</span>In other words the database schema<span style="font-family: DejaVu Sans;">架构</span>should be unchanged if you do an <tt>up</tt> followed by a <tt>down</tt>.<span style="font-family: DejaVu Sans;">换句话说数据库架构应该没有改变，如果你在</span>up<span style="font-family: DejaVu Sans;">方法过后又执行</span>down<span style="font-family: DejaVu Sans;">方法。</span>For example if you create a table in the <tt>up</tt> method you should drop it in the <tt>down</tt> method. It is wise to do things in precisely the reverse order to in the <tt>up</tt> method.<span style="font-family: DejaVu Sans;">例如如果你创建使用</span>up<span style="font-family: DejaVu Sans;">方法一个表你应该在</span>down<span style="font-family: DejaVu Sans;">方法中去除它。</span>For example</p>

<p><code>class</code> <code>ExampleMigration</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>up</code></p>

<p><code> </code><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.references</code><code> </code><code>:category</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>#add</code><code> </code><code>a</code><code> </code><code>foreign</code><code> </code><code>key</code></p>

<p><code> </code><code>execute</code><code> </code><code>&lt;&lt;-SQL</code></p>

<p><code> </code><code>ALTER</code> <code>TABLE</code> <code>products</code></p>

<p><code> </code><code>ADD</code> <code>CONSTRAINT</code> <code>fk_products_categories</code></p>

<p><code> </code><code>FOREIGN</code> <code>KEY</code> <code>(category_id)</code></p>

<p><code> </code><code>REFERENCES</code> <code>categories(id)</code></p>

<p><code> </code><code>SQL</code></p>

<p>&nbsp;</p>

<p><code> </code><code>add_column</code><code> </code><code>:users,</code><code> </code><code>:home_page_url,</code><code> </code><code>:string</code></p>

<p>&nbsp;</p>

<p><code> </code><code>rename_column</code><code> </code><code>:users,</code><code> </code><code>:email,</code><code> </code><code>:email_address</code></p>

<p><code> </code><code>end</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>down</code></p>

<p><code> </code><code>rename_column</code><code> </code><code>:users,</code><code> </code><code>:email_address,</code><code> </code><code>:email</code></p>

<p><code> </code><code>remove_column</code><code> </code><code>:users,</code><code> </code><code>:home_page_url</code></p>

<p><code> </code><code>execute</code><code> </code><code>&ldquo;ALTER</code><code> </code><code>TABLE</code><code> </code><code>products</code><code> </code><code>DROP</code><code> </code><code>FOREIGN</code><code> </code><code>KEY</code><code> </code><code>fk_products_categories&rdquo;</code></p>

<p><code> </code><code>drop_table</code><code> </code><code>:products</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>Sometimes your migration will do something which is just plain irreversible<span style="font-family: DejaVu Sans;">不可逆转的</span>, for example it might destroy some data.<span style="font-family: DejaVu Sans;">有时候你的</span>migration<span style="font-family: DejaVu Sans;">将会做一些不可逆转的事情。例如它可能会删除一些数据。</span>In cases like those when you can’t reverse the migration you can raise <tt>ActiveRecord::IrreversibleMigration</tt> from your <tt>down</tt> method.<span style="font-family: DejaVu Sans;">在这样的情况中你不能撤销</span>migration<span style="font-family: DejaVu Sans;">你可以在你的</span>down<span style="font-family: DejaVu Sans;">方法中</span>raise <tt>ActiveRecord::IrreversibleMigration</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span>If someone tries to revert your migration an error message will be displayed saying that it can’t be done.<span style="font-family: DejaVu Sans;">如果有人尝试撤销你的</span>migration<span style="font-family: DejaVu Sans;">那么一个错误消息将会被显示<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>it can’t be done”<span style="font-family: DejaVu Sans;">。</span></p>

<h3><a name="running-migrations"></a>4 Running Migrations</h3>


<p>Rails provides a set of rake tasks to work with migrations which boils down to running certain sets of migrations. Rails<span style="font-family: DejaVu Sans;">提供给</span>migrations<span style="font-family: DejaVu Sans;">一组</span>rake<span style="font-family: DejaVu Sans;">任务，它大致归纳于运行若干的</span>migrations<span style="font-family: DejaVu Sans;">。</span>The very first migration related rake task you use will probably be <tt>db:migrate</tt>.<span style="font-family: DejaVu Sans;">你使用的非常靠前的</span>migration<span style="font-family: DejaVu Sans;">相应于</span>rake<span style="font-family: DejaVu Sans;">的任务恰好是</span><tt>db:migrate</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span>In its most basic form it just runs the <tt>up</tt> method for all the migrations that have not yet been run.<span style="font-family: DejaVu Sans;">其中它是最基本的形式，它仅仅运行</span>migrations <span style="font-family: DejaVu Sans;">还没被运行的</span>up<span style="font-family: DejaVu Sans;">方法。</span>If there are no such migrations it exits.<span style="font-family: DejaVu Sans;">如果没有这样的迁移它将会退出。</span></p>

<p>Note that running the <tt> </tt><tt>db:migrate</tt> also invokes the <tt>db:schema:dump</tt> task, which will update your db/schema.rb file to match the structure of your database.<span style="font-family: DejaVu Sans;">注意运行</span><tt>db:migrate</tt><span style="font-family: DejaVu Sans;"><tt>也调用了</tt><tt></tt></span><tt>db:schema:dump</tt><span style="font-family: DejaVu Sans;"><tt>任务，它将会更新你的</tt><tt></tt></span><tt>db/schema.rb</tt><span style="font-family: DejaVu Sans;"><tt>来和你的数据库匹配。</tt></span></p>

<p><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>specify</tt><tt> </tt><tt>a</tt><tt> </tt><tt>target</tt><tt> </tt><tt>version,</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt> </tt><tt>will</tt><tt> </tt><tt>run</tt><tt> </tt><tt>the</tt><tt> </tt><tt>required</tt><tt> </tt><tt>migrations</tt><tt> </tt><tt>(up</tt><tt> </tt><tt>or</tt><tt> </tt><tt>down)</tt><tt> </tt><tt>until</tt><tt> </tt><tt>it</tt><tt> </tt><tt>has</tt><tt> </tt><tt>reached</tt><tt> </tt><tt>the</tt><tt> </tt><tt>specified</tt><tt> </tt><tt>version.</tt><span style="font-family: DejaVu Sans;"><tt>如果你特别（指定了）一个目标版本，</tt><tt></tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>将会运行所请求的</tt></span><tt>migrations</tt><span style="font-family: DejaVu Sans;"><tt>（</tt></span><tt>up</tt><span style="font-family: DejaVu Sans;"><tt>或</tt></span><tt>down</tt><span style="font-family: DejaVu Sans;"><tt>）直到它已经达成了（与）指定版本（的匹配）。</tt><tt></tt></span><tt>The</tt><tt> </tt><tt>version</tt><tt> </tt><tt>is</tt><tt> </tt><tt>the</tt><tt> </tt><tt>numerical</tt><tt> </tt><tt>prefix</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>migration</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>filename.</tt><span style="font-family: DejaVu Sans;"><tt>版本号是</tt></span><tt>migration</tt><tt>‘</tt><tt>s</tt><span style="font-family: DejaVu Sans;"><tt>文件的数字前缀。</tt><tt></tt></span><tt>For</tt><tt> </tt><tt>example</tt><tt> </tt><tt>to</tt><tt> </tt><tt>migrate</tt><tt> </tt><tt>to</tt><tt> </tt><tt>version</tt><tt> </tt><tt>20080906120000</tt><tt> </tt><tt>run</tt><span style="font-family: DejaVu Sans;"><tt>例如迁移到</tt></span><tt>20080906120000</tt><span style="font-family: DejaVu Sans;"><tt>版本</tt></span></p>

<p><code>$</code><code> </code><code>rake</code><code> </code><code>db:migrate</code><code> </code><code>VERSION=20080906120000</code></p>

<p><code>If</code><code> </code><code>this</code><code> </code><code>is</code><code> </code><code>greater</code><code> </code><code>than</code><code> </code><code>the</code><code> </code><code>current</code><code> </code><code>version</code><code> </code><code>(i.e.</code><code> </code><code>it</code><code> </code><code>is</code><code> </code><code>migrating</code><code> </code><code>upwards)</code><code> </code><code>this</code><code> </code><code>will</code><code> </code><code>run</code><code> </code><code>the</code><code> </code><tt>up</tt><code> </code><code>method</code><code> </code><code>on</code><code> </code><code>all</code><code> </code><code>migrations</code><code> </code><code>up</code><code> </code><code>to</code><code> </code><code>and</code><code> </code><code>including</code><code> </code><code>20080906120000,</code><code> </code><code>if</code><code> </code><code>migrating</code><code> </code><code>downwards</code><code> </code><code>this</code><code> </code><code>will</code><code> </code><code>run</code><code> </code><code>the</code><code> </code><tt>down</tt><code> </code><code>method</code><code> </code><code>on</code><code> </code><code>all</code><code> </code><code>the</code><code> </code><code>migrations</code><code> </code><code>down</code><code> </code><code>to,</code><code> </code><code>but</code><code> </code><code>not</code><code> </code><code>including,</code><code> </code><code>20080906120000.</code><span style="font-family: DejaVu Sans;"><code>如果执行的版本比当前版本更优（新）</code></span><code>(i.e.</code><code> </code><code>it</code><code> </code><code>is</code><code> </code><code>migrating</code><code> </code><code>upwards)</code><span style="font-family: DejaVu Sans;"><code>这将会执行包含</code></span><code>20080906120000</code><span style="font-family: DejaVu Sans;"><code>的所有版本的</code></span><code>migrations</code><code> </code><code>up</code><span style="font-family: DejaVu Sans;"><code>方法，反之则执行不包括</code></span><code>20080906120000</code><span style="font-family: DejaVu Sans;"><code>的版本之外的所有版本的</code></span><code>migrations</code><code> </code><code>down</code><span style="font-family: DejaVu Sans;"><code>方法。</code></span></p>

<h4><a name="rolling-back1"></a><code>4.1</code><code> </code><code>Rolling</code><code> </code><code>Back</code></h4>


<p>A common task is to rollback the last migration, for example if you made a mistake in it and wish to correct it.<span style="font-family: DejaVu Sans;">一个常用的任务来回滚最新的</span>migration<span style="font-family: DejaVu Sans;">，例如如果你在其中犯了一个错误希望</span>Rails<span style="font-family: DejaVu Sans;">能够改正它。</span>Rather than tracking down the version number associated with the previous migration you can run</p>

<p><code>$</code><code> </code><code>rake</code><code> </code><span style="color: #000080;"><span style="text-decoration: underline;"><a href="db:rollback">db:rollback</a></span></span></p>

<p><code>This</code><code> </code><code>will</code><code> </code><code>run</code><code> </code><code>the</code><code> </code><tt>down</tt><code> </code><code>method</code><code> </code><code>from</code><code> </code><code>the</code><code> </code><code>latest</code><code> </code><code>migration.</code><span style="font-family: DejaVu Sans;"><code>这将会对最新的</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>执行</code></span><code>down</code><span style="font-family: DejaVu Sans;"><code>方法。</code><code></code></span><code>If</code><code> </code><code>you</code><code> </code><code>need</code><code> </code><code>to</code><code> </code><code>undo</code><code> </code><code>several</code><code> </code><code>migrations</code><code> </code><code>you</code><code> </code><code>can</code><code> </code><code>provide</code><code> </code><code>a</code><code> </code><tt>STEP</tt><code> </code><code>parameter:</code><span style="font-family: DejaVu Sans;"><code>如果你需要撤销一系列的</code></span><code>migrations</code><span style="font-family: DejaVu Sans;"><code>你可以提供一个</code></span><code>STEP</code><code> </code><span style="font-family: DejaVu Sans;"><code>参数：</code></span></p>

<p><code>$</code><code> </code><code>rake</code><code> </code><code>db:rollback</code><code> </code><code>STEP=3</code></p>

<p><code>will</code><code> </code><code>run</code><code> </code><code>the</code><code> </code><tt>down</tt><code> </code><code>method</code><code> </code><code>from</code><code> </code><code>the</code><code> </code><code>last</code><code> </code><code>3</code><code> </code><code>migrations.</code><span style="font-family: DejaVu Sans;"><code>将会对最近的</code></span><code>3</code><span style="font-family: DejaVu Sans;"><code>次迁移执行</code></span><code>down</code><span style="font-family: DejaVu Sans;"><code>方法。</code></span></p>

<p><a name="rolling-back"></a>The rake <tt>db:migrate:redo</tt> task is a shortcut for doing a rollback and then migrating back up again. rake <tt>db:migrate:redo</tt><span style="font-family: DejaVu Sans;"><tt>任务是一个回滚后再次返回的快捷操作。</tt></span>As with the <tt>db:rollback</tt> task you can use the <tt>STEP</tt> parameter if you need to go more than one version back, for example<span style="font-family: DejaVu Sans;">通过</span>db<span style="font-family: DejaVu Sans;">：</span>rollback <span style="font-family: DejaVu Sans;">任务你可以使用</span>STEP<span style="font-family: DejaVu Sans;">参数如果你需要撤销超过一个版本，例如</span></p>

<p><code>$</code><code> </code><code>rake</code><code> </code><code>db:migrate:redo</code><code> </code><code>STEP=3</code></p>

<p><code>Neither</code><code> </code><code>of</code><code> </code><code>these</code><code> </code><code>Rake</code><code> </code><code>tasks</code><code> </code><code>do</code><code> </code><code>anything</code><code> </code><code>you</code><code> </code><code>could</code><code> </code><code>not</code><code> </code><code>do</code><code> </code><code>with</code><code> </code><tt>db:migrate</tt><code>,</code><code> </code><code>they</code><code> </code><code>are</code><code> </code><code>simply</code><code> </code><code>more</code><code> </code><code>convenient</code><span style="font-family: DejaVu Sans;"><code>方便</code><code></code></span><code>since</code><code> </code><code>you</code><code> </code><code>do</code><code> </code><code>not</code><code> </code><code>need</code><code> </code><code>to</code><code> </code><code>explicitly</code><code> </code><code>specify</code><code> </code><code>the</code><code> </code><code>version</code><code> </code><code>to</code><code> </code><code>migrate</code><code> </code><code>to.</code><span style="font-family: DejaVu Sans;"><code>（通过）上两次</code></span><code>rake</code><span style="font-family: DejaVu Sans;"><code>任务，你没有对</code></span><code>db:migrate</code><span style="font-family: DejaVu Sans;"><code>任何事情，如果你不需要指定明确的版本来迁移这样做都非常方便。</code></span></p>

<p>Lastly, the <tt>db:reset</tt> task will drop the database, recreate it and load the current schema into it.<span style="font-family: DejaVu Sans;">最后，</span></p>

<p><tt>db:reset</tt><span style="font-family: DejaVu Sans;"><tt>任务将会</tt></span><tt>drop</tt><span style="font-family: DejaVu Sans;"><tt>数据库，重建它并且在其中导入正确的架构。</tt></span></p>

<p><code> This</code><code> </code><code>is</code><code> </code><code>not</code><code> </code><code>the</code><code> </code><code>same</code><code> </code><code>as</code><code> </code><code>running</code><code> </code><code>all</code><code> </code><code>the</code><code> </code><code>migrations</code><code> – </code><code>see</code><code> </code><code>the</code><code> </code><code>section</code><code> </code><code>on</code><code> </code><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/migrations.html#schema-dumping-and-you">schema.rb</a></span></span><code>.</code><span style="font-family: DejaVu Sans;"><code>这和运行所有的</code></span><code>migrations</code><span style="font-family: DejaVu Sans;"><code>不一样</code><code><span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></code><code>阅读</code><code></code></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/migrations.html#schema-dumping-and-you">schema.rb</a></span></span><span style="font-family: DejaVu Sans;"><code>章节。</code></span></p>

<h4><a name="being-specific"></a><code>4.2</code><code> </code><code>Being</code><code> </code><code>Specific</code><span style="font-family: WenQuanYi Micro Hei;"><code>开始指定的</code></span></h4>


<p>If you need to run a specific migration up or down the <tt>db:migrate:up</tt> and <tt>db:migrate:down</tt> tasks will do that. <span style="font-family: DejaVu Sans;">如果你需要对一个指定的版本</span>migration<span style="font-family: DejaVu Sans;">执行</span>up<span style="font-family: DejaVu Sans;">或</span>down<span style="font-family: DejaVu Sans;">，那么</span><tt>db:migrate:up</tt> and <tt>db:migrate:down</tt><span style="font-family: DejaVu Sans;"><tt>任务会满足你。</tt></span>Just specify the appropriate version and the corresponding migration will have its <tt>up</tt> or <tt>down</tt> method invoked, for example<span style="font-family: DejaVu Sans;">指定适当的版本那么相应的</span>migration<span style="font-family: DejaVu Sans;">就会调用它的</span>up<span style="font-family: DejaVu Sans;">或</span>down<span style="font-family: DejaVu Sans;">方法，例如</span></p>

<p><code>$</code><code> </code><code>rake</code><code> </code><code>db:migrate:up</code><code> </code><code>VERSION=20080906120000</code></p>

<p><code>will</code><code> </code><code>run</code><code> </code><code>the</code><code> </code><tt>up</tt><code> </code><code>method</code><code> </code><code>from</code><code> </code><code>the</code><code> </code><code>20080906120000</code><code> </code><code>migration.</code><span style="font-family: DejaVu Sans;"><code>将会执行来自</code><code></code></span><code>20080906120000</code><span style="font-family: DejaVu Sans;"><code>版本的</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>的</code></span><code>up</code><span style="font-family: DejaVu Sans;"><code>方法。</code><code></code></span><code>These</code><code> </code><code>tasks</code><code> </code><code>check</code><code> </code><code>whether</code><code> </code><code>the</code><code> </code><code>migration</code><code> </code><code>has</code><code> </code><code>already</code><code> </code><code>run,</code><code> </code><code>so</code><code> </code><code>for</code><code> </code><code>example</code><code> </code><tt>db:migrate:up</tt><tt> </tt><tt>VERSION=20080906120000</tt><code> </code><code>will</code><code> </code><code>do</code><code> </code><code>nothing</code><code> </code><code>if</code><code> </code><code>Active</code><code> </code><code>Record</code><code> </code><code>believes</code><code> </code><code>that</code><code> </code><code>20080906120000</code><code> </code><code>has</code><code> </code><code>already</code><code> </code><code>been</code><code> </code><code>run.</code><span style="font-family: DejaVu Sans;"><code>这个任务会检查</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>是否已经运行，如果</code><code></code></span><code>Active</code><code> </code><code>Record</code><span style="font-family: DejaVu Sans;"><code>认为已经被运行过了</code><code></code></span><tt>db:migrate:up</tt><tt> </tt><tt>VERSION=20080906120000</tt><span style="font-family: DejaVu Sans;"><tt>将不会做任何事情。</tt></span></p>

<h4><a name="being-talkative"></a>4.3 Being Talkative<span style="font-family: WenQuanYi Micro Hei;">开始唠叨</span></h4>


<p>By default migrations tell you exactly what they’re doing and how long it took.<span style="font-family: DejaVu Sans;">通过默认的</span>migrations<span style="font-family: DejaVu Sans;">会明确地告诉你他们做了什么以及花费了多长时间。</span>A migration creating a table and adding an index might produce output like this<span style="font-family: DejaVu Sans;">一次迁移创建一个表并且添加一个</span>index<span style="font-family: DejaVu Sans;">可能会产生这样的输出</span></p>

<p><code>20080906170109</code><code> </code><code>CreateProducts:</code><code> </code><code>migrating</code></p>

<p><code>&mdash;</code><code> </code><code>create_table(:products)</code></p>

<p><code> </code><code>&ndash;&gt;</code><code> </code><code>0.0021s</code></p>

<p><code>&mdash;</code><code> </code><code>add_index(:products,</code><code> </code><code>:name)</code></p>

<p><code> </code><code>&ndash;&gt;</code><code> </code><code>0.0026s</code></p>

<p><code>20080906170109</code><code> </code><code>CreateProducts:</code><code> </code><code>migrated</code><code> </code><code>(0.0059s)</code></p>

<p>Several methods are provided that allow you to control all this:<span style="font-family: DejaVu Sans;">一些方法（被证明）允许你像下面这样控制</span></p>

<ul>
    <li><tt>suppress_messages</tt> takes a block as an argument and suppresses<span style="font-family: DejaVu Sans;">抑制</span>any output generated by the block. <tt>suppress_messages</tt><span style="font-family: DejaVu Sans;">获取一个</span>block<span style="font-family: DejaVu Sans;">作为一个参数并且抑制常规输出到</span>block</li>
    <li><tt>say</tt> takes a message argument and outputs it as is. A second boolean argument can be passed to specify whether to indent<span style="font-family: DejaVu Sans;">缩进</span>or not. <tt>say</tt><span style="font-family: DejaVu Sans;"><tt>获取一个</tt></span><tt>message</tt><span style="font-family: DejaVu Sans;"><tt>参数并且输出它。第二个布尔参数可以指定是否缩进</tt></span></li>
    <li><tt>say_with_time</tt> outputs text along with how long it took to run its block. If the block returns an integer it assumes it is the number of rows affected. say_with_time<span style="font-family: DejaVu Sans;"><tt>在文字旁边输出运行这个代码块花费了多少时间。如果</tt></span><tt>block</tt><span style="font-family: DejaVu Sans;"><tt>返回一个整数它假设这是受影响的代码行。</tt></span></li>
</ul>


<p>For example, this migration<span style="font-family: DejaVu Sans;">例如，这个</span>migration</p>

<p><code>class</code> <code>CreateProducts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>suppress_messages</code><code> </code><code>do</code></p>

<p><code> </code><code>create_table</code><code> </code><code>:products</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:name</code></p>

<p><code> </code><code>t.text</code><code> </code><code>:description</code></p>

<p><code> </code><code>t.timestamps</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>say</code><code> </code><code>&ldquo;Created</code><code> </code><code>a</code><code> </code><code>table&rdquo;</code></p>

<p><code> </code><code>suppress_messages</code><code> </code><code>{add_index</code><code> </code><code>:products,</code><code> </code><code>:name}</code></p>

<p><code> </code><code>say</code><code> </code><code>&ldquo;and</code><code> </code><code>an</code><code> </code><code>index!&rdquo;,</code><code> </code><code>true</code></p>

<p><code> </code><code>say_with_time</code><code> </code><code>&lsquo;Waiting</code><code> </code><code>for</code><code> </code><code>a</code><code> </code><code>while&rsquo;</code> <code>do</code></p>

<p><code> </code><code>sleep</code><code> </code><code>10</code></p>

<p><code> </code><code>250</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>generates the following output<span style="font-family: DejaVu Sans;">一般情况会得到如下输出</span></p>

<p>== CreateProducts: migrating =================================================</p>

<p>&mdash; Created a table</p>

<p>&ndash;&gt; and an index!</p>

<p>&mdash; Waiting for a while</p>

<p>&ndash;&gt; 10.0108s</p>

<p>&ndash;&gt; 250 rows</p>

<p>== CreateProducts: migrated (10.0171s) =======================================</p>

<p>If you just want Active Record to shut up then running <tt>rake</tt><tt> </tt><tt>db:migrate</tt><tt> </tt><tt>VERBOSE=false</tt> will suppress<span style="font-family: DejaVu Sans;">抑制</span>all output.<span style="font-family: DejaVu Sans;">如果你希望让所有</span>Active Record<span style="font-family: DejaVu Sans;">闭嘴，那么运行</span><tt>rake</tt><tt> </tt><tt>db:migrate</tt><tt> </tt><tt>VERBOSE=false</tt><span style="font-family: DejaVu Sans;"><tt>会抑制所有的输出。</tt></span></p>

<h3><a name="using-models-in-your-migrations"></a>5 Using Models in Your Migrations<span style="font-family: WenQuanYi Micro Hei;">在你的</span>migration<span style="font-family: WenQuanYi Micro Hei;">中使用</span>Moldels</h3>


<p>When creating or updating data in a migration it is often tempting to use one of your models<span style="font-family: DejaVu Sans;">新建或更新一个</span>migration<span style="font-family: DejaVu Sans;">的数据它通常会使你的</span>models<span style="font-family: DejaVu Sans;">更有诱惑力。</span>After all they exist to provide easy access to the underlying<span style="font-family: DejaVu Sans;">底层</span>data.<span style="font-family: DejaVu Sans;">毕竟他们的存在提供了对底层数据的访问。</span>This can be done, but some caution<span style="font-family: DejaVu Sans;">注意</span>should be observed<span style="font-family: DejaVu Sans;">观察</span>.<span style="font-family: DejaVu Sans;">这是可行的，但是有些地方需要注意。</span></p>

<p>For example, problems occur when the model uses database columns which are (1) not currently in the database and (2) will be created by this or a subsequent migration.<span style="font-family: DejaVu Sans;">例如，问题焦点当</span>models<span style="font-family: DejaVu Sans;">使用数据库字段，但是</span>migration<span style="font-family: DejaVu Sans;">（</span>1<span style="font-family: DejaVu Sans;">）在数据库中没有这个字段而</span>migration<span style="font-family: DejaVu Sans;">（</span>2<span style="font-family: DejaVu Sans;">）将会被它本身的</span>migration<span style="font-family: DejaVu Sans;">文件或者随后的</span>migration<span style="font-family: DejaVu Sans;">创建。</span></p>

<p>Consider this example, where Alice and Bob are working on the same code base which contains a <tt>Product</tt> model:<span style="font-family: DejaVu Sans;">思考这个例子，</span>Alice<span style="font-family: DejaVu Sans;">和</span>Bob<span style="font-family: DejaVu Sans;">工作在同样的代码中，其主要包含一个</span>Product<span style="font-family: DejaVu Sans;">模型：</span></p>

<p>Bob goes on vacation. Bob<span style="font-family: DejaVu Sans;">在休假</span></p>

<p>Alice creates a migration for the <tt>products</tt> table which adds a new column and initializes it. She also adds a validation to the Product model for the new column. Alice<span style="font-family: DejaVu Sans;">创建一个</span>products<span style="font-family: DejaVu Sans;">表单的</span>migration<span style="font-family: DejaVu Sans;">，其添加一个新的字段并初始化它。她也添加一个关于新字段的验证到</span>Product<span style="font-family: DejaVu Sans;">模型。</span></p>

<p>rails generate migration AddFlagToProduct flag:int#<span style="font-family: DejaVu Sans;">然后再添加一部分这样通过创建器的话</span>model<span style="font-family: DejaVu Sans;">文件也一起创建了</span></p>

<p><code>#</code><code> </code><code>db/migrate/20100513121110_add_flag_to_product.rb</code></p>

<p>&nbsp;</p>

<p><code>class</code> <code>AddFlagToProduct</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:flag,</code><code> </code><code>:int</code></p>

<p><code> </code><code>Product.all.each</code> <code>{</code><code> </code><code>|f|</code><code> </code><code>f.update_attributes!(:flag</code> <code>=&gt;</code><code> </code><code>&lsquo;false&rsquo;)</code><code> </code><code>}#</code><span style="font-family: DejaVu Sans;"><code>初始化置为</code></span><code>false</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>&nbsp;</p>

<p><code>#</code><code> </code><code>app/model/product.rb</code></p>

<p>&nbsp;</p>

<p><code>class</code> <code>Product</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:flag,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p><code>Alice</code><code> </code><code>adds</code><code> </code><code>a</code><code> </code><code>second</code><code> </code><code>migration</code><code> </code><code>which</code><code> </code><code>adds</code><code> </code><code>and</code><code> </code><code>initializes</code><code> </code><code>another</code><code> </code><code>column</code><code> </code><code>to</code><code> </code><code>the</code><code> </code><tt>products</tt><code> </code><code>table</code><code> </code><code>and</code><code> </code><code>also</code><code> </code><code>adds</code><code> </code><code>a</code><code> </code><code>validation</code><code> </code><code>to</code><code> </code><code>the</code><code> </code><code>Product</code><code> </code><code>model</code><code> </code><code>for</code><code> </code><code>the</code><code> </code><code>new</code><code> </code><code>column.Alice</code><span style="font-family: DejaVu Sans;"><code>添加第二个</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>，在这个</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>中给</code></span><code>Products</code><span style="font-family: DejaVu Sans;"><code>表单添加并初始化了另一个字段，而且为</code></span><code>Product</code><code> </code><code>model</code><span style="font-family: DejaVu Sans;"><code>的新字段添加并初始化了验证。</code></span></p>

<p><code>#</code><code> </code><code>db/migrate/20100515121110_add_fuzz_to_product.rb</code></p>

<p>&nbsp;</p>

<p><code>class</code> <code>AddFuzzToProduct</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:fuzz,</code><code> </code><code>:string</code></p>

<p><code> </code><code>Product.all.each</code> <code>{</code><code> </code><code>|f|</code><code> </code><code>f.update_attributes!</code><code> </code><code>:fuzz</code> <code>=&gt;</code><code> </code><code>&lsquo;fuzzy&rsquo;</code> <code>}</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><code>#</code><code> </code><code>app/model/product.rb</code></p>

<p>&nbsp;</p>

<p><code>class</code> <code>Product</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:flag,</code><code> </code><code>:fuzz,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code>end</code></p>

<p><code>Both</code><code> </code><code>migrations</code><code> </code><code>work</code><code> </code><code>for</code><code> </code><code>Alice.</code><span style="font-family: DejaVu Sans;"><code>两个</code></span><code>migrations</code><span style="font-family: DejaVu Sans;"><code>都是</code></span><code>Alice</code><span style="font-family: DejaVu Sans;"><code>编写的。</code></span></p>

<p><code>Bob</code><code> </code><code>comes</code><code> </code><code>back</code><code> </code><code>from</code><code> </code><code>vacation</code><span style="font-family: DejaVu Sans;"><code>假期</code><code></code></span><code>and:Bob</code><span style="font-family: DejaVu Sans;"><code>休假回来然后接着下面的工作</code></span></p>

<ol>
    <li><code>updates</code><code> </code><code>the</code><code> </code><code>source</code><code> – </code><code>which</code><code> </code><code>contains</code><code> </code><code>both</code><code> </code><code>migrations</code><code> </code><code>and</code><code> </code><code>the</code><code> </code><code>latests</code><code> </code><code>version</code><code> </code><code>of</code><code> </code><code>the</code><code> </code><code>Product</code><code> </code><code>model.</code><code> </code><span style="font-family: DejaVu Sans;"><code>更新源代码</code><code><span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></code><code>包含</code></span><code>migrations</code><span style="font-family: DejaVu Sans;"><code>和最新版本的</code></span><code>Product</code><span style="font-family: DejaVu Sans;"><code>模型。</code></span></li>
    <li>runs outstanding migrations with <tt>rake</tt><tt> </tt><tt>db:migrate</tt>, which includes the one that updates the <tt>Product</tt> model. <span style="font-family: DejaVu Sans;">通过</span><tt>rake</tt><tt> </tt><tt>db:migrate</tt><span style="font-family: DejaVu Sans;">执行突出（最新版本的</span>migration<span style="font-family: DejaVu Sans;">）的</span>migrations<span style="font-family: DejaVu Sans;">，其中包含了更新</span>Product<span style="font-family: DejaVu Sans;">模型。</span></li>
</ol>


<p>The migration crashes because when the model attempts<span style="font-family: DejaVu Sans;">尝试</span>to save, it tries to validate the second added column, which is not in the database when the <em>first</em> migration runs.<span style="font-family: DejaVu Sans;">数据迁移冲突因为当</span>model<span style="font-family: DejaVu Sans;">尝试保存时，它试图验证第二个添加的字段，然而它在第一次</span>migration<span style="font-family: DejaVu Sans;">运行时不在数据库中。（没有弄明白呢感觉好像两个迁移是分开的才会出现这样的错误）</span></p>

<p><code>rake</code><code> </code><code>aborted!</code></p>

<p><code>An</code><code> </code><code>error</code><code> </code><code>has</code><code> </code><code>occurred,</code><code> </code><code>this</code><code> </code><code>and</code><code> </code><code>all</code><code> </code><code>later</code><code> </code><code>migrations</code><code> </code><code>canceled:</code></p>

<p>&nbsp;</p>

<p><code>undefined</code><code> </code><code>method</code><code> </code><code>`fuzz'</code><code> </code><code>for</code><code> </code><code>#&lt;Product:0x000001049b14a0&gt;</code></p>

<p>A fix for this is to create a local model within the migration.<span style="font-family: DejaVu Sans;">解决这个错误是在</span>migration<span style="font-family: DejaVu Sans;">创建一个本地的</span>model<span style="font-family: DejaVu Sans;">。</span>This keeps rails from running the validations, so that the migrations run to completion.<span style="font-family: DejaVu Sans;">这样在</span>rails<span style="font-family: DejaVu Sans;">运行中保持了验证，使得</span>migrations<span style="font-family: DejaVu Sans;">完成了验证。</span></p>

<p>When using a faux model, it’s a good idea to call <tt>Product.reset_column_information</tt> to refresh the ActiveRecord cache for the Product model prior<span style="font-family: DejaVu Sans;">前</span>to updating data in the database.<span style="font-family: DejaVu Sans;">当使用一个人造的</span>model<span style="font-family: DejaVu Sans;">，调用</span><tt>Product.reset_column_information</tt><span style="font-family: DejaVu Sans;"><tt>来刷新在更新数据到数据库前的</tt></span><tt>Product</tt><tt> </tt><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>ActiveRecord</tt><span style="font-family: DejaVu Sans;"><tt>缓存是一个好主意。</tt></span></p>

<p><tt>If</tt><tt> </tt><tt>Alice</tt><tt> </tt><tt>had</tt><tt> </tt><tt>done</tt><tt> </tt><tt>this</tt><tt> </tt><tt>instead,</tt><tt> </tt><tt>there</tt><tt> </tt><tt>would</tt><tt> </tt><tt>have</tt><tt> </tt><tt>been</tt><tt> </tt><tt>no</tt><tt> </tt><tt>problem:</tt><span style="font-family: DejaVu Sans;"><tt>如果</tt></span><tt>Alice</tt><span style="font-family: DejaVu Sans;"><tt>这样做了就不会有问题了</tt></span></p>

<p><code>#</code><code> </code><code>db/migrate/20100513121110_add_flag_to_product.rb</code></p>

<p>&nbsp;</p>

<p><code>class</code> <code>AddFlagToProduct</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>class</code> <code>Product</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>end</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:flag,</code><code> </code><code>:int</code></p>

<p><code> </code><code>Product.reset_column_information</code></p>

<p><code> </code><code>Product.all.each</code> <code>{</code><code> </code><code>|f|</code><code> </code><code>f.update_attributes!(:flag</code> <code>=&gt;</code><code> </code><code>false)</code><code> </code><code>}</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>&nbsp;</p>

<p><code>class</code><tt> </tt><code>AddFuzzToProduct</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>class</code> <code>Product</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>add_column</code><code> </code><code>:products,</code><code> </code><code>:fuzz,</code><code> </code><code>:string</code></p>

<p><code> </code><code>Product.reset_column_information</code></p>

<p><code> </code><code>Product.all.each</code> <code>{</code><code> </code><code>|f|</code><code> </code><code>f.update_attributes!</code><code> </code><code>:fuzz</code> <code>=&gt;</code><code> </code><code>&lsquo;fuzzy&rsquo;</code> <code>}</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>&nbsp;</p>

<h3><a name="schema-dumping-and-you"></a><tt>6</tt><tt> </tt><tt>Schema</tt><tt> </tt><tt>Dumping</tt><tt> </tt><tt>and</tt><tt> </tt><tt>You</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>架构模式和你</tt></span></h3>


<h4><a name="what-are-schema-files-for"></a><tt>6.1</tt><tt> </tt><tt>What</tt><tt> </tt><tt>are</tt><tt> </tt><tt>Schema</tt><tt> </tt><tt>Files</tt><tt> </tt><tt>for?</tt></h4>


<p><tt>Migrations,</tt><tt> </tt><tt>mighty</tt><tt> </tt><tt>as</tt><tt> </tt><tt>they</tt><tt> </tt><tt>may</tt><tt> </tt><tt>be,</tt><tt> </tt><tt>are</tt><tt> </tt><tt>not</tt><tt> </tt><tt>the</tt><tt> </tt><tt>authoritative</tt><tt> </tt><tt>source</tt><tt> </tt><tt>for</tt><tt> </tt><tt>your</tt><tt> </tt><tt>database</tt><tt> </tt><tt>schema.</tt><tt> </tt><tt>Migrations</tt><span style="font-family: DejaVu Sans;"><tt>，很可能不是你的数据库</tt></span><tt>schema</tt><span style="font-family: DejaVu Sans;"><tt>的授权源。</tt><tt></tt></span><tt>That</tt><tt> </tt><tt>role</tt><tt> </tt><tt>falls</tt><tt> </tt><tt>to</tt><tt> </tt><tt>either</tt><tt> </tt><tt>db/schema.rb</tt><tt> </tt><tt>or</tt><tt> </tt><tt>an</tt><tt> </tt><tt>SQL</tt><tt> </tt><tt>file</tt><tt> </tt><tt>which</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt> </tt><tt>generates</tt><tt> </tt><tt>by</tt><tt> </tt><tt>examining</tt><tt> </tt><tt>the</tt><tt> </tt><tt>database.</tt><span style="font-family: DejaVu Sans;"><tt>这一规则影响到</tt><tt></tt></span><tt>db/schema.rb</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>SQL</tt><span style="font-family: DejaVu Sans;"><tt>文件它是</tt><tt></tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>创建器通过检查数据库生成的。</tt><tt></tt></span><tt>They</tt><tt> </tt><tt>are</tt><tt> </tt><tt>not</tt><tt> </tt><tt>designed</tt><tt> </tt><tt>to</tt><tt> </tt><tt>be</tt><tt> </tt><tt>edited,</tt><tt> </tt><tt>they</tt><tt> </tt><tt>just</tt><tt> </tt><tt>represent</tt><tt> </tt><tt>the</tt><tt> </tt><tt>current</tt><tt> </tt><tt>state</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>database.</tt><span style="font-family: DejaVu Sans;"><tt>他们的设计（原意）是不被编辑的，他们仅仅是当前数据库状态的一个表现。</tt></span></p>

<p>There is no need (and it is error prone) to deploy<span style="font-family: DejaVu Sans;">部署</span>a new instance of an app by replaying the entire<span style="font-family: DejaVu Sans;">整个</span>migration history. It is much simpler and faster to just load into the database a description of the current schema.<span style="font-family: DejaVu Sans;">这里没有必要（并且是错误倾向）去通过</span>replaying<span style="font-family: DejaVu Sans;">整个</span>migration<span style="font-family: DejaVu Sans;">历史来部署一个</span>app<span style="font-family: DejaVu Sans;">的新的实例。更明智和更快捷的方式是</span>load<span style="font-family: DejaVu Sans;">数据库的描述（也就是）当前</span>schema<span style="font-family: DejaVu Sans;">。</span></p>

<p>For example, this is how the test database is created: the current development database is dumped (either to <tt>db/schema.rb</tt> or <tt>db/development.sql</tt>) and then loaded into the test database.<span style="font-family: DejaVu Sans;">例如，这是测试数据库怎样被创建的：当前的开发数据库已经被转储（要么</span><tt>db/schema.rb</tt> <span style="font-family: DejaVu Sans;">要么</span><tt>db/development.sql</tt><span style="font-family: DejaVu Sans;">）然后被导入</span>test<span style="font-family: DejaVu Sans;">数据库。</span></p>

<p>Schema files are also useful if you want a quick look at what attributes an Active Record object has. Schema<span style="font-family: DejaVu Sans;">文件在你希望快速的查看</span>Active Record object<span style="font-family: DejaVu Sans;">有些什么属性的时候也很有帮助。</span>This information is not in the model’s code and is frequently spread across several migrations but is all summed up in the schema file. <span style="font-family: DejaVu Sans;">这些信息不是</span>model<span style="font-family: DejaVu Sans;">中的代码并且频繁分布在多个</span>migrations<span style="font-family: DejaVu Sans;">但是是所有架构文件的总结。</span>The <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://agilewebdevelopment.com/plugins/annotate_models">annotate_models</a></span></span> plugin, which automatically adds (and updates) comments at the top of each model summarizing the schema, may also be of interest. <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://agilewebdevelopment.com/plugins/annotate_models">annotate_models</a></span></span> <span style="font-family: DejaVu Sans;">插件，它能够自动在每个</span>model<span style="font-family: DejaVu Sans;">汇总的顶部的添加（更新）</span>comments<span style="font-family: DejaVu Sans;">，可能你会有兴趣。</span></p>

<h4><a name="types-of-schema-dumps"></a><tt>6.2</tt><tt> </tt><tt>Types</tt><tt> </tt><tt>of</tt><tt> </tt><tt>Schema</tt><tt> </tt><tt>Dumps</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>架构转储的形式</tt></span></h4>


<p>There are two ways to dump the schema. This is set in <tt>config/application.rb</tt> by the <tt>config.active_record.schema_format</tt> setting, which may be either <tt>:sql</tt> or <tt>:ruby</tt>.<span style="font-family: DejaVu Sans;">有两种方式来转储架构。这是（相关）设置在</span><tt>config/application.rb</tt><span style="font-family: DejaVu Sans;"><tt>通过</tt><tt></tt></span><tt>config.active_record.schema_format</tt><span style="font-family: DejaVu Sans;"><tt>来设置，其形式要么是</tt></span><tt>:sql</tt><span style="font-family: DejaVu Sans;"><tt>要么是</tt></span><tt>:ruby.</tt></p>

<p><tt>If</tt><tt> </tt><tt>:ruby</tt><tt> </tt><tt>is</tt><tt> </tt><tt>selected</tt><tt> </tt><tt>then</tt><tt> </tt><tt>the</tt><tt> </tt><tt>schema</tt><tt> </tt><tt>is</tt><tt> </tt><tt>stored</tt><tt> </tt><tt>in</tt><tt> </tt><tt>db/schema.rb.</tt><tt> </tt><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>look</tt><tt> </tt><tt>at</tt><tt> </tt><tt>this</tt><tt> </tt><tt>file</tt><tt> </tt><tt>you</tt><tt>’</tt><tt>ll</tt><tt> </tt><tt>find</tt><tt> </tt><tt>that</tt><tt> </tt><tt>it</tt><tt> </tt><tt>looks</tt><tt> </tt><tt>an</tt><tt> </tt><tt>awful</tt><span style="font-family: DejaVu Sans;"><tt>可怕</tt><tt></tt></span><tt>lot</tt><tt> </tt><tt>like</tt><tt> </tt><tt>one</tt><tt> </tt><tt>very</tt><tt> </tt><tt>big</tt><tt> </tt><tt>migration:</tt><span style="font-family: DejaVu Sans;"><tt>如果</tt></span><tt>:ruby</tt><span style="font-family: DejaVu Sans;"><tt>被选中那么</tt></span><tt>schema</tt><span style="font-family: DejaVu Sans;"><tt>被存储在</tt><tt></tt></span><tt>db/schema.rb</tt><span style="font-family: DejaVu Sans;"><tt>。如果你查看这个文件你将会发现它看起来就像一个很大的</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><code>ActiveRecord::Schema.define(:version</code><tt> </tt><code>=&gt;</code><code> </code><code>20080906171750)</code><code> </code><code>do</code></p>

<p><code> </code><code>create_table</code><code> </code><code>&ldquo;authors&rdquo;,</code><code> </code><code>:force</code> <code>=&gt;</code><code> </code><code>true</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>&ldquo;name&rdquo;</code></p>

<p><code> </code><code>t.datetime</code><code> </code><code>&ldquo;created_at&rdquo;</code></p>

<p><code> </code><code>t.datetime</code><code> </code><code>&ldquo;updated_at&rdquo;</code></p>

<p><code> </code><code>end</code></p>

<p>&nbsp;</p>

<p><code> </code><code>create_table</code><code> </code><code>&ldquo;products&rdquo;,</code><code> </code><code>:force</code> <code>=&gt;</code><code> </code><code>true</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>&ldquo;name&rdquo;</code></p>

<p><code> </code><code>t.text</code><code> </code><code>&ldquo;description&rdquo;</code></p>

<p><code> </code><code>t.datetime</code><code> </code><code>&ldquo;created_at&rdquo;</code></p>

<p><code> </code><code>t.datetime</code><code> </code><code>&ldquo;updated_at&rdquo;</code></p>

<p><code> </code><code>t.string</code><code> </code><code>&ldquo;part_number&rdquo;</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><tt>In</tt><tt> </tt><tt>many</tt><tt> </tt><tt>ways</tt><tt> </tt><tt>this</tt><tt> </tt><tt>is</tt><tt> </tt><tt>exactly</tt><tt> </tt><tt>what</tt><tt> </tt><tt>it</tt><tt> </tt><tt>is.</tt><span style="font-family: DejaVu Sans;"><tt>在很多情况下它能够准确的（反应出</tt></span><tt>schema</tt><span style="font-family: DejaVu Sans;"><tt>）的信息。</tt><tt></tt></span><tt>This</tt><tt> </tt><tt>file</tt><tt> </tt><tt>is</tt><tt> </tt><tt>created</tt><tt> </tt><tt>by</tt><tt> </tt><tt>inspecting</tt><tt> </tt><tt>the</tt><tt> </tt><tt>database</tt><tt> </tt><tt>and</tt><tt> </tt><tt>expressing</tt><tt> </tt><tt>its</tt><tt> </tt><tt>structure</tt><tt> </tt><tt>using</tt><tt> </tt><tt>create_table,</tt><tt> </tt><tt>add_index,</tt><tt> </tt><tt>and</tt><tt> </tt><tt>so</tt><tt> </tt><tt>on.</tt><span style="font-family: DejaVu Sans;"><tt>这个文件被创建来检查数据库以及表达它的结构使用</tt><tt></tt></span><tt>create_table,</tt><tt> </tt><tt>add_index</tt><span style="font-family: DejaVu Sans;"><tt>等等。</tt><tt></tt></span><tt>Because</tt><tt> </tt><tt>this</tt><tt> </tt><tt>is</tt><tt> </tt><tt>database</tt><tt> </tt><tt>independent</tt><tt> </tt><tt>it</tt><tt> </tt><tt>could</tt><tt> </tt><tt>be</tt><tt> </tt><tt>loaded</tt><tt> </tt><tt>into</tt><tt> </tt><tt>any</tt><tt> </tt><tt>database</tt><tt> </tt><tt>that</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt> </tt><tt>supports.</tt><span style="font-family: DejaVu Sans;"><tt>由于数据库的独立性它可以被导入到</tt><tt></tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>支持的任何数据库中。</tt><tt></tt></span><tt>This</tt><tt> </tt><tt>could</tt><tt> </tt><tt>be</tt><tt> </tt><tt>very</tt><tt> </tt><tt>useful</tt><tt> </tt><tt>if</tt><tt> </tt><tt>you</tt><tt> </tt><tt>were</tt><tt> </tt><tt>to</tt><tt> </tt><tt>distribute</tt><tt> </tt><tt>an</tt><tt> </tt><tt>application</tt><tt> </tt><tt>that</tt><tt> </tt><tt>is</tt><tt> </tt><tt>able</tt><tt> </tt><tt>to</tt><tt> </tt><tt>run</tt><tt> </tt><tt>against</tt><tt> </tt><tt>multiple</tt><tt> </tt><tt>databases.</tt><span style="font-family: DejaVu Sans;"><tt>这会非常有用如果你发行一个应用程序它可能面对多个数据库运行。</tt></span></p>

<p><a name="result_box1"></a><tt>There</tt><tt> </tt><tt>is</tt><tt> </tt><tt>however</tt><tt> </tt><tt>a</tt><tt> </tt><tt>trade-off:</tt><tt> </tt><tt>db/schema.rb</tt><tt> </tt><tt>cannot</tt><tt> </tt><tt>express</tt><tt> </tt><tt>database</tt><tt> </tt><tt>specific</tt><tt> </tt><tt>items</tt><tt> </tt><tt>such</tt><tt> </tt><tt>as</tt><tt> </tt><tt>foreign</tt><tt> </tt><tt>key</tt><tt> </tt><tt>constraints,</tt><tt> </tt><tt>triggers</tt><tt> </tt><tt>or</tt><tt> </tt><tt>stored</tt><tt> </tt><tt>procedures.</tt><span style="font-family: DejaVu Sans;">然而，有一个权衡：</span>DB/ schema.rb<span style="font-family: DejaVu Sans;">不能表达数据库的具体项目，如外键约束，触发器或存储过程。</span><tt>While</tt><tt> </tt><tt>in</tt><tt> </tt><tt>a</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>execute</tt><tt> </tt><tt>custom</tt><tt> </tt><tt>SQL</tt><tt> </tt><tt>statements,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>schema</tt><tt> </tt><tt>dumper</tt><tt> </tt><tt>cannot</tt><tt> </tt><tt>reconstitute</tt><tt> </tt><tt>those</tt><tt> </tt><tt>statements</tt><tt> </tt><tt>from</tt><tt> </tt><tt>the</tt><tt> </tt><tt>database.</tt><span style="font-family: DejaVu Sans;"><tt>虽然在一个</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>你可以执行自定义的</tt></span><tt>SQL</tt><span style="font-family: DejaVu Sans;"><tt>表达式，</tt></span><tt>schema</tt><span style="font-family: DejaVu Sans;"><tt>储存器不能修复一些</tt></span><tt>SQL</tt><span style="font-family: DejaVu Sans;"><tt>的表达式（不能实现</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>rollback</tt><span style="font-family: DejaVu Sans;"><tt>等功能）。</tt><tt></tt></span><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>are</tt><tt> </tt><tt>using</tt><tt> </tt><tt>features</tt><tt> </tt><tt>like</tt><tt> </tt><tt>this</tt><tt> </tt><tt>then</tt><tt> </tt><tt>you</tt><tt> </tt><tt>should</tt><tt> </tt><tt>set</tt><tt> </tt><tt>the</tt><tt> </tt><tt>schema</tt><tt> </tt><tt>format</tt><tt> </tt><tt>to</tt><tt> </tt><tt>:sql.</tt><span style="font-family: DejaVu Sans;"><tt>如果你正在使用这样的特性接着你应该设置</tt></span><tt>schema</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>格式为</tt></span><tt>:sql</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>Instead</tt><tt> </tt><tt>of</tt><tt> </tt><tt>using</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>schema</tt><tt> </tt><tt>dumper</tt><tt> </tt><tt>the</tt><tt> </tt><tt>database</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>structure</tt><tt> </tt><tt>will</tt><tt> </tt><tt>be</tt><tt> </tt><tt>dumped</tt><tt> </tt><tt>using</tt><tt> </tt><tt>a</tt><tt> </tt><tt>tool</tt><tt> </tt><tt>specific</tt><tt> </tt><tt>to</tt><tt> </tt><tt>that</tt><tt> </tt><tt>database</tt><tt> </tt><tt>(via</tt><tt> </tt><tt>the</tt><tt> </tt><tt>db:structure:dump</tt><tt> </tt><tt>Rake</tt><tt> </tt><tt>task)</tt><tt> </tt><tt>into</tt><tt> </tt><tt>db/#{Rails.env}_structure.sql.</tt><tt> </tt><tt>For</tt><tt> </tt><tt>example</tt><tt> </tt><tt>for</tt><tt> </tt><tt>PostgreSQL</tt><tt> </tt><tt>the</tt><tt> </tt><tt>pg_dump</tt><tt> </tt><tt>utility</tt><tt> </tt><tt>is</tt><tt> </tt><tt>used</tt><tt> </tt><tt>and</tt><tt> </tt><tt>for</tt><tt> </tt><tt>MySQL</tt><tt> </tt><tt>this</tt><tt> </tt><tt>file</tt><tt> </tt><tt>will</tt><tt> </tt><tt>contain</tt><tt> </tt><tt>the</tt><tt> </tt><tt>output</tt><tt> </tt><tt>of</tt><tt> </tt><tt>SHOW</tt><tt> </tt><tt>CREATE</tt><tt> </tt><tt>TABLE</tt><tt> </tt><tt>for</tt><tt> </tt><tt>the</tt><tt> </tt><tt>various</tt><tt> </tt><tt>tables.</tt><tt> </tt><tt>Loading</tt><tt> </tt><tt>this</tt><tt> </tt><tt>schema</tt><tt> </tt><tt>is</tt><tt> </tt><tt>simply</tt><tt> </tt><tt>a</tt><tt> </tt><tt>question</tt><tt> </tt><tt>of</tt><tt> </tt><tt>executing</tt><tt> </tt><tt>the</tt><tt> </tt><tt>SQL</tt><tt> </tt><tt>statements</tt><tt> </tt><tt>contained</tt><tt> </tt><tt>inside.</tt></p>

<p><a name="result_box2"></a>By definition this will be a perfect copy of the database’s structure but this will usually prevent loading the schema into a database other than the one used to create it.<span style="font-family: DejaVu Sans;">根据定义，这将是一个完美的复制数据库的结构，但通常会阻止加载到比其他用于创建一个数据库的架构。</span></p>

<h4><a name="schema-dumps-and-source-control"></a><tt>6.3</tt><tt> </tt><tt>Schema</tt><tt> </tt><tt>Dumps</tt><tt> </tt><tt>and</tt><tt> </tt><tt>Source</tt><tt> </tt><tt>Control</tt></h4>


<p>Because schema dumps are the authoritative source for your database schema, it is strongly recommended<span style="font-family: DejaVu Sans;">建议</span>that you check them into source control.<span style="font-family: DejaVu Sans;">因为架构转储是你的数据库架构的授权源，强烈建议你检查他们到源控制。</span></p>

<h3><a name="active-record-and-referential-integrity"></a> 7 Active Record and Referential<span style="font-family: WenQuanYi Micro Hei;">参照</span>Integrity<span style="font-family: WenQuanYi Micro Hei;">完整</span></h3>


<p>The Active Record way claims that intelligence belongs in your models, not in the database. As such, features such as triggers or foreign key constraints, which push some of that intelligence back into the database, are not heavily used.</p>

<p>Validations such as <tt>validates</tt><tt> </tt><tt>:foreign_key,</tt><tt> </tt><tt>:uniqueness</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt> are one way in which models can enforce data integrity. The <tt>:dependent</tt> option on associations allows models to automatically destroy child objects when the parent is destroyed. Like anything which operates at the application level these cannot guarantee referential integrity and so some people augment them with foreign key constraints.</p>

<p>Although Active Record does not provide any tools for working directly with such features, the <tt>execute</tt> method can be used to execute arbitrary SQL. There are also a number of plugins such as <span style="color: #000080;"><span style="text-decoration: underline;"><a href="https://github.com/harukizaemon/redhillonrails/tree/master/foreign_key_migrations/">foreign_key_migrations</a></span></span> which add foreign key support to Active Record (including support for dumping foreign keys in <tt>db/schema.rb</tt>).</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/17/html4he-html5zhi-jian-de-10ge-zhu-yao-bu-tong/">HTML4和HTML5之间的10个主要不同</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-17T02:30:00+08:00" pubdate data-updated="true">Nov 17<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>HTML4和HTML5之间的10个主要不同</h2>

<p>HTML5是最新的HTML标准，或迟或早，所有的web程序员都会发现需要使用到这个最新的标准，而且，很多人都会感觉到，重新开发一个HTML5的网站，要比把一个网站从HTML4迁移到HTML5上容易的多，这是因为这两个版本之间有很大不同之处。</p>

<p>事实上，HTML5并没有对HTML4做什么重大的修改，它们很多东西都是相似的。</p>

<p>可是，其中有一些很重要的区别你需要知道。下面列出的就是一些HTML4和HTML5之间主要的不同之处(并不是全部，全部列出来是不可能的)：</p>

<ol>
<li>HTML5标准还在制定中
这头一个不同之处显而易见，但非常重要，我需要先从它开始。也许你已经注意到了关于HTML5很酷的言论到处都是，但是事实情况是，HTML5是一个还未完成的标准。HTML4已经有10岁了，但它仍是当前正式的标准的事实没有改变。</li>
</ol>


<p>另一方面，HTML5仍处在早期阶段，以后的修改会不断的出现。你必须考虑到这些，因为你在网站上使用的这些新增加或修改的网页元素会每年都出现一些变化，你需要不停的更新升级你的网站，这可不是你希望的。这就是目前为止，你最好在产品里使用HTML4，只在实验里使用HTML5的原因。</p>

<ol>
<li><p>简化的语法
更简单的doctype声明是HTML5里众多新特征之一。现在你只需要写&lt;!doctype html&gt;，这就行了。HTML5的语法兼容HTML4和XHTML1，但不兼容SGML。</p></li>
<li><p>一个替代Flash的新 &lt;canvas&gt; 标记
对于Web用户来说，Flash既是一个惊喜，也是一种痛苦。有很多的Web开发人员对HTML5对Flash产生的威胁很不满。但对于那些忍受着要花几年时间加载和运行的臃肿的Flash视频的人来说，用新的 &lt;canvas&gt; 标记生成视频的技术已经到来。</p></li>
</ol>


<p>目前， &lt;canvas&gt; 标记并不能提供所有的Flash具有的功能，但假以时日，Flash必将从web上淘汰。我们拭目以待，因为很多人还并不认同这种观点。</p>

<ol>
<li>新的 &lt;header&gt; 和 &lt;footer&gt; 标记
HTML5的设计是要更好的描绘网站的解剖结构。这就是为什么这些&lt;header&gt; 和&lt;footer&gt; 等新标记的出现，它们是专门为标志网站的这些部分设计的。</li>
</ol>


<p>在开发网站时，你不在需要用&lt;div&gt;标记来标注网页的这些部分。</p>

<ol>
<li>新的 &lt;section&gt; 和 &lt;article&gt; 标记
跟&lt;header&gt; 和 &lt;footer&gt;标记类似，HTML5中引入的新的&lt;section&gt; 和 &lt;article&gt; 标记可以让开发人员更好的标注页面上的这些区域。</li>
</ol>


<p>据推测，除了让代码更有组织外，它也能改善SEO效果，能让搜索引擎更容易的分析你的页面。</p>

<ol>
<li>新的 &lt;menu&gt; 和 &lt;figure&gt; 标记
新的&lt;menu&gt;标记可以被用作普通的菜单，也可以用在工具条和右键菜单上，虽然这些东西在页面上并不常用。</li>
</ol>


<p>类似的，新的 &lt;figure&gt; 标记是一种更专业的管理页面上文字和图像的方式。当然，你可以用样式表来控制文字和图像，但使用HTML5内置的这个标记更适合。</p>

<ol>
<li>新的 &lt;audio&gt; 和 &lt;video&gt; 标记
新的&lt;audio&gt; 和 &lt;video&gt; 标记可能是HTML5中增加的最有用处的两个东西了。正如标记名称，它们是用来嵌入音频和视频文件的。</li>
</ol>


<p>除此之外还有一些新的多媒体的标记和属性，例如&lt;track&gt;，它是用来提供跟踪视频的文字信息的。有了这些标记，HTML5使Web2.0特征变得越来越友好。问题在于，在HTML5还未被广泛的接受之前，Web2.0还是老的Web2.0。</p>

<ol>
<li><p>全新的表单设计
新的 &lt;form&gt; 和 &lt;forminput&gt; 标记对原有的表单元素进行的全新的修改，它们有很多的新属性(以及一些修改)。如果你经常的开发表单，你应该花时间更详细的研究一下。</p></li>
<li><p>不再使用 &lt;b&gt; 和 &lt;font&gt; 标记
对我个人来说，这是一个让我不太理解的改动。我并不认为去除 &lt;b&gt; 和 &lt;font&gt;标记会带来多大的好处。我知道，官方的指导说这些标记可以通过CCS来做更好的处理，但这样一来，为了在文章一两个地方出现的这种标记，你就需要在独立的css和文本两个地方来实现这一的功能，岂不笨拙。也许我们以后会习惯这种方法。</p></li>
<li><p>不再使用 &lt;frame&gt;, &lt;center&gt;, &lt;big&gt; 标记
事实上，我已经记不清曾经何时用过这些标记了，所以，我并不为去除这些标记感到悲哀。相同的原因，有更好的标记能实现它们的功能——这很好，任何作废的标记从标准中剔除都是受欢迎的。</p></li>
</ol>


<p>这10个HTML5和HTML4之间的不同只是整个新的规范中的一小部分。除了这些主要的变动外，我还可以略提一下一些次要的改动，比如修改了&lt;ol&gt; 标记的属性，让它能够倒排序，对&lt;u&gt;标记也做了修改。</p>

<p>所有这些次要的改动数量众多。而且新的修改也在不断的增加，因此，如果你想实时跟踪最新的动向，你需要经常的查看w3.org的HTML4 和 HTML5之间的不同这个页面。如果你很心急，想在你的工作中使用这些新的标记和属性，我劝告你最好只是做实验，原因已经说的很清楚了，这些新标记和新属性在将来也许会有很大的改变，所以，除非你不断的更新你的代码，它们很可能会过期失效。</p>

<p>尽管如今大多数流行的浏览器的最新版都支持HTML5，但有些新的(或修改的)标记和属性它们并不支持，所以你的网页在用户的屏幕上有可能前后显示的不一致。耐心等待，等待HTML5真正可以实用时候。目前还不是时候。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/16/ri-li-jsdai-ma/">日历js代码</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-16T02:53:00+08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>日历js代码</h2>

<p>a simple js calendar code:</p>

<p>code1:</p>

<pre>
<Script LANGUAGE="JavaScript">
var months = new Array("一", "二", "三","四", "五", "六", "七", "八", "九","十", "十一", "十二");
var daysInMonth = new Array(31, 28, 31, 30, 31, 30, 31, 31,30, 31, 30, 31);
var days = new Array("日","一", "二", "三","四", "五", "六");
var classTemp;
var today=new getToday();
var year=today.year;
var month=today.month;
var newCal; 

function getDays(month, year) {
if (1 == month) return ((0 == year % 4) && (0 != (year % 100))) ||(0 == year % 400) ? 29 : 28;
else return daysInMonth[month];
}

function getToday() {
this.now = new Date();
this.year = this.now.getFullYear();
this.month = this.now.getMonth();
this.day = this.now.getDate();
}

function Calendar() {
newCal = new Date(year,month,1);
today = new getToday();   
var day = -1;
var startDay = newCal.getDay();
var endDay=getDays(newCal.getMonth(), newCal.getFullYear());
var daily = 0;
if ((today.year == newCal.getFullYear()) &&(today.month == newCal.getMonth()))
{
  day = today.day;
}
var caltable = document.all.caltable.tBodies.calendar;
var intDaysInMonth =getDays(newCal.getMonth(), newCal.getFullYear());

for (var intWeek = 0; intWeek < caltable.rows.length;intWeek++)
  for (var intDay = 0;intDay < caltable.rows[intWeek].cells.length;intDay++)
  {
  var cell = caltable.rows[intWeek].cells[intDay];
  var montemp=(newCal.getMonth()+1)<10?("0"+(newCal.getMonth()+1)):(newCal.getMonth()+1);       
  if ((intDay == startDay) && (0 == daily)){ daily = 1;}
  var daytemp=daily<10?("0"+daily):(daily);
  var d="<"+newCal.getFullYear()+"-"+montemp+"-"+daytemp+">";
  if(day==daily) cell.className="DayNow";
  else if(intDay==6) cell.className = "DaySat";
  else if (intDay==0) cell.className ="DaySun";
  else cell.className="Day";
  if ((daily > 0) && (daily <= intDaysInMonth))
  {
  cell.innerText = daily;
  daily++;
  } else
  {
  cell.className="CalendarTD";
  cell.innerText = "";
  }
}
document.all.year.value=year;
document.all.month.value=month+1;
}

function subMonth()
{
if ((month-1)<0)
{
  month=11;
  year=year-1;
} else
{
  month=month-1;
}
Calendar();
}

function addMonth()
{
if((month+1)>11)
{
  month=0;
  year=year+1;
} else
{
  month=month+1;
}
Calendar();
}

function setDate() 
{
if (document.all.month.value<1||document.all.month.value>12)
{
  alert("月的有效范围在1-12之间!");
  return;
}
year=Math.ceil(document.all.year.value);
month=Math.ceil(document.all.month.value-1);
Calendar();
}
</Script>

<Script>
function buttonOver()
{
var obj = window.event.srcElement;
obj.runtimeStyle.cssText = "background-color:#FFFFFF";
// obj.className="Hover";
}

function buttonOut()
{
var obj = window.event.srcElement;
window.setTimeout(function(){obj.runtimeStyle.cssText = "";},300);
}
</Script>

<Style>
Input {font-family: verdana;font-size: 9pt;text-decoration: none;background-color: #FFFFFF;height: 20px;border: 1px solid #666666;color:#000000;}

.Calendar {font-family: verdana;text-decoration: none;width: 170;background-color: #C0D0E8;font-size: 9pt;border:0px dotted #1C6FA5;}
.CalendarTD {font-family: verdana;font-size: 7pt;color: #000000;background-color:#f6f6f6;height: 20px;width:11%;text-align: center;}

.Title {font-family: verdana;font-size: 11pt;font-weight: normal;height: 24px;text-align: center;color: #333333;text-decoration: none;background-color: #A4B9D7;border-top-width: 1px;border-right-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-bottom-style:1px;border-top-color: #999999;border-right-color: #999999;border-bottom-color: #999999;border-left-color: #999999;}

.Day {font-family: verdana;font-size: 7pt;color:#243F65;background-color: #E5E9F2;height: 20px;width:11%;text-align: center;}
.DaySat {font-family: verdana;font-size: 7pt;color:#FF0000;text-decoration: none;background-color:#E5E9F2;text-align: center;height: 18px;width: 12%;}
.DaySun {font-family: verdana;font-size: 7pt;color: #FF0000;text-decoration: none;background-color:#E5E9F2;text-align: center;height: 18px;width: 12%;}
.DayNow {font-family: verdana;font-size: 7pt;font-weight: bold;color: #000000;background-color: #FFFFFF;height: 20px;text-align: center;}

.DayTitle {font-family: verdana;font-size: 9pt;color: #000000;background-color: #C0D0E8;height: 20px;width:11%;text-align: center;}
.DaySatTitle {font-family: verdana;font-size: 9pt;color:#FF0000;text-decoration: none;background-color:#C0D0E8;text-align: center;height: 20px;width: 12%;}
.DaySunTitle {font-family: verdana;font-size: 9pt;color: #FF0000;text-decoration: none;background-color: #C0D0E8;text-align: center;height: 20px;width: 12%;}

.DayButton {font-family: Webdings;font-size: 9pt;font-weight: bold;color: #243F65;cursor:hand;text-decoration: none;}

</Style>


<table border="0" cellpadding="0" cellspacing="1" class="Calendar" id="caltable">
<thead>
  <tr align="center" valign="middle"> 
<td colspan="7" class="Title">
  <a href="javaScript:subMonth();" title="上一月" Class="DayButton">3</a> <input name="year" type="text" size="4" maxlength="4" onkeydown="if (event.keyCode==13){setDate()}" onkeyup="this.value=this.value.replace(/[^0-9]/g,'')" onpaste="this.value=this.value.replace(/[^0-9]/g,'')"> 年 <input name="month" type="text" size="1" maxlength="2" onkeydown="if (event.keyCode==13){setDate()}" onkeyup="this.value=this.value.replace(/[^0-9]/g,'')" onpaste="this.value=this.value.replace(/[^0-9]/g,'')"> 月 <a href="JavaScript:addMonth();" title="下一月" Class="DayButton">4</a>
</td>
</tr>
<tr align="center" valign="middle"> 
<Script LANGUAGE="JavaScript"> 
  document.write("<TD class=DaySunTitle id=diary >" + days[0] + "</TD>"); 
  for (var intLoop = 1; intLoop < days.length-1;intLoop++) 
  document.write("<TD class=DayTitle id=diary>" + days[intLoop] + "</TD>"); 
  document.write("<TD class=DaySatTitle id=diary>" + days[intLoop] + "</TD>"); 
</Script>
</TR> 
</thead>
<TBODY border=1 cellspacing="0" cellpadding="0" ID="calendar" ALIGN=CENTER ONCLICK="getDiary()">
<Script LANGUAGE="JavaScript">
for (var intWeeks = 0; intWeeks < 6; intWeeks++)
{
  document.write("<TR style='cursor:hand'>");
  for (var intDays = 0; intDays < days.length;intDays++) document.write("<TD class=CalendarTD onMouseover='buttonOver();' onMouseOut='buttonOut();'></TD>");
  document.write("</TR>");
} 
</Script>
</TBODY>
</TABLE>
<Script LANGUAGE="JavaScript">
Calendar();
</Script>

</pre>


<p>Code2:</p>

<pre>
<Script LANGUAGE="JavaScript">
var months = new Array("一", "二", "三","四", "五", "六", "七", "八", "九","十", "十一", "十二");
var daysInMonth = new Array(31, 28, 31, 30, 31, 30, 31, 31,30, 31, 30, 31);
var days = new Array("日","一", "二", "三","四", "五", "六");
var classTemp;
var today=new getToday();
var year=today.year;
var month=today.month;
var newCal; 

function getDays(month, year) {
if (1 == month) return ((0 == year % 4) && (0 != (year % 100))) ||(0 == year % 400) ? 29 : 28;
else return daysInMonth[month];
}

function getToday() {
this.now = new Date();
this.year = this.now.getFullYear();
this.month = this.now.getMonth();
this.day = this.now.getDate();
}

function Calendar() {
newCal = new Date(year,month,1);
today = new getToday();   
var day = -1;
var startDay = newCal.getDay();
var endDay=getDays(newCal.getMonth(), newCal.getFullYear());
var daily = 0;
if ((today.year == newCal.getFullYear()) &&(today.month == newCal.getMonth()))
{
  day = today.day;
}
var caltable = document.all.caltable.tBodies.calendar;
var intDaysInMonth =getDays(newCal.getMonth(), newCal.getFullYear());

for (var intWeek = 0; intWeek < caltable.rows.length;intWeek++)
  for (var intDay = 0;intDay < caltable.rows[intWeek].cells.length;intDay++)
  {
  var cell = caltable.rows[intWeek].cells[intDay];
  var montemp=(newCal.getMonth()+1)<10?("0"+(newCal.getMonth()+1)):(newCal.getMonth()+1);       
  if ((intDay == startDay) && (0 == daily)){ daily = 1;}
  var daytemp=daily<10?("0"+daily):(daily);
  var d="<"+newCal.getFullYear()+"-"+montemp+"-"+daytemp+">";
  if(day==daily) cell.className="DayNow";
  else if(intDay==6) cell.className = "DaySat";
  else if (intDay==0) cell.className ="DaySun";
  else cell.className="Day";
  if ((daily > 0) && (daily <= intDaysInMonth))
  {
  cell.innerText = daily;
  daily++;
  } else
  {
  cell.className="CalendarTD";
  cell.innerText = "";
  }
}
document.all.year.value=year;
document.all.month.value=month+1;
}

function subMonth()
{
if ((month-1)<0)
{
  month=11;
  year=year-1;
} else
{
  month=month-1;
}
Calendar();
}

function addMonth()
{
if((month+1)>11)
{
  month=0;
  year=year+1;
} else
{
  month=month+1;
}
Calendar();
}

function setDate() 
{
if (document.all.month.value<1||document.all.month.value>12)
{
  alert("月的有效范围在1-12之间!");
  return;
}
year=Math.ceil(document.all.year.value);
month=Math.ceil(document.all.month.value-1);
Calendar();
}
</Script>

<Script>
function buttonOver()
{
var obj = window.event.srcElement;
obj.runtimeStyle.cssText = "background-color:#FFFFFF";
// obj.className="Hover";
}

function buttonOut()
{
var obj = window.event.srcElement;
window.setTimeout(function(){obj.runtimeStyle.cssText = "";},300);
}
</Script>

<Style>
Input {font-family: verdana;font-size: 9pt;text-decoration: none;background-color: #FFFFFF;height: 20px;border: 1px solid #666666;color:#000000;}

.Calendar {font-family: verdana;text-decoration: none;width: 170;background-color: #C0D0E8;font-size: 9pt;border:0px dotted #1C6FA5;}
.CalendarTD {font-family: verdana;font-size: 7pt;color: #000000;background-color:#f6f6f6;height: 20px;width:11%;text-align: center;}

.Title {font-family: verdana;font-size: 11pt;font-weight: normal;height: 24px;text-align: center;color: #333333;text-decoration: none;background-color: #A4B9D7;border-top-width: 1px;border-right-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-bottom-style:1px;border-top-color: #999999;border-right-color: #999999;border-bottom-color: #999999;border-left-color: #999999;}

.Day {font-family: verdana;font-size: 7pt;color:#243F65;background-color: #E5E9F2;height: 20px;width:11%;text-align: center;}
.DaySat {font-family: verdana;font-size: 7pt;color:#FF0000;text-decoration: none;background-color:#E5E9F2;text-align: center;height: 18px;width: 12%;}
.DaySun {font-family: verdana;font-size: 7pt;color: #FF0000;text-decoration: none;background-color:#E5E9F2;text-align: center;height: 18px;width: 12%;}
.DayNow {font-family: verdana;font-size: 7pt;font-weight: bold;color: #000000;background-color: #FFFFFF;height: 20px;text-align: center;}

.DayTitle {font-family: verdana;font-size: 9pt;color: #000000;background-color: #C0D0E8;height: 20px;width:11%;text-align: center;}
.DaySatTitle {font-family: verdana;font-size: 9pt;color:#FF0000;text-decoration: none;background-color:#C0D0E8;text-align: center;height: 20px;width: 12%;}
.DaySunTitle {font-family: verdana;font-size: 9pt;color: #FF0000;text-decoration: none;background-color: #C0D0E8;text-align: center;height: 20px;width: 12%;}

.DayButton {font-family: Webdings;font-size: 9pt;font-weight: bold;color: #243F65;cursor:hand;text-decoration: none;}

</Style>


<table border="0" cellpadding="0" cellspacing="1" class="Calendar" id="caltable">
<thead>
  <tr align="center" valign="middle"> 
<td colspan="7" class="Title">
  <a href="javaScript:subMonth();" title="上一月" Class="DayButton">3</a> <input name="year" type="text" size="4" maxlength="4" onkeydown="if (event.keyCode==13){setDate()}" onkeyup="this.value=this.value.replace(/[^0-9]/g,'')" onpaste="this.value=this.value.replace(/[^0-9]/g,'')"> 年 <input name="month" type="text" size="1" maxlength="2" onkeydown="if (event.keyCode==13){setDate()}" onkeyup="this.value=this.value.replace(/[^0-9]/g,'')" onpaste="this.value=this.value.replace(/[^0-9]/g,'')"> 月 <a href="JavaScript:addMonth();" title="下一月" Class="DayButton">4</a>
</td>
</tr>
<tr align="center" valign="middle"> 
<Script LANGUAGE="JavaScript"> 
  document.write("<TD class=DaySunTitle id=diary >" + days[0] + "</TD>"); 
  for (var intLoop = 1; intLoop < days.length-1;intLoop++) 
  document.write("<TD class=DayTitle id=diary>" + days[intLoop] + "</TD>"); 
  document.write("<TD class=DaySatTitle id=diary>" + days[intLoop] + "</TD>"); 
</Script>
</TR> 
</thead>
<TBODY border=1 cellspacing="0" cellpadding="0" ID="calendar" ALIGN=CENTER ONCLICK="getDiary()">
<Script LANGUAGE="JavaScript">
for (var intWeeks = 0; intWeeks < 6; intWeeks++)
{
  document.write("<TR style='cursor:hand'>");
  for (var intDays = 0; intDays < days.length;intDays++) document.write("<TD class=CalendarTD onMouseover='buttonOver();' onMouseOut='buttonOut();'></TD>");
  document.write("</TR>");
} 
</Script>
</TBODY>
</TABLE>
<Script LANGUAGE="JavaScript">
Calendar();
</Script>

</pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/16/ping-guo-ji-e-ying-xiao-zi-zao-gan-ga-huang-niu-du-men-jiao-mai-iphone4s/">苹果饥饿营销自造尴尬 “黄牛”堵门叫卖iPhone4s</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-16T02:16:00+08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>苹果饥饿营销自造尴尬 “黄牛”堵门叫卖iPhone4s</h2>

<p>iPhone4s已经在几十个国家和地区上市销售，并于本月11日正式登陆中国香港，但因为iPhone4s在内地上市时间迟迟未定，已经望穿秋水的“果粉”只能继续守候下去。然而想继续通过饥饿营销积累客户的苹果，不得不面对自己制造的“尴尬”。随着昨日大量港版iPhone4s抵京，大批黄牛来到苹果三里屯官方零售店外堵门叫卖。</p>

<p>　　“iPhone4s要吗？港版无锁的！”在苹果三里屯零售店门口，一群手拿着苹果白色包装盒的黄牛，不断地招揽着过往行人，一发现有顾客从苹果店走出来，就立刻围上去。</p>

<p>　　一位刘姓男子透露，他卖的iPhone4s是昨天刚从深圳发到北京的，黑色16G版的现在卖5850元，不讲价。虽然比起4150元的官方定价，这名黄牛一口气加了1700元，但他表示这个价格还是港版上市后降了的，以前澳版的iPhone4s要价都超过6500元。这名黄牛“备货”十分充足，身后的书包里装了近百台iPhone4s。</p>

<p>　　隔着一道通明的玻璃墙，苹果店员自然对门外的黄牛一清二楚，除了在店门口立起一块不大的警示牌提醒消费者黄牛手中的iPhone4s“来源不明”外，苹果对黄牛们似乎无能为力。“iPhone4s的上市时间还没定，所以现在我们还没有相应的预订服务。”三里屯苹果旗舰店的一位负责人坦言，想从苹果官方渠道买到iPhone4s，可能还要等上很长一段时间。</p>

<p>　　面对苹果没货，黄牛堵门的情况，不禁有“果粉”发出疑问，“为什么iPhone4s在国内迟迟不能上市”。对此，苹果中国的负责人解释称，iPhone4s进入国内需要经过多重审核，以取得工信部的入网许可证，所以上市时间迟迟未定。然而苹果这一解释无法服众，一位业内人士表示，工信部的入网许可并不难拿，一般企业提出申请后10个工作日就能通过相应审核，而iPhone4s从发布至今已经1个多月。</p>

<p>　　“苹果之所以迟迟不定iPhone4s在中国内地的上市时间，无非还是想玩饥饿营销，吊起消费者的胃口。”这位业内人士直言，但如此营销造成黄牛堵门，不知苹果有何感想。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/10/ma-nong-ao-ye-zhi-nan/">码农熬夜指南</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-10T05:40:00+08:00" pubdate data-updated="true">Nov 10<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>码农熬夜指南</h2>

<div>

最近赶着交作业，所以不得已连着三天熬夜，感觉整个人都快斯巴达了。到处找了些关于熬夜的技巧，与大家共勉。当然，不用熬夜是最好啦，可惜作为天生乐观派的程序员，多数都是平时不用功，到了要交付的时候才伴随着最后期限呼啸而过的声音熬夜赶进度。

首先,能不熬夜还是不熬的好。

熬夜前的准备
下午时候，不要吃泡面来填饱肚子，以免火气太大。晚餐应多补充一些含维生素C或含有胶原蛋白的食物，鱼类、豆类这些。
拿热水泡脚很养人，对于熬夜时候保持精力也很管用。
开始熬夜前，来一颗维他命Ｂ群营养丸，维他命Ｂ能够解除疲劳，增强人体免疫力。拿医保卡去学校随便拿一瓶，也就是几十块的事情。

熬夜中
熬夜的人，最先想到的就是喝咖啡提神。但是咖啡因虽然提神，相对地会消耗体内与神经、肌肉协调有关的维他命B群，缺乏维他命B群的人本来就比较容易累，更可能形成恶性循环，养成酗茶、酗咖啡的习惯，需要量愈来愈多，效果却愈来愈差。因此，我个人比较推荐喝茶，绿茶很不错，可以提神，又可以消除体内多余的自由基，据说还有些防辐射的作用。不过貌似肠胃不好的人喝不得绿茶，那枸杞大枣茶或菊花茶也是很好的选择，提神而且有去火的功效。

熬夜时候不要吃太多甜食，高糖虽有高热量，刚开始让人兴奋，却会消耗维他命B群，会让人容易疲劳，也容易引来肥胖问题。

熬夜时候最好的食物是水果，这个道理就不用多说了。值得注意的是，花生米、杏仁、腰果、胡桃等干果类食品，含有丰富的蛋白质、维生素B、维生素E、钙和铁等矿物质以及植物油，而胆固醇的含量很低，对恢复体能有特殊的功效。绝对是熬夜必备之选啊。

熬夜时，大脑需氧量会增大，最好隔一个小时到走廊做一些简单易行的肌肉放松动作，一方面舒缓筋骨，预防颈椎病之类的；另一方面，可以多呼吸一些新鲜空气，提神又减压。

熬夜后
其实，熬夜时候因为要忙着码代码，精神一直紧绷着，倒是并不难受。反倒是熬夜之后，才是真正痛苦的时候，精神萎靡、头疼欲裂都是常事儿。这个确实没什么好办法，只能说按之前技巧来做，痛苦会少一些。 

熬完夜直接补觉到中午，我个人觉得这是最好的恢复方式。因为千理由万理由，熬夜最让人难受的还是睡眠时间不够。

如果没这个条件，那中午也至少要睡一个小时。常言道，“午睡一小时抵过晚上睡三小时”。

大体就这些了，大家有些好的建议也不妨提出来。要想熬夜精神好，就得有技巧啊。

</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/10/getting-started-with-rails-en-cn/">Getting Started With Rails-(EN-CN)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-10T03:05:00+08:00" pubdate data-updated="true">Nov 10<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Getting Started with Rails-(EN-CN)</h2>

<h2>Getting Started with Rails</h2>


<p>This guide covers getting up and running with Ruby on Rails. After reading it, you should be familiar with:<span style="font-family: DejaVu Sans;">本指导手册覆盖了入门和运行</span>ruby on rails<span style="font-family: DejaVu Sans;">，通过阅读本指导，你会了解到：</span></p>

<ul>
    <li>Installing Rails, creating a new Rails application, and connecting your application to a database</li>
    <li>The general layout#<span style="font-family: DejaVu Sans;">布局</span>of a Rails application <span style="font-family: DejaVu Sans;">应用程序的一般布局</span></li>
    <li>The basic principles of MVC (Model, View Controller) and RESTful design MVC<span style="font-family: DejaVu Sans;">的基本原则和</span>RESTful<span style="font-family: DejaVu Sans;">设计（理念）</span></li>
    <li>How to quickly generate the starting pieces of a Rails application <span style="font-family: DejaVu Sans;">如何快捷的开始一个</span>Rails<span style="font-family: DejaVu Sans;">应用</span></li>
</ul>


<p><span style="color: #800000;"><em>This</em></span><span style="color: #800000;"><em>Guide</em></span><span style="color: #800000;"><em>is</em></span><span style="color: #800000;"><em>based</em></span><span style="color: #800000;"><em>on</em></span><span style="color: #800000;"><em>Rails</em></span><span style="color: #800000;"><em>3.1.</em></span><span style="color: #800000;"><em>Some</em></span><span style="color: #800000;"><em>of</em></span><span style="color: #800000;"><em>the</em></span><span style="color: #800000;"><em>code</em></span><span style="color: #800000;"><em>shown</em></span><span style="color: #800000;"><em>here</em></span><span style="color: #800000;"><em>will</em></span><span style="color: #800000;"><em>not</em></span><span style="color: #800000;"><em>work</em></span><span style="color: #800000;"><em>in</em></span><span style="color: #800000;"><em>earlier</em></span><span style="color: #800000;"><em>versions</em></span><span style="color: #800000;"><em>of</em></span><span style="color: #800000;"><em>Rails.</em><span style="font-family: DejaVu Sans;"><em>这个指导手册适用与</em></span></span><span style="color: #800000;"><em>Rails3.1</em><span style="font-family: DejaVu Sans;"><em>，有些代码在</em></span></span><span style="color: #800000;"><em>Rails</em><span style="font-family: DejaVu Sans;"><em>早期版本可能会不工作。</em></span></span></p>

<h3><a name="guide-assumptions"></a>1 Guide Assumptions<span style="font-family: WenQuanYi Micro Hei;">假设</span></h3>


<h3><a name="guide-assumptions1"></a>1 Guide Assumptions</h3>


<p>This guide is designed for beginners who want to get started with a Rails application from scratch#<span style="font-family: DejaVu Sans;">刻痕</span>. It does not assume#<span style="font-family: DejaVu Sans;">假设</span>that you have any prior#<span style="font-family: DejaVu Sans;">预先</span>experience with Rails. However, to get the most out of it, you need to have some prerequisites installed:<span style="font-family: DejaVu Sans;">本指导设计给那些想大概的了解</span>Rails<span style="font-family: DejaVu Sans;">应用创建的初学者。这里假设你对</span>Rails<span style="font-family: DejaVu Sans;">没有任何预先的了解。不管怎样要得到（本手册的）知识，你需要预先安装：</span></p>

<ul>
    <li>The <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://www.ruby-lang.org/en/downloads">Ruby</a></span></span> language version 1.8.7 or higher</li>
</ul>


<p><em><strong>Note</strong></em><em> </em><em>that</em><em> </em><em>Ruby</em><em> </em><em>1.8.7</em><em> </em><em>p248</em><em> </em><em>and</em><em> </em><em>p249</em><em> </em><em>have</em><em> </em><em>marshaling#</em><span style="font-family: DejaVu Sans;"><em>封送处理</em></span><em>bugs</em><em> </em><em>that</em><em> </em><em>crash#</em><span style="font-family: DejaVu Sans;"><em>意外崩溃</em><em>紧急</em></span><em>Rails</em><em> </em><em>3.0.</em><em> </em><em>Ruby</em><em> </em><em>Enterprise</em><em> </em><em>Edition</em><em> </em><em>have</em><em> </em><em>these</em><em> </em><em>fixed</em><em> </em><em>since</em><em> </em><em>release</em><em> </em><em>1.8.7-2010.02</em><em> </em><em>though.</em><em> </em><em>Ruby</em><em> </em><em>1.8.7</em><em> </em><em>p248</em><em> </em><em>and</em><em> </em><em>p249</em><span style="font-family: DejaVu Sans;"><em>在</em><em>发行版</em></span><em>1.8.7-2010.02</em><em> </em><span style="font-family: DejaVu Sans;"><em>已经得到解决。</em></span><em>On</em><em> </em><em>the</em><em> </em><em>1.9</em><em> </em><em>front,</em><em> </em><em>Ruby</em><em> </em><em>1.9.1</em><em> </em><em>is</em><em> </em><em>not</em><em> </em><em>usable</em><em> </em><em>because</em><em> </em><em>it</em><em> </em><em>outright</em><em> </em><em>segfaults</em><em> </em><em>on</em><em> </em><em>Rails</em><em> </em><em>3.0,</em><em> </em><em>so</em><em> </em><em>if</em><em> </em><em>you</em><em> </em><em>want</em><em> </em><em>to</em><em> </em><em>use</em><em> </em><em>Rails</em><em> </em><em>3</em><em> </em><em>with</em><em> </em><em>1.9.x</em><em> </em><em>jump</em><em> </em><em>on</em><em> </em><em>1.9.2</em><em> </em><em>for</em><em> </em><em>smooth</em><em> </em><em>sailing.</em></p>

<ul>
    <li>The <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://rubyforge.org/frs/?group_id=126">RubyGems</a></span></span>packaging system
<ul>
    <li>If you want to learn more about RubyGems, please read the <a href="http://docs.rubygems.org/read/book/1"><span style="color: #000080;"><span style="text-decoration: underline;">RubyGems</span></span><span style="color: #000080;"><span style="text-decoration: underline;">User</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a> <span style="font-family: DejaVu Sans;">如果你想了解更多关于</span>RubyGems<span style="font-family: DejaVu Sans;">，请阅读</span><a href="http://docs.rubygems.org/read/book/1"><span style="color: #000080;"><span style="text-decoration: underline;">RubyGems</span></span><span style="color: #000080;"><span style="text-decoration: underline;">User</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a></li>
</ul>
</li>
    <li>A working installation of the <a href="http://www.sqlite.org/"><span style="color: #000080;"><span style="text-decoration: underline;">SQLite3</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Database</span></span></a></li>
</ul>


<p>Rails is a web application framework running on the Ruby programming language. If you have no prior experience with Ruby, you will find a very steep#<span style="font-family: DejaVu Sans;">陡</span>learning curve diving straight into Rails. There are some good free resources on the internet for learning Ruby, including: Rails<span style="font-family: DejaVu Sans;">是一个基于</span>Ruby<span style="font-family: DejaVu Sans;">程序语言的</span>web<span style="font-family: DejaVu Sans;">程序框架。如果你没有预先的学习</span>ruby<span style="font-family: DejaVu Sans;">，你会发现直接的入门</span>Rails<span style="font-family: DejaVu Sans;">学习很有跨度。这里有一些学习</span>ruby<span style="font-family: DejaVu Sans;">的免费互联网资源。</span></p>

<ul>
    <li><a href="http://www.humblelittlerubybook.com/"><span style="color: #000080;"><span style="text-decoration: underline;">Mr.</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Neighborly</span></span><span style="color: #000080;"><span style="text-decoration: underline;">’</span></span><span style="color: #000080;"><span style="text-decoration: underline;">s</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Humble</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Little</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Ruby</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Book</span></span></a></li>
    <li><a href="http://www.ruby-doc.org/docs/ProgrammingRuby/"><span style="color: #000080;"><span style="text-decoration: underline;">Programming</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Ruby</span></span></a></li>
    <li><a href="http://mislav.uniqpath.com/poignant-guide/"><span style="color: #000080;"><span style="text-decoration: underline;">Why</span></span><span style="color: #000080;"><span style="text-decoration: underline;">’</span></span><span style="color: #000080;"><span style="text-decoration: underline;">s</span></span><span style="color: #000080;"><span style="text-decoration: underline;">(Poignant)</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span><span style="color: #000080;"><span style="text-decoration: underline;">to</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Ruby</span></span></a></li>
</ul>


<h3><a name="what-is-rails"></a>2 What is Rails?<span style="font-family: WenQuanYi Micro Hei;">什么</span>Rails</h3>


<p>Rails is a web application development framework written in the Ruby language. It is <strong>designed</strong><strong> </strong><strong>to</strong> make programming web applications easier by making assumptions#<span style="font-family: DejaVu Sans;">完成</span>about what every developer needs to get started. It allows you to write less code while accomplishing more than many other languages and frameworks. Experienced#<span style="font-family: DejaVu Sans;">经验丰富的</span>Rails developers also report that it makes web application development more fun.Rails<span style="font-family: DejaVu Sans;">是一个使用</span>Ruby<span style="font-family: DejaVu Sans;">语言编写的的</span>web<span style="font-family: DejaVu Sans;">框架应用程序。其设计目的是为了让每个着手开始编写</span>web<span style="font-family: DejaVu Sans;">应用程序的开发人员更加容易的完成工作。它允许你写最少的代码完成超过其他任何语言和框架所完成的工作。经验丰富的</span>Rails<span style="font-family: DejaVu Sans;">开发人员还告诉我们通过</span>Rails<span style="font-family: DejaVu Sans;">使设计</span>web<span style="font-family: DejaVu Sans;">应用程序更快乐。</span></p>

<p>Rails is opinionated#<span style="font-family: DejaVu Sans;">自以为是</span>software. It makes the assumption that there is a “best” way to do things, and it’s designed to encourage#<span style="font-family: DejaVu Sans;">鼓励</span>that way – and in some cases to discourage alternatives<span style="font-family: DejaVu Sans;">替代品</span>. If you learn “The Rails Way” you’ll probably discover a tremendous increase in productivity. If you persist in bringing old habits#<span style="font-family: DejaVu Sans;">习惯</span>from other languages to your Rails development, and trying to use patterns<span style="font-family: DejaVu Sans;">模式</span>you learned elsewhere, you may have a less happy experience.Rails<span style="font-family: DejaVu Sans;">是一个自以为是的软件。它使得我们以最好的方式去做事情，它还鼓励<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></span>and in some cases to discourage alternatives<span style="font-family: DejaVu Sans;">，如果你学习<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>Rails<span style="font-family: DejaVu Sans;">方式<span style="font-family: Liberation Serif,Times New Roman,serif;">”</span>你将会适时的发现生产力的巨大增长。如果你固守在来自其他语言的旧的习惯去进行你的</span>Rails<span style="font-family: DejaVu Sans;">开发，以以它地方学来的模式尝试</span>Rails<span style="font-family: DejaVu Sans;">，那么你将会得到很少的快乐的经历。</span></p>

<p><strong>The</strong><strong> </strong><strong>Rails</strong><strong> </strong><strong>philosophy</strong><span style="font-family: DejaVu Sans;"><strong>理念</strong></span><strong>includes</strong><strong> </strong><strong>several</strong><strong> </strong><strong>guiding</strong><strong> </strong><strong>principles:Rails</strong><span style="font-family: DejaVu Sans;"><strong>理念包含几个指导原则</strong></span></p>

<ul>
    <li><strong>DRY</strong><strong> – “</strong><strong>Don</strong><strong>’</strong><strong>t</strong><strong> </strong><strong>Repeat</strong><strong> </strong><strong>Yourself</strong><strong>”</strong> – suggests that writing the same code over and over again is a bad thing. <span style="font-family: DejaVu Sans;">不要自己重复<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>建议一次又一次编写同样的代码是一件坏事请。</span></li>
    <li>Convention#<span style="font-family: DejaVu Sans;">约定</span>Over Configuration(<span style="font-family: DejaVu Sans;">约定优于配置</span>) – means that Rails makes assumptions about what you want to do and how you’re going to do it<span style="font-family: DejaVu Sans;">想做怎么做</span>, rather than requiring you to specify every little thing through endless configuration files. <span style="font-family: DejaVu Sans;">约定优于配置<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>意思是</span>Rails<span style="font-family: DejaVu Sans;">对于你想做什么以及你想怎么做，你刻意的做很少的事情比编写无尽的配置文件更好</span></li>
    <li>REST is the best pattern<span style="font-family: DejaVu Sans;">模式</span>for web applications – organizing your application around resources#<span style="font-family: DejaVu Sans;">资源</span>and standard HTTP verbs#<span style="font-family: DejaVu Sans;">动词</span>is the fastest way to go. REST<span style="font-family: DejaVu Sans;">是开发</span>web<span style="font-family: DejaVu Sans;">应用程序的最好模式<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>环绕</span>resources<span style="font-family: DejaVu Sans;">和标准的</span>HTTP<span style="font-family: DejaVu Sans;">动作组织你的应用程序</span></li>
</ul>


<h4><a name="the-mvc-architecture"></a>2.1 The MVC Architecture#MVC<span style="font-family: WenQuanYi Micro Hei;">架构</span></h4>


<p>At the core of Rails is the Model, View, Controller architecture, usually just called MVC. MVC benefits include:Model<span style="font-family: DejaVu Sans;">，</span>View<span style="font-family: DejaVu Sans;">，</span>Controller<span style="font-family: DejaVu Sans;">架构是</span>Rails<span style="font-family: DejaVu Sans;">的核心，通常称之为</span>MVC<span style="font-family: DejaVu Sans;">。</span></p>

<ul>
    <li>Isolation<span style="font-family: DejaVu Sans;">分离</span>of business logic<span style="font-family: DejaVu Sans;">逻辑</span>from the user interface <span style="font-family: DejaVu Sans;">界面</span>#<span style="font-family: DejaVu Sans;">从用户界面的业务逻辑的分离</span></li>
    <li>Ease of keeping code DRY# <strong>“</strong><strong>Don</strong><strong>’</strong><strong>t</strong><strong> </strong><strong>Repeat</strong><strong> </strong><strong>Yourself</strong><strong>”</strong></li>
    <li>Making it clear where different types of code belong for easier maintenance #<span style="font-family: DejaVu Sans;">维护明确代码的不同之处使之跟容易维护</span></li>
</ul>


<h5><a name="models"></a>2.1.1 Models</h5>


<p>A model represents<span style="font-family: DejaVu Sans;">代表</span>the information (data) of the application and the rules to manipulate that data.<span style="font-family: DejaVu Sans;">模型代表了应用程序的信息（数据）和操纵这些数据的规则。</span>In the case of Rails, models are primarily used for managing the rules of interaction with a corresponding#<span style="font-family: DejaVu Sans;">相应的</span>database table. In most cases, each table in your database will correspond to one model in your application. The bulk of your application’s business logic will be concentrated in the models.<span style="font-family: DejaVu Sans;">在</span>Rails<span style="font-family: DejaVu Sans;">中，</span>models<span style="font-family: DejaVu Sans;">主要用于管理数据表和相应的规则的互动。在大多数情况，在你数据库中的每个表都会和你的应用程序互动。你应用程序的逻辑业务将会集中放置在</span>models<span style="font-family: DejaVu Sans;">中。</span></p>

<h5><a name="views"></a>2.1.2 Views</h5>


<p>Views represent the user interface of your application. In Rails, views are often HTML files with embedded Ruby code that perform<span style="font-family: DejaVu Sans;">执行</span>tasks related solely to the presentation#<span style="font-family: DejaVu Sans;">演示</span>of the data. Views handle the job of providing data to the web browser or other tool that is used to make requests from your application.View<span style="font-family: DejaVu Sans;">代表了应用程序的用户界面。在</span>Rails<span style="font-family: DejaVu Sans;">中，</span>Views<span style="font-family: DejaVu Sans;">通常是嵌入了执行演示数据任务的</span>Ruby<span style="font-family: DejaVu Sans;">代码的</span>HTML<span style="font-family: DejaVu Sans;">文件。</span>Views<span style="font-family: DejaVu Sans;">完成了给</span>web<span style="font-family: DejaVu Sans;">浏览器或者其他工具用于提出来自你的程序的请求提供数据。</span></p>

<h5><a name="controllers"></a>2.1.3 Controllers</h5>


<p>Controllers provide the “glue” between models and views. In Rails, controllers are responsible for processing the incoming requests from the web browser, interrogating the models for data, and passing that data on to the views for presentation.Controllers<span style="font-family: DejaVu Sans;">提供了</span>models<span style="font-family: DejaVu Sans;">和视图间的粘合。在</span>Rails<span style="font-family: DejaVu Sans;">中，</span>controllers<span style="font-family: DejaVu Sans;">相应来自</span>web<span style="font-family: DejaVu Sans;">浏览器请求的进程，向</span>models<span style="font-family: DejaVu Sans;">询问数据以及传递数据给</span>views<span style="font-family: DejaVu Sans;">用于演示。</span></p>

<h4><a name="the-components-of-rails"></a>2.2 The Components of Rails Rials<span style="font-family: WenQuanYi Micro Hei;">的组件</span></h4>


<p>Rails ships as many individual components.Rails<span style="font-family: DejaVu Sans;">关联着许多独立的组件。</span>Each of these components are briefly explained below. <span style="font-family: DejaVu Sans;">对这些组建在下面给出简要的解释。</span>If you are new to Rails, as you read this section, don’t get hung up on the details of each component, as they will be explained in further detail later. <span style="font-family: DejaVu Sans;">如果你是</span>Rails<span style="font-family: DejaVu Sans;">的新人，当你阅读到这个部分，不要抛弃任何一个组件的描述，而且他们还会做进一步解释。</span>For instance, we will bring up Rack applications, but you don’t need to know anything about them to continue with this guide.<span style="font-family: DejaVu Sans;">例如，我们将会构造应用骨架，但是在这里，你不需要知道关于他们的更进一步的任何知识。</span></p>

<ul>
    <li>Action Pack<span style="font-family: DejaVu Sans;">动作行为组</span>
<ul>
    <li>Action Controller <span style="font-family: DejaVu Sans;">行为控制</span></li>
    <li>Action Dispatch <span style="font-family: DejaVu Sans;">行为传输</span></li>
    <li>Action View <span style="font-family: DejaVu Sans;">行为视图</span></li>
</ul>
</li>
    <li>Action Mailer <span style="font-family: DejaVu Sans;">行为信封</span></li>
    <li>Active Model</li>
    <li>Active Record</li>
    <li>Active Resource</li>
    <li>Active Support</li>
    <li>Railties</li>
</ul>


<h5><a name="action-pack"></a>2.2.1 Action Pack</h5>


<p>Action Pack is a single gem that contains Action Controller, Action View and Action Dispatch. The “VC” part of “MVC”.Action Pack<span style="font-family: DejaVu Sans;">是一个单独的包它包含了</span>Action Controller, Action View and Action Dispatch<span style="font-family: DejaVu Sans;">传输调度。是</span>MVC<span style="font-family: DejaVu Sans;">的</span>VC<span style="font-family: DejaVu Sans;">部分</span></p>

<h6><a name="action-controller"></a>2.2.1.1 Action Controller</h6>


<p>Action Controller is the component that manages the controllers in a Rails application.The Action Controller framework processes incoming requests to a Rails application, extracts parameters, and dispatches them to the intended action. Services provided by Action Controller include session management, template rendering, and redirect management. Action Controller<span style="font-family: DejaVu Sans;">是在</span>Rails<span style="font-family: DejaVu Sans;">中管理控制的组件。</span>The Action Controller<span style="font-family: DejaVu Sans;">框架进程收到</span>Rails<span style="font-family: DejaVu Sans;">应用程序的请求，提取参数，以及调度他们到具有相应义务的动作。这些服务是由</span>Action Controller<span style="font-family: DejaVu Sans;">包含了会话管理部分，模板渲染（翻译），重定向部分。</span></p>

<h6><a name="action-view"></a>2.2.1.2 Action View</h6>


<p>Action View manages the views of your Rails application. It can create both HTML and XML output by default. Action View manages rendering templates, including nested and partial templates, and includes built-in AJAX support. View templates are covered in more detail in another guide called <a href="http://guides.rubyonrails.org/layouts_and_rendering.html"><span style="color: #000080;"><span style="text-decoration: underline;">Layouts</span></span><span style="color: #000080;"><span style="text-decoration: underline;">and</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rendering</span></span></a>.Action View<span style="font-family: DejaVu Sans;">管理你的</span>Rails<span style="font-family: DejaVu Sans;">应用程序的视图。它可以以创建</span>HTML<span style="font-family: DejaVu Sans;">和</span>XML<span style="font-family: DejaVu Sans;">作为默认输出。</span>Action View<span style="font-family: DejaVu Sans;">管理模板渲染，包含嵌套和组装模板，还包含了内置的</span>AJAX<span style="font-family: DejaVu Sans;">支持。</span></p>

<h6><a name="action-dispatch"></a>2.2.1.3 Action Dispatch</h6>


<p>Action Dispatch handles routing of web requests and dispatches them as you want, either to your application or any other Rack application. Rack applications are a more advanced topic and are covered in a separate guide called <a href="http://guides.rubyonrails.org/rails_on_rack.html"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">on</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rack</span></span></a>.<span style="font-family: DejaVu Sans;">行为调度处理了你的和其他部分的应用程序的路由<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>这些</span>web<span style="font-family: DejaVu Sans;">请求以及一些你所想要的调度，</span></p>

<h5><a name="action-mailer"></a>2.2.2 Action Mailer</h5>


<p>Action Mailer is a framework for building e-mail services. You can use Action Mailer to receive and process incoming email and send simple plain text or complex multipart emails based on flexible templates.Action Mailer<span style="font-family: DejaVu Sans;">是一个营造</span>E-mail<span style="font-family: DejaVu Sans;">服务的框架。你可以使用</span>Action Mailer<span style="font-family: DejaVu Sans;">去发送、接收</span>emial<span style="font-family: DejaVu Sans;">以及发送一些简单的计划文本或者基于灵活模板的复杂的多重的电子邮件。</span></p>

<h5><a name="active-model"></a>2.2.3 Active Model</h5>


<p>Active Model provides a defined interface between the Action Pack gem services and Object Relationship Mapping gems such as Active Record. Active Model allows Rails to utilize other ORM frameworks in place of Active Record if your application needs this.Active Model<span style="font-family: DejaVu Sans;">提供了</span>Action Pack gem<span style="font-family: DejaVu Sans;">服务和</span>Object Relationship Mapping gems<span style="font-family: DejaVu Sans;">之间的接口定义，比如</span>Active<span style="font-family: DejaVu Sans;">记录。</span>Active Model<span style="font-family: DejaVu Sans;">允许</span>Rails<span style="font-family: DejaVu Sans;">在</span>Active Record<span style="font-family: DejaVu Sans;">部分去采用其他</span>ORM<span style="font-family: DejaVu Sans;">框架如果你的应用程序需要。</span></p>

<h5><a name="active-record"></a>2.2.4 Active Record</h5>


<p>Active Record is the base for the models in a Rails application. It provides database independence, basic CRUD functionality, advanced finding capabilities, and the ability to relate models to one another, among other services.Active Record<span style="font-family: DejaVu Sans;">是一个</span>Rails<span style="font-family: DejaVu Sans;">应用程序的</span>models<span style="font-family: DejaVu Sans;">根本。它提供独立的数据库，基于</span>CRUD<span style="font-family: DejaVu Sans;">功能，先进（高级）的查找能力，和与另一个</span>models<span style="font-family: DejaVu Sans;">关联的能力，几乎所有其他服务。</span></p>

<h5><a name="active-resource"></a>2.2.5 Active Resource</h5>


<p>Active Resource provides a framework for managing the connection between business objects and RESTful web services. It implements a way to map web-based resources to local objects with CRUD semantics.Active Resource<span style="font-family: DejaVu Sans;">提供一个管理目标业务和</span>RESTful web<span style="font-family: DejaVu Sans;">服务之间连接的框架。它实现了使用</span>CRUD<span style="font-family: DejaVu Sans;">语义测绘</span>web-base <span style="font-family: DejaVu Sans;">资源到本地目标。</span></p>

<h5><a name="active-support"></a>2.2.6 Active Support</h5>


<p>Active Support is an extensive collection of utility classes and standard Ruby library extensions that are used in Rails, both by the core code and by your applications.Active Support<span style="font-family: DejaVu Sans;">是一个广泛收集实用工具类和标准的</span>Ruby<span style="font-family: DejaVu Sans;">库的扩展，它们由的核心代码和您的应用程序（决定）。</span></p>

<h5><a name="railties"></a>2.2.7 Railties</h5>


<p>Railties is the core Rails code that builds new Rails applications and glues the various frameworks and plugins together in any Rails application.Railties<span style="font-family: DejaVu Sans;">是在</span>Rails<span style="font-family: DejaVu Sans;">代码中创建新</span>Rails<span style="font-family: DejaVu Sans;">应用和在任何</span>Rails<span style="font-family: DejaVu Sans;">应用中粘和各种插件在一起的核心。</span></p>

<h4><a name="rest"></a>2.3 REST</h4>


<p>Rest stands for Representational State Transfer and is the foundation of the RESTful architecture.Rest<span style="font-family: DejaVu Sans;">作为具有代表性的状态传输是</span>RESTful<span style="font-family: DejaVu Sans;">架构的基础。</span>This is generally considered to be Roy Fielding’s doctoral thesis<span style="font-family: DejaVu Sans;">博士论文</span>, <a href="http://www.ics.uci.edu/%7Efielding/pubs/dissertation/top.htm"><span style="color: #000080;"><span style="text-decoration: underline;">Architectural</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Styles</span></span><span style="color: #000080;"><span style="text-decoration: underline;">and</span></span><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Design</span></span><span style="color: #000080;"><span style="text-decoration: underline;">of</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Network-based</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Software</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Architectures</span></span></a>. While you can read through the thesis, REST in terms of Rails boils down to two main principles:<span style="font-family: DejaVu Sans;">当你阅读这篇论文</span>REST<span style="font-family: DejaVu Sans;">在</span>Rails<span style="font-family: DejaVu Sans;">归纳为主要亮点原则：</span></p>

<ul>
    <li>Using resource identifiers such as URLs to represent resources.<span style="font-family: DejaVu Sans;">使用资源标识符比如</span>URLs<span style="font-family: DejaVu Sans;">去表现资源</span></li>
    <li>Transferring representations of the state of that resource between system components.<span style="font-family: DejaVu Sans;">转移（传送）在系统组件之间代表资源的状态</span></li>
</ul>


<p>For example, the following HTTP request:</p>

<p><tt>DELETE</tt><tt> </tt><tt>/photos/17</tt></p>

<p>would be understood to refer to a photo resource with the ID of 17, and to indicate a desired action – deleting that resource. <span style="font-family: DejaVu Sans;">（系统）将会明白参照</span>ID<span style="font-family: DejaVu Sans;">为</span>14<span style="font-family: DejaVu Sans;">的</span>phone<span style="font-family: DejaVu Sans;">资源，注明删除该资源。</span>REST is a natural style for the architecture of web applications, and Rails hooks into this shielding<span style="font-family: DejaVu Sans;">屏蔽</span>you from many of the RESTful complexities and browser quirks.REST<span style="font-family: DejaVu Sans;">自然风格去架构</span>web<span style="font-family: DejaVu Sans;">应用程序，通过组件这样的钩子，使你避免了许多复杂的</span>RESTful<span style="font-family: DejaVu Sans;">和浏览器之间的差异。</span></p>

<p>If you’d like more details on REST as an architectural#<span style="font-family: DejaVu Sans;">架构风格</span>style, these resources are more approachable<span style="font-family: DejaVu Sans;">平易近人</span>than Fielding’s thesis:</p>

<ul>
    <li><a href="http://www.infoq.com/articles/rest-introduction"><span style="color: #000080;"><span style="text-decoration: underline;">A</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Brief</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Introduction</span></span><span style="color: #000080;"><span style="text-decoration: underline;">to</span></span><span style="color: #000080;"><span style="text-decoration: underline;">REST</span></span></a> by Stefan Tilkov</li>
    <li><a href="http://bitworking.org/news/373/An-Introduction-to-REST"><span style="color: #000080;"><span style="text-decoration: underline;">An</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Introduction</span></span><span style="color: #000080;"><span style="text-decoration: underline;">to</span></span><span style="color: #000080;"><span style="text-decoration: underline;">REST</span></span></a> (video tutorial) by Joe Gregorio</li>
    <li><a href="http://en.wikipedia.org/wiki/Representational_State_Transfer"><span style="color: #000080;"><span style="text-decoration: underline;">Representational</span></span><span style="color: #000080;"><span style="text-decoration: underline;">State</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Transfer</span></span></a> article in Wikipedia</li>
    <li><a href="http://www.infoq.com/articles/webber-rest-workflow"><span style="color: #000080;"><span style="text-decoration: underline;">How</span></span><span style="color: #000080;"><span style="text-decoration: underline;">to</span></span><span style="color: #000080;"><span style="text-decoration: underline;">GET</span></span><span style="color: #000080;"><span style="text-decoration: underline;">a</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Cup</span></span><span style="color: #000080;"><span style="text-decoration: underline;">of</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Coffee</span></span></a> by Jim Webber, Savas Parastatidis &amp; Ian Robinson</li>
</ul>


<h3><a name="creating-a-new-rails-project"></a>3 Creating a New Rails Project</h3>


<p>If you follow this guide, you’ll create a Rails project called <tt>blog</tt>, a (very) simple weblog.<span style="font-family: DejaVu Sans;">如果你跟随这个指导，你将会创建一个叫做</span>blog<span style="font-family: DejaVu Sans;">的</span>Rails<span style="font-family: DejaVu Sans;">项目<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>一个非常简单的网络博客。</span>Before you can start building the application, you need to make sure that you have Rails itself installed.<span style="font-family: DejaVu Sans;">当你准备开始构建这个项目之前你需要确保</span>Rails<span style="font-family: DejaVu Sans;">已经完全安装。</span></p>

<h4><a name="installing-rails"></a>3.1 Installing Rails<span style="font-family: WenQuanYi Micro Hei;">安装</span>Rails</h4>


<p>In most cases, the easiest way to install Rails is to take advantage of RubyGems:<span style="font-family: DejaVu Sans;">在大多数情况下，最安装</span>Rails<span style="font-family: DejaVu Sans;">简单的方式是通过方便的</span>RubyGems</p>

<p><code>Usually</code><code> </code><code>run</code><code> </code><code>this</code><code> </code><code>as</code><code> </code><code>the</code><code> </code><code>root</code><code> </code><code>user:</code></p>

<p><code>#</code><code> </code><code>gem</code><code> </code><code>install</code><code> </code><code>rails#</code><span style="font-family: DejaVu Sans;"><code>一般这样安装的</code></span><code>rails</code><span style="font-family: DejaVu Sans;"><code>都是最新的</code></span><code>release</code><span style="font-family: DejaVu Sans;"><code>版本</code></span></p>

<p><code>If</code><code> </code><code>you</code><code>’</code><code>re</code><code> </code><code>working</code><code> </code><code>on</code><code> </code><code>Windows,</code><code> </code><code>you</code><code> </code><code>can</code><code> </code><code>quickly</code><code> </code><code>install</code><code> </code><code>Ruby</code><code> </code><code>and</code><code> </code><code>Rails</code><code> </code><code>with</code><code> </code><a href="http://railsinstaller.org/"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Installer</span></span></a><code>.</code><span style="font-family: DejaVu Sans;"><code>如果你的工作环境是</code></span><code>Windows</code><span style="font-family: DejaVu Sans;"><code>，你可以通过</code></span><code>Rails</code><code> </code><code>Installer</code><span style="font-family: DejaVu Sans;"><code>快速的安装</code></span><code>Rails</code><span style="font-family: DejaVu Sans;"><code>。</code></span></p>

<p><code>/////////////////////////////</code></p>

<p><code>###gem</code><code> </code><code>help</code><code> </code><code>commands</code></p>

<p><code>➜ </code><code>~</code><code> </code><code>gem</code><code> </code><code>install</code><code> </code><code>rails&amp;&amp;sudo</code><code> </code><code>gem</code><code> </code><code>install</code><code> </code><code>rails</code></p>

<p><code>ERROR:</code><code> </code><code>Could</code><code> </code><code>not</code><code> </code><code>find</code><code> </code><code>a</code><code> </code><code>valid</code><code> </code><code>gem</code><code> </code><code>&lsquo;rails&rsquo;</code><code> </code><code>(&gt;=</code><code> </code><code>0)</code><code> </code><code>in</code><code> </code><code>any</code><code> </code><code>repository</code></p>

<p><code>ERROR:</code><code> </code><code>While</code><code> </code><code>executing</code><code> </code><code>gem</code><code> </code><code>&hellip;</code><code> </code><code>(Gem::RemoteFetcher::FetchError)</code></p>

<p><code>Errno::ETIMEDOUT:</code><code> </code><code>Connection</code><code> </code><code>timed</code><code> </code><code>out</code><code> </code><code>&ndash;</code><code> </code><code>connect(2)</code><code> </code><code>(</code><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://rubygems.org/latest_specs.4.8.gz"><a href="http://rubygems.org/latest_specs.4.8.gz">http://rubygems.org/latest_specs.4.8.gz</a></a></span></span><code>)</code></p>

<p><span style="font-family: DejaVu Sans;"><code>经检查和</code></span><code>GFW</code><span style="font-family: DejaVu Sans;"><code>无关，是</code></span><code>rubygems</code><span style="font-family: DejaVu Sans;"><code>的</code></span><code>DNS</code><code> </code><span style="font-family: DejaVu Sans;"><code>调整问题</code></span></p>

<p>&nbsp;</p>

<p><span style="font-family: DejaVu Sans;"><code>问题解决的最好方法方法</code></span></p>

<p><code>jhjguxin@jhjguxin-virtual-machine:~/blog$</code><code> </code><code>gem</code><code> </code><code>update</code><code> </code><code>&mdash;system</code><code> </code></p>

<p>&nbsp;</p>

<p><code>ERROR:</code><code> </code><code>gem</code><code> </code><code>update</code><code> </code><code>&mdash;system</code><code> </code><code>is</code><code> </code><code>disabled</code><code> </code><code>on</code><code> </code><code>Debian,</code><code> </code><code>because</code><code> </code><code>it</code><code> </code><code>will</code><code> </code><code>overwrite</code><code> </code><code>the</code><code> </code><code>content</code><code> </code><code>of</code><code> </code><code>the</code><code> </code><code>rubygems</code><code> </code><code>Debian</code><code> </code><code>package,</code><code> </code><code>and</code><code> </code><code>might</code><code> </code><code>break</code><code> </code><code>your</code><code> </code><code>Debian</code><code> </code><code>system</code><code> </code><code>in</code><code> </code><code>subtle</code><code> </code><code>ways.</code><code> </code><code>The</code><code> </code><code>Debian-supported</code><code> </code><code>way</code><code> </code><code>to</code><code> </code><code>update</code><code> </code><code>rubygems</code><code> </code><code>is</code><code> </code><code>through</code><code> </code><code>apt-get,</code><code> </code><code>using</code><code> </code><code>Debian</code><code> </code><code>official</code><code> </code><code>repositories.</code></p>

<p>&nbsp;</p>

<p><code>If</code><code> </code><code>you</code><code> </code><code>really</code><code> </code><code>know</code><code> </code><code>what</code><code> </code><code>you</code><code> </code><code>are</code><code> </code><code>doing,</code><code> </code><code>you</code><code> </code><code>can</code><code> </code><code>still</code><code> </code><code>update</code><code> </code><code>rubygems</code><code> </code><code>by</code><code> </code><code>setting</code><code> </code><code>the</code><code> </code><code>REALLY_GEM_UPDATE_SYSTEM</code><code> </code><code>environment</code><code> </code><code>variable,</code><code> </code><code>but</code><code> </code><code>please</code><code> </code><code>remember</code><code> </code><code>that</code><code> </code><code>this</code><code> </code><code>is</code><code> </code><code>completely</code><code> </code><code>unsupported</code><code> </code><code>by</code><code> </code><code>Debian.</code></p>

<p><code>jhjguxin@jhjguxin-virtual-machine:~/blog$</code><code> </code><code>export</code><code> </code><code>REALLY_GEM_UPDATE_SYSTEM=1</code></p>

<p>&nbsp;</p>

<p><code>jhjguxin@jhjguxin-virtual-machine:~/blog$</code><code> </code><code>gem</code><code> </code><code>update</code><code> –</code><code>system</code></p>

<p>&nbsp;</p>

<p><code>###</code><span style="font-family: DejaVu Sans;"><code>正是</code></span><code>gem</code><span style="font-family: DejaVu Sans;"><code>出问题了</code><code></code><code>结果直接用</code></span><code>sudo</code><code> </code><code>apt-get</code><code> </code><code>install</code><code> </code><code>rails,</code><span style="font-family: DejaVu Sans;"><code>悲剧了</code></span><code>ubuntu</code><span style="font-family: DejaVu Sans;"><code>现在还是用的</code></span><code>rails2.3</code><span style="font-family: DejaVu Sans;"><code>的包然后导致，后面有些命令无法执行</code></span></p>

<h4><a name="creating-the-blog-application"></a><code>3.2</code><code> </code><code>Creating</code><code> </code><code>the</code><code> </code><code>Blog</code><code> </code><code>Application</code></h4>


<p>The best way to use this guide is to follow each step as it happens, no code or step needed to make this example application has been left out, so you can literally follow along step by step.<span style="font-family: DejaVu Sans;">学习（使用）本指导的最好方式是跟随这里描述的每一步，不写代码或者没有例子所需的步骤会使得这个例子被冷落，你可以根据文字描述的步骤一步接着一步的操作。</span>If you need to see the completed code, you can download it from <a href="https://github.com/mikel/getting-started-code"><span style="color: #000080;"><span style="text-decoration: underline;">Getting</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Started</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Code</span></span></a>.<span style="font-family: DejaVu Sans;">如果你需要完整的代码你可以从这里下载</span><a href="https://github.com/mikel/getting-started-code"><span style="color: #000080;"><span style="text-decoration: underline;">Getting</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Started</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Code</span></span></a><span style="font-family: DejaVu Sans;">。</span></p>

<p>To begin, open a terminal, navigate to a folder where you have rights to create files, and type:<span style="font-family: DejaVu Sans;">开始，打开一个</span>terminal,<span style="font-family: DejaVu Sans;">导航至一个你有权限创建文件的文件夹，并输入：</span></p>

<p><code>rails</code><code> </code><code>new</code><code> </code><code>blog#&mdash;skip-bundle]</code><code> </code><code>#</code><code> </code><code>Don&rsquo;t</code><code> </code><code>run</code><code> </code><code>bundle</code><code> </code><code>install</code><span style="font-family: DejaVu Sans;"><code>这样在国内就不会由于连不上</code></span><code>gem</code><span style="font-family: DejaVu Sans;"><code>即便上能够上也会很慢半天没反映</code></span></p>

<p><code>#</code><span style="font-family: DejaVu Sans;"><code>请确保你的</code></span><code>rials</code><code> </code><span style="font-family: DejaVu Sans;"><code>版本是</code></span><code>3.1</code><code> </code><span style="font-family: DejaVu Sans;"><code>不然的话这只能用下面的了</code></span></p>

<p><code><span style="color: #800000;">The</span></code><code></code><code><span style="color: #800000;">guides</span></code><code></code><code><span style="color: #800000;">for</span></code><code></code><code><span style="color: #800000;">Rails</span></code><code></code><code><span style="color: #800000;">2.3</span></code><code></code><code><span style="color: #800000;">are</span></code><code></code><code><span style="color: #800000;">still</span></code><code></code><code><span style="color: #800000;">available</span></code><code></code><code><span style="color: #800000;">at</span></code><code></code><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/v2.3.11/"><a href="http://guides.rubyonrails.org/v2.3.11/">http://guides.rubyonrails.org/v2.3.11/</a></a></span></span><code><span style="color: #800000;">.</span></code><code> </code></p>

<p><code><em>jhjguxin@jhjguxin-virtual-machine:~$</em></code><code><em> </em></code><code><em>rails</em></code><code><em> </em></code><code><em>new</em></code><code><em> </em></code><code><em>blog#</em></code><span style="font-family: DejaVu Sans;"><code><em>这里建立的文件夹名称为</em></code></span><code><em>new</em></code><span style="font-family: DejaVu Sans;"><code><em>额估计是新版本发生了或者有些地方没弄通（</em></code></span><code><em>ubuntu</em></code><code><em> </em></code><code><em>11.10</em></code><code><em> </em></code><code><em>Rails</em></code><code><em> </em></code><code><em>2.3.14</em></code><code><em> </em></code><code><em>ruby</em></code><code><em> </em></code><code><em>1.8.7</em></code><code><em> </em></code><code><em>(2011-06-30</em></code><code><em> </em></code><code><em>patchlevel</em></code><code><em> </em></code><code><em>352)</em></code><code><em> </em></code><code><em>[i686-linux]</em></code><code><em> </em></code><span style="font-family: DejaVu Sans;"><code><em>）</em></code></span></p>

<p><code><em>jhjguxin@jhjguxin-virtual-machine:~$</em></code><code><em> </em></code><code><em>rails</em></code><code><em> </em></code><code><em>blog</em></code></p>

<p><code><em>jhjguxin@jhjguxin-Aspire-4750:~$</em></code><code><em> </em></code><code><em>sudo</em></code><code><em> </em></code><code><em>gem</em></code><code><em> </em></code><code><em>install</em></code><code><em> </em></code><code><em>json</em></code><code><em> </em></code><code><em>-v</em></code><code><em> </em></code><code><em>1.6.1</em></code></p>

<p><code><em>Invalid</em></code><code><em> </em></code><code><em>gemspec</em></code><code><em> </em></code><code><em>in</em></code><code><em> </em></code><code><em>[/var/lib/gems/1.8/specifications/tilt-1.3.3.gemspec]:</em></code><code><em> </em></code><code><em>invalid</em></code><code><em> </em></code><code><em>date</em></code><code><em> </em></code><code><em>format</em></code><code><em> </em></code><code><em>in</em></code><code><em> </em></code><code><em>specification:</em></code><code><em> </em></code><code><em>&ldquo;2011-08-25</em></code><code><em> </em></code><code><em>00:00:00.000000000Z&rdquo;</em></code></p>

<p><code><em>Invalid</em></code><code><em> </em></code><code><em>gemspec</em></code><code><em> </em></code><code><em>in</em></code><code><em> </em></code><code><em>[/var/lib/gems/1.8/specifications/json-1.6.1.gemspec]:</em></code><code><em> </em></code><code><em>invalid</em></code><code><em> </em></code><code><em>date</em></code><code><em> </em></code><code><em>format</em></code><code><em> </em></code><code><em>in</em></code><code><em> </em></code><code><em>specification:</em></code><code><em> </em></code><code><em>&ldquo;2011-09-18</em></code><code><em> </em></code><code><em>00:00:00.000000000Z&rdquo;</em></code></p>

<p><code><em>Invalid</em></code><code><em> </em></code><code><em>gemspec</em></code><code><em> </em></code><code><em>in</em></code><code><em> </em></code><code><em>[/var/lib/gems/1.8/specifications/tilt-1.3.3.gemspec]:</em></code><code><em> </em></code><code><em>invalid</em></code><code><em> </em></code><code><em>date</em></code><code><em> </em></code><code><em>format</em></code><code><em> </em></code><code><em>in</em></code><code><em> </em></code><code><em>specification:</em></code><code><em> </em></code><code><em>&ldquo;2011-08-25</em></code><code><em> </em></code><code><em>00:00:00.000000000Z&rdquo;</em></code></p>

<p><code><em>Invalid</em></code><code><em> </em></code><code><em>gemspec</em></code><code><em> </em></code><code><em>in</em></code><code><em> </em></code><code><em>[/var/lib/gems/1.8/specifications/json-1.6.1.gemspec]:</em></code><code><em> </em></code><code><em>invalid</em></code><code><em> </em></code><code><em>date</em></code><code><em> </em></code><code><em>format</em></code><code><em> </em></code><code><em>in</em></code><code><em> </em></code><code><em>specification:</em></code><code><em> </em></code><code><em>&ldquo;2011-09-18</em></code><code><em> </em></code><code><em>00:00:00.000000000Z&rdquo;</em></code></p>

<p><span style="font-family: DejaVu Sans;"><code><em>出现这个问题的时候我</em></code><code><em>是改</em></code><code><span style="color: #000000;"><span style="font-size: small;"><em>成</em></span></span></code><code></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>s.date</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>=</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>%</em></span></span></code><code><span style="color: #000000;"><span style="font-size: small;"><em>q{2011-09-18}</em></span></span></code></p>

<p><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>在</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>rails</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>3.1</em></span></span></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>中由于要创建</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>bundler</em></span></span></code><code></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>信息（</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>Gemfile</em></span></span></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>文件）会提示你安装</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>sqlite3</em></span></span></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>等数据库信息，估计也就是你应用程序所用到的一些必须的</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>modules</em></span></span></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>。</em></span></span></code></span></p>

<p><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>这里用的是</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>sqlite3</em></span></span></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>做数据库，提示的是安装的是</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>sqlite3.</em></span></span></code></p>

<p><code><span style="color: #000000;"><span style="font-size: small;"><em>sudo</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>apt-get</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>install</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>sqlite3</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>sqlite3-doc</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libsqlite3-ruby</em></span></span></code></p>

<p><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>还是</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>ERROR:</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>Failed</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>to</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>build</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>gem</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>native</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>extension.</em></span></span></code><code></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>的话</em></span></span></code></span></p>

<p><code><span style="color: #000000;"><span style="font-size: small;"><em>sudo</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>apt-get</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>install</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxslt1-dev</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxml2-dev</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxslt-ruby</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxslt1.1</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxsltc-java-gcj</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxslt-ruby</em></span></span></code></p>

<p><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxslt1-dbg</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxsltc-java</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>ibxslthl-java</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libxslt-ruby1.8</em></span></span></code></p>

<p><code><span style="color: #000000;"><span style="font-size: small;"><em>sudo</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>apt-get</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>install</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libsqlite3-ruby</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>libsqlite3-dev</em></span></span></code></p>

<p><code><span style="color: #000000;"><span style="font-size: small;"><em>sudo</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>gem</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>install</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>therubyracer</em></span></span></code></p>

<p><code><span style="color: #000000;"><span style="font-size: small;"><em>####</em></span></span></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>对于本地安装的</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>rails</em></span></span></code><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>（就是爬不出去墙的）</em></span></span></code></span><code><span style="color: #000000;"><span style="font-size: small;"><em>sudo</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>gem</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>install</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>sqlite3-1.3.4.gem</em></span></span></code></p>

<p><span style="font-family: DejaVu Sans;"><code><span style="color: #000000;"><span style="font-size: small;"><em>成功了！</em></span></span></code></span></p>

<p><code><span style="color: #000000;"><span style="font-size: small;"><em>Your</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>bundle</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>is</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>complete!</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>Use</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em><code>bundle&lt;/em&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;/code&gt;&lt;code&gt;&lt;span style="color: #000000;"&gt;&lt;span style="font-size: small;"&gt;&lt;em&gt;show&lt;/em&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;code&gt;&lt;/code&gt;&lt;code&gt;&lt;span style="color: #000000;"&gt;&lt;span style="font-size: small;"&gt;&lt;em&gt;[gemname]</code></em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>to</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>see</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>where</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>a</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>bundled</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>gem</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>is</em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em>installed.</em></span></span></code></p>

<p><code>This</code><code> </code><code>will</code><code> </code><code>create</code><code> </code><code>a</code><code> </code><code>Rails</code><code> </code><code>application</code><code> </code><code>called</code><code> </code><code>Blog</code><code> </code><code>in</code><code> </code><code>a</code><code> </code><code>directory</code><code> </code><code>called</code><code> </code><code>blog.</code><span style="font-family: DejaVu Sans;"><code>这里将创建一个名叫</code></span><code>Blog</code><span style="font-family: DejaVu Sans;"><code>的</code></span><code>Rails</code><span style="font-family: DejaVu Sans;"><code>应用程序在名称为</code></span><code>blog</code><span style="font-family: DejaVu Sans;"><code>的目录中。</code></span></p>

<p><code>You</code><code> </code><code>can</code><code> </code><code>see</code><code> </code><code>all</code><code> </code><code>of</code><code> </code><code>the</code><code> </code><code>switches</code><code> </code><code>that</code><code> </code><code>the</code><code> </code><code>Rails</code><code> </code><code>application</code><code> </code><code>builder</code><code> </code><code>accepts</code><code> </code><code>by</code><code> </code><code>running</code><code> </code><tt>rails</tt><tt> </tt><tt>new</tt><tt> </tt><tt>-h</tt><code>.</code><span style="font-family: DejaVu Sans;"><code>你可以通过运行</code></span><code>rails</code><code> </code><code>new</code><code> </code><code>-h</code><span style="font-family: DejaVu Sans;"><code>，查看</code></span><code>rails</code><span style="font-family: DejaVu Sans;"><code>应用程序创建器的所有命令（开关）。</code></span></p>

<p><code>After</code><code> </code><code>you</code><code> </code><code>create</code><code> </code><code>the</code><code> </code><code>blog</code><code> </code><code>application,</code><code> </code><code>switch</code><code> </code><code>to</code><code> </code><code>its</code><code> </code><code>folder</code><code> </code><code>to</code><code> </code><code>continue</code><code> </code><code>work</code><code> </code><code>directly</code><code> </code><code>in</code><code> </code><code>that</code><code> </code><code>application:</code><span style="font-family: DejaVu Sans;"><code>当你创建了这个</code></span><code>blog</code><span style="font-family: DejaVu Sans;"><code>程序，跳转到它所在的文件夹中（直接对这个程序编辑）</code></span><code>.</code></p>

<p><code>$cd</code><code> </code><code>blog</code></p>

<p><code>In</code><code> </code><code>any</code><code> </code><code>case,</code><code> </code><code>Rails</code><code> </code><code>will</code><code> </code><code>create</code><code> </code><code>a</code><code> </code><code>folder</code><code> </code><code>in</code><code> </code><code>your</code><code> </code><code>working</code><code> </code><code>directory</code><code> </code><code>called</code><code> </code><tt>blog</tt><code>.</code><code> </code><span style="font-family: DejaVu Sans;"><code>在任何情况下，</code></span><code>Rails</code><span style="font-family: DejaVu Sans;"><code>将会创建一个名为</code></span><code>blog</code><span style="font-family: DejaVu Sans;"><code>的文件夹在你的工作目录中。</code></span><code>Open</code><code> </code><code>up</code><code> </code><code>that</code><code> </code><code>folder</code><code> </code><code>and</code><code> </code><code>explore</code><code> </code><code>its</code><code> </code><code>contents.</code><span style="font-family: DejaVu Sans;"><code>打开这个文件夹浏览其中的内容。</code><code></code></span><code>Most</code><code> </code><code>of</code><code> </code><code>the</code><code> </code><code>work</code><code> </code><code>in</code><code> </code><code>this</code><code> </code><code>tutorial</code><code> </code><code>will</code><code> </code><code>happen</code><code> </code><code>in</code><code> </code><code>the</code><code> </code><tt>app/</tt><code> </code><code>folder,</code><code> </code><code>but</code><code> </code><code>here</code><code>’</code><code>s</code><code> </code><code>a</code><code> </code><code>basic</code><code> </code><code>rundown#</code><span style="font-family: DejaVu Sans;"><code>概述</code><code></code></span><code>on</code><code> </code><code>the</code><code> </code><code>function</code><code> </code><code>of</code><code> </code><code>each</code><code> </code><code>folder</code><code> </code><code>that</code><code> </code><code>Rails</code><code> </code><code>creates</code><code> </code><code>in</code><code> </code><code>a</code><code> </code><code>new</code><code> </code><code>application</code><code> </code><code>by</code><code> </code><code>default:</code><span style="font-family: DejaVu Sans;"><code>在这个体验中的大多数的工作都是在</code></span><code>app/</code><span style="font-family: DejaVu Sans;"><code>这个文件夹中完成的，这里对</code></span><code>Rails</code><span style="font-family: DejaVu Sans;"><code>创建的新应用中的每一个文件夹的功能做出了一个概述：</code></span></p>

<table width="665" cellspacing="0" cellpadding="2"><colgroup> <col width="74" /> <col width="583" /> </colgroup>
<tbody>
<tr>
<th width="74">File/Folder</th>
<th width="583">Purpose#<span style="font-family: DejaVu Sans;">目的</span></th>
</tr>
<tr>
<td width="74">Gemfile</td>
<td width="583">This file allows you to specify what gem dependencies are needed for your Rails application. See section on Bundler, below.<span style="font-family: DejaVu Sans;">这个文件让你可以（添加）你的</span>Rails<span style="font-family: DejaVu Sans;">所需要的特殊的</span>gem<span style="font-family: DejaVu Sans;">依赖关系。</span></td>
</tr>
<tr>
<td width="74">README</td>
<td width="583">This is a brief instruction manual#<span style="font-family: DejaVu Sans;">手册</span>for your application. You should edit this file to tell others what your application does, how to set it up, and so on.<span style="font-family: DejaVu Sans;">这是一个简单的说明手册。你需要编辑这个文件告诉其他人你的应用程序可以做什么，怎么安装等等。</span></td>
</tr>
<tr>
<td width="74">Rakefile</td>
<td width="583">This file locates and loads tasks that can be run from the command line. The task definitions are defined throughout the components of Rails. Rather than changing Rakefile, you should add your own tasks by adding files to the lib/tasks directory of your application.<span style="font-family: DejaVu Sans;">这个文件定位和载入能够在命令行中运行的任务。这个应该是域吧（任务定义）贯穿整个</span>Rials<span style="font-family: DejaVu Sans;">的组件定义。除了修改</span>Rakefile<span style="font-family: DejaVu Sans;">，你还需要添加你自己的任务的文件到你的应用程序的</span>lib/tasks<span style="font-family: DejaVu Sans;">目录。</span></td>
</tr>
<tr>
<td width="74">app/</td>
<td width="583">Contains the controllers, models, views and assets for your application. You’ll focus on this folder for the remainder of this guide.<span style="font-family: DejaVu Sans;">包含</span>controllers, models, views<span style="font-family: DejaVu Sans;">和你应用程序的</span>assets<span style="font-family: DejaVu Sans;">（资源），再接下面的手册中你主要的注意力应该放在这里。</span></td>
</tr>
<tr>
<td width="74">config/</td>
<td width="583">Configure your application’s runtime rules, routes, database, and more.<span style="font-family: DejaVu Sans;">配置你的应用程序的运行的规则，（</span>url<span style="font-family: DejaVu Sans;">）路由，数据库和其他。</span></td>
</tr>
<tr>
<td width="74">config.ru</td>
<td width="583">Rack configuration for Rack based servers used to start the application.<span style="font-family: DejaVu Sans;">基于</span>Rack<span style="font-family: DejaVu Sans;">服务器使用这个应用程序的</span>Rack<span style="font-family: DejaVu Sans;">配置</span></td>
</tr>
<tr>
<td width="74">db/</td>
<td width="583">Shows your current database schema, as well as the database migrations. You’ll learn about migrations shortly.<span style="font-family: DejaVu Sans;">显示你当前的数据表，同样也显示数据迁移。你将会简单的了解关于（数据）迁移。</span></td>
</tr>
<tr>
<td width="74">doc/</td>
<td width="583">In-depth documentation for your application.<span style="font-family: DejaVu Sans;">应用程序的（深入）全面的文档。</span></td>
</tr>
<tr>
<td width="74">lib/</td>
<td width="583">Extended modules for your application (not covered in this guide).<span style="font-family: DejaVu Sans;">应用程序用到的扩展库（本手册没有涉及）</span></td>
</tr>
<tr>
<td width="74">log/</td>
<td width="583">Application log files.<span style="font-family: DejaVu Sans;">应用程序的日志文件</span></td>
</tr>
<tr>
<td width="74">public/</td>
<td width="583">The only folder seen to the world as-is. Contains the static files and compiled assets.<span style="font-family: DejaVu Sans;">这是外部可见的唯一文件夹。包含静态文件和编译资源。</span></td>
</tr>
<tr>
<td width="74">script/</td>
<td width="583">Contains the rails script that starts your app and can contain other scripts you use to deploy#<span style="font-family: DejaVu Sans;">部署配置</span>or run your application.<span style="font-family: DejaVu Sans;">包含运行你的</span>app<span style="font-family: DejaVu Sans;">的</span>rails<span style="font-family: DejaVu Sans;">脚本，或者其他用来配置或运行你的应用程序的</span>scripts<span style="font-family: DejaVu Sans;">。</span></td>
</tr>
<tr>
<td width="74">test/</td>
<td width="583">Unit tests, fixtures, and other test apparatus. These are covered in <a href="http://guides.rubyonrails.org/testing.html"><span style="color: #000080;"><span style="text-decoration: underline;">Testing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Applications</span></span></a><span style="font-family: DejaVu Sans;">单元测试，</span>fixtures<span style="font-family: DejaVu Sans;">，或者其他</span>test<span style="font-family: DejaVu Sans;">工具。他们在</span><a href="http://guides.rubyonrails.org/testing.html"><span style="color: #000080;"><span style="text-decoration: underline;">Testing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Applications</span></span></a><span style="font-family: DejaVu Sans;">里面有完整的讲述。</span></td>
</tr>
<tr>
<td width="74">tmp/</td>
<td width="583">Temporary files<span style="font-family: DejaVu Sans;">模板文件</span></td>
</tr>
<tr>
<td width="74">vendor/</td>
<td width="583">A place for all third-party code. In a typical Rails application, this includes Ruby Gems, the Rails source code (if you install it into your project) and plugins containing additional prepackaged functionality.<span style="font-family: DejaVu Sans;">放置第三方代码的地方。在一个典型的</span>Rails<span style="font-family: DejaVu Sans;">应用程序中，这里包含</span>Ruby Gems<span style="font-family: DejaVu Sans;">，</span>Rails<span style="font-family: DejaVu Sans;">源代码（如果你把</span>Rails<span style="font-family: DejaVu Sans;">安装到你的项目中）还包含一些预先包装好的额外的插件</span></td>
</tr>
</tbody>
</table>


<h4><a name="configuring-a-database"></a><code>3.3</code><code> </code><code>Configuring</code><code> </code><code>a</code><code> </code><code>Database</code><span style="font-family: WenQuanYi Micro Hei;"><code>配置数据库</code></span></h4>


<p>Just about every Rails application will interact with a database.<span style="font-family: DejaVu Sans;">基本上每个</span>Rails<span style="font-family: DejaVu Sans;">应用程序都会和一个数据库互动。</span>The database to use is specified in a configuration file, <tt>config/database.yml</tt>.<span style="font-family: DejaVu Sans;">使用的数据库在</span>config/database.yml<span style="font-family: DejaVu Sans;">的配置文件中指定的。</span>If you open this file in a new Rails application, you’ll see a default database configuration using SQLite3. The file contains sections for three different environments in which Rails can run by default:<span style="font-family: DejaVu Sans;">如果你在一个新的</span>Rails<span style="font-family: DejaVu Sans;">应用程序中打开这个文件，你将会看到一个默认的数据库配置使用的是</span>SQLite3.<span style="font-family: DejaVu Sans;">这个文件包含</span>Rails<span style="font-family: DejaVu Sans;">可以默认运行的三个不同的环境会话。</span></p>

<ul>
    <li>The <tt>development</tt> environment is used on your development computer as you interact manually with the application. <span style="font-family: DejaVu Sans;">开发环境使用在开发计算机上，让你和你的应用程序手动交互</span></li>
    <li>The <tt>test</tt> environment is used to run automated tests. <span style="font-family: DejaVu Sans;">测试环境用于运行自动测试</span></li>
    <li>The <tt>production</tt> environment is used when you deploy your application for the world to use.<span style="font-family: DejaVu Sans;">产品环境在你向外发布过后使用</span></li>
</ul>


<h5><a name="configuring-an-sqlite3-database"></a>3.3.1 Configuring an SQLite3 Database</h5>


<p>Rails comes with built-in support for <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://www.sqlite.org/">SQLite3</a></span></span>, which is a lightweight serverless database application.Rails<span style="font-family: DejaVu Sans;">内置并支持</span>SQLite3<span style="font-family: DejaVu Sans;">，</span>SQLite3<span style="font-family: DejaVu Sans;">是一个轻量级的数据库服务器。</span>While a busy production environment may overload SQLite, it works well for development and testing.<span style="font-family: DejaVu Sans;">但是一个繁忙的产品环境可能会导致</span>SQLite<span style="font-family: DejaVu Sans;">超载，</span>SQLite3<span style="font-family: DejaVu Sans;">更适合在开发或测试中使用。</span>Rails defaults to using an SQLite database when creating a new project, but you can always change it later.Rails<span style="font-family: DejaVu Sans;">在创建一个新项目的时候默认使用一个</span>SQLite<span style="font-family: DejaVu Sans;">数据库，但是你可以在之后随时更改。</span></p>

<p>Here’s the section of the default configuration file (<tt>config/database.yml</tt>) with connection information for the development environment:<span style="font-family: DejaVu Sans;">这是在开发环境中配置连接信息的默认配置文件的节选：</span></p>

<p><code>development:</code></p>

<p><code> </code><code>adapter:</code><code> </code><code>sqlite3</code></p>

<p><code> </code><code>database:</code><code> </code><code>db/development.sqlite3</code></p>

<p><code> </code><code>pool:</code><code> </code><code>5</code></p>

<p><code> </code><code>timeout:</code><code> </code><code>5000</code></p>

<p>In this guide we are using an SQLite3 database for data storage, because it is a zero configuration database that just works. <span style="font-family: DejaVu Sans;">在这个手册中使用一个</span>SQLite3<span style="font-family: DejaVu Sans;">数据库存存储数据，因为它不需要我们再去配置就能工作。</span>Rails also supports MySQL and PostgreSQL “out of the box”, and has plugins for many database systems.Rails<span style="font-family: DejaVu Sans;">同样支持</span>MySQL<span style="font-family: DejaVu Sans;">和</span>PostgreSQL <span style="font-family: DejaVu Sans;">，它还有许多支持其他数据库系统的插件</span>If you are using a database in a production environment Rails most likely has an adapter for it.<span style="font-family: DejaVu Sans;">如果你在产品环境中使用数据库对</span>Rails<span style="font-family: DejaVu Sans;">来说仅仅是添加一个适配器而已。</span></p>

<h5><a name="configuring-a-mysql-database"></a>3.3.2 Configuring a MySQL Database<span style="font-family: WenQuanYi Micro Hei;">配置一个</span>MySQL<span style="font-family: WenQuanYi Micro Hei;">数据库</span></h5>


<p>If you choose to use MySQL instead of the shipped SQLite3 database, your <tt>config/database.yml</tt> will look a little different.<span style="font-family: DejaVu Sans;">如果你选择</span>MySQL<span style="font-family: DejaVu Sans;">代替</span>SQLite3<span style="font-family: DejaVu Sans;">数据库，你的配置文件会有一点不同。</span>Here’s the development section:<span style="font-family: DejaVu Sans;">这是开发环境下（的配置）：</span></p>

<p><code>development:</code></p>

<p><code> </code><code>adapter:</code><code> </code><code>mysql2</code></p>

<p><code> </code><code>encoding:</code><code> </code><code>utf8</code></p>

<p><code> </code><code>database:</code><code> </code><code>blog_development</code></p>

<p><code> </code><code>pool:</code><code> </code><code>5</code></p>

<p><code> </code><code>username:</code><code> </code><code>root</code></p>

<p><code> </code><code>password:</code></p>

<p><code> </code><code>socket:</code><code> </code><code>/tmp/mysql.sock</code></p>

<p>If your development computer’s MySQL installation includes a root user with an empty password, this configuration should work for you. <span style="font-family: DejaVu Sans;">如果你的开发计算机中安装的</span>MySQL<span style="font-family: DejaVu Sans;">包含一个</span>root<span style="font-family: DejaVu Sans;">用户和空的密码，这个配置文件就可以工作。</span>Otherwise, change the username and password in the <tt>development</tt> section as appropriate.<span style="font-family: DejaVu Sans;">否则，修改合适的开发环境中使用的用户名和密码。</span></p>

<h5><a name="configuring-a-postgresql-database"></a>3.3.3 Configuring a PostgreSQL Database<span style="font-family: WenQuanYi Micro Hei;">配置一个</span>PostgreSQL<span style="font-family: WenQuanYi Micro Hei;">数据库</span></h5>


<p>If you choose to use PostgreSQL, your <tt>config/database.yml</tt> will be customized to use PostgreSQL databases:</p>

<p><code>development:</code></p>

<p><code> </code><code>adapter:</code><code> </code><code>postgresql</code></p>

<p><code> </code><code>encoding:</code><code> </code><code>unicode</code></p>

<p><code> </code><code>database:</code><code> </code><code>blog_development</code></p>

<p><code> </code><code>pool:</code><code> </code><code>5</code></p>

<p><code> </code><code>username:</code><code> </code><code>blog</code></p>

<p><code> </code><code>password:</code></p>

<h5><a name="configuring-an-sqlite3-database-for-jrub"></a> 3.3.4 Configuring an SQLite3 Database for JRuby Platform<span style="font-family: WenQuanYi Micro Hei;">配置在</span>JRuby<span style="font-family: WenQuanYi Micro Hei;">平台中使用的</span>SQLite3<span style="font-family: WenQuanYi Micro Hei;">数据库</span></h5>


<p>If you choose to use SQLite3 and using JRuby, your <tt>config/database.yml</tt> will look a little different. Here’s the development section:</p>

<p><code>development:</code></p>

<p><code> </code><code>adapter:</code><code> </code><code>jdbcsqlite3</code></p>

<p><code> </code><code>database:</code><code> </code><code>db/development.sqlite3</code></p>

<h5><a name="configuring-a-mysql-database-for-jruby-p"></a> 3.3.5 Configuring a MySQL Database for JRuby Platform<span style="font-family: WenQuanYi Micro Hei;">配置在</span>JRuby<span style="font-family: WenQuanYi Micro Hei;">平台中使用的</span>MySQL<span style="font-family: WenQuanYi Micro Hei;">数据库</span></h5>


<p>If you choose to use MySQL and using JRuby, your <tt>config/database.yml</tt> will look a little different. Here’s the development section:</p>

<p><code>development:</code></p>

<p><code> </code><code>adapter:</code><code> </code><code>jdbcmysql</code></p>

<p><code> </code><code>database:</code><code> </code><code>blog_development</code></p>

<p><code> </code><code>username:</code><code> </code><code>root</code></p>

<p><code> </code><code>password:</code></p>

<h5><a name="configuring-a-postgresql-database-for-jr"></a> 3.3.6 Configuring a PostgreSQL Database for JRuby Platform<span style="font-family: WenQuanYi Micro Hei;">配置在</span>JRuby<span style="font-family: WenQuanYi Micro Hei;">平台中使用的</span>PostgreSQL<span style="font-family: WenQuanYi Micro Hei;">数据库</span></h5>


<p>Finally if you choose to use PostgreSQL and using JRuby, your <tt>config/database.yml</tt> will look a little different. Here’s the development section:</p>

<p><code>development:</code></p>

<p><code> </code><code>adapter:</code><code> </code><code>jdbcpostgresql</code></p>

<p><code> </code><code>encoding:</code><code> </code><code>unicode</code></p>

<p><code> </code><code>database:</code><code> </code><code>blog_development</code></p>

<p><code> </code><code>username:</code><code> </code><code>blog</code></p>

<p><code> </code><code>password:</code></p>

<p>Change the username and password in the <tt>development</tt> section as appropriate.<span style="font-family: DejaVu Sans;">修改在开发会话中使用的合适的用户名和密码</span></p>

<p>You don’t have to update the database configurations manually. <span style="font-family: DejaVu Sans;">你不是必须手动的配置数据库</span>If you look at the options of the application generator, you will see that one of the options is named <tt>—</tt><tt>database</tt>. <span style="font-family: DejaVu Sans;">如果你查看应用程序产生器，你将会发现一个选项（</span>-d, &mdash;database=name Preconfigure for selected database (options: mysql/oracle/postgresql/sqlite2/sqlite3/frontbase/ibm_db).<span style="font-family: DejaVu Sans;">）</span></p>

<p>This option allows you to choose an adapter from a list of the most used relational databases. You can even run the generator repeatedly: <tt>cd</tt><tt> </tt><tt>..</tt><tt> </tt><tt>&amp;&amp;</tt><tt> </tt><tt>rails</tt><tt> </tt><tt>blog</tt><tt> </tt><tt>&mdash;database=mysql</tt>When you confirm<span style="font-family: DejaVu Sans;">确认</span>the overwriting of the <tt>config/database.yml</tt> file, your application will be configured for MySQL instead of SQLite.</p>

<h4><a name="creating-the-database"></a>3.4 Creating the Database<span style="font-family: WenQuanYi Micro Hei;">创建数据库</span></h4>


<p>Now that you have your database configured,it’s time to have Rails create an empty database for you. <span style="font-family: DejaVu Sans;">现在你已经有了你的数据库配置文件了，是时候创建一个空的数据库了。</span>You can do this by running a rake command:</p>

<p><code>$</code><code> </code><code>rake</code><code> </code><code>db:create</code><code> #</code><span style="font-family: DejaVu Sans;"><code><span style="font-family: Liberation Serif,Times New Roman,serif;">确保你的系统中已经有一个</span></code></span><code>JavaScript runtime.</code><code>#</code><span style="font-family: DejaVu Sans;"><code>可能还需要执行</code></span><code>sudo</code><code> </code><code><span style="font-family: monospace;">gem</span></code><code></code><code><span style="font-family: monospace;">install</span></code><code></code><code><span style="font-family: monospace;">therubyracer</span></code><code></code><code><span style="font-family: monospace;">&amp;&amp;</span></code><code>sudo</code><code> </code><code>gem</code><code> </code><code>install</code><code> </code><code>execjs</code></p>

<p>jhjguxin@jhjguxin-virtual-machine:~/blog$ rake db:create</p>

<p>rake aborted!</p>

<p>Could not find a JavaScript runtime. See <a href="https://github.com/sstephenson/execjs">https://github.com/sstephenson/execjs</a> for a list of available runtimes.</p>

<p><code>one</code><code> </code><code>way:</code></p>

<p><span style="font-family: DejaVu Sans;"><code>并且</code></span><code>In</code><code> </code><code>your</code><code> </code><code>Gemfile</code></p>

<pre>write this

gem 'execjs'

gem 'therubyracer'

and then run

bundle install</pre>


<p><code> #</code><span style="font-family: DejaVu Sans;"><code>在</code></span><code>ubuntu</code><span style="font-family: DejaVu Sans;"><code>环境中安装</code></span><code>sqlite3</code><span style="font-family: DejaVu Sans;"><code>库</code></span><code><span style="color: #000000;"><span style="font-size: small;"><em><span style="text-decoration: underline;"><strong>sudo</strong></span></em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em><span style="text-decoration: underline;"><strong>apt-get</strong></span></em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em><span style="text-decoration: underline;"><strong>install</strong></span></em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em><span style="text-decoration: underline;"><strong>libsqlite3-ruby</strong></span></em></span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;"><em><span style="text-decoration: underline;"><strong>libsqlite3-dev</strong></span></em></span></span></code><code> </code><span style="font-family: DejaVu Sans;"><code>也尝试过使用</code></span><code>gem</code><code> </code><code>install</code><code> </code><code>sqlite3-ruby</code><span style="font-family: DejaVu Sans;"><code>但是网上说是</code></span><code>gem</code><code> </code><code>nds</code><span style="font-family: DejaVu Sans;"><code>有问题</code><code></code><code>安装</code></span><code>ruby</code><span style="font-family: DejaVu Sans;"><code>的</code></span><code> mysql</code><span style="font-family: DejaVu Sans;"><code>库</code></span><code><span style="text-decoration: underline;"><strong>sudo</strong></span></code><code></code><code><span style="text-decoration: underline;"><strong>apt-get</strong></span></code><code></code><code><span style="text-decoration: underline;"><strong>install</strong></span></code><code></code><code><span style="text-decoration: underline;"><strong>libmysql-ruby</strong></span></code></p>

<p>another way:</p>

<p><span style="font-family: DejaVu Sans;"><span style="color: #800000;">参照上面的网址：我找了一个</span></span><span style="color: #800000;">ubuntu<span style="font-family: DejaVu Sans;">里面有的</span></span><span style="color: #800000;">Node.js</span><span style="font-family: DejaVu Sans;"><span style="color: #800000;">就可以不用那个</span></span><span style="color: #800000;">therubyracer<span style="font-family: DejaVu Sans;">了</span></span></p>

<p>jhjguxin@jhjguxin-virtual-machine:~/blog$ rake db:create</p>

<p>This will create your development and test SQLite3 databases inside the <tt>db/</tt> folder.<span style="font-family: DejaVu Sans;">将会在</span>db/<span style="font-family: DejaVu Sans;">文件夹中创建你的开发环境的数据库文件</span>development.sqlite3</p>

<p>Rake is a general-purpose command-runner that Rails uses for many things. You can see the list of available rake commands in your application by running <tt>rake</tt><tt> </tt><tt>-T</tt>.Rake<span style="font-family: DejaVu Sans;">是一个通用的命令行可以帮助</span>Rails<span style="font-family: DejaVu Sans;">用户完成很多事情。你可以通过运行</span><tt>rake</tt><tt> </tt><tt>-T</tt><tt> </tt><span style="font-family: DejaVu Sans;">查看可用的</span>rake<span style="font-family: DejaVu Sans;">命令</span></p>

<p>ruby script/server#<span style="font-family: DejaVu Sans;">或者</span>script/server</p>

<h3><a name="hello-rails"></a>4 Hello, Rails!</h3>


<p>One of the traditional places to start with a new language is by getting some text up on screen quickly. To do this, you need to get your Rails application server running.<span style="font-family: DejaVu Sans;">传统的方式之一，开始使用一种新的（命令）语法并得到快速掠过的文字。要得到这样的结果你需要使你的</span>Rails<span style="font-family: DejaVu Sans;">程序运行。</span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>server</code><code> </code><code>#&mdash;&mdash;-rails2.3.1</code><code> </code>$ ruby script/server#</p>

<p>This will fire up an instance of the WEBrick web server by default (Rails can also use several other web servers). <span style="font-family: DejaVu Sans;">这里默认将开启一个</span>WEBrick<span style="font-family: DejaVu Sans;">服务器的的实例（</span>Rails<span style="font-family: DejaVu Sans;">也可能使用一些其他的</span>web<span style="font-family: DejaVu Sans;">服务器）。</span>To see your application in action, open a browser window and navigate to <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/"><a href="http://localhost:3000">http://localhost:3000</a></a></span></span>. You should see Rails’ default information page:<span style="font-family: DejaVu Sans;">查看你的应用程序的行为，打开一个浏览器并且导航到</span>127.0.0.0<span style="font-family: DejaVu Sans;">：</span>3000<span style="font-family: DejaVu Sans;">你将会看到一个</span>Rails<span style="font-family: DejaVu Sans;">默认的信息页面。</span></p>

<p>To stop the web server, hit Ctrl+C in the terminal window where it’s running. In development mode, Rails does not generally require you to stop the server; changes you make in files will be automatically picked up by the server.<span style="font-family: DejaVu Sans;">要终止</span>web<span style="font-family: DejaVu Sans;">服务，在命令运行的终端中按下</span>Ctrl+C<span style="font-family: DejaVu Sans;">。在开发环境模式中，</span>Rails<span style="font-family: DejaVu Sans;">一般不需要你停止服务；你所做的更改将自动的编译进需要的文件中并且重启服务。</span></p>

<p>The “Welcome Aboard#<span style="font-family: DejaVu Sans;">船<span style="font-family: Liberation Serif,Times New Roman,serif;">” </span></span>page is the <em>smoke</em><em> </em><em>test</em> for a new Rails application: it makes sure that you have your software configured correctly enough to serve a page.<span style="font-family: DejaVu Sans;">这个欢迎界面体现了一个新的</span>Rails<span style="font-family: DejaVu Sans;">应用程序创建成功（通过了</span>Rails<span style="font-family: DejaVu Sans;">的自检）。</span>You can also click on the <em>About</em><em> </em><em>your</em><em> </em><em>application</em><em>’</em><em>s</em><em> </em><em>environment</em> link to see a summary of your application’s environment.<span style="font-family: DejaVu Sans;">你可以点击<span style="font-family: Liberation Serif,Times New Roman,serif;">‘ </span></span><em>About</em><em> </em><em>your</em><em> </em><em>application</em><em>’</em><em>s</em><em> </em><em>environment</em>’<span style="font-family: DejaVu Sans;">查看你的应用程序运行环境摘要信息。</span></p>

<h4><a name="say-hello-rails"></a>4.2 Say “Hello”, Rails</h4>


<p>To get Rails saying “Hello”, you need to create at minimum a controller and a view.<span style="font-family: DejaVu Sans;">要使</span>Rails<span style="font-family: DejaVu Sans;">说出（显示）<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span>你好<span style="font-family: Liberation Serif,Times New Roman,serif;">”</span>，你还需要创建一个最小的</span>a controller and a view<span style="font-family: DejaVu Sans;">。</span>Fortunately, you can do that in a single command. Enter this command in your terminal:<span style="font-family: DejaVu Sans;">幸运的是，你可以完成这些通过一行命令。在终端中输入：</span>
<code>rails</code><code> </code><code>generate</code><code> </code><code>controller</code><code> </code><code>home</code><code> </code><code>index</code><code> </code>##rails2.3.1 <code><span style="color: #000000;"><span style="font-size: small;">script/generate</span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;">controller</span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;">home</span></span></code><code></code><code><span style="color: #000000;"><span style="font-size: small;">index##</span></span></code></p>

<p>If you get a command not found error when running this command, you need to explicitly pass Rails <tt>rails</tt> commands to Ruby: <tt><em>ruby</em></tt><tt><em> </em></tt><tt><em>\path\to\your\application\script\rails</em></tt><tt><em> </em></tt><tt><em>generate</em></tt><tt><em> </em></tt><tt><em>controller</em></tt><tt><em> </em></tt><tt><em>home</em></tt><tt><em> </em></tt><tt><em>index</em></tt><em>.</em><span style="font-family: DejaVu Sans;"><em>如果你在输入这个命令的时候出现没有这个命令错误，你需要明确的使用</em></span><em>ruby</em><span style="font-family: DejaVu Sans;"><em>来执行</em></span><em>Rails</em><span style="font-family: DejaVu Sans;"><em>命令。</em><span style="color: #800000;"><em>这里就没有</em></span></span><span style="color: #800000;"><em>rails</em><span style="font-family: DejaVu Sans;"><em>这个文件</em></span><span style="color: #800000;"><em>应该是</em></span></span><span style="color: #800000;"><em>ruby</em></span><span style="color: #800000;"><em>script/generate</em></span><span style="color: #800000;"><em>controller</em></span><span style="color: #800000;"><em>home</em></span><span style="color: #800000;"><em>index</em></span></p>

<p>Rails will create several files for you, including <tt>app/views/home/index.html.erb</tt>. Rails<span style="font-family: DejaVu Sans;">将会为你创建一些文件，包含<span style="font-family: Liberation Serif,Times New Roman,serif;">‘</span></span><tt>app/views/home/index.html.erb</tt>’<span style="font-family: DejaVu Sans;">。</span>This is the template that will be used to display the results of the <tt>index</tt> action (method) in the <tt>home</tt> controller.<span style="font-family: DejaVu Sans;">这个模板会用来显示在</span><tt>home</tt> controller<span style="font-family: DejaVu Sans;">中的</span><tt>index</tt> action (method)<span style="font-family: DejaVu Sans;">的结果。</span>Open this file in your text editor and edit it to contain a single line of code:<span style="font-family: DejaVu Sans;">在文本编辑器中打开这个文件并输入：</span></p>

<p><code>&lt;h1&gt;Hello,</code><code> </code><code>Rails!&lt;/h1&gt;</code><code> </code></p>

<h4><a name="setting-the-application-home-page"></a>4.3 Setting the Application Home Page</h4>


<p>Now that we have made the controller and view, we need to tell Rails when we want “Hello Rails” to show up. <span style="font-family: DejaVu Sans;">现在我们已经创建了</span>controller <span style="font-family: DejaVu Sans;">和</span>view<span style="font-family: DejaVu Sans;">，我们还需要告诉</span>Rails<span style="font-family: DejaVu Sans;">我们想在什么时候显示出来。</span>In our case, we want it to show up when we navigate to the root URL of our site, <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/"><a href="http://localhost:3000">http://localhost:3000</a></a></span></span>, instead of the “Welcome Aboard” smoke test.<span style="font-family: DejaVu Sans;">在本例中，我们想让它在我们导航至站点</span>url<span style="font-family: DejaVu Sans;">根目录的时候替代<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>Welcome Aboard”<span style="font-family: DejaVu Sans;">显示。</span></p>

<p>The first step to doing this is to delete the default page from your application:<span style="font-family: DejaVu Sans;">首先移除应用程序中的默认页面。</span></p>

<p><code>rm</code><code> </code><code>public/index.html</code></p>

<p>We need to do this as Rails will deliver#<span style="font-family: DejaVu Sans;">提供，传输</span>any static file in the <tt>public</tt> directory in preference#<span style="font-family: DejaVu Sans;">偏好优先</span>to any dynamic#<span style="font-family: DejaVu Sans;">动态</span>content we generate from the controllers.<span style="font-family: DejaVu Sans;">我们必须这样做因为，</span>Rails<span style="font-family: DejaVu Sans;">将会传送任何在</span>public<span style="font-family: DejaVu Sans;">的静态文件优先于我们在</span>controllers<span style="font-family: DejaVu Sans;">生成的动态（显示）内容。</span></p>

<p>Now, you have to tell Rails where your actual home page is located.Open the file <tt>config/routes.rb</tt> in your editor. This is your application’s <em>routing</em><em> </em><em>file</em> which holds entries in a special DSL (domain-specific language) that tells Rails how to connect incoming requests to controllers and actions. This file contains many sample routes on commented lines, and one of them actually shows you how to connect the root of your site to a specific controller and action. Find the line beginning with <tt>root</tt><tt> </tt><tt>:to</tt>, uncomment it and change it like the following:<span style="font-family: DejaVu Sans;">现在你还必须告诉</span>Rails <span style="font-family: DejaVu Sans;">你实际上的主页在哪里。在文本编辑器中打开</span><tt>config/routes.rb</tt> <span style="font-family: DejaVu Sans;">。这是你应用程序的路由文件，它采用</span>DSL<span style="font-family: DejaVu Sans;">语言囊括了告诉</span>Rails<span style="font-family: DejaVu Sans;">怎样连接请求信息到</span>controllers and actions.<span style="font-family: DejaVu Sans;">的所有条目。</span></p>

<p><span style="font-family: DejaVu Sans;">这个文件包含许多简单的路由命令，其中一条实际上是用于告诉我们怎样连接你站点根目录到一个指定的</span>controller and acti<span style="font-family: DejaVu Sans;">。找到以</span>root :to<span style="font-family: DejaVu Sans;">开头的那一行，注释掉它改成如下内容：</span></p>

<p><code>Blog::Application.routes.draw</code><code> </code><code>do</code></p>

<p>&nbsp;</p>

<p><code> </code><code>get</code><code> </code><code>&ldquo;home/index&rdquo;</code></p>

<p>&nbsp;</p>

<p><code> </code><code>root</code><code> </code><code>:to</code><code> </code><code>=&gt;</code><code> </code><code>&ldquo;home#index&rdquo;</code></p>

<p><code>//////////////////this</code><code> </code><code>depend</code><code> </code><code>on</code><code> </code><code>rails</code><code> </code><code>2.3.1/////////</code></p>

<p><code>Blog::Application.routes.draw</code><code> </code><code>do</code></p>

<p>&nbsp;</p>

<p><code> </code><code>#&hellip;</code></p>

<p><code> </code><code>#</code><code> </code><code>You</code><code> </code><code>can</code><code> </code><code>have</code><code> </code><code>the</code><code> </code><code>root</code><code> </code><code>of</code><code> </code><code>your</code><code> </code><code>site</code><code> </code><code>routed</code><code> </code><code>with</code><code> </code><code>&ldquo;root&rdquo;</code></p>

<p><code> </code><code>#</code><code> </code><code>just</code><code> </code><code>remember</code><code> </code><code>to</code><code> </code><code>delete</code><code> </code><code>public/index.html.</code></p>

<p><code> </code><code>map.root</code><code> </code><code>:controller</code><code> </code><code>=&gt;</code><code> </code><code>&ldquo;home&rdquo;</code><code> </code></p>

<p><code>or</code></p>

<p><code> </code><code>map.root</code><code> </code><code>:controller</code><code> </code><code>=&gt;</code><code> </code><code>&ldquo;home&rdquo;,:action</code><code> </code><code>=&gt;</code><code> </code><code>&lsquo;index&rsquo;</code></p>

<p><code> </code><code>##root</code><code> </code><code>:to</code> <code>=&gt;</code><code> </code><code>&ldquo;home#index&rdquo;</code></p>

<p>The <tt>root</tt><tt> </tt><tt>:to</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&ldquo;home#index&rdquo;</tt> tells Rails to map the root action to the home controller’s index action.</p>

<p><span style="color: #800000;">ps</span><span style="color: #800000;">-ef|grep</span><span style="color: #800000;">webrick</span></p>

<p><span style="color: #800000;">kill</span><span style="color: #800000;">-9</span><span style="font-family: DejaVu Sans;"><span style="color: #800000;">上面得到的</span></span><span style="color: #800000;">id</span><span style="font-family: DejaVu Sans;"><span style="color: #800000;">强制结束</span></span><span style="color: #800000;">WEBrick<span style="font-family: DejaVu Sans;">服务</span></span></p>

<p>Now if you navigate to <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/"><a href="http://localhost:3000">http://localhost:3000</a></a></span></span> in your browser, you’ll see <tt>Hello,</tt><tt> </tt><tt>Rails!</tt>.<span style="font-family: DejaVu Sans;">现在你在浏览器中导航至</span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/"><a href="http://localhost:3000">http://localhost:3000</a></a></span></span> <span style="font-family: DejaVu Sans;">，你将会看到<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span><tt>Hello,</tt><tt> </tt><tt>Rails!</tt>”.</p>

<p>For more information about routing, refer to <a href="http://guides.rubyonrails.org/routing.html"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Routing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">from</span></span><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Outside</span></span><span style="color: #000080;"><span style="text-decoration: underline;">In</span></span></a>.<span style="font-family: DejaVu Sans;">更多的信息请参见</span><a href="http://guides.rubyonrails.org/routing.html"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Routing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">from</span></span><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Outside</span></span><span style="color: #000080;"><span style="text-decoration: underline;">In</span></span></a><span style="font-family: DejaVu Sans;">。</span></p>

<h3><a name="getting-up-and-running-quickly-with-scaf"></a> 5 Getting Up and Running Quickly with Scaffolding<span style="font-family: WenQuanYi Micro Hei;">使用</span>Scaffolding<span style="font-family: WenQuanYi Micro Hei;">快速创建并运行</span></h3>


<p>Rails <em>scaffolding</em> is a quick way to generate some of the major pieces of an application. Rails <em>scaffolding<span style="font-family: DejaVu Sans;">是一个快速的方法产生应用程序的一些主要的部分。</span></em>If you want to create the models, views, and controllers for a new resource in a single operation, scaffolding is the tool for the job.<span style="font-family: DejaVu Sans;">如果你想使用一种简单的操作为新资源创建</span>models,views<span style="font-family: DejaVu Sans;">和</span>controllers<span style="font-family: DejaVu Sans;">，</span>Scaffolding<span style="font-family: DejaVu Sans;">是一个不错的工具。</span></p>

<h3><a name="creating-a-resource"></a>6 Creating a Resource<span style="font-family: WenQuanYi Micro Hei;">创建一个资源</span></h3>


<p>In the case of the blog application, you can start by generating a scaffolded Post resource: this will represent#<span style="font-family: DejaVu Sans;">代表，表现表示</span>a single blog posting. To do this, enter this command in your terminal:<span style="font-family: DejaVu Sans;">在本示例中的</span>blog<span style="font-family: DejaVu Sans;">应用程序，你可以使用</span>scaffolded<span style="font-family: DejaVu Sans;">产生</span>post<span style="font-family: DejaVu Sans;">资源：它表现为一个简单的</span>blog posting<span style="font-family: DejaVu Sans;">。要完成这些，在终端输入如下命令：</span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>scaffold</code><code> </code><code>Post</code><code> </code><code>name:string</code><code> </code><code>title:string</code><code> </code><code>content:text</code></p>

<h2>rails 2.3.1 script/generate scaffold Post name:string title:string content:text</h2>

<p>The scaffold generator will build several files in your application, along with some folders, and edit <tt>config/routes.rb</tt>. Here’s a quick overview of what it creates:scaffold<span style="font-family: DejaVu Sans;">创建器将会在应用程序中的一些文件夹中生成一些文件，并且还会编辑</span><tt>config/routes.rb</tt><span style="font-family: DejaVu Sans;"><tt>。下面这些产生的文件的大概说明：</tt></span></p>

<table width="665" cellspacing="0" cellpadding="2"><colgroup> <col width="231" /> <col width="426" /> </colgroup>
<tbody>
<tr>
<th width="231">File</th>
<th width="426">Purpose</th>
</tr>
<tr>
<td width="231">db/migrate/20100207214725_create_posts.rb</td>
<td width="426">Migration to create the posts table in your database (your name will include a different timestamp)<span style="font-family: DejaVu Sans;">将创建的</span>posts<span style="font-family: DejaVu Sans;">表单迁移到你的数据库（会在你的命名前面加上时间）</span></td>
</tr>
<tr>
<td width="231">app/models/post.rb</td>
<td width="426">The Post model Post<span style="font-family: DejaVu Sans;">模型</span></td>
</tr>
<tr>
<td width="231">test/fixtures/posts.yml</td>
<td width="426">Dummy posts for use in testing <span style="font-family: DejaVu Sans;">模拟测试</span>post</td>
</tr>
<tr>
<td width="231">app/controllers/posts_controller.rb</td>
<td width="426">The Posts controller</td>
</tr>
<tr>
<td width="231">app/views/posts/index.html.erb</td>
<td width="426">A view to display an index of all posts <span style="font-family: DejaVu Sans;">显示所有</span>post</td>
</tr>
<tr>
<td width="231">app/views/posts/edit.html.erb</td>
<td width="426">A view to edit an existing post<span style="font-family: DejaVu Sans;">编辑</span>post</td>
</tr>
<tr>
<td width="231">app/views/posts/show.html.erb</td>
<td width="426">A view to display a single post<span style="font-family: DejaVu Sans;">显示一条</span>post</td>
</tr>
<tr>
<td width="231">app/views/posts/new.html.erb</td>
<td width="426">A view to create a new post<span style="font-family: DejaVu Sans;">创建</span>post</td>
</tr>
<tr>
<td width="231">app/views/posts/_form.html.erb</td>
<td width="426">A partial to control the overall look and feel of the form used in edit and new views<span style="font-family: DejaVu Sans;">一个用于控制编辑和创建新视图的整体视效表</span></td>
</tr>
<tr>
<td width="231">app/helpers/posts_helper.rb</td>
<td width="426">Helper functions to be used from the post views<span style="font-family: DejaVu Sans;">使用</span>post<span style="font-family: DejaVu Sans;">的帮助功能</span>views</td>
</tr>
<tr>
<td width="231">app/assets/stylesheets/scaffolds.css.scss</td>
<td width="426">Cascading style sheet#<span style="font-family: DejaVu Sans;">层叠样式</span>to make the scaffolded views look better #css<span style="font-family: DejaVu Sans;">使</span>scaffolded<span style="font-family: DejaVu Sans;">视图具有更好的效果</span></td>
</tr>
<tr>
<td width="231">app/assets/stylesheets/posts.css.scss</td>
<td width="426">Cascading style sheet for the posts controller#post controller<span style="font-family: DejaVu Sans;">的</span>css<span style="font-family: DejaVu Sans;">效果</span></td>
</tr>
<tr>
<td width="231">app/assets/javascripts/posts.js.coffee</td>
<td width="426">CoffeeScript for the posts controller</td>
</tr>
<tr>
<td width="231">test/unit/post_test.rb</td>
<td width="426">Unit testing harness#<span style="font-family: DejaVu Sans;">利用</span>for the posts model post models<span style="font-family: DejaVu Sans;">的</span>Unit<span style="font-family: DejaVu Sans;">测试</span></td>
</tr>
<tr>
<td width="231">test/functional/posts_controller_test.rb</td>
<td width="426">Functional testing harness for the posts controller post controller<span style="font-family: DejaVu Sans;">的功能测试</span></td>
</tr>
<tr>
<td width="231">test/unit/helpers/posts_helper_test.rb</td>
<td width="426">Unit testing harness for the posts helper post helper<span style="font-family: DejaVu Sans;">的</span>Uint <span style="font-family: DejaVu Sans;">测试</span></td>
</tr>
<tr>
<td width="231">config/routes.rb</td>
<td width="426">Edited to include routing information for posts <span style="font-family: DejaVu Sans;">加入</span>posts <span style="font-family: DejaVu Sans;">路由信息</span></td>
</tr>
</tbody>
</table>


<p><tt>While</tt><tt> </tt><tt>scaffolding</tt><tt> </tt><tt>will</tt><tt> </tt><tt>get</tt><tt> </tt><tt>you</tt><tt> </tt><tt>up</tt><tt> </tt><tt>and</tt><tt> </tt><tt>running</tt><tt> </tt><tt>quickly,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>code</tt><tt> </tt><tt>it</tt><tt> </tt><tt>generates</tt><tt> </tt><tt>is</tt><tt> </tt><tt>unlikely</tt><tt> </tt><tt>to</tt><tt> </tt><tt>be</tt><tt> </tt><tt>a</tt><tt> </tt><tt>perfect</tt><tt> </tt><tt>fit</tt><tt> </tt><tt>for</tt><tt> </tt><tt>your</tt><tt> </tt><tt>application.</tt><span style="font-family: DejaVu Sans;"><tt>即便是</tt></span><tt>scaffolding</tt><span style="font-family: DejaVu Sans;"><tt>使你创建和运行非常快捷，但是产生的代码不可能完美的适合你的应用程序。</tt><tt></tt></span><tt>You</tt><tt>’</tt><tt>ll</tt><tt> </tt><tt>most</tt><tt> </tt><tt>probably</tt><tt> </tt><tt>want</tt><tt> </tt><tt>to</tt><tt> </tt><tt>customize</tt><tt> </tt><tt>the</tt><tt> </tt><tt>generated</tt><tt> </tt><tt>code.</tt><span style="font-family: DejaVu Sans;"><tt>你大多数都需要定制产生的代码。</tt><tt></tt></span><tt>Many</tt><tt> </tt><tt>experienced</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>developers</tt><tt> </tt><tt>avoid</tt><tt> </tt><tt>scaffolding</tt><tt> </tt><tt>entirely,</tt><tt> </tt><tt>preferring</tt><tt> </tt><tt>to</tt><tt> </tt><tt>write</tt><tt> </tt><tt>all</tt><tt> </tt><tt>or</tt><tt> </tt><tt>most</tt><tt> </tt><tt>of</tt><tt> </tt><tt>their</tt><tt> </tt><tt>source</tt><tt> </tt><tt>code</tt><tt> </tt><tt>from</tt><tt> </tt><tt>scratch.</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>很多有经验的</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>开发人员完全不使用</tt></span><tt>scaffolding</tt><span style="font-family: DejaVu Sans;"><tt>，宁愿从头编写全部的代码。</tt></span><tt>Rails,</tt><tt> </tt><tt>however,</tt><tt> </tt><tt>makes</tt><tt> </tt><tt>it</tt><tt> </tt><tt>really</tt><tt> </tt><tt>simple</tt><tt> </tt><tt>to</tt><tt> </tt><tt>customize</tt><tt> </tt><tt>templates</tt><tt> </tt><tt>for</tt><tt> </tt><tt>generated</tt><tt> </tt><tt>models,</tt><tt> </tt><tt>controllers,</tt><tt> </tt><tt>views</tt><tt> </tt><tt>and</tt><tt> </tt><tt>other</tt><tt> </tt><tt>source</tt><tt> </tt><tt>files.Rails</tt><span style="font-family: DejaVu Sans;"><tt>，无论如何，使得为生成的</tt></span><tt>models</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>controllers</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>views</tt><span style="font-family: DejaVu Sans;"><tt>或者其他代码编定制模板非常简单。</tt><tt></tt></span><tt>You</tt><tt>’</tt><tt>ll</tt><tt> </tt><tt>find</tt><tt> </tt><tt>more</tt><tt> </tt><tt>information</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><a href="http://guides.rubyonrails.org/generators.html"><span style="color: #000080;"><span style="text-decoration: underline;">Creating</span></span><span style="color: #000080;"><span style="text-decoration: underline;">and</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Customizing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Generators</span></span><span style="color: #000080;"><span style="text-decoration: underline;">&amp;</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Templates</span></span></a><tt> </tt><tt>guide.</tt><span style="font-family: DejaVu Sans;"><tt>你可以在</tt><tt></tt></span><a href="http://guides.rubyonrails.org/generators.html"><span style="color: #000080;"><span style="text-decoration: underline;">Creating</span></span><span style="color: #000080;"><span style="text-decoration: underline;">and</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Customizing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Generators</span></span><span style="color: #000080;"><span style="text-decoration: underline;">&amp;</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Templates</span></span></a><span style="font-family: DejaVu Sans;"><tt>看到更多信息。</tt></span></p>

<h4><a name="running-a-migration"></a><tt>6.1</tt><tt> </tt><tt>Running</tt><tt> </tt><tt>a</tt><tt> </tt><tt>Migration</tt></h4>


<p>One of the products of the <tt>rails</tt><tt> </tt><tt>generate</tt><tt> </tt><tt>scaffold</tt> command is a <em>database</em><em> </em><em>migration</em>. Migrations are Ruby classes that are designed to make it simple to create and modify database tables. Rails uses rake commands to run migrations, and it’s possible to undo a migration after it’s been applied to your database. Migration filenames include a timestamp to ensure that they’re processed#<span style="font-family: DejaVu Sans;">处理</span>in the order that they were created.script/generate scaffold<span style="font-family: DejaVu Sans;">的一个产品就是数据迁移。</span>Migrations<span style="font-family: DejaVu Sans;">是一个</span>ruby<span style="font-family: DejaVu Sans;">类被设计用来使数据库表单的创建和修改变得简单。</span>Rails<span style="font-family: DejaVu Sans;">使用</span>rake<span style="font-family: DejaVu Sans;">命令来执行迁移，它还可以撤销已经应用的修改。</span>Migration filenames include a timestamp<span style="font-family: DejaVu Sans;">确保了迁移能够完成。</span></p>

<p>If you look in the <tt>db/migrate/20100207214725_create_posts.rb</tt> file (remember, yours will have a slightly different name<span style="font-family: DejaVu Sans;">记住，你得到的可能会有略微不同</span>), here’s what you’ll find:</p>

<p><code>class</code><tt> </tt><code>CreatePosts</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Migration</code></p>

<p><code> </code><code>def</code> <code>change</code></p>

<p><code> </code><code>create_table</code><code> </code><code>:posts</code> <code>do</code> <code>|t|</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:name</code></p>

<p><code> </code><code>t.string</code><code> </code><code>:title</code></p>

<p><code> </code><code>t.text</code><code> </code><code>:content</code></p>

<p>&nbsp;</p>

<p><code> </code><code>t.timestamps</code></p>

<p><code> </code><code>end</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><tt>The</tt><tt> </tt><tt>above</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>creates</tt><tt> </tt><tt>a</tt><tt> </tt><tt>method</tt><tt> </tt><tt>name</tt><tt> </tt><tt>change</tt><tt> </tt><tt>which</tt><tt> </tt><tt>will</tt><tt> </tt><tt>be</tt><tt> </tt><tt>called</tt><tt> </tt><tt>when</tt><tt> </tt><tt>you</tt><tt> </tt><tt>run</tt><tt> </tt><tt>this</tt><tt> </tt><tt>migration.</tt><span style="font-family: DejaVu Sans;"><tt>整个</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>创建了一个名叫</tt></span><tt>change</tt><span style="font-family: DejaVu Sans;"><tt>的方法，该方法在你运行这个</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>的时候被调用。</tt><tt></tt></span><tt>The</tt><tt> </tt><tt>action</tt><tt> </tt><tt>defined</tt><tt> </tt><tt>in</tt><tt> </tt><tt>that</tt><tt> </tt><tt>method</tt><tt> </tt><tt>is</tt><tt> </tt><tt>also</tt><tt> </tt><tt>reversible#</tt><span style="font-family: DejaVu Sans;"><tt>可逆</tt></span><tt>,</tt><tt> </tt><tt>which</tt><tt> </tt><tt>means</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>knows</tt><tt> </tt><tt>how</tt><tt> </tt><tt>to</tt><tt> </tt><tt>reverse</tt><tt> </tt><tt>the</tt><tt> </tt><tt>change</tt><tt> </tt><tt>made</tt><tt> </tt><tt>by</tt><tt> </tt><tt>this</tt><tt> </tt><tt>migration,</tt><tt> </tt><tt>in</tt><tt> </tt><tt>case</tt><tt> </tt><tt>you</tt><tt> </tt><tt>want</tt><tt> </tt><tt>to</tt><tt> </tt><tt>reverse</tt><tt> </tt><tt>it</tt><tt> </tt><tt>at</tt><tt> </tt><tt>later</tt><tt> </tt><tt>date.</tt><span style="font-family: DejaVu Sans;"><tt>这个方法中定义的行为也是可逆的，那就是说</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>知道怎样逆向改变这个</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>，如果你需要恢复到上一次数据。</tt><tt></tt></span><tt>By</tt><tt> </tt><tt>default,</tt><tt> </tt><tt>when</tt><tt> </tt><tt>you</tt><tt> </tt><tt>run</tt><tt> </tt><tt>this</tt><tt> </tt><tt>migration</tt><tt> </tt><tt>it</tt><tt> </tt><tt>will</tt><tt> </tt><tt>creates</tt><tt> </tt><tt>a</tt><tt> </tt><tt>posts</tt><tt> </tt><tt>table</tt><tt> </tt><tt>with</tt><tt> </tt><tt>two</tt><tt> </tt><tt>string</tt><tt> </tt><tt>columns</tt><tt> </tt><tt>and</tt><tt> </tt><tt>a</tt><tt> </tt><tt>text</tt><tt> </tt><tt>column.</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>默认情况下，当你运行这个</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>，他将会创建一个包含两个字符串列和一个</tt></span><tt>text</tt><span style="font-family: DejaVu Sans;"><tt>列的表单。</tt></span><tt>It</tt><tt> </tt><tt>also</tt><tt> </tt><tt>creates</tt><tt> </tt><tt>two</tt><tt> </tt><tt>timestamp</tt><tt> </tt><tt>fields</tt><tt> </tt><tt>to</tt><tt> </tt><tt>track</tt><tt> </tt><tt>record</tt><tt> </tt><tt>creation</tt><tt> </tt><tt>and</tt><tt> </tt><tt>updating.</tt><tt> </tt><tt>More</tt><tt> </tt><tt>information</tt><tt> </tt><tt>about</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>migrations</tt><tt> </tt><tt>can</tt><tt> </tt><tt>be</tt><tt> </tt><tt>found</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><a href="http://guides.rubyonrails.org/migrations.html"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Database</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Migrations</span></span></a><tt> </tt><tt>guide.</tt><span style="font-family: DejaVu Sans;"><tt>关于</tt></span><tt>Rails</tt><tt> </tt><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>的更多信息请阅读</tt><tt></tt></span><a href="http://guides.rubyonrails.org/migrations.html"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Database</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Migrations</span></span></a><span style="font-family: DejaVu Sans;"><tt>手册。</tt></span></p>

<p><tt>At</tt><tt> </tt><tt>this</tt><tt> </tt><tt>point,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>use</tt><tt> </tt><tt>a</tt><tt> </tt><tt>rake</tt><tt> </tt><tt>command</tt><tt> </tt><tt>to</tt><tt> </tt><tt>run</tt><tt> </tt><tt>the</tt><tt> </tt><tt>migration:</tt><span style="font-family: DejaVu Sans;"><tt>这个时候，你可以使用</tt></span><tt>rake</tt><span style="font-family: DejaVu Sans;"><tt>命令运行</tt></span><tt>migration</tt><span style="font-family: DejaVu Sans;"><tt>了：</tt></span></p>

<p><code>rake</code><code> </code><code>db:migrate</code></p>

<p><code>Rails</code><code> </code><code>will</code><code> </code><code>execute</code><code> </code><code>this</code><code> </code><code>migration</code><code> </code><code>command</code><code> </code><code>and</code><code> </code><code>tell</code><code> </code><code>you</code><code> </code><code>it</code><code> </code><code>created</code><code> </code><code>the</code><code> </code><code>Posts</code><code> </code><code>table.Rails</code><span style="font-family: DejaVu Sans;"><code>将会执行这个</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>命令并且通知你它创建了</code></span><code>Post</code><span style="font-family: DejaVu Sans;"><code>表单。</code></span></p>

<p><code>==</code><code> </code><code>CreatePosts:</code><code> </code><code>migrating</code><code> </code><code>====================================================</code></p>

<p><code>&mdash;</code><code> </code><code>create_table(:posts)</code></p>

<p><code> </code><code>&ndash;&gt;</code><code> </code><code>0.0030s</code></p>

<p><code>==</code><code> </code><code>CreatePosts:</code><code> </code><code>migrated</code><code> </code><code>(0.0032s)</code><code> </code><code>===========================================</code></p>

<p><code>Because</code><code> </code><code>you</code><code>’</code><code>re</code><code> </code><code>working</code><code> </code><code>in</code><code> </code><code>the</code><code> </code><code>development</code><code> </code><code>environment</code><code> </code><code>by</code><code> </code><code>default,</code><code> </code><code>this</code><code> </code><code>command</code><code> </code><code>will</code><code> </code><code>apply</code><code> </code><code>to</code><code> </code><code>the</code><code> </code><code>database</code><code> </code><code>defined</code><code> </code><code>in</code><code> </code><code>the</code><code> </code><tt>development</tt><code> </code><code>section</code><code> </code><code>of</code><code> </code><code>your</code><code> </code><tt>config/database.yml</tt><code> </code><code>file.</code><code> </code><code>If</code><code> </code><code>you</code><code> </code><code>would</code><code> </code><code>like</code><code> </code><code>to</code><code> </code><code>execute</code><code> </code><code>migrations</code><code> </code><code>in</code><code> </code><code>other</code><code> </code><code>environment,</code><code> </code><code>for</code><code> </code><code>instance</code><code> </code><code>in</code><code> </code><code>production,</code><code> </code><code>you</code><code> </code><code>must</code><code> </code><code>explicitly</code><code> </code><code>pass</code><code> </code><code>it</code><code> </code><code>when</code><code> </code><code>invoking</code><code> </code><code>the</code><code> </code><code>command:</code><code> </code><tt>rake</tt><tt> </tt><tt>db:migrate</tt><tt> </tt><tt>RAILS_ENV=production</tt><code>.</code><span style="font-family: DejaVu Sans;"><code>由于你默认工作在开发环境中，这个命令将会应用于开发环境会话的数据库位于你的</code></span><tt>config/database.yml</tt><tt> </tt><span style="font-family: DejaVu Sans;"><code>中。如果你想执行</code></span><code>migration</code><span style="font-family: DejaVu Sans;"><code>在其他环境中，比如以产品（环境）为实例，你必须明确调用的通过命令行中执行：</code></span><code>rake</code><code> </code><code>db:migrate</code><code> </code><code>RAILS_ENV=production</code><span style="font-family: DejaVu Sans;"><code>。</code></span></p>

<h4><a name="adding-a-link"></a><code>6.2</code><code> </code><code>Adding</code><code> </code><code>a</code><code> </code><code>Link</code><span style="font-family: WenQuanYi Micro Hei;"><code>添加要给</code></span><code>link</code><span style="font-family: WenQuanYi Micro Hei;"><code>（到</code></span><code>blog</code><span style="font-family: WenQuanYi Micro Hei;"><code>）</code></span></h4>


<p>To hook the posts up to the home page you’ve already created, you can add a link to the home page.<span style="font-family: DejaVu Sans;">把你已经创建好的</span>post<span style="font-family: DejaVu Sans;">挂到主页上，你可以通过添加一个</span>link<span style="font-family: DejaVu Sans;">到主页。</span>Open <tt>app/views/home/index.html.erb</tt> and modify it as follows:<span style="font-family: DejaVu Sans;">打开</span><tt>app/views/home/index.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>并且按照下面所示更改：</tt></span></p>

<p><code>&lt;h1&gt;Hello,</code><code> </code><code>Rails!&lt;/h1&gt;</code></p>

<p><code>&lt;%=</code><code> </code><code>link_to</code><code> </code><code>&ldquo;My</code><code> </code><code>Blog&rdquo;,</code><code> </code><code>posts_path</code><code> </code><code>%&gt;</code></p>

<p><tt>The</tt><tt> </tt><tt>link_to</tt><tt> </tt><tt>method</tt><tt> </tt><tt>is</tt><tt> </tt><tt>one</tt><tt> </tt><tt>of</tt><tt> </tt><tt>Rails</tt><tt>’ </tt><tt>built-in</tt><tt> </tt><tt>view</tt><tt> </tt><tt>helpers.</tt><span style="font-family: DejaVu Sans;"><tt>这个链接方法是</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>在</tt><tt></tt></span><tt>view</tt><tt> </tt><tt>helpers</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>的内建方法之一</tt><tt></tt><tt>。</tt></span><tt>It</tt><tt> </tt><tt>creates</tt><tt> </tt><tt>a</tt><tt> </tt><tt>hyperlink</tt><tt> </tt><tt>based</tt><tt> </tt><tt>on</tt><tt> </tt><tt>text</tt><tt> </tt><tt>to</tt><tt> </tt><tt>display</tt><tt> </tt><tt>and</tt><tt> </tt><tt>where</tt><tt> </tt><tt>to</tt><tt> </tt><tt>go</tt><tt> – </tt><tt>in</tt><tt> </tt><tt>this</tt><tt> </tt><tt>case,</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>path</tt><tt> </tt><tt>for</tt><tt> </tt><tt>posts.</tt><span style="font-family: DejaVu Sans;"><tt>它创建一个基于文字的超级链接并显示到哪里，在这个实例中（跳转）到</tt></span><tt>posts</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="working-with-posts-in-the-browser"></a><tt>6.3</tt><tt> </tt><tt>Working</tt><tt> </tt><tt>with</tt><tt> </tt><tt>Posts</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>Browser</tt></h4>


<p>Now you’re ready to start working with posts. To do that, navigate to <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/"><a href="http://localhost:3000">http://localhost:3000</a></a></span></span> and then click the “My Blog” link:<span style="font-family: DejaVu Sans;">现在你已经准备好在</span>posts<span style="font-family: DejaVu Sans;">中工作了。导航至</span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/"><a href="http://localhost:3000">http://localhost:3000</a></a></span></span><span style="font-family: DejaVu Sans;">，并且点击<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>My Blog”<span style="font-family: DejaVu Sans;">链接。</span></p>

<p><code>This</code><code> </code><code>is</code><code> </code><code>the</code><code> </code><code>result</code><code> </code><code>of</code><code> </code><code>Rails</code><code> </code><code>rendering</code><code> </code><code>the</code><code> </code><tt>index</tt><code> </code><code>view</code><code> </code><code>of</code><code> </code><code>your</code><code> </code><code>posts.</code><span style="font-family: DejaVu Sans;"><code>这就是</code></span><code>Rails</code><span style="font-family: DejaVu Sans;"><code>渲染你的</code></span><code>posts</code><span style="font-family: DejaVu Sans;"><code>视图的结果。</code><code></code></span><code>There</code><code> </code><code>aren</code><code>’</code><code>t</code><code> </code><code>currently</code><code> </code><code>any</code><code> </code><code>posts</code><code> </code><code>in</code><code> </code><code>the</code><code> </code><code>database,</code><code> </code><code>but</code><code> </code><code>if</code><code> </code><code>you</code><code> </code><code>click</code><code> </code><code>the</code><code> </code><tt>New</tt><tt> </tt><tt>Post</tt><code> </code><code>link</code><code> </code><code>you</code><code> </code><code>can</code><code> </code><code>create</code><code> </code><code>one.</code><span style="font-family: DejaVu Sans;"><code>在你点击</code><code><span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></code></span><code>New</code><code> </code><code>Post</code><code>”</code><span style="font-family: DejaVu Sans;"><code>链接并创建一个新的</code></span><code>post</code><span style="font-family: DejaVu Sans;"><code>之前，数据库里面是没有任何</code></span><code>post</code><span style="font-family: DejaVu Sans;"><code>的。</code><code></code></span><code>After</code><code> </code><code>that,</code><code> </code><code>you</code><code>’</code><code>ll</code><code> </code><code>find</code><code> </code><code>that</code><code> </code><code>you</code><code> </code><code>can</code><code> </code><code>edit</code><code> </code><code>posts,</code><code> </code><code>look</code><code> </code><code>at</code><code> </code><code>their</code><code> </code><code>details,</code><code> </code><code>or</code><code> </code><code>destroy</code><code> </code><code>them.</code><code> </code><span style="font-family: DejaVu Sans;"><code>随后你可以编辑，查看详细内容，或者删除他们。</code></span><code>All</code><code> </code><code>of</code><code> </code><code>the</code><code> </code><code>logic</code><code> </code><code>and</code><code> </code><code>HTML</code><code> </code><code>to</code><code> </code><code>handle</code><code> </code><code>this</code><code> </code><code>was</code><code> </code><code>built</code><code> </code><code>by</code><code> </code><code>the</code><code> </code><code>single</code><code> </code><tt>rails</tt><tt> </tt><tt>generate</tt><tt> </tt><tt>scaffold</tt><code> </code><code>command.post</code><span style="font-family: DejaVu Sans;"><code>的所有的</code></span><code>logic</code><span style="font-family: DejaVu Sans;"><code>和</code></span><code>HTML</code><span style="font-family: DejaVu Sans;"><code>都是通过</code></span><tt><em>rails</em></tt><tt><em> </em></tt><tt><em>generate</em></tt><tt><em> </em></tt><tt><em>scaffold</em></tt><tt><em> </em></tt><span style="font-family: DejaVu Sans;"><code>生成的。</code></span></p>

<p><code>In</code><code> </code><code>development</code><code> </code><code>mode</code><code> </code><code>(which</code><code> </code><code>is</code><code> </code><code>what</code><code> </code><code>you</code><code>’</code><code>re</code><code> </code><code>working</code><code> </code><code>in</code><code> </code><code>by</code><code> </code><code>default),</code><code> </code><code>Rails</code><code> </code><code>reloads</code><code> </code><code>your</code><code> </code><code>application</code><code> </code><code>with</code><code> </code><code>every</code><code> </code><code>browser</code><code> </code><code>request,</code><code> </code><code>so</code><code> </code><code>there</code><code>’</code><code>s</code><code> </code><code>no</code><code> </code><code>need</code><code> </code><code>to</code><code> </code><code>stop</code><code> </code><code>and</code><code> </code><code>restart</code><code> </code><code>the</code><code> </code><code>web</code><code> </code><code>server.</code><span style="font-family: DejaVu Sans;"><code>在开发模式中（你的默认工作模式），</code></span><code>Rails</code><span style="font-family: DejaVu Sans;"><code>会在每个浏览器请求的时候重新载入你的应用程序，因此你不需要停止或者重启</code></span><code>web</code><span style="font-family: DejaVu Sans;"><code>服务。</code></span></p>

<p><code>Congratulations,</code><code> </code><code>you</code><code>’</code><code>re</code><code> </code><code>riding</code><code> </code><code>the</code><code> </code><code>rails!</code><code> </code><code>Now</code><code> </code><code>it</code><code>’</code><code>s</code><code> </code><code>time</code><code> </code><code>to</code><code> </code><code>see</code><code> </code><code>how</code><code> </code><code>it</code><code> </code><code>all</code><code> </code><code>works.</code><span style="font-family: DejaVu Sans;"><code>恭喜，你已经驯服了</code></span><code>rails</code><span style="font-family: DejaVu Sans;"><code>！现在是时候去看看它的所有工作了。</code></span></p>

<h4><a name="the-model"></a><code>6.4</code><code> </code><code>The</code><code> </code><code>Model</code></h4>


<p>The model file, <tt>app/models/post.rb</tt> is about as simple as it can get:</p>

<p><code>class</code><code> </code><code>Post</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code>end</code></p>

<p><code>There</code><code> </code><code>isn</code><code>’</code><code>t</code><code> </code><code>much</code><code> </code><code>to</code><code> </code><code>this</code><code> </code><code>file</code><code> – </code><code>but</code><code> </code><code>note</code><code> </code><code>that</code><code> </code><code>the</code><code> </code><tt>Post</tt><code> </code><code>class</code><code> </code><code>inherits</code><code> </code><code>from</code><code> </code><tt>ActiveRecord::Base</tt><code>.</code><span style="font-family: DejaVu Sans;"><code>这里有可能不一致</code><code><span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></code><code>但是切记</code></span><code>Post</code><span style="font-family: DejaVu Sans;"><code>类继承于</code><code></code></span><tt>ActiveRecord::Base</tt><span style="font-family: DejaVu Sans;"><tt>。</tt><code></code></span><code>Active</code><code> </code><code>Record</code><code> </code><code>supplies</code><code> </code><code>a</code><code> </code><code>great</code><code> </code><code>deal</code><code> </code><code>of</code><code> </code><code>functionality</code><code> </code><code>to</code><code> </code><code>your</code><code> </code><code>Rails</code><code> </code><code>models</code><code> </code><code>for</code><code> </code><code>free,</code><code> </code><code>including</code><code> </code><code>basic</code><code> </code><code>database</code><code> </code><code>CRUD</code><code> </code><code>(Create,</code><code> </code><code>Read,</code><code> </code><code>Update,</code><code> </code><code>Destroy)</code><code> </code><code>operations,</code><code> </code><code>data</code><code> </code><code>validation,</code><code> </code><code>as</code><code> </code><code>well</code><code> </code><code>as</code><code> </code><code>sophisticated#</code><span style="font-family: DejaVu Sans;"><code>复杂</code><code></code></span><code>search</code><code> </code><code>support</code><code> </code><code>and</code><code> </code><code>the</code><code> </code><code>ability</code><code> </code><code>to</code><code> </code><code>relate</code><code> </code><code>multiple</code><code> </code><code>models</code><code> </code><code>to</code><code> </code><code>one</code><code> </code><code>another.</code><code> </code><code>Active</code><code> </code><code>Record</code><span style="font-family: DejaVu Sans;"><code>免费为你的</code></span><code>models</code><span style="font-family: DejaVu Sans;"><code>提供了强大的功能，包括基本数据库的</code></span><code>CRUD</code><span style="font-family: DejaVu Sans;"><code>（创建，读取，更新，删除）操作，数据验证，以及复杂的的查询与其它数据表单多关联的字段的支持能力。</code></span></p>

<h4><a name="adding-some-validation"></a><code>6.5</code><code> </code><code>Adding</code><code> </code><code>Some</code><code> </code><code>Validation</code><span style="font-family: WenQuanYi Micro Hei;"><code>添加一些验证</code></span></h4>


<p>Rails includes methods to help you validate the data that you send to models. Rails<span style="font-family: DejaVu Sans;">包含一些帮助你验证发送到</span>models<span style="font-family: DejaVu Sans;">的数据的方法。</span>Open the <tt>app/models/post.rb</tt> file and edit it:<span style="font-family: DejaVu Sans;">打开</span><tt>app/models/post.rb</tt><span style="font-family: DejaVu Sans;"><tt>并编辑：</tt></span></p>

<p>class Post &lt; ActiveRecord::Base</p>

<p>validates :name, :presence =&gt; true</p>

<p>validates :title, :presence =&gt; true,</p>

<p>:length =&gt; { :minimum =&gt; 5 }</p>

<p>end</p>

<p>These changes will ensure that all posts have a name and a title, and that the title is at least five characters long. <span style="font-family: DejaVu Sans;">这些更改会确保所有的</span>post<span style="font-family: DejaVu Sans;">都有一个</span>name<span style="font-family: DejaVu Sans;">和</span>titile<span style="font-family: DejaVu Sans;">并且</span>title<span style="font-family: DejaVu Sans;">长度至少五个字符。</span>Rails can validate a variety of<span style="font-family: DejaVu Sans;">各种，很多</span>conditions#<span style="font-family: DejaVu Sans;">名词（字段）</span>in a model, including the presence or uniqueness<span style="font-family: DejaVu Sans;">独特</span>of columns, their format, and the existence of associated<span style="font-family: DejaVu Sans;">相关</span>objects. Rails<span style="font-family: DejaVu Sans;">可以验证很多种字段，比如字段能否为空和独特性，字段的格式，以及字段的关联。</span></p>

<h4><a name="using-the-console"></a>6.6 Using the Console</h4>


<p>To see your validations in action, you can use the console.<span style="font-family: DejaVu Sans;">要想在</span>action<span style="font-family: DejaVu Sans;">里面查看你的验证你可以使用</span>console<span style="font-family: DejaVu Sans;">。</span>The console is a command-line tool that lets you execute#<span style="font-family: DejaVu Sans;">执行运行</span>Ruby code in the context of your application:console<span style="font-family: DejaVu Sans;">是一个可以让你在你的应用程序的上下文中执行</span>Ruby<span style="font-family: DejaVu Sans;">代码的命令行工具：</span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>console</code></p>

<p><code>The</code><code> </code><code>default</code><code> </code><code>console</code><code> </code><code>will</code><code> </code><code>make</code><code> </code><code>changes</code><code> </code><code>to</code><code> </code><code>your</code><code> </code><code>database.</code><span style="font-family: DejaVu Sans;"><code>默认的</code></span><code>console</code><span style="font-family: DejaVu Sans;"><code>将会改变你的数据库。</code><code></code></span><code>You</code><code> </code><code>can</code><code> </code><code>instead</code><code> </code><code>open</code><code> </code><code>a</code><code> </code><code>console</code><code> </code><code>that</code><code> </code><code>will</code><code> </code><code>roll</code><code> </code><code>back</code><code> </code><code>any</code><code> </code><code>changes</code><code> </code><code>you</code><code> </code><code>make</code><code> </code><code>by</code><code> </code><code>using</code><code> </code>rails console &mdash;sandbox<code>.</code><span style="font-family: DejaVu Sans;"><code>你可以通过运行</code></span><code>rails</code><code> </code><code>console</code><code> –</code><code>sandbox</code><code> </code><code>or</code><code> </code><code>rails</code><code> </code><code>console</code><code> </code><code>-s,</code><span style="font-family: DejaVu Sans;"><code>这样你可以回滚你的任何操作。</code></span></p>

<p>jhjguxin@jhjguxin-Aspire-4750:~/blog$ rails console -s</p>

<p>Loading development environment in sandbox (Rails 3.1.1)</p>

<p>Any modifications you make will be rolled back on exit</p>

<p>irb(main):001:0&gt; p=Post.new(:content=&gt;&ldquo;A new post to test console&rdquo;)</p>

<p>=&gt; #&lt;Post id: nil, name: nil, title: nil, content: &ldquo;A new post to test console&rdquo;, created_at: nil, updated_at: nil&gt;</p>

<p>irb(main):002:0&gt; p.save</p>

<p>(0.2ms) SAVEPOINT active_record_1</p>

<p>(0.1ms) ROLLBACK TO SAVEPOINT active_record_1</p>

<p>=&gt; false</p>

<p>irb(main):003:0&gt; p.errors</p>

<p>=&gt; #&lt;ActiveModel::Errors:0xb6765d48 @base=#&lt;Post id: nil, name: nil, title: nil, content: &ldquo;A new post to test console&rdquo;, created_at: nil, updated_at: nil&gt;, @messages=#&lt;OrderedHash {:title=&gt;[&ldquo;is too short (minimum is 5 characters)&rdquo;, &ldquo;can&rsquo;t be blank&rdquo;], :name=&gt;[&ldquo;can&rsquo;t be blank&rdquo;]}&gt;&gt;</p>

<p>This code shows creating a new <tt>Post</tt> instance, attempting to save it and getting <tt>false</tt> for a return value (indicating that the save failed), and inspecting the <tt>errors</tt> of the post.<span style="font-family: DejaVu Sans;">这段代码演示了创建一个</span>Post<span style="font-family: DejaVu Sans;">实例，并企图保存到数据库并得到一个失败的返回值（说明保存失败的原因），检查</span>post<span style="font-family: DejaVu Sans;">的错误信息。</span></p>

<p>When you’re finished, type <tt>exit</tt> and hit <tt>return</tt> to exit the console.<span style="font-family: DejaVu Sans;">当你操作完成，输入</span>exit<span style="font-family: DejaVu Sans;">并回车退出</span>console<span style="font-family: DejaVu Sans;">。</span></p>

<p>Unlike the development web server, the console does not automatically load your code afresh for each line.<span style="font-family: DejaVu Sans;">不像开发环境的</span>web<span style="font-family: DejaVu Sans;">服务器</span>console<span style="font-family: DejaVu Sans;">不会自动导入你每行输入的新的代码。</span>If you make changes to your models while the console is open, type <tt>reload!</tt> at the console prompt to load them.<span style="font-family: DejaVu Sans;">如果你改变了你的</span>moels<span style="font-family: DejaVu Sans;">并且</span>console<span style="font-family: DejaVu Sans;">是打开的，输入</span>reload!<span style="font-family: DejaVu Sans;">那么</span>console<span style="font-family: DejaVu Sans;">会立即导入他们。</span></p>

<p>jhjguxin@jhjguxin-Aspire-4750:~/blog$ rails console</p>

<p>Loading development environment (Rails 3.1.1)</p>

<p>irb(main):001:0&gt; p=Post.new(:title=&gt;&ldquo;test console&rdquo;,:name=&gt;&ldquo;jhjguxin&rdquo;,:content=&gt;&ldquo;A new post to test console&rdquo;)</p>

<p>=&gt; #&lt;Post id: nil, name: &ldquo;jhjguxin&rdquo;, title: &ldquo;test console&rdquo;, content: &ldquo;A new post to test console&rdquo;, created_at: nil, updated_at: nil&gt;</p>

<p>irb(main):002:0&gt; p.save</p>

<p>SQL (13.4ms) INSERT INTO &ldquo;posts&rdquo; (&ldquo;content&rdquo;, &ldquo;created_at&rdquo;, &ldquo;name&rdquo;, &ldquo;title&rdquo;, &ldquo;updated_at&rdquo;) VALUES (?, ?, ?, ?, ?) [[&ldquo;content&rdquo;, &ldquo;A new post to test console&rdquo;], [&ldquo;created_at&rdquo;, Sat, 05 Nov 2011 15:55:17 UTC +00:00], [&ldquo;name&rdquo;, &ldquo;jhjguxin&rdquo;], [&ldquo;title&rdquo;, &ldquo;test console&rdquo;], [&ldquo;updated_at&rdquo;, Sat, 05 Nov 2011 15:55:17 UTC +00:00]]</p>

<p>=&gt; true</p>

<p>irb(main):003:0&gt; reload!</p>

<p>Reloading&hellip;</p>

<p>=&gt; true</p>

<h6>###<span style="font-family: DejaVu Sans;">如果是</span>rails console &mdash;sandbox could not reload! Successfully.</h6>

<h4><a name="listing-all-posts"></a>6.7 Listing All Posts</h4>


<p>The easiest place to start looking at functionality is with the code that lists all posts. <span style="font-family: DejaVu Sans;">寻找所有功能的地方是使用代码列出所有的</span>post<span style="font-family: DejaVu Sans;">。</span>Open the file <tt>app/controllers/posts_controller.rb</tt> and look at the <tt>index</tt> action:<span style="font-family: DejaVu Sans;">打开文件</span><tt>app/controllers/posts_controller.rb</tt><span style="font-family: DejaVu Sans;"><tt>，并且查看</tt></span><tt>index</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><code>def</code> <code>index</code></p>

<p><code> </code><code>@posts</code> <code>=</code><code> </code><code>Post.all</code></p>

<p>&nbsp;</p>

<p><code> </code><code>respond_to</code><code> </code><code>do</code> <code>|format|</code></p>

<p><code> </code><code>format.html</code><code> </code><code>#</code><code> </code><code>index.html.erb</code></p>

<p><code> </code><code>format.json</code><code> </code><code>{</code><code> </code><code>render</code><code> </code><code>:json</code> <code>=&gt;</code><code> </code><code>@posts</code> <code>}</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p><tt>Post.all</tt> calls the <tt>Post</tt> model to return all of the posts currently in the database. Post.all<span style="font-family: DejaVu Sans;">调用</span>Post model<span style="font-family: DejaVu Sans;">并返回当前在数据库中的所有</span>post<span style="font-family: DejaVu Sans;">。</span>The result of this call is an array of posts that we store in an instance variable called <tt>@posts</tt>.<span style="font-family: DejaVu Sans;">本次调用的结果是一个</span>post<span style="font-family: DejaVu Sans;">的数组，并且我们将这个数组存储在一个叫做</span>@posts<span style="font-family: DejaVu Sans;">的实例变量中。</span></p>

<p>For more information on finding records with Active Record, see <a href="http://guides.rubyonrails.org/active_record_querying.html"><span style="color: #000080;"><span style="text-decoration: underline;">Active</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Record</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Query</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Interface</span></span></a>.<span style="font-family: DejaVu Sans;">查找有关</span>Active Record<span style="font-family: DejaVu Sans;">更多的信息，可以查看</span><a href="http://guides.rubyonrails.org/active_record_querying.html"><span style="color: #000080;"><span style="text-decoration: underline;">Active</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Record</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Query</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Interface</span></span></a><span style="font-family: DejaVu Sans;">相关记录。</span></p>

<p>The <tt>respond_to</tt> block handles both HTML and JSON calls to this action.<span style="font-family: DejaVu Sans;">这个</span>respond_to<span style="font-family: DejaVu Sans;">块处理了这个动作的</span>HTML<span style="font-family: DejaVu Sans;">和</span>JSON<span style="font-family: DejaVu Sans;">请求。</span>If you browse to <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/posts.json"><a href="http://localhost:3000/posts.json">http://localhost:3000/posts.json</a></a></span></span>, you’ll see a JSON containing all of the posts.<span style="font-family: DejaVu Sans;">如果你浏览</span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/posts.json"><a href="http://localhost:3000/posts.json">http://localhost:3000/posts.json</a></a></span></span><span style="font-family: DejaVu Sans;">，你将会看到一个</span>JSON<span style="font-family: DejaVu Sans;">包含着所有的</span>post<span style="font-family: DejaVu Sans;">。</span>The HTML format looks for a view in <tt>app/views/posts/</tt> with a name that corresponds to the action name. <span style="font-family: DejaVu Sans;">这个</span>HTML<span style="font-family: DejaVu Sans;">格式在</span><tt>app/views/posts/</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span>view<span style="font-family: DejaVu Sans;">中查找相对应的动作名称。</span>Rails makes all of the instance variables from the action available to the view.Rails<span style="font-family: DejaVu Sans;">使来自</span>action<span style="font-family: DejaVu Sans;">的所有的实例变量对应到（可用）</span>view<span style="font-family: DejaVu Sans;">。</span>Here’s <tt>app/views/posts/index.html.erb</tt>:</p>

<p><code>&lt;h1&gt;Listing</code><code> </code><code>posts&lt;/h1&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;table&gt;</code></p>

<p><code> </code><code>&lt;tr&gt;</code></p>

<p><code> </code><code>&lt;th&gt;Name&lt;/th&gt;</code></p>

<p><code> </code><code>&lt;th&gt;Title&lt;/th&gt;</code></p>

<p><code> </code><code>&lt;th&gt;Content&lt;/th&gt;</code></p>

<p><code> </code><code>&lt;th&gt;&lt;/th&gt;</code></p>

<p><code> </code><code>&lt;th&gt;&lt;/th&gt;</code></p>

<p><code> </code><code>&lt;th&gt;&lt;/th&gt;</code></p>

<p><code> </code><code>&lt;/tr&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;%</code> <code>@posts.each</code> <code>do</code> <code>|post|</code><code> </code><code>%&gt;</code></p>

<p><code> </code><code>&lt;tr&gt;</code></p>

<p><code> </code><code>&lt;td&gt;&lt;%=</code> <code>post.name</code><code> </code><code>%&gt;&lt;/td&gt;</code></p>

<p><code> </code><code>&lt;td&gt;&lt;%=</code> <code>post.title</code><code> </code><code>%&gt;&lt;/td&gt;</code></p>

<p><code> </code><code>&lt;td&gt;&lt;%=</code> <code>post.content</code><code> </code><code>%&gt;&lt;/td&gt;</code></p>

<p><code> </code><code>&lt;td&gt;&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Show&rsquo;,</code><code> </code><code>post</code><code> </code><code>%&gt;&lt;/td&gt;</code></p>

<p><code> </code><code>&lt;td&gt;&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Edit&rsquo;,</code><code> </code><code>edit_post_path(post)</code><code> </code><code>%&gt;&lt;/td&gt;</code></p>

<p><code> </code><code>&lt;td&gt;&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Destroy&rsquo;,</code><code> </code><code>post,</code><code> </code><code>:confirm</code> <code>=&gt;</code><code> </code><code>&lsquo;Are</code><code> </code><code>you</code><code> </code><code>sure?&rsquo;,</code><code> </code><code>:method</code> <code>=&gt;</code><code> </code><code>:delete</code> <code>%&gt;&lt;/td&gt;</code></p>

<p><code> </code><code>&lt;/tr&gt;</code></p>

<p><code>&lt;%</code> <code>end</code> <code>%&gt;</code></p>

<p><code>&lt;/table&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;br</code> <code>/&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;New</code><code> </code><code>post&rsquo;,</code><code> </code><code>new_post_path</code><code> </code><code>%&gt;</code></p>

<p>This view iterates#<span style="font-family: DejaVu Sans;">迭代</span>over the contents of the <tt>@posts</tt> array to display content and links.<span style="font-family: DejaVu Sans;">这个</span>view<span style="font-family: DejaVu Sans;">迭代</span>@posts<span style="font-family: DejaVu Sans;">数组所有的内容并显示相关的内容和链接。</span>A few things to note in the view:<span style="font-family: DejaVu Sans;">关于视图</span>note<span style="font-family: DejaVu Sans;">一些信息：</span></p>

<ul>
    <li><tt>link_to</tt> builds a hyperlink to a particular destination link_to<span style="font-family: DejaVu Sans;">创建一个超链接到一个地方</span></li>
    <li><tt>edit_post_path</tt> and <tt>new_post_path</tt> are helpers that Rails provides as part of RESTful routing.<tt>edit_post_path</tt> and <tt>new_post_path</tt><span style="font-family: DejaVu Sans;"><tt>是</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>提供的</tt></span>RESTful<span style="font-family: DejaVu Sans;">路由向导。</span>You’ll see a variety of these helpers for the different actions that the controller includes. <span style="font-family: DejaVu Sans;">不同的具有</span>controller<span style="font-family: DejaVu Sans;">的</span>actions<span style="font-family: DejaVu Sans;">中你将会看到一系列的这样的向导。</span></li>
</ul>


<p>In previous versions of Rails, you had to use <tt>&lt;%=h</tt><tt> </tt><tt>post.name</tt><tt> </tt><tt>%&gt;</tt> so that any HTML would be escaped before being inserted into the page.<span style="font-family: DejaVu Sans;">在以前的版本的</span>Rails<span style="font-family: DejaVu Sans;">中，你必须使用</span>&lt;%=h post.name %&gt; <span style="font-family: DejaVu Sans;">以避免一些</span>HTML<span style="font-family: DejaVu Sans;">可能会转义在插入到页面之前。</span>In Rails 3.0, this is now the default.<span style="font-family: DejaVu Sans;">在</span>Rails 3.0<span style="font-family: DejaVu Sans;">，作为默认。</span>To get unescaped HTML, you now use &lt;%= raw post.name %&gt;.<span style="font-family: DejaVu Sans;">得到一个非转义的</span>HTML<span style="font-family: DejaVu Sans;">，你现在使用</span>&lt;%=raw post.name%&gt;.</p>

<p>For more details on the rendering process, see <a href="http://guides.rubyonrails.org/layouts_and_rendering.html"><span style="color: #000080;"><span style="text-decoration: underline;">Layouts</span></span><span style="color: #000080;"><span style="text-decoration: underline;">and</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rendering</span></span><span style="color: #000080;"><span style="text-decoration: underline;">in</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span></a>.<span style="font-family: DejaVu Sans;">了解更过关于渲染处理流程，阅读</span><a href="http://guides.rubyonrails.org/layouts_and_rendering.html"><span style="color: #000080;"><span style="text-decoration: underline;">Layouts</span></span><span style="color: #000080;"><span style="text-decoration: underline;">and</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rendering</span></span><span style="color: #000080;"><span style="text-decoration: underline;">in</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span></a>.</p>

<h4><a name="customizing-the-layout"></a>6.8 Customizing the Layout<span style="font-family: WenQuanYi Micro Hei;">定制布局</span></h4>


<p>The view is only part of the story of how HTML is displayed in your web browser.view<span style="font-family: DejaVu Sans;">仅仅告诉</span>HTML<span style="font-family: DejaVu Sans;">要显示什么（内容）在你的</span>web<span style="font-family: DejaVu Sans;">浏览器里面。</span>Rails also has the concept of <tt>layouts</tt>, which are containers for views.Rails<span style="font-family: DejaVu Sans;">也有关于布局的概念（定义），那就是（布局）是对</span>viewi<span style="font-family: DejaVu Sans;">的包装。</span>When Rails renders a view to the browser, it does so by putting the view’s HTML into a layout’s HTML.<span style="font-family: DejaVu Sans;">当</span>Rails<span style="font-family: DejaVu Sans;">渲染一个</span>view<span style="font-family: DejaVu Sans;">到浏览器，它通常是（这样做）把</span>view<span style="font-family: DejaVu Sans;">的</span>HTML<span style="font-family: DejaVu Sans;">放进布局的</span>HTML<span style="font-family: DejaVu Sans;">中。</span>In previous versions of Rails, the <tt>rails</tt><tt> </tt><tt>generate</tt><tt> </tt><tt>scaffold</tt> command would automatically create a controller specific layout, like <tt>app/views/layouts/posts.html.erb</tt>, for the posts controller. <span style="font-family: DejaVu Sans;">在以前的版本中，</span><tt>rails</tt><tt> </tt><tt>generate</tt><tt> </tt><tt>scaffold</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>命令将会自动创建</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>对应指定的布局。</tt></span>However this has been changed in Rails 3.0. An application specific <tt>layout</tt> is used for all the controllers and can be found in <tt>app/views/layouts/application.html.erb</tt>. <span style="font-family: DejaVu Sans;">然而在</span>rails3.0<span style="font-family: DejaVu Sans;">中有所不同了。一个应用程序指定的布局适用于所有的</span>controllers<span style="font-family: DejaVu Sans;">，可以在</span><tt>app/views/layouts/application.html.erb</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>中找到</tt></span><tt>(</tt><span style="font-family: DejaVu Sans;"><tt>这就好像是</tt></span><tt>django</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>base.html)</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span>Open this layout in your editor and modify the <tt>body</tt> tag:<span style="font-family: DejaVu Sans;">打开这个</span>layout<span style="font-family: DejaVu Sans;">在你的编辑器中并且修改</span>body<span style="font-family: DejaVu Sans;">标签：</span></p>

<p>&lt;!DOCTYPE html&gt;</p>

<p>&lt;html&gt;</p>

<p>&lt;head&gt;</p>

<p>&lt;title&gt;Blog&lt;/title&gt;</p>

<p>&lt;%= stylesheet_link_tag &ldquo;application&rdquo; %&gt;</p>

<p>&lt;%= javascript_include_tag &ldquo;application&rdquo; %&gt;</p>

<p>&lt;%= csrf_meta_tags %&gt;</p>

<p>&lt;/head&gt;</p>

<p>&lt;body style=&ldquo;background: #EEEEEE;&rdquo;&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= yield %&gt;</p>

<p>&nbsp;</p>

<p>&lt;/body&gt;</p>

<p>&lt;/html&gt;</p>

<p>Now when you refresh the <tt>/posts</tt> page, you’ll see a gray background to the page. This same gray background will be used throughout all the views for posts.<span style="font-family: DejaVu Sans;">现在你刷新</span><tt>/posts</tt><span style="font-family: DejaVu Sans;"><tt>页面，你将会看到一个灰色的页面背景。并且相同的灰色背景将会使用在</tt></span><tt>posts</tt><span style="font-family: DejaVu Sans;"><tt>的所有视图中。</tt></span></p>

<h4><a name="creating-new-posts"></a><tt>6.9</tt><tt> </tt><tt>Creating</tt><tt> </tt><tt>New</tt><tt> </tt><tt>Posts</tt></h4>


<p>Creating a new post involves two actions. The first is the <tt>new</tt> action, which instantiates an empty <tt>Post</tt> object:<span style="font-family: DejaVu Sans;">创建一个</span>new post <span style="font-family: DejaVu Sans;">包含两个</span>actions<span style="font-family: DejaVu Sans;">。首先是</span>new action<span style="font-family: DejaVu Sans;">，它会实例化一个空的</span>Post<span style="font-family: DejaVu Sans;">对象：</span></p>

<p><code>def</code> <code>new</code></p>

<p><code> </code><code>@post</code> <code>=</code><code> </code><code>Post.new</code></p>

<p>&nbsp;</p>

<p><code> </code><code>respond_to</code><code> </code><code>do</code> <code>|format|</code></p>

<p><code> </code><code>format.html</code><code> </code><code>#</code><code> </code><code>new.html.erb</code></p>

<p><code> </code><code>format.json</code><code> </code><code>{</code><code> </code><code>render</code><code> </code><code>:json</code> <code>=&gt;</code><code> </code><code>@post</code> <code>}</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>The <tt>new.html.erb</tt> view displays this empty Post to the user: <span style="font-family: DejaVu Sans;">这个</span>new.html.erb<span style="font-family: DejaVu Sans;">视图显示这个空的</span>post<span style="font-family: DejaVu Sans;">给用户：</span></p>

<p><code>&lt;h1&gt;New</code><code> </code><code>post&lt;/h1&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>&lsquo;form&rsquo;</code> <code>%&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Back&rsquo;,</code><code> </code><code>posts_path</code><code> </code><code>%&gt;</code></p>

<p>The <tt>&lt;%=</tt><tt> </tt><tt>render</tt><tt> </tt><tt>&lsquo;form&rsquo;</tt><tt> </tt><tt>%&gt;</tt> line is our first introduction to <em>partials</em> in Rails.<tt>&lt;%=</tt><tt> </tt><tt>render</tt><tt> </tt><tt>&lsquo;form&rsquo;</tt><tt> </tt><tt>%&gt;</tt><span style="font-family: DejaVu Sans;"><tt>是我们第一个介绍的</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>partials</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span>A partial is a snippet of HTML and Ruby code that can be reused in multiple locations.<span style="font-family: DejaVu Sans;">一个</span>partial<span style="font-family: DejaVu Sans;">是一个</span>HTML<span style="font-family: DejaVu Sans;">代码片段和</span>Ruby<span style="font-family: DejaVu Sans;">代码的组合可以在多目标对象中重用。（类似于</span>django<span style="font-family: DejaVu Sans;">的</span>include &lsquo;other.html&rsquo;<span style="font-family: DejaVu Sans;">）</span>In this case, the form used to make a new post, is basically identical to a form used to edit a post, both have text fields for the name and title and a text area for the content with a button to make a new post or update the existing post.<span style="font-family: DejaVu Sans;">在本例中，</span>form<span style="font-family: DejaVu Sans;">用于创建</span>new post<span style="font-family: DejaVu Sans;">，它相当于一个用于编辑一个</span>post<span style="font-family: DejaVu Sans;">的表单，这个表单有一个</span>name text fields <span style="font-family: DejaVu Sans;">和</span>title text fields <span style="font-family: DejaVu Sans;">以及一个</span>content<span style="font-family: DejaVu Sans;">的</span>text area<span style="font-family: DejaVu Sans;">还有一个用于添加一个新的</span>post<span style="font-family: DejaVu Sans;">或者更新已经存在的</span>post<span style="font-family: DejaVu Sans;">的按钮。</span></p>

<p>If you take a look at <tt>views/posts/<em>form.html.erb</tt> file, you will see the following:<span style="font-family: DejaVu Sans;">如果你看一下</span><tt>views/posts/</em>form.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>这个文件，你将会发现下面的内容：</tt></span></p>

<p>&lt;%= form_for(@post) do |f| %&gt;</p>

<p>&lt;% if @post.errors.any? %&gt;</p>

<p>&lt;div id=&ldquo;error_explanation&rdquo;&gt;</p>

<p>&lt;h2&gt;&lt;%= pluralize(@post.errors.count, &ldquo;error&rdquo;) %&gt; prohibited this post from being saved:&lt;/h2&gt;</p>

<p>&lt;ul&gt;</p>

<p>&lt;% @post.errors.full_messages.each do |msg| %&gt;</p>

<p>&lt;li&gt;&lt;%= msg %&gt;&lt;/li&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;/ul&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.label :name %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_field :name %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.label :title %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_field :title %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.label :content %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_area :content %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.submit %&gt;</p>

<p>&lt;/div</p>

<p>&lt;% end %&gt;</p>

<p><tt>This</tt><tt> </tt><tt>partial</tt><tt> </tt><tt>receives</tt><tt> </tt><tt>all</tt><tt> </tt><tt>the</tt><tt> </tt><tt>instance</tt><tt> </tt><tt>variables</tt><tt> </tt><tt>defined</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>calling</tt><tt> </tt><tt>view</tt><tt> </tt><tt>file,</tt><tt> </tt><tt>so</tt><tt> </tt><tt>in</tt><tt> </tt><tt>this</tt><tt> </tt><tt>case,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>controller</tt><tt> </tt><tt>assigned</tt><tt> </tt><tt>the</tt><tt> </tt><tt>new</tt><tt> </tt><tt>Post</tt><tt> </tt><tt>object</tt><tt> </tt><tt>to</tt><tt> </tt><tt>@post</tt><tt> </tt><tt>and</tt><tt> </tt><tt>so,</tt><tt> </tt><tt>this</tt><tt> </tt><tt>is</tt><tt> </tt><tt>available</tt><tt> </tt><tt>in</tt><tt> </tt><tt>both</tt><tt> </tt><tt>the</tt><tt> </tt><tt>view</tt><tt> </tt><tt>and</tt><tt> </tt><tt>partial</tt><tt> </tt><tt>as</tt><tt> </tt><tt>@post.</tt><span style="font-family: DejaVu Sans;"><tt>这个</tt></span><tt>partial</tt><span style="font-family: DejaVu Sans;"><tt>接收在</tt></span><tt>view</tt><span style="font-family: DejaVu Sans;"><tt>文件中定义的所有的实例变量，因此在本例中，</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>申请新的</tt></span><tt>Post</tt><span style="font-family: DejaVu Sans;"><tt>对象给</tt></span><tt>@post</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>@post</tt><span style="font-family: DejaVu Sans;"><tt>在</tt></span><tt>viewi</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>partial</tt><span style="font-family: DejaVu Sans;"><tt>都是可用的。</tt></span></p>

<p><tt>For</tt><tt> </tt><tt>more</tt><tt> </tt><tt>information</tt><tt> </tt><tt>on</tt><tt> </tt><tt>partials,</tt><tt> </tt><tt>refer</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><a href="http://guides.rubyonrails.org/layouts_and_rendering.html#using-partials"><span style="color: #000080;"><span style="text-decoration: underline;">Layouts</span></span><span style="color: #000080;"><span style="text-decoration: underline;">and</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rendering</span></span><span style="color: #000080;"><span style="text-decoration: underline;">in</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span></a><tt> </tt><tt>guide.</tt><span style="font-family: DejaVu Sans;"><tt>有关</tt></span><tt>partials</tt><span style="font-family: DejaVu Sans;"><tt>的更多信息，参考</tt><tt></tt></span><a href="http://guides.rubyonrails.org/layouts_and_rendering.html#using-partials"><span style="color: #000080;"><span style="text-decoration: underline;">Layouts</span></span><span style="color: #000080;"><span style="text-decoration: underline;">and</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rendering</span></span><span style="color: #000080;"><span style="text-decoration: underline;">in</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span></a><span style="font-family: DejaVu Sans;"><tt>指导。</tt></span></p>

<p><tt>The</tt><tt> </tt><tt>form_for</tt><tt> </tt><tt>block</tt><tt> </tt><tt>is</tt><tt> </tt><tt>used</tt><tt> </tt><tt>to</tt><tt> </tt><tt>create</tt><tt> </tt><tt>an</tt><tt> </tt><tt>HTML</tt><tt> </tt><tt>form.form_for</tt><span style="font-family: DejaVu Sans;"><tt>代码块用于创建一个</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>表单。</tt><tt></tt></span><tt>Within</tt><tt> </tt><tt>this</tt><tt> </tt><tt>block,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>have</tt><tt> </tt><tt>access</tt><tt> </tt><tt>to</tt><tt> </tt><tt>methods</tt><tt> </tt><tt>to</tt><tt> </tt><tt>build</tt><tt> </tt><tt>various</tt><tt> </tt><tt>controls</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form.</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>在这个代码块中你可以在访问方法的基础上在表单上创建各种控制。</tt></span><tt>For</tt><tt> </tt><tt>example,</tt><tt> </tt><tt>f.text_field</tt><tt> </tt><tt>:name</tt><tt> </tt><tt>tells</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>to</tt><tt> </tt><tt>create</tt><tt> </tt><tt>a</tt><tt> </tt><tt>text</tt><tt> </tt><tt>input</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form,</tt><tt> </tt><tt>and</tt><tt> </tt><tt>to</tt><tt> </tt><tt>hook</tt><tt> </tt><tt>it</tt><tt> </tt><tt>up</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>name</tt><tt> </tt><tt>attribute</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>instance</tt><tt> </tt><tt>being</tt><tt> </tt><tt>displayed.</tt><span style="font-family: DejaVu Sans;"><tt>比如，</tt></span><tt>f.test_field</tt><tt> </tt><tt>:name</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>告诉</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>在表单中创建一个</tt></span><tt>text</tt><tt> </tt><tt>input</tt><span style="font-family: DejaVu Sans;"><tt>。</tt><tt></tt></span><tt>You</tt><tt> </tt><tt>can</tt><tt> </tt><tt>only</tt><tt> </tt><tt>use</tt><tt> </tt><tt>these</tt><tt> </tt><tt>methods</tt><tt> </tt><tt>with</tt><tt> </tt><tt>attributes</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>model</tt><tt> </tt><tt>that</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>is</tt><tt> </tt><tt>based</tt><tt> </tt><tt>on</tt><tt> </tt><tt>(in</tt><tt> </tt><tt>this</tt><tt> </tt><tt>case</tt><tt> </tt><tt>name,</tt><tt> </tt><tt>title,</tt><tt> </tt><tt>and</tt><tt> </tt><tt>content).form</tt><span style="font-family: DejaVu Sans;"><tt>使用的方法基于</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>的相对应的字段属性（类型如</tt></span><tt>text_field</tt><tt> </tt><tt>or</tt><tt> </tt><tt>text_area</tt><span style="font-family: DejaVu Sans;"><tt>）（例如本例中的</tt></span><tt>name,title,content</tt><span style="font-family: DejaVu Sans;"><tt>）。</tt><tt></tt></span><tt>Rails</tt><tt> </tt><tt>uses</tt><tt> </tt><tt>form_for</tt><tt> </tt><tt>in</tt><tt> </tt><tt>preference</tt><span style="font-family: DejaVu Sans;"><tt>偏好优先</tt><tt></tt></span><tt>to</tt><tt> </tt><tt>having</tt><tt> </tt><tt>you</tt><tt> </tt><tt>write</tt><tt> </tt><tt>raw</tt><tt> </tt><tt>HTML</tt><tt> </tt><tt>because</tt><tt> </tt><tt>the</tt><tt> </tt><tt>code</tt><tt> </tt><tt>is</tt><tt> </tt><tt>more</tt><tt> </tt><tt>succinct#</tt><span style="font-family: DejaVu Sans;"><tt>简洁</tt></span><tt>,</tt><tt> </tt><tt>and</tt><tt> </tt><tt>because</tt><tt> </tt><tt>it</tt><tt> </tt><tt>explicitly</tt><span style="font-family: DejaVu Sans;"><tt>明确</tt><tt></tt></span><tt>ties</tt><span style="font-family: DejaVu Sans;"><tt>关系</tt><tt></tt></span><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>to</tt><tt> </tt><tt>a</tt><tt> </tt><tt>particular</tt><tt> </tt><tt>model</tt><tt> </tt><tt>instance.Rails</tt><span style="font-family: DejaVu Sans;"><tt>使用（偏向于使用）</tt></span><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>列出你要输入的</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>行因为这样代码更加简洁，并却这样使得</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>particular</tt><tt> </tt><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>实例关系更加明显。</tt></span></p>

<p><tt>The</tt><tt> </tt><tt>form_for</tt><tt> </tt><tt>block</tt><tt> </tt><tt>is</tt><tt> </tt><tt>also</tt><tt> </tt><tt>smart</tt><tt> </tt><tt>enough</tt><tt> </tt><tt>to</tt><tt> </tt><tt>work</tt><tt> </tt><tt>out</tt><tt> </tt><tt>if</tt><tt> </tt><tt>you</tt><tt> </tt><tt>are</tt><tt> </tt><tt>doing</tt><tt> </tt><tt>a</tt><tt> </tt><em>New</em><em> </em><em>Post</em><tt> </tt><tt>or</tt><tt> </tt><tt>an</tt><tt> </tt><em>Edit</em><em> </em><em>Post</em><tt> </tt><tt>action,</tt><tt> </tt><tt>and</tt><tt> </tt><tt>will</tt><tt> </tt><tt>set</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>action</tt><tt> </tt><tt>tags</tt><tt> </tt><tt>and</tt><tt> </tt><tt>submit</tt><tt> </tt><tt>button</tt><tt> </tt><tt>names</tt><tt> </tt><tt>appropriately</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>HTML</tt><tt> </tt><tt>output.form_for</tt><span style="font-family: DejaVu Sans;"><tt>代码块同样也足够你定制你的</tt></span><tt>New</tt><tt> </tt><tt>Post</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>Edit</tt><tt> </tt><tt>Post</tt><tt> </tt><tt>action,</tt><span style="font-family: DejaVu Sans;"><tt>并且将会设置</tt></span><tt>form</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>标签和在</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>输出中显示的提交按钮名称。</tt></span></p>

<p><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>need</tt><tt> </tt><tt>to</tt><tt> </tt><tt>create</tt><tt> </tt><tt>an</tt><tt> </tt><tt>HTML</tt><tt> </tt><tt>form</tt><tt> </tt><tt>that</tt><tt> </tt><tt>displays</tt><tt> </tt><tt>arbitrary#</tt><span style="font-family: DejaVu Sans;"><tt>任意</tt><tt></tt></span><tt>fields,</tt><tt> </tt><tt>not</tt><tt> </tt><tt>tied</tt><tt> </tt><tt>to</tt><tt> </tt><tt>a</tt><tt> </tt><tt>model,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>should</tt><tt> </tt><tt>use</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form_tag</tt><tt> </tt><tt>method,</tt><tt> </tt><tt>which</tt><tt> </tt><tt>provides</tt><tt> </tt><tt>shortcuts</tt><tt> </tt><tt>for</tt><tt> </tt><tt>building</tt><tt> </tt><tt>forms</tt><tt> </tt><tt>that</tt><tt> </tt><tt>are</tt><tt> </tt><tt>not</tt><tt> </tt><tt>necessarily</tt><tt> </tt><tt>tied</tt><tt> </tt><tt>to</tt><tt> </tt><tt>a</tt><tt> </tt><tt>model</tt><tt> </tt><tt>instance.</tt><span style="font-family: DejaVu Sans;"><tt>如果你需要创建一个</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>表单显示任意的域，而不绑定到</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>字段中，你应该使用</tt></span><tt>form_tag</tt><span style="font-family: DejaVu Sans;"><tt>方法，它快捷的保证了建立</tt></span><tt>forms</tt><span style="font-family: DejaVu Sans;"><tt>不必在绑定到一个</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>实例。</tt></span></p>

<p><tt>When</tt><tt> </tt><tt>the</tt><tt> </tt><tt>user</tt><tt> </tt><tt>clicks</tt><tt> </tt><tt>the</tt><tt> </tt><tt>Create</tt><tt> </tt><tt>Post</tt><tt> </tt><tt>button</tt><tt> </tt><tt>on</tt><tt> </tt><tt>this</tt><tt> </tt><tt>form,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>browser</tt><tt> </tt><tt>will</tt><tt> </tt><tt>send</tt><tt> </tt><tt>information</tt><tt> </tt><tt>back</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>create</tt><tt> </tt><tt>method</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>controller</tt><tt> </tt><tt>(Rails</tt><tt> </tt><tt>knows</tt><tt> </tt><tt>to</tt><tt> </tt><tt>call</tt><tt> </tt><tt>the</tt><tt> </tt><tt>create</tt><tt> </tt><tt>method</tt><tt> </tt><tt>because</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>is</tt><tt> </tt><tt>sent</tt><tt> </tt><tt>with</tt><tt> </tt><tt>an</tt><tt> </tt><tt>HTTP</tt><tt> </tt><tt>POST</tt><tt> </tt><tt>request;</tt><tt> </tt><tt>that</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>one</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>conventions</tt><tt> </tt><tt>that</tt><tt> </tt><tt>I</tt><tt> </tt><tt>mentioned</tt><tt> </tt><tt>earlier):</tt><span style="font-family: DejaVu Sans;"><tt>当用户点击这张表单上面的创建</tt></span><tt>Post</tt><span style="font-family: DejaVu Sans;"><tt>按钮，浏览器将会发送信息</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>的方法回服务器（</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>知道调用</tt></span><tt>create</tt><span style="font-family: DejaVu Sans;"><tt>方法，因为</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>是以</tt></span><tt>HTTP</tt><tt> </tt><tt>POST</tt><span style="font-family: DejaVu Sans;"><tt>请求发送，这是我随后提到的一种协议之一）</tt></span></p>

<p><tt> </tt><tt>def</tt><tt> </tt><tt>create</tt></p>

<p><tt> </tt><tt>@post</tt><tt> </tt><tt>=</tt><tt> </tt><tt>Post.new(params[:post])</tt></p>

<p><tt> </tt><tt>respond_to</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|format|</tt></p>

<p><tt> </tt><tt>if</tt><tt> </tt><tt>@post.save</tt></p>

<p><tt> </tt><tt>format.html</tt><tt> </tt><tt>{</tt><tt> </tt><tt>redirect_to</tt><tt> </tt><tt>@post,</tt><tt> </tt><tt>:notice</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&lsquo;Post</tt><tt> </tt><tt>was</tt><tt> </tt><tt>successfully</tt><tt> </tt><tt>created.&rsquo;</tt><tt> </tt><tt>}</tt></p>

<p><tt> </tt><tt>format.json</tt><tt> </tt><tt>{</tt><tt> </tt><tt>render</tt><tt> </tt><tt>:json</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>@post,</tt><tt> </tt><tt>:status</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:created,</tt><tt> </tt><tt>:location</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>@post</tt><tt> </tt><tt>}</tt></p>

<p><tt> </tt><tt>else</tt></p>

<p><tt> </tt><tt>format.html</tt><tt> </tt><tt>{</tt><tt> </tt><tt>render</tt><tt> </tt><tt>:action</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&ldquo;new&rdquo;</tt><tt> </tt><tt>}</tt></p>

<p><tt> </tt><tt>format.json</tt><tt> </tt><tt>{</tt><tt> </tt><tt>render</tt><tt> </tt><tt>:json</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>@post.errors,</tt><tt> </tt><tt>:status</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:unprocessable_entity</tt><tt> </tt><tt>}</tt></p>

<p><tt> </tt><tt>end</tt></p>

<p><tt> </tt><tt>end</tt></p>

<p><tt> </tt><tt>end</tt></p>

<p>The <tt>create</tt> action instantiates a new Post object from the data supplied by the user on the form, which Rails makes available in the <tt>params</tt> hash.create action<span style="font-family: DejaVu Sans;">实例化一个新的</span>Post<span style="font-family: DejaVu Sans;">对象，这个对象给</span>form<span style="font-family: DejaVu Sans;">提供数据支持。</span>After successfully saving the new post, <tt>create</tt> returns the appropriate format that the user has requested (HTML in our case).<span style="font-family: DejaVu Sans;">当成功的保存了新</span>post<span style="font-family: DejaVu Sans;">，</span>create<span style="font-family: DejaVu Sans;">返回用户请求的适当的格式（在本例中是</span>HTML<span style="font-family: DejaVu Sans;">）。</span>It then redirects the user to the resulting post <tt>show</tt> action and sets a notice to the user that the Post was successfully created.<span style="font-family: DejaVu Sans;">然后重定向用户页面到结果显示的</span>post show action<span style="font-family: DejaVu Sans;">页面并且给出提示</span>Post<span style="font-family: DejaVu Sans;">成功的创建了。</span></p>

<p>If the post was not successfully saved, due to a validation error, then the controller returns the user back to the <tt>new</tt> action with any error messages so that the user has the chance to fix the error and try again.<span style="font-family: DejaVu Sans;">如果</span>post<span style="font-family: DejaVu Sans;">没有保存成功，是因为（数据）验证错误，然后</span>controller<span style="font-family: DejaVu Sans;">控制用户页面回到</span>new action<span style="font-family: DejaVu Sans;">（包含验证错误新息）给用户。</span></p>

<p>The “Post was successfully created.” message is stored inside of the Rails <tt>flash</tt> hash, (usually just called <em>the</em><em> </em><em>flash</em>) so that messages can be carried#<span style="font-family: DejaVu Sans;">载</span>over to another action, providing the user with useful information on the status of their request. “Post was successfully created.” <span style="font-family: DejaVu Sans;">这条消息被存储在</span>Rails<span style="font-family: DejaVu Sans;">的</span>flash<span style="font-family: DejaVu Sans;">的</span>hash<span style="font-family: DejaVu Sans;">表中，（通常之叫它</span>flash<span style="font-family: DejaVu Sans;">）因此消息可以转载到另一个</span>action<span style="font-family: DejaVu Sans;">，在请求状态中提供有用的信息给用户。</span>In the case of <tt>create</tt>, the user never actually sees any page rendered during the Post creation process, because it immediately redirects to the new Post as soon Rails saves the record.<span style="font-family: DejaVu Sans;">在这个新建例子（数据验证失败）中，用户实际上从来不看任何在页面创建进程中的渲染页面，因为它立刻重定向页面到</span>new Post<span style="font-family: DejaVu Sans;">当</span>Rails<span style="font-family: DejaVu Sans;">保存了这个记录。</span>The Flash carries over a message to the next action, so that when the user is redirected back to the <tt>show</tt> action, they are presented with a message saying “Post was successfully created.”Flash<span style="font-family: DejaVu Sans;">装载消息到接下来的</span>action<span style="font-family: DejaVu Sans;">，因此当用户被重定向到了</span>show action<span style="font-family: DejaVu Sans;">，他们立刻收到了一条消息<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>Post was successfully created.”<span style="font-family: DejaVu Sans;">。</span></p>

<h4><a name="showing-an-individual-post"></a>6.10 Showing an Individual Post<span style="font-family: WenQuanYi Micro Hei;">显示一条单个的</span>Post</h4>


<p>When you click the <tt>show</tt> link for a post on the index page, it will bring you to a URL like <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/posts/1"><a href="http://localhost:3000/posts/1">http://localhost:3000/posts/1</a></a></span></span>. <span style="font-family: DejaVu Sans;">当你在</span>posts <span style="font-family: DejaVu Sans;">的主页面点击一个</span>post<span style="font-family: DejaVu Sans;">的</span>show<span style="font-family: DejaVu Sans;">这个超链接，他将会产生一个</span>url <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://localhost:3000/posts/1"><a href="http://localhost:3000/posts/1">http://localhost:3000/posts/1</a></a></span></span><span style="font-family: DejaVu Sans;"><tt>。</tt></span>Rails interprets<span style="font-family: DejaVu Sans;">解释</span>this as a call to the <tt>show</tt> action for the resource, and passes in <tt>1</tt> as the <tt>:id</tt> parameter.Rails<span style="font-family: DejaVu Sans;">解释这是一个到</span>show action<span style="font-family: DejaVu Sans;">的</span>resource <span style="font-family: DejaVu Sans;">调用。</span>Here’s the <tt>show</tt> action:<span style="font-family: DejaVu Sans;">这里是</span>show action<span style="font-family: DejaVu Sans;">：</span></p>

<p>def show</p>

<p>@post = Post.find(params[:id])</p>

<p>respond_to do |format|</p>

<p>format.html # show.html.erb</p>

<p>format.json { render :json =&gt; @post }</p>

<p>end</p>

<p>end</p>

<p>The <tt>show</tt> action uses <tt>Post.find</tt> to search for a single record in the database by its id value.<span style="font-family: DejaVu Sans;">这里的</span>show action<span style="font-family: DejaVu Sans;">使用</span>Post.find<span style="font-family: DejaVu Sans;">通过对应记录的</span>id<span style="font-family: DejaVu Sans;">来查找单个记录。</span>After finding the record, Rails displays it by using <tt>show.html.erb</tt>:<span style="font-family: DejaVu Sans;">当找到记录，</span>Rails<span style="font-family: DejaVu Sans;">使用</span>show.html.erb<span style="font-family: DejaVu Sans;">来显示它：</span></p>

<p>&lt;p id=&ldquo;notice&rdquo;&gt;&lt;%= notice %&gt;&lt;/p&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Name:&lt;/b&gt;</p>

<p>&lt;%= @post.name %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Title:&lt;/b&gt;</p>

<p>&lt;%= @post.title %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Content:&lt;/b&gt;</p>

<p>&lt;%= @post.content %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;%= link_to &lsquo;Edit&rsquo;, edit_post_path(@post) %&gt; |</p>

<p>&lt;%= link_to &lsquo;Back&rsquo;, posts_path %&gt;</p>

<h4><a name="editing-posts"></a>6.11 Editing Posts<span style="font-family: WenQuanYi Micro Hei;">编辑</span>Posts</h4>


<p>Like creating a new post, editing a post is a two-part process.<span style="font-family: DejaVu Sans;">类似创建一个新的</span>post<span style="font-family: DejaVu Sans;">，编辑一个</span>post<span style="font-family: DejaVu Sans;">也（分为）两部分。</span>The first step is a request to <tt>edit_post_path(@post)</tt> with a particular post. This calls the <tt>edit</tt> action in the controller:<span style="font-family: DejaVu Sans;">首先是到</span><tt>edit_post_path(@post)</tt><span style="font-family: DejaVu Sans;"><tt>请求一个特定的</tt></span><tt>post</tt><span style="font-family: DejaVu Sans;"><tt>。这里是调用的在</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>中的</tt></span><tt>edit</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><code>def</code><tt> </tt><code>edit</code></p>

<p><code> </code><code>@post</code> <code>=</code><code> </code><code>Post.find(params[:id])</code></p>

<p><code>end</code></p>

<p>After finding the requested post, Rails uses the <tt>edit.html.erb</tt> view to display it:<span style="font-family: DejaVu Sans;">在找到了请求的</span>post<span style="font-family: DejaVu Sans;">，</span>Rails<span style="font-family: DejaVu Sans;">使用</span><tt>edit.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>试图来显示它：</tt></span></p>

<p><code>&lt;h1&gt;Editing</code><code> </code><code>post&lt;/h1&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>&lsquo;form&rsquo;</code> <code>%&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Show&rsquo;,</code><code> </code><code>@post</code> <code>%&gt;</code> <code>|</code></p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Back&rsquo;,</code><code> </code><code>posts_path</code><code> </code><code>%&gt;</code></p>

<p><tt>Again,</tt><tt> </tt><tt>as</tt><tt> </tt><tt>with</tt><tt> </tt><tt>the</tt><tt> </tt><tt>new</tt><tt> </tt><tt>action,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>edit</tt><tt> </tt><tt>action</tt><tt> </tt><tt>is</tt><tt> </tt><tt>using</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>partial,</tt><tt> </tt><tt>this</tt><tt> </tt><tt>time</tt><tt> </tt><tt>however,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>will</tt><tt> </tt><tt>do</tt><tt> </tt><tt>a</tt><tt> </tt><tt>PUT</tt><tt> </tt><tt>action</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>PostsController</tt><tt> </tt><tt>and</tt><tt> </tt><tt>the</tt><tt> </tt><tt>submit</tt><tt> </tt><tt>button</tt><tt> </tt><tt>will</tt><tt> </tt><tt>display</tt><tt> “</tt><tt>Update</tt><tt> </tt><tt>Post</tt><tt>”</tt><span style="font-family: DejaVu Sans;"><tt>再一次的，就像</tt></span><tt>new</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>edit</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>也使用</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>部分，这次有所不同，</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>将会提交一个</tt></span><tt>PUT</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>到</tt></span><tt>PostsController</tt><span style="font-family: DejaVu Sans;"><tt>并且提交按钮将会显示</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></tt></span><tt>Update</tt><tt> </tt><tt>Post</tt><tt>”</tt></p>

<p><tt>Submitting</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>created</tt><tt> </tt><tt>by</tt><tt> </tt><tt>this</tt><tt> </tt><tt>view</tt><tt> </tt><tt>will</tt><tt> </tt><tt>invoke</tt><span style="font-family: DejaVu Sans;"><tt>调用</tt><tt></tt></span><tt>the</tt><tt> </tt><tt>update</tt><tt> </tt><tt>action</tt><tt> </tt><tt>within</tt><tt> </tt><tt>the</tt><tt> </tt><tt>controller:</tt><span style="font-family: DejaVu Sans;"><tt>提交的</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>由上面这个视图创建的并且还会调用</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>中的</tt></span><tt>update</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><tt> </tt><tt>def</tt><tt> </tt><tt>update</tt></p>

<p><tt> </tt><tt>@post</tt><tt> </tt><tt>=</tt><tt> </tt><tt>Post.find(params[:id])</tt></p>

<p><tt> </tt><tt>respond_to</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|format|</tt></p>

<p><tt> </tt><tt>if</tt><tt> </tt><tt>@post.update_attributes(params[:post])</tt></p>

<p><tt> </tt><tt>format.html</tt><tt> </tt><tt>{</tt><tt> </tt><tt>redirect_to</tt><tt> </tt><tt>@post,</tt><tt> </tt><tt>:notice</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&lsquo;Post</tt><tt> </tt><tt>was</tt><tt> </tt><tt>successfully</tt><tt> </tt><tt>updated.&rsquo;</tt><tt> </tt><tt>}</tt></p>

<p><tt> </tt><tt>format.json</tt><tt> </tt><tt>{</tt><tt> </tt><tt>head</tt><tt> </tt><tt>:ok</tt><tt> </tt><tt>}</tt></p>

<p><tt> </tt><tt>else</tt></p>

<p><tt> </tt><tt>format.html</tt><tt> </tt><tt>{</tt><tt> </tt><tt>render</tt><tt> </tt><tt>:action</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&ldquo;edit&rdquo;</tt><tt> </tt><tt>}</tt></p>

<p><tt> </tt><tt>format.json</tt><tt> </tt><tt>{</tt><tt> </tt><tt>render</tt><tt> </tt><tt>:json</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>@post.errors,</tt><tt> </tt><tt>:status</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:unprocessable_entity</tt><tt> </tt><tt>}</tt></p>

<p><tt> </tt><tt>end</tt></p>

<p><tt> </tt><tt>end</tt></p>

<p><tt> </tt><tt>end</tt></p>

<p><tt>In</tt><tt> </tt><tt>the</tt><tt> </tt><tt>update</tt><tt> </tt><tt>action,</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>first</tt><tt> </tt><tt>uses</tt><tt> </tt><tt>the</tt><tt> </tt><tt>:id</tt><tt> </tt><tt>parameter</tt><tt> </tt><tt>passed</tt><tt> </tt><tt>back</tt><tt> </tt><tt>from</tt><tt> </tt><tt>the</tt><tt> </tt><tt>edit</tt><tt> </tt><tt>view</tt><tt> </tt><tt>to</tt><tt> </tt><tt>locate</tt><tt> </tt><tt>the</tt><tt> </tt><tt>database</tt><tt> </tt><tt>record</tt><tt> </tt><tt>that</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>being</tt><tt> </tt><tt>edited.</tt><span style="font-family: DejaVu Sans;"><tt>在</tt></span><tt>update</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>中，</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>首先使用</tt></span><tt>:id</tt><span style="font-family: DejaVu Sans;"><tt>参数从</tt></span><tt>edit</tt><tt> </tt><tt>view</tt><span style="font-family: DejaVu Sans;"><tt>（传值到）数据库记录下刚才编辑的内容。</tt><tt></tt></span><tt>The</tt><tt> </tt><tt>update_attributes#</tt><span style="font-family: DejaVu Sans;"><tt>更新</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>的属性</tt><tt></tt></span><tt>call</tt><tt> </tt><tt>then</tt><tt> </tt><tt>takes</tt><tt> </tt><tt>the</tt><tt> </tt><tt>rest</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>parameters</tt><tt> </tt><tt>from</tt><tt> </tt><tt>the</tt><tt> </tt><tt>request</tt><tt> </tt><tt>and</tt><tt> </tt><tt>applies</tt><tt> </tt><tt>them</tt><tt> </tt><tt>to</tt><tt> </tt><tt>this</tt><tt> </tt><tt>record.</tt><tt> </tt><tt>update_attributes</tt><span style="font-family: DejaVu Sans;"><tt>在应用一些（更多）参数的来自</tt></span><tt>request</tt><span style="font-family: DejaVu Sans;"><tt>的数据到</tt></span><tt>recode</tt><span style="font-family: DejaVu Sans;"><tt>时被调用。</tt><tt></tt></span><tt>If</tt><tt> </tt><tt>all</tt><tt> </tt><tt>goes</tt><tt> </tt><tt>well,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>user</tt><tt> </tt><tt>is</tt><tt> </tt><tt>redirected</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>post</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>show</tt><tt> </tt><tt>view.</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>如果一切成功，用户会被重定向到</tt></span><tt>post</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>show</tt><span style="font-family: DejaVu Sans;"><tt>视图。</tt></span><tt>If</tt><tt> </tt><tt>there</tt><tt> </tt><tt>are</tt><tt> </tt><tt>any</tt><tt> </tt><tt>problems,</tt><tt> </tt><tt>it</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>back</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>edit</tt><tt> </tt><tt>view</tt><tt> </tt><tt>to</tt><tt> </tt><tt>correct</tt><tt> </tt><tt>them.</tt><span style="font-family: DejaVu Sans;"><tt>如果期间发生了任何错误，它将回到</tt></span><tt>edit</tt><span style="font-family: DejaVu Sans;"><tt>视图并（要求）改正他们。</tt></span></p>

<h4><a name="destroying-a-post1"></a><tt>6.12</tt><tt> </tt><tt>Destroying</tt><tt> </tt><tt>a</tt><tt> </tt><tt>Post</tt><tt> </tt><span style="font-family: WenQuanYi Micro Hei;"><tt>摧毁一个</tt></span><tt>post</tt></h4>


<p>Finally, clicking one of the <tt>destroy</tt> links sends the associated id to the <tt>destroy</tt> action:<span style="font-family: DejaVu Sans;">最后，点击一个</span>destroy<span style="font-family: DejaVu Sans;">链接发送相关的</span>id<span style="font-family: DejaVu Sans;">到</span>destroy<span style="font-family: DejaVu Sans;">动作：</span></p>

<p><code>def</code> <code>destroy</code></p>

<p><code> </code><code>@post</code> <code>=</code><code> </code><code>Post.find(params[:id])</code></p>

<p><code> </code><code>@post.destroy</code></p>

<p>&nbsp;</p>

<p><code> </code><code>respond_to</code><code> </code><code>do</code> <code>|format|</code></p>

<p><code> </code><code>format.html</code><code> </code><code>{</code><code> </code><code>redirect_to</code><code> </code><code>posts_url</code><code> </code><code>}</code></p>

<p><code> </code><code>format.json</code><code> </code><code>{</code><code> </code><code>head</code><code> </code><code>:ok</code> <code>}</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>The <tt>destroy</tt> method of an Active Record model instance removes the corresponding record from the database.<span style="font-family: DejaVu Sans;">这个</span>destroy<span style="font-family: DejaVu Sans;">是</span>Active Recordmodel<span style="font-family: DejaVu Sans;">的实例（功能是）从数据库中移除相应的记录。</span>After that’s done, there isn’t any record to display, so Rails redirects the user’s browser to the index view for the model.<span style="font-family: DejaVu Sans;">当这个（操作）完成，这里没有任何记录显示，因此</span>Rails<span style="font-family: DejaVu Sans;">重定向用户的浏览器到</span>model<span style="font-family: DejaVu Sans;">的主页视图。</span></p>

<h3><a name="adding-a-second-model"></a>7 Adding a Second Model<span style="font-family: WenQuanYi Micro Hei;">添加第二个</span>Model<span style="font-family: WenQuanYi Micro Hei;">（</span>comment<span style="font-family: WenQuanYi Micro Hei;">）</span></h3>


<p>Now that you’ve seen how a model built with scaffolding looks like, it’s time to add a second model to the application.<span style="font-family: DejaVu Sans;">你已经知道了通过</span>scaffolding<span style="font-family: DejaVu Sans;">生成的</span>model<span style="font-family: DejaVu Sans;">看起来是怎样的。</span>The second model will handle comments on blog posts.<span style="font-family: DejaVu Sans;">第二个</span>model<span style="font-family: DejaVu Sans;">用来处理</span>blog post<span style="font-family: DejaVu Sans;">的评论。</span></p>

<h4><a name="generating-a-model"></a>7.1 Generating a Model<span style="font-family: WenQuanYi Micro Hei;">构造一个</span>model</h4>


<p>Models in Rails use a singular name, and their corresponding database tables use a plural name. Rails <span style="font-family: DejaVu Sans;">中的</span>Models<span style="font-family: DejaVu Sans;">使用一个单数名称，同时它们相关的数据库表使用一个复数名称。</span>For the model to hold comments, the convention is to use the name Comment.<span style="font-family: DejaVu Sans;">对于评论在</span>models<span style="font-family: DejaVu Sans;">中的代名词，习惯上使用的的是</span>Comment<span style="font-family: DejaVu Sans;">。</span>Even if you don’t want to use the entire apparatus set up by scaffolding, most Rails developers still use generators to make things like models and controllers.<span style="font-family: DejaVu Sans;">即使你不想完完全全的使用</span>scaffolding<span style="font-family: DejaVu Sans;">，大多数的</span>Rails<span style="font-family: DejaVu Sans;">仍然使用生成器来做这些事情比如</span>models<span style="font-family: DejaVu Sans;">和</span>controllers<span style="font-family: DejaVu Sans;">。</span>To create the new model, run this command in your terminal:<span style="font-family: DejaVu Sans;">要创建一个新的</span>model<span style="font-family: DejaVu Sans;">，在终端中运行下面这条命令：</span></p>

<p><code>rails</code><code> </code><code>generate</code><code> </code><code>model</code><code> </code><code>Comment</code><code> </code><code>commenter:string</code><code> </code><code>body:text</code><code> </code><code>post:references</code><code> </code><code>#references</code><span style="font-family: DejaVu Sans;"><code>引用</code></span></p>

<p>This command will generate four files:<span style="font-family: DejaVu Sans;">这条命令将会生成四个文件：</span></p>

<ul>
    <li><tt>app/models/comment.rb</tt> – The model <span style="font-family: DejaVu Sans;">模型</span></li>
    <li><tt>db/migrate/20111108080402_create_comments.rb</tt> – The migration <span style="font-family: DejaVu Sans;">数据迁移</span></li>
    <li><tt>test/unit/comment_test.rb</tt> <span style="color: #800000;">and</span><tt>test/fixtures/comments.yml</tt> – The test harness. <span style="font-family: DejaVu Sans;">测试工具</span></li>
</ul>


<p>First, take a look at <tt>comment.rb</tt>:<span style="font-family: DejaVu Sans;">首先，看一看</span>comment.rb:</p>

<p><code>class</code> <code>Comment</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>belongs_to</code><code> </code><code>:post</code></p>

<p><code>end</code></p>

<p>This is very similar to the <tt>post.rb</tt> model that you saw earlier.<span style="font-family: DejaVu Sans;">这和你刚刚看到</span>post.rb<span style="font-family: DejaVu Sans;">很近似。</span>The difference is the line <tt>belongs_to</tt><tt> </tt><tt>:post</tt>, which sets up an Active Record <em>association</em>. <span style="font-family: DejaVu Sans;">不同的是这行</span><tt>belongs_to</tt><tt> </tt><tt>:post</tt><span style="font-family: DejaVu Sans;"><tt>，他会安装一个</tt><tt></tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><tt> </tt><em>association<span style="font-family: DejaVu Sans;">。</span></em>You’ll learn a little about associations in the next section of this guide.<span style="font-family: DejaVu Sans;">你将会在接下来的</span>guide<span style="font-family: DejaVu Sans;">学习一点有关</span>associations<span style="font-family: DejaVu Sans;">的内容。</span></p>

<p>In addition to the model, Rails has also made a migration to create the corresponding database table:<span style="font-family: DejaVu Sans;">除了模型，</span>Rails<span style="font-family: DejaVu Sans;">同样也产生了一个</span>migration<span style="font-family: DejaVu Sans;">来创建相应的数据库表单：</span></p>

<p>class CreateComments &lt; ActiveRecord::Migration</p>

<p>def change</p>

<p>create_table :comments do |t|</p>

<p>t.string :commenter</p>

<p>t.text :body</p>

<p>t.references :post</p>

<p>t.timestamps</p>

<p>end</p>

<p>add_index :comments, :post_id</p>

<p>end</p>

<p>end</p>

<p>The <tt>t.references</tt> line sets up a foreign key column for the association between the two models.<span style="font-family: DejaVu Sans;">对于</span><tt>t.references</tt><span style="font-family: DejaVu Sans;"><tt>这行，会在两个</tt></span><tt>models</tt><span style="font-family: DejaVu Sans;"><tt>之间生成一个外键列从而形成一个关系（组合）。</tt></span>And the <tt>add_index</tt> line sets up an index for this association column. Go ahead and run the migration:<span style="font-family: DejaVu Sans;">而且<tt></tt></span><tt>add_index</tt> line<span style="font-family: DejaVu Sans;">生成一个首页关联到这个关系行：</span></p>

<p><code>$</code><code> </code><code>rake</code><code> </code><code>db:migrate</code></p>

<p>Rails is smart enough to only execute the migrations that have not already been run against the current database, so in this case you will just see:Rails<span style="font-family: DejaVu Sans;">能够智能的只针对对没有被运行过的表单，执行</span>migrations<span style="font-family: DejaVu Sans;">生成当前的数据库，因此这里你只会看到：</span></p>

<h4><a name="associating-models"></a>7.2 Associating Models<span style="font-family: WenQuanYi Micro Hei;">关联</span>models</h4>


<p>Active Record associations let you easily declare the relationship between two models. In the case of comments and posts, you could write out the relationships this way:Active Record associations<span style="font-family: DejaVu Sans;">让你很容易的申明两个</span>models<span style="font-family: DejaVu Sans;">之间的关系。在本例中的</span>comments<span style="font-family: DejaVu Sans;">和</span>posts<span style="font-family: DejaVu Sans;">，你可以写出这样描述关系：</span></p>

<ul>
    <li>Each comment belongs to one post <span style="font-family: DejaVu Sans;">一条</span>comment<span style="font-family: DejaVu Sans;">对应于一个</span>post</li>
    <li>One post can have many comments <span style="font-family: DejaVu Sans;">一个</span>post<span style="font-family: DejaVu Sans;">可以对应于多个</span>comments</li>
</ul>


<p>In fact, this is very close to the syntax that Rails uses to declare this association.<span style="font-family: DejaVu Sans;">实际上，这也很接近</span>Rails<span style="font-family: DejaVu Sans;">申明的</span>association <span style="font-family: DejaVu Sans;">的语法。</span>You’ve already seen the line of code inside the Comment model that makes each comment belong to a Post:<span style="font-family: DejaVu Sans;">你已经看到了在</span>Comment model<span style="font-family: DejaVu Sans;">中的使每个</span>comment<span style="font-family: DejaVu Sans;">对应于一个</span>post<span style="font-family: DejaVu Sans;">的代码。</span></p>

<p>You’ll need to edit the <tt>post.rb</tt> file to add the other side of the association:<span style="font-family: DejaVu Sans;">你将会需要编辑</span>post.rb<span style="font-family: DejaVu Sans;">文件来添加其他</span>association <span style="font-family: DejaVu Sans;">盟友。</span></p>

<p><code>class</code> <code>Post</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:name,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code> </code><code>validates</code><code> </code><code>:title,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true,</code></p>

<p><code> </code><code>:length</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:minimum</code> <code>=&gt;</code><code> </code><code>5</code> <code>}</code></p>

<p>&nbsp;</p>

<p><code> </code><code>has_many</code><code> </code><code>:comments</code></p>

<p><code>end</code></p>

<p>These two declarations enable a good bit of automatic behavior. For example, if you have an instance variable <tt>@post</tt> containing a post, you can retrieve all the comments belonging to that post <strong>as</strong><strong> </strong><strong>the</strong><strong> </strong><strong>array</strong> <tt>@post.comments</tt>.</p>

<p>For more information on Active Record associations, see the <a href="http://guides.rubyonrails.org/association_basics.html"><span style="color: #000080;"><span style="text-decoration: underline;">Active</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Record</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Associations</span></span></a> guide.</p>

<h4><a name="adding-a-route-for-comments"></a>7.3 Adding a Route for Comments<span style="font-family: WenQuanYi Micro Hei;">给</span>Comments<span style="font-family: WenQuanYi Micro Hei;">添加路由</span></h4>


<p>As with the <tt>home</tt> controller, we will need to add a route so that Rails knows where we would like to navigate to see <tt>comments</tt>.<span style="font-family: DejaVu Sans;">作为</span>home controller<span style="font-family: DejaVu Sans;">，我们将还需要添加一个路由让</span>Rails<span style="font-family: DejaVu Sans;">知道我们导航到哪里可以看到评论。</span>Open up the <tt>config/routes.rb</tt> file again, you will see an entry that was added automatically for <tt>posts</tt> near the top by the scaffold generator, resources :posts, edit it as follows:<span style="font-family: DejaVu Sans;">再次打开</span><tt>config/routes.rb</tt><span style="font-family: DejaVu Sans;"><tt>文件，你将会看到</tt></span><tt>scaffold</tt><span style="font-family: DejaVu Sans;"><tt>创建器在顶部为</tt></span><tt>posts</tt><span style="font-family: DejaVu Sans;"><tt>自动添加的入口，</tt><tt></tt></span>resources :posts<span style="font-family: DejaVu Sans;">，把它改成如下：</span></p>

<p>resources :posts do</p>

<p>resources :comments</p>

<p>end</p>

<p>This creates <tt>comments</tt> as a <em>nested</em><em> </em><em>resource</em> within <tt>posts</tt>.<span style="font-family: DejaVu Sans;">这里把</span>comments<span style="font-family: DejaVu Sans;">作为一个嵌套资源放在</span>posts<span style="font-family: DejaVu Sans;">中。</span>This is another part of capturing the hierarchical relationship that exists between posts and comments.<span style="font-family: DejaVu Sans;">这是在存在的</span>posts<span style="font-family: DejaVu Sans;">和</span>comments<span style="font-family: DejaVu Sans;">的分层关系的表现。</span></p>

<p>For more information on routing, see the <a href="http://guides.rubyonrails.org/routing.html"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Routing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">from</span></span><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Outside</span></span><span style="color: #000080;"><span style="text-decoration: underline;">In</span></span></a> guide.<span style="font-family: DejaVu Sans;">关于</span>routing<span style="font-family: DejaVu Sans;">的更多的信息，查看</span><a href="http://guides.rubyonrails.org/routing.html"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Routing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">from</span></span><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Outside</span></span><span style="color: #000080;"><span style="text-decoration: underline;">In</span></span></a> guide<span style="font-family: DejaVu Sans;">。</span></p>

<h4><a name="generating-a-controller"></a>7.4 Generating a Controller<span style="font-family: WenQuanYi Micro Hei;">构造一个</span>Controller</h4>


<p>With the model in hand, you can turn your attention to creating a matching controller.model<span style="font-family: DejaVu Sans;">已经到手了，你可以把你的注意力放到创建一个匹配的</span>controller<span style="font-family: DejaVu Sans;">上了。</span>Again, there’s a generator for this:<span style="font-family: DejaVu Sans;">类似的，像这样构造：</span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>controller</code><code> </code><code>Comments</code></p>

<p>This creates six files and one empty directory:<span style="font-family: DejaVu Sans;">这里新建了</span>6<span style="font-family: DejaVu Sans;">个文件和一个空目录。</span></p>

<ul>
    <li><tt>app/controllers/comments_controller.rb</tt> – The controller</li>
    <li><tt>app/helpers/comments_helper.rb</tt> – A view helper file</li>
    <li><tt>test/functional/comments_controller_test.rb</tt> – The functional tests for the controller</li>
    <li><tt>test/unit/helpers/comments_helper_test.rb</tt> – The unit tests for the helper</li>
    <li><tt>app/views/comments/</tt> – Views of the controller are stored here</li>
    <li><tt>app/assets/stylesheets/comment.css.scss</tt> – Cascading style sheet for the controller</li>
    <li><tt>app/assets/javascripts/comment.js.coffee</tt> – CoffeeScript for the controller</li>
</ul>


<p>Like with any blog, our readers will create their comments directly after reading the post, and once they have added their comment, will be sent back to the post show page to see their comment now listed.<span style="font-family: DejaVu Sans;">就像大多数</span>blog<span style="font-family: DejaVu Sans;">，我们的读者将会直接发表他们的评论在他们阅读</span>post<span style="font-family: DejaVu Sans;">的时候，并且一旦他们添加评论成功，将会回到</span>postshow<span style="font-family: DejaVu Sans;">页面去查看他们刚刚列出的评论。</span>Due to this, our <tt>CommentsController</tt> is there to provide a method to create comments and delete SPAM comments when they arrive.<span style="font-family: DejaVu Sans;">正因为这样</span>(<span style="font-family: DejaVu Sans;">的考虑</span>)<span style="font-family: DejaVu Sans;">，我们的</span><tt>CommentsController</tt><span style="font-family: DejaVu Sans;"><tt>如下，它提供一个方法来创建</tt></span><tt>comments</tt><span style="font-family: DejaVu Sans;"><tt>和删除垃圾评论。</tt></span></p>

<p>&lt;p&gt;&lt;%= notice %&gt;&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Name:&lt;/b&gt;</p>

<p>&lt;%= @post.name %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Title:&lt;/b&gt;</p>

<p>&lt;%= @post.title %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Content:&lt;/b&gt;</p>

<p>&lt;%= @post.content %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;h2&gt;Add a comment:&lt;/h2&gt;</p>

<p>&lt;%= form_for([@post, @post.comments.build]) do |f| %&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.label :commenter %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_field :commenter %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.label :body %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_area :body %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.submit %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= link_to &lsquo;Edit Post&rsquo;, edit_post_path(@post) %&gt; |</p>

<p>&lt;%= link_to &lsquo;Back to Posts&rsquo;, posts_path %&gt; |</p>

<p>This adds a form on the Post show page that creates a new comment, which will call the <tt>CommentsController</tt> <tt>create</tt> action, so let’s wire that up:<span style="font-family: DejaVu Sans;">这里添加一个</span>forms<span style="font-family: DejaVu Sans;">在</span>Post show<span style="font-family: DejaVu Sans;">页面用来创建一个新的评论，它将会调用</span><tt>CommentsController</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>creat</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>，因此让我们补充上下面的内容：</tt></span></p>

<p><code>class</code><tt> </tt><code>CommentsController</code><code> </code><code>&lt;</code><code> </code><code>ApplicationController</code></p>

<p><code> </code><code>def</code> <code>create</code></p>

<p><code> </code><code>@post</code> <code>=</code><code> </code><code>Post.find(params[:post_id])</code></p>

<p><code> </code><code>@comment</code> <code>=</code><code> </code><code>@post.comments.create(params[:comment])</code></p>

<p><code> </code><code>redirect_to</code><code> </code><code>post_path(@post)</code></p>

<p><code> </code><code>end</code></p>

<p><code>end</code></p>

<p>You’ll see a bit more complexity here than you did in the controller for posts.<span style="font-family: DejaVu Sans;">这里你看到的会比你在</span>controller<span style="font-family: DejaVu Sans;">中为</span>posts<span style="font-family: DejaVu Sans;">做的要复杂点。</span>That’s a side-effect of the nesting that you’ve set up; each request for a comment has to keep track#<span style="font-family: DejaVu Sans;">踪迹</span>of the post to which the comment is attached, thus the initial find action to the Post model to get the post in question.<span style="font-family: DejaVu Sans;">那就是你刚刚你刚补充的副作用的根源；每个面向</span>comment<span style="font-family: DejaVu Sans;">的请求都保持了它所依附的</span>post<span style="font-family: DejaVu Sans;">的踪迹，因此这样初始化</span>find action<span style="font-family: DejaVu Sans;">的时候匹配相应的</span>post model<span style="font-family: DejaVu Sans;">（时）得到了答案。</span></p>

<p>In addition, the code takes advantage of some of the methods available for an association.<span style="font-family: DejaVu Sans;">此外，上面的代码带来的好处就是使得一些对于</span>association<span style="font-family: DejaVu Sans;">的方法可用。</span>We use the <tt>create</tt> method on <tt>@post.comments</tt> to create and save the comment.<span style="font-family: DejaVu Sans;">我们使用</span><tt>@post.comments</tt><span style="font-family: DejaVu Sans;"><tt>中的</tt></span>create<span style="font-family: DejaVu Sans;">方法来新建和保存</span>comment<span style="font-family: DejaVu Sans;">。</span>This will automatically link the comment so that it belongs to that particular post.<span style="font-family: DejaVu Sans;">这里将会自动连接到</span>link<span style="font-family: DejaVu Sans;">使得</span>comment<span style="font-family: DejaVu Sans;">依附于指定的</span>post<span style="font-family: DejaVu Sans;">。</span></p>

<p>Once we have made the new comment, we send the user back to the original post using the <tt>post_path(@post)</tt> helper.<span style="font-family: DejaVu Sans;">一旦我们评论过后，我们使用</span>post_path(@post)<span style="font-family: DejaVu Sans;">助手导引用户到先前的</span>post<span style="font-family: DejaVu Sans;">。</span>As we have already seen, this calls the <tt>show</tt> action of the <tt>PostsController</tt> which in turn renders the <tt>show.html.erb</tt> template. <span style="font-family: DejaVu Sans;">正如我们已经看到的，这里调用</span>PostsController<span style="font-family: DejaVu Sans;">的</span>show action<span style="font-family: DejaVu Sans;">它将反过来渲染</span><tt>show.html.erb</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>模板。</tt></span>This is where we want the comment to show, so let’s add that to the <tt>app/views/posts/show.html.erb</tt>.<span style="font-family: DejaVu Sans;">这里也是我们想让</span>comment<span style="font-family: DejaVu Sans;">显示的地方，因此让我们添加（那些代码）到</span><tt>app/views/posts/show.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>&lt;p&gt;&lt;%= notice %&gt;&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Name:&lt;/b&gt;</p>

<p>&lt;%= @post.name %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Title:&lt;/b&gt;</p>

<p>&lt;%= @post.title %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Content:&lt;/b&gt;</p>

<p>&lt;%= @post.content %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;h2&gt;Comments&lt;/h2&gt;</p>

<p>&lt;% @post.comments.each do |comment| %&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Commenter:&lt;/b&gt;</p>

<p>&lt;%= comment.commenter %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Comment:&lt;/b&gt;</p>

<p>&lt;%= comment.body %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&nbsp;</p>

<p>&lt;h2&gt;Add a comment:&lt;/h2&gt;</p>

<p>&lt;%= form_for([@post, @post.comments.build]) do |f| %&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.label :commenter %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_field :commenter %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.label :body %&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_area :body %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;div&gt;</p>

<p>&lt;%= f.submit %&gt;</p>

<p>&lt;/div&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&nbsp;</p>

<p>&lt;br /&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= link_to &lsquo;Edit Post&rsquo;, edit_post_path(@post) %&gt; |</p>

<p>&lt;%= link_to &lsquo;Back to Posts&rsquo;, posts_path %&gt; |</p>

<p>Now you can add posts and comments to your blog and have them show up in the right places.<span style="font-family: DejaVu Sans;">现在你可以添加</span>posts<span style="font-family: DejaVu Sans;">和</span>comments<span style="font-family: DejaVu Sans;">到你的</span>blog<span style="font-family: DejaVu Sans;">同时随后他们会在相应的地方显示出来。</span></p>

<h3><a name="refactoring"></a>8 Refactoring<span style="font-family: WenQuanYi Micro Hei;">重构</span></h3>


<p>Now that we have Posts and Comments working, if we take a look at the <tt>app/views/posts/show.html.erb</tt> template, it’s getting long and awkward. <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">现在我们已经有</span></span>Posts<span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">和</span></span>Comments<span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">开始工作了，如果我们注意一下</span></span><tt>app/views/posts/show.html.erb</tt> <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">模板，发现它变得太长而且很别扭。</span></span>We can use partials to clean this up.<span style="font-family: DejaVu Sans;">我们可以使用</span>partials<span style="font-family: DejaVu Sans;">来整理它。</span></p>

<h4><a name="rendering-partial-collections"></a>8.1 Rendering Partial<span style="font-family: WenQuanYi Micro Hei;">（局部）</span>Collections</h4>


<p>First we will make a comment partial to extract showing all the comments for the post. <span style="font-family: DejaVu Sans;">首先我们会创建一个</span>comment partial<span style="font-family: DejaVu Sans;">来专门显示</span>post<span style="font-family: DejaVu Sans;">的所有的</span>comments<span style="font-family: DejaVu Sans;">。</span>Create the file <tt>app/views/comments/<em>comment.html.erb</tt> and put the following into it:<span style="font-family: DejaVu Sans;">创建</span><tt>app/views/comments/</em>comment.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>文件并输入下面的代码：</tt></span></p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Commenter:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>comment.commenter</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Comment:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>comment.body</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p><tt>Then</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>app/views/posts/show.html.erb</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>change</tt><tt> </tt><tt>it</tt><tt> </tt><tt>to</tt><tt> </tt><tt>look</tt><tt> </tt><tt>like</tt><tt> </tt><tt>the</tt><tt> </tt><tt>following:</tt><span style="font-family: DejaVu Sans;"><tt>然后在</tt><tt></tt></span><tt>app/views/posts/show.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>你可以相应的这样更改：</tt></span></p>

<p><code>&lt;p</code><tt> </tt><code>class=&ldquo;notice&rdquo;&gt;&lt;%=</code><tt> </tt><code>notice</code><code> </code><code>%&gt;&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Name:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.name</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Title:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.title</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Content:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.content</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;h2&gt;Comments&lt;/h2&gt;</code></p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>@post.comments</code><code> </code><code>%&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;h2&gt;Add</code><code> </code><code>a</code><code> </code><code>comment:&lt;/h2&gt;</code></p>

<p><code>&lt;%=</code> <code>form_for([@post,</code><code> </code><code>@post.comments.build])</code><code> </code><code>do</code> <code>|f|</code><code> </code><code>%&gt;</code></p>

<p><code> </code><code>&lt;div</code> <code>class=&ldquo;field&rdquo;&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.label</code><code> </code><code>:commenter</code> <code>%&gt;&lt;br</code> <code>/&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.text_field</code><code> </code><code>:commenter</code> <code>%&gt;</code></p>

<p><code> </code><code>&lt;/div&gt;</code></p>

<p><code> </code><code>&lt;div</code> <code>class=&ldquo;field&rdquo;&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.label</code><code> </code><code>:body</code> <code>%&gt;&lt;br</code> <code>/&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.text_area</code><code> </code><code>:body</code> <code>%&gt;</code></p>

<p><code> </code><code>&lt;/div&gt;</code></p>

<p><code> </code><code>&lt;div</code> <code>class=&ldquo;actions&rdquo;&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.submit</code><code> </code><code>%&gt;</code></p>

<p><code> </code><code>&lt;/div&gt;</code></p>

<p><code>&lt;%</code> <code>end</code> <code>%&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;br</code> <code>/&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Edit</code><code> </code><code>Post&rsquo;,</code><code> </code><code>edit_post_path(@post)</code><code> </code><code>%&gt;</code> <code>|</code></p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Back</code><code> </code><code>to</code><code> </code><code>Posts&rsquo;,</code><code> </code><code>posts_path</code><code> </code><code>%&gt;</code> <code>|</code></p>

<p><tt>This</tt><tt> </tt><tt>will</tt><tt> </tt><tt>now</tt><tt> </tt><tt>render</tt><tt> </tt><tt>the</tt><tt> </tt><tt>partial</tt><tt> </tt><tt>in</tt><tt> </tt><tt>app/views/comments/<em>comment.html.erb</tt><tt> </tt><tt>once</tt><tt> </tt><tt>for</tt><tt> </tt><tt>each</tt><tt> </tt><tt>comment</tt><tt> </tt><tt>that</tt><tt> </tt><tt>is</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>@post.comments</tt><tt> </tt><tt>collection.</tt><span style="font-family: DejaVu Sans;"><tt>这里会对</tt></span><tt>@post.comments</tt><span style="font-family: DejaVu Sans;"><tt>的每一个</tt></span><tt>comment</tt><span style="font-family: DejaVu Sans;"><tt>渲染</tt><tt></tt></span><tt>app/views/comments/</em>comment.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>模板。</tt><tt></tt></span><tt>As</tt><tt> </tt><tt>the</tt><tt> </tt><tt>render</tt><tt> </tt><tt>method</tt><tt> </tt><tt>iterates</tt><tt> </tt><tt>over</tt><tt> </tt><tt>the</tt><tt> </tt><tt>@post.comments</tt><tt> </tt><tt>collection,</tt><tt> </tt><tt>it</tt><tt> </tt><tt>assigns</tt><tt> </tt><tt>each</tt><tt> </tt><tt>comment</tt><tt> </tt><tt>to</tt><tt> </tt><tt>a</tt><tt> </tt><tt>local</tt><tt> </tt><tt>variable</tt><tt> </tt><tt>named</tt><tt> </tt><tt>the</tt><tt> </tt><tt>same</tt><tt> </tt><tt>as</tt><tt> </tt><tt>the</tt><tt> </tt><tt>partial,</tt><tt> </tt><tt>in</tt><tt> </tt><tt>this</tt><tt> </tt><tt>case</tt><tt> </tt><tt>comment</tt><tt> </tt><tt>which</tt><tt> </tt><tt>is</tt><tt> </tt><tt>then</tt><tt> </tt><tt>available</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>partial</tt><tt> </tt><tt>for</tt><tt> </tt><tt>us</tt><tt> </tt><tt>to</tt><tt> </tt><tt>show.</tt><span style="font-family: DejaVu Sans;"><tt>当渲染方法迭代</tt></span><tt>@post.comments</tt><span style="font-family: DejaVu Sans;"><tt>收集器的时候，它声明每个</tt></span><tt>comment</tt><span style="font-family: DejaVu Sans;"><tt>为本地变量命名和</tt></span><tt>partial</tt><span style="font-family: DejaVu Sans;"><tt>相同（这里为</tt></span><tt>comment</tt><span style="font-family: DejaVu Sans;"><tt>），通过这样在</tt></span><tt>partial</tt><span style="font-family: DejaVu Sans;"><tt>中的</tt></span><tt>comment</tt><span style="font-family: DejaVu Sans;"><tt>就可以显示给我们的用户了。</tt></span></p>

<h4><a name="rendering-a-partial-form"></a><tt>8.2</tt><tt> </tt><tt>Rendering</tt><tt> </tt><tt>a</tt><tt> </tt><tt>Partial</tt><tt> </tt><tt>Form</tt></h4>


<p><tt>Let</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>also</tt><tt> </tt><tt>move</tt><tt> </tt><tt>that</tt><tt> </tt><tt>new</tt><tt> </tt><tt>comment</tt><tt> </tt><tt>section</tt><tt> </tt><tt>out</tt><tt> </tt><tt>to</tt><tt> </tt><tt>its</tt><tt> </tt><tt>own</tt><tt> </tt><tt>partial.</tt><span style="font-family: DejaVu Sans;"><tt>同样让我们移动</tt></span><tt>new</tt><tt> </tt><tt>comment</tt><span style="font-family: DejaVu Sans;"><tt>部分到它自己的地方吧。</tt><tt></tt></span><tt>Again,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>create</tt><tt> </tt><tt>a</tt><tt> </tt><tt>file</tt><tt> </tt><tt>app/views/comments/<em>form.html.erb</tt><tt> </tt><tt>and</tt><tt> </tt><tt>in</tt><tt> </tt><tt>it</tt><tt> </tt><tt>you</tt><tt> </tt><tt>put:</tt><span style="font-family: DejaVu Sans;"><tt>类似的，创建一个文件</tt><tt></tt></span><tt>app/views/comments/</em>form.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>并且在里面放入下面代码：</tt></span></p>

<p><code>&lt;%=</code><tt> </tt><code>form_for([@post,</code><code> </code><code>@post.comments.build])</code><code> </code><code>do</code><tt> </tt><code>|f|</code><code> </code><code>%&gt;</code></p>

<p><code> </code><code>&lt;div</code> <code>class=&ldquo;field&rdquo;&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.label</code><code> </code><code>:commenter</code> <code>%&gt;&lt;br</code> <code>/&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.text_field</code><code> </code><code>:commenter</code> <code>%&gt;</code></p>

<p><code> </code><code>&lt;/div&gt;</code></p>

<p><code> </code><code>&lt;div</code> <code>class=&ldquo;field&rdquo;&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.label</code><code> </code><code>:body</code> <code>%&gt;&lt;br</code> <code>/&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.text_area</code><code> </code><code>:body</code> <code>%&gt;</code></p>

<p><code> </code><code>&lt;/div&gt;</code></p>

<p><code> </code><code>&lt;div</code> <code>class=&ldquo;actions&rdquo;&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>f.submit</code><code> </code><code>%&gt;</code></p>

<p><code> </code><code>&lt;/div&gt;</code></p>

<p><code>&lt;%</code> <code>end</code> <code>%&gt;</code></p>

<p><tt>Then</tt><tt> </tt><tt>you</tt><tt> </tt><tt>make</tt><tt> </tt><tt>the</tt><tt> </tt><tt>app/views/posts/show.html.erb</tt><tt> </tt><tt>look</tt><tt> </tt><tt>like</tt><tt> </tt><tt>the</tt><tt> </tt><tt>following:</tt><span style="font-family: DejaVu Sans;"><tt>接着你这样修改</tt><tt></tt></span><tt>app/views/posts/show.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>文件：</tt></span></p>

<p><code>&lt;p</code><tt> </tt><code>class=&ldquo;notice&rdquo;&gt;&lt;%=</code><tt> </tt><code>notice</code><code> </code><code>%&gt;&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Name:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.name</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Title:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.title</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Content:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.content</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;h2&gt;Comments&lt;/h2&gt;</code></p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>@post.comments</code><code> </code><code>%&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;h2&gt;Add</code><code> </code><code>a</code><code> </code><code>comment:&lt;/h2&gt;</code></p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>&ldquo;comments/form&rdquo;</code> <code>%&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;br</code> <code>/&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Edit</code><code> </code><code>Post&rsquo;,</code><code> </code><code>edit_post_path(@post)</code><code> </code><code>%&gt;</code> <code>|</code></p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Back</code><code> </code><code>to</code><code> </code><code>Posts&rsquo;,</code><code> </code><code>posts_path</code><code> </code><code>%&gt;</code> <code>|</code></p>

<p><tt>The</tt><tt> </tt><tt>second</tt><tt> </tt><tt>render</tt><tt> </tt><tt>just</tt><tt> </tt><tt>defines</tt><tt> </tt><tt>the</tt><tt> </tt><tt>partial</tt><tt> </tt><tt>template</tt><tt> </tt><tt>we</tt><tt> </tt><tt>want</tt><tt> </tt><tt>to</tt><tt> </tt><tt>render,</tt><tt> </tt><tt>comments/form,</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>is</tt><tt> </tt><tt>smart</tt><tt> </tt><tt>enough</tt><tt> </tt><tt>to</tt><tt> </tt><tt>spot</tt><tt> </tt><tt>the</tt><tt> </tt><tt>forward</tt><tt> </tt><tt>slash</tt><tt> </tt><tt>in</tt><tt> </tt><tt>that</tt><tt> </tt><tt>string</tt><tt> </tt><tt>and</tt><tt> </tt><tt>realize</tt><tt> </tt><tt>that</tt><tt> </tt><tt>you</tt><tt> </tt><tt>want</tt><tt> </tt><tt>to</tt><tt> </tt><tt>render</tt><tt> </tt><tt>the</tt><tt> </tt><tt><em>form.html.erb</tt><tt> </tt><tt>file</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>app/views/comments</tt><tt> </tt><tt>directory.</tt><span style="font-family: DejaVu Sans;"><tt>第二个</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>仅仅定义了一个我们想渲染的</tt></span><tt>partial</tt><tt> </tt><tt>template</tt><tt> </tt><tt>comments/form</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>可以智能的识别字符串代表的含义，并且知道你是想</tt></span><tt>render</tt><tt> </tt><tt></em>form.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>模板。</tt></span></p>

<p>The <tt>@post</tt> object is available to any partials rendered in the view because we defined it as an instance variable.@post<span style="font-family: DejaVu Sans;">可以在任何的视图中</span>partials rendered<span style="font-family: DejaVu Sans;">，因为我们把它定义成的实例变量。</span></p>

<h3><a name="deleting-comments"></a><tt>9</tt><tt> </tt><tt>Deleting</tt><tt> </tt><tt>Comments</tt></h3>


<p>Another important feature on a blog is being able to delete SPAM comments.<span style="font-family: DejaVu Sans;">另一个重要的功能就是可以删除垃圾评论。</span>To do this, we need to implement a link of some sort in the view and a <tt>DELETE</tt> action in the <tt>CommentsController</tt>.<span style="font-family: DejaVu Sans;">要达到这样的效果，我们需要在</span>view<span style="font-family: DejaVu Sans;">中实现某种链接和在</span>CommentsController<span style="font-family: DejaVu Sans;">中的</span>DELETE<span style="font-family: DejaVu Sans;">动作。</span></p>

<p><tt>So</tt><tt> </tt><tt>first,</tt><tt> </tt><tt>let</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>add</tt><tt> </tt><tt>the</tt><tt> </tt><tt>delete</tt><tt> </tt><tt>link</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>app/views/comments/<em>comment.html.erb</tt><tt> </tt><tt>partial:</tt><span style="font-family: DejaVu Sans;"><tt>首先，在</tt></span><tt>app/views/comments/</em>comment.html.erb</tt><tt> </tt><tt>partial</tt><span style="font-family: DejaVu Sans;"><tt>中添加</tt></span><tt>delete</tt><tt> </tt><tt>link</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Commenter:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>comment.commenter</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Comment:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>comment.body</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Destroy</code><code> </code><code>Comment&rsquo;,</code><code> </code><code>[comment.post,</code><code> </code><code>comment],</code></p>

<p><code> </code><code>:confirm</code> <code>=&gt;</code><code> </code><code>&lsquo;Are</code><code> </code><code>you</code><code> </code><code>sure?&rsquo;,</code></p>

<p><code> </code><code>:method</code> <code>=&gt;</code><code> </code><code>:delete</code> <code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>Clicking this new “Destroy Comment” link will fire off a <tt>DELETE</tt><tt> </tt><tt>/posts/:id/comments/:id</tt> to our <tt>CommentsController</tt>, which can then use this to find the comment we want to delete, so let’s add a destroy action to our controller:<span style="font-family: DejaVu Sans;">点击<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>Destroy Comment”<span style="font-family: DejaVu Sans;">，</span>link<span style="font-family: DejaVu Sans;">将会发送</span><tt>DELETE</tt><tt> </tt><tt>/posts/:id/comments/:id</tt><span style="font-family: DejaVu Sans;"><tt>到我们的</tt></span><tt>CommentsController</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>CommentsController</tt><span style="font-family: DejaVu Sans;"><tt>将会利用刚刚收到的（消息）找到我们想删除哪条评论，因此让我们接着添加一个</tt></span><tt>destroy</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>到我们的</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><code>class</code><tt> </tt><code>CommentsController</code><code> </code><code>&lt;</code><code> </code><code>ApplicationController</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>create</code></p>

<p><code> </code><code>@post</code> <code>=</code><code> </code><code>Post.find(params[:post_id])</code></p>

<p><code> </code><code>@comment</code> <code>=</code><code> </code><code>@post.comments.create(params[:comment])</code></p>

<p><code> </code><code>redirect_to</code><code> </code><code>post_path(@post)</code></p>

<p><code> </code><code>end</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>destroy</code></p>

<p><code> </code><code>@post</code> <code>=</code><code> </code><code>Post.find(params[:post_id])</code></p>

<p><code> </code><code>@comment</code> <code>=</code><code> </code><code>@post.comments.find(params[:id])</code></p>

<p><code> </code><code>@comment.destroy</code></p>

<p><code> </code><code>redirect_to</code><code> </code><code>post_path(@post)</code></p>

<p><code> </code><code>end</code></p>

<p>&nbsp;</p>

<p><code>end</code></p>

<p><tt>The</tt><tt> </tt><tt>destroy</tt><tt> </tt><tt>action</tt><tt> </tt><tt>will</tt><tt> </tt><tt>find</tt><tt> </tt><tt>the</tt><tt> </tt><tt>post</tt><tt> </tt><tt>we</tt><tt> </tt><tt>are</tt><tt> </tt><tt>looking</tt><tt> </tt><tt>at,</tt><tt> </tt><tt>locate</tt><tt> </tt><tt>the</tt><tt> </tt><tt>comment</tt><tt> </tt><tt>within</tt><tt> </tt><tt>the</tt><tt> </tt><tt>@post.comments</tt><tt> </tt><tt>collection,</tt><tt> </tt><tt>and</tt><tt> </tt><tt>then</tt><tt> </tt><tt>remove</tt><tt> </tt><tt>it</tt><tt> </tt><tt>from</tt><tt> </tt><tt>the</tt><tt> </tt><tt>database</tt><tt> </tt><tt>and</tt><tt> </tt><tt>send</tt><tt> </tt><tt>us</tt><tt> </tt><tt>back</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>show</tt><tt> </tt><tt>action</tt><tt> </tt><tt>for</tt><tt> </tt><tt>the</tt><tt> </tt><tt>post.destroy</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>将会找到那个我们正在阅读的</tt></span><tt>post</tt><span style="font-family: DejaVu Sans;"><tt>，并且定位</tt></span><tt>comment</tt><span style="font-family: DejaVu Sans;"><tt>在</tt></span><tt>@post.comments</tt><span style="font-family: DejaVu Sans;"><tt>收集器，然后从数据库</tt></span><tt>remove</tt><span style="font-family: DejaVu Sans;"><tt>它，最后传回到</tt></span><tt>post</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>show</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="deleting-associated-objects"></a><tt>9.1</tt><tt> </tt><tt>Deleting</tt><tt> </tt><tt>Associated</tt><tt> </tt><tt>Objects</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>删除关联对象</tt></span></h4>


<p><a name="deleting-associated-objects1"></a>If you delete a post then its associated comments will also need to be deleted. <span style="font-family: DejaVu Sans;">如果你删除一个了</span>post<span style="font-family: DejaVu Sans;">，那么与之相关联的</span>comments<span style="font-family: DejaVu Sans;">也需要被删除。</span>Otherwise they would simply occupy space in the database.<span style="font-family: DejaVu Sans;">否则他们将会只是在数据库中占用空间（别无它用）。</span>Rails allows you to use the <tt>dependent</tt> option of an association to achieve this. Modify the Post model, <tt>app/models/post.rb</tt>, as follows:Rails<span style="font-family: DejaVu Sans;">允许你通过关系的依赖选项完成（上述功能）。修改</span>Post model<span style="font-family: DejaVu Sans;">。</span></p>

<p><code>class</code> <code>Post</code><code> </code><code>&lt;</code><code> </code><code>ActiveRecord::Base</code></p>

<p><code> </code><code>validates</code><code> </code><code>:name,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true</code></p>

<p><code> </code><code>validates</code><code> </code><code>:title,</code><code> </code><code>:presence</code> <code>=&gt;</code><code> </code><code>true,</code></p>

<p><code> </code><code>:length</code> <code>=&gt;</code><code> </code><code>{</code><code> </code><code>:minimum</code> <code>=&gt;</code><code> </code><code>5</code> <code>}</code></p>

<p><code> </code><code>has_many</code><code> </code><code>:comments,</code><code> </code><code>:dependent</code> <code>=&gt;</code><code> </code><code>:destroy</code></p>

<p><code>end</code></p>

<h3><a name="security"></a>10 Security</h3>


<p>If you were to publish your blog online, anybody would be able to add, edit and delete posts or delete comments.<span style="font-family: DejaVu Sans;">如果你就这样</span>publish<span style="font-family: DejaVu Sans;">你的</span>blog<span style="font-family: DejaVu Sans;">在互联网，任何人都可以添加，编辑和删除</span>post<span style="font-family: DejaVu Sans;">或者删除</span>comments<span style="font-family: DejaVu Sans;">。</span></p>

<p>Rails provides a very simple HTTP authentication system that will work nicely in this situation.Rails<span style="font-family: DejaVu Sans;">提供了一个非常简单的</span>HTTP<span style="font-family: DejaVu Sans;">认证系统在这样的情况下会非常适合。</span></p>

<p>In the <tt>PostsController</tt> we need to have a way to block access to the various actions if the person is not authenticated, here we can use the Rails <tt>http_basic_authenticate_with</tt> method, allowing access to the requested action if that method allows it.<span style="font-family: DejaVu Sans;">在</span><tt>PostsController</tt><span style="font-family: DejaVu Sans;"><tt>中我们需要一个方法来阻止没有通过认证的用户的操作，这里我们可以使用</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>的</tt><tt></tt></span><tt>http_basic_authenticate_with</tt><span style="font-family: DejaVu Sans;"><tt>这个方法，准许方法允许的请求的</tt></span><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>To use the authentication system, we specify it at the top of our <tt>PostsController</tt>, in this case, we want the user to be authenticated on every action, except for <tt>index</tt> and <tt>show</tt>, so we write that:<span style="font-family: DejaVu Sans;">要是用这个认证系统，我们需要在</span><tt>PostsController</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>的顶部</tt>在指定（即引用）它，这样我们希望用户在进行每个</span>action<span style="font-family: DejaVu Sans;">的时候都是通过授权的，除了</span>index<span style="font-family: DejaVu Sans;">和</span>show<span style="font-family: DejaVu Sans;">，因此我们这样写：</span></p>

<p><code>class</code> <code>PostsController</code><code> </code><code>&lt;</code><code> </code><code>ApplicationController</code></p>

<p>&nbsp;</p>

<p><code> </code><code>http_basic_authenticate_with</code><code> </code><code>:name</code> <code>=&gt;</code><code> </code><code>&ldquo;dhh&rdquo;,</code><code> </code><code>:password</code> <code>=&gt;</code><code> </code><code>&ldquo;secret&rdquo;,</code><code> </code><code>:except</code> <code>=&gt;</code><code> </code><code>:index</code></p>

<p>&nbsp;</p>

<p><code> </code><code>#</code><code> </code><code>GET</code><code> </code><code>/posts</code></p>

<p><code> </code><code>#</code><code> </code><code>GET</code><code> </code><code>/posts.json</code></p>

<p><code> </code><code>def</code> <code>index</code></p>

<p><code> </code><code>@posts</code> <code>=</code><code> </code><code>Post.all</code></p>

<p>We also only want to allow authenticated users to delete comments, so in the <tt>CommentsController</tt> we write:<span style="font-family: DejaVu Sans;">我们同样希望只有授权用户能够删除评论，因此在</span><tt>CommentsController</tt><span style="font-family: DejaVu Sans;"><tt>这样写：</tt></span></p>

<p><code>class</code><tt> </tt><code>CommentsController</code><code> </code><code>&lt;</code><code> </code><code>ApplicationController</code></p>

<p>&nbsp;</p>

<p><code> </code><code>http_basic_authenticate_with</code><code> </code><code>:name</code> <code>=&gt;</code><code> </code><code>&ldquo;dhh&rdquo;,</code><code> </code><code>:password</code> <code>=&gt;</code><code> </code><code>&ldquo;secret&rdquo;,</code><code> </code><code>:only</code> <code>=&gt;</code><code> </code><code>:destroy</code></p>

<p>&nbsp;</p>

<p><code> </code><code>def</code> <code>create</code></p>

<p><code> </code><code>@post</code> <code>=</code><code> </code><code>Post.find(params[:post_id])</code></p>

<p><tt>Now</tt><tt> </tt><tt>if</tt><tt> </tt><tt>you</tt><tt> </tt><tt>try</tt><tt> </tt><tt>to</tt><tt> </tt><tt>create</tt><tt> </tt><tt>a</tt><tt> </tt><tt>new</tt><tt> </tt><tt>post,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>will</tt><tt> </tt><tt>be</tt><tt> </tt><tt>greeted</tt><tt> </tt><tt>with</tt><tt> </tt><tt>a</tt><tt> </tt><tt>basic</tt><tt> </tt><tt>HTTP</tt><tt> </tt><tt>Authentication</tt><tt> </tt><tt>challenge.</tt><span style="font-family: DejaVu Sans;"><tt>现在如果你尝试创建一个新的</tt></span><tt>post</tt><span style="font-family: DejaVu Sans;"><tt>，你将会迎来一个基于</tt></span><tt>HTTP</tt><span style="font-family: DejaVu Sans;"><tt>认证的挑战。</tt></span></p>

<h3><a name="building-a-multi-model-form"></a>11 Building a Multi-Model Form<span style="font-family: WenQuanYi Micro Hei;">构建一个多模型表单</span></h3>


<p>Another feature of your average blog is the ability to tag posts. To implement this feature your application needs to interact with more than one model on a single form. Rails offers support for nested forms.<span style="font-family: DejaVu Sans;">另一个功能你的平衡的</span>blog<span style="font-family: DejaVu Sans;">是能够给</span>posts<span style="font-family: DejaVu Sans;">添加</span>tag<span style="font-family: DejaVu Sans;">。要想在你的程序中实现这个功能需要在一个</span>form<span style="font-family: DejaVu Sans;">中与超过一个</span>model<span style="font-family: DejaVu Sans;">互动。</span>Rails<span style="font-family: DejaVu Sans;">提供了嵌套</span>forms<span style="font-family: DejaVu Sans;">。</span></p>

<p>To demonstrate this, we will add support for giving each post multiple tags, right in the form where you create the post. First, create a new model to hold the tags:<span style="font-family: DejaVu Sans;">为了演示这个（功能），你将会在你创建</span>post<span style="font-family: DejaVu Sans;">的</span>form<span style="font-family: DejaVu Sans;">中添加</span>post<span style="font-family: DejaVu Sans;">的多</span>tag<span style="font-family: DejaVu Sans;">支持。首先创建一个</span>new model<span style="font-family: DejaVu Sans;">来存放</span>tags<span style="font-family: DejaVu Sans;">：</span></p>

<p><code>$</code><code> </code><code>rails</code><code> </code><code>generate</code><code> </code><code>model</code><code> </code><code>tag</code><code> </code><code>name:string</code><code> </code><code>post:references</code></p>

<p>Again, run the migration to create the database table:<span style="font-family: DejaVu Sans;">再次运行</span>migration<span style="font-family: DejaVu Sans;">来创建数据库表单：</span></p>

<p><code>$</code><code> </code><code>rake</code><code> </code><code>db:migrate</code></p>

<p>Next, edit the <tt>post.rb</tt> file to create the other side of the association, and to tell Rails (via the <tt>accepts_nested_attributes_for</tt> macro) that you intend to edit tags via posts:<span style="font-family: DejaVu Sans;">接下来：编辑</span>post.rb<span style="font-family: DejaVu Sans;">文件来创建来创建另一个成员，并且告诉</span>Rails<span style="font-family: DejaVu Sans;">（通过</span>the <tt>accepts_nested_attributes_for</tt> <span style="font-family: DejaVu Sans;">宏）你打算通过</span>posts form<span style="font-family: DejaVu Sans;">来编辑</span>tags<span style="font-family: DejaVu Sans;">。</span></p>

<p>class Post &lt; ActiveRecord::Base</p>

<p>validates :name, :presence =&gt; true</p>

<p>validates :title, :presence =&gt; true</p>

<p>validates :content,:presence =&gt; true,</p>

<p>:length =&gt; { :minimum =&gt; 5 }</p>

<p>&nbsp;</p>

<p>has_many :comments, :dependent =&gt; :destroy</p>

<p>has_many :tags</p>

<p>&nbsp;</p>

<p>accepts_nested_attributes_for :tags, :allow_destroy =&gt; :true,</p>

<p>:reject_if =&gt; proc { |attrs| attrs.all? { |k, v| v.blank? } }</p>

<p>end</p>

<p><tt>The</tt><tt> </tt><tt>:allow_destroy</tt><tt> </tt><tt>option</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>nested</tt><tt> </tt><tt>attribute</tt><tt> </tt><tt>declaration</tt><tt> </tt><tt>tells</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>to</tt><tt> </tt><tt>display</tt><tt> </tt><tt>a</tt><tt> “</tt><tt>remove</tt><tt>” </tt><tt>checkbox</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>view</tt><tt> </tt><tt>that</tt><tt> </tt><tt>you</tt><tt>’</tt><tt>ll</tt><tt> </tt><tt>build</tt><tt> </tt><tt>shortly.</tt><span style="font-family: DejaVu Sans;"><tt>对于</tt></span><tt>:allow_destroy</tt><span style="font-family: DejaVu Sans;"><tt>嵌套属性的声明是告诉</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>显示一个</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></tt></span><tt>remove</tt><tt>”</tt><span style="font-family: DejaVu Sans;"><tt>复选框在视图中那样你可以快速创建（</tt></span><tt>tags</tt><span style="font-family: DejaVu Sans;"><tt>）。</tt><tt></tt></span><tt>The</tt><tt> </tt><tt>:reject_if</tt><tt> </tt><tt>option</tt><tt> </tt><tt>prevents</tt><tt> </tt><tt>saving</tt><tt> </tt><tt>new</tt><tt> </tt><tt>tags</tt><tt> </tt><tt>that</tt><tt> </tt><tt>do</tt><tt> </tt><tt>not</tt><tt> </tt><tt>have</tt><tt> </tt><tt>any</tt><tt> </tt><tt>attributes</tt><tt> </tt><tt>filled</tt><tt> </tt><tt>in.</tt><span style="font-family: DejaVu Sans;"><tt>对于</tt></span><tt>:reject_if</tt><span style="font-family: DejaVu Sans;"><tt>保证不保存没有任何内容的</tt></span><tt>tags</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>We</tt><tt> </tt><tt>will</tt><tt> </tt><tt>modify</tt><tt> </tt><tt>views/posts/<em>form.html.erb</tt><tt> </tt><tt>to</tt><tt> </tt><tt>render</tt><tt> </tt><tt>a</tt><tt> </tt><tt>partial</tt><tt> </tt><tt>to</tt><tt> </tt><tt>make</tt><tt> </tt><tt>a</tt><tt> </tt><tt>tag:</tt><span style="font-family: DejaVu Sans;"><tt>我们将要修改</tt><tt></tt></span><tt>views/posts/</em>form.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>来</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>（</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>的）一部分来创建</tt></span><tt>tag</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><tt>&lt;%</tt><tt> </tt><tt>@post.tags.build</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>form_for(@post)</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|post_form|</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;%</tt><tt> </tt><tt>if</tt><tt> </tt><tt>@post.errors.any?</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;div</tt><tt> </tt><tt>id=&ldquo;errorExplanation&rdquo;&gt;</tt></p>

<p><tt> </tt><tt>&lt;h2&gt;&lt;%=</tt><tt> </tt><tt>pluralize(@post.errors.count,</tt><tt> </tt><tt>&ldquo;error&rdquo;)</tt><tt> </tt><tt>%&gt;</tt><tt> </tt><tt>prohibited</tt><tt> </tt><tt>this</tt><tt> </tt><tt>post</tt><tt> </tt><tt>from</tt><tt> </tt><tt>being</tt><tt> </tt><tt>saved:&lt;/h2&gt;</tt></p>

<p><tt> </tt><tt>&lt;ul&gt;</tt></p>

<p><tt> </tt><tt>&lt;%</tt><tt> </tt><tt>@post.errors.full_messages.each</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|msg|</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;li&gt;&lt;%=</tt><tt> </tt><tt>msg</tt><tt> </tt><tt>%&gt;&lt;/li&gt;</tt></p>

<p><tt> </tt><tt>&lt;%</tt><tt> </tt><tt>end</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;/ul&gt;</tt></p>

<p><tt> </tt><tt>&lt;/div&gt;</tt></p>

<p><tt> </tt><tt>&lt;%</tt><tt> </tt><tt>end</tt><tt> </tt><tt>%&gt;</tt></p>

<p>&nbsp;</p>

<p><tt> </tt><tt>&lt;div</tt><tt> </tt><tt>class=&ldquo;field&rdquo;&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>post_form.label</tt><tt> </tt><tt>:name</tt><tt> </tt><tt>%&gt;&lt;br</tt><tt> </tt><tt>/&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>post_form.text_field</tt><tt> </tt><tt>:name</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;/div&gt;</tt></p>

<p><tt> </tt><tt>&lt;div</tt><tt> </tt><tt>class=&ldquo;field&rdquo;&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>post_form.label</tt><tt> </tt><tt>:title</tt><tt> </tt><tt>%&gt;&lt;br</tt><tt> </tt><tt>/&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>post_form.text_field</tt><tt> </tt><tt>:title</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;/div&gt;</tt></p>

<p><tt> </tt><tt>&lt;div</tt><tt> </tt><tt>class=&ldquo;field&rdquo;&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>post_form.label</tt><tt> </tt><tt>:content</tt><tt> </tt><tt>%&gt;&lt;br</tt><tt> </tt><tt>/&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>post_form.text_area</tt><tt> </tt><tt>:content</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;/div&gt;</tt></p>

<p><tt> </tt><tt>&lt;h2&gt;Tags&lt;/h2&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>render</tt><tt> </tt><tt>:partial</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&lsquo;tags/form&rsquo;,</tt></p>

<p><tt> </tt><tt>:locals</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>{:form</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>post_form}</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;div</tt><tt> </tt><tt>class=&ldquo;actions&rdquo;&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>post_form.submit</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;/div&gt;</tt></p>

<p><tt>&lt;%</tt><tt> </tt><tt>end</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt>Note</tt><tt> </tt><tt>that</tt><tt> </tt><tt>we</tt><tt> </tt><tt>have</tt><tt> </tt><tt>changed</tt><tt> </tt><tt>the</tt><tt> </tt><tt>f</tt><tt> </tt><tt>in</tt><tt> </tt><tt>form_for(@post)</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|f|</tt><tt> </tt><tt>to</tt><tt> </tt><tt>post_form</tt><tt> </tt><tt>to</tt><tt> </tt><tt>make</tt><tt> </tt><tt>it</tt><tt> </tt><tt>easier</tt><tt> </tt><tt>to</tt><tt> </tt><tt>understand</tt><tt> </tt><tt>what</tt><tt> </tt><tt>is</tt><tt> </tt><tt>going</tt><tt> </tt><tt>on.</tt><span style="font-family: DejaVu Sans;"><tt>注意：我们已经更改</tt></span><code>form_for(@post)</code><code> </code><code>do</code><code> </code><code>|f|</code><span style="font-family: DejaVu Sans;"><tt>为</tt></span><code>form_for(@post)</code><code> </code><code>do</code><tt> </tt><code>|post_form|</code><span style="font-family: DejaVu Sans;"><code>这样会更加容易明白是怎么回事。</code></span></p>

<p><code>This</code><code> </code><code>example</code><code> </code><code>shows</code><code> </code><code>another</code><code> </code><code>option</code><code> </code><code>of</code><code> </code><code>the</code><code> </code><code>render</code><code> </code><code>helper,</code><code> </code><code>being</code><code> </code><code>able</code><code> </code><code>to</code><code> </code><code>pass</code><code> </code><code>in</code><code> </code><code>local</code><code> </code><code>variables,</code><code> </code><code>in</code><code> </code><code>this</code><code> </code><code>case,</code><code> </code><code>we</code><code> </code><code>want</code><code> </code><code>the</code><code> </code><code>local</code><code> </code><code>variable</code><code> </code><tt>form</tt><code> </code><code>in</code><code> </code><code>the</code><code> </code><code>partial</code><code> </code><code>to</code><code> </code><code>refer</code><code> </code><code>to</code><code> </code><code>the</code><code> </code><tt>post_form</tt><code> </code><code>object.</code><span style="font-family: DejaVu Sans;"><code>这个例子在</code></span><code>render</code><code> </code><code>helper</code><span style="font-family: DejaVu Sans;"><code>中使用另个方式（使用</code></span><code>f</code><span style="font-family: DejaVu Sans;"><code>），是为了说明我们希望的是在</code></span><code>form</code><span style="font-family: DejaVu Sans;"><code>中使用局部变量指向的</code></span><code>post_form</code><span style="font-family: DejaVu Sans;"><code>对象。</code></span></p>

<p><tt>We</tt><tt> </tt><tt>also</tt><tt> </tt><tt>add</tt><tt> </tt><tt>a</tt><tt> </tt><tt>@post.tags.build</tt><tt> </tt><tt>at</tt><tt> </tt><tt>the</tt><tt> </tt><tt>top</tt><tt> </tt><tt>of</tt><tt> </tt><tt>this</tt><tt> </tt><tt>form.</tt><tt> </tt><tt>This</tt><tt> </tt><tt>is</tt><tt> </tt><tt>to</tt><tt> </tt><tt>make</tt><tt> </tt><tt>sure</tt><tt> </tt><tt>there</tt><tt> </tt><tt>is</tt><tt> </tt><tt>a</tt><tt> </tt><tt>new</tt><tt> </tt><tt>tag</tt><tt> </tt><tt>ready</tt><tt> </tt><tt>to</tt><tt> </tt><tt>have</tt><tt> </tt><tt>its</tt><tt> </tt><tt>name</tt><tt> </tt><tt>filled</tt><tt> </tt><tt>in</tt><tt> </tt><tt>by</tt><tt> </tt><tt>the</tt><tt> </tt><tt>user.</tt><tt> </tt><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>do</tt><tt> </tt><tt>not</tt><tt> </tt><tt>build</tt><tt> </tt><tt>the</tt><tt> </tt><tt>new</tt><tt> </tt><tt>tag,</tt><tt> </tt><tt>then</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>will</tt><tt> </tt><tt>not</tt><tt> </tt><tt>appear</tt><tt> </tt><tt>as</tt><tt> </tt><tt>there</tt><tt> </tt><tt>is</tt><tt> </tt><tt>no</tt><tt> </tt><tt>new</tt><tt> </tt><tt>Tag</tt><tt> </tt><tt>object</tt><tt> </tt><tt>ready</tt><tt> </tt><tt>to</tt><tt> </tt><tt>create.</tt><span style="font-family: DejaVu Sans;"><tt>我们还在</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>的顶部添加</tt></span><tt>@post.tags.build</tt><span style="font-family: DejaVu Sans;"><tt>。这里是为了确保每个新的</tt></span><tt>tag</tt><span style="font-family: DejaVu Sans;"><tt>都被用户填上了</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>。如果你不创建新</tt></span><tt>tag</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>将不会显示它。</tt></span></p>

<p><tt>Now</tt><tt> </tt><tt>create</tt><tt> </tt><tt>the</tt><tt> </tt><tt>folder</tt><tt> </tt><tt>app/views/tags</tt><tt> </tt><tt>and</tt><tt> </tt><tt>make</tt><tt> </tt><tt>a</tt><tt> </tt><tt>file</tt><tt> </tt><tt>in</tt><tt> </tt><tt>there</tt><tt> </tt><tt>called</tt><tt> </tt><tt><em>form.html.erb</tt><tt> </tt><tt>which</tt><tt> </tt><tt>contains</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>for</tt><tt> </tt><tt>the</tt><tt> </tt><tt>tag:</tt><span style="font-family: DejaVu Sans;"><tt>现在创建一个</tt><tt></tt></span><tt>app/views/tags</tt><span style="font-family: DejaVu Sans;"><tt>文件夹并且在里面新建一个</tt></span><tt></em>form.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>包含以下内容：</tt></span></p>

<p><code>&lt;%=</code><tt> </tt><code>form.fields_for</code><code> </code><code>:tags</code><tt> </tt><code>do</code><tt> </tt><code>|tag_form|</code><code> </code><code>%&gt;</code></p>

<p><code> </code><code>&lt;div</code> <code>class=&ldquo;field&rdquo;&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>tag_form.label</code><code> </code><code>:name,</code><code> </code><code>&lsquo;Tag:&rsquo;</code> <code>%&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>tag_form.text_field</code><code> </code><code>:name</code> <code>%&gt;</code></p>

<p><code> </code><code>&lt;/div&gt;</code></p>

<p><code> </code><code>&lt;%</code> <code>unless</code> <code>tag_form.object.nil?</code><code> </code><code>||</code><code> </code><code>tag_form.object.new_record?</code><code> </code><code>%&gt;</code></p>

<p><code> </code><code>&lt;div</code> <code>class=&ldquo;field&rdquo;&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>tag_form.label</code><code> </code><code>:_destroy,</code><code> </code><code>&lsquo;Remove:&rsquo;</code> <code>%&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>tag_form.check_box</code><code> </code><code>:_destroy</code><code> </code><code>%&gt;</code></p>

<p><code> </code><code>&lt;/div&gt;</code></p>

<p><code> </code><code>&lt;%</code> <code>end</code> <code>%&gt;</code></p>

<p><code>&lt;%</code> <code>end</code> <code>%&gt;</code></p>

<p><tt>Finally,</tt><tt> </tt><tt>we</tt><tt> </tt><tt>will</tt><tt> </tt><tt>edit</tt><tt> </tt><tt>the</tt><tt> </tt><tt>app/views/posts/show.html.erb</tt><tt> </tt><tt>template</tt><tt> </tt><tt>to</tt><tt> </tt><tt>show</tt><tt> </tt><tt>our</tt><tt> </tt><tt>tags.</tt><span style="font-family: DejaVu Sans;"><tt>最后编辑</tt></span><tt>app/views/posts/show.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>模板显示我们的</tt></span><tt>tags</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><code>&lt;p</code><tt> </tt><code>class=&ldquo;notice&rdquo;&gt;&lt;%=</code><tt> </tt><code>notice</code><code> </code><code>%&gt;&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Name:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.name</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Title:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.title</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Content:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.content</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Tags:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.tags.map</code><code> </code><code>{</code><code> </code><code>|t|</code><code> </code><code>t.name</code><code> </code><code>}.join(&ldquo;,</code><code> </code><code>&rdquo;)</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;h2&gt;Comments&lt;/h2&gt;</code></p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>@post.comments</code><code> </code><code>%&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;h2&gt;Add</code><code> </code><code>a</code><code> </code><code>comment:&lt;/h2&gt;</code></p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>&ldquo;comments/form&rdquo;</code> <code>%&gt;</code></p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Edit</code><code> </code><code>Post&rsquo;,</code><code> </code><code>edit_post_path(@post)</code><code> </code><code>%&gt;</code> <code>|</code></p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Back</code><code> </code><code>to</code><code> </code><code>Posts&rsquo;,</code><code> </code><code>posts_path</code><code> </code><code>%&gt;</code> <code>|</code></p>

<p><tt>With</tt><tt> </tt><tt>these</tt><tt> </tt><tt>changes</tt><tt> </tt><tt>in</tt><tt> </tt><tt>place,</tt><tt> </tt><tt>you</tt><tt>’</tt><tt>ll</tt><tt> </tt><tt>find</tt><tt> </tt><tt>that</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>edit</tt><tt> </tt><tt>a</tt><tt> </tt><tt>post</tt><tt> </tt><tt>and</tt><tt> </tt><tt>its</tt><tt> </tt><tt>tags</tt><tt> </tt><tt>directly</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>same</tt><tt> </tt><tt>view.</tt><span style="font-family: DejaVu Sans;"><tt>通过这写修改，你会发现你可以直接在</tt></span><tt>post</tt><tt> </tt><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>中编辑</tt></span><tt>tags</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>However, that method call <tt>@post.tags.map</tt><tt> </tt><tt>{</tt><tt> </tt><tt>|t|</tt><tt> </tt><tt>t.name</tt><tt> </tt><tt>}.join(&ldquo;,</tt><tt> </tt><tt>&rdquo;)</tt> is awkward, we could handle this by making a helper method.<span style="font-family: DejaVu Sans;">另外，</span><tt>@post.tags.map</tt><tt> </tt><tt>{</tt><tt> </tt><tt>|t|</tt><tt> </tt><tt>t.name</tt><tt> </tt><tt>}.join(&ldquo;,</tt><tt> </tt><tt>&rdquo;)</tt><span style="font-family: DejaVu Sans;"><tt>这个方法很别扭，我们可以通过编写一个</tt></span><tt>helper</tt><tt> </tt><tt>method</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>###</tt><span style="font-family: DejaVu Sans;"><tt>上面都还只能一次创建一个</tt></span><tt>tag</tt><span style="font-family: DejaVu Sans;"><tt>在</tt></span><tt>post</tt><tt> </tt><tt>form</tt></p>

<h3><a name="view-helpers"></a><tt>12</tt><tt> </tt><tt>View</tt><tt> </tt><tt>Helpers</tt></h3>


<p><tt>View</tt><tt> </tt><tt>Helpers</tt><tt> </tt><tt>live</tt><tt> </tt><tt>in</tt><tt> </tt><tt>app/helpers</tt><tt> </tt><tt>and</tt><tt> </tt><tt>provide</tt><tt> </tt><tt>small</tt><tt> </tt><tt>snippets</tt><tt> </tt><tt>of</tt><tt> </tt><tt>reusable</tt><tt> </tt><tt>code</tt><tt> </tt><tt>for</tt><tt> </tt><tt>views.View</tt><tt> </tt><tt>Helpers</tt><span style="font-family: DejaVu Sans;"><tt>放置在</tt></span><tt>app/helpers</tt><span style="font-family: DejaVu Sans;"><tt>，它提供了可重用的小代码片段给</tt></span><tt>view</tt><span style="font-family: DejaVu Sans;"><tt>。</tt><tt></tt></span><tt>In</tt><tt> </tt><tt>our</tt><tt> </tt><tt>case,</tt><tt> </tt><tt>we</tt><tt> </tt><tt>want</tt><tt> </tt><tt>a</tt><tt> </tt><tt>method</tt><tt> </tt><tt>that</tt><tt> </tt><tt>strings</tt><tt> </tt><tt>a</tt><tt> </tt><tt>bunch</tt><tt> </tt><tt>of</tt><tt> </tt><tt>objects</tt><tt> </tt><tt>together</tt><tt> </tt><tt>using</tt><tt> </tt><tt>their</tt><tt> </tt><tt>name</tt><tt> </tt><tt>attribute</tt><tt> </tt><tt>and</tt><tt> </tt><tt>joining</tt><tt> </tt><tt>them</tt><tt> </tt><tt>with</tt><tt> </tt><tt>a</tt><tt> </tt><tt>comma.</tt><span style="font-family: DejaVu Sans;"><tt>在本例，我们想要一个方法把（</tt></span><tt>tag</tt><span style="font-family: DejaVu Sans;"><tt>）放在一起（一个字符串中），并且使用逗号分割。</tt><tt></tt></span><tt>As</tt><tt> </tt><tt>this</tt><tt> </tt><tt>is</tt><tt> </tt><tt>for</tt><tt> </tt><tt>the</tt><tt> </tt><tt>Post</tt><tt> </tt><tt>show</tt><tt> </tt><tt>template,</tt><tt> </tt><tt>we</tt><tt> </tt><tt>put</tt><tt> </tt><tt>it</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>PostsHelper.</tt><span style="font-family: DejaVu Sans;"><tt>要想这样在</tt></span><tt>Post</tt><tt> </tt><tt>show</tt><span style="font-family: DejaVu Sans;"><tt>模板，我们在</tt></span><tt>PostHelper</tt><span style="font-family: DejaVu Sans;"><tt>中写入：</tt></span></p>

<p><tt>Now</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>edit</tt><tt> </tt><tt>the</tt><tt> </tt><tt>view</tt><tt> </tt><tt>in</tt><tt> </tt><tt>app/views/posts/show.html.erb</tt><tt> </tt><tt>to</tt><tt> </tt><tt>look</tt><tt> </tt><tt>like</tt><tt> </tt><tt>this:</tt><span style="font-family: DejaVu Sans;"><tt>现在你可以在</tt><tt></tt></span><tt>app/views/posts/show.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>中更改：</tt></span></p>

<p><code>&lt;p</code><tt> </tt><code>class=&ldquo;notice&rdquo;&gt;&lt;%=</code><tt> </tt><code>notice</code><code> </code><code>%&gt;&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Name:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.name</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Title:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.title</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Content:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>@post.content</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;p&gt;</code></p>

<p><code> </code><code>&lt;b&gt;Tags:&lt;/b&gt;</code></p>

<p><code> </code><code>&lt;%=</code> <code>join_tags(@post)</code><code> </code><code>%&gt;</code></p>

<p><code>&lt;/p&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;h2&gt;Comments&lt;/h2&gt;</code></p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>@post.comments</code><code> </code><code>%&gt;</code></p>

<p>&nbsp;</p>

<p><code>&lt;h2&gt;Add</code><code> </code><code>a</code><code> </code><code>comment:&lt;/h2&gt;</code></p>

<p><code>&lt;%=</code> <code>render</code><code> </code><code>&ldquo;comments/form&rdquo;</code> <code>%&gt;</code></p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Edit</code><code> </code><code>Post&rsquo;,</code><code> </code><code>edit_post_path(@post)</code><code> </code><code>%&gt;</code> <code>|</code></p>

<p><code>&lt;%=</code> <code>link_to</code><code> </code><code>&lsquo;Back</code><code> </code><code>to</code><code> </code><code>Posts&rsquo;,</code><code> </code><code>posts_path</code><code> </code><code>%&gt;</code> <code>|</code></p>

<h3><a name="what-s-next"></a>13 What’s Next?<span style="font-family: WenQuanYi Micro Hei;">接下来做什么呢？</span></h3>


<p>Now that you’ve seen your first Rails application, you should feel free to update it and experiment on your own. But you don’t have to do everything without help.<span style="font-family: DejaVu Sans;">现在你已经看到了你的第一个</span>Rails<span style="font-family: DejaVu Sans;">应用程序，你应该可以很轻松的继续更新它或者试验一下你的想法。</span>As you need assistance getting up and running with Rails, feel free to consult these support resources:<span style="font-family: DejaVu Sans;">当你在更新和运行</span>Rails<span style="font-family: DejaVu Sans;">的时候需要援助，咨询下面推荐的资源会让你感到轻松：</span></p>

<ul>
    <li>The <a href="http://guides.rubyonrails.org/index.html"><span style="color: #000080;"><span style="text-decoration: underline;">Ruby</span></span><span style="color: #000080;"><span style="text-decoration: underline;">on</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">guides</span></span></a></li>
    <li>The <a href="http://railstutorial.org/book"><span style="color: #000080;"><span style="text-decoration: underline;">Ruby</span></span><span style="color: #000080;"><span style="text-decoration: underline;">on</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Tutorial</span></span></a></li>
    <li>The <a href="http://groups.google.com/group/rubyonrails-talk"><span style="color: #000080;"><span style="text-decoration: underline;">Ruby</span></span><span style="color: #000080;"><span style="text-decoration: underline;">on</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">mailing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">list</span></span></a></li>
    <li>The <span style="color: #000080;"><span style="text-decoration: underline;"><a href="irc://irc.freenode.net/#rubyonrails">#rubyonrails</a></span></span> channel on irc.freenode.net</li>
    <li>The <a href="http://wiki.rubyonrails.org/"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Wiki</span></span></a></li>
</ul>


<p>Rails also comes with built-in help that you can generate using the rake command-line utility:Rails<span style="font-family: DejaVu Sans;">同样也带有内置的帮助你可以使用</span>rake<span style="font-family: DejaVu Sans;">命令实用工具在你的应用程序中创建帮助文档：</span></p>

<ul>
    <li>Running <tt><strong>rake</strong></tt><tt><strong> </strong></tt><tt><strong>doc:guides</strong></tt> will put a full copy of the Rails Guides in the <tt>doc/guides</tt> folder of your application. Open <tt>doc/guides/index.html</tt> in your web browser to explore the Guides. <span style="font-family: DejaVu Sans;">运行</span><tt><strong>rake</strong></tt><tt><strong> </strong></tt><tt><strong>doc:guides</strong></tt><span style="font-family: DejaVu Sans;"><tt>将会输出所有</tt></span><tt>Rails</tt><tt> </tt><tt>Guides</tt><span style="font-family: DejaVu Sans;"><tt>的文档到你的应用程序中的</tt></span><tt>doc/guides</tt><span style="font-family: DejaVu Sans;"><tt>中。在你的浏览器中打开</tt></span><tt>/guides/index.html</tt><span style="font-family: DejaVu Sans;"><tt>浏览</tt></span><tt>Guides</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></li>
    <li>Running <tt>rake</tt><tt> </tt><tt>doc:rails</tt> will put a full copy of the API documentation for Rails in the <tt>doc/api</tt> folder of your application. Open <tt>doc/api/index.html</tt> in your web browser to explore the API documentation. <span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">运行 </span></span><tt>rake</tt><tt> </tt><tt>doc:rails</tt><span style="font-family: DejaVu Sans;"><tt>将会</tt><tt>输出所有</tt></span><tt>Rails</tt><tt> API </tt><span style="font-family: DejaVu Sans;"><tt>的文档到你的应用程序中的</tt></span><tt>doc/api</tt><span style="font-family: DejaVu Sans;"><tt>中。</tt></span></li>
</ul>


<h1><span style="font-family: DejaVu Sans;">因为</span>redcloth<span style="font-family: DejaVu Sans;">的问题文档支持有点故障，虽然找到了一种解决方法但是不够完美以待官方或者来人修复。</span></h1>

<h3><a name="configuration-gotchas"></a><a name="result_box"></a> 14 Configuration Gotchas<span style="font-family: WenQuanYi Micro Hei;">配置陷阱</span></h3>


<p>The easiest way to work with Rails is to store all external data as UTF-8.Rails<span style="font-family: DejaVu Sans;">使用</span>Rails<span style="font-family: DejaVu Sans;">最简单的工作方式是存储所有的外部数据为</span>UTF-8<span style="font-family: DejaVu Sans;">编码。</span>If you don’t, Ruby libraries and Rails will often be able to convert your native data into UTF-8, but this doesn’t always work reliably, so you’re better off ensuring that all external data is UTF-8.<span style="font-family: DejaVu Sans;">如果不那样做，</span>Ruby libraries<span style="font-family: DejaVu Sans;">和</span>Rails<span style="font-family: DejaVu Sans;">通才会转换你的自然数据成</span>UTF-8<span style="font-family: DejaVu Sans;">编码，但是这样不是很可靠，因此你最好保证所有的外部数据是</span>UTF-8<span style="font-family: DejaVu Sans;">编码。</span></p>

<p>If you have made a mistake in this area, the most common symptom is a black diamond with a question mark inside appearing in the browser. <span style="font-family: DejaVu Sans;">如果你在这里犯了错误，一般的症状就是在浏览器中出现钻石符号（可能是</span>^<span style="font-family: DejaVu Sans;">）变成了问号。</span>Another common symptom is characters like “Ã¼” appearing instead of “ü”. <span style="font-family: DejaVu Sans;">另一个普遍症状是<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>ü”<span style="font-family: DejaVu Sans;">变成了<span style="font-family: Liberation Serif,Times New Roman,serif;"> “</span></span>Ã¼”<span style="font-family: DejaVu Sans;">。</span>Rails takes a number of internal<span style="font-family: DejaVu Sans;">内部</span>steps to mitigate<span style="font-family: DejaVu Sans;">减轻</span>common causes of these problems that can be automatically detected<span style="font-family: DejaVu Sans;">检测</span>and corrected. However, if you have external data that is not stored as UTF-8, it can occasionally<span style="font-family: DejaVu Sans;">偶尔</span>result in these kinds of issues that cannot be automatically detected by Rails and corrected<span style="font-family: DejaVu Sans;">更正</span>.</p>

<p>Two very common sources of data that are not UTF-8:<span style="font-family: DejaVu Sans;">两种非常普遍的不是</span>UTF-8 <span style="font-family: DejaVu Sans;">编码的源数据：</span></p>

<ul>
    <li>Your text editor: Most text editors (such as Textmate), default to saving files as UTF-8. If your text editor does not, this can result in special characters that you enter in your templates (such as é) to appear as a diamond with a question mark inside in the browser. This also applies to your I18N translation files. Most editors that do not already default to UTF-8 (such as some versions of Dreamweaver) offer a way to change the default to UTF-8. Do so.</li>
    <li>Your database. Rails defaults to converting data from your database into UTF-8 at the boundary. However, if your database is not using UTF-8 internally, it may not be able to store all characters that your users enter. For instance, if your database is using Latin-1 internally, and your user enters a Russian, Hebrew, or Japanese character, the data will be lost forever once it enters the database. If possible, use UTF-8 as the internal storage of your database.</li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/15/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/13/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/08/tong-guo-mongodumphe-mongorestoreshi-xian-mongodbbei-fen-he-hui-fu-by-chenzhou123520/">通过mongodump和mongorestore实现Mongodb备份和恢复 &#8211;by Chenzhou123520</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/ruby-on-rails-4-dot-0-release-notes/">Ruby on Rails 4.0 Release Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/rails-active-record-named-scopes/">Rails Active Record Named Scopes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/27/shai-shai-wo-men-de-kai-yuan-xiang-mu-iteyekai-yuan-dai-ma/">晒晒我们的开源项目 ITEYE开源代码</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/26/single-sign-on-dan-dian-deng-lu-sso/">Single Sign-on 单点登录 Sso</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jhjguxin">@jhjguxin</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jhjguxin',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Francis Jiang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
