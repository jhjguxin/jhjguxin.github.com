
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Francis's Octopress Blog</title>
  <meta name="author" content="Francis Jiang">

  
  <meta name="description" content="ruby-debug in 30 seconds (we don&rsquo;t need no stinkin&#8217; GUI!) Many people (including me) have complained about the lack of a good GUI &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jhjguxin.github.io/blog/page/13">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Francis's Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-25901353-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Francis's Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jhjguxin.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/readme">Readme</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/27/ruby-debug-in-30-seconds-we-dont-need-no-stinkin-gui/">Ruby-debug in 30 Seconds (We Don&#8217;t Need No Stinkin&#8217; GUI!)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-27T17:38:00+08:00" pubdate data-updated="true">Dec 27<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>ruby-debug in 30 seconds (we don&rsquo;t need no stinkin&#8217; GUI!)</h2>

<p><code>Many people (including me) have complained about the lack of a good GUI debugger for Ruby. Now that some are finally getting usable, I&rsquo;ve found I actually prefer IRB-style ruby-debug to a GUI.</code></p>

<p>There&rsquo;s good tutorial links on the <a href="http://www.datanoise.com/ruby-debug/">ruby-debug homepage</a>, and a very good <a href="http://cheat.errtheblog.com/s/rdebug/">Cheat sheet</a>, but I wanted to give a bare-bones HOWTO to help you get immediately productive with ruby-debug.</p>

<h1>Install the latest gem</h1>


<pre><code>$ gem install ruby-debug </code></pre>


<h1>Install the cheatsheet</h1>


<pre><code>$ gem install cheat $ cheat rdebug </code></pre>


<h1>Set autolist, autoeval, and autoreload as defaults</h1>


<pre><code>$ vi ~/.rdebugrc set autolist set autoeval set autoreload </code></pre>


<h1>Run Rails (or other app) via rdebug</h1>


<pre><code>$ rdebug script/server </code></pre>


<h1>Breakpoint from rdebug</h1>


<pre><code>(rdb:1) b app/controllers/my_controller.rb:10 </code></pre>


<h1>Breakpoint in source</h1>


<pre><code>require 'ruby-debug' debugger my_buggy_method('foo') </code></pre>


<h1>Catchpoint</h1>


<pre><code>(rdb:1) cat RuntimeError </code></pre>


<h1>Continue to breakpoint</h1>


<pre><code>(rdb:1) c </code></pre>


<h1>Next Line (Step Over)</h1>


<pre><code>(rdb:1) n </code></pre>


<h1>Step Into</h1>


<pre><code>(rdb:1) s </code></pre>


<h1>Continue</h1>


<pre><code>(rdb:1) c </code></pre>


<h1>Where (Display Frame / Call Stack)</h1>


<pre><code>(rdb:1) where </code></pre>


<h1>List current line</h1>


<pre><code>(rdb:1) l= </code></pre>


<h1>Evaluate any var or expression</h1>


<pre><code>(rdb:1) myvar.class </code></pre>


<h1>Modify a var</h1>


<pre><code>(rdb:1) @myvar = 'foo' </code></pre>


<h1>Help</h1>


<pre><code>(rdb:1) h </code></pre>


<p>There are many other commands, but these are the basics you need to poke around. Check the <a href="http://cheat.errtheblog.com/s/rdebug/">Cheat sheet</a> for details.</p>

<p>This can also be used directly from any IDE that supports input into a running console (such as Intellij Idea).</p>

<p>That should get you started. So, before you stick in another &lsquo;p&rsquo; to debug, try out ruby-debug instead!</p>

<p><code>require &lsquo;rubygems&rsquo;
require &lsquo;ruby-debug&rsquo;</p>

<h1>$ruby breakpoint_test.rb</h1>

<h1>vim breakpoint_test.rb</h1>

<h1>:!ruby breakpoint_test.rb</h1>

<h1>Next Line (Step Over)</h1>

<h1>(rdb:1) n</h1>

<h1>Step Into</h1>

<h1>(rdb:1) s</h1>

<h1>to debug in a function which is called from other place,before this function call,type &rsquo;s' and you will found your are inside this function.</h1>

<p>def leap_year year
leap = case
breakpoint
when year % 400 == 0: true
when year % 100 == 0: false
else year % 4 ==0
end
puts leap
end
if <strong>FILE</strong> == $0</p>

<h1>tests&hellip;</h1>

<p>puts &ldquo;year=2000&rdquo;
leap_year 2000
puts &ldquo;year=2004&rdquo;
leap_year 2004
puts &ldquo;year=2002&rdquo;
leap_year 2002
end</code></p>

<p>标签： <a href="http://jhjguxin.hwcrazy.com/tag/breakpoint/">breakpoint</a> <a href="http://jhjguxin.hwcrazy.com/tag/debug/">debug</a> <a href="http://jhjguxin.hwcrazy.com/tag/rails/">rails</a> <a href="http://jhjguxin.hwcrazy.com/tag/ruby/">ruby</a> <a href="http://jhjguxin.hwcrazy.com/tag/shell/">shell</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/27/action-controller-overview/">Action Controller Overview</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-27T00:24:00+08:00" pubdate data-updated="true">Dec 27<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Action Controller Overview</h2>

<h3>Controllers</h3>


<dl><dt>Action Controller Overview</dt><dd>This guide covers how controllers work and how they fit into the request cycle in your application. It includes sessions, filters, and cookies, data streaming, and dealing with exceptions raised by a request, among other topics.</dd><dt>Rails Routing from the Outside In</dt><dd>This guide covers the user-facing features of Rails routing. If you want to understand how to use routing in your own Rails applications, start here.</dd></dl>


<h2>Action Controller Overview</h2>


<p>In this guide you will learn how controllers work and how they fit into the request cycle in your application. After reading this guide, you will be able to:</p>

<p><span style="font-family: DejaVu Sans;">在这个</span>gudie<span style="font-family: DejaVu Sans;">中你将会学习到</span>controllers<span style="font-family: DejaVu Sans;">是怎样工作的以及它们在你的应用程序中是怎用配合完成</span>request cycle<span style="font-family: DejaVu Sans;">。</span></p>

<ul>
    <li>Follow the flow of a request through a controller</li>
</ul>


<p><span style="font-family: DejaVu Sans;">跟随</span>requset<span style="font-family: DejaVu Sans;">流向一个</span>controller</p>

<ul>
    <li>Understand why and how to store data in the session or cookies</li>
</ul>


<p><span style="font-family: DejaVu Sans;">明白在会话和</span>cookies<span style="font-family: DejaVu Sans;">中为什么以及怎样存储</span>data</p>

<ul>
    <li>Work with filters to execute code during request processing</li>
</ul>


<p><span style="font-family: DejaVu Sans;">使用</span>filters<span style="font-family: DejaVu Sans;">来工作在</span>request<span style="font-family: DejaVu Sans;">过程中执行</span>code</p>

<ul>
    <li>Use Action Controller’s built-in HTTP authentication</li>
</ul>


<p><span style="font-family: DejaVu Sans;">使用</span>Action Controller<span style="font-family: DejaVu Sans;">的内置的</span>HTTP<span style="font-family: DejaVu Sans;">认证</span></p>

<ul>
    <li>Stream data directly to the user’s browser</li>
</ul>


<p>Stream data<span style="font-family: DejaVu Sans;">直接（到）用户的浏览器</span></p>

<ul>
    <li>Filter sensitive parameters so they do not appear in the application’s log</li>
</ul>


<p><span style="font-family: DejaVu Sans;">过滤敏感参数使得它们不会在应用程序的</span>log<span style="font-family: DejaVu Sans;">中出现</span></p>

<ul>
    <li>Deal with exceptions that may be raised during request processing</li>
</ul>


<p><span style="font-family: DejaVu Sans;">处理可能在</span>request<span style="font-family: DejaVu Sans;">进程之间抛出的意外</span></p>

<h3><a name="what-does-a-controller-do"></a> 1 What Does a Controller Do?</h3>


<p>Action Controller is the C in MVC. After routing has determined which controller to use for a request, your controller is responsible for making sense of the request and producing the appropriate output. Luckily, Action Controller does most of the groundwork for you and uses smart conventions to make this as straightforward as possible.
Action Controller<span style="font-family: DejaVu Sans;">是</span>MVC<span style="font-family: DejaVu Sans;">中的</span>C<span style="font-family: DejaVu Sans;">。在</span>routing<span style="font-family: DejaVu Sans;">已经决定了对于一个</span>request<span style="font-family: DejaVu Sans;">使用哪个</span>controller<span style="font-family: DejaVu Sans;">，你的</span>controller<span style="font-family: DejaVu Sans;">负责请求的实际意图并且产生合适的输出。幸运的是，</span>Action Controller<span style="font-family: DejaVu Sans;">为了做了大多数的基础工作并且使用智能方便的（方式）使得</span>C<span style="font-family: DejaVu Sans;">能够尽可能的直接干脆。</span></p>

<p>For most conventional RESTful applications, the controller will receive the request (this is invisible to you as the developer), fetch or save data from a model and use a view to create HTML output. If your controller needs to do things a little differently, that’s not a problem, this is just the most common way for a controller to work.</p>

<p><span style="font-family: DejaVu Sans;">对于大多数的传统的</span>RESTful<span style="font-family: DejaVu Sans;">应用程序，</span>controller<span style="font-family: DejaVu Sans;">将会收到请求（这对于开发者你来说是无形的），从一个</span>model<span style="font-family: DejaVu Sans;">刷新或者</span>savee<span style="font-family: DejaVu Sans;">数据或者使用一个视图来创建</span>HTML<span style="font-family: DejaVu Sans;">输出。如果你的</span>controller<span style="font-family: DejaVu Sans;">需要做些略微不同的事情，这不是问题，这仅仅是</span>controller<span style="font-family: DejaVu Sans;">在工作中大多数通常的方式。</span></p>

<p>A controller can thus be thought of as a middle man between models and views. It makes the model data available to the view so it can display that data to the user, and it saves or updates data from the user to the model.</p>

<p><span style="font-family: DejaVu Sans;">一个</span>controller<span style="font-family: DejaVu Sans;">能够这样，作为在</span>models<span style="font-family: DejaVu Sans;">和</span>views<span style="font-family: DejaVu Sans;">之间的中间人。它使得</span>model<span style="font-family: DejaVu Sans;">数据可以用户</span>view<span style="font-family: DejaVu Sans;">因此它可以显示这些数据给用户，同时它从用户保存或者更新数据到</span>model<span style="font-family: DejaVu Sans;">。</span></p>

<p>For more details on the routing process, see <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/routing.html">Rails</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/routing.html">Routing</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/routing.html">from</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/routing.html">the</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/routing.html">Outside</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/routing.html">In</a></span></span>.</p>

<h3><a name="methods-and-actions"></a>2 Methods and Actions</h3>


<p>A controller is a Ruby class which inherits from <tt>ApplicationController</tt> and has methods just like any other class. When your application receives a request, the routing will determine which controller and action to run, then Rails creates an instance of that controller and runs the method with the same name as the action.</p>

<p><span style="font-family: DejaVu Sans;">一个</span>controller<span style="font-family: DejaVu Sans;">是一个</span>Ruby<span style="font-family: DejaVu Sans;">类它继承至</span><tt>ApplicationController</tt><span style="font-family: DejaVu Sans;"><tt>同时像其他类一样它也有方法。当你的应用程序收到一个</tt></span><tt>request</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>routing</tt><span style="font-family: DejaVu Sans;"><tt>将会决定那个</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>会运行，然后</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>创建一个</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>的实例同时运行与</tt></span><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>名字相同的方法。</tt></span></p>

<p>class ClientsController &lt; ApplicationController</p>

<p>def new</p>

<p>end</p>

<p>end</p>

<p>As an example, if a user goes to <tt>/clients/new</tt> in your application to add a new client, Rails will create an instance of <tt>ClientsController</tt> and run the <tt>new</tt> method. Note that the empty method from the example above could work just fine because Rails will by default render the <tt>new.html.erb</tt> view unless the action says otherwise. The <tt>new</tt> method could make available to the view a <tt>@client</tt> instance variable by creating a new <tt>Client</tt>:</p>

<p><span style="font-family: DejaVu Sans;">正如一个例子，如果一个</span>user<span style="font-family: DejaVu Sans;">导航至</span><tt>/clients/new</tt> <span style="font-family: DejaVu Sans;">在你的应用程序中添加一个</span>new client<span style="font-family: DejaVu Sans;">，</span>Rails<span style="font-family: DejaVu Sans;">将会创建一个</span><tt>ClientsController</tt><span style="font-family: DejaVu Sans;"><tt>的实例并且运行</tt></span><tt>new</tt><span style="font-family: DejaVu Sans;"><tt>方法。注意例子中空的方法完全可以工作因为</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>将会默认</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>名称为</tt><tt></tt></span><tt>new.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>的视图除非</tt></span><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>指定了另外的。</tt></span><tt>new</tt><span style="font-family: DejaVu Sans;"><tt>方法通过创建一个新的</tt></span><tt>Client</tt><span style="font-family: DejaVu Sans;"><tt>将使得可以查看</tt></span><tt>@client</tt><span style="font-family: DejaVu Sans;"><tt>实例变量。</tt></span></p>

<p>def new</p>

<p>@client = Client.new</p>

<p>end</p>

<p>The <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/layouts_and_rendering.html">Layouts</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/layouts_and_rendering.html">&amp;</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/layouts_and_rendering.html">Rendering</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/layouts_and_rendering.html">Guide</a></span></span> explains this in more detail.</p>

<p><tt>ApplicationController</tt> inherits from <tt>ActionController::Base</tt>, which defines a number of helpful methods. This guide will cover some of these, but if you’re curious to see what’s in there, you can see all of them in the API documentation or in the source itself.</p>

<p><tt>ApplicationController</tt><span style="font-family: DejaVu Sans;"><tt>继承至</tt><tt></tt></span><tt>ActionController::Base</tt><span style="font-family: DejaVu Sans;"><tt>，器定义了很多</tt></span><tt>helpful</tt><span style="font-family: DejaVu Sans;"><tt>方法。这个教材将会涵盖这些，但是如果你好奇与其中有些什么，你可以在</tt></span><tt>API</tt><span style="font-family: DejaVu Sans;"><tt>文档中或者他的源代码中看到所有的方法。</tt></span></p>

<p>Only public methods are callable as actions. It is a best practice to lower the visibility of methods which are not intended to be actions, like auxiliary methods or filters.</p>

<p><span style="font-family: DejaVu Sans;">对于</span>action<span style="font-family: DejaVu Sans;">只有公共的方法才是可调用的。它是低敏感度方法的最好实践，而这些对</span>actions<span style="font-family: DejaVu Sans;">没有义务，像辅助方法或者过滤器。</span></p>

<h3><a name="parameters"></a>3 Parameters</h3>


<p>You will probably want to access data sent in by the user or other parameters in your controller actions. There are two kinds of parameters possible in a web application. The first are parameters that are sent as part of the URL, called query string parameters. The query string is everything after “?” in the URL. The second type of parameter is usually referred to as POST data. This information usually comes from an HTML form which has been filled in by the user. It’s called POST data because it can only be sent as part of an HTTP POST request. Rails does not make any distinction between query string parameters and POST parameters, and both are available in the <tt>params</tt> hash in your controller:</p>

<p><span style="font-family: DejaVu Sans;">在你的</span>controller action<span style="font-family: DejaVu Sans;">中你可能想访问用户或者其他参数发送的数据。一个</span>web<span style="font-family: DejaVu Sans;">应用程序中这里可能有两种参数。第一种是作为</span>URL<span style="font-family: DejaVu Sans;">一部分发送的参数，叫做</span>query string parameters<span style="font-family: DejaVu Sans;">（字符串查询参数）。查询字符串是在</span>URL<span style="font-family: DejaVu Sans;">的<span style="font-family: Liberation Serif,Times New Roman,serif;">”</span></span>?”<span style="font-family: DejaVu Sans;">后面的所有字符。第二种类型的参数通常被简称为</span>POST data<span style="font-family: DejaVu Sans;">。这类信息通常来至于一个被用户填写的</span>HTML<span style="font-family: DejaVu Sans;">表单。它被称为</span>POST data<span style="font-family: DejaVu Sans;">因为它仅能通过</span>HTTP POST <span style="font-family: DejaVu Sans;">请求的一部分发送。</span>Rails<span style="font-family: DejaVu Sans;">在字符串查询参数和</span>POST data<span style="font-family: DejaVu Sans;">参数之间不做任何区分，它们在你的</span>controller<span style="font-family: DejaVu Sans;">的</span>params<span style="font-family: DejaVu Sans;">字典中都是可用的。</span></p>

<p>class ClientsController &lt; ActionController::Base</p>

<h1>This action uses query string parameters because it gets run</h1>

<h1>by an HTTP GET request, but this does not make any difference</h1>

<h1>to the way in which the parameters are accessed. The URL for</h1>

<h1>this action would look like this in order to list activated</h1>

<h1>clients: /clients?status=activated</h1>

<p>def index</p>

<p>if params[:status] == &ldquo;activated&rdquo;</p>

<p>@clients = Client.activated</p>

<p>else</p>

<p>@clients = Client.unactivated</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<h1>This action uses POST parameters. They are most likely coming</h1>

<h1>from an HTML form which the user has submitted. The URL for</h1>

<h1>this RESTful request will be &ldquo;/clients&rdquo;, and the data will be</h1>

<h1>sent as part of the request body.</h1>

<p>def create</p>

<p>@client = Client.new(params[:client])</p>

<p>if @client.save</p>

<p>redirect_to @client</p>

<p>else</p>

<h1>This line overrides the default rendering behavior, which</h1>

<h1>would have been to render the &ldquo;create&rdquo; view.</h1>

<p>render :action =&gt; &ldquo;new&rdquo;</p>

<p>end</p>

<p>end</p>

<p>end</p>

<h4><a name="hash-and-array-parameters"></a>3.1 Hash and Array Parameters</h4>


<p>The <tt>params</tt> hash is not limited to one-dimensional keys and values. It can contain arrays and (nested) hashes. To send an array of values, append an empty pair of square brackets “[]” to the key name:</p>

<p>params hash<span style="font-family: DejaVu Sans;">字典不限于一维的关键字和值。它能够包含数组和（嵌套）字典。要发送一个数组值，添加一个空的<span style="font-family: Liberation Serif,Times New Roman,serif;">”</span></span>[]”<span style="font-family: DejaVu Sans;">给</span>key name<span style="font-family: DejaVu Sans;">：</span></p>

<pre>GET /clients?ids[]=1&amp;ids[]=2&amp;ids[]=3</pre>


<p><strong>The</strong><strong> </strong><strong>actual</strong><strong> </strong><strong>URL</strong><strong> </strong><strong>in</strong><strong> </strong><strong>this</strong><strong> </strong><strong>example</strong><strong> </strong><strong>will</strong><strong> </strong><strong>be</strong><strong> </strong><strong>encoded</strong><strong> </strong><strong>as</strong><strong> “</strong><strong>/clients?ids%5b%5d=1&amp;ids%5b%5d=2&amp;ids%5b%5d=3</strong><strong>” </strong><strong>as</strong><strong> “</strong><strong>[</strong><strong>” </strong><strong>and</strong><strong> “</strong><strong>]</strong><strong>” </strong><strong>are</strong><strong> </strong><strong>not</strong><strong> </strong><strong>allowed</strong><strong> </strong><strong>in</strong><strong> </strong><strong>URLs.</strong><strong> </strong>Most of the time you don’t have to worry about this because the browser will take care of it for you, and Rails will decode it back when it receives it, but if you ever find yourself having to send those requests to the server manually you have to keep this in mind.<span style="font-family: DejaVu Sans;">但是如果你发现你自己不得不手动的发送这些请求到服务器你必须注意。</span></p>

<p>The value of <tt>params[:ids]</tt> will now be <tt>[&ldquo;1&rdquo;,</tt><tt> </tt><tt>&ldquo;2&rdquo;,</tt><tt> </tt><tt>&ldquo;3&rdquo;]</tt>. <strong>Note</strong><strong> </strong><strong>that</strong><strong> </strong><strong>parameter</strong><strong> </strong><strong>values</strong><strong> </strong><strong>are</strong><strong> </strong><strong>always</strong><strong> </strong><strong>strings;</strong><strong> </strong>Rails makes no attempt to guess or cast the type.</p>

<p>To send a hash you include the key name inside the brackets:</p>

<p>&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/clients&rdquo; method=&ldquo;post&rdquo;&gt;</p>

<p>&lt;input type=&ldquo;text&rdquo; name=&ldquo;client[name]&rdquo; value=&ldquo;Acme&rdquo; /&gt;</p>

<p>&lt;input type=&ldquo;text&rdquo; name=&ldquo;client[phone]&rdquo; value=&ldquo;12345&rdquo; /&gt;</p>

<p>&lt;input type=&ldquo;text&rdquo; name=&ldquo;client[address][postcode]&rdquo; value=&ldquo;12345&rdquo; /&gt;</p>

<p>&lt;input type=&ldquo;text&rdquo; name=&ldquo;client[address][city]&rdquo; value=&ldquo;Carrot City&rdquo; /&gt;</p>

<p>&lt;/form&gt;</p>

<p>When this form is submitted, the <strong>value</strong><strong> </strong><strong>of</strong><strong> </strong><tt><strong>params[:client]</strong></tt> will be <tt>{&ldquo;name&rdquo;</tt><tt> </tt><tt>=&gt;</tt><tt> “</tt><tt>Acme</tt><tt>”</tt><tt>,</tt><tt> “</tt><tt>phone</tt><tt>” </tt><tt>=&gt;</tt><tt> “</tt><tt>12345</tt><tt>”</tt><tt>,</tt><tt> “</tt><tt>address</tt><tt>” </tt><tt>=&gt;</tt><tt> </tt><tt>{&ldquo;postcode&rdquo;</tt><tt> </tt><tt>=&gt;</tt><tt> “</tt><tt>12345</tt><tt>”</tt><tt>,</tt><tt> “</tt><tt>city</tt><tt>” </tt><tt>=&gt;</tt><tt> “</tt><tt>Carrot</tt><tt> </tt><tt>City</tt><tt>”</tt><tt>}}</tt>. Note the nested hash in <tt>params[:client][:address]</tt>.</p>

<p>Note that the <tt>params</tt> hash is actually an instance of <tt>HashWithIndifferentAccess</tt> from Active Support, which acts like a hash that lets you use symbols and strings interchangeably<span style="font-family: DejaVu Sans;">互换</span>as keys.</p>

<h4><a name="json-xml-parameters"></a>3.2 JSON/XML parameters</h4>


<p>If you’re writing a web service application, you might find yourself more comfortable on accepting parameters in JSON or XML format. Rails will automatically convert your parameters into <tt>params</tt> hash, which you’ll be able to access like you would normally do with form data.</p>

<p><span style="font-family: DejaVu Sans;">如果你打算写一个</span>web<span style="font-family: DejaVu Sans;">服务程序，你可能会发现使用</span>JSON<span style="font-family: DejaVu Sans;">或者</span>XML<span style="font-family: DejaVu Sans;">格式接收参数会更加舒服。</span>Rails<span style="font-family: DejaVu Sans;">将会自动的转换你的参数到</span>params hash<span style="font-family: DejaVu Sans;">字典中，其中你将可以像正常表单数据那样接收数据。</span></p>

<p>So for example, if you are sending this JSON parameter:</p>

<pre>{ "company": { "name": "acme", "address": "123 Carrot Street" } }</pre>


<p>You’ll get <tt>params[:company]</tt> as <tt>{</tt><tt> </tt><tt>:name</tt><tt> </tt><tt>=&gt;</tt><tt> “</tt><tt>acme</tt><tt>”</tt><tt>,</tt><tt> “</tt><tt>address</tt><tt>” </tt><tt>=&gt;</tt><tt> “</tt><tt>123</tt><tt> </tt><tt>Carrot</tt><tt> </tt><tt>Street</tt><tt>” </tt><tt>}</tt>.</p>

<p>Also, if you’ve turned on <tt>config.wrap_parameters</tt> in your initializer or calling <tt>wrap_parameters</tt> in your controller, you can safely omit the root element in the JSON/XML parameter. The parameters will be cloned and wrapped in the key according to your controller’s name by default. So the above parameter can be written as:</p>

<p><span style="font-family: DejaVu Sans;">同样，如果你已经打开</span><tt>config.wrap_parameters</tt><span style="font-family: DejaVu Sans;"><tt>在你的</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>中初始化或者调用</tt><tt></tt></span><tt>wrap_parameters</tt><span style="font-family: DejaVu Sans;"><tt>，在</tt></span><tt>JSON/XML</tt><span style="font-family: DejaVu Sans;"><tt>参数中你可以安全的忽略</tt></span><tt>root</tt><tt> </tt><tt>element</tt><span style="font-family: DejaVu Sans;"><tt>。参数将会克隆和包装在</tt></span><tt>key</tt><span style="font-family: DejaVu Sans;"><tt>默认会依照你的</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>。因此完整的参数可以这样写：</tt></span></p>

<pre><tt>{</tt><tt> </tt><tt>"name":</tt><tt> </tt><tt>"acme",</tt><tt> </tt><tt>"address":</tt><tt> </tt><tt>"123</tt><tt> </tt><tt>Carrot</tt><tt> </tt><tt>Street"</tt><tt> </tt><tt>}</tt></pre>


<p><tt>And</tt><tt> </tt><tt>assume</tt><span style="font-family: DejaVu Sans;"><tt>假设</tt><tt></tt></span><tt>that</tt><tt> </tt><tt>you</tt><tt>’</tt><tt>re</tt><tt> </tt><tt>sending</tt><tt> </tt><tt>the</tt><tt> </tt><tt>data</tt><tt> </tt><tt>to</tt><tt> </tt><tt>CompaniesController,</tt><tt> </tt><tt>it</tt><tt> </tt><tt>would</tt><tt> </tt><tt>then</tt><tt> </tt><tt>be</tt><tt> </tt><tt>wrapped</tt><tt> </tt><tt>in</tt><tt> </tt><tt>:company</tt><tt> </tt><tt>key</tt><tt> </tt><tt>like</tt><tt> </tt><tt>this:</tt></p>

<p>{ :name =&gt; &ldquo;acme&rdquo;, :address =&gt; &ldquo;123 Carrot Street&rdquo;, :company =&gt; { :name =&gt; &ldquo;acme&rdquo;, :address =&gt; &ldquo;123 Carrot Street&rdquo; }}</p>

<p>You can customize the name of the key or specific parameters you want to wrap by consulting the <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://api.rubyonrails.org/classes/ActionController/ParamsWrapper.html">API</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://api.rubyonrails.org/classes/ActionController/ParamsWrapper.html">documentation</a></span></span></p>

<h4><a name="routing-parameters"></a>3.3 Routing Parameters</h4>


<p>The <tt>params</tt> hash will always contain the <tt>:controller</tt> and <tt>:action</tt> keys, but you should use the methods <tt>controller_name</tt> and <tt>action_name</tt> instead to access these values. Any other parameters defined by the routing, such as <tt>:id</tt> will also be available. As an example, consider a listing of clients where the list can show either active or inactive clients. We can add a route which captures the <tt>:status</tt> parameter in a “pretty” URL:</p>

<p>params hash<span style="font-family: DejaVu Sans;">字典总会包含关键字</span><tt>:controller</tt> and <tt>:action</tt><span style="font-family: DejaVu Sans;"><tt>，但是你应该使用方法</tt><tt></tt></span><tt>controller_name</tt><tt> </tt><tt>and</tt><tt> </tt><tt>action_name</tt><span style="font-family: DejaVu Sans;"><tt>作为替代访问这些值。也有一些其他的值被</tt></span><tt>routing</tt><span style="font-family: DejaVu Sans;"><tt>定义，例如</tt></span><tt>:id</tt><span style="font-family: DejaVu Sans;"><tt>也是可以的。例如，思考一个</tt></span><tt>clients</tt><span style="font-family: DejaVu Sans;"><tt>的列表能够显示</tt></span><tt>active</tt><span style="font-family: DejaVu Sans;"><tt>或者</tt></span><tt>inactive</tt><tt> </tt><tt>client</tt><span style="font-family: DejaVu Sans;"><tt>。我们可以添加一个</tt></span><tt>route</tt><span style="font-family: DejaVu Sans;"><tt>它会捕获在</tt><tt></tt></span><tt>a</tt><tt> “</tt><tt>pretty</tt><tt>” </tt><tt>URL</tt><span style="font-family: DejaVu Sans;"><tt>（一个漂亮的</tt></span><tt>URL</tt><span style="font-family: DejaVu Sans;"><tt>）中的</tt></span><tt>:status</tt><span style="font-family: DejaVu Sans;"><tt>参数：</tt></span></p>

<p>match &lsquo;/clients/:status&rsquo; =&gt; &lsquo;clients#index&rsquo;, :foo =&gt; &ldquo;bar&rdquo;</p>

<p>In this case, when a user opens the URL <tt>/clients/active</tt>, <tt>params[:status]</tt> will be set to “active”. When this route is used, <tt>params[:foo]</tt> will also be set to “bar” <strong>just</strong><strong> </strong><strong>like</strong><strong> </strong><strong>it</strong><strong> </strong><strong>was</strong><strong> </strong><strong>passed</strong><strong> </strong><strong>in</strong><strong> </strong><strong>the</strong><strong> </strong><strong>query</strong><strong> </strong><strong>string.</strong><strong> </strong>In the same way <tt>params[:action]</tt> will contain “index”.</p>

<h4><a name="default_url_options"></a>3.4 <tt>default_url_options</tt></h4>


<p>You can set global default parameters that will be used <strong>when</strong><strong> </strong><strong>generating</strong><strong> </strong><strong>URLs</strong><strong> </strong><strong>with</strong><strong> </strong><tt><strong>default_url_options</strong></tt>. To do this, define a method with that name in your controller:</p>

<p>class ApplicationController &lt; ActionController::Base</p>

<h1>The options parameter is the hash passed in to &lsquo;url_for&rsquo;</h1>

<p>def default_url_options(options)</p>

<p>{:locale =&gt; I18n.locale}</p>

<p>end</p>

<p>end</p>

<p>These options will be used as a starting-point when generating URLs, so it’s possible they’ll be overridden by <tt>url_for</tt>. Because this method is defined in the controller, you can define it on <tt>ApplicationController</tt> so it would be used for all URL generation, or you could define it on only one controller for all URLs generated there.</p>

<h3><a name="session"></a>4 Session<span style="font-family: WenQuanYi Micro Hei;">会话</span></h3>


<p>Your application has a session for each user in which you can store small amounts of data that will be persisted between requests. <strong>The</strong><strong> </strong><strong>session</strong><strong> </strong><strong>is</strong><strong> </strong><strong>only</strong><strong> </strong><strong>available</strong><strong> </strong><strong>in</strong><strong> </strong><strong>the</strong><strong> </strong><strong>controller</strong><strong> </strong><strong>and</strong><strong> </strong><strong>the</strong><strong> </strong><strong>view</strong><strong> </strong><strong>and</strong><strong> </strong><strong>can</strong><strong> </strong><strong>use</strong><strong> </strong><strong>one</strong><strong> </strong><strong>of</strong><strong> </strong><strong>a</strong><strong> </strong><strong>number</strong><strong> </strong><strong>of</strong><strong> </strong><strong>different</strong><strong> </strong><strong>storage</strong><strong> </strong><strong>mechanisms</strong>:</p>

<p><span style="font-family: DejaVu Sans;">你的应用程序对每一位用户都有一个会话通过它你可以存储少量的数据这会将</span>request<span style="font-family: DejaVu Sans;">区分开来。</span></p>

<ul>
    <li>CookieStore – Stores everything on the client.</li>
    <li>DRbStore – Stores the data on a DRb server.</li>
    <li>MemCacheStore – Stores the data in a memcache.</li>
    <li>ActiveRecordStore – Stores the data in a database using Active Record.</li>
</ul>


<p>All session stores use a cookie to store a unique ID for each session (you must use a cookie, Rails will not allow you to pass the session ID in the URL as this is less secure).</p>

<p><span style="font-family: DejaVu Sans;">每个会话使用一个</span>cookie<span style="font-family: DejaVu Sans;">存储并且每个会话都有一个独特的</span>ID<span style="font-family: DejaVu Sans;">（你必须使用一个</span>cookie<span style="font-family: DejaVu Sans;">，</span>Rails<span style="font-family: DejaVu Sans;">不允许你在</span>URL<span style="font-family: DejaVu Sans;">中传送会话</span>ID<span style="font-family: DejaVu Sans;">因为这样不安全）。</span></p>

<p>For most stores this ID is used to look up the session data on the server, e.g. in a database table. There is one exception, and that is the default and recommended session store – the CookieStore – which stores all session data in the cookie itself (the ID is still available to you if you need it). This has the advantage of being very lightweight and it requires zero setup in a new application in order to use the session. The cookie data is cryptographically signed to make it tamper-proof, but it is not encrypted, so anyone with access to it can read its contents but not edit it (Rails will not accept it if it has been edited).</p>

<p><a name="result_box"></a><span style="font-family: DejaVu Sans;">大多数（时候）存储这个</span>ID<span style="font-family: DejaVu Sans;">是用来在</span>server<span style="font-family: DejaVu Sans;">上面查找</span>session data<span style="font-family: DejaVu Sans;">，例如，存放在一个数据库</span>table<span style="font-family: DejaVu Sans;">中。这里有一个例外，并且这是默认以及推荐的</span>session<span style="font-family: DejaVu Sans;">存储</span>-CookieStore-<span style="font-family: DejaVu Sans;">它存储所有的</span>session<span style="font-family: DejaVu Sans;">数据在它的</span>cookie<span style="font-family: DejaVu Sans;">中（如果你需要</span>ID<span style="font-family: DejaVu Sans;">同样是可用的）。这里的优势是十分轻量级并且在一个新应用程序中使用</span>session<span style="font-family: DejaVu Sans;">是零安装。</span>cookie<span style="font-family: DejaVu Sans;">数据以加密签名的方式以防篡改，但是它没有将内容译成迷文，因此任何人访问它都可以阅读它的内容但是不能编辑它（</span>Rails<span style="font-family: DejaVu Sans;">将不会接受被编辑过的</span>cookie<span style="font-family: DejaVu Sans;">）。</span></p>

<p><strong>The</strong><strong> </strong><strong>CookieStore</strong><strong> </strong><strong>can</strong><strong> </strong><strong>store</strong><strong> </strong><strong>around</strong><strong> </strong><strong>4kB</strong><strong> </strong><strong>of</strong><strong> </strong><strong>data</strong><strong> — </strong><strong>much</strong><strong> </strong><strong>less</strong><strong> </strong><strong>than</strong><strong> </strong><strong>the</strong><strong> </strong><strong>others</strong><strong> — </strong><strong>but</strong><strong> </strong><strong>this</strong><strong> </strong><strong>is</strong><strong> </strong><strong>usually</strong><strong> </strong><strong>enough.</strong><strong> </strong>Storing large amounts of data in the session is discouraged no matter which session store your application uses. You should especially avoid storing complex objects (anything other than basic Ruby objects, the most common example being model instances) in the session, as the server might not be able to reassemble them between requests, which will result in an error.</p>

<p>CookieStore<span style="font-family: DejaVu Sans;">能够存储大约</span>4KB<span style="font-family: DejaVu Sans;">的数据<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>远少于其他<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>但是这通常足够。在你应用程序使用的</span>session<span style="font-family: DejaVu Sans;">中，存储大量的数据是无比泄气的。你应该尤其避免存储复杂的对象（任何其他的</span>Ruby<span style="font-family: DejaVu Sans;">基本对象，最普遍的例子是</span>model<span style="font-family: DejaVu Sans;">实例）在</span>session<span style="font-family: DejaVu Sans;">，因为</span>server<span style="font-family: DejaVu Sans;">可能不能在不同的请求间重组它们，结果它将得到错误。</span></p>

<p>Read more about session storage in the <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/security.html">Security</a></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/security.html">Guide</a></span></span>.</p>

<p>If you need a different session storage mechanism, you can change it in the <tt>config/initializers/session_store.rb</tt> file:</p>

<p><span style="font-family: DejaVu Sans;">如果你需要一个不同的</span>session<span style="font-family: DejaVu Sans;">存储机制，你可以在这里更改</span><tt>config/initializers/session_store.rb</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<h1>Use the database for sessions instead of the cookie-based default,</h1>

<h1>which shouldn&rsquo;t be used to store highly confidential information</h1>

<h1>(create the session table with &ldquo;script/rails g session_migration&rdquo;)</h1>

<h1>YourApp::Application.config.session_store :active_record_store</h1>

<p>Rails sets up a session key (the name of the cookie) when signing the session data. These can also be changed in <tt>config/initializers/session_store.rb</tt>:</p>

<p>Rails<span style="font-family: DejaVu Sans;">当注册</span>session data<span style="font-family: DejaVu Sans;">的时候会设置一个</span>session key(cookie<span style="font-family: DejaVu Sans;">的名字</span>)<span style="font-family: DejaVu Sans;">。也可以在这里修改</span><tt>config/initializers/session_store.rb</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<h1>Be sure to restart your server when you modify this file.</h1>

<p>&nbsp;</p>

<p>YourApp::Application.config.session_store :cookie_store, :key =&gt; &lsquo;_your_app_session&rsquo;</p>

<p>You can also pass a <tt>:domain</tt> key and specify the domain name for the cookie:</p>

<p><span style="font-family: DejaVu Sans;">你也可以通过一个</span>:domain<span style="font-family: DejaVu Sans;">关键字指定</span>cookie<span style="font-family: DejaVu Sans;">的域名：</span></p>

<h1>Be sure to restart your server when you modify this file.</h1>

<p>&nbsp;</p>

<p>YourApp::Application.config.session_store :cookie_store, :key =&gt; &lsquo;_your_app_session&rsquo;, :domain =&gt; &ldquo;.example.com&rdquo;</p>

<p>Rails sets up (for the CookieStore) a secret key<span style="font-family: DejaVu Sans;">密钥</span>used for signing the session data. This can be changed in <tt>config/initializers/secret_token.rb</tt></p>

<h1>Be sure to restart your server when you modify this file.</h1>

<p>&nbsp;</p>

<h1>Your secret key for verifying the integrity of signed cookies.</h1>

<h1>If you change this key, all old signed cookies will become invalid!</h1>

<h1>Make sure the secret is at least 30 characters and all random,</h1>

<h1>no regular words or you&rsquo;ll be exposed to dictionary attacks.</h1>

<p>YourApp::Application.config.secret_token = &lsquo;49d3f3de9ed86c74b94ad6bd0&hellip;&rsquo;</p>

<p>Changing the secret when using the <tt>CookieStore</tt> will invalidate<span style="font-family: DejaVu Sans;">废除</span>all existing sessions.</p>

<p><span style="font-family: DejaVu Sans;">当使用</span>CookieStore<span style="font-family: DejaVu Sans;">的时候改变密钥将会废除所有存在的</span>sessions<span style="font-family: DejaVu Sans;">。</span></p>

<h4><a name="accessing-the-session"></a>4.1 Accessing the Session</h4>


<p>In your controller you can access the session through the <tt>session</tt> instance method.</p>

<p><span style="font-family: DejaVu Sans;">在你的</span>controller<span style="font-family: DejaVu Sans;">你可以访问</span>session<span style="font-family: DejaVu Sans;">通过</span>session<span style="font-family: DejaVu Sans;">实例方法。</span></p>

<p><strong>Sessions</strong><strong> </strong><strong>are</strong><strong> </strong><strong>lazily</strong><strong> </strong><strong>loaded.</strong><strong> </strong><strong>If</strong><strong> </strong><strong>you</strong><strong> </strong><strong>don</strong><strong>’</strong><strong>t</strong><strong> </strong><strong>access</strong><strong> </strong><strong>sessions</strong><strong> </strong><strong>in</strong><strong> </strong><strong>your</strong><strong> </strong><strong>action</strong><strong>’</strong><strong>s</strong><strong> </strong><strong>code,</strong><strong> </strong><strong>they</strong><strong> </strong><strong>will</strong><strong> </strong><strong>not</strong><strong> </strong><strong>be</strong><strong> </strong><strong>loaded.</strong> Hence<span style="font-family: DejaVu Sans;">因此</span>you will never need to disable sessions, just not accessing them will do the job.</p>

<p>Session values are stored using key/value pairs like a hash:</p>

<p>session<span style="font-family: DejaVu Sans;">的值使用</span>key/value<span style="font-family: DejaVu Sans;">对存储就像一个</span>hash<span style="font-family: DejaVu Sans;">字典：</span></p>

<p>class ApplicationController &lt; ActionController::Base</p>

<p>&nbsp;</p>

<p>private</p>

<p>&nbsp;</p>

<h1>Finds the User with the ID stored in the session with the key</h1>

<h1>:current_user_id This is a common way to handle user login in</h1>

<h1>a Rails application; logging in sets the session value and</h1>

<h1>logging out removes it.</h1>

<p>def current_user</p>

<p>@_current_user ||= session[:current_user_id] &amp;&amp;</p>

<p>User.find_by_id(session[:current_user_id])</p>

<p>end</p>

<p>end</p>

<p>To store something in the session, just assign it to the key like a hash:</p>

<p><span style="font-family: DejaVu Sans;">要存储一些信息在</span>session<span style="font-family: DejaVu Sans;">中，仅仅需要将其指派给</span>key<span style="font-family: DejaVu Sans;">就像一个</span>hash<span style="font-family: DejaVu Sans;">字典一样：</span></p>

<p>class LoginsController &lt; ApplicationController</p>

<h1>&ldquo;Create&rdquo; a login, aka &ldquo;log the user in&rdquo;</h1>

<p>def create</p>

<p>if user = User.authenticate(params[:username], params[:password])</p>

<h1>Save the user ID in the session so it can be used in</h1>

<h1>subsequent requests</h1>

<p>session[:current_user_id] = user.id</p>

<p>redirect_to root_url</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>To remove something from the session, assign that key to be <tt>nil</tt>:</p>

<p><span style="font-family: DejaVu Sans;">从</span>session<span style="font-family: DejaVu Sans;">从移除一些信息，分派那个</span>key<span style="font-family: DejaVu Sans;">为</span>nil<span style="font-family: DejaVu Sans;">：</span></p>

<p>class LoginsController &lt; ApplicationController</p>

<h1>&ldquo;Delete&rdquo; a login, aka &ldquo;log the user out&rdquo;</h1>

<p>def destroy</p>

<h1>Remove the user id from the session</h1>

<p>@_current_user = session[:current_user_id] = nil</p>

<p>redirect_to root_url</p>

<p>end</p>

<p>end</p>

<p>To reset the entire session, use <tt> </tt><tt>reset_session</tt>.<span style="font-family: DejaVu Sans;">从值整个</span>session<span style="font-family: DejaVu Sans;">，使用</span><tt>reset_session</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="the-flash"></a>4.2 The Flash</h4>


<p>The flash is a special part of the session which is cleared with each request. This means that values stored there will only be available in the next request, which is useful for storing error messages etc. It is accessed in much the same way as the session, like a hash. Let’s use the act of logging out as an example. The controller can send a message which will be displayed to the user on the next request:</p>

<p>flash<span style="font-family: DejaVu Sans;">在</span>session<span style="font-family: DejaVu Sans;">中是一个特殊的部分它它清楚于每个（下一次）请求。这里的意思是存储的值仅仅在下一个请求中是可用的，这在存储错误信息等是非常有用的。它的访问方式与</span>session<span style="font-family: DejaVu Sans;">的访问方式有着很大的相同之处，就像（访问）一个</span>hash<span style="font-family: DejaVu Sans;">字典那样。让我们使用登出动作作为一个例子。</span>controller<span style="font-family: DejaVu Sans;">会发送一个消息这个消息在下一个请求的时候将会显示给用户：</span></p>

<p>class LoginsController &lt; ApplicationController</p>

<p>def destroy</p>

<p>session[:current_user_id] = nil</p>

<p>flash[:notice] = &ldquo;You have successfully logged out&rdquo;</p>

<p>redirect_to root_url</p>

<p>end</p>

<p>end</p>

<p>Note it is also possible to assign a flash message as part of the redirection.</p>

<p>redirect_to root_url, :notice =&gt; &ldquo;You have successfully logged out&rdquo;</p>

<p>The <tt>destroy</tt> action redirects to the application’s <tt>root_url</tt>, where the message will be displayed. Note that it’s entirely up to the next action to decide what, if anything, it will do with what the previous action put in the flash. It’s conventional to display eventual errors or notices from the flash in the application’s layout:</p>

<p><tt>destroy</tt><span style="font-family: DejaVu Sans;"><tt>动作重定向到应用程序的</tt></span><tt>root_url,</tt><span style="font-family: DejaVu Sans;"><tt>在这里消息（刚添加的）将会被显示。注意：它完全取决于</tt></span><tt>next</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>来决定做什么，如果有（</tt></span><tt>next</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>），它将会完成</tt></span><tt>previous</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>放入</tt></span><tt>flash</tt><span style="font-family: DejaVu Sans;"><tt>中的信息。</tt></span></p>

<p>&lt;html&gt;</p>

<p>&lt;!&mdash; &lt;head/&gt; &mdash;&gt;</p>

<p>&lt;body&gt;</p>

<p>&lt;% if flash[:notice] %&gt;</p>

<p>&lt;p&gt;&lt;%= flash[:notice] %&gt;&lt;/p&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;% if flash[:error] %&gt;</p>

<p>&lt;p&gt;&lt;%= flash[:error] %&gt;&lt;/p&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;!&mdash; more content &mdash;&gt;</p>

<p>&lt;/body&gt;</p>

<p>&lt;/html&gt;</p>

<p>This way, if an action sets an error or a notice message, the layout will display it automatically<span style="font-family: DejaVu Sans;">。</span></p>

<p><span style="font-family: DejaVu Sans;">通过这种方式，如果</span>action<span style="font-family: DejaVu Sans;">设定一条</span>error<span style="font-family: DejaVu Sans;">或者通知消息，</span>laout<span style="font-family: DejaVu Sans;">将会自动的显示它。</span></p>

<p>If you want a flash value to be carried over to another request, use the <tt>keep</tt> method:</p>

<p><span style="font-family: DejaVu Sans;">如果你想一个</span>flash<span style="font-family: DejaVu Sans;">值转接到另一个</span>request<span style="font-family: DejaVu Sans;">，使用</span>keep<span style="font-family: DejaVu Sans;">方法：</span></p>

<p>class MainController &lt; ApplicationController</p>

<h1>Let&rsquo;s say this action corresponds to root_url, but you want</h1>

<h1>all requests here to be redirected to UsersController#index.</h1>

<h1>If an action sets the flash and redirects here, the values</h1>

<h1>would normally be lost when another redirect happens, but you</h1>

<h1>can use &lsquo;keep&rsquo; to make it persist for another request.</h1>

<p>def index</p>

<h1>Will persist all flash values.</h1>

<p>flash.keep</p>

<p>&nbsp;</p>

<h1>You can also use a key to keep only some kind of value.</h1>

<h1>flash.keep(:notice)</h1>

<p>redirect_to users_url</p>

<p>end</p>

<p>end</p>

<h5><a name="flash-now"></a>4.2.1 <tt>flash.now</tt></h5>


<p>By default, adding values to the flash will make them available to the next request, but sometimes you may want to access those values in the same request. For example, if the <tt>create</tt> action fails to save a resource and you render the <tt>new</tt> template directly, that’s not going to result in a new request, but you may still want to display a message using the flash. To do this, you can use <tt>flash.now</tt> in the same way you use the normal <tt>flash</tt>:</p>

<p><span style="font-family: DejaVu Sans;">默认情况，添加到</span>flash<span style="font-family: DejaVu Sans;">中的值在</span>next request<span style="font-family: DejaVu Sans;">中是可用的，但是有时你可以想在同样的</span>request<span style="font-family: DejaVu Sans;">中访问这些值。例如，如果</span><tt>create</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>保存</tt></span><tt>resource</tt><span style="font-family: DejaVu Sans;"><tt>失败并且你直接</tt></span><tt>render</tt><tt> </tt><tt>new</tt><tt> </tt><tt>template</tt><span style="font-family: DejaVu Sans;"><tt>，这样在一个</tt></span><tt>new</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>request</tt><span style="font-family: DejaVu Sans;"><tt>中没有得到</tt></span><tt>result</tt><span style="font-family: DejaVu Sans;"><tt>，但是你仍然希望使用</tt></span><tt>flash</tt><span style="font-family: DejaVu Sans;"><tt>显示消息。这样做，你可以就像使用</tt></span><tt>flash</tt><span style="font-family: DejaVu Sans;"><tt>那样使用</tt><tt></tt></span><tt>flash.now</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p>class ClientsController &lt; ApplicationController</p>

<p>def create</p>

<p>@client = Client.new(params[:client])</p>

<p>if @client.save</p>

<h1>&hellip;</h1>

<p>else</p>

<p>flash.now[:error] = &ldquo;Could not save client&rdquo;</p>

<p>render :action =&gt; &ldquo;new&rdquo;</p>

<p>end</p>

<p>end</p>

<p>end</p>

<h3><a name="cookies"></a>5 Cookies</h3>


<p>Your application can store small amounts of data on the client — called cookies — that will be persisted across requests and even sessions. Rails provides easy access to cookies via the <tt>cookies</tt> method, which — much like the <tt>session</tt> — works like a hash:</p>

<p><span style="font-family: DejaVu Sans;">你的应用程序可以存储少量</span>data<span style="font-family: DejaVu Sans;">在</span>client<span style="font-family: DejaVu Sans;">上<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>它被称之为</span>cookies——<span style="font-family: DejaVu Sans;">它会保持访问的请求以及曾经</span>sessions<span style="font-family: DejaVu Sans;">。</span>Rails<span style="font-family: DejaVu Sans;">提供简单的方式来访问</span>cookies<span style="font-family: DejaVu Sans;">通过</span>cookies<span style="font-family: DejaVu Sans;">方法，就像</span>session——<span style="font-family: DejaVu Sans;">一</span>hash<span style="font-family: DejaVu Sans;">字典那样工作（存储</span>data<span style="font-family: DejaVu Sans;">）：</span></p>

<p>class CommentsController &lt; ApplicationController</p>

<p>def new</p>

<h1>Auto-fill the commenter&rsquo;s name if it has been stored in a cookie</h1>

<p>@comment = Comment.new(:name =&gt; cookies[:commenter_name])</p>

<p>end</p>

<p>&nbsp;</p>

<p>def create</p>

<p>@comment = Comment.new(params[:comment])</p>

<p>if @comment.save</p>

<p>flash[:notice] = &ldquo;Thanks for your comment!&rdquo;</p>

<p>if params[:remember_name]#:remember_name<span style="font-family: DejaVu Sans;">这里相当于用户的的反馈是否记住</span>name</p>

<h1>Remember the commenter&rsquo;s name.</h1>

<p>cookies[:commenter_name] = @comment.name</p>

<p>else</p>

<h1>Delete cookie for the commenter&rsquo;s name cookie, if any.</h1>

<p>cookies.delete(:commenter_name)</p>

<p>end</p>

<p>redirect_to @comment.article</p>

<p>else</p>

<p>render :action =&gt; &ldquo;new&rdquo;</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>Note that while for session values you set the key to <tt>nil</tt>, to delete a cookie value you should use <tt>cookies.delete(:key)</tt>.</p>

<h3><a name="rendering-xml-and-json-data"></a>6 Rendering xml and json data</h3>


<p>ActionController makes it extremely easy to render <tt>xml</tt> or <tt>json</tt> data. If you generate a controller using scaffold then your controller would look something like this.</p>

<p>ActionController<span style="font-family: DejaVu Sans;">使得</span>render xml<span style="font-family: DejaVu Sans;">或者</span>json<span style="font-family: DejaVu Sans;">数据相当简单。如果你使用</span>scaffold<span style="font-family: DejaVu Sans;">创建一个</span>controller<span style="font-family: DejaVu Sans;">那么你的</span>controller<span style="font-family: DejaVu Sans;">看起来将会像这样：</span></p>

<p>class UsersController &lt; ApplicationController</p>

<p>def index</p>

<p>@users = User.all</p>

<p>respond_to do |format|</p>

<p>format.html # index.html.erb</p>

<p>format.xml { render :xml =&gt; @users}</p>

<p>format.json { render :json =&gt; @users}</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>Notice that in the above case code is <tt>render</tt><tt> </tt><tt>:xml</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>@users</tt> and not <tt>render</tt><tt> </tt><tt>:xml</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>@users.to_xml</tt>. That is because if the input is not string then rails automatically invokes <tt>to_xml</tt> .</p>

<p><span style="font-family: DejaVu Sans;">注意在</span>render<span style="font-family: DejaVu Sans;">中的完整示例代码是</span><tt>render</tt><tt> </tt><tt>:xml</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>@users</tt><span style="font-family: DejaVu Sans;"><tt>并不是</tt><tt></tt></span><tt>render</tt><tt> </tt><tt>:xml</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>@users.to_xml</tt><span style="font-family: DejaVu Sans;"><tt>，那是因为如果输入的不是</tt></span><tt>string</tt><span style="font-family: DejaVu Sans;"><tt>那么</tt></span><tt>rails</tt><span style="font-family: DejaVu Sans;"><tt>自动调用</tt></span><tt>to_xml</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h3><a name="filters"></a>7 Filters<span style="font-family: WenQuanYi Micro Hei;">过滤器</span></h3>


<p>Filters are methods that are run before, after or “around” a controller action.</p>

<p>Filters<span style="font-family: DejaVu Sans;">是一个方法它运行在</span>controller action<span style="font-family: DejaVu Sans;">之前或者伴随着</span>controller action<span style="font-family: DejaVu Sans;">。</span></p>

<p>Filters are inherited, so if you set a filter on <tt>ApplicationController</tt>, it will be run on every controller in your application.</p>

<p>Filters<span style="font-family: DejaVu Sans;">是可继承的，因此如果你在</span><tt>ApplicationController</tt><tt> </tt><span style="font-family: DejaVu Sans;">设置了一个</span>filter<span style="font-family: DejaVu Sans;">，他将会在你的应用程序的每个</span>controller<span style="font-family: DejaVu Sans;">中运行。</span></p>

<p>Before filters may halt the request cycle. A common before filter is one which requires that a user is logged in for an action to be run. You can define the filter method this way:</p>

<p><span style="font-family: DejaVu Sans;">在</span>filters<span style="font-family: DejaVu Sans;">之前可能会停止</span>request<span style="font-family: DejaVu Sans;">周期。一个通常情况在</span>filter<span style="font-family: DejaVu Sans;">之前的是用户</span>logged in<span style="font-family: DejaVu Sans;">的</span>requires<span style="font-family: DejaVu Sans;">使之对应的</span>action<span style="font-family: DejaVu Sans;">被运行。你可以这样定义</span>filter<span style="font-family: DejaVu Sans;">方法：</span></p>

<p>class ApplicationController &lt; ActionController::Base</p>

<p>before_filter :require_login</p>

<p>&nbsp;</p>

<p>private</p>

<p>&nbsp;</p>

<p>def require_login</p>

<p>unless logged_in?</p>

<p>flash[:error] = &ldquo;You must be logged in to access this section&rdquo;</p>

<p>redirect_to new_login_url # halts request cycle</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<h1>The logged_in? method simply returns true if the user is logged</h1>

<h1>in and false otherwise. It does this by &ldquo;booleanizing&rdquo; the</h1>

<h1>current_user method we created previously using a double ! operator.</h1>

<h1>Note that this is not common in Ruby and is discouraged unless you</h1>

<h1>really mean to convert something into true or false.</h1>

<p>def logged_in?</p>

<p>!!current_user</p>

<p>end</p>

<p>end</p>

<p>The method simply stores an error message in the flash and redirects to the login form if the user is not logged in. If a before filter renders or redirects, the action will not run. If there are additional filters scheduled to run after that filter they are also cancelled.</p>

<p><span style="font-family: DejaVu Sans;">这个方法简单的存储一个错误消息在</span>flash<span style="font-family: DejaVu Sans;">中并且重定向到</span>login<span style="font-family: DejaVu Sans;">表单如果用户没有登录。如果是一个在</span>filter<span style="font-family: DejaVu Sans;">之前的</span>renderes<span style="font-family: DejaVu Sans;">或者重定向，这个</span>action<span style="font-family: DejaVu Sans;">将不会运行。如果这里有额外附加的</span>filters<span style="font-family: DejaVu Sans;">计划运行并且在这个</span>filter<span style="font-family: DejaVu Sans;">之后，它们也将取消（执行）。</span></p>

<p>In this example the filter is added to <tt><strong>ApplicationController</strong></tt> and thus all controllers in the application inherit it. This will make everything in the application <span style="color: #800000;">require</span><span style="color: #800000;">the</span><span style="color: #800000;">user</span><span style="color: #800000;">to</span><span style="color: #800000;">be</span><span style="color: #800000;">logged</span><span style="color: #800000;">in</span><span style="color: #800000;">in</span><span style="color: #800000;">order</span><span style="color: #800000;">to</span><span style="color: #800000;">use</span><span style="color: #800000;">it</span>. For obvious reasons (the user wouldn’t be able to log in in the first place!), not all controllers or actions should require this. You can prevent this filter from running before particular actions with <tt>skip_before_filter</tt>:</p>

<p><span style="font-family: DejaVu Sans;">明显的原因（在第一次登录的时候不能登录），并不是所有的</span>controllers<span style="font-family: DejaVu Sans;">或者</span>actions<span style="font-family: DejaVu Sans;">需要登录，你可以使用</span><tt>skip_before_filter</tt><tt> </tt><span style="font-family: DejaVu Sans;">在部分</span>action<span style="font-family: DejaVu Sans;">运行之前阻止这个</span>filter<span style="font-family: DejaVu Sans;">：</span></p>

<p>class LoginsController &lt; ApplicationController</p>

<p>skip_before_filter :require_login, :only =&gt; [:new, :create]</p>

<p>end</p>

<p>Now, the <tt>LoginsController</tt>’s <tt>new</tt> and <tt>create</tt> actions will work as before without requiring the user to be logged in. The <tt>:only</tt> option is used to only skip this filter for these actions, and there is also an <tt>:except</tt> option which works the other way. These options can be used when adding filters too, so you can add a filter which only runs for selected actions in the first place.</p>

<p><span style="font-family: DejaVu Sans;">现在，</span><tt>LoginsController</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>new</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>create</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>工作之前不再需要用户已经登录站点来。</tt></span><tt>:only</tt><span style="font-family: DejaVu Sans;"><tt>选项使用于仅仅在这些</tt></span><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>中略过</tt></span><tt>filter</tt><span style="font-family: DejaVu Sans;"><tt>，同样这里也有</tt></span><tt>:except</tt><span style="font-family: DejaVu Sans;"><tt>选项一相反的方式工作。这些选项也可以在添加</tt></span><tt>filters</tt><span style="font-family: DejaVu Sans;"><tt>的时候使用，因此你可以添加一个</tt></span><tt>filter</tt><span style="font-family: DejaVu Sans;"><tt>其仅仅在选择的</tt></span><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>第一次运行的时候执行（忽略）。</tt></span></p>

<h4><a name="after-filters-and-around-filters"></a>7.1 After Filters and Around Filters</h4>


<p>In addition to before filters, you can also run filters after an action has been executed, or both before and after.</p>

<p><span style="font-family: DejaVu Sans;">除了在</span>filters<span style="font-family: DejaVu Sans;">之前，你也可以在</span>action<span style="font-family: DejaVu Sans;">被执行之后运行</span>filters<span style="font-family: DejaVu Sans;">，或者在之前和过后都执行。</span></p>

<p>After filters are similar to before filters, but because the action has already been run they have access to the response data that’s about to be sent to the client. Obviously, after filters cannot stop the action from running.</p>

<p>After filters<span style="font-family: DejaVu Sans;">（执行</span>action<span style="font-family: DejaVu Sans;">）和</span>before filters<span style="font-family: DejaVu Sans;">类似，但是因为</span>action<span style="font-family: DejaVu Sans;">已经被运行，这些</span>filter<span style="font-family: DejaVu Sans;">会访问</span>response data<span style="font-family: DejaVu Sans;">并且，</span>response data<span style="font-family: DejaVu Sans;">会全部发送给</span>client<span style="font-family: DejaVu Sans;">。明显的，</span>after filters<span style="font-family: DejaVu Sans;">不能够停止</span>action<span style="font-family: DejaVu Sans;">的运行。</span></p>

<p>Around filters are responsible for running their associated actions by yielding, similar to how Rack middlewares work.</p>

<p>Around filters<span style="font-family: DejaVu Sans;">能够通过</span>yielding<span style="font-family: DejaVu Sans;">运行（</span>Around filters<span style="font-family: DejaVu Sans;">执行的</span>action<span style="font-family: DejaVu Sans;">的）关联的</span>action<span style="font-family: DejaVu Sans;">，类似于</span>Rack middlewares<span style="font-family: DejaVu Sans;">工作方式。</span></p>

<p>For example, in a website where changes have an approval workflow an administrator could be able to preview them easily, just apply them within a transaction:</p>

<p><span style="font-family: DejaVu Sans;">例如，在一个</span>website<span style="font-family: DejaVu Sans;">更改操作有一个批准工作流程，管理员可以很容易预览这些内容，仅仅在一个</span>transaction<span style="font-family: DejaVu Sans;">中就可以实现这个功能的应用：</span></p>

<p>class ChangesController &lt; ActionController::Base</p>

<p>around_filter :wrap_in_transaction, :only =&gt; :show</p>

<p>&nbsp;</p>

<p>private</p>

<p>&nbsp;</p>

<p>def wrap_in_transaction</p>

<p>ActiveRecord::Base.transaction do</p>

<p>begin</p>

<p>yield</p>

<p>ensure</p>

<p>raise ActiveRecord::Rollback</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>Note that an around filter wraps also rendering. In particular, if in the example above the view itself reads from the database via a scope or whatever, it will do so within the transaction and thus present the data to preview.</p>

<p><span style="font-family: DejaVu Sans;">注意</span>around filter<span style="font-family: DejaVu Sans;">同样也会</span>render<span style="font-family: DejaVu Sans;">。特别的是，如果在上述例子中，</span>view<span style="font-family: DejaVu Sans;">自己通过一个</span>scpoe<span style="font-family: DejaVu Sans;">或者其他从数据库中读取（数据），他将会在</span>transaction<span style="font-family: DejaVu Sans;">中实现</span>approval workflow<span style="font-family: DejaVu Sans;">并且将当前数据预览呈现。</span></p>

<p>They can choose not to yield and build the response themselves, in which case the action is not run.</p>

<p><span style="font-family: DejaVu Sans;">他们（</span>admin<span style="font-family: DejaVu Sans;">）可以选择不</span>yield<span style="font-family: DejaVu Sans;">并且建立他们自己的</span>response<span style="font-family: DejaVu Sans;">，这样（更改的）</span>action<span style="font-family: DejaVu Sans;">将不会运行。</span></p>

<h4><a name="other-ways-to-use-filters"></a>7.2 Other Ways to Use Filters <span style="font-family: WenQuanYi Micro Hei;">过滤器的其他使用方式</span></h4>


<p>While the most common way to use filters is by creating private methods and using *_filter to add them, there are two other ways to do the same thing.</p>

<p><span style="font-family: DejaVu Sans;">即使通常使用过滤器的方式是创建私有的方法并且使用</span>*_filter<span style="font-family: DejaVu Sans;">（</span>around_filter :wrap_in_transaction, :only =&gt; :show<span style="font-family: DejaVu Sans;">）来添加他们，这里有两种其他的方法来做同样的事情。</span></p>

<p>The first is to use a block directly with the *_filter methods. The block receives the controller as an argument, and the <tt>require_login</tt> filter from above could be rewritten to use a block:</p>

<p><span style="font-family: DejaVu Sans;">第一种方法是使用一个</span>*_filter methods<span style="font-family: DejaVu Sans;">的</span>block<span style="font-family: DejaVu Sans;">（块）。这个</span>block<span style="font-family: DejaVu Sans;">接收</span>controller<span style="font-family: DejaVu Sans;">为一个参数，，并且从</span>above<span style="font-family: DejaVu Sans;">（上下文中的上文）</span>could be rewritten to use a block<span style="font-family: DejaVu Sans;">：</span><strong>#</strong><span style="font-family: DejaVu Sans;"><strong>这个例子中也是第一次登录无法完成，没有忽略登录</strong></span><strong>action</strong><span style="font-family: DejaVu Sans;"><strong>。</strong></span></p>

<p>class ApplicationController &lt; ActionController::Base</p>

<p>before_filter do |controller|</p>

<p>redirect_to new_login_url unless controller.send(:logged_in?)</p>

<p>end</p>

<p>end</p>

<p>Note that the filter in this case uses <tt>send</tt> because the <tt>logged_in?</tt> method is private and the filter is not run in the scope of the controller. This is not the recommended way to implement this particular filter, but in more simple cases it might be useful.</p>

<p><span style="font-family: DejaVu Sans;">注意这个例子中的</span>filter<span style="font-family: DejaVu Sans;">使用的是</span>send<span style="font-family: DejaVu Sans;">因为</span><tt>logged_in?</tt><span style="font-family: DejaVu Sans;"><tt>方法是私有的并且</tt></span><tt>filter</tt><span style="font-family: DejaVu Sans;"><tt>并不在</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>的范围内运行。这里并不是实施这个特别的</tt></span><tt>filter</tt><span style="font-family: DejaVu Sans;"><tt>的推荐的方式，但是在很多简单的情况下这可能会有用。</tt></span></p>

<p><tt>The</tt><tt> </tt><tt>second</tt><tt> </tt><tt>way</tt><tt> </tt><tt>is</tt><tt> </tt><tt>to</tt><tt> </tt><tt>use</tt><tt> </tt><tt>a</tt><tt> </tt><tt>class</tt><tt> </tt><tt>(actually,</tt><tt> </tt><tt>any</tt><tt> </tt><tt>object</tt><tt> </tt><tt>that</tt><tt> </tt><tt>responds</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>right</tt><tt> </tt><tt>methods</tt><tt> </tt><tt>will</tt><tt> </tt><tt>do)</tt><tt> </tt><tt>to</tt><tt> </tt><tt>handle</tt><tt> </tt><tt>the</tt><tt> </tt><tt>filtering.</tt><tt> </tt><tt>This</tt><tt> </tt><tt>is</tt><tt> </tt><tt>useful</tt><tt> </tt><tt>in</tt><tt> </tt><tt>cases</tt><tt> </tt><tt>that</tt><tt> </tt><tt>are</tt><tt> </tt><tt>more</tt><tt> </tt><tt>complex</tt><tt> </tt><tt>and</tt><tt> </tt><tt>can</tt><tt> </tt><tt>not</tt><tt> </tt><tt>be</tt><tt> </tt><tt>implemented</tt><tt> </tt><tt>in</tt><tt> </tt><tt>a</tt><tt> </tt><tt>readable</tt><tt> </tt><tt>and</tt><tt> </tt><tt>reusable</tt><tt> </tt><tt>way</tt><tt> </tt><tt>using</tt><tt> </tt><tt>the</tt><tt> </tt><tt>two</tt><tt> </tt><tt>other</tt><tt> </tt><tt>methods.</tt><tt> </tt><tt>As</tt><tt> </tt><tt>an</tt><tt> </tt><tt>example,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>could</tt><tt> </tt><tt>rewrite</tt><tt> </tt><tt>the</tt><tt> </tt><tt>login</tt><tt> </tt><tt>filter</tt><tt> </tt><tt>again</tt><tt> </tt><tt>to</tt><tt> </tt><tt>use</tt><tt> </tt><tt>a</tt><tt> </tt><tt>class:</tt></p>

<p><span style="font-family: DejaVu Sans;">第二种方式是使用一个</span>class<span style="font-family: DejaVu Sans;">（实际上，<tt>响应正确方法的任何对象都是可以的</tt>）来处理</span>filtering<span style="font-family: DejaVu Sans;">。这在非常复杂的情况下，在只读不能</span><tt>implemented</tt><span style="font-family: DejaVu Sans;">，重复使用两种其他方法是非常有用的。在例子中，你可以使用一个</span>class<span style="font-family: DejaVu Sans;">来再次重写</span>login filter<span style="font-family: DejaVu Sans;">：</span></p>

<p>class ApplicationController &lt; ActionController::Base</p>

<p>before_filter LoginFilter</p>

<p>end</p>

<p>&nbsp;</p>

<p>class LoginFilter</p>

<p>def self.filter(controller)</p>

<p>unless controller.send(:logged_in?)</p>

<p>controller.flash[:error] = &ldquo;You must be logged in&rdquo;</p>

<p>controller.redirect_to controller.new_login_url</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>Again, this is not an ideal example for this filter, because it’s not run in the scope of the controller but gets the controller passed as an argument. The filter class has a class method <tt>filter</tt> which gets run before or after the action, depending on if it’s a before or after filter. Classes used as around filters can also use the same <tt>filter</tt> method, which will get run in the same way. The method must <tt>yield</tt> to execute the action. Alternatively, it can have both a <tt>before</tt> and an <tt>after</tt> method that are run before and after the action.</p>

<p><span style="font-family: DejaVu Sans;">同样的，对于这种</span>filter<span style="font-family: DejaVu Sans;">这不是一个（好）主意，因为它在</span>controller<span style="font-family: DejaVu Sans;">的范围中不会运行但是获取</span>controller<span style="font-family: DejaVu Sans;">为一个参数。</span>filter <span style="font-family: DejaVu Sans;">类有一个类方法</span>filter<span style="font-family: DejaVu Sans;">，它在</span>before<span style="font-family: DejaVu Sans;">或者</span>after action<span style="font-family: DejaVu Sans;">运行，这依赖于它是一个</span>before<span style="font-family: DejaVu Sans;">还是</span>after filter<span style="font-family: DejaVu Sans;">。使用</span>around filters<span style="font-family: DejaVu Sans;">的类同样也可以使用</span>filter <span style="font-family: DejaVu Sans;">方法，其也会以相同的方式运行。（</span>filter<span style="font-family: DejaVu Sans;">）方法必须</span>yield to <span style="font-family: DejaVu Sans;">执行的</span>action<span style="font-family: DejaVu Sans;">。另外，它也可以同时有</span>before<span style="font-family: DejaVu Sans;">和</span>after<span style="font-family: DejaVu Sans;">方法在</span>before <span style="font-family: DejaVu Sans;">和</span>after action<span style="font-family: DejaVu Sans;">中运行。</span></p>

<h3><a name="request-forgery-protection"></a>8 Request Forgery Protection<span style="font-family: WenQuanYi Micro Hei;">伪造请求保护</span></h3>


<p>Cross-site request forgery is a type of attack in which a site tricks a user into making requests on another site, possibly adding, modifying or deleting data on that site without the user’s knowledge or permission.</p>

<p><span style="font-family: DejaVu Sans;">跨站伪造请求是一种典型的攻击方式，在这种攻击方式中，一个网站诱骗用户发送请求到另一个网站，可能在这个站点中添加，修改或者删除数据并没有用户的信息或者权限。</span></p>

<p>The first step to avoid this is to make sure all “destructive” actions (create, update and destroy) can only be accessed with non-GET requests. If you’re following RESTful conventions you’re already doing this. However, a malicious site can still send a non-GET request to your site quite easily, and that’s where the request forgery protection comes in. As the name says, it protects from forged requests.</p>

<p><span style="font-family: DejaVu Sans;">避免这样的事情发生的第一步是确保所有的<span style="font-family: Liberation Serif,Times New Roman,serif;"> “</span></span>destructive”<span style="font-family: DejaVu Sans;">（破坏性）</span>actions(create, update and destroy)<span style="font-family: DejaVu Sans;">只能接受</span>non-GET<span style="font-family: DejaVu Sans;">请求。如果你遵循</span>RESTful<span style="font-family: DejaVu Sans;">公约你已经这样做了。然而，一个恶意的网站仍然可以轻易的发送一个</span>non-GET<span style="font-family: DejaVu Sans;">请求到你的站点，到这里就该伪造请求保护（</span>request forgery protection<span style="font-family: DejaVu Sans;">）出场了。正如名字所说，它防护伪造请求（对你站点的攻击）。</span></p>

<p>If you generate a form like this:<span style="font-family: DejaVu Sans;">如果你像下面这样生成表单：</span></p>

<p>&lt;%= form_for @user do |f| %&gt;</p>

<p>&lt;%= f.text_field :username %&gt;</p>

<p>&lt;%= f.text_field :password %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>You will see how the token gets added as a hidden field:</p>

<p><span style="font-family: DejaVu Sans;">你将会看到令牌是怎样作为一个</span>hidden field<span style="font-family: DejaVu Sans;">添加：</span></p>

<p>&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/users/1&rdquo; method=&ldquo;post&rdquo;&gt;</p>

<p>&lt;input type=&ldquo;hidden&rdquo;</p>

<p>value=&ldquo;67250ab105eb5ad10851c00a5621854a23af5489&rdquo;</p>

<p>name=&ldquo;authenticity_token&rdquo;/&gt;</p>

<p>&lt;!&mdash; fields &mdash;&gt;</p>

<p>&lt;/form&gt;</p>

<p>Rails adds this token to every form that’s generated using the <a href="http://guides.rubyonrails.org/form_helpers.html"><span style="color: #000080;"><span style="text-decoration: underline;">form</span></span><span style="color: #000080;"><span style="text-decoration: underline;">helpers</span></span></a>, so most of the time you don’t have to worry about it. If you’re writing a form manually or need to add the token for another reason, it’s available through the method <tt>form_authenticity_token</tt>:</p>

<p>Rails<span style="font-family: DejaVu Sans;">为每个使用</span>form helpers<span style="font-family: DejaVu Sans;">生成的</span>form<span style="font-family: DejaVu Sans;">添加这样的令牌。因此大多数时间你不需要担心这样的问题。如果你打算手动编写一个</span>form<span style="font-family: DejaVu Sans;">或者因为其他的原因需要添加令牌，这也是可以的通过</span><tt>form_authenticity_token</tt><span style="font-family: DejaVu Sans;"><tt>方法来实现：</tt></span></p>

<p><tt>form_authenticity_token</tt><span style="font-family: DejaVu Sans;"><tt>生成一个有效的认证令牌。这在</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>不会自动添加的地方非常有用，比如在定制</tt></span><tt>Ajax</tt><span style="font-family: DejaVu Sans;"><tt>调用的时候。</tt></span></p>

<p>The <a href="http://guides.rubyonrails.org/security.html"><span style="color: #000080;"><span style="text-decoration: underline;">Security</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a> has more about this and a lot of other security-related issues that you should be aware of when developing a web application.</p>

<p><a href="http://guides.rubyonrails.org/security.html"><span style="color: #000080;"><span style="text-decoration: underline;">Security</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a> <span style="font-family: DejaVu Sans;">有更多的关于这些以及许多其他安全相关的问题（的解决方法）你在开发一个</span>web application<span style="font-family: DejaVu Sans;">的时候应该保持清醒。</span></p>

<h3>9 The Request and Response Objects</h3>


<p>In every controller there are two accessor methods pointing to the request and the response objects associated with the request cycle that is currently in execution. The <tt>request</tt> method contains an instance of <tt>AbstractRequest</tt> and the <tt>response</tt> method returns a response object representing what is going to be sent back to the client.</p>

<p><span style="font-family: DejaVu Sans;">在每个</span>controller<span style="font-family: DejaVu Sans;">有两个指向与目前正在执行的请求周期相关的</span>request <span style="font-family: DejaVu Sans;">和</span>response <span style="font-family: DejaVu Sans;">对象的访问方法。</span>request<span style="font-family: DejaVu Sans;">方法包含一个</span><tt>AbstractRequest</tt><span style="font-family: DejaVu Sans;"><tt>的实例以及</tt><tt></tt></span><tt>response</tt><span style="font-family: DejaVu Sans;"><tt>方法返回一个</tt></span><tt>response</tt><span style="font-family: DejaVu Sans;"><tt>对象表示什么打算发送回</tt></span><tt>client</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="the-request-object"></a>9.1 The <tt>request</tt> Object</h4>


<p>The request object contains a lot of useful information about the request coming in from the client. To get a full list of the available methods, refer to the <a href="http://api.rubyonrails.org/classes/ActionDispatch/Request.html"><span style="color: #000080;"><span style="text-decoration: underline;">API</span></span><span style="color: #000080;"><span style="text-decoration: underline;">documentation</span></span></a>. Among the properties that you can access on this object are:</p>

<p>request<span style="font-family: DejaVu Sans;">对象包含很多来自发出请求的</span>client<span style="font-family: DejaVu Sans;">的有用信息。要得到可用方法的完整列表，参考</span><a href="http://api.rubyonrails.org/classes/ActionDispatch/Request.html"><span style="color: #000080;"><span style="text-decoration: underline;">API</span></span><span style="color: #000080;"><span style="text-decoration: underline;">documentation</span></span></a><span style="font-family: DejaVu Sans;">。其中你可以在这个对象中访问的属性有：</span></p>

<p>&nbsp;</p>

<table width="665" cellspacing="0" cellpadding="2"><colgroup><col width="194" /> <col width="463" /> </colgroup>
<tbody>
<tr>
<th width="194">Property of <tt>request</tt></th>
<th width="463">Purpose</th>
</tr>
<tr>
<td width="194">host</td>
<td width="463">The hostname used for this request.</td>
</tr>
<tr>
<td width="194">domain(n=2)</td>
<td width="463">The hostname’s first <tt>n</tt> segments, starting from the right (the TLD).</td>
</tr>
<tr>
<td width="194">format</td>
<td width="463">The content type requested by the client.</td>
</tr>
<tr>
<td width="194">method</td>
<td width="463">The HTTP method used for the request.</td>
</tr>
<tr>
<td width="194">get?, post?, put?, delete?, head?</td>
<td width="463">Returns true if the HTTP method is GET/POST/PUT/DELETE/HEAD.</td>
</tr>
<tr>
<td width="194">headers</td>
<td width="463">Returns a hash containing the headers associated with the request.</td>
</tr>
<tr>
<td width="194">port</td>
<td width="463">The port number (integer) used for the request.</td>
</tr>
<tr>
<td width="194">protocol</td>
<td width="463">Returns a string containing the protocol used plus “://”, for example “http://”.</td>
</tr>
<tr>
<td width="194">query_string</td>
<td width="463">The query string part of the URL, i.e., everything after “?”.</td>
</tr>
<tr>
<td width="194">remote_ip</td>
<td width="463">The IP address of the client.</td>
</tr>
<tr>
<td width="194">url</td>
<td width="463">The entire URL used for the request.</td>
</tr>
</tbody>
</table>


<p>&nbsp;</p>

<h5><a name="path_parameters-query_parameters-and-req"></a> 9.1.1 <tt>path_parameters</tt>, <tt>query_parameters</tt>, and <tt>request_parameters</tt></h5>


<p>Rails collects all of the parameters sent along with the request in the <tt>params</tt> hash, whether they are sent as part of the query string or the post body. The request object has three accessors that give you access to these parameters depending on where they came from. The <tt>query_parameters</tt> hash contains parameters that were sent as part of the query string while the <tt>request_parameters</tt> hash contains parameters sent as part of the post body. The <tt>path_parameters</tt> hash contains parameters that were recognized by the routing as being part of the path leading to this particular controller and action.</p>

<p>Rails<span style="font-family: DejaVu Sans;">收集所有的</span>parameters<span style="font-family: DejaVu Sans;">于</span>params hash<span style="font-family: DejaVu Sans;">字典中于</span>request<span style="font-family: DejaVu Sans;">一起发送，无论是作为</span>query <span style="font-family: DejaVu Sans;">字符串的一部分发送还是在</span>post body<span style="font-family: DejaVu Sans;">中发送。</span>request<span style="font-family: DejaVu Sans;">有三个访问器提供给你访问这些参数这依赖于它来自哪里。</span><tt>query_parameters</tt><tt> </tt><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典包含作为查询字符串的一部分发送的参数，而</tt><tt></tt></span><tt>request_parameters</tt><span style="font-family: DejaVu Sans;"><tt>包含作为</tt></span><tt>post</tt><tt> </tt><tt>body</tt><span style="font-family: DejaVu Sans;"><tt>的一个部分发送的参数。</tt><tt></tt></span><tt>path_parameters</tt><tt> </tt><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典包含被</tt></span><tt>routing</tt><span style="font-family: DejaVu Sans;"><tt>组织作为指向特殊的</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>的参数。</tt></span></p>

<h4><a name="the-response-object"></a>9.2 The <tt>response</tt> Object</h4>


<p>The response object is not usually used directly, but is during the execution of the action and rendering of the data that is being sent back to the user, but sometimes – like in an after filter – it can be useful to access the response directly. Some of these accessor methods also have setters, allowing you to change their values.</p>

<p>response object<span style="font-family: DejaVu Sans;">通常并不直接使用，但是它在</span>action<span style="font-family: DejaVu Sans;">的执行与</span>rendering<span style="font-family: DejaVu Sans;">的数据被发送回给用户期间建立，但是有的时候——像在一个</span>after filter——<span style="font-family: DejaVu Sans;">它在直接访问</span>response<span style="font-family: DejaVu Sans;">（</span>object<span style="font-family: DejaVu Sans;">）会非常有用。这些访问器中的一些</span>methods<span style="font-family: DejaVu Sans;">也有</span>setters<span style="font-family: DejaVu Sans;">，允许你改变它们的值。</span></p>

<p>&nbsp;</p>

<table width="665" cellspacing="0" cellpadding="2"><colgroup><col width="146" /> <col width="511" /> </colgroup>
<tbody>
<tr>
<th width="146">Property of <tt>response</tt></th>
<th width="511">Purpose</th>
</tr>
<tr>
<td width="146">body</td>
<td width="511">This is the string of data being sent back to the client. This is most often HTML.</td>
</tr>
<tr>
<td width="146">status</td>
<td width="511">The HTTP status code for the response, like 200 for a successful request or 404 for file not found.</td>
</tr>
<tr>
<td width="146">location</td>
<td width="511">The URL the client is being redirected to, if any.</td>
</tr>
<tr>
<td width="146">content_type</td>
<td width="511">The content type of the response.</td>
</tr>
<tr>
<td width="146">charset</td>
<td width="511">The character set being used for the response. Default is “utf-8”.</td>
</tr>
<tr>
<td width="146">headers</td>
<td width="511">Headers used for the response.</td>
</tr>
</tbody>
</table>


<p>&nbsp;</p>

<h5><a name="setting-custom-headers"></a>9.2.1 Setting Custom Headers</h5>


<p>If you want to set custom headers for a response then <tt>response.headers</tt> is the place to do it. The headers attribute is a hash which maps header names to their values, <strong>and Rails will set some of them automatically.</strong> If you want to add or change a header, just assign it to <tt>response.headers</tt> this way:</p>

<p>response.headers[&ldquo;Content-Type&rdquo;] = &ldquo;application/pdf&rdquo;</p>

<h3><a name="http-authentications"></a>10 HTTP Authentications</h3>


<p>Rails comes with two built-in HTTP authentication mechanisms:</p>

<ul>
    <li>Basic Authentication</li>
    <li>Digest Authentication</li>
</ul>


<h4><a name="http-basic-authentication"></a>10.1 HTTP Basic Authentication</h4>


<p>HTTP basic authentication is an authentication scheme that is supported by the majority of browsers and other HTTP clients. As an example, consider an administration section which will only be available by entering a username and a password into the browser’s HTTP basic dialog window. Using the built-in authentication is quite easy and only requires you to use one method, <tt>http_basic_authenticate_with</tt>.</p>

<p><span style="font-family: DejaVu Sans;">基于</span>HTTP<span style="font-family: DejaVu Sans;">的认证是一个认证结构它被主流的浏览器以及其他的</span>HTTP clients<span style="font-family: DejaVu Sans;">支持。作为一个例子，思考一个管理员</span>section<span style="font-family: DejaVu Sans;">它仅仅可以输入</span>username<span style="font-family: DejaVu Sans;">和</span>password<span style="font-family: DejaVu Sans;">到浏览器的基于</span>HTTP<span style="font-family: DejaVu Sans;">对话框窗口。使用内建的认证是十分简单的仅仅需要你使用一个方法，</span><tt>http_basic_authenticate_with</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>class AdminController &lt; ApplicationController</p>

<p>http_basic_authenticate_with :name =&gt; &ldquo;humbaba&rdquo;, :password =&gt; &ldquo;5baa61e4&rdquo;</p>

<p>end</p>

<p>With this in place, you can create namespaced controllers that inherit from <tt>AdminController</tt>. The filter will thus be run for all actions in those controllers, protecting them with HTTP basic authentication.</p>

<p><span style="font-family: DejaVu Sans;">通过将这段代码，你可以创建继承至</span><tt>AdminController</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span>namespaced controller<span style="font-family: DejaVu Sans;">。过滤器将自动对这些</span>controllers<span style="font-family: DejaVu Sans;">中的所有的</span>action<span style="font-family: DejaVu Sans;">运行这样的（认证），使用基于</span>HTTP<span style="font-family: DejaVu Sans;">的认证来保护它们。</span></p>

<h6>##in demo</h6>

<p>class PostsController &lt; ApplicationController</p>

<p>http_basic_authenticate_with :name =&gt; &ldquo;test&rdquo;, :password =&gt; &ldquo;123456&rdquo;, :except =&gt; :index</p>

<p>end</p>

<h4><a name="http-digest-authentication"></a>10.2 HTTP Digest Authentication</h4>


<p>HTTP digest authentication is superior to the basic authentication as it does not require the client to send an unencrypted password over the network (though HTTP basic authentication is safe over HTTPS). Using digest authentication with Rails is quite easy and only requires using one method, <tt>authenticate_or_request_with_http_digest</tt>.</p>

<p>HTTP <span style="font-family: DejaVu Sans;">精简认证优于基础认证因为它不需要</span>client<span style="font-family: DejaVu Sans;">发送一个未加密的穿过网络（即使</span>HTTP<span style="font-family: DejaVu Sans;">基础的认证比</span>HTTPS<span style="font-family: DejaVu Sans;">更安全）。在</span>Rails<span style="font-family: DejaVu Sans;">中使用 </span>digest authentication<span style="font-family: DejaVu Sans;">相当容易并且仅仅需要使用一个方法，</span><tt>authenticate_or_request_with_http_digest</tt><span style="font-family: DejaVu Sans;">。</span></p>

<p>class AdminController &lt; ApplicationController</p>

<p>USERS = { &ldquo;lifo&rdquo; =&gt; &ldquo;world&rdquo; }</p>

<p>&nbsp;</p>

<p>before_filter :authenticate</p>

<p>&nbsp;</p>

<p>private</p>

<p>&nbsp;</p>

<p>def authenticate</p>

<p>authenticate_or_request_with_http_digest do |username|</p>

<p>USERS[username]</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>As seen in the example above, the <tt>authenticate_or_request_with_http_digest</tt> block takes only one argument – the username. And the block returns the password. Returning <tt>false</tt> or <tt>nil</tt> from the <tt>authenticate_or_request_with_http_digest</tt> will cause authentication failure.</p>

<p><span style="font-family: DejaVu Sans;">正如上面看到例子， </span><tt>authenticate_or_request_with_http_digest</tt><span style="font-family: DejaVu Sans;"><tt>代码块仅仅获取一个参数——</tt></span><tt>username</tt><span style="font-family: DejaVu Sans;"><tt>。并且</tt></span><tt>block</tt><span style="font-family: DejaVu Sans;"><tt>（</tt></span><tt>do&hellip;end</tt><span style="font-family: DejaVu Sans;"><tt>之间的</tt></span><tt>block</tt><span style="font-family: DejaVu Sans;"><tt>）返回</tt></span><tt>password</tt><span style="font-family: DejaVu Sans;"><tt>。从 </tt></span><tt>authenticate_or_request_with_http_digest</tt><span style="font-family: DejaVu Sans;"><tt>返回</tt></span><tt>false</tt><span style="font-family: DejaVu Sans;"><tt>或者</tt></span><tt>nil</tt><span style="font-family: DejaVu Sans;"><tt>将会导致认证失败。</tt></span></p>

<h3><a name="streaming-and-file-downloads"></a>11 Streaming and File Downloads</h3>


<p>Sometimes you may want to send a file to the user instead of rendering an HTML page. All controllers in Rails have the <tt>send_data</tt> and the <tt>send_file</tt> methods, which will both stream data to the client. <tt>send_file</tt> is a convenience method that lets you provide the name of a file on the disk and it will stream the contents of that file for you.</p>

<p><span style="font-family: DejaVu Sans;">有时你可能希望发送一个文件给用户代替</span>rendering<span style="font-family: DejaVu Sans;">一个</span>HTML<span style="font-family: DejaVu Sans;">页面。</span>Rails<span style="font-family: DejaVu Sans;">中的所有</span>controllers<span style="font-family: DejaVu Sans;">都有</span>send_data<span style="font-family: DejaVu Sans;">和</span>send_file<span style="font-family: DejaVu Sans;">方法，它们都将会（将文件）以流数据形式发送给</span>client<span style="font-family: DejaVu Sans;">。</span>send_file<span style="font-family: DejaVu Sans;">是一个方便的方法它让你提供在</span>disk<span style="font-family: DejaVu Sans;">上的一个文件的</span>name<span style="font-family: DejaVu Sans;">并且它将会把那个文件的内容以</span>stream<span style="font-family: DejaVu Sans;">的形式发送给你。</span></p>

<p>To stream data to the client, use <tt>send_data</tt>:</p>

<p>require &ldquo;prawn&rdquo;</p>

<p>class ClientsController &lt; ApplicationController</p>

<h1>Generates a PDF document with information on the client and</h1>

<h1>returns it. The user will get the PDF as a file download.</h1>

<p>def download_pdf</p>

<p>client = Client.find(params[:id])</p>

<p>send_data generate_pdf(client),</p>

<p>:filename =&gt; &ldquo;#{client.name}.pdf&rdquo;,</p>

<p>:type =&gt; &ldquo;application/pdf&rdquo;</p>

<p>end</p>

<p>&nbsp;</p>

<p>private</p>

<p>&nbsp;</p>

<p>def generate_pdf(client)</p>

<p>Prawn::Document.new do</p>

<p>text client.name, :align =&gt; :center</p>

<p>text &ldquo;Address: #{client.address}&rdquo;</p>

<p>text &ldquo;Email: #{client.email}&rdquo;</p>

<p>end.render</p>

<p>end</p>

<p>end</p>

<p>The <tt>download_pdf</tt> action in the example above will call a private method which actually generates the PDF document and returns it as a string. This string will then be streamed to the client as a file download and a filename will be suggested to the user. Sometimes when streaming files to the user, you may not want them to download the file. Take images, for example, which can be embedded into HTML pages. To tell the browser a file is not meant to be downloaded, you can set the <tt>:disposition</tt> option to “inline”. The opposite and default value for this option is “attachment”.</p>

<p><span style="font-family: DejaVu Sans;">上面例子中的 </span><tt>download_pdf action</tt><span style="font-family: DejaVu Sans;"><tt>将会</tt></span><tt>call</tt><span style="font-family: DejaVu Sans;"><tt>一个私有的方法这个方法实际上创建</tt></span><tt>PDF</tt><span style="font-family: DejaVu Sans;"><tt>文档并且将其作为一个</tt></span><tt>string</tt><span style="font-family: DejaVu Sans;"><tt>形式返回。这个</tt></span><tt>string</tt><span style="font-family: DejaVu Sans;"><tt>将会随后以</tt></span><tt>stream</tt><span style="font-family: DejaVu Sans;"><tt>的形式到</tt></span><tt>client</tt><span style="font-family: DejaVu Sans;"><tt>作为一个文件下载并且一个文件名将会建议给用户。提到图形，例如，它可以被嵌入</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>页面。</tt><tt><strong>要告诉浏览器一个文件不是（用来）被下载的，你可以设置</strong></tt></span><tt><strong>:disposition</strong></tt><span style="font-family: DejaVu Sans;"><tt><strong>选项为</strong></tt></span><tt><strong>&lsquo;inline&rsquo;</strong></tt><span style="font-family: DejaVu Sans;"><tt><strong>。这个选项相反的和默认的值是”</strong></tt></span><tt><strong>attachment”</strong></tt><span style="font-family: DejaVu Sans;"><tt><strong>。</strong></tt></span></p>

<h4><a name="sending-files"></a>11.1 Sending Files</h4>


<p>If you want to send a file that already exists on disk, use the <tt>send_file</tt> method.</p>

<p><span style="font-family: DejaVu Sans;">如果你想发送一个已经在硬盘中存在的文件，使用</span>send_file<span style="font-family: DejaVu Sans;">方法。</span></p>

<p>class ClientsController &lt; ApplicationController</p>

<h1>Stream a file that has already been generated and stored on disk.</h1>

<p>def download_pdf</p>

<p>client = Client.find(params[:id])</p>

<p>send_file(&ldquo;#{Rails.root}/files/clients/#{client.id}.pdf&rdquo;,</p>

<p>:filename =&gt; &ldquo;#{client.name}.pdf&rdquo;,</p>

<p>:type =&gt; &ldquo;application/pdf&rdquo;)</p>

<p>end</p>

<p>end</p>

<p>This will read and stream the file 4kB at the time, avoiding loading the entire file into memory at once. You can turn off streaming with the <tt>:stream</tt> option or adjust the block size with the <tt>:buffer_size</tt> option.</p>

<p><span style="font-family: DejaVu Sans;">这将会</span>read<span style="font-family: DejaVu Sans;">和</span>stream<span style="font-family: DejaVu Sans;">文件一次</span>4kB<span style="font-family: DejaVu Sans;">，避免一次将整个文件导入内存。你可以用</span>:stream<span style="font-family: DejaVu Sans;">选项关闭流传送使或者设置适当的</span>block size<span style="font-family: DejaVu Sans;">通过</span>:buffer_size<span style="font-family: DejaVu Sans;">选项。</span></p>

<p>Be careful when using data coming from the client (params, cookies, etc.) to locate the file on disk, as this is a security risk that might allow someone to gain access to files they are not meant to see.</p>

<p><a name="result_box1"></a> <span style="font-family: DejaVu Sans;">在使用来自</span>client<span style="font-family: DejaVu Sans;">的数据的时候要小心（</span>params,cookies,etc.<span style="font-family: DejaVu Sans;">）到（服务器）本地硬盘中的文件，因为这是一个安全风险，可能会允许有人获得并不意味着他们看到的文件。</span></p>

<p>&nbsp;</p>

<p>It is not recommended that you stream static files through Rails if you can instead keep them in a public folder on your web server. It is much more efficient to let the user download the file directly using Apache or another web server, keeping the request from unnecessarily going through the whole Rails stack. Although if you do need the request to go through Rails for some reason, you can set the <tt>:x_sendfile</tt> option to true, and Rails will let the web server handle sending the file to the user, freeing up the Rails process to do other things. Note that your web server needs to support the <tt>X-Sendfile</tt> header for this to work.</p>

<p><a name="result_box2"></a> <span style="font-family: DejaVu Sans;">并不推荐你</span>stream<span style="font-family: DejaVu Sans;">静态文件通过</span>Rails<span style="font-family: DejaVu Sans;">如果作为替代你可以存放他们在你的服务器的一个公共的文件夹中。直接使用</span>Apache<span style="font-family: DejaVu Sans;">或者其他</span>web<span style="font-family: DejaVu Sans;">服务器让用户下载这些文件更加有效，避免不必要的</span>request<span style="font-family: DejaVu Sans;">通过整体的</span>Rails<span style="font-family: DejaVu Sans;">堆栈。即使如果因为某些原因你需要</span>request<span style="font-family: DejaVu Sans;">通过</span>Rails<span style="font-family: DejaVu Sans;">，你可以设置</span><tt>:x_sendfile</tt> option to true<span style="font-family: DejaVu Sans;">，</span>Rails<span style="font-family: DejaVu Sans;">将会让</span>web server handle<span style="font-family: DejaVu Sans;">发送这些文件给用户，释放</span>Rails<span style="font-family: DejaVu Sans;">进程去做其他的事情。注意你的</span>web server<span style="font-family: DejaVu Sans;">需要支持 </span><tt>X-Sendfile</tt> header<span style="font-family: DejaVu Sans;">来做这个工作。</span></p>

<h4><a name="restful-downloads"></a>11.2 RESTful Downloads</h4>


<p>While <tt>send_data</tt> works just fine, if you are creating a RESTful application having separate actions for file downloads is usually not necessary. In REST terminology, the PDF file from the example above can be considered just another representation of the client resource. Rails provides an easy and quite sleek way of doing “RESTful downloads”. Here’s how you can rewrite the example so that the PDF download is a part of the <tt>show</tt> action, without any streaming:</p>

<p><span style="font-family: DejaVu Sans;">当</span>send_data<span style="font-family: DejaVu Sans;">工作良好，如果你正在创建的一个</span>RESTful<span style="font-family: DejaVu Sans;">应用程序有单独的</span>actions<span style="font-family: DejaVu Sans;">来做</span>file<span style="font-family: DejaVu Sans;">下载通常是不需要的。在</span>REST<span style="font-family: DejaVu Sans;">术语中，来自例子中的</span>PDF<span style="font-family: DejaVu Sans;">文件完全可以被认为仅仅另一种</span>client<span style="font-family: DejaVu Sans;">资源的代表。</span>Rails<span style="font-family: DejaVu Sans;">提供一个容易和相当光滑的方式“</span>RESTful downloads”<span style="font-family: DejaVu Sans;">来做这些。这里重写例子以便于</span>PDF<span style="font-family: DejaVu Sans;">下载是</span>show action<span style="font-family: DejaVu Sans;">的一部分，没有任何的</span>streaming<span style="font-family: DejaVu Sans;">：</span></p>

<p>class ClientsController &lt; ApplicationController</p>

<h1>The user can request to receive this resource as HTML or PDF.</h1>

<p>def show</p>

<p>@client = Client.find(params[:id])</p>

<p>&nbsp;</p>

<p>respond_to do |format|</p>

<p>format.html</p>

<p>format.pdf { render :pdf =&gt; generate_pdf(@client) }</p>

<p>end</p>

<p>end</p>

<p>end</p>

<p>In order for this example to work, you have to add the PDF MIME type to Rails. This can be done by adding the following line to the file <tt>config/initializers/mime_types.rb</tt>:</p>

<p><span style="font-family: DejaVu Sans;">为了是这个例子能够工作，你必须添加 </span>PDF MIME type<span style="font-family: DejaVu Sans;">到</span>Rails<span style="font-family: DejaVu Sans;">。可以添加下面的代码行到 </span><tt>config/initializers/mime_types.rb</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p>Mime::Type.register &ldquo;application/pdf&rdquo;, :pdf</p>

<p><strong>Configuration files are not reloaded on each request,</strong> so you have to restart the server in order for their changes to take effect.</p>

<p>Now the user can request to get a PDF version of a client just by adding “.pdf” to the URL:</p>

<p>GET /clients/1.pdf</p>

<h3><a name="parameter-filtering"></a>12 Parameter Filtering</h3>


<p>Rails keeps a log file for each environment in the <tt>log</tt> folder. These are extremely useful when debugging what’s actually going on in your application, but in a live application you may not want every bit of information to be stored in the log file. You can filter certain request parameters from your log files by appending them to <tt>config.filter_parameters</tt> in the application configuration. These parameters will be marked [FILTERED] in the log.</p>

<p>Rail<span style="font-family: DejaVu Sans;">对于每个环境保留一个</span>log<span style="font-family: DejaVu Sans;">文件在</span>log<span style="font-family: DejaVu Sans;">文件夹中。这些文件相当有用，在当你调试的时候他们是在你应用程序中实际运行的记录，但是在一个</span>live<span style="font-family: DejaVu Sans;">的应用程序中你可以不希望每</span>bit<span style="font-family: DejaVu Sans;">的信息都被存储在</span>log<span style="font-family: DejaVu Sans;">文件中。你可以从你的</span>log<span style="font-family: DejaVu Sans;">文件中过滤某些</span>request parameters<span style="font-family: DejaVu Sans;">，通过添加它们到 </span><tt>config.filter_parameters</tt><span style="font-family: DejaVu Sans;"><tt>在</tt></span><tt>application configuration</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span><tt>These parameters will be marked [FILTERED] in the log.</tt></p>

<p>config.filter_parameters &lt;&lt; :password</p>

<h3><a name="rescue"></a>13 Rescue<span style="font-family: WenQuanYi Micro Hei;">挽救</span></h3>


<p>Most likely your application is going to contain bugs or otherwise throw an exception that needs to be handled. For example, if the user follows a link to a resource that no longer exists in the database, Active Record will throw the <tt>ActiveRecord::RecordNotFound</tt> exception.</p>

<p><span style="font-family: DejaVu Sans;">就像你的应用程序包含某些</span>bugs<span style="font-family: DejaVu Sans;">或者另一方面抛出一个异常需要被处理。例如，如果用户</span>follows<span style="font-family: DejaVu Sans;">一个</span>link<span style="font-family: DejaVu Sans;">到一个在数据库中并不存在的</span>resourece,Active Record<span style="font-family: DejaVu Sans;">将会抛出 </span><tt>ActiveRecord::RecordNotFound</tt><span style="font-family: DejaVu Sans;"><tt>异常。</tt></span></p>

<p>Rails’ default exception handling displays a “500 Server Error” message for all exceptions. If the request was made locally, a nice traceback and some added information gets displayed so you can figure out what went wrong and deal with it. If the request was remote Rails will just display a simple “500 Server Error” message to the user, or a “404 Not Found” if there was a routing error or a record could not be found. Sometimes you might want to customize how these errors are caught and how they’re displayed to the user. There are several levels of exception handling available in a Rails application:</p>

<p>Rails<span style="font-family: DejaVu Sans;">的默认异常处理方式是对于所有的异常显示一个“</span>500 Server Error”<span style="font-family: DejaVu Sans;">消息。如果</span>request<span style="font-family: DejaVu Sans;">（相关的定制）在服务器被生成，一个漂亮的</span>traceback<span style="font-family: DejaVu Sans;">以及添加一些信息来显示使得你可以指出什么地方出错了并且怎样处理它。如果</span>request<span style="font-family: DejaVu Sans;">被</span>remote Rails<span style="font-family: DejaVu Sans;">将会仅仅显示一个简单的“</span>500 Server Error” <span style="font-family: DejaVu Sans;">消息给用户，或者如果这里有一个</span>routing<span style="font-family: DejaVu Sans;">错误或者一个记录不能被发现“</span>404 Not Found”<span style="font-family: DejaVu Sans;">将会发送给用户。有时你可以能希望定制这些错误怎样引起以及为什么它们被显示给用户。在</span>Rails<span style="font-family: DejaVu Sans;">应用程序中这里有一些级别的异常处理可用：</span></p>

<h4><a name="the-default-500-and-404-templates"></a>13.1 The Default 500 and 404 Templates</h4>


<p>By default a production application will render either a 404 or a 500 error message. These messages are contained in static HTML files in the <tt>public</tt> folder, in <tt>404.html</tt> and <tt>500.html</tt> respectively. You can customize these files to add some extra information and layout, but remember that they are static; i.e. you can’t use RHTML or layouts in them, just plain HTML.</p>

<p><span style="font-family: DejaVu Sans;">通过一个默认生成的应用程序将会</span>render<span style="font-family: DejaVu Sans;">一个</span>404<span style="font-family: DejaVu Sans;">或者</span>500<span style="font-family: DejaVu Sans;">错误消息。这些消息被包含在</span>public<span style="font-family: DejaVu Sans;">文件夹的静态</span>HTML<span style="font-family: DejaVu Sans;">文件中，分别在 </span><tt>404.html</tt> and <tt>500.html</tt><span style="font-family: DejaVu Sans;"><tt>。你可以定制这些文件来添加一些其他的信息和</tt></span><tt>layout</tt><span style="font-family: DejaVu Sans;"><tt>，但是记住他们是静态的；</tt></span><tt>i.e. you can’t use RHTML or layouts in them, </tt><span style="font-family: DejaVu Sans;"><tt>仅仅是纯</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="rescue_from"></a>13.2 <tt>rescue_from</tt></h4>


<p>If you want to do something a bit more elaborate when catching errors, you can use <tt>rescue_from</tt>, which handles exceptions of a certain type (or multiple types) in an entire controller and its subclasses.</p>

<p><span style="font-family: DejaVu Sans;">如果你想做一些事情在</span>catching <span style="font-family: DejaVu Sans;">错误的时候做多一点的阐述，你可以使用 </span><tt>rescue_from</tt><span style="font-family: DejaVu Sans;"><tt>，其处理一种明确的异常类型（或者多种）在整个</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>以及它的子类中。</tt></span></p>

<p>When an exception occurs which is caught by a <tt>rescue_from</tt> directive, the exception object is passed to the handler. The handler can be a method or a <tt>Proc</tt> object passed to the <tt>:with</tt> option. You can also use a block directly instead of an explicit <tt>Proc</tt> object.</p>

<p><span style="font-family: DejaVu Sans;">当一个异常发生其会直接引发 </span><tt>rescue_from</tt><span style="font-family: DejaVu Sans;"><tt>，这个</tt></span><tt>exception</tt><span style="font-family: DejaVu Sans;"><tt>对象被传递给</tt></span><tt>handler</tt><span style="font-family: DejaVu Sans;"><tt>。这个</tt></span><tt>handler</tt><span style="font-family: DejaVu Sans;"><tt>可以是一个方法或者一个被传递给</tt></span><tt>:with</tt><span style="font-family: DejaVu Sans;"><tt>选项的</tt></span><tt>Proc</tt><span style="font-family: DejaVu Sans;"><tt>对象。你也可以直接使用一个</tt></span><tt>block</tt><span style="font-family: DejaVu Sans;"><tt>替代准确的</tt></span><tt>Proc</tt><span style="font-family: DejaVu Sans;"><tt>对象。</tt></span></p>

<p>Here’s how you can use <tt>rescue_from</tt> to intercept all <tt>ActiveRecord::RecordNotFound</tt> errors and do something with them.</p>

<p><span style="font-family: DejaVu Sans;">这里是你如何使用 </span><tt>rescue_from</tt><span style="font-family: DejaVu Sans;"><tt>来截取所有的</tt></span><tt>ActiveRecord::RecordNotFound errors</tt><span style="font-family: DejaVu Sans;"><tt>并且为其做一些事情。</tt></span></p>

<p><tt>class ApplicationController &lt; ActionController::Base</tt></p>

<p><tt> </tt><tt>rescue_from ActiveRecord::RecordNotFound, :with =&gt; :record_not_found</tt></p>

<p>&nbsp;</p>

<p><tt> </tt><tt>private</tt></p>

<p>&nbsp;</p>

<p><tt> </tt><tt>def record_not_found</tt></p>

<p><tt> </tt><tt>render :text =&gt; &ldquo;404 Not Found&rdquo;, :status =&gt; 404</tt></p>

<p><tt> </tt><tt>end</tt></p>

<p><tt>end</tt></p>

<p>Of course, this example is anything but elaborate and doesn’t improve on the default exception handling at all, but once you can catch all those exceptions you’re free to do whatever you want with them. For example, you could create custom exception classes that will be thrown when a user doesn’t have access to a certain section of your application:</p>

<p><span style="font-family: DejaVu Sans;">当然，这个例子的所有事情仅仅只是阐述以及没有改善默认的异常处理，但是一旦你可以</span>catch<span style="font-family: DejaVu Sans;">所有的异常你可以自由的做你想做的。例如，你可以创建定制的异常类它将在用户访问没有访问权限的应用程序的某些部分时候抛出：</span></p>

<p>class ApplicationController &lt; ActionController::Base</p>

<p>rescue_from User::NotAuthorized, :with =&gt; :user_not_authorized</p>

<p>&nbsp;</p>

<p>private</p>

<p>&nbsp;</p>

<p>def user_not_authorized</p>

<p>flash[:error] = &ldquo;You don&rsquo;t have access to this section.&rdquo;</p>

<p>redirect_to :back</p>

<p>end</p>

<p>end</p>

<p>&nbsp;</p>

<p>class ClientsController &lt; ApplicationController</p>

<h1>Check that the user has the right authorization to access clients.</h1>

<p>before_filter :check_authorization</p>

<p>&nbsp;</p>

<h1>Note how the actions don&rsquo;t have to worry about all the auth stuff.</h1>

<p>def edit</p>

<p>@client = Client.find(params[:id])</p>

<p>end</p>

<p>&nbsp;</p>

<p>private</p>

<p>&nbsp;</p>

<h1>If the user is not authorized, just throw the exception.</h1>

<p>def check_authorization</p>

<p>raise User::NotAuthorized unless current_user.admin?</p>

<p>end</p>

<p>end</p>

<p>Certain exceptions are only rescuable from the <tt>ApplicationController</tt> class, as they are raised before the controller gets initialized and the action gets executed. See Pratik Naik’s <a href="http://m.onkey.org/2008/7/20/rescue-from-dispatching">article</a> on the subject for more information.</p>

<h3><a name="force-https-protocol"></a><a name="result_box3"></a> 14 Force HTTPS protocol<span style="font-family: WenQuanYi Micro Hei;">强制</span>HTTPS<span style="font-family: WenQuanYi Micro Hei;">协议</span></h3>


<p>Sometime you might want to force a particular controller to only be accessible via an HTTPS protocol for security reason. Since Rails 3.1 you can now use <tt>force_ssl</tt> method in your controller to enforce that:</p>

<p><span style="font-family: DejaVu Sans;">有时候因为安全原因你可能希望强制特定的</span>cotroller<span style="font-family: DejaVu Sans;">仅仅在</span>HTTPS<span style="font-family: DejaVu Sans;">协议下是可访问的。从</span>Rails 3.1<span style="font-family: DejaVu Sans;">你可以在你的</span>controller<span style="font-family: DejaVu Sans;">使用 </span><tt>force_ssl</tt><span style="font-family: DejaVu Sans;"><tt>来强制执行：</tt></span></p>

<p>class DinnerController</p>

<p>force_ssl</p>

<p>end</p>

<p>Just like the filter, you could also passing <tt>:only</tt> and <tt>:except</tt> to enforce the secure connection only to specific actions.</p>

<p>class DinnerController</p>

<p>force_ssl :only =&gt; :cheeseburger</p>

<h1>or</h1>

<p>force_ssl :except =&gt; :cheeseburger</p>

<p>end</p>

<p>Please note that if you found yourself adding <tt>force_ssl</tt> to many controllers, you may found yourself wanting to force the whole application to use HTTPS instead. In that case, you can set the <tt>config.force_ssl</tt> in your environment file.</p>

<p><span style="font-family: DejaVu Sans;">请注意如果你发现你自己的添加 </span><tt>force_ssl</tt><span style="font-family: DejaVu Sans;"><tt>到许多</tt></span><tt>controllers</tt><span style="font-family: DejaVu Sans;"><tt>，你可能发现你自己希望强制整个应用程序使用</tt></span><tt>HTTPS</tt><span style="font-family: DejaVu Sans;"><tt>替代。因为这样的原因，你可以在你的环境文件中设置</tt></span><tt>config.force_ssl</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><a href="http://jhjguxin.hwcrazy.com/tag/controller/">controller</a> <a href="http://jhjguxin.hwcrazy.com/tag/filter/">filter</a> <a href="http://jhjguxin.hwcrazy.com/tag/guide/">guide</a> <a href="http://jhjguxin.hwcrazy.com/tag/rails/">rails</a> <a href="http://jhjguxin.hwcrazy.com/tag/ruby/">ruby</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/21/rails-form-helpers/">Rails Form Helpers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-21T23:22:00+08:00" pubdate data-updated="true">Dec 21<span>st</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Rails Form helpers</h2>

<h2>Rails Form helpers</h2>


<p>Forms in web applications are an essential interface for user input. However, form markup can quickly become tedious to write and maintain because of form control naming and their numerous attributes. Rails deals away with these complexities by providing view helpers for generating form markup. However, since they have different use-cases, developers are required to know all the differences between similar helper methods before putting them to use.</p>

<p>Forms<span style="font-family: DejaVu Sans;">在</span>web<span style="font-family: DejaVu Sans;">应用程序中是一个必不可少的提供用户输入的</span>interface<span style="font-family: DejaVu Sans;">（接口）。然而，形式标记的编写和维护很快就变得十分乏味是因为表单控件的命名和它们的许多属性。</span>Rails<span style="font-family: DejaVu Sans;">处理这些复杂的（事物）通过提供</span>view helpers<span style="font-family: DejaVu Sans;">来创建</span>form markup<span style="font-family: DejaVu Sans;">。然而，自从有了不同的用户需求，开发人员需要知道所有的</span>similar helper <span style="font-family: DejaVu Sans;">方法间的的不同在使用它们之前。</span></p>

<p>In this guide you will:<span style="font-family: DejaVu Sans;">在这个</span>guide<span style="font-family: DejaVu Sans;">中你可以了解到：</span></p>

<ul>
    <li>Create search forms and similar kind of generic forms not representing any specific model in your application<span style="font-family: DejaVu Sans;">在你的应用程序中，创建</span>search forms<span style="font-family: DejaVu Sans;">和生成类似的</span>forms<span style="font-family: DejaVu Sans;">它们不代表任何指定的</span>model</li>
    <li>Make model-centric forms for creation and editing of specific database records<span style="font-family: DejaVu Sans;">制造</span>model-centric forms<span style="font-family: DejaVu Sans;">来创建和编辑指定的数据库记录</span></li>
    <li>Generate select boxes from multiple types of data <span style="font-family: DejaVu Sans;">从多种数据生成</span>select boxes</li>
    <li>Understand the date and time helpers Rails provides <span style="font-family: DejaVu Sans;">明白</span>Rails<span style="font-family: DejaVu Sans;">提供的</span>date<span style="font-family: DejaVu Sans;">和</span>time helpers</li>
    <li>Learn what makes a file upload form different <span style="font-family: DejaVu Sans;">学习什么使得一个文件</span>upload form<span style="font-family: DejaVu Sans;">变得不同</span></li>
    <li>Learn some cases of building forms to external resources <span style="font-family: DejaVu Sans;">学习某些情况下为</span>external resources<span style="font-family: DejaVu Sans;">（外部资源）构建</span>forms</li>
    <li>Find out where to look for complex forms <span style="font-family: DejaVu Sans;">找出在哪里查找复杂的</span>forms</li>
</ul>


<p>This guide is not intended to be a complete documentation of available form helpers and their arguments. Please visit <a href="http://api.rubyonrails.org/"><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">API</span></span><span style="color: #000080;"><span style="text-decoration: underline;">documentation</span></span></a> for a complete reference.</p>

<p><span style="font-family: DejaVu Sans;">本教程不大算成为一个包含可用的</span>form helpers<span style="font-family: DejaVu Sans;">和它们的参数的完整的文档。请访问</span><a href="http://api.rubyonrails.org/"><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">API</span></span><span style="color: #000080;"><span style="text-decoration: underline;">documentation</span></span></a><span style="font-family: DejaVu Sans;">得到完整的参考。</span></p>

<h3><a name="dealing-with-basic-forms"></a>1 Dealing with Basic Forms</h3>


<p>The most basic form helper is <tt>form_tag</tt>.<span style="font-family: DejaVu Sans;">最基本的</span>form helper<span style="font-family: DejaVu Sans;">是</span>form_tag<span style="font-family: DejaVu Sans;">。</span></p>

<p>&lt;%= form_tag do %&gt;</p>

<p>Form contents</p>

<p>&lt;% end %&gt;</p>

<p>When called without arguments like this, it creates a <tt>&lt;form&gt;</tt> tag which, when submitted, will POST to the current page. For instance, assuming the current page is <tt>/home/index</tt>, the generated HTML will look like this (some line breaks added for readability):</p>

<p><span style="font-family: DejaVu Sans;">当像这样无参调用时，它创建一个</span>&lt;form&gt;<span style="font-family: DejaVu Sans;">标签，当提交这个表单时，会提交到当前页面。作为实例，假设当前页面是</span><tt>/home/index</tt><span style="font-family: DejaVu Sans;"><tt>，创建的</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>将会像这样（有一些换行为了增加可读性）：</tt></span></p>

<p>&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/home/index&rdquo; method=&ldquo;post&rdquo;&gt;</p>

<p>&lt;div style=&ldquo;margin:0;padding:0&rdquo;&gt;</p>

<p>&lt;input name=&ldquo;utf8&rdquo; type=&ldquo;hidden&rdquo; value=&ldquo;&amp;#x2713;&rdquo; /&gt;</p>

<p>&lt;input name=&ldquo;authenticity_token&rdquo; type=&ldquo;hidden&rdquo; value=&ldquo;f755bb0ed134b76c432144748a6d4b7a7ddf2b71&rdquo; /&gt;</p>

<p>&lt;/div&gt;</p>

<p>Form contents</p>

<p>&lt;/form&gt;</p>

<p>Now, you’ll notice that the HTML contains something extra: a <tt>div</tt> element with two hidden input elements inside. This div is important, because the form cannot be successfully submitted without it. The first input element with name <tt>utf8</tt> enforces browsers to properly respect your form’s character encoding and is generated for all forms whether their actions are “GET” or “POST”. The second input element with name <tt>authenticity_token</tt> is a security feature of Rails called <strong>cross-site</strong><strong> </strong><strong>request</strong><strong> </strong><strong>forgery</strong><strong> </strong><strong>protection</strong>, and form helpers generate it for every non-GET form (provided that this security feature is enabled). You can read more about this in the <a href="http://guides.rubyonrails.org/security.html#_cross_site_reference_forgery_csrf"><span style="color: #000080;"><span style="text-decoration: underline;">Security</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a>.</p>

<p><span style="font-family: DejaVu Sans;">现在，你将会注意到</span>HTML<span style="font-family: DejaVu Sans;">包含一些额外的东西：一个</span>div<span style="font-family: DejaVu Sans;">元素和在里边的两个隐藏的</span>input<span style="font-family: DejaVu Sans;">元素。这个</span>div<span style="font-family: DejaVu Sans;">很重要，因为如果没有它</span>form<span style="font-family: DejaVu Sans;">不能够成功的被提交。第一个</span>input<span style="font-family: DejaVu Sans;">元素有</span>name utf8<span style="font-family: DejaVu Sans;">会强制浏览器合适的遵循你的</span>form&rsquo;s<span style="font-family: DejaVu Sans;">的字符编码并且无论是它创建的所有</span>forms<span style="font-family: DejaVu Sans;">还是它们的</span>actions<span style="font-family: DejaVu Sans;">（<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>GET” or “POST”<span style="font-family: DejaVu Sans;">）。第二个</span>input<span style="font-family: DejaVu Sans;">元素使用</span>name <tt>authenticity_token</tt><span style="font-family: DejaVu Sans;"><tt>它是一个</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>的安全特性调用</tt><tt></tt></span><strong>cross-site</strong><strong> </strong><strong>request</strong><strong> </strong><strong>forgery</strong><strong> </strong><strong>protection<span style="font-family: DejaVu Sans;">（站间请求保护）</span></strong><span style="font-family: DejaVu Sans;"><strong>，并且</strong></span><strong>form</strong><strong> </strong><strong>helpers<span style="font-family: DejaVu Sans;">为每个</span></strong><strong>non-GET</strong><strong> </strong><strong>form</strong><strong> </strong><strong>(<span style="font-family: DejaVu Sans;">确保这个安全特性是有效的</span></strong><strong>)</strong><strong> </strong><span style="font-family: DejaVu Sans;"><strong>创建它。你可以阅读关于他的更多信息在</strong><strong></strong></span><a href="http://guides.rubyonrails.org/security.html#_cross_site_reference_forgery_csrf"><span style="color: #000080;"><span style="text-decoration: underline;">Security</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a><span style="font-family: DejaVu Sans;"><strong>中。</strong></span></p>

<p>Throughout this guide, the <tt>div</tt> with the hidden input elements will be excluded<span style="font-family: DejaVu Sans;">排除</span>from code samples for brevity<span style="font-family: DejaVu Sans;">短暂</span>.<span style="font-family: DejaVu Sans;">通过这个教程，</span>div<span style="font-family: DejaVu Sans;">里面的两个隐藏的</span>input<span style="font-family: DejaVu Sans;">元素将会从</span>samples code<span style="font-family: DejaVu Sans;">暂时排除。</span></p>

<h4><a name="a-generic-search-form"></a>1.1 A Generic Search Form<span style="font-family: WenQuanYi Micro Hei;">通用搜索表单</span></h4>


<p>One of the most basic forms you see on the web is a search form. This form contains:</p>

<p><span style="font-family: DejaVu Sans;">搜索表单是你在</span>web<span style="font-family: DejaVu Sans;">上最常见的基本表单之一。这个表单包含：</span></p>

<ol>
    <li>a form element with “GET” method,</li>
    <li>a label for the input,</li>
    <li>a text input element, and</li>
    <li>a submit element.</li>
</ol>


<p>To create this form you will use <tt>form_tag</tt>, <tt>label_tag</tt>, <tt>text_field_tag</tt>, and <tt>submit_tag</tt>, respectively. Like this:</p>

<p><span style="font-family: DejaVu Sans;">要创建这个表单你将会分别使用</span>form_tag,label_tag,text_field_tag,and submit_tag<span style="font-family: DejaVu Sans;">。</span></p>

<p>&lt;%= form_tag(&ldquo;/search&rdquo;, :method =&gt; &ldquo;get&rdquo;) do %&gt;</p>

<p>&lt;%= label_tag(:q, &ldquo;Search for:&rdquo;) %&gt;</p>

<p>&lt;%= text_field_tag(:q) %&gt;</p>

<p>&lt;%= submit_tag(&ldquo;Search&rdquo;) %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>This will generate the following HTML:<span style="font-family: DejaVu Sans;">这将会生成随后的</span>HTML<span style="font-family: DejaVu Sans;">：</span></p>

<p>&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/search&rdquo; method=&ldquo;get&rdquo;&gt;</p>

<p>&lt;label for=&ldquo;q&rdquo;&gt;Search for:&lt;/label&gt;</p>

<p>&lt;input id=&ldquo;q&rdquo; name=&ldquo;q&rdquo; type=&ldquo;text&rdquo; /&gt;#label <span style="font-family: DejaVu Sans;">和</span>input<span style="font-family: DejaVu Sans;">的</span>for<span style="font-family: DejaVu Sans;">和</span>id<span style="font-family: DejaVu Sans;">的值的统一是为了将它们关联起来选中</span>label<span style="font-family: DejaVu Sans;">则</span>input<span style="font-family: DejaVu Sans;">则被激活</span></p>

<p>&lt;input name=&ldquo;commit&rdquo; type=&ldquo;submit&rdquo; value=&ldquo;Search&rdquo; /&gt;</p>

<p>&lt;/form&gt;</p>

<p>For every form input, an ID attribute is generated from its name (“q” in the example). These IDs can be very useful for CSS styling or manipulation of form controls with JavaScript.</p>

<p><span style="font-family: DejaVu Sans;">对于每个</span>form input<span style="font-family: DejaVu Sans;">，</span>ID<span style="font-family: DejaVu Sans;">属性被从它的</span>name<span style="font-family: DejaVu Sans;">生成（本例中是</span>q<span style="font-family: DejaVu Sans;">）。这些</span>IDs<span style="font-family: DejaVu Sans;">在</span>CSS styling<span style="font-family: DejaVu Sans;">中非常有用或者使用</span>JavaScript<span style="font-family: DejaVu Sans;">操作</span>form controls<span style="font-family: DejaVu Sans;">。</span></p>

<p>Besides <tt>text_field_tag</tt> and <tt>submit_tag</tt>, there is a similar helper for <em>every</em> form control in HTML.<span style="font-family: DejaVu Sans;">下面的</span><tt>text_field_tag</tt> and <tt>submit_tag</tt><span style="font-family: DejaVu Sans;"><tt>，它们是每个</tt></span><tt>form</tt><tt> </tt><tt>control</tt><span style="font-family: DejaVu Sans;"><tt>在</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>中的</tt></span><tt>similar</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>Always use “GET” as the method for search forms. This allows users to bookmark a specific search and get back to it. More generally Rails encourages you to use the right HTTP verb for an action.</p>

<p><span style="font-family: DejaVu Sans;">通常对</span>search forms<span style="font-family: DejaVu Sans;">使用<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>GET”<span style="font-family: DejaVu Sans;">方法。这允许用户将一个指定的搜索（的</span>url<span style="font-family: DejaVu Sans;">添加）书签并（通过这个书签）取回查询结果。更常规的方法</span>Rails<span style="font-family: DejaVu Sans;">鼓励你对于一个</span>HTTP <span style="font-family: DejaVu Sans;">动作使用正确的</span>verb(<span style="font-family: DejaVu Sans;">动词</span>)<span style="font-family: DejaVu Sans;">。</span></p>

<h4><a name="multiple-hashes-in-form-helper-calls"></a> 1.2 Multiple Hashes in Form Helper Calls</h4>


<p>The <tt>form_tag</tt> helper accepts 2 arguments: the path for the action and an options hash. This hash specifies the method of form submission and HTML options such as the form element’s class.</p>

<p><tt>form_tag</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>接收两个参数：</tt></span><tt>path</tt><span style="font-family: DejaVu Sans;"><tt>的值为动作的路径以及一个</tt></span><tt>options</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典。</tt></span></p>

<p><span style="font-family: DejaVu Sans;"><tt>这个</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典指定提交</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>的方法和（一些）</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>选项如</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>元素的</tt></span><tt>class</tt><span style="font-family: DejaVu Sans;"><tt>属性。</tt></span></p>

<p>As with the <tt>link_to</tt> helper, the path argument doesn’t have to be given a string; it can be a hash of URL parameters recognizable by Rails’ routing mechanism, which will turn the hash into a valid URL. However, since both arguments to <tt>form_tag</tt> are hashes, you can easily run into a problem if you would like to specify both. For instance, let’s say you write this:</p>

<p><span style="font-family: DejaVu Sans;">如同</span>link_to helper<span style="font-family: DejaVu Sans;">，</span>path<span style="font-family: DejaVu Sans;">参数不是必须是被提供给一个</span>string<span style="font-family: DejaVu Sans;">；它可以是被</span>Rails<span style="font-family: DejaVu Sans;">的</span>routing mechanism<span style="font-family: DejaVu Sans;">组织的一个</span>URL<span style="font-family: DejaVu Sans;">参数的</span>hash<span style="font-family: DejaVu Sans;">字典，他将转接</span>hash<span style="font-family: DejaVu Sans;">（键）到一个有效的</span>URL<span style="font-family: DejaVu Sans;">。然而，</span></p>

<p><span style="font-family: DejaVu Sans;">既然两个参数</span><tt>form_tag</tt><span style="font-family: DejaVu Sans;"><tt>都是</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典形式，你可以容易的陷入一个问题如果你想指定他们两个。下面的实例，让告诉你写下如下代码：</tt></span></p>

<p>form_tag(:controller =&gt; &ldquo;people&rdquo;, :action =&gt; &ldquo;search&rdquo;, :method =&gt; &ldquo;get&rdquo;, :class =&gt; &ldquo;nifty_form&rdquo;)</p>

<h1>=&gt; &lsquo;&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/people/search?method=get&amp;class=nifty_form&rdquo; method=&ldquo;post&rdquo;&gt;&rsquo;</h1>

<p>Here, <tt>method</tt> and <tt>class</tt> are appended to the query string of the generated URL because you even though you mean to write two hashes, you really only specified one. So you need to tell Ruby which is which by delimiting the first hash (or both) with curly brackets. This will generate the HTML you expect:</p>

<p><span style="font-family: DejaVu Sans;">这里，</span>method<span style="font-family: DejaVu Sans;">和</span>class<span style="font-family: DejaVu Sans;">被添加到生成的</span>UIR<span style="font-family: DejaVu Sans;">的</span>query<span style="font-family: DejaVu Sans;">字符串中是因为即使你曾经意图写的两个</span>hash<span style="font-family: DejaVu Sans;">字段，你实际上只指定了一个。因此你需要告诉</span>Ruby<span style="font-family: DejaVu Sans;">其中的那一个被限制为第一个</span>hash<span style="font-family: DejaVu Sans;">（或者两个都）使用大括号。这是生成的</span>HTML<span style="font-family: DejaVu Sans;">你期望的：</span></p>

<p>form_tag({:controller =&gt; &ldquo;people&rdquo;, :action =&gt; &ldquo;search&rdquo;}, :method =&gt; &ldquo;get&rdquo;, :class =&gt; &ldquo;nifty_form&rdquo;)</p>

<h1>=&gt; &lsquo;&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/people/search&rdquo; method=&ldquo;get&rdquo;&gt;&rsquo;</h1>

<h4><a name="helpers-for-generating-form-elements"></a> 1.3 Helpers for Generating Form Elements</h4>


<p>Rails provides a series of helpers for generating form elements such as checkboxes, text fields, and radio buttons. These basic helpers, with names ending in “_tag” (such as <tt>text_field_tag</tt> and <tt>check_box_tag</tt>), generate just a single <tt>&lt;input&gt;</tt> element. The first parameter to these is always the name of the input. When the form is submitted, the name will be passed along with the form data, and will make its way to the <tt>params</tt> hash in the controller with the value entered by the user for that field. For example, if the form contains <tt>&lt;%=</tt><tt> </tt><tt>text_field_tag(:query)</tt><tt> </tt><tt>%&gt;</tt>, then you would be able to get the value of this field in the controller with <tt>params[:query]</tt>.</p>

<p>Rails<span style="font-family: DejaVu Sans;">提供一系列的</span>helpers<span style="font-family: DejaVu Sans;">来创建</span>form<span style="font-family: DejaVu Sans;">元素例如</span>checkboxes<span style="font-family: DejaVu Sans;">，</span>text fields<span style="font-family: DejaVu Sans;">以及</span>radio buttons<span style="font-family: DejaVu Sans;">。这些基本的</span>helpers<span style="font-family: DejaVu Sans;">，使用<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>_tag”<span style="font-family: DejaVu Sans;">结尾（例如</span><tt>text_field_tag</tt> and <tt>check_box_tag</tt><span style="font-family: DejaVu Sans;">），创建一个单独的</span>&lt;input&gt;<span style="font-family: DejaVu Sans;">元素。其第一个参数通常是</span>input<span style="font-family: DejaVu Sans;">的</span>name<span style="font-family: DejaVu Sans;">。当这个</span>form<span style="font-family: DejaVu Sans;">被提交的时候，名称也将会和</span>form data<span style="font-family: DejaVu Sans;">一起（提交），并且将会以它的方式将它和用户输入到</span>field<span style="font-family: DejaVu Sans;">中的值传递到</span>controller<span style="font-family: DejaVu Sans;">中的</span>params hash<span style="font-family: DejaVu Sans;">中。例如，如果</span>form<span style="font-family: DejaVu Sans;">包含</span><tt>&lt;%=</tt><tt> </tt><tt>text_field_tag(:query)</tt><tt> </tt><tt>%&gt;</tt><span style="font-family: DejaVu Sans;"><tt>，然后你可以在</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>使用</tt><tt></tt></span><tt>params[:query]</tt><span style="font-family: DejaVu Sans;"><tt>获取这个</tt></span><tt>field</tt><span style="font-family: DejaVu Sans;"><tt>中的值。</tt></span></p>

<p>When naming inputs, Rails uses certain conventions that make it possible to submit parameters with non-scalar values such as arrays or hashes, which will also be accessible in <tt>params</tt>. You can read more about them in <a href="http://guides.rubyonrails.org/form_helpers.html#understanding-parameter-naming-conventions"><span style="color: #000080;"><span style="text-decoration: underline;">chapter</span></span><span style="color: #000080;"><span style="text-decoration: underline;">7</span></span><span style="color: #000080;"><span style="text-decoration: underline;">of</span></span><span style="color: #000080;"><span style="text-decoration: underline;">this</span></span><span style="color: #000080;"><span style="text-decoration: underline;">guide</span></span></a>. For details on the precise usage of these helpers, please refer to the <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/FormTagHelper.html"><span style="color: #000080;"><span style="text-decoration: underline;">API</span></span><span style="color: #000080;"><span style="text-decoration: underline;">documentation</span></span></a>.</p>

<p><span style="font-family: DejaVu Sans;">当命名了</span>inputs<span style="font-family: DejaVu Sans;">，</span>Rails<span style="font-family: DejaVu Sans;">使用某些公约使得提交</span>parameters<span style="font-family: DejaVu Sans;">和</span>non-scalar<span style="font-family: DejaVu Sans;">（非标量）的值例如</span>arrays<span style="font-family: DejaVu Sans;">或者</span>hashes<span style="font-family: DejaVu Sans;">成为了可能，其也可以通过使用</span><tt>params</tt><span style="font-family: DejaVu Sans;"><tt>来访问。你可以阅读</tt><tt></tt></span><a href="http://guides.rubyonrails.org/form_helpers.html#understanding-parameter-naming-conventions"><span style="color: #000080;"><span style="text-decoration: underline;">chapter</span></span><span style="color: #000080;"><span style="text-decoration: underline;">7</span></span><span style="color: #000080;"><span style="text-decoration: underline;">of</span></span><span style="color: #000080;"><span style="text-decoration: underline;">this</span></span><span style="color: #000080;"><span style="text-decoration: underline;">guide</span></span></a><span style="font-family: DejaVu Sans;"><tt>来了解更多的信息。要知道这些</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>的精确用法的描述，请参阅</tt><tt></tt></span><a href="http://api.rubyonrails.org/classes/ActionView/Helpers/FormTagHelper.html"><span style="color: #000080;"><span style="text-decoration: underline;">API</span></span><span style="color: #000080;"><span style="text-decoration: underline;">documentation</span></span></a><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h5><a name="checkboxes"></a>1.3.1 Checkboxes<span style="font-family: WenQuanYi Micro Hei;">复选框</span></h5>


<p>Checkboxes are form controls that give the user a set of options they can enable or disable:</p>

<p>Checkboxes<span style="font-family: DejaVu Sans;">是</span>form<span style="font-family: DejaVu Sans;">控件它提供给用户一个设置选项这个选项可以选中和取消选中：</span></p>

<p>&lt;%= check_box_tag(:pet_dog) %&gt;</p>

<p>&lt;%= label_tag(:pet_dog, &ldquo;I own a dog&rdquo;) %&gt;</p>

<p>&lt;%= check_box_tag(:pet_cat) %&gt;</p>

<p>&lt;%= label_tag(:pet_cat, &ldquo;I own a cat&rdquo;) %&gt;</p>

<p>This generates the following:<span style="font-family: DejaVu Sans;">这将生成随后的代码：</span></p>

<p>&lt;input id=&ldquo;pet_dog&rdquo; name=&ldquo;pet_dog&rdquo; type=&ldquo;checkbox&rdquo; value=&ldquo;1&rdquo; /&gt;</p>

<p>&lt;label for=&ldquo;pet_dog&rdquo;&gt;I own a dog&lt;/label&gt;</p>

<p>&lt;input id=&ldquo;pet_cat&rdquo; name=&ldquo;pet_cat&rdquo; type=&ldquo;checkbox&rdquo; value=&ldquo;1&rdquo; /&gt;</p>

<p>&lt;label for=&ldquo;pet_cat&rdquo;&gt;I own a cat&lt;/label&gt;</p>

<p>The first parameter to <tt>check_box_tag</tt>, of course, is the name of the input. The second parameter, naturally, is the value of the input. This value will be included in the form data (and be present in <tt>params</tt>) when the checkbox is checked.</p>

<p><tt>check_box_tag</tt><span style="font-family: DejaVu Sans;"><tt>的第一个参数，当然是</tt></span><tt>input</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>。第二个参数，自然地，是</tt></span><tt>input</tt><span style="font-family: DejaVu Sans;"><tt>输入的值。这个</tt></span><tt>value</tt><span style="font-family: DejaVu Sans;"><tt>将会包含在</tt></span><tt>form</tt><tt> </tt><tt>data</tt><span style="font-family: DejaVu Sans;"><tt>中（并且使用</tt></span><tt>params</tt><span style="font-family: DejaVu Sans;"><tt>表示）当</tt></span><tt>checkbox</tt><span style="font-family: DejaVu Sans;"><tt>被选中。</tt></span></p>

<h5><a name="radio-buttons"></a>1.3.2 Radio Buttons<span style="font-family: WenQuanYi Micro Hei;">单选按钮</span></h5>


<p>Radio buttons, while similar to checkboxes, are controls that specify a set of options in which they are mutually exclusive (i.e., the user can only pick one):</p>

<p><span style="font-family: DejaVu Sans;">单选框，它和复选框很类似，它是一种控件指定一些设置选项这些选项之间是相互排斥的（</span>i.e., <span style="font-family: DejaVu Sans;">用户仅仅只能选择一个）：</span></p>

<p>&lt;%= radio_button_tag(:age, &ldquo;child&rdquo;) %&gt;</p>

<p>&lt;%= label_tag(:age_child, &ldquo;I am younger than 21&rdquo;) %&gt;</p>

<p>&lt;%= radio_button_tag(:age, &ldquo;adult&rdquo;) %&gt;</p>

<p>&lt;%= label_tag(:age_adult, &ldquo;I&rsquo;m over 21&rdquo;) %&gt;</p>

<p>Output:<span style="font-family: DejaVu Sans;">输出：</span></p>

<p>&lt;input id=&ldquo;age_child&rdquo; name=&ldquo;age&rdquo; type=&ldquo;radio&rdquo; value=&ldquo;child&rdquo; /&gt;</p>

<p>&lt;label for=&ldquo;age_child&rdquo;&gt;I am younger than 21&lt;/label&gt;</p>

<p>&lt;input id=&ldquo;age_adult&rdquo; name=&ldquo;age&rdquo; type=&ldquo;radio&rdquo; value=&ldquo;adult&rdquo; /&gt;</p>

<p>&lt;label for=&ldquo;age_adult&rdquo;&gt;I&rsquo;m over 21&lt;/label&gt;</p>

<p>As with <tt>check_box_tag</tt>, the second parameter to <tt>radio_button_tag</tt> is the value of the input. Because these two radio buttons share the same name (age) the user will only be able to select one, and <tt>params[:age]</tt> will contain either “child” or “adult”.</p>

<p><span style="font-family: DejaVu Sans;">正如</span><tt>check_box_tag</tt><span style="font-family: DejaVu Sans;"><tt>，</tt><tt></tt></span><tt>radio_button_tag</tt><span style="font-family: DejaVu Sans;"><tt>的第二个参数是</tt></span><tt>input</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>value</tt><span style="font-family: DejaVu Sans;"><tt>。因为这两个</tt></span><tt>radio</tt><tt> </tt><tt>buttons</tt><span style="font-family: DejaVu Sans;"><tt>分享相同的</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>（</tt></span><tt>age</tt><span style="font-family: DejaVu Sans;"><tt>）用户仅仅能够选择一个，并且</tt></span><tt>params[:age]</tt><span style="font-family: DejaVu Sans;"><tt>将会包含或者</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></tt></span><tt>child</tt><tt>”</tt><span style="font-family: DejaVu Sans;"><tt>或者</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></tt></span><tt>adult</tt><tt>”</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>Always use labels for checkbox and radio buttons. They associate text with a specific option and make it easier for users to click the inputs by expanding<span style="font-family: DejaVu Sans;">扩大</span>the clickable region.</p>

<p><span style="font-family: DejaVu Sans;">经常把</span>checkbox<span style="font-family: DejaVu Sans;">或</span>radio button<span style="font-family: DejaVu Sans;">和</span>labels<span style="font-family: DejaVu Sans;">标签一起使用。他们<strong>将文字</strong></span><strong>text</strong><span style="font-family: DejaVu Sans;"><strong>和一个特定的选项管理起来并且通过扩大可点击区域使得用户能够更加容易点击。</strong></span></p>

<h4><a name="other-helpers-of-interest"></a>1.4 Other Helpers of Interest<span style="font-family: WenQuanYi Micro Hei;">其他有趣的</span>Helpers</h4>


<p>Other form controls worth mentioning are textareas, password fields, hidden fields, search fields, telephone fields, URL fields and email fields:</p>

<p><span style="font-family: DejaVu Sans;">其他值得一提的</span>form<span style="font-family: DejaVu Sans;">控件是</span>textareas<span style="font-family: DejaVu Sans;">，</span>password<span style="font-family: DejaVu Sans;">，</span>fields<span style="font-family: DejaVu Sans;">，</span>hidden fields<span style="font-family: DejaVu Sans;">，</span>search fields<span style="font-family: DejaVu Sans;">，</span>telephone fields<span style="font-family: DejaVu Sans;">，</span>URL fields<span style="font-family: DejaVu Sans;">和</span>email fields<span style="font-family: DejaVu Sans;">：</span></p>

<p>other helpers of interest&lt;br /&gt;</p>

<p>&lt;%= label_tag(:message, &ldquo;content&rdquo;) %&gt;</p>

<p>&lt;%= text_area_tag(:message, &ldquo;Hi, nice site&rdquo;, :size =&gt; &ldquo;24x6&rdquo;) %&gt;&lt;br /&gt;</p>

<p>&lt;%= label_tag(:password, &ldquo;password&rdquo;) %&gt;</p>

<p>&lt;%= password_field_tag(:password) %&gt;&lt;br /&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= hidden_field_tag(:parent_id, &ldquo;5&rdquo;) %&gt;&lt;br /&gt;</p>

<p>&lt;%= label_tag(:user_name, &ldquo;search:&rdquo;) %&gt;</p>

<p>&lt;%= search_field(:user, :name) %&gt;&lt;br /&gt;</p>

<p>&lt;%= label_tag(:user_phone, &ldquo;phone&rdquo;) %&gt;</p>

<p>&lt;%= telephone_field(:user, :phone) %&gt;&lt;br /&gt;</p>

<p>&lt;%= label_tag(:user_homepage, &ldquo;homepage&rdquo;) %&gt;</p>

<p>&lt;%= url_field(:user, :homepage) %&gt;&lt;br /&gt;</p>

<p>&lt;%= label_tag(:user_address, &ldquo;address&rdquo;) %&gt;</p>

<p>&lt;%= email_field(:user, :address) %&gt;&lt;br /&gt;</p>

<p>Output:<span style="font-family: DejaVu Sans;">输出：</span></p>

<p>&lt;label for=&ldquo;message&rdquo;&gt;content&lt;/label&gt;</p>

<p>&lt;textarea cols=&ldquo;24&rdquo; id=&ldquo;message&rdquo; name=&ldquo;message&rdquo; rows=&ldquo;6&rdquo;&gt;Hi, nice site&lt;/textarea&gt;&lt;br /&gt;</p>

<p>&lt;label for=&ldquo;password&rdquo;&gt;password&lt;/label&gt;</p>

<p>&lt;input id=&ldquo;password&rdquo; name=&ldquo;password&rdquo; type=&ldquo;password&rdquo; /&gt;&lt;br /&gt;</p>

<p>&nbsp;</p>

<p>&lt;input id=&ldquo;parent_id&rdquo; name=&ldquo;parent_id&rdquo; type=&ldquo;hidden&rdquo; value=&ldquo;5&rdquo; /&gt;&lt;br /&gt;</p>

<p>&lt;label for=&ldquo;user_name&rdquo;&gt;search:&lt;/label&gt;</p>

<p>&lt;input id=&ldquo;user_name&rdquo; name=&ldquo;user[name]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;search&rdquo; /&gt;&lt;br /&gt;</p>

<p>&lt;label for=&ldquo;user_phone&rdquo;&gt;phone&lt;/label&gt;</p>

<p>&lt;input id=&ldquo;user_phone&rdquo; name=&ldquo;user[phone]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;tel&rdquo; /&gt;&lt;br /&gt;</p>

<p>&lt;label for=&ldquo;user_homepage&rdquo;&gt;homepage&lt;/label&gt;</p>

<p>&lt;input id=&ldquo;user_homepage&rdquo; name=&ldquo;user[homepage]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;url&rdquo; /&gt;&lt;br /&gt;</p>

<p>&lt;label for=&ldquo;user_address&rdquo;&gt;address&lt;/label&gt;</p>

<p>&lt;input id=&ldquo;user_address&rdquo; name=&ldquo;user[address]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;email&rdquo; /&gt;&lt;br /</p>

<p>Hidden inputs are not shown to the user but instead hold data like any textual input. Values inside them can be changed with JavaScript.</p>

<p>Hidden inputs<span style="font-family: DejaVu Sans;">不显示给用户但是它可以</span>hold<span style="font-family: DejaVu Sans;">任何文本形式数据的输入。</span>Hidden<span style="font-family: DejaVu Sans;">里面的值可以用</span>JavaScript<span style="font-family: DejaVu Sans;">改变。</span></p>

<p>The search, telephone, URL, and email inputs are HTML5 controls. If you require your app to have a consistent experience in older browsers, you will need an HTML5 polyfill (provided by CSS and/or JavaScript). There is definitely <a href="https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-Browser-Polyfills"><span style="color: #000080;"><span style="text-decoration: underline;">no</span></span><span style="color: #000080;"><span style="text-decoration: underline;">shortage</span></span><span style="color: #000080;"><span style="text-decoration: underline;">of</span></span><span style="color: #000080;"><span style="text-decoration: underline;">solutions</span></span><span style="color: #000080;"><span style="text-decoration: underline;">for</span></span><span style="color: #000080;"><span style="text-decoration: underline;">this</span></span></a>, although a couple of popular tools at the moment are <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://www.modernizr.com/">Modernizr</a></span></span> and <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://yepnopejs.com/">yepnope</a></span></span>, which provide a simple way to add functionality based on the presence of detected HTML5 features.</p>

<p>search, telephone, URL, <span style="font-family: DejaVu Sans;">和</span>email inputs<span style="font-family: DejaVu Sans;">是</span>HTML5<span style="font-family: DejaVu Sans;">控件。如果你需要你的</span>app<span style="font-family: DejaVu Sans;">在旧的浏览器上面拥有兼容的体验，你将需要一个</span>HTML5 polyfill<span style="font-family: DejaVu Sans;">（</span>provided by CSS and/or JavaScript<span style="font-family: DejaVu Sans;">）。这里肯定</span><a href="https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-Browser-Polyfills"><span style="color: #000080;"><span style="text-decoration: underline;">no</span></span><span style="color: #000080;"><span style="text-decoration: underline;">shortage</span></span><span style="color: #000080;"><span style="text-decoration: underline;">of</span></span><span style="color: #000080;"><span style="text-decoration: underline;">solutions</span></span><span style="color: #000080;"><span style="text-decoration: underline;">for</span></span><span style="color: #000080;"><span style="text-decoration: underline;">this</span></span></a><span style="font-family: DejaVu Sans;">（没有针对此类问题一致的解决方法），即使现在有了一组广受欢迎的工具是</span><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://www.modernizr.com/">Modernizr</a></span></span> and <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://yepnopejs.com/">yepnope</a></span></span><span style="font-family: DejaVu Sans;">，他们提供了一个简单的方法来添加检测</span>HTML5<span style="font-family: DejaVu Sans;">特性功能是否存在。</span></p>

<p>&nbsp;</p>

<p>If you’re using password input fields (for any purpose), you might want to configure your application to prevent those parameters from being logged. You can learn about this in the <a href="http://guides.rubyonrails.org/security.html#logging"><span style="color: #000080;"><span style="text-decoration: underline;">Security</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a>.</p>

<p><span style="font-family: DejaVu Sans;">如果你正在使用</span>password input fields<span style="font-family: DejaVu Sans;">（无论何种原因），你可能想配置你的应用程序以防止记录这些参数。你可以从</span><a href="http://guides.rubyonrails.org/security.html#logging"><span style="color: #000080;"><span style="text-decoration: underline;">Security</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a><span style="font-family: DejaVu Sans;">中了解这些信息。</span></p>

<h3><a name="dealing-with-model-objects"></a>2 Dealing with Model Objects</h3>


<h4><a name="model-object-helpers"></a>2.1 Model Object Helpers</h4>


<p>A particularly common task for a form is editing or creating a model object. While the <tt>*<em>tag</tt> helpers can certainly be used for this task they are somewhat verbose as for each tag you would have to ensure the correct parameter name is used and set the default value of the input appropriately. Rails provides helpers tailored to this task. These helpers lack the </em>tag suffix, for example <tt>text_field</tt>, <tt>text_area</tt>.</p>

<p>form<span style="font-family: DejaVu Sans;">的一个格外普遍的任务是编辑或创建一个</span>model<span style="font-family: DejaVu Sans;">对象。然而，无疑</span><tt>*<em>tag</tt><tt> </tt><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>能够在这个任务中使用，他们有点繁琐，为每一个标签，你就必须确保使用中的参数名称的正确使用，并设置适当的输入的默认值。</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>为这个任务量身定制了</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>。这些</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>缺少</tt></span><tt></em>tag</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>后缀，例如</tt></span><tt>text_field,text_area.</tt></p>

<p>For these helpers the first argument is the name of an instance variable and the second is the name of a method (usually an attribute) to call on that object. Rails will set the value of the input control to the return value of that method for the object and set an appropriate input name. If your controller has defined <tt>@person</tt> and that person’s name is Henry then a form containing:</p>

<p><span style="font-family: DejaVu Sans;">对于这些</span>helpers<span style="font-family: DejaVu Sans;">第一个参数是实例变量的</span>name<span style="font-family: DejaVu Sans;">，第二个是方法的名称（通常是一个属性）来调用那个对象。</span>Rails<span style="font-family: DejaVu Sans;">将（传输）</span>input <span style="font-family: DejaVu Sans;">控件的值给该对象的方法的返回值，并设置一个适当的输入名称。如果你的控件</span>name<span style="font-family: DejaVu Sans;">已经被定义为</span><tt>@person</tt><span style="font-family: DejaVu Sans;"><tt>并且</tt><tt></tt></span><tt>person</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>name</tt><tt> </tt><tt>is</tt><tt> </tt><tt>Henry</tt><span style="font-family: DejaVu Sans;"><tt>那么这个</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>包含：</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>text_field(:person,</tt><tt> </tt><tt>:name)</tt><tt> </tt><tt>%&gt;</tt></p>

<p>will produce output similar to</p>

<p>&lt;input id=&ldquo;person_name&rdquo; name=&ldquo;person[name]&rdquo; type=&ldquo;text&rdquo; value=&ldquo;Henry&rdquo;/&gt;</p>

<p>Upon form submission the value entered by the user will be stored in <tt>params[:person][:name]</tt>. The <tt>params[:person]</tt> hash is suitable for passing to <tt>Person.new</tt> or, if <tt>@person</tt> is an instance of Person, <tt>@person.update_attributes</tt>. While the name of an attribute is the most common second parameter to these helpers this is not compulsory. In the example above, as long as person objects have a <tt>name</tt> and a <tt>name=</tt> method Rails will be happy.</p>

<p><span style="font-family: DejaVu Sans;">在用户输入后，并由</span>form<span style="font-family: DejaVu Sans;">提交的值将会被存储在</span><tt>params[:person][:name]</tt><span style="font-family: DejaVu Sans;"><tt>中。</tt></span><tt>params[:person]</tt><span style="font-family: DejaVu Sans;"><tt>相当于</tt><tt></tt></span><tt>Person.new</tt><span style="font-family: DejaVu Sans;"><tt>，如果</tt></span><tt>@person</tt><span style="font-family: DejaVu Sans;"><tt>是一个</tt></span><tt>Person</tt><span style="font-family: DejaVu Sans;"><tt>的实例，则相当于</tt><tt></tt></span><tt>@person.update_attributes</tt><span style="font-family: DejaVu Sans;"><tt>。虽然这些</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>的属性名称最常见的是第二个参数，但这不是强制性的。在例子中，只要</tt></span><tt>Person</tt><span style="font-family: DejaVu Sans;"><tt>对象有一个名称和一个</tt></span><tt>name=method</tt><span style="font-family: DejaVu Sans;"><tt>那么</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>会很乐意。</tt></span></p>

<p>You must pass the name of an instance variable, i.e. <tt>:person</tt> or <tt>&ldquo;person&rdquo;</tt>, not an actual instance of your model object.<span style="font-family: DejaVu Sans;">你必须提供一个实例变量的名称，</span>i.e. <tt>:person</tt> or <tt>&ldquo;person&rdquo;</tt><span style="font-family: DejaVu Sans;"><tt>，不是一个你</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>对象中实际的实例。</tt></span></p>

<p><strong>Rails</strong><strong> </strong><strong>provides</strong><strong> </strong><strong>helpers</strong><strong> </strong><strong>for</strong><strong> </strong><strong>displaying</strong><strong> </strong><strong>the</strong><strong> </strong><strong>validation</strong><strong> </strong><strong>errors</strong><strong> </strong><strong>associated</strong><strong> </strong><strong>with</strong><strong> </strong><strong>a</strong><strong> </strong><strong>model</strong><strong> </strong><strong>object.</strong><strong> </strong><strong>These</strong><strong> </strong><strong>are</strong><strong> </strong><strong>covered</strong><strong> </strong><strong>in</strong><strong> </strong><strong>detail</strong><strong> </strong><strong>by</strong><strong> </strong><strong>the</strong><strong> </strong><a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#displaying-validation-errors-in-the-view"><span style="color: #000080;"><span style="text-decoration: underline;"><strong>Active</strong></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><strong>Record</strong></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><strong>Validations</strong></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><strong>and</strong></span></span><span style="color: #000080;"><span style="text-decoration: underline;"><strong>Callbacks</strong></span></span></a><strong> </strong><strong>guide.</strong></p>

<h4><a name="binding-a-form-to-an-object"></a>2.2 Binding a Form to an Object<span style="font-family: WenQuanYi Micro Hei;">将</span>form<span style="font-family: WenQuanYi Micro Hei;">和</span>Object<span style="font-family: WenQuanYi Micro Hei;">绑定</span></h4>


<p>While this is an increase in comfort it is far from perfect. If Person has many attributes to edit then we would be repeating the name of the edited object many times. What we want to do is somehow bind a form to a model object, which is exactly what <tt>form_for</tt> does.</p>

<p><span style="font-family: DejaVu Sans;">虽然添加的这些功能让我们（在使用中）感到舒适但离完美远远不够。如果</span>Person<span style="font-family: DejaVu Sans;">拥有多个属性需要编辑然后我们将会重复被编辑</span>object<span style="font-family: DejaVu Sans;">的</span>name<span style="font-family: DejaVu Sans;">很多次。我们想要（</span>Rails<span style="font-family: DejaVu Sans;">）做的是以某种方式将</span>model object<span style="font-family: DejaVu Sans;">和</span>form<span style="font-family: DejaVu Sans;">绑定，这也恰好是</span><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>要做的。</tt></span></p>

<p>Assume we have a controller for dealing with articles <tt>app/controllers/articles_controller.rb</tt>:</p>

<p><span style="font-family: DejaVu Sans;"><tt>假设我们有一个</tt></span><tt>controller(app/controllers/articles_controller.rb)</tt><span style="font-family: DejaVu Sans;"><tt>来处理</tt></span><tt>articles:</tt></p>

<p>def new</p>

<p>@article = Article.new</p>

<p>end</p>

<p>The corresponding view <tt>app/views/articles/new.html.erb</tt> using <tt>form_for</tt> looks like this:</p>

<p>&lt;%= form_for @article, :url =&gt; { :action =&gt; &ldquo;create&rdquo; }, :html =&gt; {:class =&gt; &ldquo;nifty_form&rdquo;} do |f| %&gt;</p>

<p>&lt;%= f.text_field :title %&gt;</p>

<p>&lt;%= f.text_area :body, :size =&gt; &ldquo;60x12&rdquo; %&gt;</p>

<p>&lt;%= f.submit &ldquo;Create&rdquo; %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>There are a few things to note here:<span style="font-family: DejaVu Sans;">这里对其做的事情备注如下：</span></p>

<ol>
    <li><tt>@article</tt> is the actual object being edited. <tt>@article</tt><span style="font-family: DejaVu Sans;"><tt>是实际上被编辑的</tt></span><tt>object</tt></li>
    <li>There is a single hash of options. Routing options are passed in the <tt>:url</tt> hash, HTML options are passed in the <tt>:html</tt> hash. <span style="font-family: DejaVu Sans;">这里是一个单个</span>hash<span style="font-family: DejaVu Sans;">字典的选项。</span>Routing<span style="font-family: DejaVu Sans;">选项通过</span>:url hash<span style="font-family: DejaVu Sans;">键对提供，</span>HTML<span style="font-family: DejaVu Sans;">选项通过</span>:html hash<span style="font-family: DejaVu Sans;">键对提供</span></li>
    <li>The <tt>form_for</tt> method yields a <strong>form</strong><strong> </strong><strong>builder</strong> object (the <tt>f</tt> variable).</li>
    <li>Methods to create form controls are called <strong>on</strong> the form builder object <tt>f</tt><span style="font-family: DejaVu Sans;"><tt>创建</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>控件的方法是通过调用</tt></span><tt>object</tt><tt> </tt><tt>f</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>form</tt><tt> </tt><tt>builder</tt></li>
</ol>


<p>The resulting HTML is:</p>

<p>&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/articles/create&rdquo; method=&ldquo;post&rdquo; class=&ldquo;nifty_form&rdquo;&gt;</p>

<p>&lt;input id=&ldquo;article_title&rdquo; name=&ldquo;article[title]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;text&rdquo; /&gt;</p>

<p>&lt;textarea id=&ldquo;article_body&rdquo; name=&ldquo;article[body]&rdquo; cols=&ldquo;60&rdquo; rows=&ldquo;12&rdquo;&gt;&lt;/textarea&gt;</p>

<p>&lt;input name=&ldquo;commit&rdquo; type=&ldquo;submit&rdquo; value=&ldquo;Create&rdquo; /&gt;</p>

<p>&lt;/form&gt;</p>

<p>The name passed to <tt>form_for</tt> controls the key used in <tt>params</tt> to access the form’s values. Here the name is <tt>article</tt> and so all the inputs have names of the form <tt>article[</tt><em>attribute_name</em><tt>]</tt>. Accordingly, in the <tt>create</tt> action <tt>params[:article]</tt> will be a hash with keys <tt>:title</tt> and <tt>:body</tt>. You can read more about the significance of input names in the parameter_names section.</p>

<p><span style="font-family: DejaVu Sans;">通过</span><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>控件的</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>以及</tt></span><tt>parmas</tt><span style="font-family: DejaVu Sans;"><tt>使用的关键字来接收</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>的值。这里的</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>是</tt></span><tt>article</tt><span style="font-family: DejaVu Sans;"><tt>并且</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>所有的</tt></span><tt>inputs</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>都是</tt><tt></tt></span><tt>article[</tt><em>attribute_name</em><tt>]</tt><span style="font-family: DejaVu Sans;"><tt>。因此，在</tt></span><tt>create</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>中</tt><tt></tt></span><tt>params[:article]</tt><span style="font-family: DejaVu Sans;"><tt>将会有关键字</tt></span><tt>:title</tt><tt> </tt><tt>and</tt><tt> </tt><tt>:body</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt><strong>键值</strong></tt><tt>。你可以阅读更多的</tt></span><tt>input</tt><tt> </tt><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>的含义在</tt><tt></tt></span><tt>parameter_names</tt><span style="font-family: DejaVu Sans;"><tt>章节。</tt></span></p>

<p>The helper methods called on the form builder are identical<span style="font-family: DejaVu Sans;">相同一致</span>to the model object helpers except that it is not necessary to specify which object is being edited since this is already managed by the form builder.</p>

<p><span style="font-family: DejaVu Sans;">这个调用</span>form builder<span style="font-family: DejaVu Sans;">的</span>helper<span style="font-family: DejaVu Sans;">方法除了不需要指定那个</span>object<span style="font-family: DejaVu Sans;">被编辑既然这已经交给</span>form builder<span style="font-family: DejaVu Sans;">管理，其他部分与</span>model object helpers<span style="font-family: DejaVu Sans;">一致。</span></p>

<p>You can create a similar binding without actually creating <tt>&lt;form&gt;</tt> tags with the <tt>fields_for</tt> helper. This is useful for editing additional model objects with the same form. For example if you had a Person model with an associated ContactDetail model you could create a form for creating both like so:</p>

<p><span style="font-family: DejaVu Sans;">你可以创建一个类似的</span>tags<span style="font-family: DejaVu Sans;">组合却没有真正的使用</span>fields_for helper<span style="font-family: DejaVu Sans;">创建</span>&lt;form&gt; tags<span style="font-family: DejaVu Sans;">。这在使用相同的</span>form<span style="font-family: DejaVu Sans;">编辑额外的对象的时候非常有用。例如如果你有一个</span>Person model<span style="font-family: DejaVu Sans;">以及相关联的</span>ContactDetail model<span style="font-family: DejaVu Sans;">你可以创建一个</span>form<span style="font-family: DejaVu Sans;">来创建他们两个如下：</span></p>

<p>&lt;%= form_for @person, :url =&gt; { :action =&gt; &ldquo;create&rdquo; } do |person_form| %&gt;</p>

<p>&lt;%= person_form.text_field :name %&gt;</p>

<p>&lt;%= fields_for @person.contact_detail do |contact_details_form| %&gt;</p>

<p>&lt;%= contact_details_form.text_field :phone_number %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>which produces the following output:</p>

<p>&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/people/create&rdquo; id=&ldquo;new_person&rdquo; method=&ldquo;post&rdquo;&gt;</p>

<p>&lt;input id=&ldquo;person_name&rdquo; name=&ldquo;person[name]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;text&rdquo; /&gt;</p>

<p>&lt;input id=&ldquo;contact_detail_phone_number&rdquo; name=&ldquo;contact_detail[phone_number]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;text&rdquo; /&gt;</p>

<p>&lt;/form&gt;</p>

<p>The object yielded by <tt>fields_for</tt> is a form builder like the one yielded by <tt>form_for</tt> (in fact <tt>form_for</tt> calls <tt>fields_for</tt> internally<span style="font-family: DejaVu Sans;">（在内部调用</span><tt>fields_for</tt><span style="font-family: DejaVu Sans;">）</span>).</p>

<h4><a name="relying-on-record-identification"></a>2.3 Relying on Record Identification<span style="font-family: WenQuanYi Micro Hei;">依托于记录的识别</span></h4>


<p>The Article model is directly available to users of the application, so — following the best practices for developing with Rails — you should declare it <strong>a</strong><strong> </strong><strong>resource</strong>:</p>

<p>Article<span style="font-family: DejaVu Sans;">模型是应用程序用户直接可用的，因此<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>遵循</span>Rails<span style="font-family: DejaVu Sans;">开发最好的实践<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>你应该声明它为一个</span><strong>resource</strong>:</p>

<p>resources :articles</p>

<p>Declaring a resource has a number of side-effects<span style="font-family: DejaVu Sans;">（官网上是</span>side-affects<span style="font-family: DejaVu Sans;">错别字？）</span>. See <a href="http://guides.rubyonrails.org/routing.html#resource-routing-the-rails-default"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Routing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">From</span></span><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Outside</span></span><span style="color: #000080;"><span style="text-decoration: underline;">In</span></span></a> for more information on setting up and using resources.</p>

<p><span style="font-family: DejaVu Sans;">声明一个</span>resource<span style="font-family: DejaVu Sans;">会有一系列的副作用。查看</span><a href="http://guides.rubyonrails.org/routing.html#resource-routing-the-rails-default"><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Routing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">From</span></span><span style="color: #000080;"><span style="text-decoration: underline;">the</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Outside</span></span><span style="color: #000080;"><span style="text-decoration: underline;">In</span></span></a><span style="font-family: DejaVu Sans;">来获取在设定和使用</span>resource<span style="font-family: DejaVu Sans;">的更多信息。</span></p>

<p>When dealing with RESTful resources, calls to <tt>form_for</tt> can get significantly easier if you rely on <strong>record</strong><strong> </strong><strong>identification</strong>. In short, you can just pass the model instance and have Rails figure out model name and the rest:</p>

<p><span style="font-family: DejaVu Sans;">当在处理</span>RESTful resources<span style="font-family: DejaVu Sans;">的时候，调用</span><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>会明显简单的多如果你</tt></span><tt>rely</tt><tt> </tt><tt>on</tt><tt> </tt><strong>record</strong><strong> </strong><strong>identification</strong><span style="font-family: DejaVu Sans;"><tt>。简而言之，你可以仅仅通过</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>实例和</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>来</tt></span><tt>figure</tt><tt> </tt><tt>out</tt><span style="font-family: DejaVu Sans;"><tt>（谋取）</tt></span><tt>model</tt><tt> </tt><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>或者重设它：</tt></span></p>

<p><tt>##</tt><tt> </tt><tt>Creating</tt><tt> </tt><tt>a</tt><tt> </tt><tt>new</tt><tt> </tt><tt>article</tt></p>

<p><tt>#</tt><tt> </tt><tt>long-style:</tt></p>

<p><tt>form_for(@article,</tt><tt> </tt><tt>:url</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>articles_path)</tt></p>

<p><tt>#</tt><tt> </tt><tt>same</tt><tt> </tt><tt>thing,</tt><tt> </tt><tt>short-style</tt><tt> </tt><tt>(record</tt><tt> </tt><tt>identification</tt><tt> </tt><tt>gets</tt><tt> </tt><tt>used):</tt></p>

<p><tt>form_for(@article)</tt></p>

<p>&nbsp;</p>

<p><tt>##</tt><tt> </tt><tt>Editing</tt><tt> </tt><tt>an</tt><tt> </tt><tt>existing</tt><tt> </tt><tt>article</tt></p>

<p><tt>#</tt><tt> </tt><tt>long-style:</tt></p>

<p><tt>form_for(@article,</tt><tt> </tt><tt>:url</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>article_path(@article),</tt><tt> </tt><tt>:html</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>{</tt><tt> </tt><tt>:method</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&ldquo;put&rdquo;</tt><tt> </tt><tt>})</tt></p>

<p><tt>#</tt><tt> </tt><tt>short-style:</tt></p>

<p><tt>form_for(@article)</tt></p>

<p><tt>Notice</tt><tt> </tt><tt>how</tt><tt> </tt><tt>the</tt><tt> </tt><tt>short-style</tt><tt> </tt><tt>form_for</tt><tt> </tt><tt>invocation</tt><tt> </tt><tt>is</tt><tt> </tt><tt>conveniently</tt><tt> </tt><tt>the</tt><tt> </tt><tt>same,</tt><tt> </tt><tt>regardless</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>record</tt><tt> </tt><tt>being</tt><tt> </tt><tt>new</tt><tt> </tt><tt>or</tt><tt> </tt><tt>existing.</tt><tt> </tt><tt>Record</tt><tt> </tt><tt>identification</tt><tt> </tt><tt>is</tt><tt> </tt><tt>smart</tt><tt> </tt><tt>enough</tt><tt> </tt><tt>to</tt><tt> </tt><tt>figure</tt><tt> </tt><tt>out</tt><tt> </tt><tt>if</tt><tt> </tt><tt>the</tt><tt> </tt><tt>record</tt><tt> </tt><tt>is</tt><tt> </tt><tt>new</tt><tt> </tt><tt>by</tt><tt> </tt><tt>asking</tt><tt> </tt><tt>record.new_record?.</tt><tt> </tt><tt>It</tt><tt> </tt><tt>also</tt><tt> </tt><tt>selects</tt><tt> </tt><tt>the</tt><tt> </tt><tt>correct</tt><tt> </tt><tt>path</tt><tt> </tt><tt>to</tt><tt> </tt><tt>submit</tt><tt> </tt><tt>to</tt><tt> </tt><tt>and</tt><tt> </tt><tt>the</tt><tt> </tt><tt>name</tt><tt> </tt><tt>based</tt><tt> </tt><tt>on</tt><tt> </tt><tt>the</tt><tt> </tt><tt>class</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>object.</tt></p>

<p><span style="font-family: DejaVu Sans;"><tt>注意</tt></span><tt>short-style</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>的调用相对如此的方便，无论这个记录是刚开始还是已经存在了。</tt><tt></tt></span><tt>Record</tt><tt> </tt><tt>identification</tt><span style="font-family: DejaVu Sans;"><tt>能够智能识别如果记录是否是</tt></span><tt>new</tt><span style="font-family: DejaVu Sans;"><tt>通过询问</tt></span><tt>record.new_record?</tt><span style="font-family: DejaVu Sans;"><tt>。它也选择正确的提交路径并且它的</tt></span><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>基于</tt></span><tt>object</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>class</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>Rails</tt><tt> </tt><tt>will</tt><tt> </tt><tt>also</tt><tt> </tt><tt>automatically</tt><tt> </tt><tt>set</tt><tt> </tt><tt>the</tt><tt> </tt><tt>class</tt><tt> </tt><tt>and</tt><tt> </tt><tt>id</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>form</tt><tt> </tt><tt>appropriately:</tt><tt> </tt><tt>a</tt><tt> </tt><tt>form</tt><tt> </tt><tt>creating</tt><tt> </tt><tt>an</tt><tt> </tt><tt>article</tt><tt> </tt><tt>would</tt><tt> </tt><tt>have</tt><tt> </tt><tt>id</tt><tt> </tt><tt>and</tt><tt> </tt><tt>class</tt><tt> </tt><tt>new_article.</tt><tt> </tt><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>were</tt><tt> </tt><tt>editing</tt><tt> </tt><tt>the</tt><tt> </tt><tt>article</tt><tt> </tt><tt>with</tt><tt> </tt><tt>id</tt><tt> </tt><tt>23,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>class</tt><tt> </tt><tt>would</tt><tt> </tt><tt>be</tt><tt> </tt><tt>set</tt><tt> </tt><tt>to</tt><tt> </tt><tt>edit_article</tt><tt> </tt><tt>and</tt><tt> </tt><tt>the</tt><tt> </tt><tt>id</tt><tt> </tt><tt>to</tt><tt> </tt><tt>edit_article_23.</tt><tt> </tt><tt>These</tt><tt> </tt><tt>attributes</tt><tt> </tt><tt>will</tt><tt> </tt><tt>be</tt><tt> </tt><tt>omitted</tt><span style="font-family: DejaVu Sans;"><tt>省略</tt><tt></tt></span><tt>for</tt><tt> </tt><tt>brevity</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>rest</tt><tt> </tt><tt>of</tt><tt> </tt><tt>this</tt><tt> </tt><tt>guide.</tt></p>

<p><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>也会适当的自动的设置</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>（元素）的</tt></span><tt>class</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>：一个（用于）创建一个</tt></span><tt>article</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>fom</tt><span style="font-family: DejaVu Sans;"><tt>将会拥有</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>classnew_article</tt><span style="font-family: DejaVu Sans;"><tt>。如果你在正编辑</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>为</tt></span><tt>23</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>article</tt><span style="font-family: DejaVu Sans;"><tt>，它的</tt></span><tt>class</tt><span style="font-family: DejaVu Sans;"><tt>属性将会被设置为</tt></span><tt>edit_article</tt><span style="font-family: DejaVu Sans;"><tt>并且</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>为</tt></span><tt>edit_article_23</tt><span style="font-family: DejaVu Sans;"><tt>。为了教程的简洁，这些属性将会被部分忽略。</tt></span></p>

<p>When you’re using STI (single-table inheritance) with your models, you can’t rely on record identification on a subclass if only their parent class is declared a resource. You will have to specify the model name, :url, and :method explicitly.</p>

<p>当你正在你的model中使用STI（single-table inheritance），你不能在一个子类中使用 rely on record identification除非他的父类被声明为一个resource。（那么）你将不得不准确的指定model name，:url,:method。</p>

<h5><a name="dealing-with-namespaces"></a><tt>2.3.1</tt><tt> </tt><tt>Dealing</tt><tt> </tt><tt>with</tt><tt> </tt><tt>Namespaces</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>使用名称空间处理（业务）</tt></span></h5>


<p>If you have created namespaced routes, <tt>form_for</tt> has a nifty shorthand for that too. If your application has an admin namespace then</p>

<p><span style="font-family: DejaVu Sans;"><tt>如果你已经创建一个</tt></span><tt>namespaced</tt><tt> </tt><tt>routes</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>拥有一个可爱的快捷操作来做这些。如果你的应用程序拥有一个</tt></span><tt>admin</tt><tt> </tt><tt>namespace</tt><span style="font-family: DejaVu Sans;"><tt>然后</tt></span></p>

<p><tt>form_for</tt><tt> </tt><tt>[:admin,</tt><tt> </tt><tt>@article]</tt></p>

<p><tt>will</tt><tt> </tt><tt>create</tt><tt> </tt><tt>a</tt><tt> </tt><tt>form</tt><tt> </tt><tt>that</tt><tt> </tt><tt>submits</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>articles</tt><tt> </tt><tt>controller</tt><tt> </tt><tt>inside</tt><tt> </tt><tt>the</tt><tt> </tt><tt>admin</tt><tt> </tt><tt>namespace</tt><tt> </tt><tt>(submitting</tt><tt> </tt><tt>to</tt><tt> </tt><tt>admin_article_path(@article)</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>case</tt><tt> </tt><tt>of</tt><tt> </tt><tt>an</tt><tt> </tt><tt>update).</tt><tt> </tt><tt>If</tt><tt> </tt><tt>you</tt><tt> </tt><tt>have</tt><tt> </tt><tt>several</tt><tt> </tt><tt>levels</tt><tt> </tt><tt>of</tt><tt> </tt><tt>namespacing</tt><tt> </tt><tt>then</tt><tt> </tt><tt>the</tt><tt> </tt><tt>syntax</tt><tt> </tt><tt>is</tt><tt> </tt><tt>similar:</tt></p>

<p><span style="font-family: DejaVu Sans;"><tt>将会创建一个</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>它会提交（信息）到在</tt></span><tt>admin</tt><tt> </tt><tt>namespace</tt><span style="font-family: DejaVu Sans;"><tt>（比如在</tt></span><tt>update</tt><span style="font-family: DejaVu Sans;"><tt>情况下会提交到</tt><tt></tt></span><tt>admin_article_path(@article)</tt><span style="font-family: DejaVu Sans;"><tt>）中的</tt></span><tt>articles</tt><tt> </tt><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>。如果你有一系列等级的</tt></span><tt>name</tt><tt> </tt><tt>spacing</tt><span style="font-family: DejaVu Sans;"><tt>然后将会有语法智能（处理他们）：</tt></span></p>

<p><tt>form_for</tt><tt> </tt><tt>[:admin,</tt><tt> </tt><tt>:management,</tt><tt> </tt><tt>@article]</tt></p>

<p><tt>For</tt><tt> </tt><tt>more</tt><tt> </tt><tt>information</tt><tt> </tt><tt>on</tt><tt> </tt><tt>Rails</tt><tt>’ </tt><tt>routing</tt><tt> </tt><tt>system</tt><tt> </tt><tt>and</tt><tt> </tt><tt>the</tt><tt> </tt><tt>associated</tt><tt> </tt><tt>conventions,</tt><tt> </tt><tt>please</tt><tt> </tt><tt>see</tt><tt> </tt><tt>the</tt><tt> </tt><a href="http://guides.rubyonrails.org/routing.html"><span style="color: #000080;"><span style="text-decoration: underline;">routing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">guide</span></span></a><tt>.</tt></p>

<p><span style="font-family: DejaVu Sans;"><tt>得到更多的关于</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>routing</tt><span style="font-family: DejaVu Sans;"><tt>和关联约定，请阅读</tt><tt></tt></span><a href="http://guides.rubyonrails.org/routing.html"><span style="color: #000080;"><span style="text-decoration: underline;">routing</span></span><span style="color: #000080;"><span style="text-decoration: underline;">guide</span></span></a><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="how-do-forms-with-put-or-delete-methods-"></a> 2.4 How do forms with PUT or DELETE methods work?<span style="font-family: WenQuanYi Micro Hei;">表单的</span>PUT<span style="font-family: WenQuanYi Micro Hei;">或者</span>DELETE<span style="font-family: WenQuanYi Micro Hei;">方法是如何工作的</span></h4>


<p>The Rails framework encourages RESTful design of your applications, which means you’ll be making a lot of “PUT” and “DELETE” requests (besides “GET” and “POST”). However, most browsers <em>don</em><em>’</em><em>t</em><em> </em><em>support</em> methods other than “GET” and “POST” when it comes to submitting forms.</p>

<p>Rails<span style="font-family: DejaVu Sans;">框架鼓励在你的应用程序中使用</span>RESTful<span style="font-family: DejaVu Sans;">风格设计，意思是你将会产生许多<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>PUT”<span style="font-family: DejaVu Sans;">和<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>DELETE”<span style="font-family: DejaVu Sans;">请求（在<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>GET”AND“POST”<span style="font-family: DejaVu Sans;">之后）。然而，大多数的浏览器在提交表单的时候并不支持超过<span style="font-family: Liberation Serif,Times New Roman,serif;">”</span></span>GET”AND”POST”<span style="font-family: DejaVu Sans;">之外的方法。</span></p>

<p>Rails works around this issue by emulating<span style="font-family: DejaVu Sans;">模拟</span>other methods over POST with a hidden input named <tt>&ldquo;_method&rdquo;</tt>, which is set to reflect the desired method:</p>

<p>Rails<span style="font-family: DejaVu Sans;">围绕这个问题通过在</span>POST<span style="font-family: DejaVu Sans;">之外添加一个隐藏的（命名为</span><tt>&ldquo;_method&rdquo;</tt><span style="font-family: DejaVu Sans;">）</span>input<span style="font-family: DejaVu Sans;">标签来模拟其他的方法，这个</span>input<span style="font-family: DejaVu Sans;">标签被用来呈现所需的方法：</span></p>

<p>form_tag(search_path, :method =&gt; &ldquo;put&rdquo;)</p>

<p>output:</p>

<p>&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/search&rdquo; method=&ldquo;post&rdquo;&gt;</p>

<p>&lt;div style=&ldquo;margin:0;padding:0&rdquo;&gt;</p>

<p>&lt;input name=&ldquo;_method&rdquo; type=&ldquo;hidden&rdquo; value=&ldquo;put&rdquo; /&gt;</p>

<p>&lt;input name=&ldquo;utf8&rdquo; type=&ldquo;hidden&rdquo; value=&ldquo;&amp;#x2713;&rdquo; /&gt;</p>

<p>&lt;input name=&ldquo;authenticity_token&rdquo; type=&ldquo;hidden&rdquo; value=&ldquo;f755bb0ed134b76c432144748a6d4b7a7ddf2b71&rdquo; /&gt;</p>

<p>&lt;/div&gt;</p>

<p>&hellip;</p>

<p>When parsing POSTed data, Rails will take into account the special <tt>_method</tt> parameter and acts as if the HTTP method was the one specified inside it (“PUT” in this example).</p>

<p><span style="font-family: DejaVu Sans;">当解析</span>POSTed<span style="font-family: DejaVu Sans;">数据的时候，</span>Rails<span style="font-family: DejaVu Sans;">将会出进入指定的</span><tt>_method</tt><span style="font-family: DejaVu Sans;"><tt>参数并且如果有一个</tt></span><tt>HTTP</tt><span style="font-family: DejaVu Sans;"><tt>方法在里面被指定了（本例中是</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">”</span></tt></span><tt>PUT</tt><tt>”</tt><span style="font-family: DejaVu Sans;"><tt>）。</tt></span></p>

<h3><a name="making-select-boxes-with-ease"></a>3 Making Select Boxes with Ease<span style="font-family: WenQuanYi Micro Hei;">使用容易（的方式）来生成</span>Select Boxes</h3>


<p>Select boxes in HTML require a significant<span style="font-family: DejaVu Sans;">（明显）</span>amount of markup (one <tt>OPTION</tt> element for each option to choose from), therefore it makes the most sense for them to be dynamically generated.</p>

<p>Select boxes<span style="font-family: DejaVu Sans;">在</span>HTML<span style="font-family: DejaVu Sans;">需要标明</span>markup<span style="font-family: DejaVu Sans;">的数量</span>(<span style="font-family: DejaVu Sans;">一个</span>OPTION<span style="font-family: DejaVu Sans;">元素对应需要选择的每一个选项</span>)<span style="font-family: DejaVu Sans;">，因此对于他们的动态生成这是有意义的。</span></p>

<p>Here is what the markup might look like:<span style="font-family: DejaVu Sans;">这里是</span>markup<span style="font-family: DejaVu Sans;">可能的样子：</span></p>

<p>&lt;select name=&ldquo;city_id&rdquo; id=&ldquo;city_id&rdquo;&gt;</p>

<p>&lt;option value=&ldquo;1&rdquo;&gt;Lisbon&lt;/option&gt;</p>

<p>&lt;option value=&ldquo;2&rdquo;&gt;Madrid&lt;/option&gt;</p>

<p>&hellip;</p>

<p>&lt;option value=&ldquo;12&rdquo;&gt;Berlin&lt;/option&gt;</p>

<p>&lt;/select&gt;</p>

<p>Here you have a list of cities whose names are presented to the user. Internally the application only wants to handle their IDs so they are used as the options’ value attribute. Let’s see how Rails can help out here.</p>

<p><span style="font-family: DejaVu Sans;">这里你有一个城市的列表这个列表的名字被呈现给用户。在应用程序的内部只希望处理它们的</span>IDs<span style="font-family: DejaVu Sans;">因此它们通过</span>option‘s<span style="font-family: DejaVu Sans;">的</span>value<span style="font-family: DejaVu Sans;">属性来使用。让我们看看</span>Rails<span style="font-family: DejaVu Sans;">是如何帮助输出这里的代码的。</span></p>

<h4><a name="the-select-and-option-tags"></a>3.1 The Select and Option Tags Select<span style="font-family: WenQuanYi Micro Hei;">和</span>Option<span style="font-family: WenQuanYi Micro Hei;">标签</span></h4>


<p>The most generic helper is <tt>select_tag</tt>, which — as the name implies — simply generates the <tt>SELECT</tt> tag that encapsulates an options string:</p>

<p><span style="font-family: DejaVu Sans;">最常见的生成器</span>helper<span style="font-family: DejaVu Sans;">是</span><tt>select_tag</tt><span style="font-family: DejaVu Sans;"><tt>，它</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></tt><tt>就像名字的意思</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></tt><tt>简单的生成</tt></span><tt>SELECT</tt><span style="font-family: DejaVu Sans;"><tt>标签在其中封装一个选项字符串：</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>select_tag(:city_id,</tt><tt> </tt><tt>&lsquo;&lt;option</tt><tt> </tt><tt>value=&ldquo;1&rdquo;&gt;Lisbon&lt;/option&gt;&hellip;&rsquo;)</tt><tt> </tt><tt>%&gt;</tt></p>

<p>This is a start, but it doesn’t dynamically create the option tags. You can generate option tags with the <tt>options_for_select</tt> helper:</p>

<p><span style="font-family: DejaVu Sans;">这是开始，但是它不会动态创建</span>option<span style="font-family: DejaVu Sans;">标签。你可以在</span><tt>options_for_select</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>中</tt>创建</span>option<span style="font-family: DejaVu Sans;">标签：</span></p>

<p>&lt;%= options_for_select([[&lsquo;Lisbon&rsquo;, 1], [&lsquo;Madrid&rsquo;, 2], &hellip;]) %&gt;</p>

<p>&nbsp;</p>

<p>output:</p>

<p>&nbsp;</p>

<p>&lt;option value=&ldquo;1&rdquo;&gt;Lisbon&lt;/option&gt;</p>

<p>&lt;option value=&ldquo;2&rdquo;&gt;Madrid&lt;/option&gt;</p>

<p>&hellip;</p>

<p>The first argument to <tt>options_for_select</tt> is a nested array where each element has two elements: option text (city name) and option value (city id). The option value is what will be submitted to your controller. Often this will be the id of a corresponding database object but this does not have to be the case.</p>

<p><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>的第一个参数是一个嵌套数组它的的每一个元素有两个元素：</tt></span><tt>option</tt><tt> </tt><tt>text</tt><span style="font-family: DejaVu Sans;"><tt>（</tt></span><tt>city</tt><tt> </tt><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>）和</tt></span><tt>option</tt><tt> </tt><tt>value</tt><span style="font-family: DejaVu Sans;"><tt>（</tt></span><tt>city</tt><tt> </tt><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>）。这里的</tt></span><tt>option</tt><tt> </tt><tt>value</tt><span style="font-family: DejaVu Sans;"><tt>将会被提交到你的</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>中。通常这里会有</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>和其相应的数据库对象但是并不完全是这样。</tt></span></p>

<p><tt>Knowing</tt><tt> </tt><tt>this,</tt><tt> </tt><tt>you</tt><tt> </tt><tt>can</tt><tt> </tt><tt>combine</tt><tt> </tt><tt>select_tag</tt><tt> </tt><tt>and</tt><tt> </tt><tt>options_for_select</tt><tt> </tt><tt>to</tt><tt> </tt><tt>achieve</tt><tt> </tt><tt>the</tt><tt> </tt><tt>desired,</tt><tt> </tt><tt>complete</tt><tt> </tt><tt>markup:</tt></p>

<p><span style="font-family: DejaVu Sans;">知道这些，你可结合</span><tt>select_tag</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>到达预期的（目标），完成</tt></span><tt>markup</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>select_tag(:city_id,</tt><tt> </tt><tt>options_for_select(&hellip;))</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt>options_for_select</tt> allows you to pre-select an option by passing its value.</p>

<p><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>允许你预选择一个选项通过它的值。</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>options_for_select([[&lsquo;Lisbon&rsquo;,</tt><tt> </tt><tt>1],</tt><tt> </tt><tt>[&lsquo;Madrid&rsquo;,</tt><tt> </tt><tt>2],</tt><tt> </tt><tt>&hellip;],</tt><tt> </tt><tt>2)</tt><tt> </tt><tt>%&gt;</tt></p>

<p>&nbsp;</p>

<p><tt>output:</tt></p>

<p>&nbsp;</p>

<p><tt>&lt;option</tt><tt> </tt><tt>value=&ldquo;1&rdquo;&gt;Lisbon&lt;/option&gt;</tt></p>

<p><tt>&lt;option</tt><tt> </tt><tt>value=&ldquo;2&rdquo;</tt><tt> </tt><tt>selected=&ldquo;selected&rdquo;&gt;Madrid&lt;/option&gt;</tt></p>

<p><tt>&hellip;</tt></p>

<p>bellow is my code in templates<span style="font-family: DejaVu Sans;">：</span></p>

<p>&lt;!&mdash;it not work&mdash;&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= select_tag(:city_id, &lsquo;&lt;option value=&ldquo;1&rdquo;&gt;Lisbon&lt;/option&gt;&lt;option value=&ldquo;2&rdquo;&gt;Madrid&lt;/option&gt;&rsquo;) %&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= options_for_select([[&lsquo;Lisbon&rsquo;, 1], [&lsquo;Madrid&rsquo;, 2] ], 2)%&gt;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>combine select_tag and options_for_select combine select_tag and options_for_select:&lt;br /&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= select_tag(:city_id, options_for_select([[&lsquo;Lisbon&rsquo;, 1], [&lsquo;Madrid&rsquo;, 2] ], 2)) %&gt;</p>

<p>&nbsp;</p>

<p>Whenever Rails sees that the internal value of an option being generated matches this value, it will add the <tt>selected</tt> attribute to that option.</p>

<p><span style="font-family: DejaVu Sans;">无论何时</span>Rails<span style="font-family: DejaVu Sans;">发现开始创建的</span>option tag<span style="font-family: DejaVu Sans;">的值匹配</span>option<span style="font-family: DejaVu Sans;">内部的值（设定的默认选中的值），</span></p>

<p><span style="font-family: DejaVu Sans;">，将会添加</span>selected<span style="font-family: DejaVu Sans;">属性到这个选项。</span></p>

<p>The second argument to <tt>options_for_select</tt> must be exactly equal to the desired internal value. In particular if the value is the integer 2 you cannot pass “2” to <tt>options_for_select</tt> — you must pass 2. Be aware of values extracted from the <tt>params</tt> hash as they are all strings.</p>

<p><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>的第二个参数必须准确等于预期的内部的值。特别是如果这个值是整数</tt></span><tt>2</tt><span style="font-family: DejaVu Sans;"><tt>你不能传送</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></tt></span><tt>2</tt><tt>”</tt><span style="font-family: DejaVu Sans;"><tt>给</tt><tt></tt></span><tt>options_for_select</tt><tt>——</tt><span style="font-family: DejaVu Sans;"><tt>你必须传送</tt></span><tt>2</tt><span style="font-family: DejaVu Sans;"><tt>。在这个值来自</tt></span><tt>params</tt><tt> </tt><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>的时候你必须保持清醒因为它们全都是</tt></span><tt>strings</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="select-boxes-for-dealing-with-models"></a> <tt>3.2</tt><tt> </tt><tt>Select</tt><tt> </tt><tt>Boxes</tt><tt> </tt><tt>for</tt><tt> </tt><tt>Dealing</tt><tt> </tt><tt>with</tt><tt> </tt><tt>Models</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>使用</tt></span><tt>Select</tt><tt> </tt><tt>Boxes</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>来处理</tt></span><tt>Models#</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>外键的</tt></span><tt>select</tt><tt> </tt><tt>boxes</tt></h4>


<p>In most cases form controls will be tied to a specific database model and as you might expect Rails provides helpers tailored for that purpose. Consistent with other form helpers, when dealing with models you drop the <tt>_tag</tt> suffix from <tt>select_tag</tt>:</p>

<p><span style="font-family: DejaVu Sans;"><tt>在大多数情况中</tt></span><tt>form</tt><tt> </tt><tt>controls</tt><span style="font-family: DejaVu Sans;"><tt>将会被捆绑到一个指定的数据库</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>并且正如你可能期望</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>为捆绑的这个</tt></span><tt>models</tt><span style="font-family: DejaVu Sans;"><tt>提供量身定制的</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>。与其他</tt></span><tt>form</tt><tt> </tt><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>一致的，当在处理</tt></span><tt>models</tt><span style="font-family: DejaVu Sans;"><tt>的时候你从</tt></span><tt>select_tag</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>抛弃</tt></span><tt>_tag</tt><span style="font-family: DejaVu Sans;"><tt>后缀。</tt></span></p>

<h1>controller:</h1>

<p>@person = Person.new(:city_id =&gt; 2)</p>

<h1>view:</h1>

<p>&lt;%= select(:person, :city_id, [[&lsquo;Lisbon&rsquo;, 1], [&lsquo;Madrid&rsquo;, 2], &hellip;]) %&gt;</p>

<p>Notice that the third parameter, the options array, is the same kind of argument you pass to <tt>options_for_select</tt>. One advantage here is that you don’t have to worry about pre-selecting the correct city if the user already has one — Rails will do this for you by reading from the <tt>@person.city_id</tt> attribute.</p>

<p><span style="font-family: DejaVu Sans;">注意上面的第三个参数，这个选项数组，是相同的类型的参数你提供给</span><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>（注意其中的省略号，它是省略了一些选项没有写出但是实际中不能这样写哦有就全部给出）。这里的一个优势就是你不用必须担心预选择正确的城市如果用户已经有一个</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>将会通过读取</tt></span><tt>@person.city_id</tt><span style="font-family: DejaVu Sans;"><tt>属性替你这些事情。</tt></span></p>

<p><tt>As</tt><tt> </tt><tt>with</tt><tt> </tt><tt>other</tt><tt> </tt><tt>helpers,</tt><tt> </tt><tt>if</tt><tt> </tt><tt>you</tt><tt> </tt><tt>were</tt><tt> </tt><tt>to</tt><tt> </tt><tt>use</tt><tt> </tt><tt>the</tt><tt> </tt><tt>select</tt><tt> </tt><tt>helper</tt><tt> </tt><tt>on</tt><tt> </tt><tt>a</tt><tt> </tt><tt>form</tt><tt> </tt><tt>builder</tt><tt> </tt><tt>scoped</tt><tt> </tt><tt>to</tt><tt> </tt><tt>the</tt><tt> </tt><tt>@person</tt><tt> </tt><tt>object,</tt><tt> </tt><tt>the</tt><tt> </tt><tt>syntax</tt><tt> </tt><tt>would</tt><tt> </tt><tt>be:</tt></p>

<p><span style="font-family: DejaVu Sans;">如同其他</span>helpers<span style="font-family: DejaVu Sans;">，如果你打算在一个作用域为</span><tt>@person</tt><span style="font-family: DejaVu Sans;"><tt>对象的</tt></span>form builder<span style="font-family: DejaVu Sans;">使用</span>select helper<span style="font-family: DejaVu Sans;">，语句将会是：</span></p>

<h1>select on a form builder</h1>

<p>&lt;%= f.select(:city_id, &hellip;) %&gt;</p>

<p>If you are using <tt>select</tt> (or similar helpers such as <tt>collection_select</tt>, <tt>select_tag</tt>) to set a <tt>belongs_to</tt> association you <strong>must</strong><strong> </strong><strong>pass</strong><strong> </strong><strong>the</strong><strong> </strong><strong>name</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><span style="color: #800000;"><strong>foreign</strong></span><span style="color: #800000;"><strong>key</strong></span> (in the example above <tt>city_id</tt>), not the name of association itself. If you specify <tt>city</tt> instead of <tt>city_id</tt> Active Record will raise an error along the lines of <tt>ActiveRecord::AssociationTypeMismatch:</tt><tt> </tt><tt>City(#17815740)</tt><tt> </tt><tt>expected,</tt><tt> </tt><tt>got</tt><tt> </tt><tt>String(#1138750)</tt><tt> </tt>when you pass the <tt>params</tt> hash to <tt>Person.new</tt> or <tt>update_attributes</tt>. Another way of looking at this is that form helpers only edit attributes. You should also be aware of the potential<span style="font-family: DejaVu Sans;">潜在</span>security ramifications<span style="font-family: DejaVu Sans;">后果</span>of allowing users to edit foreign keys directly. You may wish to consider the use of <tt>attr_protected</tt> and <tt>attr_accessible</tt>. For further details on this, see the <a href="http://guides.rubyonrails.org/security.html#_mass_assignment"><span style="color: #000080;"><span style="text-decoration: underline;">Ruby</span></span><span style="color: #000080;"><span style="text-decoration: underline;">On</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Security</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a>.</p>

<p>you <strong>must</strong><strong> </strong><strong>pass</strong><strong> </strong><strong>the</strong><strong> </strong><strong>name</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><span style="color: #800000;"><strong>foreign</strong></span><span style="color: #800000;"><strong>key</strong></span> (in the example above <tt>city_id</tt>), not the name of association itself. <span style="font-family: DejaVu Sans;">你可以考虑使用</span><tt>attr_protected</tt> and <tt>attr_accessible</tt>.</p>

<h4><a name="option-tags-from-a-collection-of-arbitra"></a> 3.3 Option Tags from a Collection of Arbitrary Objects <span style="font-family: WenQuanYi Micro Hei;">任意集合对象的</span>Option <span style="font-family: WenQuanYi Micro Hei;">标签</span></h4>


<p>Generating options tags with <tt>options_for_select</tt> requires that you create an array containing the text and value for each option. But what if you had a City model (perhaps an Active Record one) and you wanted to generate option tags from a collection of those objects? One solution would be to make a nested array by iterating over them:</p>

<p><span style="font-family: DejaVu Sans;">通常情况下</span><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>option</tt><span style="font-family: DejaVu Sans;"><tt>标签需要你创建一个包含</tt></span><tt>text</tt><span style="font-family: DejaVu Sans;"><tt>和每个选项的的值的数组。但是如果你有一个</tt></span><tt>City</tt><tt> </tt><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>（可能是</tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>中的一个）同时你想生成这些对象集合的选项？一个解决办法是产生一个迭代所有对象的嵌套数组：</tt></span></p>

<p><tt>&lt;%</tt><tt> </tt><tt>cities_array</tt><tt> </tt><tt>=</tt><tt> </tt><tt>City.all.map</tt><tt> </tt><tt>{</tt><tt> </tt><tt>|city|</tt><tt> </tt><tt>[city.name,</tt><tt> </tt><tt>city.id]</tt><tt> </tt><tt>}</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>options_for_select(cities_array)</tt><tt> </tt><tt>%&gt;</tt></p>

<p>This is a perfectly Pairs passed to <tt>options_for_select</tt> should have the name first and the id second, however with <tt>options_from_collection_for_select</tt> the first argument is the value method and the second the text method.valid solution, but Rails provides a less verbose alternative: <tt>options_from_collection_for_select</tt>. This helper expects a collection of arbitrary objects and two additional arguments: the names of the methods to read the option <strong>value</strong> and <strong>text</strong> from, respectively<span style="font-family: DejaVu Sans;">分别</span>:</p>

<p><span style="font-family: DejaVu Sans;">这是一个完美有效的解决方法，但是</span>Rail<span style="font-family: DejaVu Sans;">提供一个更少累赘替代上面的方法：</span><tt>options_from_collection_for_select</tt>. <span style="font-family: DejaVu Sans;">这个</span>helper<span style="font-family: DejaVu Sans;">预订一个任意对象的集合和两个额外的参数：方法的</span>name<span style="font-family: DejaVu Sans;">来分别读取</span>option<span style="font-family: DejaVu Sans;">的</span>value<span style="font-family: DejaVu Sans;">和</span>text<span style="font-family: DejaVu Sans;">：</span></p>

<p>&lt;%= options_from_collection_for_select(City.all, :id, :name) %&gt;</p>

<p>As the name implies, this only generates option tags. To generate a working select box you would need to use it in conjunction with <tt>select_tag</tt>, just as you would with <tt>options_for_select</tt>. When working with model objects, just as <tt>select</tt> combines <tt>select_tag</tt> and <tt>options_for_select</tt>, <tt>collection_select</tt> combines <tt>select_tag</tt> with <tt>options_from_collection_for_select</tt>.</p>

<p><span style="font-family: DejaVu Sans;">正如其名，它仅仅生成</span>option tags<span style="font-family: DejaVu Sans;">。要生成一个能够工作的</span>select box<span style="font-family: DejaVu Sans;">你还需将其关联到</span><tt>select_tag</tt><span style="font-family: DejaVu Sans;"><tt>，就像你处理</tt><tt></tt></span><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>一样的。当在</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>对象中工作的时候，就像</tt></span><tt>select</tt><span style="font-family: DejaVu Sans;"><tt>联合</tt><tt></tt></span><tt>select_tag</tt><span style="font-family: DejaVu Sans;"><tt>与</tt></span><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>的情行，</tt><tt></tt></span><tt>collection_select</tt><span style="font-family: DejaVu Sans;"><tt>联合</tt></span><tt>select_tag</tt><span style="font-family: DejaVu Sans;"><tt>与</tt></span><tt>options_from_collection_for_select.</tt><tt><strong>#</strong></tt><span style="font-family: DejaVu Sans;"><tt><strong>这里好像说的是外键的</strong></tt></span><tt><strong>select</strong></tt><tt><strong> </strong></tt><tt><strong>boxes</strong></tt></p>

<p>&lt;%= collection_select(:person, :city_id, City.all, :id, :name) %&gt;</p>

<p>To recap, <tt>options_from_collection_for_select</tt> is to <tt>collection_select</tt> what <tt>options_for_select</tt> is to <tt>select</tt>.</p>

<p><span style="font-family: DejaVu Sans;">概括一下，</span><tt>options_from_collection_for_select</tt><span style="font-family: DejaVu Sans;"><tt>对于</tt><tt></tt></span><tt>collection_select</tt><span style="font-family: DejaVu Sans;"><tt>正如</tt><tt></tt></span><tt>options_for_select</tt><span style="font-family: DejaVu Sans;"><tt>对于</tt></span><tt>select</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>Pairs passed to <tt>options_for_select</tt> should have the<strong> </strong><strong>name</strong><strong> </strong><strong>first</strong><strong> </strong><strong>and</strong><strong> </strong><strong>the</strong><strong> </strong><strong>id</strong><strong> </strong><strong>second</strong>, however with <tt>options_from_collection_for_select</tt> the first argument is the value method and the second the text method.</p>

<h4><a name="time-zone-and-country-select"></a>3.4 Time Zone and Country Select<span style="font-family: WenQuanYi Micro Hei;">时区和国家选择</span></h4>


<p>To leverage time zone support in Rails, you have to ask your users what time zone they are in. Doing so would require generating select options from a list of pre-defined TimeZone objects using <tt>collection_select</tt>, but you can simply use the <tt>time_zone_select</tt> helper that already wraps this:</p>

<p><span style="font-family: DejaVu Sans;">在</span>Rails<span style="font-family: DejaVu Sans;">利用时区支持，你必须询问你的用户他们处在什么时区。要这样做将在使用</span><tt>collection_select</tt><span style="font-family: DejaVu Sans;"><tt>的时候</tt></span>require<span style="font-family: DejaVu Sans;">来自预先定义列表中的一个</span>TimeZome <span style="font-family: DejaVu Sans;">对象的创建</span>select<span style="font-family: DejaVu Sans;">选项，但是你可以简单的使用</span><tt>time_zone_select</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>它已经包含了这些：</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>time_zone_select(:person,</tt><tt> </tt><tt>:time_zone)</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt>There</tt><tt> </tt><tt>is</tt><tt> </tt><tt>also</tt><tt> </tt><tt>time_zone_options_for_select</tt><tt> </tt><tt>helper</tt><tt> </tt><tt>for</tt><tt> </tt><tt>a</tt><tt> </tt><tt>more</tt><tt> </tt><tt>manual</tt><tt> </tt><tt>(therefore</tt><tt> </tt><tt>more</tt><tt> </tt><tt>customizable)</tt><tt> </tt><tt>way</tt><tt> </tt><tt>of</tt><tt> </tt><tt>doing</tt><tt> </tt><tt>this.</tt><tt> </tt><tt>Read</tt><tt> </tt><tt>the</tt><tt> </tt><tt>API</tt><tt> </tt><tt>documentation</tt><tt> </tt><tt>to</tt><tt> </tt><tt>learn</tt><tt> </tt><tt>about</tt><tt> </tt><tt>the</tt><tt> </tt><tt>possible</tt><tt> </tt><tt>arguments</tt><tt> </tt><tt>for</tt><tt> </tt><tt>these</tt><tt> </tt><tt>two</tt><tt> </tt><tt>methods.</tt></p>

<p><span style="font-family: DejaVu Sans;"><tt>这里同样也有</tt><tt></tt></span><tt>also</tt><tt> </tt><tt>time_zone_options_for_select</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>来手动的做这些（因此更具定制可能）。阅读</tt></span><tt>API</tt><span style="font-family: DejaVu Sans;"><tt>文档来了解这两个方法可能的参数。</tt></span></p>

<p>Rails <em>used</em> to have a <tt>country_select</tt> helper for choosing countries, but this has been extracted to the <a href="https://github.com/chrislerum/country_select"><span style="color: #000080;"><span style="text-decoration: underline;">country_select</span></span><span style="color: #000080;"><span style="text-decoration: underline;">plugin</span></span></a>. When using this, be aware that the exclusion or inclusion of certain names from the list can be somewhat controversial (and was the reason this functionality was extracted from Rails).</p>

<p>Rails<span style="font-family: DejaVu Sans;">通常使用一个</span><tt>country_select</tt><span style="font-family: DejaVu Sans;"><tt>来选择国家，但是这是从</tt><tt></tt></span><a href="https://github.com/chrislerum/country_select"><span style="color: #000080;"><span style="text-decoration: underline;">country_select</span></span><span style="color: #000080;"><span style="text-decoration: underline;">plugin</span></span></a><span style="font-family: DejaVu Sans;"><tt>提取的。当使用这些，要知道来自</tt></span><tt>list</tt><span style="font-family: DejaVu Sans;"><tt>中排除或者列入的一些</tt></span><tt>names</tt><span style="font-family: DejaVu Sans;"><tt>可能有些争议（并且这也是这个功能从</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>中提取出来的原因）。</tt></span></p>

<h3><a name="using-date-and-time-form-helpers"></a>4 Using Date and Time Form Helpers</h3>


<p>The date and time helpers differ from all the other form helpers in two important respects:</p>

<p>date and time helpers<span style="font-family: DejaVu Sans;">与其他所有的</span>form helpers<span style="font-family: DejaVu Sans;">都不相同（着重）表现在两个重要的方面：</span></p>

<ol>
    <li>Dates and times are not representable by a single input element. Instead you have several, one for each component (year, month, day etc.) and so there is no single value in your <tt>params</tt> hash with your date or time.</li>
</ol>


<p>Dates and times<span style="font-family: DejaVu Sans;">不仅仅表现为单个</span>input element<span style="font-family: DejaVu Sans;">。对于每个组件中的一个（</span>year,month,day ect<span style="font-family: DejaVu Sans;">）取而代之你都有一些（</span>element<span style="font-family: DejaVu Sans;">）。因此在你的</span>params hash<span style="font-family: DejaVu Sans;">字典中没有你的</span>date or time<span style="font-family: DejaVu Sans;">的单个值。</span></p>

<ol start="2">
    <li>Other helpers use the <tt>_tag</tt> suffix to indicate<span style="font-family: DejaVu Sans;">说明</span>whether a helper is a barebones helper or one that operates on model objects. With dates and times, <tt>select_date</tt>, <tt>select_time</tt> and <tt>select_datetime</tt> are the barebones helpers, <tt>date_select</tt>, <tt>time_select</tt> and <tt>datetime_select</tt> are the equivalent model object helpers. <strong>#</strong><span style="font-family: DejaVu Sans;"><strong>交换了一下顺序</strong></span></li>
</ol>


<p><span style="font-family: DejaVu Sans;">其他</span>helpers<span style="font-family: DejaVu Sans;">使用</span><tt>_tag</tt><span style="font-family: DejaVu Sans;"><tt>后缀来说明一个</tt></span><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>是单纯的</tt></span><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>还是一个</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>对象的那样的操作。</tt></span></p>

<p>Both of these families of helpers will create a series of select boxes for the different components (year, month, day etc.).</p>

<p><span style="font-family: DejaVu Sans;">这些</span>helper<span style="font-family: DejaVu Sans;">的组员将会创建一系列的对应于不同的组件的</span>select boxes<span style="font-family: DejaVu Sans;">（</span>year, month, day etc.<span style="font-family: DejaVu Sans;">）。</span></p>

<h4><a name="barebones-helpers"></a>4.1 Barebones Helpers</h4>


<p>The <tt>select_*</tt> family of helpers take as their first argument an instance of Date, Time or DateTime that is used as the currently selected value. You may omit this parameter, in which case the current date is used. For example</p>

<p><span style="font-family: DejaVu Sans;"><tt>譬如</tt></span><tt>select_*</tt><tt> </tt><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>成员获取</tt></span><tt>Date</tt><span style="font-family: DejaVu Sans;"><tt>实例作为它们的第一个变量，</tt></span><tt>Time</tt><tt> </tt><tt>or</tt><tt> </tt><tt>DateTime</tt><span style="font-family: DejaVu Sans;"><tt>使用的是当前选择的值。你可能忽略这个参数，在这种情况中</tt></span><tt>current</tt><tt> </tt><tt>date</tt><span style="font-family: DejaVu Sans;"><tt>会被使用。例如</tt></span></p>

<p><code>&lt;%=</code><tt> </tt><code>select_date</code><code> </code><code>Date.today,</code><code> </code><code>:prefix</code><tt> </tt><code>=&gt;</code><code> </code><code>:start_date</code><tt> </tt><code>%&gt;</code></p>

<p><tt>outputs</tt><tt> </tt><tt>(with</tt><tt> </tt><tt>actual</tt><tt> </tt><tt>option</tt><tt> </tt><tt>values</tt><tt> </tt><tt>omitted</tt><tt> </tt><tt>for</tt><tt> </tt><tt>brevity)</tt><span style="font-family: DejaVu Sans;"><tt>为了简洁省略了实际的选项值</tt></span><tt>#</tt><span style="font-family: DejaVu Sans;"><tt>省略号应该是相应的实际的日期和时间</tt></span></p>

<p>&lt;select id=&ldquo;start_date_year&rdquo; name=&ldquo;start_date[year]&rdquo;&gt; &hellip; &lt;/select&gt;</p>

<p>&lt;select id=&ldquo;start_date_month&rdquo; name=&ldquo;start_date[month]&rdquo;&gt; &hellip; &lt;/select&gt;</p>

<p>&lt;select id=&ldquo;start_date_day&rdquo; name=&ldquo;start_date[day]&rdquo;&gt; &hellip; &lt;/select&gt;</p>

<p>The above inputs would result in <tt>params[:start_date]</tt> being a hash with keys <tt>:year</tt>, <tt>:month</tt>, <tt>:day</tt>. To get an actual Time or Date object you would have to extract these values and pass them to the appropriate constructor, for example</p>

<p><span style="font-family: DejaVu Sans;">完整的输入结果将会在</span><tt>params[:start_date]</tt><span style="font-family: DejaVu Sans;"><tt>他会是一个关键字是</tt></span><tt>:year,</tt><tt> </tt><tt>:month,</tt><tt> </tt><tt>:day</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典。要得到一个实际的</tt></span><tt>Time</tt><tt> </tt><tt>or</tt><tt> </tt><tt>Date</tt><span style="font-family: DejaVu Sans;"><tt>对象你将不得不提取这些值并且转换他们为适合的结构，例如：</tt></span></p>

<p><tt>Date.civil(params[:start_date][:year].to_i,</tt><tt> </tt><tt>params[:start_date][:month].to_i,</tt><tt> </tt><tt>params[:start_date][:day].to_i)</tt></p>

<p>The <tt>:prefix</tt> option is the key used to retrieve the hash of date components from the <tt>params</tt> hash. Here it was set to <tt>start_date</tt>, if omitted it will default to <tt>date</tt>.</p>

<p><tt>:prefix</tt><span style="font-family: DejaVu Sans;"><tt>选项是用来接收来自</tt></span><tt>params</tt><tt> </tt><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>形式的</tt></span><tt>date</tt><span style="font-family: DejaVu Sans;"><tt>组件的关键。这里它被设置为</tt><tt></tt></span><tt>start_date</tt><span style="font-family: DejaVu Sans;"><tt>，如果省略形式的话默认是</tt></span><tt>date</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="select-model-object-helpers"></a><tt>4.2</tt><tt> </tt><tt>Model</tt><tt> </tt><tt>Object</tt><tt> </tt><tt>Helpers</tt></h4>


<p><tt>select_date</tt> does not work well with forms that update or create Active Record objects as Active Record expects<span style="font-family: DejaVu Sans;">预计</span>each element of the <tt>params</tt> hash to correspond to one attribute. The model object helpers for dates and times submit parameters with special names, when Active Record sees parameters with such names it knows they must be combined with the other parameters and given to a constructor appropriate to the column type. For example:</p>

<p><tt>select_date</tt><span style="font-family: DejaVu Sans;"><tt>（这个是单纯的</tt></span><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>）在</tt></span><tt>update</tt><tt> </tt><tt>or</tt><tt> </tt><tt>create</tt><tt> </tt><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>对象的时候</tt>预置每个</span>params hash<span style="font-family: DejaVu Sans;">字典的</span>element<span style="font-family: DejaVu Sans;">对应到一个属性不会很好的工作。</span>Dates and times <span style="font-family: DejaVu Sans;">的</span>model object helpers<span style="font-family: DejaVu Sans;">提交参数通过指定的</span>names<span style="font-family: DejaVu Sans;">，当</span>Active Record<span style="font-family: DejaVu Sans;">发现这些参数时，它知道它们必须结合其他参数以及每一列（属性</span>year, month, day etc.<span style="font-family: DejaVu Sans;">）被给予一个合适的结构。例如：</span></p>

<p>&lt;%= date_select :person, :birth_date %&gt;</p>

<p>outputs (with actual option values omitted for brevity)<span style="font-family: DejaVu Sans;">将实际的</span>option<span style="font-family: DejaVu Sans;">的</span>values<span style="font-family: DejaVu Sans;">忽略以精简</span></p>

<p>&lt;select id=&ldquo;person_birth_date_1i&rdquo; name=&ldquo;person[birth_date(1i)]&rdquo;&gt; &hellip; &lt;/select&gt;</p>

<p>&lt;select id=&ldquo;person_birth_date_2i&rdquo; name=&ldquo;person[birth_date(2i)]&rdquo;&gt; &hellip; &lt;/select&gt;</p>

<p>&lt;select id=&ldquo;person_birth_date_3i&rdquo; name=&ldquo;person[birth_date(3i)]&rdquo;&gt; &hellip; &lt;/select&gt;</p>

<p>which results in a <tt>params</tt> hash like</p>

<p>{:person =&gt; {&lsquo;birth_date(1i)&rsquo; =&gt; &lsquo;2008&rsquo;, &lsquo;birth_date(2i)&rsquo; =&gt; &lsquo;11&rsquo;, &lsquo;birth_date(3i)&rsquo; =&gt; &lsquo;22&rsquo;}}</p>

<p>When this is passed to <tt>Person.new</tt> (or <tt>update_attributes</tt>), Active Record spots that these parameters should all be used to construct the <tt>birth_date</tt> attribute and uses the suffixed information to determine in which order it should pass these parameters to functions such as <tt>Date.civil</tt>.</p>

<p><span style="font-family: DejaVu Sans;">当这些信息提交给</span>Person.new<span style="font-family: DejaVu Sans;">（</span><tt>update_attributes</tt><span style="font-family: DejaVu Sans;">），</span>Active Record<span style="font-family: DejaVu Sans;">指出所有的这些参数应该使用于</span><tt>birth_date</tt><tt> </tt><tt>attribute</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>结构并且使用后缀声明使得它能够传递这些参数给功能（方法）例如</tt><tt></tt></span><tt>Date.civil</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h4><a name="common-options"></a>4.3 Common Options</h4>


<p>Both families of helpers use the same core set of functions to generate the individual select tags and so both accept largely the same options. In particular, by default Rails will generate year options 5 years either side of the current year. If this is not an appropriate range, the <tt>:start_year</tt> and <tt>:end_year</tt> options override this. For an exhaustive list of the available options, refer to the <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/DateHelper.html"><span style="color: #000080;"><span style="text-decoration: underline;">API</span></span><span style="color: #000080;"><span style="text-decoration: underline;">documentation</span></span></a>.</p>

<p>helpers<span style="font-family: DejaVu Sans;">的所有成员都使用相同的</span>core set of functions<span style="font-family: DejaVu Sans;">来构建个体的</span>select <span style="font-family: DejaVu Sans;">标签因此同样能够接收大量相同的</span>options<span style="font-family: DejaVu Sans;">。以其一为例，默认情况下</span>year options<span style="font-family: DejaVu Sans;">中</span>Rails<span style="font-family: DejaVu Sans;">将会创建在当前年份的上和下</span>5<span style="font-family: DejaVu Sans;">年。如果这不是一个合适的范围，</span><tt>:start_year</tt> and <tt>:end_year</tt><span style="font-family: DejaVu Sans;"><tt>选项将会覆盖默认的范围。要得到可用选项的全面的列表，参考</tt><tt></tt></span><a href="http://api.rubyonrails.org/classes/ActionView/Helpers/DateHelper.html"><span style="color: #000080;"><span style="text-decoration: underline;">API</span></span><span style="color: #000080;"><span style="text-decoration: underline;">documentation</span></span></a><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>As a rule of thumb you should be using <tt>date_select</tt> when working with model objects and <tt>select_date</tt> in other cases, such as a search form which filters results by date.</p>

<p><span style="font-family: DejaVu Sans;">一个规则指引你在处理</span>model objects<span style="font-family: DejaVu Sans;">的时候使用</span>date_select<span style="font-family: DejaVu Sans;">在其他情况的时候使用</span>select_date<span style="font-family: DejaVu Sans;">，比如一个</span>search form<span style="font-family: DejaVu Sans;">它过滤日期作获取结果。</span></p>

<p>In many cases the built-in date pickers are clumsy as they do not aid the user in working out the relationship between the date and the day of the week.</p>

<p><span style="font-family: DejaVu Sans;">在许多情况下，内置的日期选择器是笨拙的，因为他们对计算出日期和工作日关系的用户没有援助。</span></p>

<h4><a name="individual-components"></a>4.4 Individual Components<span style="font-family: WenQuanYi Micro Hei;">个体组件</span></h4>


<p>Occasionally you need to display just a single date component such as a year or a month. Rails provides a series of helpers for this, one for each component <tt>select_year</tt>, <tt>select_month</tt>, <tt>select_day</tt>, <tt>select_hour</tt>, <tt>select_minute</tt>, <tt>select_second</tt>. These helpers are fairly straightforward. By default they will generate an input field named after the time component (for example “year” for <tt>select_year</tt>, “month” for <tt>select_month</tt> etc.) although this can be overridden with the <tt>:field_name</tt> option. The <tt>:prefix</tt> option works in the same way that it does for <tt>select_date</tt> and <tt>select_time</tt> and has the same default value.</p>

<p><span style="font-family: DejaVu Sans;">偶然情况下你需要仅仅显示单个日期组件如</span>year or month<span style="font-family: DejaVu Sans;">。</span>Rails<span style="font-family: DejaVu Sans;">提供一些</span>helpers<span style="font-family: DejaVu Sans;">来做这些，给每一个组件</span><tt>select_year</tt>, <tt>select_month</tt>, <tt>select_day</tt>, <tt>select_hour</tt>, <tt>select_minute</tt>, <tt>select_second</tt><span style="font-family: DejaVu Sans;">。这些</span>helpers<span style="font-family: DejaVu Sans;">相当的简单。默认情况下他们将会创建一个</span>input field<span style="font-family: DejaVu Sans;">并以时间组件命名（例如<span style="font-family: Liberation Serif,Times New Roman,serif;"> “</span></span>year” for <tt>select_year</tt>, “month” for <tt>select_month</tt> etc.<span style="font-family: DejaVu Sans;">）即使这会覆盖</span><tt>:field_name</tt><span style="font-family: DejaVu Sans;"><tt>选项。</tt></span><tt>:prefix</tt><span style="font-family: DejaVu Sans;"><tt>以一样的方式工作，对于</tt></span><tt>select_date</tt><tt> </tt><tt>and</tt><tt> </tt><tt>select_time</tt><span style="font-family: DejaVu Sans;"><tt>会设置同样的默认值。</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>select_year(2011)</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>select_year(Time.now)</tt><tt> </tt><tt>%&gt;</tt></p>

<p>will produce the same output if the current year is 2011 and the value chosen by the user can be retrieved by <tt>params[:date][:year]</tt>.</p>

<h3><a name="uploading-files"></a>5 Uploading Files</h3>


<p>A common task is uploading some sort of file, whether it’s a picture of a person or a CSV file containing data to process. The most important thing to remember with file uploads is that the rendered form’s encoding <strong>MUST</strong> be set to “multipart/form-data”. If you use <tt>form_for</tt>, this is done automatically. If you use <tt>form_tag</tt>, you must set it yourself, as per the following example.</p>

<p>The following two forms both upload a file.</p>

<p><span style="font-family: DejaVu Sans;">一个常用的任务是上传一些种类的文件，无论在上传进程中的是一个个人图片还是一个包含数据</span>CSV<span style="font-family: DejaVu Sans;">文件。文件上传中重点要注意的事情是</span>rendered <span style="font-family: DejaVu Sans;">表单的编码<span style="color: #800000;"><strong>必须被设置成</strong></span>是<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>multipart/form-data”. <span style="font-family: DejaVu Sans;">如果你使用的</span><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>，这将被自动完成。如果你使用</tt><tt></tt></span><tt>form_tag</tt><span style="font-family: DejaVu Sans;"><tt>，你必须自己设置它，在随后的每个例子中。后面的两个表单都是上传一个文件。</tt></span></p>

<p>&nbsp;</p>

<p>&lt;%= form_tag({:action =&gt; :upload}, :multipart =&gt; true) do %&gt;</p>

<p>&lt;%= file_field_tag &lsquo;picture&rsquo; %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= form_for @person do |f| %&gt;</p>

<p>&lt;%= f.file_field :picture %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>Since Rails 3.1, forms rendered using <tt>form_for</tt> have their encoding set to <tt>multipart/form-data</tt> automatically once a <tt>file_field</tt> is used inside the block. Previous versions required you to set this explicitly.</p>

<p><span style="font-family: DejaVu Sans;">从</span>Rails3.1,form<span style="font-family: DejaVu Sans;">使用</span>form_for<span style="font-family: DejaVu Sans;">来</span>render<span style="font-family: DejaVu Sans;">一旦在</span>block<span style="font-family: DejaVu Sans;">中有一个</span><tt>file_field</tt><span style="font-family: DejaVu Sans;"><tt>被使用编码自动设置为</tt><tt></tt></span><tt>multipart/form-data</tt><span style="font-family: DejaVu Sans;"><tt>。以前的版本需要你准确的设置为这样的编码。</tt></span></p>

<p>Rails provides the usual pair of helpers: the barebones <tt>file_field_tag</tt> and the model oriented <tt>file_field</tt>. The only difference with other helpers is that you cannot set a default value for file inputs as this would have no meaning. As you would expect in the first case the uploaded file is in <tt>params[:picture]</tt> and in the second case in<tt> </tt><tt>params[:person][:picture]</tt>.</p>

<p>R<span style="font-family: DejaVu Sans;">爱丽丝提供通常配对的</span>helpers<span style="font-family: DejaVu Sans;">：单个的</span><tt>file_field_tag</tt><span style="font-family: DejaVu Sans;"><tt>和面向</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>的</tt><tt></tt></span><tt>file_field</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><span style="font-family: DejaVu Sans;">这与其他的</span>helpers<span style="font-family: DejaVu Sans;">的不同是你不能为</span>file inputs<span style="font-family: DejaVu Sans;">设置一个不同的值因为这样没有意义。正如你所期望的第一种情况上传的文件在</span><tt>params[:picture]</tt><span style="font-family: DejaVu Sans;"><tt>，第二种情况在</tt><tt></tt></span><tt>params[:person][:picture]</tt><span style="font-family: DejaVu Sans;"><tt>中。</tt></span></p>

<h4><a name="what-gets-uploaded"></a>5.1 What Gets Uploaded</h4>


<p>The object in the <tt>params</tt> hash is an instance of a subclass of IO. Depending on the size of the uploaded file it may in fact be a StringIO or an instance of File backed by a temporary file. In both cases the object will have an <tt>original_filename</tt> attribute containing the name the file had on the user’s computer and a <tt>content_type</tt> attribute containing the MIME type of the uploaded file. The following snippet saves the uploaded content in <tt>#{Rails.root}/public/uploads</tt> under the same name as the original file (assuming the form was the one in the previous example).</p>

<p><span style="font-family: DejaVu Sans;">在</span>params hash<span style="font-family: DejaVu Sans;">中的对象是</span>IO<span style="font-family: DejaVu Sans;">子类的一个实例。取决于上传文件的大小它可能实际上是一个</span>StringIO<span style="font-family: DejaVu Sans;">或者临时文件的备份文件。在这两个情况中对象将会有一个</span><tt>original_filename</tt><span style="font-family: DejaVu Sans;"><tt>属性包含文件在用户电脑上的名字以及一个</tt><tt></tt></span><tt>content_type</tt><span style="font-family: DejaVu Sans;"><tt>属性包含上传文件的</tt></span><tt>MIME</tt><span style="font-family: DejaVu Sans;"><tt>形式。随后的阶段保存上传的内容在</tt></span><tt>#{Rails.root}/public/uploads</tt><span style="font-family: DejaVu Sans;"><tt>并以与原始名字相同（假设</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>是一个预先的例子则下面是其控制函数）</tt></span></p>

<p>def upload</p>

<p>uploaded_io = params[:person][:picture]</p>

<p>File.open(Rails.root.join(&lsquo;public&rsquo;, &lsquo;uploads&rsquo;, uploaded_io.original_filename), &lsquo;w&rsquo;) do |file|</p>

<p>file.write(uploaded_io.read)</p>

<p>end</p>

<p>end</p>

<p>Once a file has been uploaded, there are a multitude of potential<span style="font-family: DejaVu Sans;">潜在</span>tasks, ranging from where to store the files (on disk, Amazon S3, etc) and associating them with models to resizing image files and generating thumbnails. The intricacies of this are beyond the scope of this guide, but there are several libraries designed to assist with these. Two of the better known ones are <span style="color: #000080;"><span style="text-decoration: underline;"><a href="https://github.com/jnicklas/carrierwave">CarrierWave</a></span></span> and <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://www.thoughtbot.com/projects/paperclip">Paperclip</a></span></span>.</p>

<p><span style="font-family: DejaVu Sans;">一旦一个文件被上传，这里有多个潜在的任务，响应在哪里存放文件</span>(on disk, Amazon S3, etc) <span style="font-family: DejaVu Sans;">并且关联它们至</span>models<span style="font-family: DejaVu Sans;">为重设大小的图片文件同时创建缩略图。这里的复杂远超这个</span>guide<span style="font-family: DejaVu Sans;">的范围，但是这里有一些库被设计来分派这些。有两个较好的库</span>ones are <span style="color: #000080;"><span style="text-decoration: underline;"><a href="https://github.com/jnicklas/carrierwave">CarrierWave</a></span></span> and <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://www.thoughtbot.com/projects/paperclip">Paperclip</a></span></span><span style="font-family: DejaVu Sans;">。</span></p>

<p><span style="color: #800000;"><strong>If</strong></span><span style="color: #800000;"><strong>the</strong></span><span style="color: #800000;"><strong>user</strong></span><span style="color: #800000;"><strong>has</strong></span><span style="color: #800000;"><strong>not</strong></span><span style="color: #800000;"><strong>selected</strong></span><span style="color: #800000;"><strong>a</strong></span><span style="color: #800000;"><strong>file</strong></span><span style="color: #800000;"><strong>the</strong></span><span style="color: #800000;"><strong>corresponding</strong></span><span style="color: #800000;"><strong>parameter</strong></span><span style="color: #800000;"><strong>will</strong></span><span style="color: #800000;"><strong>be</strong></span><span style="color: #800000;"><strong>an</strong></span><span style="color: #800000;"><strong>empty</strong></span><span style="color: #800000;"><strong>string.</strong></span></p>

<h4><a name="dealing-with-ajax"></a>5.2 Dealing with Ajax<span style="font-family: WenQuanYi Micro Hei;">处理</span>Ajax</h4>


<p>Unlike other forms making an asynchronous file upload form is not as simple as providing <tt>form_for</tt> with <tt>:remote</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>. With an Ajax form the serialization is done by JavaScript running inside the browser and since JavaScript cannot read files from your hard drive the file cannot be uploaded. The most common workaround is to use an invisible iframe that serves as the target for the form submission.</p>

<p><span style="font-family: DejaVu Sans;">与其他</span>forms<span style="font-family: DejaVu Sans;">不同制作一个异步文件上传表单不能简单的提供</span><tt>form_for</tt> with <tt>:remote</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>.<span style="font-family: DejaVu Sans;">一个</span>Ajax<span style="font-family: DejaVu Sans;">表单这个序列被在浏览器内部运行的</span>JavaScript<span style="font-family: DejaVu Sans;">完成同时因为</span>JavaScript<span style="font-family: DejaVu Sans;">不能从你的硬盘中读取文件这个文件就不能上传。最常见的解决方法是使用一种无形的</span>iframe<span style="font-family: DejaVu Sans;">服务于目标</span>forms<span style="font-family: DejaVu Sans;">的提交。</span></p>

<h3><a name="customizing-form-builders"></a>6 Customizing Form Builders</h3>


<p>As mentioned previously the object yielded by <tt>form_for</tt> and <tt>fields_for</tt> is an instance of FormBuilder (or a subclass thereof). Form builders encapsulate the notion of displaying form elements for a single object. While you can of course write helpers for your forms in the usual way you can also subclass FormBuilder and add the helpers there. For example</p>

<p><span style="font-family: DejaVu Sans;">正如开始提到的<tt></tt></span><tt>object</tt><tt> </tt><tt>yielded</tt><tt> </tt><tt>by</tt><tt> </tt><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>以及是</tt></span><tt>FormBuilder</tt><span style="font-family: DejaVu Sans;"><tt>的实例（或者其中的子类的实例）。</tt></span><tt>Form</tt><tt> </tt><tt>builders</tt><span style="font-family: DejaVu Sans;"><tt>封装表单元素的显示</tt></span><tt>notion</tt><span style="font-family: DejaVu Sans;"><tt>为一个单独的对象。然而你当然你也可以为你的</tt></span><tt>form</tt><span style="font-family: DejaVu Sans;"><tt>编写</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>通常的方式你可以通过（编写）</tt></span><tt>FormBuilder</tt><span style="font-family: DejaVu Sans;"><tt>的子类并且在这里添加</tt></span><tt>helpers</tt><span style="font-family: DejaVu Sans;"><tt>。例如：</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>form_for</tt><tt> </tt><tt>@person</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|f|</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>text_field_with_label</tt><tt> </tt><tt>f,</tt><tt> </tt><tt>:first_name</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt>&lt;%</tt><tt> </tt><tt>end</tt><tt> </tt><tt>%&gt;</tt></p>

<p><span style="font-family: DejaVu Sans;"><tt>可以替换为：</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>form_for</tt><tt> </tt><tt>@person,</tt><tt> </tt><tt>:builder</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>LabellingFormBuilder</tt><tt> </tt><tt>do</tt><tt> </tt><tt>|f|</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt> </tt><tt>&lt;%=</tt><tt> </tt><tt>f.text_field</tt><tt> </tt><tt>:first_name</tt><tt> </tt><tt>%&gt;</tt></p>

<p><tt>&lt;%</tt><tt> </tt><tt>end</tt><tt> </tt><tt>%&gt;</tt></p>

<p>by defining a LabellingFormBuilder class similar to the following:</p>

<p><span style="font-family: DejaVu Sans;">通过定义一个</span>LabellingFormBuilder<span style="font-family: DejaVu Sans;">类与接下来的类似：</span></p>

<p>class LabellingFormBuilder &lt; ActionView::Helpers::FormBuilder</p>

<p>def text_field(attribute, options={})</p>

<p>label(attribute) + super</p>

<p>end</p>

<p>end</p>

<p>If you reuse this frequently you could define a <tt>labeled_form_for</tt> helper that automatically applies the <tt>:builder</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>LabellingFormBuilder</tt> option.</p>

<p><span style="font-family: DejaVu Sans;">如果你拒绝这样频繁的操作你可以定义一个</span><tt>labeled_form_for</tt><span style="font-family: DejaVu Sans;"><tt>它会自动的应用</tt></span><tt>:builder</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>LabellingFormBuilder</tt><span style="font-family: DejaVu Sans;"><tt>选项。</tt></span></p>

<p><tt>The</tt><tt> </tt><tt>form</tt><tt> </tt><tt>builder</tt><tt> </tt><tt>used</tt><tt> </tt><tt>also</tt><tt> </tt><tt>determines</tt><tt> </tt><tt>what</tt><tt> </tt><tt>happens</tt><tt> </tt><tt>when</tt><tt> </tt><tt>you</tt><tt> </tt><tt>do</tt></p>

<p>form builer<span style="font-family: DejaVu Sans;">的使用也决定了在你操作的时候将会发生什么</span></p>

<p>&lt;%= render :partial =&gt; f %&gt;</p>

<p>If <tt>f</tt> is an instance of FormBuilder then this will render the <tt>form</tt> partial, setting the partial’s object to the form builder. If the form builder is of class LabellingFormBuilder then the <tt>labelling_form</tt> partial would be rendered instead.</p>

<p><span style="font-family: DejaVu Sans;">如果</span>f<span style="font-family: DejaVu Sans;">是</span>FormBuilder<span style="font-family: DejaVu Sans;">的一个实例那么这里将会局部的</span>render<span style="font-family: DejaVu Sans;">表单，为</span>form buider<span style="font-family: DejaVu Sans;">设置</span>partial’s<span style="font-family: DejaVu Sans;">对象。如果</span>form builder<span style="font-family: DejaVu Sans;">是</span>LabellingFormBuilder<span style="font-family: DejaVu Sans;">那么在</span>render<span style="font-family: DejaVu Sans;">中</span><tt>labelling_form</tt><span style="font-family: DejaVu Sans;"><tt>将会替代</tt></span><tt>f</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h3><a name="understanding-parameter-naming-conventio"></a> 7 Understanding Parameter Naming Conventions<span style="font-family: WenQuanYi Micro Hei;">明白参数公约</span></h3>


<p>As you’ve seen in the previous sections, values from forms can be at the top level of the <tt>params</tt> hash or nested in another hash. For example in a standard <tt>create</tt> action for a Person model, <tt>params[:model]</tt> would usually be a hash of all the attributes for the person to create. The <tt>params</tt> hash can also contain arrays, arrays of hashes and so on.</p>

<p><span style="font-family: DejaVu Sans;">正如你在（本节</span>guide<span style="font-family: DejaVu Sans;">）前面部分看到的，来至</span>forms<span style="font-family: DejaVu Sans;">的值将会在顶级的</span>parmas hash<span style="font-family: DejaVu Sans;">字典内或者是嵌套在另一个</span>hash<span style="font-family: DejaVu Sans;">子典中。例如在</span>Person model<span style="font-family: DejaVu Sans;">的一个标准的</span>create action<span style="font-family: DejaVu Sans;">中，</span><tt>params[:model]</tt><span style="font-family: DejaVu Sans;"><tt>通常将会有一个含有创建的</tt></span><tt>person</tt><span style="font-family: DejaVu Sans;"><tt>的所有属性的字典。</tt></span><tt>params</tt><span style="font-family: DejaVu Sans;"><tt>字典也可以包含数组，由</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典组成的数组等等。</tt></span></p>

<p>Fundamentally HTML forms don’t know about any sort of structured data, all they generate is name–value pairs, where pairs are just plain strings. The arrays and hashes you see in your application are the result of some parameter naming conventions that Rails uses.</p>

<p><span style="font-family: DejaVu Sans;">归根结底</span>HTML forms<span style="font-family: DejaVu Sans;">并不知道关于数据结构的任何类型，它们生成的所有仅是</span>name-value<span style="font-family: DejaVu Sans;">对，这些（</span>name-value<span style="font-family: DejaVu Sans;">）仅仅是纯</span>string<span style="font-family: DejaVu Sans;">。你在应用程序中看到的数组和</span>hash<span style="font-family: DejaVu Sans;">字典是一些在</span>Rails<span style="font-family: DejaVu Sans;">使用的参数命名公约的结果。</span></p>

<p>You may find you can try out examples in this section faster by using the console to directly invoke Rails’ parameter parser. For example,</p>

<p><span style="font-family: DejaVu Sans;">你会发现你可以快速的尝试这部分的例子通过使用</span>console<span style="font-family: DejaVu Sans;">来直接的调用</span>Rails&rsquo;s parameter <span style="font-family: DejaVu Sans;">解析器。例如，</span></p>

<p>ActionController::UrlEncodedPairParser.parse_query_parameters &ldquo;name=fred&amp;phone=0123456789&rdquo;</p>

<h1>=&gt; {&ldquo;name&rdquo;=&gt;&ldquo;fred&rdquo;, &ldquo;phone&rdquo;=&gt;&ldquo;0123456789&rdquo;}</h1>

<h4><a name="basic-structures"></a>7.1 Basic Structures<span style="font-family: WenQuanYi Micro Hei;">基础的</span>strcutures</h4>


<p>The two basic structures are arrays and hashes. Hashes mirror the syntax used for accessing the value in <tt>params</tt>. For example if a form contains</p>

<p><span style="font-family: DejaVu Sans;">两个根本的结构是</span>arrays<span style="font-family: DejaVu Sans;">和</span>hash<span style="font-family: DejaVu Sans;">字典。</span>Hash<span style="font-family: DejaVu Sans;">字典镜像这种语法用来访问</span>params<span style="font-family: DejaVu Sans;">的值。例如如果一个</span>form<span style="font-family: DejaVu Sans;">中包含</span></p>

<p>&lt;input id=&ldquo;person_name&rdquo; name=&ldquo;person[name]&rdquo; type=&ldquo;text&rdquo; value=&ldquo;Henry&rdquo;/&gt;</p>

<p>the <tt>params</tt> hash will contain</p>

<p>{&lsquo;person&rsquo; =&gt; {&lsquo;name&rsquo; =&gt; &lsquo;Henry&rsquo;}}</p>

<p>and <tt>params[:person][:name]</tt> will retrieve the submitted value in the controller.</p>

<p><span style="font-family: DejaVu Sans;">同时</span><tt>params[:person][:name]</tt><span style="font-family: DejaVu Sans;"><tt>将会在</tt></span><tt>controller</tt><span style="font-family: DejaVu Sans;"><tt>中接收提交的</tt></span><tt>value</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>Hashes can be nested as many levels as required, for example</p>

<p><span style="font-family: DejaVu Sans;">如果需要</span>hash<span style="font-family: DejaVu Sans;">字典可以嵌套多层，例如</span></p>

<p>&lt;input id=&ldquo;person_address_city&rdquo; name=&ldquo;person[address][city]&rdquo; type=&ldquo;text&rdquo; value=&ldquo;New York&rdquo;/&gt;</p>

<p>will result in the <tt>params</tt> hash being<span style="font-family: DejaVu Sans;">将会在</span>params hash<span style="font-family: DejaVu Sans;">字典中返回</span></p>

<p>{&lsquo;person&rsquo; =&gt; {&lsquo;address&rsquo; =&gt; {&lsquo;city&rsquo; =&gt; &lsquo;New York&rsquo;}}}</p>

<p>Normally Rails ignores duplicate parameter names. If the parameter name contains an empty set of square brackets [] then they will be accumulated in an array. If you wanted people to be able to input multiple phone numbers, you could place this in the form:</p>

<p><span style="font-family: DejaVu Sans;">正常情况下</span>Rails<span style="font-family: DejaVu Sans;">忽略重复参数名称。如果参数名包含一个空的</span>[]<span style="font-family: DejaVu Sans;">那么它们会在一个数组中累积。如果你想</span>people<span style="font-family: DejaVu Sans;">能够输入多个电话号码，你可以将这里放入</span>form<span style="font-family: DejaVu Sans;">中：</span></p>

<p>&lt;input name=&ldquo;person[phone_number][]&rdquo; type=&ldquo;text&rdquo;/&gt;</p>

<p>&lt;input name=&ldquo;person[phone_number][]&rdquo; type=&ldquo;text&rdquo;/&gt;</p>

<p>&lt;input name=&ldquo;person[phone_number][]&rdquo; type=&ldquo;text&rdquo;/&gt;</p>

<p><strong>This would result in </strong><tt><strong>params[:person][:phone_number]</strong></tt><strong> being an array.</strong></p>

<h4><a name="combining-them"></a>7.2 Combining Them<span style="font-family: WenQuanYi Micro Hei;">联合它们</span></h4>


<p>We can mix and match these two concepts. For example, one element of a hash might be an array as in the previous example, or you can have an array of hashes. For example a form might let you create any number of addresses by repeating the following form fragment</p>

<p><span style="font-family: DejaVu Sans;">我们可以总结出两个概念。例如，一个</span>element<span style="font-family: DejaVu Sans;">的</span>hash<span style="font-family: DejaVu Sans;">键值可能是作为一个先前例子的</span>hash<span style="font-family: DejaVu Sans;">键值的数组，或者你也可以有一个</span>hash<span style="font-family: DejaVu Sans;">字典的数组。例如一个</span>form<span style="font-family: DejaVu Sans;">可以让你创建任何数量的地址通过重复随后的</span>form <span style="font-family: DejaVu Sans;">片段</span></p>

<p>&lt;input name=&ldquo;addresses[][line1]&rdquo; type=&ldquo;text&rdquo;/&gt;</p>

<p>&lt;input name=&ldquo;addresses[][line2]&rdquo; type=&ldquo;text&rdquo;/&gt;</p>

<p>&lt;input name=&ldquo;addresses[][city]&rdquo; type=&ldquo;text&rdquo;/&gt;</p>

<p>This would result in <tt>params[:addresses]</tt> being an array of hashes with keys <tt>line1</tt>, <tt>line2</tt> and <tt>city</tt>. Rails decides to start accumulating values in a new hash whenever it encounters an input name that already exists in the current hash.</p>

<p><span style="font-family: DejaVu Sans;">这里返回的结果在</span><tt>params[:addresses]</tt><span style="font-family: DejaVu Sans;"><tt>中，是一个</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典组成的数组其中</tt></span><tt>keys</tt><span style="font-family: DejaVu Sans;"><tt>是</tt></span><tt>line1,line2</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>city</tt><span style="font-family: DejaVu Sans;"><tt>。 </tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>决定开始在一个新的</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>中积累值不管它是不是遇到一个已经在当前的</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>已经存在的</tt></span><tt>input name</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>There’s a restriction, however, while hashes can be nested arbitrarily, only one level of “arrayness” is allowed. Arrays can be usually replaced by hashes, for example instead of having an array of model objects one can have a hash of model objects keyed by their id, an array index or some other parameter.</tt></p>

<p><span style="font-family: DejaVu Sans;">这是一个限制，然而，即使</span>hashes<span style="font-family: DejaVu Sans;">能够嵌套任意层，只有一级的<tt>“</tt></span><tt>arrayness”</tt><span style="font-family: DejaVu Sans;"><tt>是被允许的。数组通常可以替换</tt></span><tt>hashes</tt><span style="font-family: DejaVu Sans;"><tt>字典，例如作为替代，一个数组的</tt></span><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>对象可以键入它们的</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>，一个</tt></span><tt>array index</tt><span style="font-family: DejaVu Sans;"><tt>或者一些其他参数。</tt></span></p>

<p>Array parameters do not play well with the <tt>check_box</tt> helper. According to the HTML specification unchecked checkboxes submit no value. However it is often convenient for a checkbox to always submit a value. The <tt>check_box</tt> helper fakes this by creating an auxiliary hidden input with the same name. If the checkbox is unchecked only the hidden input is submitted and if it is checked then both are submitted but the value submitted by the checkbox takes precedence. When working with array parameters this duplicate submission will confuse Rails since duplicate input names are how it decides when to start a new array element. It is preferable to either use <tt> </tt><tt>check_box_tag</tt> or to use hashes instead of arrays.</p>

<p><span style="font-family: DejaVu Sans;">数组参数在</span>check_box helper<span style="font-family: DejaVu Sans;">中不能得到很好的效果。根据</span>HTML<span style="font-family: DejaVu Sans;">规范的</span>unchecked checkboxes<span style="font-family: DejaVu Sans;">提交空值。无论如何一个</span>checkbox<span style="font-family: DejaVu Sans;">提交一个值通常非常方便。</span>check_box helper <span style="font-family: DejaVu Sans;">假想这种情况来创建具有相同</span>name<span style="font-family: DejaVu Sans;">一个辅助的隐藏</span>input<span style="font-family: DejaVu Sans;">。如果</span>checkbox<span style="font-family: DejaVu Sans;">是</span>unchecked<span style="font-family: DejaVu Sans;">那么只有</span>hidden input<span style="font-family: DejaVu Sans;">被提交如果它是</span>check<span style="font-family: DejaVu Sans;">那么两个都会提交但是</span>checkbox<span style="font-family: DejaVu Sans;">优先提交</span>value.<span style="font-family: DejaVu Sans;">当（</span>Rails<span style="font-family: DejaVu Sans;">）工作到有这两个重复提交的参数数组</span>rails<span style="font-family: DejaVu Sans;">将会产生混淆，因为重复 </span>input name<span style="font-family: DejaVu Sans;">会开始一个新的数组元素。这里使用 </span><tt>check_box_tag</tt><span style="font-family: DejaVu Sans;"><tt>或者使用</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>替代</tt></span><tt>array</tt><span style="font-family: DejaVu Sans;"><tt>都是可取的。</tt></span></p>

<h4><a name="using-form-helpers"></a>7.3 Using Form Helpers</h4>


<p>The previous sections did not use the Rails form helpers at all. While you can craft the input names yourself and pass them directly to helpers such as <tt>text_field_tag</tt> Rails also provides higher level support. The two tools at your disposal here are the name parameter to <tt>form_for</tt> and <tt>fields_for</tt> and the <tt>:index</tt> option that helpers take.</p>

<p><span style="font-family: DejaVu Sans;">前面的部分根本没有使用</span>Rails form helpers<span style="font-family: DejaVu Sans;">。然而你可以自己加工</span>input name<span style="font-family: DejaVu Sans;">并且直接传输他们给</span>helpers<span style="font-family: DejaVu Sans;">例如 </span><tt>text_field_tag Rails</tt><span style="font-family: DejaVu Sans;"><tt>也提供更高级别的支持。有两个工具供你差遣它们是获取</tt></span><tt>:name</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>form_for</tt><span style="font-family: DejaVu Sans;"><tt>和获取</tt></span><tt>:index</tt><span style="font-family: DejaVu Sans;"><tt>选项的</tt></span><tt>fields_for helpers</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>You might want to render a form with a set of edit fields for each of a person’s addresses. For example:</p>

<p><span style="font-family: DejaVu Sans;">你可能想</span>render<span style="font-family: DejaVu Sans;">一个</span>person&rsquo;s addresses form<span style="font-family: DejaVu Sans;">并且对</span>person&rsquo;s each addresses<span style="font-family: DejaVu Sans;">使用一样的</span>edit fields<span style="font-family: DejaVu Sans;">。</span></p>

<p>&lt;%= form_for @person do |person_form| %&gt;</p>

<p>&lt;%= person_form.text_field :name %&gt;</p>

<p>&lt;% @person.addresses.each do |address| %&gt;</p>

<p>&lt;%= person_form.fields_for address, :index =&gt; address do |address_form|%&gt;</p>

<p>&lt;%= address_form.text_field :city %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>Assuming the person had two addresses, with ids 23 and 45 this would create output similar to this:</p>

<p><span style="font-family: DejaVu Sans;">假设</span>person<span style="font-family: DejaVu Sans;">有两个</span>address<span style="font-family: DejaVu Sans;">。</span>id<span style="font-family: DejaVu Sans;">为</span>23<span style="font-family: DejaVu Sans;">和</span>45<span style="font-family: DejaVu Sans;">将会创建与下面类似的</span>HTML<span style="font-family: DejaVu Sans;">代码：</span></p>

<p>&lt;form accept-charset=&ldquo;UTF-8&rdquo; action=&ldquo;/people/1&rdquo; id=&ldquo;edit_person_1&rdquo; method=&ldquo;post&rdquo;&gt;</p>

<p>&lt;input id=&ldquo;person_name&rdquo; name=&ldquo;person[name]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;text&rdquo; /&gt;</p>

<p>&lt;input id=&ldquo;person_address_23_city&rdquo; name=&ldquo;person[address][23][city]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;text&rdquo; /&gt;</p>

<p>&lt;input id=&ldquo;person_address_45_city&rdquo; name=&ldquo;person[address][45][city]&rdquo; size=&ldquo;30&rdquo; type=&ldquo;text&rdquo; /&gt;</p>

<p>&lt;/form&gt;</p>

<p>This will result in a <tt>params</tt> hash that looks like</p>

<p>{&lsquo;person&rsquo; =&gt; {&lsquo;name&rsquo; =&gt; &lsquo;Bob&rsquo;, &lsquo;address&rsquo; =&gt; {&lsquo;23&rsquo; =&gt; {&lsquo;city&rsquo; =&gt; &lsquo;Paris&rsquo;}, &lsquo;45&rsquo; =&gt; {&lsquo;city&rsquo; =&gt; &lsquo;London&rsquo;}}}}</p>

<p>&nbsp;</p>

<p>Rails knows that all these inputs should be part of the person hash because you called <tt>fields_for</tt> on the first form builder. By specifying an <tt>:index</tt> option you’re telling Rails that instead of naming the inputs <tt>person[address][city]</tt> it should insert that index surrounded by [] between the address and the city. If you pass an Active Record object as we did then Rails will call <tt>to_param</tt> on it, which by default returns the database id. This is often useful as it is then easy to locate which Address record should be modified. You can pass numbers with some other significance, strings or even <tt>nil</tt> (which will result in an array parameter being created).</p>

<p>Rails<span style="font-family: DejaVu Sans;">知道这里所有的</span>inputs<span style="font-family: DejaVu Sans;">应该是</span>person hash<span style="font-family: DejaVu Sans;">的一部分因为你在</span>form builder<span style="font-family: DejaVu Sans;">的开始调用了 </span><tt>fields_for</tt><span style="font-family: DejaVu Sans;"><tt>。通过指定</tt></span><tt>:index</tt><span style="font-family: DejaVu Sans;"><tt>选项你告诉</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>替代</tt></span><tt>person[address][city] input</tt><span style="font-family: DejaVu Sans;"><tt>中的名字它将会在</tt></span><tt>address</tt><span style="font-family: DejaVu Sans;"><tt>和此帖有之间插入被</tt></span><tt>[]</tt><span style="font-family: DejaVu Sans;"><tt>包围的</tt></span><tt>index</tt><span style="font-family: DejaVu Sans;"><tt>。如果你通过的是一个</tt></span><tt>Active Record object</tt><span style="font-family: DejaVu Sans;"><tt>正如我们知道的</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>将会调用</tt></span><tt>_param,</tt><span style="font-family: DejaVu Sans;"><tt>它会默认返回数据库的（</tt></span><tt>city</tt><span style="font-family: DejaVu Sans;"><tt>的）</tt></span><tt>id</tt><span style="font-family: DejaVu Sans;"><tt>。这在当</tt></span><tt>Addrss</tt><span style="font-family: DejaVu Sans;"><tt>记录需要修改，的时候非常有用它能易于定位。你可以传递给其他意义的数字，字符串或者空（它将返回在创建的参数数组中）。</tt></span></p>

<p><tt>To create more intricate</tt><span style="font-family: DejaVu Sans;"><tt>复杂 </tt></span><tt>nestings, you can specify the first part of the input name (person[address] in the previous example) explicitly, for example</tt></p>

<p>&lt;%= fields_for &lsquo;person[address][primary]&rsquo;, address, :index =&gt; address do |address_form| %&gt;</p>

<p>&lt;%= address_form.text_field :city %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>will create inputs like</p>

<p>As a general rule the final input name is the concatenation of the name given to <tt>fields_for</tt>/<tt>form_for</tt>, the index value and the name of the attribute. You can also pass an <tt>:index</tt> option directly to helpers such as <tt>text_field</tt>, but it is usually less repetitive to specify this at the form builder level rather than on individual input controls.</p>

<p>As a shortcut you can append [] to the name and omit<span style="font-family: DejaVu Sans;">忽略 </span>the <tt>:index</tt> option. This is the same as specifying <tt>:index =&gt; address</tt> so</p>

<p>&lt;%= fields_for &lsquo;person[address][primary][]&rsquo;, address do |address_form| %&gt;</p>

<p>&lt;%= address_form.text_field :city %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>produces exactly the same output as the previous example.</p>

<h3><a name="forms-to-external-resources"></a>8 Forms to external resources</h3>


<p>If you need to post some data to an external<span style="font-family: DejaVu Sans;">外部 </span>resource it is still great to build your from using rails form helpers. But sometimes you need to set an <tt>authenticity_token</tt> for this resource. You can do it by passing an <tt>:authenticity_token =&gt; &lsquo;your_external_token&rsquo;</tt> parameter to the <tt>form_tag</tt> options:</p>

<p>&lt;%= form_tag &lsquo;<a href="http://farfar.away/form">http://farfar.away/form</a>&rsquo;, :authenticity_token =&gt; &lsquo;external_token&rsquo;) do %&gt;</p>

<p>Form contents</p>

<p>&lt;% end %&gt;</p>

<p>Sometimes when you submit data to an external resource, like payment gateway, fields you can use in your form are limited by an external API. So you may want not to generate an <tt>authenticity_token</tt> hidden field at all. For doing this just pass <tt>false</tt> to the <tt>:authenticity_token</tt> option:</p>

<p>&lt;%= form_tag &lsquo;<a href="http://farfar.away/form">http://farfar.away/form</a>&rsquo;, :authenticity_token =&gt; false) do %&gt;</p>

<p>Form contents</p>

<p>&lt;% end %&gt;</p>

<p>The same technique is available for the <tt>form_for</tt> too:</p>

<p>&lt;%= form_for @invoice, :url =&gt; external_url, :authenticity_token =&gt; &lsquo;external_token&rsquo; do |f|</p>

<p>Form contents</p>

<p>&lt;% end %&gt;</p>

<p>Or if you don’t want to render an <tt>authenticity_token</tt> field:</p>

<p>&lt;%= form_for @invoice, :url =&gt; external_url, :authenticity_token =&gt; false do |f|</p>

<p>Form contents</p>

<p>&lt;% end %&gt;</p>

<h3><a name="building-complex-forms"></a>9 Building Complex Forms</h3>


<p>Many apps grow beyond simple forms editing a single object. For example when creating a Person you might want to allow the user to (on the same form) create multiple address records (home, work, etc.). When later editing that person the user should be able to add, remove or amend addresses as necessary. While this guide has shown you all the pieces necessary to handle this, Rails does not yet have a standard end-to-end way of accomplishing this, but many have come up with viable approaches. These include:</p>

<ul>
    <li>As of Rails 2.3, Rails includes <a href="http://guides.rubyonrails.org/2_3_release_notes.html#nested-attributes">Nested Attributes</a> and <a href="http://guides.rubyonrails.org/2_3_release_notes.html#nested-object-forms">Nested Object Forms</a></li>
    <li>Ryan Bates’ series of Railscasts on <a href="http://railscasts.com/episodes/75">complex forms</a></li>
    <li>Handle Multiple Models in One Form from <a href="http://media.pragprog.com/titles/fr_arr/multiple_models_one_form.pdf">Advanced Rails Recipes</a></li>
    <li>Eloy Duran’s <a href="https://github.com/alloy/complex-form-examples/">complex-forms-examples</a> application</li>
    <li>Lance Ivy’s <a href="https://github.com/cainlevy/nested_assignment/tree/master">nested_assignment</a> plugin and <a href="https://github.com/cainlevy/complex-form-examples/tree/cainlevy">sample application</a></li>
    <li>James Golick’s <a href="https://github.com/jamesgolick/attribute_fu">attribute_fu</a> plugin</li>
</ul>


<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/20/file-uploading-using-rails/">File Uploading Using Rails</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-20T15:55:00+08:00" pubdate data-updated="true">Dec 20<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>File Uploading using Rails</h2>

<p>You may have a requirement in which you want your site visitors to upload a file on your server. Rails makes it very easy to handle this requirement. Now we will proceed with a simple and small Rails project.</p>

<p>As usual, let&rsquo;s start off with a new Rails application called <strong>upload</strong>. So let&rsquo;s create basic structure of the application by using simple rails command.</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>C:\ruby&gt; rails upload</pre>
</td>
</tr>
</tbody>
</table>


<p>Now let&rsquo;s decide where you would like to save your uploaded files. Assume this is <strong>data</strong> directory inside your public section. So create this directory and check the permissions.</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>C:\ruby&gt; cd upload
C:\ruby&gt; mkdir upload\public\data</pre>
</td>
</tr>
</tbody>
</table>


<p>Our next step will be as usual, to create controller and models, so let&rsquo;s do that:</p>

<h2>Creating Model:</h2>


<p>Because this is not a database based application so we can keep name whatever is comfortable to us. Assume we have to create a <strong>DataFile</strong> model.</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>C:\ruby&gt; ruby script/generate model DataFile
      exists  app/models/
      exists  test/unit/
      exists  test/fixtures/
      create  app/models/data_file.rb
      create  test/unit/data_file_test.rb
      create  test/fixtures/data_files.yml
      create  db/migrate
      create  db/migrate/001_create_data_files.rb</pre>
</td>
</tr>
</tbody>
</table>


<p>Now we will create a method called <strong>save</strong> in <strong>data_file.rb</strong> model file. This method will be called by the application controller.</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>class DataFile &lt; ActiveRecord::Base
  def self.save(upload)
    name =  upload['datafile'].original_filename
    directory = "public/data"
    # create the file path
    path = File.join(directory, name)
    # write the file
    File.open(path, "wb") { |f| f.write(upload['datafile'].read) }
  end
end</pre>
</td>
</tr>
</tbody>
</table>


<p>The above function will take CGI object <strong>upload</strong> and will extract uploaded file name using helper function <strong>original_filename</strong> and finally it will store uploaded file into &ldquo;public/data&rdquo; directory. You can call helper function <strong>content_type</strong> to know media type of the uploaded file.</p>

<p>Here <strong>File</strong> is a ruby object and join is a helper function will concatenate directory name alongwith file name and will return full file path.</p>

<p>Next, to open a file in write mode we are using open helper function provided by <strong>File</strong> object. Further we are reading data from the passed data file and writing into output file.</p>

<h2>Creating Controller:</h2>


<p>Now let&rsquo;s create a controller for our upload project:</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>C:\ruby&gt; ruby script/generate controller Upload
      exists  app/controllers/
      exists  app/helpers/
      create  app/views/upload
      exists  test/functional/
      create  app/controllers/upload_controller.rb
      create  test/functional/upload_controller_test.rb
      create  app/helpers/upload_helper.rb</pre>
</td>
</tr>
</tbody>
</table>


<p>Now we will create two controller functions first function <strong>index</strong> will call a view file to take user input and second function <strong>uploadFile</strong> takes file information from the user and passes it to the &lsquo;DataFile&rsquo; model. We set the upload directory to the &lsquo;uploads&rsquo; directory we created earlier &ldquo;directory = &lsquo;data&rsquo;&rdquo;.</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>class UploadController &lt; ApplicationController
  def index
     render :file =&gt; 'app\views\upload\uploadfile.rhtml'
  end
  def uploadFile
    post = DataFile.save(params[:upload])
    render :text =&gt; "File has been uploaded successfully"
  end
end</pre>
</td>
</tr>
</tbody>
</table>


<p>Here we are calling function defined in model file. The <strong>render</strong> function is being used to redirect to view file as well as to display a message.</p>

<h2>Creating View:</h2>


<p>Finally we will create a view file <strong>uploadfile.rhtml</strong> which we have mentioned in controller. Populate this file with the following code:</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>&lt;h1&gt;File Upload&lt;/h1&gt;
&lt;%= start_form_tag ({:action =&gt; 'uploadFile'}, 
                        :multipart =&gt; true) %&gt;
&lt;p&gt;&lt;label for="upload_file"&gt;Select File&lt;/label&gt; : 
&lt;%= file_field 'upload', 'datafile' %&gt;&lt;/p&gt;
&lt;%= submit_tag "Upload" %&gt;
&lt;%= end_form_tag %&gt;</pre>
</td>
</tr>
</tbody>
</table>


<p>Here everything is same what we have explained in earlier chapters. Only new tag is <strong>file_field</strong> which will create a button to select a file from user&rsquo;s computer.</p>

<p>By setting the multipart parameter to true, you ensure that your action properly passes along the binary data from the file.</p>

<p>Here, an important point to note is that we have assigned <strong>&ldquo;uploadFile&rdquo;</strong> as the method name in :action, which will be called when you click the <strong>Upload</strong> button.</p>

<p>This will show you a screen as follows:</p>

<center><img src="http://www.tutorialspoint.com/images/upload-file.gif" alt="Upload File" />

</center>


<p>Now you select a file and upload it, this file will be uploaded into app/public/data directory with the actual file name and a message will be displayed to you saying that &ldquo;File has been uploaded successfully&rdquo;.</p>

<p><strong>NOTE:</strong> If a file with the same name already exists in your output directory then it will be over-written.</p>

<h2>Files uploaded from Internet Explorer:</h2>


<p>Internet Explorer includes the entire path of a file in the filename sent, so the <strong>original_filename</strong> routine will return something like:</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>C:\Documents and Files\user_name\Pictures\My File.jpg</pre>
</td>
</tr>
</tbody>
</table>


<p>instead of just:</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>My File.jpg</pre>
</td>
</tr>
</tbody>
</table>


<p>This is easily handled by <strong>File.basename</strong>, which strips out everything before the filename.</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>def sanitize_filename(file_name)
  # get only the filename, not the whole path (from IE)
  just_filename = File.basename(file_name) 
  # replace all none alphanumeric, underscore or perioids
  # with underscore
  just_filename.sub(/[^\w\.\-]/,'_') 
end</pre>
</td>
</tr>
</tbody>
</table>


<h2>Deleting an existing File:</h2>


<p>If you want to delete any existing file then its simple and need to write following code:</p>

<table cellpadding="5">
<tbody>
<tr>
<td>
<pre>  def cleanup
    File.delete("#{RAILS_ROOT}/dirname/#{@filename}") 
            if File.exist?("#{RAILS_ROOT}/dirname/#{@filename}")
  end</pre>
</td>
</tr>
</tbody>
</table>


<p>For a complete detail on <strong>File</strong> object, you need to go through Ruby Reference Manual.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/15/python-de-xu-ni-huan-jing-ji-duo-ban-ben-kai-fa-li-qi-%5Bnil%5Dvirtualenv-yu-pythonbrew/">Python 的虛擬環境及多版本開發利器─Virtualenv 與 Pythonbrew</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-15T21:29:00+08:00" pubdate data-updated="true">Dec 15<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Python 的虛擬環境及多版本開發利器─Virtualenv 與 Pythonbrew</h2>

<p>Virtualenv 和 Pythonbrew 都是可以創造虛擬（獨立）Python 環境的工具，只是虛擬（獨立）標的不同。</p>

<p>Virtualenv 可以隔離函數庫需求不同的專案，讓它們不會互相影響。在建立並啟動虛擬環境後，透過 <code>pip</code> 安裝的套件會被放在虛擬環境中，專案就可以擁有一個獨立的環境。</p>

<p>簡而言之，Virtualenv 可以幫你做到：</p>

<ul>
    <li>在沒有權限的情況下安裝新套件</li>
    <li>不同專案可以使用不同版本的相同套件</li>
    <li>套件版本升級時不會影響其他專案</li>
</ul>


<p>Pythonbrew 則可以在家目錄中安裝多個 Python，並迅速地切換版本；也可以在指定的 Python 版本下批次測試你的 Python 程式；另外更整合了 Virtualenv。</p>

<p>這篇文章會詳細介紹這兩個工具，讓你在多人開發及多版本開發的環境中更得心應手。</p>

<p>&nbsp;</p>

<h3>事前準備</h3>


<p>Python 的 package 通常會上傳至 <a href="http://pypi.python.org/pypi" target="_blank">PyPI</a>，有很多工具都可以從 <a href="http://pypi.python.org/pypi">PyPI</a> 安裝 package。下面會使用 <code>easy_install</code> 這個工具（由 <a href="http://pypi.python.org/pypi/setuptools" target="_blank">setuptools</a> 提供）來安裝 Virtualenv 和 Pythonbrew。</p>

<h4>01. Linux</h4>


<p>如果不知道 <code>easy_install</code> 或還沒安裝 setuptools，在 Debian/Ubuntu 可以用下列指令安裝：</p>

<pre><code>$ sudo apt-get install python-setuptools </code></pre>


<p>在 Fedora/CentOS/Redhat/openSUSE，則可以使用：</p>

<pre><code>$ su - # yum install python-setuptools </code></pre>


<h4>02. Windows</h4>


<p>在 Windows 則可以從 <a href="http://pypi.python.org/pypi/setuptools" target="_blank">setuptools</a> 的頁面找到 <code>*.exe</code> 格式的安裝檔案。安裝完後，可以在 <code>C:\PythonX.Y\Scripts&lt;/code>（X.Y 是 Python 的版本）下找到 <code>easy_install.exe</code>。記得把這個路徑放進 Windows 環境變數中的 PATH。</p>

<p>接著就可以輕鬆安裝任何在 <a href="http://pypi.python.org/pypi" target="_blank">PyPI</a> 的 Python Package 囉。</p>

<h3>Virtualenv - Virtual Python Environment builder</h3>


<h4>01. 安裝</h4>


<p>Pythonbrew 已整合了 Virtualenv，如果不想額外安裝一個套件，也可以不要裝 Virtualenv。</p>

<p>如果需要安裝，請於命令列模式下輸入下列指令：</p>

<pre><code># easy_install virtualenv </code></pre>


<h4>02. 使用方法</h4>


<h5>I. 建立虛擬環境</h5>


<p>請於命令列模式下輸入下列指令：</p>

<pre><code>$ virtualenv [指定虛擬環境的名稱] </code></pre>


<p>例如下列指令會建立名為 &ldquo;ENV&rdquo; 的虛擬環境：</p>

<pre><code>$ virtualenv ENV </code></pre>


<p>預設在建立虛擬環境時，會依賴系統環境中的 site packages，如果想<em>完全不依賴</em>系統的 packages，可以加上參數 <code>&mdash;no-site-packages</code> 來建立虛擬環境：</p>

<pre><code>$ virtualenv --no-site-packages [指定虛擬環境的名稱] </code></pre>


<div id="ii.-啟動虛擬環境">
<h3>II. 啟動虛擬環境</h3>
請先切換當前目錄至建立的虛擬環境中。前例中，建立名稱為 &#8220;ENV&#8221;，則：
<pre><code>$ cd ENV </code></pre>
接著，啟動虛擬環境：
<pre><code>$ source bin/activate </code></pre>
在 Windows 環境中則改用：
<pre><code>&gt; \path\to\env\Scripts\activate.bat </code></pre>
然後就可以注意到，在 shell 提示字元的最前面多了虛擬環境的名稱提示：
<pre><code>(ENV) ...$ </code></pre>
<h5>III. 退出虛擬環境</h5>
請於命令列模式下輸入下列指令：
<pre><code>$ deactivate </code></pre>
就可以回到系統原先的 Python 環境。
<h5>IV. 在虛擬環境安裝新的 Python 套件</h5>
Virtualenv 在安裝時會附帶 <code>pip</code> 這個 Python 的套件安裝工具，當虛擬環境被啟動時，由它安裝的 package 會出現在虛擬環境的資料夾中，用法是：
<pre><code>(ENV)...$ pip install [套件名稱] </code></pre>
如果系統也有安裝 <code>pip</code>，請特別注意是否已經<em>啟動</em>虛擬環境，否則套件會被安裝到系統中，而非虛擬環境裡。

如果想要避免 <code>pip</code> 在沒有進入虛擬環境時被使用，可以在 <code>~/.bashrc</code> 加上：
<pre><code>export PIP_REQUIRE_VIRTUALENV=true </code></pre>
要求 <code>pip</code> 一定要在虛擬環境中執行。

也可以用下面的設定，讓系統的 <code>pip</code> 自動使用啟動中的虛擬環境。
<pre><code>export PIP_RESPECT_VIRTUALENV=true </code></pre>
避免意外將套件安裝至系統環境。
<h5>V. 從程式中指定使用虛擬環境的函數庫</h5>
無法從 Shell 啟動虛擬環境的情況，像是使用 <a href="http://www.modpython.org/" target="_blank">mod_python</a> 或 <a href="http://code.google.com/p/modwsgi/" target="_blank">mod_wsgi</a>，這時可以在 Python 的程式中加上：
<pre><code>activate_this = '/path/to/env/bin/activate_this.py' execfile(activate_this, dict(__file__=activate_this)) </code></pre>
來使用安裝在虛擬環境中的 packages。
<h4>03. 延伸套件：Virtualenvwrapper</h4>
Virtualenvwrapper 是一個 Virtualenv 的 extension，可使虛擬環境的管理變得更容易。

詳細來說，Virtualenvwrapper 提供下述功能：
<ol>
    <li>將所有的虛擬環境整合在一個目錄下。</li>
    <li>管理（新增、移除、複製）所有的虛擬環境。</li>
    <li>可以使用一個命令切換虛擬環境。</li>
    <li>Tab 補全虛擬環境的名字。</li>
    <li>每個操作都提供允許使用者自訂的 hooks。</li>
    <li>可撰寫容易分享的 extension plugin 系統。</li>
</ol>
<h5>I. 安裝</h5>
請於命令列模式下輸入下列指令：
<pre><code># easy_install virtualenvwrapper </code></pre>
<h5>II. 使用方法</h5>
於 <code>$WORKON_HOME</code>製作虛擬環境：
<pre><code>$ mkvirtualenv [-i package] [-r requirements_file] [virtualenv options] ENVNAME </code></pre>
列出所有的虛擬環境：
<pre><code>$ lsvirtualenv [-b] [-l] [-h] </code></pre>
<code>-b</code> 是簡短模式；<code>-l</code> 是詳細模式（預設）；<code>-h</code> 是印出 help 資訊。

移除虛擬環境：
<pre><code>$ rmvirtualenv ENVNAME </code></pre>
複製虛擬環境：
<pre><code>$ cpvirtualenv ENVNAME TARGETENVNAME </code></pre>
啟動虛擬環境：
<pre><code>$ workon [environment_name] </code></pre>
如果只輸入 <code>workon</code>，則會列出所有的虛擬環境。

離開虛擬環境一樣是使用 <code>deactivate</code>。

可以使用下面的設定來告訴 <code>pip</code> Virtualenv 的路徑。
<pre><code>export PIP_VIRTUALENV_BASE=$WORKON_HOME </code></pre>
Virtualenvwrapper 的功能當然不只如此，更多功能可以參考 <a href="http://www.doughellmann.com/docs/virtualenvwrapper/index.html" target="_blank">Virtualenvwrapper 的官方文件</a>。
<h3>Pythonbrew</h3>
<h4>01. 安裝</h4>
Pythonbrew 是個比較新的專案，雖然比較新，卻非常完整。它也有整合上面介紹的 Virtualenv。可以用類似 Virtualenvwrapper 的方式來操作 Virtualenv。

安裝方式與 Virtualenv 一樣，只要輸入下面的指令就可以了：
<pre><code># easy_install $ pythonbrew </code></pre>
Pythonbrew 官方有推薦的安裝方式，但這篇教學為求一致性，就不額外介紹了，可以參考 <a href="https://github.com/utahta/$%20pythonbrew/blob/master/README.rst" target="_blank">pythonbrew/README.rst</a>。

對於 Windows 的使用者，很可惜地，Pythonbrew 暫時沒有支援 Windows 的計畫 (<a href="https://github.com/utahta/$%20pythonbrew/issues/6" target="_blank">#6: Windows Support? - Issues - utahta/pythonbrew - GitHub</a>)。所以 Windows 暫時還沒辦法使用 Pythonbrew 囉。

經過 <code>easy_install</code> 的安裝後，還需要在 shell 執行：
<pre><code>$ pythonbrew_install </code></pre>
才會把初始的設定檔和資料夾配置進你的家目錄。接著要修改 <code>~/.bashrc</code> 的配置：
<pre><code>$ echo "source ~/.pythonbrew/etc/bashrc" &gt;&gt; ~/.bashrc </code></pre>
這樣就算安裝完全囉。

Pythonbrew 使用 <code>curl</code> 來抓取資料，如果你的系統沒有，請記得安裝。Ubuntu 上可以使用這行指令：
<pre><code>$ sudo apt-get install curl </code></pre>
<h4>02. 編譯前準備</h4>
因為 Pythonbrew 採取下載 tarball，並編譯、安裝的方法，所以我們要先為系統準備好編譯 Python 所需的套件。

也因為許多 Linux 發行版都已打包 Python，所以我們可以偷懶一點，用已經打包好的套件來解決編譯所需的相依性。在 Ubuntu/Debian 上，可以透過：
<pre><code>$ sudo apt-get build-dep python2.7 </code></pre>
來安裝所有編譯 Python 2.7 所需的套件。雖然已經能夠安裝得相當完整，但還是缺少了 <code>gdbm</code> 這個 module，如果需要的話，可以透過：
<pre><code>$ sudo apt-get build-dep python-gdbm </code></pre>
來安裝編譯 <code>gdbm</code> 所需的套件。

註：<code>bsddb185</code>、<code>linuxaudiodev</code>、<code>ossaudiodev</code>、<code>sunaudiodev</code> 等是按以上方式安裝後，仍會缺少的 module。其中 <code>ossaudiodev</code>（Open Sound System）在隨 Ubuntu 發布的 Python 中有提供，列出來讓大家參考。

Fedora/CentOS/Redhat/openSUSE 則可以使用 <code>yum-builddep</code> 這個指令。
<h4>03. 使用方法</h4>
Pythonbrew 的操作不外乎安裝、移除、列出及使用新的 Python 版本，下面是依照初次使用時所需的指令順序來介紹。
<h5>I. 列出可安裝的版本</h5>
首先我們用 <code>list --know</code> 列出可以安裝的 Python 版本：
<pre><code>$ pythonbrew list --know </code></pre>
</div>


<div id="ii.-安裝新的版本">
<h5>II. 安裝新的版本</h5>
接著利用 <code>install VERSION</code> 來下載並編譯 Python 到本機，除了接 Python 的版本編號以外，也可以接 Python 的 tarball 路徑或網址來安裝；也能調整編譯 Python 的選項。下面是一些例子：
<pre><code>$ pythonbrew install 2.7.2 $ pythonbrew install --verbose 2.7.2 $ pythonbrew install --force 2.7.2 $ pythonbrew install --no-test 2.7.2 $ pythonbrew install --configure="CC=gcc_4.1" 2.7.2 $ pythonbrew install --no-setuptools 2.7.2 $ pythonbrew install http://www.python.org/ftp/python/2.7/Python-2.7.2.tgz $ pythonbrew install /path/to/Python-2.7.2.tgz $ pythonbrew install /path/to/Python-2.7.2 $ pythonbrew install 2.7.2 3.2 </code></pre>
<h5>III. 清理安裝時產生的檔案</h5>
下載的 Python tarball 會放在 <code>~/.pythonbrew/dists/</code> 下；而編譯則會在 <code>~/.pythonbrew/build/</code> 下進行。如果想清理這兩個目錄，可以使用：
<pre><code>$ pythonbrew cleanup </code></pre>
<h5>IV. 列出所有已安裝的版本</h5>
安裝好之後，可以使用 <code>list</code> 命令列出所有已安裝的 Python 版本：
<pre><code>$ pythonbrew list </code></pre>
後面有打星號的，就是現在正在使用的 Python 版本。
<h5>V. 切換已安裝的版本</h5>
可以使用 <code>switch</code> 來切換預設的 Python 版本：
<pre><code>$ pythonbrew switch VERSION </code></pre>
如果只想在當前的 shell 下切換，可以使用 <code>use</code>：
<pre><code>$ pythonbrew use VERSION </code></pre>
要切換回預設的環境時，使用 <code>off</code>：
<pre><code>$ pythonbrew off </code></pre>
就會返回系統環境的 Python 了。
<h5>VI. 批次在不同版本下測試</h5>
最重要的是，可以用系統內所有安裝過的 Python 版本，或指定的 Python 版本來測試自己的程式！
<pre><code>$ pythonbrew py test.py # 使用所有有安裝的版本 $ pythonbrew py -v test.py # 詳細輸出 $ pythonbrew py -p 2.7.2 -p 3.2 test.py # 指定特定的版本 </code></pre>
<h5>VII. 移除已安裝的版本</h5>
若想移除已經安裝的 Python，則可以使用 <code>uninstall</code>：
<pre><code>$ pythonbrew uninstall 2.7.2 $ pythonbrew uninstall 2.7.2 3.2 </code></pre>
<h5>VIII. 與 Virtualenv 的整合</h5>
要注意 Pythonbrew 中所提供的 Virtualenv，是基於 Pythonbrew 中所安裝的 Python（置於 <code>~/.pythonbrew/venvs/Python-VERSION/</code> 下）。在不使用 Pythonbrew 的情況下，無法使用附屬於 Pythonbrew 的 <code>venv</code> 功能。

Pythonbrew 提供了和 Virtualenvwrapper 類似的功能，只是沒有像 Virtualenvwrapper 那麼完整的 plugin 系統。所有在 Pythonbrew 中的 Virtualenv 指令都以 <code>venv</code> 作為第一個副命令。
<pre><code>$ pythonbrew venv create [指定虛擬環境的名稱] $ pythonbrew venv list $ pythonbrew venv use [指定虛擬環境的名稱] $ pythonbrew venv delete [指定虛擬環境的名稱] </code></pre>
離開虛擬環境一樣是使用 <code>deactivate</code>。
<h5>IX. Buildout</h5>
如果有使用 <a href="http://www.buildout.org/" target="_blank">Buildout</a> 這個工具，也可以透過 Pythonbrew 來執行：
<pre><code>$ pythonbrew buildout $ pythonbrew buildout -p 2.6.6 # 指定版本 </code></pre>
</div>


<div id="x.-自我更新">
<h5>X. 自我更新</h5>
最後，Pythonbrew 有內建更新自己的指令：
<pre><code>$ pythonbrew update $ pythonbrew update --master $ pythonbrew update --develop </code></pre>
Virtualenv 和 Pythonbrew 就介紹到這邊，如果想獲得更多資訊，可以多多參考它們的官網哦。祝大家玩得愉快。
<h3>參考資料</h3>
<ul>
    <li><a href="http://www.virtualenv.org/" target="_blank">www.virtualenv.org</a></li>
    <li><a href="https://github.com/utahta/pythonbrew" target="_blank">utahta/pythonbrew - GitHub</a></li>
    <li><a href="http://pypi.python.org/pypi/setuptools" target="_blank">setuptools - PyPI</a></li>
    <li><a href="http://pypi.python.org/pypi/pip" target="_blank">pip - PyPI</a></li>
    <li><a href="http://www.doughellmann.com/docs/virtualenvwrapper/" target="_blank">virtualenvwrapper documentaion</a></li>
    <li><a href="http://stackoverflow.com/questions/6171210/building-python-and-more-on-missing-modules" target="_blank">Building Python and more on missing modules - Stack Overflow</a></li>
</ul>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/15/djangokai-fa-bi-zhi-bi-hui/">Django开发必知必会</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-15T21:27:00+08:00" pubdate data-updated="true">Dec 15<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Django开发必知必会</h2>

<div id="cnblogs_post_body">
<h1>Django开发必知必会</h1>
<div id="id1">
<h1>版权说明</h1>
由于最近发现很多转载笔者的文章而没有说明作者和出处,所以特别在些声明.

本博客所有内容采用 Creative Commons Licenses 许可使用. 引用本内容时，请保留 <strong>朱涛</strong>, <strong>出处</strong> ，并且 <strong>非商业</strong> .

</div>
<div id="id2">
<h1>摘要</h1>
Django 作为 python 社区中最流利的web框架,它所强调的就是 <strong>快速开发</strong>, <strong>复用</strong>, <strong>可读</strong>. 本文主要介绍使用 Django 来开发所需要了解的知识,其中也包含了一些指导性的原则以及笔者的一些经验之谈.
<div id="contents">

Contents
<ul>
    <li>版权说明</li>
    <li>摘要</li>
    <li>基本知识
<ul>
    <li>熟悉python和django</li>
    <li>其它的相关技术</li>
</ul>
</li>
    <li>可用的资源</li>
    <li>高级知识
<ul>
    <li>使用virtualenv+pip来构建独立的开发环境</li>
    <li>使用fabric进行部署</li>
</ul>
</li>
    <li>推荐的开发流程</li>
    <li>结论</li>
    <li>参考资料</li>
</ul>
</div>
</div>
<div id="id3">
<h1>基本知识</h1>
<div id="python-django">
<h2>熟悉python和django</h2>
Django 是基于 python 的,所以在开发前需要熟悉相关的技术.

python 推荐几本比较好的书,包括:
<ol>
    <li>learning python</li>
    <li>python cookbook</li>
</ol>
熟读 Django 的 官方文档 和相关的书籍，这些都是必须。比较好的书籍有：
<ol>
    <li>Django Book</li>
    <li>Pro Django</li>
    <li>Practical Django Projects</li>
</ol>
更多参考 django相关资源.

</div>
<div id="id4">
<h2>其它的相关技术</h2>
作为web开发的程序员,还需要了解其它的相关技术,包括:
<ul>
    <li>html</li>
    <li>css</li>
    <li>javascript ( jquery 等)</li>
    <li>ajax</li>
    <li>网络知识和标准,如 http 协议, TCP/IP网络架构等.</li>
</ul>
</div>
</div>
<div id="id5">
<h1>可用的资源</h1>
掌握了上面提到的基本知识外,我们对 python, Django 及web开发的相关技术有了一定的熟悉,也对 python 和 Django 的 哲学也有一定的了解,如 <em>Don&#8217;t Repeat Yourself</em>,<em>Keep It Simple, Stupid</em>, <em>Don&#8217;t Reinvent Wheels</em> 等.

所以,在开始一个项目之前我们需要了解已有哪些可用的资源.

而在可用的资源中,最需要跟踪的一个项目就是 pinax ，它提供了站点所必须的一些常用功能，而 所采用的方式便是提供一些 <strong>可复用的app</strong>, 使得我们很容易集成到我们的环境中， 或者基于 pinax 二次开发。

除此之外，还需要了解一些特定领域的相关资源，如：
<ul>
    <li>商店 satchmo</li>
    <li>地理 GeoDjango</li>
    <li>OpenId django-openid</li>
    <li>等等</li>
</ul>
在获得特定领域的相关资源后，会大大地提高开发的效率，从而降低成本。

</div>
<div id="id6">
<h1>高级知识</h1>
掌握上面提到的技术,这时就基本上是一个合格的 Django 程序员了,但是除此之外,还需要了解一些高级的知识.
<div id="virtualenv-pip">
<h2>使用virtualenv+pip来构建独立的开发环境</h2>
virtualenv 用 于建立一个独立的（与其它module)的虚拟环境，从而使得不同的虚拟环境下的 程序可以依赖于不同版本的module,例如某个django project是基于0.96的，而另外的project是基于 1.1的，所以就必须有不同的虚拟环境。 了解更多参考： pip and virtualenv

使用 pip 来 <strong>复制</strong> 已有的依赖。 pip 是用来取代 easy_install 的，除此而外， 我们还可以很方便地使用 pip 来 <strong>复制</strong> 我们当前的工作环境。例如，我们建立一个<em>requirements.txt</em> 文件 来记录我们当前工作环境中的相关依赖程序，然后输入 <cite>pip install -r /path/to/requirements.txt</cite>, 那么相应的 依赖软件会自动安装。前提是你的系统已经安装了 pip.

除此而外，当你需要部署一个django项目时，可以使用 wsgi 很方便地进行部署，具体参考 virtualenv and wsgi.

</div>
<div id="fabric">
<h2>使用fabric进行部署</h2>
参考 Deploying Python Web Applications

另外,我们还可以使用 python 的强大功能,来实现例如配置文件的路径自适应, 利用调试状态来设定特定的属性等.

</div>
</div>
<div id="id7">
<h1>推荐的开发流程</h1>
可使用下面的开发流程来进行 Django 的开发(假设是从新开始一个项目的)：
<ol>
    <li>使用 virtualenv 建立相应的独立环境</li>
    <li>使用 easy_install 和 pip 安装相应的依赖模块</li>
    <li>多人开发时可将当前的所有模块 <strong>复制</strong> 给同事( <cite>pip</cite> 有 <em>feeze</em> 命令来输出当前环境下的所有依赖模块及版本,以保证所有的开发人员使用相同的代码库)</li>
    <li>为服务器也建立相应的独立环境,并使用 fabric 进行自动化部署.</li>
    <li>最后,使用 wsgi 和web服务器来发布产品</li>
</ol>
</div>
<div id="id8">
<h1>结论</h1>
利用 Django 的 <strong>复用</strong>, <strong>快速开发</strong> 等特性来进行Web开发, 其实是有一定的规律可循的, 除了上面介绍的一些开发知识(技巧)外,如果在开发中你发现某个过程很繁琐,你这时候就要考虑去调研 是否已经存在相关的解决方案.而不要一味地,耗时地去完成.

</div>
<div id="id9">
<h1>参考资料</h1>
<ol>
    <li>Notes on using pip and virtualenv with Django</li>
    <li>啄木鸟社区</li>
    <li>django相关资源</li>
</ol>
</div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/08/layouts-and-rendering-in-rails/">Layouts and Rendering in Rails</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-08T21:12:00+08:00" pubdate data-updated="true">Dec 8<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Layouts and Rendering in Rails</h2>

<h2>Layouts and Rendering in Rails</h2>


<p>This guide covers the basic layout features of Action Controller and Action View. By referring to this guide, you will be able to:</p>

<p><span style="font-family: DejaVu Sans;">这个教程涵盖了</span>Action Controller and Action View<span style="font-family: DejaVu Sans;">的基础布局。通过这个教程，你可以了解到如下内容：</span></p>

<ul>
    <li>Use the various rendering methods built into Rails <span style="font-family: DejaVu Sans;">使用</span>Rails<span style="font-family: DejaVu Sans;">内建的各种渲染方法</span></li>
    <li>Create layouts with multiple content sections <span style="font-family: DejaVu Sans;">使用多个</span>content sections<span style="font-family: DejaVu Sans;">创建</span>layouts</li>
    <li>Use partials to DRY up your views <span style="font-family: DejaVu Sans;">在你的</span>view<span style="font-family: DejaVu Sans;">里面使用</span>partials</li>
    <li>Use nested layouts (sub-templates) <span style="font-family: DejaVu Sans;">使用嵌套</span>layouts<span style="font-family: DejaVu Sans;">（</span>sub-templates<span style="font-family: DejaVu Sans;">）</span></li>
</ul>


<h3><a name="overview-how-the-pieces-fit-together"></a> 1 Overview: How the Pieces Fit Together<span style="font-family: WenQuanYi Micro Hei;">概述：如何完整的组合在一起</span></h3>


<p>This guide focuses on the interaction between Controller and View in the Model-View-Controller triangle. As you know, the Controller is responsible for orchestrating the whole process of handling a request in Rails, though it normally hands off any heavy code to the Model. But then, when it’s time to send a response back to the user, the Controller hands things off to the View. It’s that handoff that is the subject of this guide.</p>

<p><span style="font-family: DejaVu Sans;">这个教程主要着重于在</span>model-view-controller<span style="font-family: DejaVu Sans;">三角（关系）中的</span>controller<span style="font-family: DejaVu Sans;">和</span>view<span style="font-family: DejaVu Sans;">之间的交互。众所周知，</span>controller<span style="font-family: DejaVu Sans;">是负责编排在</span>Rails<span style="font-family: DejaVu Sans;">处理请求的全过程，通过这样它一般可以让</span>model<span style="font-family: DejaVu Sans;">从沉重的代码中解放出来。但是接下来，什么时候是发回一个响应给用户呢，</span>controller<span style="font-family: DejaVu Sans;">把事情交给</span>view.<span style="font-family: DejaVu Sans;">这就是</span>handoff<span style="font-family: DejaVu Sans;">这也是这个教程的主题。</span></p>

<p>In broad strokes, this involves deciding what should be sent as the response and calling an appropriate method to create that response. If the response is a full-blown view, Rails also does some extra work to wrap<span style="font-family: DejaVu Sans;">包裹</span>the view in a layout and possibly to pull in partial views. You’ll see all of those paths later in this guide.</p>

<p><span style="font-family: DejaVu Sans;">在广泛的划分情况下，这涉及到决定应该发送什么作为响应或者调用一个适当的方法来创建一个响应。如果这个响应是一个</span>full-blown<span style="font-family: DejaVu Sans;">的</span>view<span style="font-family: DejaVu Sans;">，</span>Rails<span style="font-family: DejaVu Sans;">同样做一些额外的工作来在</span>layout<span style="font-family: DejaVu Sans;">中包装视图或者有可能的话调入其他部分</span>view<span style="font-family: DejaVu Sans;">。在后部分你将会看到完整的教程。</span></p>

<h3><a name="creating-responses"></a>2 Creating Responses<span style="font-family: WenQuanYi Micro Hei;">创建一个回应</span></h3>


<p>From the controller’s point of view, there are three ways to create an HTTP response:</p>

<p><span style="font-family: DejaVu Sans;">基于</span>controller<span style="font-family: DejaVu Sans;">的</span>view<span style="font-family: DejaVu Sans;">观点，这里有三种方法来创建一个</span>HTTP response<span style="font-family: DejaVu Sans;">：</span></p>

<ul>
    <li>Call <tt>render</tt> to create a full response to send back to the browser <span style="font-family: DejaVu Sans;">调用一个</span>render<span style="font-family: DejaVu Sans;">来创建以个完全回应</span>full response<span style="font-family: DejaVu Sans;">回传给浏览器。</span></li>
    <li>Call <tt>redirect_to</tt> to send an HTTP redirect status code to the browser <span style="font-family: DejaVu Sans;">调用一个</span>redirect_to<span style="font-family: DejaVu Sans;">来发送一个</span>HTTP<span style="font-family: DejaVu Sans;">重定向状态码给浏览器</span></li>
    <li>Call <tt>head</tt> to create a response consisting solely of HTTP headers to send back to the browser <span style="font-family: DejaVu Sans;">调用</span>head<span style="font-family: DejaVu Sans;">创建一个响应，只包括</span>HTTP<span style="font-family: DejaVu Sans;">头并将其发送回浏览器</span></li>
</ul>


<p>I’ll cover each of these methods in turn. But first, a few words about the very easiest thing that the controller can do to create a response: nothing at all.</p>

<p><span style="font-family: DejaVu Sans;">我将会依次（介绍）每种方法。但在此之前，用少量的文字说明最简单的事情<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span></span>controller<span style="font-family: DejaVu Sans;">创建一个回应：什么都没有。</span></p>

<h4><a name="rendering-by-default-convention-over-con"></a> 2.1 Rendering by Default: Convention Over Configuration in Action<span style="font-family: WenQuanYi Micro Hei;">以默认方式渲染：</span>Action<span style="font-family: WenQuanYi Micro Hei;">约定优于配置</span></h4>


<p>You’ve heard that Rails promotes “convention over configuration”. Default rendering is an excellent example of this. By default, controllers in Rails automatically render views with names that correspond to valid routes. For example, if you have this code in your <tt>BooksController</tt> class:</p>

<p><span style="font-family: DejaVu Sans;">你已经听过了</span>Rails<span style="font-family: DejaVu Sans;">的原则<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span>约定优于配置<span style="font-family: Liberation Serif,Times New Roman,serif;">”</span>。在这里默认的渲染是一个优秀的例子。<strong>默认情况中，</strong></span><strong>Rails</strong><span style="font-family: DejaVu Sans;"><strong>中的</strong></span><strong>controllers</strong><span style="font-family: DejaVu Sans;"><strong>自动渲染视图通过在</strong></span><strong>routes</strong><span style="font-family: DejaVu Sans;"><strong>中验证对应的视图名字</strong>。例如，如果你的（视图代码）在你的</span><tt>BooksController</tt><span style="font-family: DejaVu Sans;"><tt>类</tt>中：</span></p>

<h3>rails generate scaffold Book title:string content:text</h3>

<p>&nbsp;</p>

<p>class BooksController &lt; ApplicationController</p>

<p>end</p>

<p>And the following in your routes file:<span style="font-family: DejaVu Sans;">并且将下面的代码放入你的</span>routes<span style="font-family: DejaVu Sans;">文件中：</span></p>

<p>resources :books</p>

<p>And you have a view file <tt>app/views/books/index.html.erb</tt>:</p>

<p>Rails will automatically render <tt>app/views/books/index.html.erb</tt> when you navigate to <tt>/books</tt> and you will see “Books are coming soon!” on your screen.</p>

<p>Rails<span style="font-family: DejaVu Sans;">将会自动渲染</span>render <tt>app/views/books/index.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>当你导航到</tt></span><tt>/books</tt><span style="font-family: DejaVu Sans;"><tt>并且你将会看到在你的屏幕上会出现</tt><tt><span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></tt></span><tt>Books</tt><tt> </tt><tt>are</tt><tt> </tt><tt>coming</tt><tt> </tt><tt>soon!</tt><tt>”</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p><tt>However</tt><tt> </tt><tt>a</tt><tt> </tt><tt>coming</tt><tt> </tt><tt>soon</tt><tt> </tt><tt>screen</tt><tt> </tt><tt>is</tt><tt> </tt><tt>only</tt><tt> </tt><tt>minimally</tt><tt> </tt><tt>useful,</tt><tt> </tt><tt>so</tt><tt> </tt><tt>you</tt><tt> </tt><tt>will</tt><tt> </tt><tt>soon</tt><tt> </tt><tt>create</tt><tt> </tt><tt>your</tt><tt> </tt><tt>Book</tt><tt> </tt><tt>model</tt><tt> </tt><tt>and</tt><tt> </tt><tt>add</tt><tt> </tt><tt>the</tt><tt> </tt><tt>index</tt><tt> </tt><tt>action</tt><tt> </tt><tt>to</tt><tt> </tt><tt>BooksController:</tt></p>

<p><span style="font-family: DejaVu Sans;"><tt>无论如何</tt><tt></tt></span><tt>a</tt><tt> </tt><tt>coming</tt><tt> </tt><tt>soon</tt><tt> </tt><tt>screen</tt><span style="font-family: DejaVu Sans;"><tt>只是一个很小的用途，因此接着很快你将会创建你的</tt></span><tt>Book</tt><span style="font-family: DejaVu Sans;"><tt>模型并且添加</tt></span><tt>index</tt><tt> </tt><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>到</tt><tt></tt></span><tt>BooksController</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p><tt>class</tt><tt> </tt><tt>BooksController</tt><tt> </tt><tt>&lt;</tt><tt> </tt><tt>ApplicationController</tt></p>

<p><tt> </tt><tt>def</tt><tt> </tt><tt>index</tt></p>

<p><tt> </tt><tt>@books</tt><tt> </tt><tt>=</tt><tt> </tt><tt>Book.all</tt></p>

<p><tt> </tt><tt>end</tt></p>

<p><tt>end</tt></p>

<p><tt>Note</tt><tt> </tt><tt>that</tt><tt> </tt><tt>we</tt><tt> </tt><tt>don</tt><tt>’</tt><tt>t</tt><tt> </tt><tt>have</tt><tt> </tt><tt>explicit</tt><tt> </tt><tt>render</tt><tt> </tt><tt>at</tt><tt> </tt><tt>the</tt><tt> </tt><tt>end</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>index</tt><tt> </tt><tt>action</tt><tt> </tt><tt>in</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>按照</tt></span><tt>accordance</tt><tt> </tt><tt>with</tt><tt> “</tt><tt>convention</tt><tt> </tt><tt>over</tt><tt> </tt><tt>configuration</tt><tt>” </tt><tt>principle.</tt><tt> </tt><tt>The</tt><tt> </tt><tt>rule</tt><tt> </tt><tt>is</tt><tt> </tt><tt>that</tt><tt> </tt><tt>if</tt><tt> </tt><tt>you</tt><tt> </tt><tt>do</tt><tt> </tt><tt>not</tt><tt> </tt><tt>explicitly</tt><tt> </tt><tt>render</tt><tt> </tt><tt>something</tt><tt> </tt><tt>at</tt><tt> </tt><tt>the</tt><tt> </tt><tt>end</tt><tt> </tt><tt>of</tt><tt> </tt><tt>a</tt><tt> </tt><tt>controller</tt><tt> </tt><tt>action,</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>will</tt><tt> </tt><tt>automatically</tt><tt> </tt><tt>look</tt><tt> </tt><tt>for</tt><tt> </tt><tt>the</tt><tt> </tt><tt>action_name.html.erb</tt><tt> </tt><tt>template</tt><tt> </tt><tt>in</tt><tt> </tt><tt>the</tt><tt> </tt><tt>controller</tt><tt>’</tt><tt>s</tt><tt> </tt><tt>view</tt><tt> </tt><tt>path</tt><tt> </tt><tt>and</tt><tt> </tt><tt>render</tt><tt> </tt><tt>it.</tt><tt> </tt><tt>So</tt><tt> </tt><tt>in</tt><tt> </tt><tt>this</tt><tt> </tt><tt>case,</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>will</tt><tt> </tt><tt>render</tt><tt> </tt><tt>the</tt><tt> </tt><tt>app/views/books/index.html.erb</tt><tt> </tt><tt>file.</tt></p>

<p><span style="font-family: DejaVu Sans;">注意按照<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span>约定优于配置<span style="font-family: Liberation Serif,Times New Roman,serif;">”</span>原则，在</span>index action<span style="font-family: DejaVu Sans;">结束的时候，我们没有明确的渲染。这里的规则是如果你在使用一个</span>controller action<span style="font-family: DejaVu Sans;">结束的时候没有明确的</span>render<span style="font-family: DejaVu Sans;">一些事物，</span>Rails<span style="font-family: DejaVu Sans;">将会自动的在</span>controller<span style="font-family: DejaVu Sans;">的视图目录中找到</span><tt>action_name.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>文件并渲染它。因此在这个例子中，</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>将会渲染</tt><tt></tt></span><tt>app/views/books/index.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>文件。</tt></span></p>

<p>If we want to display the properties of all the books in our view, we can do so with an ERB template like this:</p>

<p><span style="font-family: DejaVu Sans;">如果我们想在我们的视图中显示所有</span>books<span style="font-family: DejaVu Sans;">的属性，我们可以这样做使用一个如下的</span>ERB<span style="font-family: DejaVu Sans;">模板：</span></p>

<p>&lt;h1&gt;Listing Books&lt;/h1&gt;</p>

<p>&nbsp;</p>

<p>&lt;table&gt;</p>

<p>&lt;tr&gt;</p>

<p>&lt;th&gt;Title&lt;/th&gt;</p>

<p>&lt;th&gt;Summary&lt;/th&gt;</p>

<p>&lt;th&gt;&lt;/th&gt;</p>

<p>&lt;th&gt;&lt;/th&gt;</p>

<p>&lt;th&gt;&lt;/th&gt;</p>

<p>&lt;/tr&gt;</p>

<p>&nbsp;</p>

<p>&lt;% @books.each do |book| %&gt;</p>

<p>&lt;tr&gt;</p>

<p>&lt;td&gt;&lt;%= book.title %&gt;&lt;/td&gt;</p>

<p>&lt;td&gt;&lt;%= book.content %&gt;&lt;/td&gt;</p>

<p>&lt;td&gt;&lt;%= link_to &lsquo;Show&rsquo;, book %&gt;&lt;/td&gt;</p>

<p>&lt;td&gt;&lt;%= link_to &lsquo;Edit&rsquo;, edit_book_path(book) %&gt;&lt;/td&gt;</p>

<p>&lt;td&gt;&lt;%= link_to &lsquo;Remove&rsquo;, book, :confirm =&gt; &lsquo;Are you sure?&rsquo;, :method =&gt; :delete %&gt;&lt;/td&gt;</p>

<p>&lt;/tr&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;/table&gt;</p>

<p>&nbsp;</p>

<p>&lt;br /&gt;</p>

<p>&nbsp;</p>

<p>&lt;%= link_to &lsquo;New book&rsquo;, new_book_path %&gt;</p>

<p>&nbsp;</p>

<p>The actual rendering is done by subclasses of <tt>ActionView::TemplateHandlers</tt>. This guide does not dig into that process, but it’s important to know that the file extension on your view controls the choice of template handler. In Rails 2, the standard extensions are <tt>.erb</tt> for ERB (HTML with embedded Ruby), and <tt>.builder</tt> for Builder (XML generator).</p>

<p>actual<span style="font-family: DejaVu Sans;">渲染是通过</span><tt>ActionView::TemplateHandlers</tt><span style="font-family: DejaVu Sans;"><tt>的子类完成的。这个教程不会（深入）挖掘那个过程，但是知道一些文件存在在你的</tt></span><tt>view</tt><tt> </tt><tt>controls</tt><span style="font-family: DejaVu Sans;"><tt>，被选择用来做</tt></span><tt>template</tt><tt> </tt><tt>handler</tt><span style="font-family: DejaVu Sans;"><tt>这很重要。在</tt></span><tt>Rails2</tt><span style="font-family: DejaVu Sans;"><tt>中</tt></span><tt>ERB</tt><span style="font-family: DejaVu Sans;"><tt>（</tt></span><tt>HTML</tt><tt> </tt><tt>with</tt><tt> </tt><tt>embedded</tt><tt> </tt><tt>Ruby</tt><span style="font-family: DejaVu Sans;"><tt>）标准的扩展名是</tt></span><tt>.erb</tt><span style="font-family: DejaVu Sans;"><tt>，并且</tt></span><tt>.builder</tt><span style="font-family: DejaVu Sans;"><tt>是</tt></span><tt>Builder</tt><span style="font-family: DejaVu Sans;"><tt>（</tt></span><tt>XML</tt><span style="font-family: DejaVu Sans;"><tt>生成器）的扩展名。</tt></span></p>

<h4><a name="using-render"></a>2.2 Using <tt>render</tt></h4>


<p>In most cases, the <tt>ActionController::Base#render</tt> method does the heavy lifting of rendering your application’s content for use by a browser. There are a variety of ways to customize the behaviour of <tt>render</tt>. You can render the default view for a Rails template, or a specific template, or a file, or inline code, or nothing at all. You can render text, JSON, or XML. You can specify the content type or HTTP status of the rendered response as well.</p>

<p><span style="font-family: DejaVu Sans;">在大多数例子中，</span><tt>ActionController::Base#render</tt><span style="font-family: DejaVu Sans;"><tt>方法通过浏览器将你的应用程序的内容生动的</tt></span><tt>rendering</tt><span style="font-family: DejaVu Sans;"><tt>给用户。这里有多种方法来定制</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>的习惯。你可以</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>一个</tt></span><tt>Rails</tt><tt> </tt><tt>template</tt><span style="font-family: DejaVu Sans;"><tt>为默认的视图，或者指定一个</tt></span><tt>template</tt><span style="font-family: DejaVu Sans;"><tt>，或者一个文件，或者一个内联代码，或者什么都没有。你可以</tt></span><tt>render</tt><tt> </tt><tt>text</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>JSON</tt><span style="font-family: DejaVu Sans;"><tt>，或者</tt></span><tt>XML</tt><span style="font-family: DejaVu Sans;"><tt>。你可以指定上下文类型或者</tt></span><tt>HTTP</tt><span style="font-family: DejaVu Sans;"><tt>回应</tt></span><tt>rendered</tt><span style="font-family: DejaVu Sans;"><tt>的状态。</tt></span></p>

<p>If you want to see the exact results of a call to <tt>render</tt> without needing to inspect<span style="font-family: DejaVu Sans;">检查</span>it in a browser, you can call <tt>render_to_string</tt>. This method takes exactly the same options as <tt>render</tt>, but it returns a string instead of sending a response back to the browser.</p>

<p><span style="font-family: DejaVu Sans;">如果你想查看调用一个</span>render<span style="font-family: DejaVu Sans;">在浏览器中不需要检查的那些额外的结果。你可以调用</span>render_to_string<span style="font-family: DejaVu Sans;">。这个方法获取和</span>render<span style="font-family: DejaVu Sans;">完全的</span>options<span style="font-family: DejaVu Sans;">，但是它返回的一个字符串而不是发送一个</span>response<span style="font-family: DejaVu Sans;">回浏览器。</span></p>

<h5><a name="rendering-nothing"></a>2.2.1 Rendering Nothing</h5>


<p><strong>Perhaps</strong><strong> </strong><strong>the</strong><strong> </strong><strong>simplest</strong><strong> </strong><strong>thing</strong><strong> </strong><strong>you</strong><strong> </strong><strong>can</strong><strong> </strong><strong>do</strong><strong> </strong><strong>with</strong><strong> </strong><tt><strong>render</strong></tt><strong> </strong><strong>is</strong><strong> </strong><strong>to</strong><strong> </strong><strong>render</strong><strong> </strong><strong>nothing</strong><strong> </strong><strong>at</strong><strong> </strong><strong>all:</strong></p>

<p>render :nothing =&gt; true</p>

<p>If you look at the response for this using cURL, you will see the following:</p>

<p><span style="font-family: DejaVu Sans;">如果你使用</span>cURL<span style="font-family: DejaVu Sans;">查看回应，你将会看到如下内容：</span></p>

<h1>curl -I 127.0.0.1:3000/books#<span style="font-family: DejaVu Sans;">此命令就是访问</span>HTTP status<span style="font-family: DejaVu Sans;">的</span></h1>

<p>$ curl -i 127.0.0.1:3000/books</p>

<p>HTTP/1.1 200 OK</p>

<p>Connection: close</p>

<p>Date: Sun, 24 Jan 2010 09:25:18 GMT</p>

<p>Transfer-Encoding: chunked</p>

<p>Content-Type: <em>/</em>; charset=utf-8</p>

<p>X-Runtime: 0.014297</p>

<p>Set-Cookie: _blog_session=&hellip;snip&hellip;; path=/; HttpOnly</p>

<p>Cache-Control: max-age=0, private, must-revalidate</p>

<p>We see there is an empty response (no data after the <tt>Cache-Control</tt> line), but the request was successful because Rails has set the response to 200 OK. <strong>You</strong><strong> </strong><strong>can</strong><strong> </strong><strong>set</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:status</strong></tt><strong> </strong><strong>option</strong><strong> </strong><strong>on</strong><strong> </strong><strong>render</strong><strong> </strong><strong>to</strong><strong> </strong><strong>change</strong><strong> </strong><strong>this</strong><strong> </strong><strong>response.</strong><strong> </strong><strong>Rendering</strong><strong> </strong><strong>nothing</strong><strong> </strong><strong>can</strong><strong> </strong><strong>be</strong><strong> </strong><strong>useful</strong><strong> </strong><strong>for</strong><strong> </strong><strong>AJAX</strong><strong> </strong><strong>requests</strong><strong> </strong><strong>where</strong><strong> </strong><strong>all</strong><strong> </strong><strong>you</strong><strong> </strong><strong>want</strong><strong> </strong><strong>to</strong><strong> </strong><strong>send</strong><strong> </strong><strong>back</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><strong>browser</strong><strong> </strong><strong>is</strong><strong> </strong><strong>an</strong><strong> </strong><strong>acknowledgment</strong><strong> </strong><strong>that</strong><strong> </strong><strong>the</strong><strong> </strong><strong>request</strong><strong> </strong><strong>was</strong><strong> </strong><strong>completed.</strong></p>

<p>def index</p>

<p>&nbsp;</p>

<p>render :nothing =&gt; true,:status=&gt;500</p>

<p>&nbsp;</p>

<p>end</p>

<p>jhjguxin@jhjguxin-virtual-machine:~/blog$ curl -I 127.0.0.1:3000/books</p>

<p>&nbsp;</p>

<p>HTTP/1.1 300 Multiple Choices</p>

<p>HTTP/1.1 500 Internal Server Error</p>

<p>&nbsp;</p>

<p>You should probably be using the <tt>head</tt> method, discussed later in this guide, instead of <tt>render</tt><tt> </tt><tt>:nothing</tt>. This provides additional<span style="font-family: DejaVu Sans;">额外</span>flexibility<span style="font-family: DejaVu Sans;">灵活的</span>and makes it <strong>explicit</strong><strong> </strong><strong>that</strong><strong> </strong><strong>you</strong><strong>’</strong><strong>re</strong><strong> </strong><strong>only</strong><strong> </strong><strong>generating</strong><strong> </strong><strong>HTTP</strong><strong> </strong><strong>headers.</strong><span style="font-family: DejaVu Sans;"><strong>（使用</strong></span><strong>render</strong><strong> </strong><strong>:nothing</strong><span style="font-family: DejaVu Sans;"><strong>提供了额外的灵活性它能够准确的只创建</strong></span><strong>HTTP</strong><strong> </strong><strong>headers</strong><span style="font-family: DejaVu Sans;"><strong>）</strong></span></p>

<h5><a name="rendering-an-action-s-view"></a>2.2.2 Rendering an Action’s View<span style="font-family: WenQuanYi Micro Hei;">渲染一个动作的视图</span></h5>


<p>If you want to render the view that corresponds to a different action within the same template, you can use <tt>render</tt> with the name of the view:</p>

<p><span style="font-family: DejaVu Sans;">如果你想</span>render<span style="font-family: DejaVu Sans;">的视图对应着不同的</span>action<span style="font-family: DejaVu Sans;">在一个相同的</span>template<span style="font-family: DejaVu Sans;">中，你可以使用</span>render<span style="font-family: DejaVu Sans;">加上视图的名字。</span></p>

<p>def update</p>

<p>@book = Book.find(params[:id])</p>

<p>if @book.update_attributes(params[:book])</p>

<p>redirect_to(@book)</p>

<p>else</p>

<p>render &ldquo;edit&rdquo;</p>

<p>end</p>

<p>end</p>

<p>If the call to <tt>update_attributes</tt> fails, calling the <tt>update</tt> action in this controller will render the <tt>edit.html.erb</tt> template belonging to the same controller.</p>

<p>If you prefer<span style="font-family: DejaVu Sans;">如果你喜欢</span>, you can use <strong>a</strong><strong> </strong><strong>symbol</strong><strong> </strong><strong>instead</strong><strong> </strong><strong>of</strong><strong> </strong><strong>a</strong><strong> </strong><strong>string</strong><strong> </strong><strong>to</strong><strong> </strong><strong>specify</strong><strong> </strong><strong>the</strong><strong> </strong><strong>action</strong><strong> </strong><strong>to</strong><strong> </strong><strong>render</strong>:</p>

<p>def update</p>

<p>@book = Book.find(params[:id])</p>

<p>if @book.update_attributes(params[:book])</p>

<p>redirect_to(@book)</p>

<p>else</p>

<p>render :edit</p>

<p>end</p>

<p>end</p>

<p>To be explicit, you can use <tt>render</tt> with the <tt>:action</tt> option (though this is no longer necessary in Rails 3.0):</p>

<p>def update</p>

<p>@book = Book.find(params[:id])</p>

<p>if @book.update_attributes(params[:book])</p>

<p>redirect_to(@book)</p>

<p>else</p>

<p>render :action =&gt; &ldquo;edit&rdquo;</p>

<p>end</p>

<p>end</p>

<p>Using <tt>render</tt> with <tt>:action</tt> is a frequent source of confusion for Rails newcomers. The specified action is used to determine which view to render, but Rails does not run any of the code for that action in the controller. Any instance variables that you require in the view must be set up in the current action before calling <tt>render</tt>.</p>

<p><span style="font-family: DejaVu Sans;">使用</span>render<span style="font-family: DejaVu Sans;">和</span>:action<span style="font-family: DejaVu Sans;">是来（处理）来自</span>Rails<span style="font-family: DejaVu Sans;">的新访客的频繁混乱的（请求）。指定的</span>action<span style="font-family: DejaVu Sans;">是用来决定渲染哪个视图，但是</span>Rails<span style="font-family: DejaVu Sans;">并没有在</span>controller<span style="font-family: DejaVu Sans;">中为那个</span>action<span style="font-family: DejaVu Sans;">运行任何代码。不管在视图中的你请求的何种实例必须在调用</span>render<span style="font-family: DejaVu Sans;">之前被</span>set up<span style="font-family: DejaVu Sans;">到当前</span>action<span style="font-family: DejaVu Sans;">中。</span></p>

<h5><a name="rendering-an-action-s-template-from-anot"></a> 2.2.3 Rendering an Action’s Template from Another Controller<span style="font-family: WenQuanYi Micro Hei;">从另一个</span>controller<span style="font-family: WenQuanYi Micro Hei;">渲染一个</span>actions<span style="font-family: WenQuanYi Micro Hei;">的</span>template</h5>


<p>What if you want to render a template from an entirely different controller from the one that contains the action code? You can also do that with <tt>render</tt>, which accepts the full path (relative to <tt>app/views</tt>) of the template to render. For example, if you’re running code in an <tt>AdminProductsController</tt> that lives in <tt>app/controllers/admin</tt>, you can render the results of an action to a template in <tt>app/views/products</tt> this way:</p>

<p><span style="font-family: DejaVu Sans;">如果你想</span>render<span style="font-family: DejaVu Sans;">一个</span>template<span style="font-family: DejaVu Sans;">它的</span>action<span style="font-family: DejaVu Sans;">来自完全不同的</span>controller<span style="font-family: DejaVu Sans;">？你也可以使用</span>render<span style="font-family: DejaVu Sans;">来（达到目的），它接收</span>template<span style="font-family: DejaVu Sans;">的全路径（相对于</span>app/views#<span style="font-family: DejaVu Sans;">项目路径为根目录）来</span>render<span style="font-family: DejaVu Sans;">。</span></p>

<p><span style="font-family: DejaVu Sans;">例如，你正在运行的代码在</span><tt>AdminProductsController</tt><span style="font-family: DejaVu Sans;"><tt>存放在</tt><tt></tt></span><tt>app/controllers/admin</tt><span style="font-family: DejaVu Sans;"><tt>中你可以</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>一个</tt></span><tt>action</tt><span style="font-family: DejaVu Sans;"><tt>的结果到</tt></span><tt>app/views/products</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>的一个</tt></span><tt>template</tt><span style="font-family: DejaVu Sans;"><tt>中用这样的方法：</tt></span><tt>
render</tt><tt> </tt><tt>&lsquo;products/show&rsquo;</tt></p>

<p>Rails knows that this view belongs to a different controller because of the embedded slash character in the string. If you want to be explicit<span style="font-family: DejaVu Sans;">如果你想准确的表达</span>, you can use the <tt>:template</tt> option (which was required on Rails 2.2 and earlier):</p>

<p>render :template =&gt; &lsquo;products/show&rsquo;</p>

<h5><a name="rendering-an-arbitrary-file"></a>2.2.4 Rendering an Arbitrary File<span style="font-family: WenQuanYi Micro Hei;">渲染任意文件</span></h5>


<p>The <tt>render</tt> method can also use a view that’s entirely outside of your application (perhaps you’re sharing views between two Rails applications):</p>

<p>render<span style="font-family: DejaVu Sans;">方法也可以使用一个完全脱离你的</span>application<span style="font-family: DejaVu Sans;">的视图（可能你在两个</span>Rails<span style="font-family: DejaVu Sans;">之间共享视图）</span></p>

<p>render &ldquo;/u/apps/warehouse_app/current/app/views/products/show&rdquo;</p>

<p>Rails determines that this is a file render because of the leading slash character<span style="font-family: DejaVu Sans;">斜线字符</span>. To be explicit, you can use the <tt>:file</tt> option (which was required on Rails 2.2 and earlier):</p>

<p>Rails<span style="font-family: DejaVu Sans;">认为这个是一个文件</span>render<span style="font-family: DejaVu Sans;">是因为开头的斜线字符。更准确的（表示），你可以使用</span>:file<span style="font-family: DejaVu Sans;">选项（它至少需要</span>Rails2.2<span style="font-family: DejaVu Sans;">或者更高）。</span></p>

<p>render :file =&gt;</p>

<p>&ldquo;/u/apps/warehouse_app/current/app/views/products/show&rdquo;</p>

<p>The <tt>:file</tt> option takes an absolute file-system path. Of course, you need to have rights to the view that you’re using to render the content.</p>

<p>:file<span style="font-family: DejaVu Sans;">选项获取一个完全文件系统路径。当然，你需要有权限（查看）你正在渲染的视图。</span></p>

<p>By default, the file is rendered without using the current layout. If you want Rails to put the file into the current layout, you need to add the <tt>:layout</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt> option.</p>

<p><span style="font-family: DejaVu Sans;">默认情况下，这个文件没有使用当前的</span>layout<span style="font-family: DejaVu Sans;">来</span>render<span style="font-family: DejaVu Sans;">。如果你想</span>Rails<span style="font-family: DejaVu Sans;">把这个文件渲染到当前</span>layout<span style="font-family: DejaVu Sans;">，你需要添加</span>:layout=&gt;true<span style="font-family: DejaVu Sans;">选项。</span></p>

<p>&nbsp;</p>

<p>If you’re running Rails on Microsoft Windows, you should use the <tt>:file</tt> option to render a file, because Windows filenames do not have the same format as Unix filenames.<span style="font-family: DejaVu Sans;">如果你正在</span>Microsoft Windows<span style="font-family: DejaVu Sans;">中运行</span>Rails<span style="font-family: DejaVu Sans;">，你应该使用</span>:file<span style="font-family: DejaVu Sans;">选项来</span>render<span style="font-family: DejaVu Sans;">一个文件，因为</span>Windows<span style="font-family: DejaVu Sans;">文件名称与</span>Unix<span style="font-family: DejaVu Sans;">文件名称并不相同（这里的文件名称应该包含了路径）。</span></p>

<h5><a name="wrapping-it-up"></a>2.2.5 Wrapping it up<span style="font-family: WenQuanYi Micro Hei;">包装起来</span></h5>


<p>The above three ways of rendering (rendering another template within the controller, rendering a template within another controller and rendering an arbitrary file on the file system) are actually variants of the same action.</p>

<p><span style="font-family: DejaVu Sans;">这里总共有三种</span>rendering<span style="font-family: DejaVu Sans;">的方法（在</span>controller<span style="font-family: DejaVu Sans;">中</span>rendering<span style="font-family: DejaVu Sans;">另一个</span>template<span style="font-family: DejaVu Sans;">，使用另一个</span>controller render<span style="font-family: DejaVu Sans;">一个</span>template<span style="font-family: DejaVu Sans;">或者渲染一个文件系统上的任意类型的文件）实际上它们是相同</span>action<span style="font-family: DejaVu Sans;">的变种。</span></p>

<p>In fact, in the BooksController class, inside of the update action where we want to render the edit template if the book does not update successfully, all of the following render calls would all render the <tt>edit.html.erb</tt> template in the <tt>views/books</tt> directory:</p>

<p><span style="font-family: DejaVu Sans;">事实上，在</span>BooksController<span style="font-family: DejaVu Sans;">类中，在</span>update action<span style="font-family: DejaVu Sans;">中如果</span>book<span style="font-family: DejaVu Sans;">没有更新成功的话我们希望</span>render edit template<span style="font-family: DejaVu Sans;">，所有的后续</span>render<span style="font-family: DejaVu Sans;">调用将会全部</span>render<span style="font-family: DejaVu Sans;">在</span><tt>views/books</tt><span style="font-family: DejaVu Sans;"><tt>目录中的</tt></span><tt>edit.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span><tt>(edit</tt><span style="font-family: DejaVu Sans;"><tt>的各种</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>方式</tt></span><tt>)</tt></p>

<p>render :edit</p>

<p>render :action =&gt; :edit</p>

<p>render &lsquo;edit&rsquo;</p>

<p>render &lsquo;edit.html.erb&rsquo;</p>

<p>render :action =&gt; &lsquo;edit&rsquo;</p>

<p>render :action =&gt; &lsquo;edit.html.erb&rsquo;</p>

<p>render &lsquo;books/edit&rsquo;</p>

<p>render &lsquo;books/edit.html.erb&rsquo;</p>

<p>render :template =&gt; &lsquo;books/edit&rsquo;</p>

<p>render :template =&gt; &lsquo;books/edit.html.erb&rsquo;</p>

<p>render &lsquo;/path/to/rails/app/views/books/edit&rsquo;</p>

<p>render &lsquo;/path/to/rails/app/views/books/edit.html.erb&rsquo;</p>

<p>render :file =&gt; &lsquo;/path/to/rails/app/views/books/edit&rsquo;</p>

<p>render :file =&gt; &lsquo;/path/to/rails/app/views/books/edit.html.erb&rsquo;</p>

<p>Which one you use is really a matter of style and convention, but the rule of thumb is to use the simplest one that makes sense for the code you are writing.</p>

<p><span style="font-family: DejaVu Sans;">你实际使用的格式与风格和公约有关，但一般规则是使用最简单的一个，使你正在编写的代码的意义。</span></p>

<h5><a name="using-render-with-inline"></a>2.2.6 Using <tt>render</tt> with <tt>:inline</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>（使用）</tt></span><tt>:inline</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>和</tt></span><tt>render</tt></h5>


<p>The <tt>render</tt> method can do without a view completely, if you’re willing to use the <tt>:inline</tt> option to supply ERB as part of the method call. This is perfectly valid:</p>

<p>render<span style="font-family: DejaVu Sans;">方法可以完全没有视图而（单独）使用，如果你使用</span>:inline<span style="font-family: DejaVu Sans;">选项来提供</span>ERB<span style="font-family: DejaVu Sans;">（</span>ERB<span style="font-family: DejaVu Sans;">标签）作为方法调用（的参数）。这完全合法的：</span></p>

<p>render :inline =&gt;</p>

<p>&ldquo;&lt;% products.each do |p| %&gt;&lt;p&gt;&lt;%= p.name %&gt;&lt;/p&gt;&lt;% end %&gt;&rdquo;</p>

<p>&nbsp;</p>

<p>There is seldom<span style="font-family: DejaVu Sans;">很少</span>any good reason to use this option. Mixing ERB into your controllers defeats the MVC orientation of Rails and will make it harder for other developers to follow the logic of your project. Use a separate<span style="font-family: DejaVu Sans;">单独</span>erb view instead.</p>

<p><span style="font-family: DejaVu Sans;">（很少有好的理由来使用这个选项）。在你的</span>controllers<span style="font-family: DejaVu Sans;">中复杂的</span>ERB<span style="font-family: DejaVu Sans;">使得你的</span>Rails<span style="font-family: DejaVu Sans;">（应用程序）在</span>MVC<span style="font-family: DejaVu Sans;">方面很失败，并且使得其他开发人员很难跟随你项目的逻辑。（最好）使用单个</span>erb<span style="font-family: DejaVu Sans;">视图替代。</span></p>

<p>&nbsp;</p>

<p>By default, inline rendering uses ERB. You can force it to use Builder instead with the <tt>:type</tt> option:</p>

<p><span style="font-family: DejaVu Sans;">默认情况下，</span>inline rendering<span style="font-family: DejaVu Sans;">使用</span>ERB<span style="font-family: DejaVu Sans;">。你可以使用创建器强制替代它通过</span>:type<span style="font-family: DejaVu Sans;">选项：</span></p>

<p>render :inline =&gt;</p>

<p>&ldquo;xml.p {&lsquo;Horrid coding practice!&rsquo;}&rdquo;, :type =&gt; :builder</p>

<h5><a name="rendering-text"></a>2.2.7 Rendering Text<span style="font-family: WenQuanYi Micro Hei;">渲染文本</span></h5>


<p>You can send plain text – with no markup at all – back to the browser by using the <tt>:text</tt> option to <tt>render</tt>:</p>

<p><span style="font-family: DejaVu Sans;">你可以发送纯文本<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>没有做任何标记<span style="font-family: Liberation Serif,Times New Roman,serif;">——</span>返回到浏览器通过在</span>render<span style="font-family: DejaVu Sans;">中使用</span>:text<span style="font-family: DejaVu Sans;">选项：</span></p>

<p>render :text =&gt; &ldquo;OK&rdquo;</p>

<p>Rendering pure text is most useful when you’re responding to AJAX or web service requests that are expecting something other than proper HTML.</p>

<p>Rendering<span style="font-family: DejaVu Sans;">纯文本在你回应到</span>AJAZ<span style="font-family: DejaVu Sans;">或者</span>web service<span style="font-family: DejaVu Sans;">请求的时候非常有用（因为）此时用户期待适当的</span>HTML<span style="font-family: DejaVu Sans;">以外的东西。</span></p>

<p>&nbsp;</p>

<p>By default, if you use the <tt>:text</tt> option, the text is rendered without using the current layout. If you want Rails to put the text into the current layout, you need to add the <tt>:layout</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt> option.</p>

<p><span style="font-family: DejaVu Sans;">作为默认的，如果你是用</span>:text<span style="font-family: DejaVu Sans;">选项，</span>text<span style="font-family: DejaVu Sans;">并没有被</span>render<span style="font-family: DejaVu Sans;">到当前</span>layout<span style="font-family: DejaVu Sans;">。如果你希望</span>Rails<span style="font-family: DejaVu Sans;">放置</span>text<span style="font-family: DejaVu Sans;">到当前的</span>layout<span style="font-family: DejaVu Sans;">，你需要添加</span>:layout=&gt;true<span style="font-family: DejaVu Sans;">选项。</span></p>

<h5><a name="rendering-json"></a>2.2.8 Rendering JSON<span style="font-family: WenQuanYi Micro Hei;">渲染</span>JSON</h5>


<p>JSON is a JavaScript data format used by many AJAX libraries. Rails has built-in support for converting objects to JSON and rendering that JSON back to the browser:</p>

<p>JSON<span style="font-family: DejaVu Sans;">是</span>JavaScript<span style="font-family: DejaVu Sans;">数据格式它被很多</span>AJAX<span style="font-family: DejaVu Sans;">库使用。</span>Rails<span style="font-family: DejaVu Sans;">内建支持转换对象成</span>JSON<span style="font-family: DejaVu Sans;">并且</span>rendering<span style="font-family: DejaVu Sans;">这些</span>JSON<span style="font-family: DejaVu Sans;">反馈给浏览器：</span></p>

<p>render :json =&gt; @product</p>

<p>You don’t need to call <tt>to_json</tt> on the object that you want to render. If you use the <tt>:json</tt> option, <tt>render</tt> will automatically call <tt>to_json</tt> for you.</p>

<p><span style="font-family: DejaVu Sans;">你不必对你</span>render<span style="font-family: DejaVu Sans;">的</span>object<span style="font-family: DejaVu Sans;">调用</span>to_json<span style="font-family: DejaVu Sans;">。如果你使用</span>:json<span style="font-family: DejaVu Sans;">选项，</span>render<span style="font-family: DejaVu Sans;">将会自动为你调用</span>to_json<span style="font-family: DejaVu Sans;">。</span></p>

<h5><a name="rendering-xml"></a>2.2.9 Rendering XML</h5>


<p>Rails also has built-in support for converting objects to XML and rendering that XML back to the caller:</p>

<p>render :xml =&gt; @product</p>

<p>You don’t need to call <tt>to_xml</tt> on the object that you want to render. If you use the <tt>:xml</tt> option, <tt>render</tt> will automatically call <tt>to_xml</tt> for you.</p>

<h5><a name="rendering-vanilla-javascript"></a>2.2.10 Rendering Vanilla JavaScript<span style="font-family: WenQuanYi Micro Hei;">渲染香草味的的</span>JavaScript</h5>


<p>Rails can render vanilla JavaScript:</p>

<p>render :js =&gt; &ldquo;alert(&lsquo;Hello Rails&rsquo;);&rdquo;</p>

<p><strong>This</strong><strong> </strong><strong>will</strong><strong> </strong><strong>send</strong><strong> </strong><strong>the</strong><strong> </strong><strong>supplied</strong><strong> </strong><strong>string</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><strong>browser</strong><strong> </strong><strong>with</strong><strong> </strong><strong>a</strong><strong> </strong><strong>MIME</strong><strong> </strong><strong>type</strong><strong> </strong><strong>of</strong><strong> </strong><tt><strong>text/javascript</strong></tt><strong>.</strong></p>

<h5><a name="options-for-render"></a>2.2.11 Options for <tt>render</tt></h5>


<p>Calls to the <tt>render</tt> method generally accept four options:</p>

<ul>
    <li><tt>:content_type</tt></li>
    <li><tt>:layout</tt></li>
    <li><tt>:status</tt></li>
    <li><tt>:location</tt></li>
</ul>


<h6><a name="the-content_type-option"></a>2.2.11.1 The <tt>:content_type</tt> Option</h6>


<p>By default, Rails will serve the results of a rendering operation with the MIME content-type of <tt>text/html</tt> (or <tt>application/json</tt> if you use the <tt>:json</tt> option, or <tt>application/xml</tt> for the <tt>:xml</tt> option.). There are times when you might like to change this, and you can do so by setting the <tt>:content_type</tt> option:</p>

<p><span style="font-family: DejaVu Sans;">默认情况下，</span>Rails<span style="font-family: DejaVu Sans;">将会帮助渲染操作通过使用</span><tt>text/html</tt><span style="font-family: DejaVu Sans;"><tt>的</tt><tt></tt></span><tt>MIME</tt><tt> </tt><tt>content-type</tt><span style="font-family: DejaVu Sans;"><tt>（或者如果你使用</tt></span><tt>:json</tt><span style="font-family: DejaVu Sans;"><tt>选项则是</tt></span><tt>application/json</tt><span style="font-family: DejaVu Sans;"><tt>，或者如果是</tt></span><tt>:xml</tt><span style="font-family: DejaVu Sans;"><tt>选项</tt></span><tt>application/xml</tt><span style="font-family: DejaVu Sans;"><tt>）。有时你可以改成这样，你可以通过设置</tt></span><tt>:content_type</tt><span style="font-family: DejaVu Sans;"><tt>选项达成：</tt></span></p>

<p>render :file =&gt; filename, :content_type =&gt; &lsquo;application/rss&rsquo;</p>

<h6><a name="the-layout-option"></a>2.2.11.2 The <tt>:layout</tt> Option</h6>


<p>With most of the options to <tt>render</tt>, the rendered content is displayed as part of the current layout. You’ll learn more about layouts and how to use them later in this guide.</p>

<p><span style="font-family: DejaVu Sans;">它是</span>render<span style="font-family: DejaVu Sans;">的常见的选项，通过这个选项被</span>rendered<span style="font-family: DejaVu Sans;">的内容被显示为当前</span>layout<span style="font-family: DejaVu Sans;">的一部分。在本教程的随后部分你将了解更多的</span>layouts<span style="font-family: DejaVu Sans;">的知识以及如何使用它们。</span></p>

<p>You can use the <tt>:layout</tt> option to tell Rails to use a specific file as the layout for the current action:</p>

<p>render :layout =&gt; &lsquo;special_layout&rsquo;</p>

<p>You can also tell Rails to render with no layout at all:</p>

<p>render :layout =&gt; false</p>

<h6><a name="the-status-option"></a>2.2.11.3 The <tt>:status</tt> Option</h6>


<p>Rails will automatically generate a response with the correct HTTP status code (in most cases, this is <tt>200</tt><tt> </tt><tt>OK</tt>). You can use the <tt>:status</tt> option to change this:</p>

<p>Rails<span style="font-family: DejaVu Sans;">将会自动生成（包含）正确的</span>HTTP<span style="font-family: DejaVu Sans;">状态码的响应（在大多数情况，</span>200 <span style="font-family: DejaVu Sans;">是</span>OK<span style="font-family: DejaVu Sans;">）。你可以使用</span>:status<span style="font-family: DejaVu Sans;">选项来更改这些</span>:</p>

<p>render :status =&gt; 500</p>

<h1>or</h1>

<p>render :status =&gt; :forbidden</p>

<p><strong>Rails</strong><strong> </strong><strong>understands</strong><strong> </strong><strong>both</strong><strong> </strong><strong>numeric</strong><strong> </strong><strong>status</strong><strong> </strong><strong>codes</strong><strong> </strong><strong>and</strong><strong> </strong><strong>symbols</strong><strong> </strong><strong>for</strong><strong> </strong><strong>status</strong><strong> </strong><strong>codes.</strong></p>

<h6><a name="the-location-option"></a>2.2.11.4 The <tt>:location</tt> Option</h6>


<p><strong>You</strong><strong> </strong><strong>can</strong><strong> </strong><strong>use</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:location</strong></tt><strong> </strong><strong>option</strong><strong> </strong><strong>to</strong><strong> </strong><strong>set</strong><strong> </strong><strong>the</strong><strong> </strong><strong>HTTP</strong><strong> </strong><tt><strong>Location</strong></tt><strong> </strong><strong>header:</strong></p>

<p>render :xml =&gt; photo, :location =&gt; photo_url(photo)</p>

<h5><a name="finding-layouts"></a>2.2.12 Finding Layouts</h5>


<p>To find the current layout, Rails first looks for a file in <tt>app/views/layouts</tt> with the same base name as the controller. For example, rendering actions from the <tt>PhotosController</tt> class will use <tt>app/views/layouts/photos.html.erb</tt> (or <tt>app/views/layouts/photos.builder</tt>). If there is no such controller-specific layout, Rails will use <tt>app/views/layouts/application.html.erb</tt> or <tt>app/views/layouts/application.builder</tt>. If there is no <tt>.erb</tt> layout, Rails will use a <tt>.builder</tt> layout if one exists. Rails also provides several ways to more precisely assign specific layouts to individual controllers and actions.</p>

<p><span style="font-family: DejaVu Sans;">要查找正确的</span>layout<span style="font-family: DejaVu Sans;">，</span>Rails<span style="font-family: DejaVu Sans;">首先查找</span><tt>app/views/layouts</tt><span style="font-family: DejaVu Sans;"><tt>中与</tt></span><tt>controller</tt><tt> </tt><tt>base</tt><tt> </tt><tt>name</tt><span style="font-family: DejaVu Sans;"><tt>相同的文件。</tt></span><tt>For</tt><tt> </tt><tt>example,</tt><tt> </tt><tt>rendering</tt><tt> </tt><tt>actions</tt><tt> </tt><tt>from</tt><tt> </tt><tt>the</tt><tt> </tt><tt>PhotosController</tt><tt> </tt><tt>class</tt><tt> </tt><tt>will</tt><tt> </tt><tt>use</tt><tt> </tt><tt>app/views/layouts/photos.html.erb</tt><tt> </tt><tt>(or</tt><tt> </tt><tt>app/views/layouts/photos.builder).</tt><tt> </tt><tt>If</tt><tt> </tt><tt>there</tt><tt> </tt><tt>is</tt><tt> </tt><tt>no</tt><tt> </tt><tt>such</tt><tt> </tt><tt>controller-specific</tt><tt> </tt><tt>layout,</tt><tt> </tt><tt>Rails</tt><tt> </tt><tt>will</tt><tt> </tt><tt>use</tt><tt> </tt><tt>app/views/layouts/application.html.erb</tt><tt> </tt><tt>or</tt><tt> </tt><tt>app/views/layouts/application.builder.</tt><tt> </tt><span style="font-family: DejaVu Sans;"><tt>如果没有找到</tt></span><tt>.reb</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>layout</tt><span style="font-family: DejaVu Sans;"><tt>，</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>将会使用一个</tt></span><tt>.builder</tt><span style="font-family: DejaVu Sans;"><tt>如果存在。</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>也提供一些方法来恰当的分派</tt></span><tt>assign</tt><span style="font-family: DejaVu Sans;"><tt>指定的</tt></span><tt>layouts</tt><span style="font-family: DejaVu Sans;"><tt>到个别的</tt></span><tt>controllers</tt><span style="font-family: DejaVu Sans;"><tt>和</tt></span><tt>actions</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h6><a name="specifying-layouts-on-a-per-controller-b"></a> 2.2.12.1 Specifying Layouts on a per-Controller Basis</h6>


<p>You can override the automatic layout conventions in your controllers by using the <tt>layout</tt> declaration in the controller. For example:</p>

<p><span style="font-family: DejaVu Sans;">你可以通过在</span>controller<span style="font-family: DejaVu Sans;">（类）中使用</span>layout<span style="font-family: DejaVu Sans;">决定（指定的）</span>layout<span style="font-family: DejaVu Sans;">来覆盖自动</span>layout<span style="font-family: DejaVu Sans;">公约。例如：</span></p>

<p>class ProductsController &lt; ApplicationController</p>

<p>layout &ldquo;inventory&rdquo;</p>

<h1>&hellip;</h1>

<p>end</p>

<p>With this declaration, all methods within <tt> </tt><tt>ProductsController</tt> will use <tt>app/views/layouts/inventory.html.erb</tt> for their layout.</p>

<p><span style="font-family: DejaVu Sans;">通过这个声明，在</span><tt>ProductsController</tt><span style="font-family: DejaVu Sans;"><tt>中所有的方法都将使用</tt><tt></tt></span><tt>app/views/layouts/inventory.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>作为他们的</tt></span><tt>layout</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>To assign a specific layout for the entire application, use a declaration in your <tt>ApplicationController</tt> class:</p>

<p><span style="font-family: DejaVu Sans;"><strong>要分配一个指定的</strong></span><strong>layout</strong><span style="font-family: DejaVu Sans;"><strong>给整个</strong></span><strong>application</strong><span style="font-family: DejaVu Sans;"><strong>，在你的</strong></span><tt><strong>ApplicationController</strong></tt><span style="font-family: DejaVu Sans;"><tt><strong>类（</strong></tt></span><tt><strong>app/controllers/application_controller.rb</strong></tt><span style="font-family: DejaVu Sans;"><tt><strong>）</strong></tt><strong>使用一个声明：</strong></span></p>

<p>class ApplicationController &lt; ActionController::Base</p>

<p>layout &ldquo;main&rdquo;</p>

<h1>&hellip;</h1>

<p>end</p>

<p>With this declaration, all views in the entire application will use <tt>app/views/layouts/main.html.erb</tt> for their layout.<span style="font-family: DejaVu Sans;">通过这个声明，整个应用程序中的</span>view<span style="font-family: DejaVu Sans;">将会使用</span><tt>app/views/layouts/main.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>作为他们的</tt></span><tt>layout</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<h6><a name="choosing-layouts-at-runtime"></a>2.2.12.2 Choosing Layouts at Runtime<span style="font-family: WenQuanYi Micro Hei;">在运行的时候选择</span>layout</h6>


<p>You can use a symbol to defer the choice of layout until a request is processed:</p>

<p><span style="font-family: DejaVu Sans;">你可以使用一个</span>symbol<span style="font-family: DejaVu Sans;">来推迟选择的</span>layout<span style="font-family: DejaVu Sans;">直到一个请求被处理：</span></p>

<p>class ProductsController &lt; ApplicationController</p>

<p>layout :products_layout</p>

<p>&nbsp;</p>

<p>def show</p>

<p>@product = Product.find(params[:id])</p>

<p>end</p>

<p>&nbsp;</p>

<p>private</p>

<p>def products_layout</p>

<p>@current_user.special? ? &ldquo;special&rdquo; : &ldquo;products&rdquo;</p>

<p>end</p>

<p>&nbsp;</p>

<p>end</p>

<p>Now, if the current user is a special user, they’ll get a special layout when viewing a product. You can even use an inline method to determine the layout:</p>

<p><span style="font-family: DejaVu Sans;">现在，如果当前用户是一个特殊用户，他们将得到一个特殊的</span>layout<span style="font-family: DejaVu Sans;">当其正在访问一个</span>product<span style="font-family: DejaVu Sans;">。你甚至可以使用一个内联方法来确定</span>layout<span style="font-family: DejaVu Sans;">：</span></p>

<p>You can also decide the layout by passing a Proc object, the block you give the Proc will be given the <tt>controller</tt> instance, so you can make decisions based on the current request. For example:</p>

<p><span style="font-family: DejaVu Sans;">你也可以通过一个</span>Proc object<span style="font-family: DejaVu Sans;">来决定</span>layout<span style="font-family: DejaVu Sans;">，你给出的</span>Proc<span style="font-family: DejaVu Sans;">块将会被传递给</span>controller<span style="font-family: DejaVu Sans;">实例，因此你可以在当前的请求的基础上作出（指定</span>layout<span style="font-family: DejaVu Sans;">的）决定。</span></p>

<p>class ProductsController &lt; ApplicationController</p>

<p>layout Proc.new { |controller| controller.request.xhr? ? &lsquo;popup&rsquo; : &lsquo;application&rsquo; }</p>

<p>end</p>

<h2><span style="font-family: DejaVu Sans;">块里面的内容是什么意思呢？</span></h2>

<h6><a name="conditional-layouts"></a>2.2.12.3 Conditional Layouts<span style="font-family: WenQuanYi Micro Hei;">条件</span>layouts</h6>


<p>Layouts specified at the controller level support <tt>:only</tt> and <tt>:except</tt> options that take either a method name or an array of method names which correspond to method names within the controller:</p>

<p><span style="font-family: DejaVu Sans;">在</span>controller<span style="font-family: DejaVu Sans;">级别的</span>layouts<span style="font-family: DejaVu Sans;">指定支持</span>:only and :except<span style="font-family: DejaVu Sans;">选项它们获取一个方法名或者一个方法名组成的数组它们对应于在</span>controller<span style="font-family: DejaVu Sans;">中的方法名。</span></p>

<p>class ProductsController &lt; ApplicationController</p>

<p>layout &ldquo;product&rdquo;, :except =&gt; [:index, :rss]</p>

<p>end</p>

<p>With this declaration, the <tt>product</tt> layout would be used for everything but the <tt>rss</tt> and <tt>index</tt> methods.</p>

<p><span style="font-family: DejaVu Sans;">通过这个声明，</span>product<span style="font-family: DejaVu Sans;">将会使用任何</span>layout<span style="font-family: DejaVu Sans;">但是除了</span>rss<span style="font-family: DejaVu Sans;">和</span>index<span style="font-family: DejaVu Sans;">方法。</span></p>

<h6><a name="layout-inheritance"></a>2.2.12.4 Layout Inheritance layout<span style="font-family: WenQuanYi Micro Hei;">继承</span></h6>


<p>Layouts are shared downwards in the hierarchy, and more specific layouts always override more general ones. For example:</p>

<ul>
    <li><tt>application_controller.rb</tt></li>
</ul>


<p>class ApplicationController &lt; ActionController::Base</p>

<p>layout &ldquo;main&rdquo;</p>

<p>end</p>

<ul>
    <li><tt><span style="color: #000000;"><span style="font-size: small;">posts_controller.rb</span></span></tt></li>
</ul>


<p>class PostsController &lt; ApplicationController</p>

<p>end</p>

<ul>
    <li><tt>special_</tt><tt><span style="color: #000000;"><span style="font-size: small;">posts</span></span></tt><tt>_controller.rb</tt></li>
</ul>


<p>class SpecialPostsController &lt; PostsController</p>

<p>layout &ldquo;special&rdquo;</p>

<p>end</p>

<ul>
    <li><tt><span style="color: #000000;"><span style="font-size: small;">old_posts_controller.rb</span></span></tt></li>
</ul>


<p>class OldPostsController &lt; SpecialPostsController</p>

<p>layout nil</p>

<p>&nbsp;</p>

<p>def show</p>

<p>@post = Post.find(params[:id])</p>

<p>end</p>

<p>&nbsp;</p>

<p>def index</p>

<p>@old_posts = Post.older</p>

<p>render :layout =&gt; &ldquo;old&rdquo;</p>

<p>end</p>

<h1>&hellip;</h1>

<p>end</p>

<p>In this application:</p>

<ul>
    <li>In general, views will be rendered in the <tt>main</tt> layout</li>
    <li><tt>PostsController#index</tt> will use the <tt>main</tt> layout</li>
    <li><tt>SpecialPostsController#index</tt> will use the <tt>special</tt> layout</li>
    <li><tt>OldPostsController#show</tt> will use<strong> </strong><strong>no</strong><strong> </strong><strong>layout</strong><strong> </strong><strong>at</strong><strong> </strong><strong>all</strong><strong> </strong></li>
    <li><tt>OldPostsController#index</tt> will use the <tt>old</tt> layout</li>
</ul>


<h5><a name="avoiding-double-render-errors"></a>2.2.13 Avoiding Double Render Errors<span style="font-family: WenQuanYi Micro Hei;">避免两次</span>render<span style="font-family: WenQuanYi Micro Hei;">错误</span></h5>


<p>Sooner or later, most Rails developers will see the error message “Can only render or redirect once per action”. While this is annoying, it’s relatively easy to fix. Usually it happens because of a fundamental misunderstanding of the way that <tt>render</tt> works.</p>

<p><span style="font-family: DejaVu Sans;">迟早，多大数</span>Rails<span style="font-family: DejaVu Sans;">开发人员将会看到<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>Can only render or redirect once per action”.<span style="font-family: DejaVu Sans;">当这恼人的</span>(<span style="font-family: DejaVu Sans;">消息出现的时候</span>)<span style="font-family: DejaVu Sans;">，它相当容易修复。它发生的通常情况是因为对</span>render<span style="font-family: DejaVu Sans;">工作方式的根本误解。</span></p>

<p>For example, here’s some code that will trigger this error:</p>

<p><span style="font-family: DejaVu Sans;">例如，这些代码将会触发这个错误：</span></p>

<p>def show</p>

<p>@book = Book.find(params[:id])</p>

<p>if @book.special?</p>

<p>render :action =&gt; &ldquo;special_show&rdquo;</p>

<p>end</p>

<p>render :action =&gt; &ldquo;regular_show&rdquo;</p>

<p>end</p>

<p>If <tt>@book.special?</tt> evaluates to <tt>true</tt>, Rails will start the rendering process to dump<span style="font-family: DejaVu Sans;">转储</span>the <tt>@book</tt> variable into the <tt>special_show</tt> view.<strong> </strong><strong>But</strong><strong> </strong><strong>this</strong><strong> </strong><strong>will</strong><strong> </strong><em><strong>not</strong></em><strong> </strong><strong>stop</strong><strong> </strong><strong>the</strong><strong> </strong><strong>rest</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><strong>code</strong><strong> </strong><strong>in</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>show</strong></tt><strong> </strong><strong>action</strong><strong> </strong><strong>from</strong><strong> </strong><strong>running</strong>, and <strong>when</strong><strong> </strong><strong>Rails</strong><strong> </strong><strong>hits</strong><strong> </strong><strong>the</strong><strong> </strong><strong>end</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><strong>action,</strong><strong> </strong><strong>it</strong><strong> </strong><strong>will</strong><strong> </strong><strong>start</strong><strong> </strong><strong>to</strong><strong> </strong><strong>render</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>regular_show</strong></tt><strong> </strong><strong>view</strong><strong> – </strong><strong>and</strong><strong> </strong><strong>throw</strong><strong> </strong><strong>an</strong><strong> </strong><strong>error</strong>. The solution is simple: make sure that you have only one call to <tt>render</tt> or <tt>redirect</tt> in a single code path. One thing that can help is <tt>and</tt><tt> </tt><tt>return</tt>. Here’s a patched version of the method:</p>

<p>def show</p>

<p>@book = Book.find(params[:id])</p>

<p>if @book.special?</p>

<p>render :action =&gt; &ldquo;special_show&rdquo; and return</p>

<p>end</p>

<p>render :action =&gt; &ldquo;regular_show&rdquo;</p>

<p>end</p>

<p>Make sure you use <tt>and</tt><tt> </tt><tt>return</tt> and not <tt>&amp;&amp;</tt><tt> </tt><tt>return</tt> because while the former will work, the latter will not due to operator precedence in the Ruby Language.</p>

<p><span style="font-family: DejaVu Sans;">确保你使用的是</span>and return<span style="font-family: DejaVu Sans;">而不是</span>&amp;&amp; return<span style="font-family: DejaVu Sans;">因为即使</span>former<span style="font-family: DejaVu Sans;">将会工作，然而随后的却不会那是因为</span>ruby<span style="font-family: DejaVu Sans;">语言中的运算优先操作。</span></p>

<p>irb(main):019:0&gt; 1+3 and p 3+4</p>

<p>7</p>

<p>=&gt; nil</p>

<p>irb(main):020:0&gt; 1+3 &amp;&amp; p 3+4</p>

<p>SyntaxError: compile error</p>

<p>(irb):20: syntax error, unexpected tINTEGER, expecting kDO or &lsquo;{&rsquo; or &lsquo;(&rsquo;</p>

<p>1+3 &amp;&amp; p 3+4</p>

<p>^</p>

<p>from (irb):20</p>

<p>from :0</p>

<p>irb(main):021:0&gt; 1+3 &amp;&amp;(p 3+4)</p>

<p>7</p>

<p>=&gt; nil</p>

<p>irb(main):022:0&gt; false and 3+4</p>

<p>=&gt; false</p>

<h4><a name="using-redirect_to"></a>2.3 Using <tt>redirect_to</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>使用重定向</tt></span></h4>


<p><strong>Another</strong><strong> </strong><strong>way</strong><strong> </strong><strong>to</strong><strong> </strong><strong>handle</strong><strong> </strong><strong>returning</strong><strong> </strong><strong>responses</strong><strong> </strong><strong>to</strong><strong> </strong><strong>an</strong><strong> </strong><strong>HTTP</strong><strong> </strong><strong>request</strong><strong> </strong><strong>is</strong><strong> </strong><strong>with</strong><strong> </strong><tt><strong>redirect_to</strong></tt>. As you’ve seen, <tt>render</tt> tells Rails which view (or other asset) to use in constructing a response. The <tt>redirect_to</tt> method does something completely different: it tells the browser to send a new request for a different URL. For example, you could redirect from wherever you are in your code to the index of photos in your application with this call:</p>

<p><span style="font-family: DejaVu Sans;">另一种方法是使用</span><tt>redirect_to</tt><span style="font-family: DejaVu Sans;"><tt>来处理</tt></span><tt>HTTP</tt><span style="font-family: DejaVu Sans;"><tt>请求返回响应。正如你看到的，</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>通知</tt></span><tt>Rails</tt><tt>——</tt><span style="font-family: DejaVu Sans;"><tt>视图（或者其他</tt></span><tt>asset</tt><span style="font-family: DejaVu Sans;"><tt>）使用其他（</tt></span><tt>layout</tt><span style="font-family: DejaVu Sans;"><tt>）结构来响应。</tt><tt></tt></span><tt>redirect_to</tt><span style="font-family: DejaVu Sans;"><tt>方法做一些完全不同的事情：它告诉浏览器发送一个新的请求给不同的</tt></span><tt>URL</tt><span style="font-family: DejaVu Sans;"><tt>。例如，无论你在你代码的哪里你可以重定向到</tt></span><tt>photos</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>index</tt><span style="font-family: DejaVu Sans;"><tt>，在你的应用程序中使用这个掉用：</tt></span></p>

<p><code>redirect_to</code><code> </code><code>photos_path</code></p>

<p>You can use <tt>redirect_to</tt> <strong>with</strong><strong> </strong><strong>any</strong><strong> </strong><strong>arguments</strong> that you <strong>could</strong><strong> </strong><strong>use</strong><strong> </strong><strong>with</strong><strong> </strong><tt><strong>link_to</strong></tt><strong> </strong><strong>or</strong><strong> </strong><tt><strong>url_for</strong></tt>. In addition, <strong>there</strong><strong>’</strong><strong>s</strong><strong> </strong><strong>a</strong><strong> </strong><strong>special</strong><strong> </strong><strong>redirect</strong><strong> </strong><strong>that</strong><strong> </strong><strong>sends</strong><strong> </strong><strong>the</strong><strong> </strong><strong>user</strong><strong> </strong><strong>back</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><strong>page</strong><strong> </strong><strong>they</strong><strong> </strong><strong>just</strong><strong> </strong><strong>came</strong><strong> </strong><strong>from:</strong><span style="font-family: DejaVu Sans;"><strong>这里是特殊的重定向发送（命令）给用户（的浏览器）回到原来的页面：</strong></span></p>

<p>redirect_to :back</p>

<h5><a name="getting-a-different-redirect-status-code"></a> 2.3.1 Getting a Different Redirect Status Code</h5>


<p>Rails uses HTTP status code 302 (temporary redirect) when you call <tt> </tt><tt>redirect_to</tt>. If you’d like to use a different status code (perhaps 301, permanent redirect), you can do so by using the <tt>:status</tt> option:</p>

<p>Rails<span style="font-family: DejaVu Sans;">使用</span>HTTP<span style="font-family: DejaVu Sans;">状态代码</span>301(<span style="font-family: DejaVu Sans;">临时重定向</span>)<span style="font-family: DejaVu Sans;">当你调用</span><tt>redirect_to</tt><span style="font-family: DejaVu Sans;"><tt>。如果你想使用一个不同的状态代码（可能是</tt></span><tt>301</tt><span style="font-family: DejaVu Sans;"><tt>，永久重定向），你可以通过使用</tt></span><tt>:status</tt><span style="font-family: DejaVu Sans;"><tt>选项：</tt></span></p>

<p>redirect_to photos_path, :status =&gt; 301</p>

<p>Just like the <tt>:status</tt> option for <tt>render</tt>, <tt>:status</tt> for <tt>redirect_to</tt> accepts both numeric and symbolic header designations<span style="font-family: DejaVu Sans;">名称</span>.</p>

<h5><a name="the-difference-between-render-and-redire"></a> 2.3.2 The Difference Between <tt>render</tt> and <tt>redirect_to</tt></h5>


<p>Sometimes inexperienced developers conceive of <tt>redirect_to</tt> as a sort of <tt>goto</tt> command, moving execution from one place to another in your Rails code. <strong>This</strong><strong> </strong><strong>is</strong><strong> </strong><em><strong>not</strong></em><strong> </strong><strong>correct.</strong><strong> </strong><strong>Your</strong><strong> </strong><strong>code</strong><strong> </strong><strong>stops</strong><strong> </strong><strong>running</strong><strong> </strong><strong>and</strong><strong> </strong><strong>waits</strong><strong> </strong><strong>for</strong><strong> </strong><strong>a</strong><strong> </strong><strong>new</strong><strong> </strong><strong>request</strong><strong> </strong><strong>for</strong><strong> </strong><strong>the</strong><strong> </strong><strong>browser.</strong><strong> </strong>It just happens that you’ve told the browser what request it should make next, by sending back an HTTP 302 status code.</p>

<p><span style="font-family: DejaVu Sans;">有时缺乏经验的开发人员心中构想的</span><tt>redirect_to</tt><span style="font-family: DejaVu Sans;"><tt>就像一种</tt></span><tt>goto</tt><span style="font-family: DejaVu Sans;"><tt>命令，从你的</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>代码的一个地方移动到另一个地方执行。</tt></span></p>

<p>Consider these actions to see the difference:</p>

<p>def index</p>

<p>@books = Book.all</p>

<p>end</p>

<p>&nbsp;</p>

<p>def show</p>

<p>@book = Book.find_by_id(params[:id])</p>

<p>if @book.nil?</p>

<p>render :action =&gt; &ldquo;index&rdquo;</p>

<p>end</p>

<p>end</p>

<p>With the code in this form, there will likely be a problem if the <tt>@book</tt> variable is <tt>nil</tt>. Remember, a <tt>render</tt><tt> </tt><tt>:action</tt> <strong>doesn</strong><strong>’</strong><strong>t</strong><strong> </strong><strong>run</strong><strong> </strong><strong>any</strong><strong> </strong><strong>code</strong><strong> </strong><strong>in</strong><strong> </strong><strong>the</strong><strong> </strong><strong>target</strong><strong> </strong><strong>action</strong>, so nothing will set up the <tt>@books</tt> variable that the <tt>index</tt> view is presumably<span style="font-family: DejaVu Sans;">可能</span>depending on<span style="font-family: DejaVu Sans;">（实际验证结果也就是说</span>@books<span style="font-family: DejaVu Sans;">为空）</span>. One way to fix this is to redirect instead of rendering:</p>

<p>def index</p>

<p>@books = Book.all</p>

<p>end</p>

<p>&nbsp;</p>

<p>def show</p>

<p>@book = Book.find_by_id(params[:id])</p>

<p>if @book.nil?</p>

<p>redirect_to :action =&gt; :index</p>

<p>end</p>

<p>end</p>

<p><strong>With</strong><strong> </strong><strong>this</strong><strong> </strong><strong>code,</strong><strong> </strong><strong>the</strong><strong> </strong><strong>browser</strong><strong> </strong><strong>will</strong><strong> </strong><strong>make</strong><strong> </strong><strong>a</strong><strong> </strong><strong>fresh</strong><strong> </strong><strong>request</strong><strong> </strong><strong>for</strong><strong> </strong><strong>the</strong><strong> </strong><strong>index</strong><strong> </strong><strong>page,</strong><strong> </strong><strong>the</strong><strong> </strong><strong>code</strong><strong> </strong><strong>in</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>index</strong></tt><strong> </strong><strong>method</strong><strong> </strong><strong>will</strong><strong> </strong><strong>run,</strong><strong> </strong><strong>and</strong><strong> </strong><strong>all</strong><strong> </strong><strong>will</strong><strong> </strong><strong>be</strong><strong> </strong><strong>well.</strong></p>

<p>The only downside to this code, is that it requires a round trip<span style="font-family: DejaVu Sans;">旅</span>to the browser, the browser requested the show action with <tt>/books/1</tt> and the controller finds that there are no books, so the controller sends out a 302 redirect response to the browser telling it to go to <tt>/books/</tt>, the browser complies<span style="font-family: DejaVu Sans;">依从</span>and sends a new request back to the controller asking now for the <tt>index</tt> action, the controller then gets all the books in the database and renders the index template, sending it back down to the browser which then shows it on your screen.</p>

<p><span style="font-family: DejaVu Sans;">这段代码仅有的缺点，是它需要浏览器兜一个圈，浏览器通过向服务器发送</span>/books/1<span style="font-family: DejaVu Sans;">请求</span>show action<span style="font-family: DejaVu Sans;">同时</span>controller<span style="font-family: DejaVu Sans;">发现数据库没有这本书，因此</span>controller<span style="font-family: DejaVu Sans;">发出一个</span>302<span style="font-family: DejaVu Sans;">重定向响应给浏览器告诉它导航到</span>/books/<span style="font-family: DejaVu Sans;">，浏览器依从（响应）并且发回一个新的请求来申请现在（进行）</span>index action<span style="font-family: DejaVu Sans;">，</span>controller<span style="font-family: DejaVu Sans;">随后从数据库中获取所有的</span>books<span style="font-family: DejaVu Sans;">并且</span>renders<span style="font-family: DejaVu Sans;">到</span>index template<span style="font-family: DejaVu Sans;">，发送它至浏览器然后在你的</span>screen<span style="font-family: DejaVu Sans;">得到显示。</span></p>

<p>While in a small app, this added latency might not be a problem, it is something to think about when speed of response is of the essence<span style="font-family: DejaVu Sans;">本质</span>. One way to handle this double request (though a contrived example) could be:</p>

<p><span style="font-family: DejaVu Sans;">然而在一个小的</span>app<span style="font-family: DejaVu Sans;">，加载延迟不是问题，有时候是基于响应速度为主的考虑。一种方式来处理这个两次请求（通过一个人为的例子）可以像这样：</span></p>

<p>def index</p>

<p>@books = Book.all</p>

<p>end</p>

<p>&nbsp;</p>

<p>def show</p>

<p>@book = Book.find_by_id(params[:id])</p>

<p>if @book.nil?</p>

<p>@books = Book.all</p>

<p>render &ldquo;index&rdquo;, :alert =&gt; &lsquo;Your book was not found!&rsquo;</p>

<p>end</p>

<p>end</p>

<p>Which would detect<span style="font-family: DejaVu Sans;">检测</span>that there are no books, populate<span style="font-family: DejaVu Sans;">填充</span>the <tt>@books</tt> instance variable with all the books in the database and then directly render the <tt>index.html.erb</tt> template returning it to the browser with a flash alert message telling the user what happened.</p>

<h4><a name="using-head-to-build-header-only-response"></a> 2.4 Using <tt>head</tt> To Build Header-Only Responses<span style="font-family: WenQuanYi Micro Hei;">使用</span>head<span style="font-family: WenQuanYi Micro Hei;">来创建一个</span>Header-Only<span style="font-family: WenQuanYi Micro Hei;">响应</span></h4>


<p><strong>The</strong><strong> </strong><tt><strong>head</strong></tt><strong> </strong><strong>method</strong><strong> </strong><strong>can</strong><strong> </strong><strong>be</strong><strong> </strong><strong>used</strong><strong> </strong><strong>to</strong><strong> </strong><strong>send</strong><strong> </strong><strong>responses</strong><strong> </strong><strong>with</strong><strong> </strong><strong>only</strong><strong> </strong><strong>headers</strong><strong> </strong><strong>to</strong><strong> </strong><strong>the</strong><strong> </strong><strong>browser.</strong><strong> </strong>It provides a more obvious alternative to calling <tt>render</tt><tt> </tt><tt>:nothing</tt>.<span style="font-family: DejaVu Sans;">它提供一个</span><tt>render</tt><tt> </tt><tt>:nothing</tt><span style="font-family: DejaVu Sans;"><tt>明显的替代。</tt></span>The <tt>head</tt> method takes one parameter, which is interpreted<span style="font-family: DejaVu Sans;">解释执行</span>as a hash of header names and values. For example, you can return only an error header:</p>

<p>head :bad_request</p>

<p>Which would produce the following header:</p>

<p>HTTP/1.1 400 Bad Request</p>

<p>Connection: close</p>

<p>Date: Sun, 24 Jan 2010 12:15:53 GMT</p>

<p>Transfer-Encoding: chunked</p>

<p>Content-Type: text/html; charset=utf-8</p>

<p>X-Runtime: 0.013483</p>

<p>Set-Cookie: _blog_session=&hellip;snip&hellip;; path=/; HttpOnly</p>

<p>Cache-Control: no-cache</p>

<p>Or you can use other HTTP headers to convey additional information:</p>

<p><span style="font-family: DejaVu Sans;">或者你可以使用其他的</span>HTTP headers<span style="font-family: DejaVu Sans;">来传递额外信息：</span></p>

<p>head :created, :location =&gt; photo_path(@photo)</p>

<p>Which would produce:<span style="font-family: DejaVu Sans;">这将会生成：</span></p>

<p>HTTP/1.1 201 Created</p>

<p>Connection: close</p>

<p>Date: Sun, 24 Jan 2010 12:16:44 GMT</p>

<p>Transfer-Encoding: chunked</p>

<p>Location: /photos/1</p>

<p>Content-Type: text/html; charset=utf-8</p>

<p>X-Runtime: 0.083496</p>

<p>Set-Cookie: _blog_session=&hellip;snip&hellip;; path=/; HttpOnly</p>

<p>Cache-Control: no-cache</p>

<h3><a name="structuring-layouts"></a>3 Structuring Layouts<span style="font-family: WenQuanYi Micro Hei;">结构布局</span></h3>


<p>When Rails renders a view as a response, it does so by combining the view with the current layout (using the rules for finding the current layout that were covered earlier in this guide). Within a layout, you have access to three tools for combining different bits of output to form the overall response:</p>

<p><span style="font-family: DejaVu Sans;">当</span>Rails<span style="font-family: DejaVu Sans;">渲染一个视图作为响应，它这样做了通过联合视图和当前的</span>layout<span style="font-family: DejaVu Sans;">（使用规则来查找当前的</span>layout<span style="font-family: DejaVu Sans;">，它在这个教程的早期被介绍了）。在一个</span>layout<span style="font-family: DejaVu Sans;">中，你访问三种工具来整合不同的输出块，以形成整体的回应：</span></p>

<ul>
    <li>Asset tags</li>
    <li><tt>yield</tt> and <tt>content_for</tt></li>
    <li>Partials</li>
</ul>


<h4><a name="asset-tags"></a>3.1 Asset Tags<span style="font-family: WenQuanYi Micro Hei;">标签资源</span></h4>


<p>Asset tags provide methods for generating HTML that links views to feeds, JavaScript, stylesheets, images, videos and audios. These are the six asset tags available in Rails:</p>

<p><span style="font-family: DejaVu Sans;">标签资产提供方法来创建</span>HTML<span style="font-family: DejaVu Sans;">链接视图到</span>feeds<span style="font-family: DejaVu Sans;">，</span>JavaScript<span style="font-family: DejaVu Sans;">，</span>stylesheets<span style="font-family: DejaVu Sans;">，</span>images<span style="font-family: DejaVu Sans;">，</span>videos<span style="font-family: DejaVu Sans;">和</span>audios<span style="font-family: DejaVu Sans;">。</span>Rails<span style="font-family: DejaVu Sans;">中有六个</span>asset tags<span style="font-family: DejaVu Sans;">可用。</span></p>

<ul>
    <li><tt>auto_discovery_link_tag</tt></li>
    <li><tt>javascript_include_tag</tt></li>
    <li><tt>stylesheet_link_tag</tt></li>
    <li><tt>image_tag</tt></li>
    <li><tt>video_tag</tt></li>
    <li><tt>audio_tag</tt></li>
</ul>


<p>You can use these tags in layouts or other views, although the tags other than <tt>image_tag</tt> are most commonly used in the <tt>&lt;head&gt;</tt> section of a layout.</p>

<p><span style="font-family: DejaVu Sans;">你可以使用这些</span>tags<span style="font-family: DejaVu Sans;">在</span>layout<span style="font-family: DejaVu Sans;">或者其他的</span>views<span style="font-family: DejaVu Sans;">，即使</span>tags <tt>image_tag</tt><span style="font-family: DejaVu Sans;">超过通常使用的在</span>layout<span style="font-family: DejaVu Sans;">的</span>&lt;head&gt;<span style="font-family: DejaVu Sans;">部分使用。</span></p>

<p>The asset tags do <em>not</em> verify the existence of the assets at the specified locations; they simply assume<span style="font-family: DejaVu Sans;">假设</span>that you know what you’re doing and generate the link.</p>

<p>Asset tags<span style="font-family: DejaVu Sans;">并不验证</span>asstes<span style="font-family: DejaVu Sans;">存在的性在</span>specified locations<span style="font-family: DejaVu Sans;">；他们假设你知道他们正在做的什么并且生成链接。</span></p>

<h5><a name="linking-to-feeds-with-auto_discovery_lin"></a> 3.1.1 Linking to Feeds with <tt>auto_discovery_link_tag</tt></h5>


<p>The <tt>auto_discovery_link_tag</tt> helper builds HTML that most browsers and newsreaders can use to detect the presences of RSS or ATOM feeds. It takes the type of the link (<tt>:rss</tt> or <tt>:atom</tt>), a hash of options that are passed through to url_for, and a hash of options for the tag:</p>

<p><span style="font-family: DejaVu Sans;">对于</span><tt>auto_discovery_link_tag</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>创建</tt></span><tt>HTML</tt><span style="font-family: DejaVu Sans;"><tt>，那些浏览器和新读者能够检测存在的</tt></span><tt>RSS</tt><span style="font-family: DejaVu Sans;"><tt>或者</tt></span><tt>ATOM</tt><span style="font-family: DejaVu Sans;"><tt>。它带有</tt></span><tt>link</tt><span style="font-family: DejaVu Sans;"><tt>类型的参数为</tt></span><tt>(:rss</tt><tt> </tt><tt>or</tt><tt> </tt><tt>:atom)</tt><span style="font-family: DejaVu Sans;"><tt>，一个</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>字典的选项可以通过它来指定</tt><tt></tt></span><tt>url_for</tt><span style="font-family: DejaVu Sans;"><tt>以及</tt></span><tt>tag</tt><span style="font-family: DejaVu Sans;"><tt>的</tt></span><tt>hash</tt><span style="font-family: DejaVu Sans;"><tt>选项。</tt></span></p>

<p>&lt;%= auto_discovery_link_tag(:rss, {:action =&gt; &ldquo;feed&rdquo;},</p>

<p>{:title =&gt; &ldquo;RSS Feed&rdquo;}) %&gt;</p>

<p>There are three tag options available for <tt>auto_discovery_link_tag</tt>:</p>

<ul>
    <li><tt>:rel</tt> specifies the <tt>rel</tt> value in the link (defaults to “alternate”)</li>
    <li><tt>:type</tt> specifies an explicit MIME type. Rails will generate an appropriate MIME type automatically.</li>
    <li><tt>:title</tt> specifies the title of the link</li>
</ul>


<p>MIME<span style="font-family: DejaVu Sans;">类型就是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。</span></p>

<h5><a name="linking-to-javascript-files-with-javascr"></a> 3.1.2 Linking to JavaScript Files with <tt>javascript_include_tag</tt></h5>


<p>The <tt>javascript_include_tag</tt> helper returns an HTML <tt>script</tt> tag for each source provided. Rails looks in <tt>public/javascripts</tt> for these files by default, but you can specify a full path relative to the document root, or a URL, if you prefer. For example, to include <tt>public/javascripts/main.js</tt>:</p>

<p><tt>javascript_include_tag</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>返回一个</tt></span><tt>HTML</tt><tt> </tt><tt>script</tt><tt> </tt><tt>tag</tt><span style="font-family: DejaVu Sans;"><tt>给每个提供的源。</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>默认在</tt><tt></tt></span><tt>public/javascripts</tt><span style="font-family: DejaVu Sans;"><tt>查找这些文件，但是你可以指定一个全路径关联到文档目录，或者一个</tt></span><tt>URL</tt><span style="font-family: DejaVu Sans;"><tt>，如果你喜欢。例如，要包含</tt></span><tt>public/javascripts/main.js:</tt></p>

<p>&lt;%= javascript_include_tag &ldquo;main&rdquo; %&gt;</p>

<p>To include <tt>public/javascripts/main.js</tt> and <tt>public/javascripts/columns.js</tt>:</p>

<p>&lt;%= javascript_include_tag &ldquo;main&rdquo;, &ldquo;columns&rdquo; %&gt;</p>

<p>To include <tt>public/javascripts/main.js</tt> and <tt>public/photos/columns.js</tt>:</p>

<p>&lt;%= javascript_include_tag &ldquo;main&rdquo;, &ldquo;/photos/columns&rdquo; %&gt;</p>

<p>To include <tt><a href="http://example.com/main.js">http://example.com/main.js</a></tt>:</p>

<p>&lt;%= javascript_include_tag &ldquo;<a href="http://example.com/main.js">http://example.com/main.js</a>&rdquo; %&gt;</p>

<p>If the application does not use the asset pipeline, the <tt>:defaults</tt> option loads jQuery by default:</p>

<p><span style="font-family: DejaVu Sans;">如果应用程序没有使用</span>asset<span style="font-family: DejaVu Sans;">管道，</span>:defautls<span style="font-family: DejaVu Sans;">选项默认导入</span>jQuery<span style="font-family: DejaVu Sans;">：</span></p>

<p>&lt;%= javascript_include_tag :defaults %&gt;</p>

<p>And you can in any case override the expansion in <tt>config/application.rb</tt>:</p>

<p><span style="font-family: DejaVu Sans;">并且你可以随意覆盖这个扩展在</span><tt>config/application.rb</tt><span style="font-family: DejaVu Sans;"><tt>：</tt></span></p>

<p>config.action_view.javascript_expansions[:defaults] = %w(foo.js bar.js)</p>

<p>When using <tt>:defaults</tt>, if an <tt>application.js</tt> file exists in <tt>public/javascripts</tt> it will be included as well at then end.</p>

<p><span style="font-family: DejaVu Sans;">如果使用</span>:defaults<span style="font-family: DejaVu Sans;">，如果一个</span>application.js<span style="font-family: DejaVu Sans;">文件存在于</span>public/javascripts<span style="font-family: DejaVu Sans;">他将会同样被导入在随后。</span></p>

<p>Also, the <tt>:all</tt> option loads every JavaScript file in <tt>public/javascripts</tt>:<span style="font-family: DejaVu Sans;">（不包含子目录）</span></p>

<p>&lt;%= javascript_include_tag :all %&gt;</p>

<p>Note that your defaults of choice will be included first, so they will be available to all subsequently<span style="font-family: DejaVu Sans;">随后</span>included files.</p>

<p><span style="font-family: DejaVu Sans;">注意你默认的选择将会首先被</span>inclueded<span style="font-family: DejaVu Sans;">，因此他们将于随后导入所有的文件。</span></p>

<p>You can supply the <tt>:recursive</tt> option to load files in subfolders of <tt>public/javascripts</tt> as well:</p>

<p><span style="font-family: DejaVu Sans;">你也可以提供</span>:recursive<span style="font-family: DejaVu Sans;">（递归）选项来导入在</span><tt>public/javascripts</tt> <span style="font-family: DejaVu Sans;">子文件夹中的文件：</span></p>

<p>&lt;%= javascript_include_tag :all, :recursive =&gt; true %&gt;</p>

<p>If you’re loading multiple JavaScript files, you can create a better user experience by combining multiple files into a single download. To make this happen in production, specify <tt>:cache</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt> in your <tt>javascript_include_tag</tt>:</p>

<p><span style="font-family: DejaVu Sans;">如果你正在导入多个的</span>JavaScript<span style="font-family: DejaVu Sans;">文件，你可以创建一个更好的用户体验通过整合多个文件到一个单独的下载（</span>all.js<span style="font-family: DejaVu Sans;">）。要得到这样的效果在产品中，在你的</span><tt>javascript_include_tag</tt><span style="font-family: DejaVu Sans;"><tt>中</tt>指定</span><tt>:cache</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt></p>

<p>&lt;%= javascript_include_tag &ldquo;main&rdquo;, &ldquo;columns&rdquo;, :cache =&gt; true %&gt;</p>

<p>You can even use dynamic paths such as <tt>cache/#{current_site}/main/display</tt>.</p>

<p><span style="font-family: DejaVu Sans;">你可以使用多元路径例如</span><tt>cache/#{current_site}/main/display</tt></p>

<h5><a name="linking-to-css-files-with-stylesheet_lin"></a> 3.1.3 Linking to CSS Files with <tt>stylesheet_link_tag</tt></h5>


<p>The <tt>stylesheet_link_tag</tt> helper returns an HTML <tt>&lt;link&gt;</tt> tag for each source provided. Rails looks in <tt>public/stylesheets</tt> for these files by default, but you can specify a full path relative to the document root, or a URL, if you prefer. For example, to include <tt>public/stylesheets/main.css</tt>:</p>

<p><tt>stylesheet_link_tag</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>返回一个</tt></span><tt>HTML</tt><tt> </tt><tt>&lt;link&gt;</tt><span style="font-family: DejaVu Sans;"><tt>标签给每一个提供的源。</tt></span><tt>Rails</tt><span style="font-family: DejaVu Sans;"><tt>默认在</tt><tt></tt></span><tt>public/stylesheets</tt><span style="font-family: DejaVu Sans;"><tt>查找这些文件，但是你可以指定一个全路径关联到文档目录，或者一个</tt></span><tt>URL</tt><span style="font-family: DejaVu Sans;"><tt>，如果你喜欢。例如，要导入</tt></span><tt>public/stylesheets/main.css:</tt></p>

<p>&lt;%= stylesheet_link_tag &ldquo;main&rdquo; %&gt;</p>

<p>To include <tt>public/stylesheets/main.css</tt> and <tt>public/stylesheets/columns.css</tt>:</p>

<p>&lt;%= stylesheet_link_tag &ldquo;main&rdquo;, &ldquo;columns&rdquo; %&gt;</p>

<p>To include <tt>public/stylesheets/main.css</tt> and <tt>public/photos/columns.css</tt>:</p>

<p>&lt;%= stylesheet_link_tag &ldquo;main&rdquo;, &ldquo;/photos/columns&rdquo; %&gt;</p>

<p>To include <tt><a href="http://example.com/main.css">http://example.com/main.css</a></tt>:</p>

<p>&lt;%= stylesheet_link_tag &ldquo;<a href="http://example.com/main.css">http://example.com/main.css</a>&rdquo; %&gt;</p>

<p>By default, <tt>stylesheet_link_tag</tt> creates links with <tt>media=&ldquo;screen&rdquo;</tt><tt> </tt><tt>rel=&ldquo;stylesheet&rdquo;</tt><tt> </tt><tt>type=&ldquo;text/css&rdquo;</tt>. You can override any of these defaults by specifying an appropriate option (<tt>:media</tt>, <tt>:rel</tt>, or <tt>:type</tt>):</p>

<p><span style="font-family: DejaVu Sans;">默认情况，</span><tt>stylesheet_link_tag</tt><span style="font-family: DejaVu Sans;"><tt>创建</tt></span><tt>links</tt><span style="font-family: DejaVu Sans;"><tt>使用</tt></span><tt>media=&ldquo;screen&rdquo;</tt><tt> </tt><tt>rel=&ldquo;stylesheet&rdquo;</tt><tt> </tt><tt>type=&ldquo;text/css&rdquo;</tt><span style="font-family: DejaVu Sans;"><tt>。你可以覆盖这些默认设置的任何一个通过指定一个适当的选项</tt><tt></tt></span><tt>(:media,</tt><tt> </tt><tt>:rel,</tt><tt> </tt><tt>or</tt><tt> </tt><tt>:type):</tt></p>

<p>&lt;%= stylesheet_link_tag &ldquo;main_print&rdquo;, :media =&gt; &ldquo;print&rdquo; %&gt;</p>

<p>The <tt>all</tt> option links every CSS file in <tt>public/stylesheets</tt>:<span style="font-family: DejaVu Sans;">（不包含子目录）</span></p>

<p>&lt;%= stylesheet_link_tag :all %&gt;</p>

<p>You can supply the <tt>:recursive</tt> option to link files in subfolders of <tt>public/stylesheets</tt> as well:<span style="font-family: DejaVu Sans;">（递归导入</span><tt>public/stylesheets</tt><span style="font-family: DejaVu Sans;"><tt>所有的样式</tt>）</span></p>

<p>&lt;%= stylesheet_link_tag :all, :recursive =&gt; true %&gt;</p>

<p>If you’re loading multiple CSS files, you can create a better user experience by combining multiple files into a single download. To make this happen in production, specify <tt>:cache</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt> in your <tt>stylesheet_link_tag</tt>:<span style="font-family: DejaVu Sans;">（使用</span>cache<span style="font-family: DejaVu Sans;">来改善用户体验）</span></p>

<p>&lt;%= stylesheet_link_tag &ldquo;main&rdquo;, &ldquo;columns&rdquo;, :cache =&gt; true %&gt;</p>

<p>By default, the combined file will be delivered as <tt>stylesheets/all.css</tt>. You can specify a location for the cached asset file instead:</p>

<p><span style="font-family: DejaVu Sans;">默认情况下组合文件会交付为</span><tt>stylesheets/all.css</tt><span style="font-family: DejaVu Sans;"><tt>。你可以指定一个</tt></span><tt>lacation</tt><span style="font-family: DejaVu Sans;"><tt>给</tt></span><tt>cached</tt><tt> </tt><tt>asset</tt><span style="font-family: DejaVu Sans;"><tt>文件替代：</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>stylesheet_link_tag</tt><tt> </tt><tt>&ldquo;main&rdquo;,</tt><tt> </tt><tt>&ldquo;columns&rdquo;,</tt></p>

<p><tt> </tt><tt>:cache</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&lsquo;cache/main/display&rsquo;</tt><tt> </tt><tt>%&gt;</tt></p>

<p>You can even use dynamic paths such as <tt>cache/#{current_site}/main/display.</tt></p>

<h5><a name="linking-to-images-with-image_tag"></a><tt>3.1.4</tt><tt> </tt><tt>Linking</tt><tt> </tt><tt>to</tt><tt> </tt><tt>Images</tt><tt> </tt><tt>with</tt><tt> </tt><tt>image_tag</tt></h5>


<p>The <tt>image_tag</tt> helper builds an HTML <tt>&lt;img</tt><tt> </tt><tt>/&gt;</tt> tag to the specified file. By default, files are loaded from <tt>public/images</tt>.</p>

<p><tt>image_tag</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>对于指定的文件创建一个</tt></span><tt>HTML</tt><tt> </tt><tt>&lt;img</tt><tt> </tt><tt>/&gt;</tt><span style="font-family: DejaVu Sans;"><tt>标签。默认情况，文件会从</tt><tt></tt></span><tt>public/images</tt><span style="font-family: DejaVu Sans;"><tt>被导入。</tt></span></p>

<p><span style="color: #800000;">Note</span><span style="color: #800000;">that</span><span style="color: #800000;">you</span><span style="color: #800000;">must</span><span style="color: #800000;">specify</span><span style="color: #800000;">the</span><span style="color: #800000;">extension</span><span style="color: #800000;">of</span><span style="color: #800000;">the</span><span style="color: #800000;">image.</span><span style="color: #800000;">Previous</span><span style="color: #800000;">versions</span><span style="color: #800000;">of</span><span style="color: #800000;">Rails</span><span style="color: #800000;">would</span><span style="color: #800000;">allow</span><span style="color: #800000;">you</span><span style="color: #800000;">to</span><span style="color: #800000;">just</span><span style="color: #800000;">use</span><span style="color: #800000;">the</span><span style="color: #800000;">image</span><span style="color: #800000;">name</span><span style="color: #800000;">and</span><span style="color: #800000;">would</span><span style="color: #800000;">append</span><tt><span style="color: #800000;">.png</span></tt><span style="color: #800000;">if</span><span style="color: #800000;">no</span><span style="color: #800000;">extension</span><span style="color: #800000;">was</span><span style="color: #800000;">given</span><span style="color: #800000;">but</span><span style="color: #800000;">Rails</span><span style="color: #800000;">3.0</span><span style="color: #800000;">does</span><span style="color: #800000;">not.</span></p>

<p><span style="font-family: DejaVu Sans;"><span style="color: #800000;">注意你必须指定图像文件的扩展名。以前版本的</span></span><span style="color: #800000;">Rails<span style="font-family: DejaVu Sans;">能够允许你仅仅使用图像文件名称就会被添加</span></span><span style="color: #800000;">.png<span style="font-family: DejaVu Sans;">即使没有扩增名被给出。但是</span></span><span style="color: #800000;">Rails</span><span style="color: #800000;">3.0<span style="font-family: DejaVu Sans;">不这样了</span>。</span></p>

<p>&lt;%= image_tag &ldquo;header.png&rdquo; %&gt;</p>

<p>You can supply a path to the image if you like:</p>

<p><span style="font-family: DejaVu Sans;">你可以给</span>image<span style="font-family: DejaVu Sans;">提供一个路径如果你喜欢：</span></p>

<p>&lt;%= image_tag &ldquo;icons/delete.gif&rdquo; %&gt;</p>

<p>You can supply a hash of additional HTML options:</p>

<p><code>&lt;%=</code> <code>image_tag</code><code> </code><code>&ldquo;icons/delete.gif&rdquo;,</code><code> </code><code>{:height</code> <code>=&gt;</code><code> </code><code>45}</code><code> </code><code>%&gt;</code></p>

<p>You can also supply an alternate image to show on mouseover:<span style="font-family: DejaVu Sans;">你可以提供一个在鼠标经过的备用图像。</span></p>

<p>&lt;%= image_tag &ldquo;home.gif&rdquo;, :onmouseover =&gt; &ldquo;menu/home_highlight.gif&rdquo; %&gt;</p>

<p>You can supply alternate text for the image which will be used if the user has images turned off in their browser. If you do not specify an alt text explicitly, it defaults to the file name of the file, capitalized and with no extension. For example, these two image tags would return the same code:</p>

<p><span style="font-family: DejaVu Sans;">你可以提供一个备用文字给</span>image<span style="font-family: DejaVu Sans;">它们将在用户的浏览器关闭图像（显示）的时候使用。如果你不准确的指定一个</span>alt<span style="font-family: DejaVu Sans;">文本，它默认是文件的文件名，大写（首字母）并且没有扩展名。例如，下面的两个</span>image<span style="font-family: DejaVu Sans;">标签将会返回同样的代码：</span></p>

<p>&lt;%= image_tag &ldquo;home.gif&rdquo; %&gt;</p>

<p>&lt;%= image_tag &ldquo;home.gif&rdquo;, :alt =&gt; &ldquo;Home&rdquo; %&gt;</p>

<p>You can also specify a special size tag, in the format “{width}x{height}”:</p>

<p>&lt;%= image_tag &ldquo;home.gif&rdquo;, :size =&gt; &ldquo;50x20&rdquo; %&gt;</p>

<p>In addition to the above special tags, you can supply a final hash of standard HTML options, such as <tt>:class</tt>, <tt>:id</tt> or <tt>:name</tt>:</p>

<p>&lt;%= image_tag &ldquo;home.gif&rdquo;, :alt =&gt; &ldquo;Go Home&rdquo;,</p>

<p>:id =&gt; &ldquo;HomeImage&rdquo;,</p>

<p>:class =&gt; &lsquo;nav_bar&rsquo; %&gt;</p>

<h5><a name="linking-to-videos-with-video_tag"></a>3.1.5 Linking to Videos with <tt>video_tag</tt></h5>


<p>The <tt>video_tag</tt> helper builds an HTML 5 <tt>&lt;video&gt;</tt> tag to the specified file. By default, files are loaded from <tt>public/videos</tt>.</p>

<p><tt>video_tag</tt><tt> </tt><tt>helper</tt><span style="font-family: DejaVu Sans;"><tt>给指定文件创建一个</tt></span><tt>HTML</tt><tt> </tt><tt>5</tt><tt> </tt><tt>&lt;video&gt;</tt><span style="font-family: DejaVu Sans;"><tt>标签。默认的，文件会从</tt><tt></tt></span><tt>public/videos</tt><span style="font-family: DejaVu Sans;"><tt>被导入。</tt></span></p>

<p>&lt;%= video_tag &ldquo;movie.ogg&rdquo; %&gt;</p>

<p>Produces<span style="font-family: DejaVu Sans;">生成</span></p>

<p>&lt;video src=&ldquo;/videos/movie.ogg&rdquo; /&gt;</p>

<p>Like an <tt>image_tag</tt> you can supply a path, either absolute, or relative to the <tt>public/videos</tt> directory. <strong>Additionally</strong><strong> </strong><strong>you</strong><strong> </strong><strong>can</strong><strong> </strong><strong>specify</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:size</strong></tt><tt><strong> </strong></tt><tt><strong>=&gt;</strong></tt><tt><strong> </strong></tt><tt><strong>&ldquo;#{width}x#{height}&rdquo;</strong></tt><strong> </strong><strong>option</strong><strong> </strong><strong>just</strong><strong> </strong><strong>like</strong><strong> </strong><strong>an</strong><strong> </strong><tt><strong>image_tag</strong></tt><strong>.</strong> <strong>Video</strong><strong> </strong><strong>tags</strong><strong> </strong><strong>can</strong><strong> </strong><strong>also</strong><strong> </strong><strong>have</strong><strong> </strong><strong>any</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><strong>HTML</strong><strong> </strong><strong>options</strong><strong> </strong><strong>specified</strong><strong> </strong><strong>at</strong><strong> </strong><strong>the</strong><strong> </strong><strong>end</strong> (<tt>id</tt>, <tt>class</tt> et al).</p>

<p>The video tag also supports all of the <tt>&lt;video&gt;</tt> HTML options through the HTML options hash, including:</p>

<p>video<span style="font-family: DejaVu Sans;">标签同样支持所有的</span><tt>&lt;video&gt;</tt> HTML<span style="font-family: DejaVu Sans;">选项通过</span>HTML<span style="font-family: DejaVu Sans;">选项的</span>hash<span style="font-family: DejaVu Sans;">字典，包含：</span></p>

<ul>
    <li><tt>:poster</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&#8216;image_name.png&#8217;</tt>, provides an image to put in place of the video before it starts playing.</li>
    <li><tt>:autoplay</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>, starts playing the video on page load.</li>
    <li><tt>:loop</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>, loops the video once it gets to the end.</li>
    <li><tt>:controls</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>, provides browser supplied controls for the user to interact with the video.</li>
    <li><tt>:autobuffer</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>, the video will pre load the file for the user on page load.</li>
</ul>


<p>You can also specify multiple videos to play by passing an array of videos to the <tt>video_tag</tt>:</p>

<p>&lt;%= video_tag [&ldquo;trailer.ogg&rdquo;, &ldquo;movie.ogg&rdquo;] %&gt;</p>

<p>This will produce:</p>

<p>&lt;video&gt;&lt;source src=&ldquo;trailer.ogg&rdquo; /&gt;&lt;source src=&ldquo;movie.ogg&rdquo; /&gt;&lt;/video&gt;</p>

<h5><a name="linking-to-audio-files-with-audio_tag"></a> 3.1.6 Linking to Audio files with <tt>audio_tag</tt></h5>


<p>The <tt>audio_tag</tt> helper builds an HTML 5 <tt>&lt;audio&gt;</tt> tag to the specified file. By default, files are loaded from <tt>public/audios</tt>.</p>

<p>&lt;%= audio_tag &ldquo;music.mp3&rdquo; %&gt;</p>

<p>You can supply a path to the audio file if you like:</p>

<p>&lt;%= audio_tag &ldquo;music/first_song.mp3&rdquo; %&gt;</p>

<p>You can also supply a hash of additional options, such as <tt>:id</tt>, <tt>:class</tt> etc.</p>

<p>Like the <tt>video_tag</tt>, the <tt>audio_tag</tt> has special options:</p>

<ul>
    <li><tt>:autoplay</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>, starts playing the audio on page load</li>
    <li><tt>:controls</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>, provides browser supplied controls for the user to interact with the audio.</li>
    <li><tt>:autobuffer</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>true</tt>, the audio will pre load the file for the user on page load.</li>
</ul>


<h4><a name="understanding-yield"></a>3.2 Understanding <tt>yield</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>未知的</tt></span><tt>yield</tt></h4>


<p>Within the context of a layout, <tt>yield</tt> identifies a section where content from the view should be inserted. The simplest way to use this is to have a single <tt>yield</tt>, into which the entire contents of the view currently being rendered is inserted:</p>

<p><span style="font-family: DejaVu Sans;">在</span>layout<span style="font-family: DejaVu Sans;">的</span>context<span style="font-family: DejaVu Sans;">（上下文）中，</span>yield<span style="font-family: DejaVu Sans;">表示一节来自</span>view<span style="font-family: DejaVu Sans;">的内容将会被插入。最简单的方法来使用这个是有一个</span>yield<span style="font-family: DejaVu Sans;">，视图的整个内容将会被</span>rendered <span style="font-family: DejaVu Sans;">插入。</span></p>

<p>&lt;html&gt;</p>

<p>&lt;head&gt;</p>

<p>&lt;/head&gt;</p>

<p>&lt;body&gt;</p>

<p>&lt;%= yield %&gt;</p>

<p>&lt;/body&gt;</p>

<p>&lt;/html&gt;</p>

<p>You can also create a layout with multiple yielding regions:<span style="font-family: DejaVu Sans;">你也可以创建一个</span>layout<span style="font-family: DejaVu Sans;">有多个</span>yield<span style="font-family: DejaVu Sans;">区域。</span></p>

<p>&lt;html&gt;</p>

<p>&lt;head&gt;</p>

<p>&lt;%= yield :head %&gt;</p>

<p>&lt;/head&gt;</p>

<p>&lt;body&gt;</p>

<p>&lt;%= yield %&gt;</p>

<p>&lt;/body&gt;</p>

<p>&lt;/html&gt;</p>

<p>The main body of the view will always render into the unnamed <tt>yield</tt>. To render content into a named <tt>yield</tt>, you use the <tt>content_for</tt> method.</p>

<p><span style="font-family: DejaVu Sans;">视图的</span>body<span style="font-family: DejaVu Sans;">将会总是</span>render<span style="font-family: DejaVu Sans;">一个</span>unnamed yield<span style="font-family: DejaVu Sans;">。要</span>render<span style="font-family: DejaVu Sans;">内容给一个知名的</span>yield<span style="font-family: DejaVu Sans;">，使用</span><tt>content_for</tt><span style="font-family: DejaVu Sans;"><tt>方法。</tt></span></p>

<h4><a name="using-content_for"></a>3.3 Using <tt>content_for</tt></h4>


<p>The <tt>content_for</tt> method allows you to insert content into a named <tt>yield</tt> block in your layout. For example, this view would work with the layout that you just saw:</p>

<p><tt>content_for</tt><span style="font-family: DejaVu Sans;"><tt>允许你插入内容到知名的</tt></span><tt>yield</tt><span style="font-family: DejaVu Sans;"><tt>块到你的</tt></span><tt>layout</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>&lt;% content_for :head do %&gt;</p>

<p>&lt;title&gt;A simple page&lt;/title&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;Hello, Rails!&lt;/p&gt;</p>

<p>The result of rendering this page into the supplied layout would be this HTML:</p>

<p>&lt;html&gt;</p>

<p>&lt;head&gt;</p>

<p>&lt;title&gt;A simple page&lt;/title&gt;</p>

<p>&lt;/head&gt;</p>

<p>&lt;body&gt;</p>

<p>&lt;p&gt;Hello, Rails!&lt;/p&gt;</p>

<p>&lt;/body&gt;</p>

<p>&lt;/html&gt;</p>

<p>The <tt>content_for</tt> method is very helpful when your layout contains distinct regions such as sidebars and footers that should get their own blocks of content inserted. It’s also useful for inserting tags that load page-specific JavaScript or css files into the header of an otherwise generic layout.</p>

<h4><a name="using-partials"></a>3.4 Using Partials</h4>


<p>Partial templates – usually just called “partials” – are another device for breaking the rendering process into more manageable chunks. With a partial, you can move the code for rendering a particular piece of a response to its own file.</p>

<p>Partial templates-<span style="font-family: DejaVu Sans;">通常被称为<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span></span>partials”-<span style="font-family: DejaVu Sans;">是另一个设备（单元）分解渲染过程到易于管理的多个块中。通过一个</span>partial<span style="font-family: DejaVu Sans;">，你可以渲染了一个特定块的文件，通过</span>respense<span style="font-family: DejaVu Sans;">这个文件来响应特定的代码。</span></p>

<h5><a name="naming-partials"></a>3.4.1 Naming Partials<span style="font-family: WenQuanYi Micro Hei;">命名</span>Partials</h5>


<p>To render a partial as part of a view, you use the <tt>render</tt> method within the view:</p>

<p>&lt;%= render &ldquo;menu&rdquo; %&gt;</p>

<p>This will render a file named <tt>_menu.html.erb</tt> at that point within the view being rendered. Note the leading underscore character: partials are named with a leading underscore<span style="font-family: DejaVu Sans;">下划线</span>to distinguish<span style="font-family: DejaVu Sans;">区分</span>them from regular views, even though they are referred to without the underscore. This holds true even when you’re pulling in a partial from another folder:</p>

<p><span style="font-family: DejaVu Sans;">这将会</span>render<span style="font-family: DejaVu Sans;">一个名为</span><tt><em>menu.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>的文件在渲染视图的</tt></span><tt>Partials</tt><span style="font-family: DejaVu Sans;"><tt>插入点的时候。注意起始的下划线字符：</tt></span><tt><span style="color: #800000;"><strong>partials</strong></span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;"><strong>被命名为以下划线（</strong></span></tt></span><tt><span style="color: #800000;"><strong>&lsquo;</em>&rsquo;</strong></span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;"><strong>）开始的规则来区分它们和视图</strong></span></tt><tt>，即使他们（的调用没有下划线）。这在你从除当前视图所在文件夹之外调入也一样成立：</tt></span></p>

<p><tt>&lt;%=</tt><tt> </tt><tt>render</tt><tt> </tt><tt>&ldquo;shared/menu&rdquo;</tt><tt> </tt><tt>%&gt;</tt></p>

<p>That code will pull in the partial from <tt>app/views/shared/_menu.html.erb</tt>.</p>

<h5><a name="using-partials-to-simplify-views"></a>3.4.2 Using Partials to Simplify Views</h5>


<p>One way to use partials is to treat them as the equivalent of subroutines: as a way to move details out of a view so that you can grasp what’s going on more easily. For example, you might have a view that looked like this:</p>

<p>&lt;%= render &ldquo;shared/ad_banner&rdquo; %&gt;</p>

<p>&nbsp;</p>

<p>&lt;h1&gt;Products&lt;/h1&gt;</p>

<p>&nbsp;</p>

<p>&lt;p&gt;Here are a few of our fine products:&lt;/p&gt;</p>

<p>&hellip;</p>

<p>&nbsp;</p>

<p>&lt;%= render &ldquo;shared/footer&rdquo; %&gt;</p>

<p>Here,<strong> </strong><strong>the</strong><strong> </strong><tt><strong><em>ad_banner.html.erb</strong></tt><strong> </strong><strong>and</strong><strong> </strong><tt><strong></em>footer.html.erb</strong></tt><strong> </strong><strong>partials</strong><strong> </strong><strong>could</strong><strong> </strong><strong>contain</strong><strong> </strong><strong>content</strong><strong> </strong><strong>that</strong><strong> </strong><strong>is</strong><strong> </strong><strong>shared</strong><strong> </strong><strong>among</strong><strong> </strong><strong>many</strong><strong> </strong><strong>pages</strong><strong> </strong><strong>in</strong><strong> </strong><strong>your</strong><strong> </strong><strong>application.</strong> You don’t need to see the details of these sections when you’re concentrating on a particular page.</p>

<p>For content that is shared among all pages in your application, you can use partials directly from layouts.</p>

<p>For content that is shared among all pages in your application, you can use partials directly from layouts.</p>

<h5><a name="partial-layouts"></a>3.4.3 Partial Layouts</h5>


<p>A partial can use its own layout file, just as a view can use a layout. For example, you might call a partial like this:</p>

<p><span style="font-family: DejaVu Sans;">一个</span>partial<span style="font-family: DejaVu Sans;">可以使用它们自己的</span>layout<span style="font-family: DejaVu Sans;">文件，就像一个视图可以使用一个</span>layout<span style="font-family: DejaVu Sans;">。例如你可以这样调用一个</span>partial<span style="font-family: DejaVu Sans;">：</span></p>

<p>&lt;%= render :partial =&gt; &ldquo;link_area&rdquo;, :layout =&gt; &ldquo;graybar&rdquo; %&gt;</p>

<p>This would look for a partial named <tt><em>link_area.html.erb</tt> and render it using the layout <tt></em>graybar.html.erb</tt>. Note that layouts for partials follow the same leading-underscore naming as regular partials, and are placed in the same folder with the partial that they belong to (not in the master <tt>layouts</tt> folder).</p>

<p><span style="font-family: DejaVu Sans;">这将会查找一个名叫</span><tt><em>link_area.html.erb</tt><span style="font-family: DejaVu Sans;">的</span>partial<span style="font-family: DejaVu Sans;">并且在</span><tt></em>graybar.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>中</tt></span>render<span style="font-family: DejaVu Sans;">和使用它。</span></p>

<p>Also note that<strong> </strong><strong>explicitly</strong><strong> </strong><strong>specifying</strong><strong> </strong><tt><strong>:partial</strong></tt><strong> </strong><strong>is</strong><strong> </strong><strong>required</strong> when passing additional options such as <tt>:layout</tt>.</p>

<h5><a name="passing-local-variables"></a>3.4.4 Passing Local Variables</h5>


<p>You can also pass local variables into partials, making them even more powerful and flexible. For example, you can use this technique to reduce duplication between new and edit pages, while still keeping a bit of distinct content:</p>

<ul>
    <li><tt>new.html.erb</tt><tt> </tt></li>
</ul>


<p>&lt;h1&gt;New zone&lt;/h1&gt;</p>

<p>&lt;%= error_messages_for :zone %&gt;</p>

<p>&lt;%= render :partial =&gt; &ldquo;form&rdquo;, :locals =&gt; { :zone =&gt; @zone } %&gt;</p>

<ul>
    <li><tt><span style="color: #000000;"><span style="font-size: small;">edit.html.erb</span></span></tt></li>
</ul>


<p>&lt;h1&gt;Editing zone&lt;/h1&gt;</p>

<p>&lt;%= error_messages_for :zone %&gt;</p>

<p>&lt;%= render :partial =&gt; &ldquo;form&rdquo;, :locals =&gt; { :zone =&gt; @zone } %&gt;</p>

<ul>
    <li><tt>_</tt><tt><span style="color: #000000;"><span style="font-size: small;">form.html.erb</span></span></tt></li>
</ul>


<p>&lt;%= form_for(zone) do |f| %&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;b&gt;Zone name&lt;/b&gt;&lt;br /&gt;</p>

<p>&lt;%= f.text_field :name %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;p&gt;</p>

<p>&lt;%= f.submit %&gt;</p>

<p>&lt;/p&gt;</p>

<p>&lt;% end %&gt;</p>

<p>Although the same partial will be rendered into both views, Action View’s submit helper will return “Create Zone” for the new action and “Update Zone” for the edit action.</p>

<p><strong>Every</strong><strong> </strong><strong>partial</strong><strong> </strong><strong>also</strong><strong> </strong><strong>has</strong><strong> </strong><strong>a</strong><strong> </strong><strong>local</strong><strong> </strong><strong>variable</strong><strong> </strong><strong>with</strong><strong> </strong><strong>the</strong><strong> </strong><strong>same</strong><strong> </strong><strong>name</strong><strong> </strong><strong>as</strong><strong> </strong><strong>the</strong><strong> </strong><strong>partial</strong> (minus the underscore). You can pass an object in to this local variable via the <tt>:object</tt> option:</p>

<p>&lt;%= render :partial =&gt; &ldquo;customer&rdquo;, :object =&gt; @new_customer %&gt;</p>

<p>Within the <tt>customer</tt> partial, the <tt>customer</tt> variable will refer to<span style="font-family: DejaVu Sans;">引用</span><tt>@new_customer</tt> from the parent view.</p>

<p>In previous versions of Rails, <strong>the</strong><strong> </strong><strong>default</strong><span style="font-family: DejaVu Sans;"><strong>默认情况</strong></span><strong>local</strong><strong> </strong><strong>variable</strong><strong> </strong><strong>would</strong><strong> </strong><strong>look</strong><strong> </strong><strong>for</strong><strong> </strong><strong>an</strong><strong> </strong><strong>instance</strong><strong> </strong><strong>variable</strong><strong> </strong><strong>with</strong><strong> </strong><strong>the</strong><strong> </strong><strong>same</strong><strong> </strong><strong>name</strong><strong> </strong><strong>as</strong><strong> </strong><strong>the</strong><strong> </strong><strong>partial</strong><strong> </strong><strong>in</strong><strong> </strong><strong>the</strong><strong> </strong><strong>parent</strong>. This behavior was deprecated<span style="font-family: DejaVu Sans;">增加</span>in 2.3 and has been <strong>removed</strong><strong> </strong><strong>in</strong><strong> </strong><strong>Rails</strong><strong> </strong><strong>3.0.</strong><span style="font-family: DejaVu Sans;"><strong>（可以自己添加如上）</strong></span></p>

<p>If you have an instance of a model to render into a partial, you can use a shorthand syntax:</p>

<p>&lt;%= render @customer %&gt;</p>

<p>Assuming<span style="font-family: DejaVu Sans;">假设</span>that the <tt>@customer</tt> instance variable contains an instance of the <tt>Customer</tt> model, this will use <tt>_customer.html.erb</tt> to render it and will pass the local variable <tt>customer</tt> into the partial which will refer to the <tt>@customer</tt> instance variable in the parent view.</p>

<p><span style="font-family: DejaVu Sans;">假设</span><tt>@customer</tt><span style="font-family: DejaVu Sans;"><tt>实例变量包含在一个</tt><tt></tt></span><tt>Customer</tt><span style="font-family: DejaVu Sans;"><tt>的实例中，这将会使用</tt></span><tt>_customer.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>来</tt></span><tt>render</tt><span style="font-family: DejaVu Sans;"><tt>它并且传递本地变量</tt><tt></tt></span><tt>customer</tt><span style="font-family: DejaVu Sans;"><tt>给</tt><tt></tt></span><tt>partial</tt><span style="font-family: DejaVu Sans;"><tt>引用</tt></span><tt>@customer</tt><span style="font-family: DejaVu Sans;"><tt>实例变量的父视图。</tt></span></p>

<h5><a name="rendering-collections"></a>3.4.5 Rendering Collections</h5>


<p>Partials are very useful in rendering collections. When you pass a collection to a partial via the <tt>:collection</tt> option, the partial will be inserted once for each member in the collection:</p>

<ul>
    <li><tt>index.html.erb</tt></li>
</ul>


<p>&lt;h1&gt;Products&lt;/h1&gt;</p>

<p>&lt;%= render :partial =&gt; &ldquo;product&rdquo;, :collection =&gt; @products %&gt;</p>

<ul>
    <li><tt>_product.html.erb</tt></li>
</ul>


<p>&lt;p&gt;Product Name: &lt;%= product.name %&gt;&lt;/p&gt;</p>

<p>When a partial is called with a pluralized collection, then the individual instances of the partial have access to the member of the collection being rendered via a variable named after the partial. In this case, the partial is <tt><em>product</tt>, and within the <tt></em>product</tt> partial, you can refer to <tt>product</tt> to get the instance that is being rendered.</p>

<p><span style="font-family: DejaVu Sans;">当一个</span>partial<span style="font-family: DejaVu Sans;">被通过一个多元的</span>collection<span style="font-family: DejaVu Sans;">调用，然后</span>partial <span style="font-family: DejaVu Sans;">的个别的实例会访问</span>collection<span style="font-family: DejaVu Sans;">的成员并开始被</span>rendered<span style="font-family: DejaVu Sans;">通过一个在</span>partial<span style="font-family: DejaVu Sans;">后面的变量名。在本例中</span>the partial is <tt><em>product</tt>,<span style="font-family: DejaVu Sans;">并且在</span><tt></em>product</tt> partial<span style="font-family: DejaVu Sans;">中，你可以引用</span>product<span style="font-family: DejaVu Sans;">来得到被开始渲染的实例。</span></p>

<p>In Rails 3.0, there is also a shorthand for this. Assuming <tt>@products</tt> is a collection of <tt>product</tt> instances, you can simply write this in the <tt>index.html.erb</tt> to produce the same result:</p>

<p><span style="font-family: DejaVu Sans;">在</span>Rails 3.0<span style="font-family: DejaVu Sans;">中有一个快捷操作。假设</span><tt>@products</tt><span style="font-family: DejaVu Sans;"><tt>是一个</tt></span><tt>product</tt><span style="font-family: DejaVu Sans;"><tt>实例的集合，你可以简单的在</tt><tt></tt></span><tt>index.html.erb</tt><span style="font-family: DejaVu Sans;"><tt>中写入下面的代码来产生相同的结果：</tt></span></p>

<p>&lt;h1&gt;Products&lt;/h1&gt;</p>

<p>&lt;%= render @products %&gt;</p>

<p>Rails determines the name of the partial to use by looking at the model name in the collection. In fact, you can even create a heterogeneous<span style="font-family: DejaVu Sans;">合成</span>collection and render it this way, and Rails will choose the proper partial for each member of the collection:</p>

<ul>
    <li><tt>index.html.erb</tt><tt> </tt></li>
</ul>


<p>&lt;h1&gt;Contacts&lt;/h1&gt;</p>

<p>&lt;%= render [customer1, employee1, customer2, employee2] %&gt;</p>

<ul>
    <li><tt>customers/_customer.html.erb</tt><tt> </tt></li>
</ul>


<p>&lt;p&gt;Customer: &lt;%= customer.name %&gt;&lt;/p&gt;</p>

<ul>
    <li><tt>employees/_employee.html.erb</tt></li>
</ul>


<p>&lt;p&gt;Employee: &lt;%= employee.name %&gt;&lt;/p&gt;</p>

<p>In this case, Rails will use the customer or employee partials as appropriate for each member of the collection.</p>

<h5><a name="local-variables"></a>3.4.6 Local Variables</h5>


<p>To use a custom local variable name within the partial, specify the <tt>:as</tt> option in the call to the partial:</p>

<p>&lt;%= render :partial =&gt; &ldquo;product&rdquo;, :collection =&gt; @products, :as =&gt; :item %&gt;</p>

<p>With this change, <strong>you</strong><strong> </strong><strong>can</strong><strong> </strong><strong>access</strong><strong> </strong><strong>an</strong><strong> </strong><strong>instance</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>@products</strong></tt><strong> </strong><strong>collection</strong><strong> </strong><strong>as</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>item</strong></tt><strong> </strong><strong>local</strong><strong> </strong><strong>variable</strong><strong> </strong><strong>within</strong><strong> </strong><strong>the</strong><strong> </strong><strong>partial</strong>.<span style="font-family: DejaVu Sans;">你可以访问</span>item<span style="font-family: DejaVu Sans;">本地变量来访问</span><tt><strong>@products</strong></tt><tt><strong> </strong></tt><tt><strong>collection</strong></tt><span style="font-family: DejaVu Sans;"><tt><strong>的实例。</strong></tt></span></p>

<p>&nbsp;</p>

<p>You can also<strong> </strong><strong>pass</strong><strong> </strong><strong>in</strong><strong> </strong><strong>arbitrary</strong><strong> </strong><strong>local</strong><strong> </strong><strong>variables</strong><strong> </strong><strong>to</strong><strong> </strong><strong>any</strong><strong> </strong><strong>partial</strong><strong> </strong><strong>you</strong><strong> </strong><strong>are</strong><strong> </strong><strong>rendering</strong><strong> </strong><strong>with</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>:locals</strong></tt><tt><strong> </strong></tt><tt><strong>=&gt;</strong></tt><tt><strong> </strong></tt><tt><strong>{}</strong></tt><strong> </strong><strong>option:</strong></p>

<p>&lt;%= render :partial =&gt; &lsquo;products&rsquo;, :collection =&gt; @products,</p>

<p>:as =&gt; :item, :locals =&gt; {:title =&gt; &ldquo;Products Page&rdquo;} %&gt;</p>

<p>Would render a partial <tt>_products.html.erb</tt> once for each instance of <tt>product</tt> in the <tt>@products</tt> instance variable passing the instance to the partial as a local variable <strong>called</strong><strong> </strong><tt><strong>item</strong></tt><strong> </strong><strong>and</strong><strong> </strong><strong>to</strong><strong> </strong><strong>each</strong><strong> </strong><strong>partial</strong>,<strong> </strong><strong>make</strong><strong> </strong><strong>the</strong><strong> </strong><strong>local</strong><strong> </strong><strong>variable</strong><strong> </strong><tt><strong>title</strong></tt><strong> </strong><strong>available</strong><strong> </strong><strong>with</strong><strong> </strong><strong>the</strong><strong> </strong><strong>value</strong><strong> </strong><tt><strong>Products</strong></tt><tt><strong> </strong></tt><tt><strong>Page</strong></tt><strong>.</strong></p>

<p>Rails also makes a counter variable available within a partial called by the collection, named after the member of the collection followed by <tt>_counter</tt>. <strong>For</strong><strong> </strong><strong>example,</strong><strong> </strong><strong>if</strong><strong> </strong><strong>you</strong><strong>’</strong><strong>re</strong><strong> </strong><strong>rendering</strong><strong> </strong><tt><strong>@products</strong></tt><strong>,</strong><strong> </strong><strong>within</strong><strong> </strong><strong>the</strong><strong> </strong><strong>partial</strong><strong> </strong><strong>you</strong><strong> </strong><strong>can</strong><strong> </strong><strong>refer</strong><strong> </strong><strong>to</strong><strong> </strong><tt><strong>product_counter</strong></tt><strong> </strong><strong>to</strong><strong> </strong><strong>tell</strong><strong> </strong><strong>you</strong><strong> </strong><strong>how</strong><strong> </strong><strong>many</strong><strong> </strong><strong>times</strong><strong> </strong><strong>the</strong><strong> </strong><strong>partial</strong><strong> </strong><strong>has</strong><strong> </strong><strong>been</strong><strong> </strong><strong>rendered.</strong><strong> </strong>This does not work in conjunction<span style="font-family: DejaVu Sans;">结合</span>with the <tt>:as</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>:value</tt> option.</p>

<p>You can also specify a second partial to be rendered between instances of the main partial by using the <tt>:spacer_template</tt> option:</p>

<h5><a name="spacer-templates"></a>3.4.7 Spacer Templates<span style="font-family: WenQuanYi Micro Hei;">间隔</span>templates</h5>


<p>&lt;%= render @products, :spacer_template =&gt; &ldquo;product_ruler&rdquo; %&gt;</p>

<p>Rails will render the <tt><em>product_ruler</tt> partial (<strong>with</strong><strong> </strong><strong>no</strong><strong> </strong><strong>data</strong><strong> </strong><strong>passed</strong><strong> </strong><strong>in</strong><strong> </strong><strong>to</strong><strong> </strong><strong>it</strong>) <strong>between</strong><strong> </strong><strong>each</strong><strong> </strong><strong>pair</strong><strong> </strong><strong>of</strong><strong> </strong><tt><strong></em>product</strong></tt><strong> </strong><strong>partials</strong>.</p>

<h4><a name="using-nested-layouts"></a>3.5 Using Nested Layouts<span style="font-family: WenQuanYi Micro Hei;">使用嵌套</span>layouts</h4>


<p>You may find that your application requires a layout that differs slightly<span style="font-family: DejaVu Sans;">略有不同</span>from your regular application layout to support one particular controller. Rather than repeating the main layout and editing it, you can accomplish<span style="font-family: DejaVu Sans;">完成</span>this by using nested layouts (sometimes called sub-templates). Here’s an example:</p>

<p>Suppose<span style="font-family: DejaVu Sans;">假设</span>you have the following <tt>ApplicationController</tt> layout:</p>

<ul>
    <li><tt>app/views/layouts/application.html.erb</tt></li>
</ul>


<p>&lt;html&gt;</p>

<p>&lt;head&gt;</p>

<p>&lt;title&gt;&lt;%= @page_title or &lsquo;Page Title&rsquo; %&gt;&lt;/title&gt;</p>

<p>&lt;%= stylesheet_link_tag &lsquo;layout&rsquo; %&gt;</p>

<p>&lt;style type=&ldquo;text/css&rdquo;&gt;&lt;%= yield :stylesheets %&gt;&lt;/style&gt;</p>

<p>&lt;/head&gt;</p>

<p>&lt;body&gt;</p>

<p>&lt;div id=&ldquo;top_menu&rdquo;&gt;Top menu items here&lt;/div&gt;</p>

<p>&lt;div id=&ldquo;menu&rdquo;&gt;Menu items here&lt;/div&gt;</p>

<p>&lt;div id=&ldquo;content&rdquo;&gt;&lt;%= content_for?(:content) ? yield(:content) : yield %&gt;&lt;/div&gt;</p>

<p>&lt;/body&gt;</p>

<p>&lt;/html&gt;</p>

<p>On pages generated by <tt>NewsController</tt>, you want to hide the top menu and add a right menu:</p>

<ul>
    <li><tt>app/views/layouts/news.html.erb</tt></li>
</ul>


<p>&lt;% content_for :stylesheets do %&gt;</p>

<h1>top_menu {display: none}</h1>

<h1>right_menu {float: right; background-color: yellow; color: black}</h1>

<p>&lt;% end %&gt;</p>

<p>&lt;% content_for :content do %&gt;</p>

<p>&lt;div id=&ldquo;right_menu&rdquo;&gt;Right menu items here&lt;/div&gt;</p>

<p>&lt;%= content_for?(:news_content) ? yield(:news_content) : yield %&gt;</p>

<p>&lt;% end %&gt;</p>

<p>&lt;%= render :template =&gt; &lsquo;layouts/application&rsquo; %&gt;</p>

<h1>&lt;<span style="font-family: DejaVu Sans;">表达式</span>1&gt;?&lt;<span style="font-family: DejaVu Sans;">表达式</span>2&gt;:&lt;<span style="font-family: DejaVu Sans;">表达式</span>3&gt;; &ldquo;?&rdquo;<span style="font-family: DejaVu Sans;">运算符的含义是</span>: <span style="font-family: DejaVu Sans;">先求表达式</span>1<span style="font-family: DejaVu Sans;">的值</span>, <span style="font-family: DejaVu Sans;">如果为真</span>, <span style="font-family: DejaVu Sans;">则执行表达式</span>2<span style="font-family: DejaVu Sans;">，并返回表达式</span>2<span style="font-family: DejaVu Sans;">的结果</span>; <span style="font-family: DejaVu Sans;">如果表达式</span>1<span style="font-family: DejaVu Sans;">的值为假</span>, <span style="font-family: DejaVu Sans;">则执行表达式</span>3 <span style="font-family: DejaVu Sans;">，并返回表达式</span>3<span style="font-family: DejaVu Sans;">的结果</span>.</h1>

<p>That’s it. The News views will use the new layout, hiding the top menu and adding a new right menu inside the “content” div.</p>

<p>There are several ways of getting similar results with different sub-templating schemes using this technique. Note that there is no limit in nesting levels. One can use the <tt>ActionView::render</tt> method via <tt>render</tt><tt> </tt><tt>:template</tt><tt> </tt><tt>=&gt;</tt><tt> </tt><tt>&lsquo;layouts/news&rsquo;</tt> to base a new layout on the News layout. If you are sure you will not subtemplate the <tt>News</tt> layout, you can <strong>replace</strong> the <tt>content_for?(:news_content)</tt><tt> </tt><tt>?</tt><tt> </tt><tt>yield(:news_content)</tt><tt> </tt><tt>:</tt><tt> </tt><tt>yield</tt> <strong>with</strong><strong> </strong><strong>simply</strong><strong> </strong><tt><strong>yield</strong></tt><strong>.</strong></p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/07/pythonzhong-de-bian-ma-wen-ti/">Python中的编码问题</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-07T13:37:00+08:00" pubdate data-updated="true">Dec 7<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>python中的编码问题</h2>

<p>这里简单的说一下。（下面内容基本上时从《Python.Core.Programming.2ed》上摘的）
Unicode是计算机可以支持这个星球上的多种语言的秘密武器，在Unicode之前，用的都是ASCII，ASCII吗非常简单，每个英文字符都用7位二进制数的方式存储在计算机内，其范围是32到126.它的实现原理这里也不说了。
但是ASCII码只能表示95个可打印的字符，后来把ASCII扩展到了8位，这样就能表示223个字符了，虽然这个来表示欧美字母语言已经足够了，但是对于像中文等语系来说就太少了。于是Unicode码诞生了。
Unicode通过使用一个或者多个字节来表示一个字符，这样就突破了ASCII的限制，这样，Unicode可以表示超过90000个字符了。
 
Python 与Unicode
 
为了让Unicode和ASCII码值的字符串看起来尽可能的相像，Python的字符串从原来的简单数据类型改变成了真正的对象，ASCII字符串成了ＳｔｒｉｎｇＴｙｐｅ，而Ｕｎｉｃｏｄｅ字符串成了UnicodeType类型，他们的行为非常相近。String模块里面都有相应的处理函数。String模块已经停止了更新，只保留了对ＡＳＸＩＩ码的支持，string模块已经不推荐使用，在任何要跟Ｕｎｉｃｏｄｅ兼容的代码里都不要再用该模块，Python保留该模块仅仅为了向后兼容。
Python里面默认所有字面上的字符串都用ASCII编码，可以通过在字符串前面加一个‘ｕ’前缀的方式声明Ｕｎｉｃｏｄｅ字符串，这个‘ｕ’前缀告诉Python后面的字符串要编成Ｕｎｉｃｏｄｅ字符串。
 
&gt;&gt;&gt; &ldquo;Hello World&rdquo; #ASCII string
&lsquo;Hello World&rsquo;
&gt;&gt;&gt; u&#8221;Hello World&#8221; #Unicode string
u&#8217;Hello World&#8217;
 
内建的str()函数和chr（）函数不能处理Unicode，它们只能处理常规ASCII编码的字符串，如果一个Unicode字符串作为参数传给了str（）函数，它会首先被转换成ASCII码字符串然后交给str（）函数。
 
Codecs
 
Codec是把Coder/DECoder得首字母组合，它定义了文本跟二进制的转换方式，跟ASCII那种用一个字节把字符转换成数字的方式不同，Unicode用的是多字节，这导致了Unicode支持多种不同的编码方式，比如说codec支持的四种耳熟能详的编码方式是：ASCII，ISO8859—1/Latin-1，UTF-8,和UTF-16
最著名的是UTF-8编码，它也用一个字节来编码ASCII字符，这让那些必须同时处理ASCII码和Unicode码文本的程序员的工作变得非常轻松，因为ASCII字符的UTF-8编码和ASCII编码完全相同。
UTF-8编码可以用1到4个字节来表示其他语言的字符，这给那些需要直接处理Unicode数据的程序员带来了麻烦，因为他们没有办法按照固定长度逐一读出各个字符，幸运的是我们不需要掌握直接读取Unicode数据的方法，Python已经替我们完成了相关细节，我们无需为处理多字节字符的复杂问题而担心。
UTF-16也是一种变长编码，但是它不常用。
 
编码解码
 
Unicode支持多种编码格式，这为程序员带来了额外的负担，每当你向一个文件写入字符串的时候，你必须定义一个编码用于把对应的Unicode内容转换成你定义的格式，Python通过Unicode字符串的encode()函数解决了这个问题，该函数接受字符串中的字符为参数，输出你指定的编码格式的内容。
所以，每次我们写一个Unicode字符串到磁盘上我们都要用指定的编码器给他“编码“一下，相应地，当我们从这个文件读取数据时，我们必须”解码”该文件，使之成为Unicode字符串对象。
简单的例子：</p>

<div><code>#!/usr/bin/env python
# -*- coding: UTF-8 -*-
import chardet
#chardet.detect(u'啊啊算法')
def u(s, encoding):
if isinstance(s, unicode):#用来判断是否为unicode
return s
else:
try:
return unicode(s, encoding)# 不是的话就转成unicode
except IOError:
print('error\n')</code>#s=r&#8217;\u6df1\u5733\u71c3\u6c14\u4e2d\u7b7e\u7387&#8217;
#zh = reduce(lambda x,y: x + unichr(int(y, 16)), s.split(r&#8221;\u&#8221;))
#print zh
def jiema(getstring):
fstr=r&#8221;&#8221;
list_str=getstring.split(r&#8217;\u&#8217;)
for single in list_str:
if single != &#8221;:
fstr+=unichr(int(single,16))
print fstrif __name__==&#8217;__main__&#8217;:
coding=[&#8216;utf&#8217;,&#8217;ascii&#8217;,&#8217;gb2312&#8217;,&#8217;gbk&#8217;]
a=&#8217;\u8bf7\u91cd\u65b0\u767b\u5f55&#8217;#这里没有加u得到的 就是ascii码
#if chardet.detect(u&#8217;啊啊算法&#8217;)
if chardet.detect(a)[&#8216;encoding&#8217;]==&#8217;ascii&#8217;:
print &#8220;beging to call jiema &#8230;.&#8221;
jiema(a)
else:
print &#8220;beging to zhuanma&#8221;
for code in coding:
print code
print u(a,code)
print &#8220;&#8221;&#8220;Python里面默认所有字面上的字符串都用ASCII编码，可以通过在字符串前面加一个‘ｕ’前缀的方式声明Ｕｎｉｃｏｄｅ字符串，这个‘ｕ’前缀告诉Python后面的字符串要编成Ｕｎｉｃｏｄｅ字符串。&#8221;&#8220;&#8221;
print &#8220;&#8221;&#8220;ASCII 是一种字符集,包括大小写的英文字母、数字、控制字符等，它用一个字节表示，范围是 0-127Unicode分为UTF-8和UTF-16。UTF-8变长度的，最多 6 个字节，小于 127 的字符用一个字节表示，与 ASCII 字符集的结果一样，ASCII 编码下的英语文本不需要修改就可以当作 UTF-8 编码进行处理。&#8221;&#8220;&#8221;
<div>标签： <a href="http://jhjguxin.hwcrazy.com/tag/python/">python</a></div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/07/mac-oskuai-jie-jian/">MAC OS快捷键</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-07T00:05:00+08:00" pubdate data-updated="true">Dec 7<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>MAC OS快捷键</h2>

<div>

<strong>全局</strong><strong>
</strong>Cmd-C 复制文件
Cmd-V 粘贴文件
Option-拖动复制文件到新地址
Cmd-拖动移动并自动对齐
Cmd-Delete 删除
Cmd-Option-拖动做替身(快捷方式)
Cmd-Shift-Delete 清空垃圾桶
Cmd-Shift-Option-Delete 强制清空垃圾桶
Tab 选定下一个项目
Shift-Tab 选定上一个项目
Return 执行默认动作
Escape 关闭对话框
Page Up 向上翻页
向上箭头选取上一个文件
Page Down 向下翻页
向下箭头选取下一个文件
Cmd-Shift-G 打开’前往文件夹’对话框
Cmd-句号[.] 关闭对话框

<strong>Exposé</strong><strong> </strong><strong>和系统的快捷</strong><strong></strong>
F8 切换Space
Shift-F8 慢速切换Space
F9（默认设置）使用Exposé 显示所有打开的窗口
F10（默认设置）使用Exposé 在某个应用程序中显示所有打开的窗口
F11（默认设置）使用Exposé 隐藏所有打开的窗口并显示桌面
Cmd-H 隐藏程序
Cmd-Option-H 隐藏其他程序
Cmd-Q 退出程序
Cmd-Shift-Q 退出所有程序并且注销用户
Cmd-Option-Shift-Q 强制注销用户
Cmd-Tab 切换到下一个应用程序
Cmd-Shift-Tab 切换到上一个应用程序
Cmd-拖动整理菜单栏
按下Option 键并点按一个窗口切换窗口并隐藏当前窗口
按住Option 并点按Dock 图标切换到另一个应用程序并隐藏当前应用程序
按下Control 键并点按该项查看某个项的快捷（上下文）菜单
将光标移到该词上面，然后按Cmd-Control-D 使用Dictionary 查看对字词在应用程序中的定义

<strong>停止响应</strong>
Cmd-句号[.] 停止进程
Cmd-Option-Escape 打开’强制退出’
电源键关机
Cmd-Option-Shift-电源键强制关机或重新启动（在某些电脑上）
Cmd-Control-电源键强制重启


<strong>Finder</strong>
Cmd-点击标题查看当前窗口的路径
Cmd-双击(文件夹上) 新窗口中打开文件夹
Option-双击(文件夹上) 新窗口中打开文件夹并关闭当前窗口
Cmd-1 用图标浏览
Cmd-2 用列表浏览
Cmd-Option-向右箭头列表模式下显示包含的目录
向左箭头列表模式下关闭选定目录
Cmd-向下箭头在图标或列表模式下打开选定目录
Cmd-Option-向下箭头在图标或列表模式下在新窗口打开选定目录并关闭当前窗口
Cmd-Shift-Option-向下箭头(慢速)在图标或列表模式下在新窗口打开选定目录并关闭当前窗口
Cmd-向上箭头打开上一级目录
Cmd-Option-向上箭头打开上一级目录并关闭当前目录
Cmd-3 用分栏浏览
Cmd-4 用cover flow浏览
Cmd-Y 打开快速查看
Cmd-Option-Y 用幻灯片显示
Cmd-Shift-H 打开用户文件夹
Cmd-Option-Shift-向上箭头聚焦桌面
Cmd-Shift-I 打开iDisk
Cmd-Shift-D 打开桌面
Cmd-Shift-C 打开’电脑’
Cmd-Shift-K 打开网络
Cmd-Shift-A 打开应用程序
双击标题最小化窗口
Cmd-M 最小化窗口
Option-点击按钮应用到所有激活的窗口
按下并按住滚动条快速浏览长文稿
按住Option 键并点按滚动条迅速在“滚动到当前位置”和“滚动到页面”之间切换
Cmd-波浪符号(~) 激活当前应用程序中的上一个或下一个窗口

<strong>Dock</strong>
拖动分割线自定义Dock大小
Option-拖动分割线调整Dock到合适大小
Control-点击显示Dock快捷菜单
Control-点击图标显示项目的快捷菜单
Cmd-点击打开图标所在文件夹
Option-点击切换并隐藏当前程序
Cmd-Option-点击切换并隐藏所有程序
Cmd-Option-拖动强制程序打开文件
Cmd-Option-D 显示/隐藏Dock

<strong>启动</strong>
*快捷键只能在启动时使用
当您看到进程指示器（看起来像旋转的齿轮）时，请按住左边的Shift 键。防止自动登录
听到启动音之后立即按住Shift 键，然后当您看到进程指示器（看起来像旋转的齿轮）时释放该键。以安全模式启动（只
有必要的Mac OS X 项被启动，一些功能和应用程序可能无法正常工作。）
在登录屏幕上点按“登录”按钮之后，请按住Shift 键。防止登录时打开“登录项”和Finder 窗口
C 从光盘启动
N 从默认的NetBoot 磁盘映像启动
T 以目标磁盘模式启动
Option 选择启动磁盘（在某些电脑上）
Cmd-X 使用Mac OS X 而不是Mac OS 9 来进行启动（如果两者均位于同一宗卷上）
按住鼠标键推出可去掉的光盘
Cmd-Option-P-R 还原参数RAM
Cmd-V 显示详细的状态信息（详细模式）
Cmd-S 以单一用户模式启动


<strong>Safari</strong>
Cmd-Option-F google搜索栏
Option-向上箭头向上翻页
Option-向下箭头向下翻页
Cmd-点击链接在后台用新标签打开
Cmd-Shift-点击链接打开并激活新标签
Cmd-Option-点击链接打开新窗口
Option-点击Close 按钮关闭其他标签
Cmd-Shift-] 选取下一个标签
Cmd-Shift-[ 选取上一个标签
Cmd-Shift-H 打开主页
Cmd-Shift-K 切换’禁止弹出窗口&#8217;
Cmd-Option-E 清空缓存
Cmd-Option-R 不用缓存并刷新页面
Cmd-F 查找
Cmd-M 最小化窗口
Shift-点击按钮慢动作动画效果
Cmd-加号[+] 增大字体
Cmd-减号[-] 减小字体
Cmd-0 默认字体

<strong>Dashboard</strong>
使用这些快捷来处理Dashboard 和Dashboard widget。
F12（默认设置）显示或隐藏Dashboard
Cmd-R 重新载入当前widget
Cmd-等号(=) 显示或隐藏widget 栏
Cmd-向左箭头键，Cmd-向右箭头键滚动widget 栏
注:要更改Dashboard 的快捷，请选取“文件”&gt;“系统偏好设置”，点按“Exposé &amp; Spaces”，然后点按“Exposé”。


<strong>Front</strong><strong> </strong><strong>Row</strong>
您可以使用键盘来控制Front Row 而无需使用Apple Remote 遥控器。
Cmd-Esc (Escape) 打开Front Row
Cmd-Esc 或Esc 从打开的菜单中关闭Front Row
向上箭头键，向下箭头键浏览菜单和列表
Cmd-Esc 或Esc 返回上一级菜单
空格键或Return 选择菜单或列表中的项
空格键或Return 播放和暂停音频或视频
向上箭头键，向下箭头键更改音量
向右箭头键，向左箭头键前往下一个或上一个歌曲或照片
向右箭头键，向左箭头键前往所播放DVD 的下一章或上一章
右箭头键，左箭头键（按住按钮）快进或倒回歌曲、视频或DVD
在某些Apple 键盘和便携式电脑上，您或许也可以使用特定按键来更改音量和控制回放。


<strong>键盘导航</strong>
Control-F1 打开/关闭全键盘控制
Control-F2 聚焦菜单栏
Control-F3 聚焦Dock
Control-F4 聚焦活跃窗口或下一个窗口
Control-F5 聚焦窗口工具栏
Control-F6 聚焦浮动窗口
Control-F7 在控制或文本框与列表之间移动
Control-F8 聚焦菜单栏中的状态菜单
Cmd-Accent [`] 聚焦活跃应用程序的下一个窗口
Cmd-Shift-Accent [`] 聚焦活跃应用程序的上一个窗口
Cmd-Option-Accent [`] 聚焦窗口抽屉
Cmd-Option-T 显示或隐藏字符调板

</div>


<div>标签： <a href="http://jhjguxin.hwcrazy.com/tag/apple/">apple</a> <a href="http://jhjguxin.hwcrazy.com/tag/mac/">mac</a> <a href="http://jhjguxin.hwcrazy.com/tag/shortcuts/">shortcuts</a></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/02/active-record-query-interface-cn/">Active Record-Query Interface-CN</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-02T17:54:00+08:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Active Record-Query Interface-CN</h2>

<h1>Active Record</h1>


<p>Active Record<span style="font-family: DejaVu Sans;">（中文名：活动记录）是一种领域模型模式，特点是一个模型类对应关系型数据库中的一个表，而模型类的一个实例对应表中的一行记录。</span>Active Record <span style="font-family: DejaVu Sans;">和</span>Row Gateway <span style="font-family: DejaVu Sans;">（行记录入口）十分相似，但前者是领域模型，后者是一种数据源模式。关系型数据库往往通过外键来表述实体关系，</span>Active Record <span style="font-family: DejaVu Sans;">在数据源层面上也将这种关系映射为对象的关联和聚集。</span></p>

<p><span style="font-family: DejaVu Sans;">　　</span>Active Record <span style="font-family: DejaVu Sans;">适合非常简单的领域需求，尤其在领域模型和数据库模型十分相似的情况下。如果遇到更加复杂的领域模型结构（例如用到继承、策略的领域模型），往往需要使用分离数据源的领域模型，结合</span>Data Mapper <span style="font-family: DejaVu Sans;">（数据映射器）使用。</span></p>

<p><span style="font-family: DejaVu Sans;">　　</span>Active Record <span style="font-family: DejaVu Sans;">驱动框架一般兼有</span>ORM <span style="font-family: DejaVu Sans;">框架的功能，但</span>ActivActive Recorde Record <span style="font-family: DejaVu Sans;">不是简单的</span>ORM<span style="font-family: DejaVu Sans;">，正如和</span>Row Gateway <span style="font-family: DejaVu Sans;">的区别。著名的例子是全栈（</span>Full Stack<span style="font-family: DejaVu Sans;">）</span>Web <span style="font-family: DejaVu Sans;">开发框架</span>Ruby on Rails <span style="font-family: DejaVu Sans;">，其默认使用一个纯</span>Ruby <span style="font-family: DejaVu Sans;">写成的</span><strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><span style="font-family: DejaVu Sans;"><strong>框架</strong>来驱动</span>MVC <span style="font-family: DejaVu Sans;">中的模型层。</span></p>

<p><span style="font-family: DejaVu Sans;">　　对象关系映射（</span>ORM<span style="font-family: DejaVu Sans;">）提供了概念性的、易于理解的模型化数据的方法。</span>ORM<span style="font-family: DejaVu Sans;">方法论基于三个核心原则：简单：以最基本的形式建模数据。传达性：数据库结构被任何人都能理解的语言文档化。精确性：基于数据模型创建正确标准化了的结构。</span></p>

<p><span style="font-family: DejaVu Sans;">　　在</span>Martin Fowler <span style="font-family: DejaVu Sans;">的《企业应用架构模式》一书中曾详细叙述了本模式。</span></p>

<p><span style="font-family: DejaVu Sans;">　　以下是著名的</span>Active Record <span style="font-family: DejaVu Sans;">驱动框架：</span></p>

<p><span style="font-family: DejaVu Sans;">　　</span>SQLObject(Python)</p>

<p><span style="font-family: DejaVu Sans;">　　</span>Ruby on Rails ActiveRecord (Ruby)</p>

<p><span style="font-family: DejaVu Sans;">　　</span>Yii Framework ActiveRecord (PHP)</p>

<p><span style="font-family: DejaVu Sans;">　　</span>Castle ActiveRecord (.NET)</p>

<h2>Migrations</h2>


<p>Migrations are a convenient way for you to alter<span style="font-family: DejaVu Sans;">移动</span>your database in a structured and organized manner.Migrations<span style="font-family: DejaVu Sans;">是一种很便捷的方法让你能够以一种结构化的和有组织的方式来迁移你的数据库。</span>You could edit fragments of SQL by hand but you would then be responsible for telling other developers that they need to go and run them.<span style="font-family: DejaVu Sans;">你可以手动编辑</span>SQL<span style="font-family: DejaVu Sans;">片段，而且你有责任把这些告诉其他的开发人员，因为他们需要开发和使用它们。</span>You’d also have to keep track of which changes need to be run against the production machines next time you deploy.<span style="font-family: DejaVu Sans;">你也可以跟踪对你部署的代码在接下来的</span>production<span style="font-family: DejaVu Sans;">机器（将会）发生的变化。</span></p>

<p>Active Record tracks which migrations have already been run so all you have to do is update your source and run <tt>rake</tt><tt> </tt><tt>db:migrate</tt>.Active Record<span style="font-family: DejaVu Sans;">跟踪并迁移你已经运行过的（代码和数据），而你只需要在更新了你的源代码的时候执行</span><tt>rake</tt><tt> </tt><tt>db:migrate</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span>Active Record will work out which migrations should be run.Active Recor<span style="font-family: DejaVu Sans;">将会计算出那些迁移需要被执行。</span>It will also update your <tt>db/schema.rb</tt> file to match the structure of your database.<span style="font-family: DejaVu Sans;">它还会更新你的</span><tt>db/schema.rb</tt><span style="font-family: DejaVu Sans;"><tt>文件使其于你的数据库结构相匹配。</tt></span></p>

<p>Rails<span style="font-family: DejaVu Sans;">使用的是</span><strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><span style="font-family: DejaVu Sans;"><strong>框架</strong>来处理数据迁移，这里笔者把</span>Active Record <span style="font-family: DejaVu Sans;">框架放在一个地方学习了，如需了解</span>Migration<span style="font-family: DejaVu Sans;">部分需要直接阅读</span>Migration<span style="font-family: DejaVu Sans;">部分。</span></p>

<p>&nbsp;</p>

<h2>Active Record Validations and Callbacks <span style="font-family: WenQuanYi Micro Hei;">活动记录验证和回调</span></h2>


<p>This guide teaches you how to hook<span style="font-family: DejaVu Sans;">勾子</span>into the life cycle of your Active Record objects.<span style="font-family: DejaVu Sans;">这个教程指导你怎样挂接到你的</span>Active Record objects<span style="font-family: DejaVu Sans;">的生存周期。</span>You will learn how to validate the state of objects before they go into the database, and how to perform custom operations at certain points in the object life cycle.<span style="font-family: DejaVu Sans;">你将会学习到在将数据对象存入数据库之前怎样验证它们的状态，以及在对象生存周期的一些点上怎样执行定制操作。</span></p>

<p>Rails<span style="font-family: DejaVu Sans;">使用的是</span><strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><span style="font-family: DejaVu Sans;"><strong>框架</strong>来处理验证和回调，这里笔者把</span>Active Record <span style="font-family: DejaVu Sans;">框架放在一个地方学习了，如需了解</span>Migration<span style="font-family: DejaVu Sans;">部分需要直接阅读</span>Validations and Callbacks <span style="font-family: DejaVu Sans;">部分。</span></p>

<h2><strong>A</strong><strong> </strong><strong>Guide</strong><strong> </strong><strong>to</strong><strong> </strong><strong>Active</strong><strong> </strong><strong>Record</strong><strong> </strong><strong>Associations</strong></h2>


<p>This guide covers the association features of Active Record. By referring to this guide, you will be able to:<span style="font-family: DejaVu Sans;">本教程涵盖了</span>Active Record<span style="font-family: DejaVu Sans;">的关系部分的特性。（通过）这个教程提及的，你将能够：</span></p>

<ul>
    <li>Declare associations between Active Record models <span style="font-family: DejaVu Sans;">在</span>Active Record<span style="font-family: DejaVu Sans;">的</span>models<span style="font-family: DejaVu Sans;">中声明（它们的）关系</span></li>
    <li>Understand the various types of Active Record associations <span style="font-family: DejaVu Sans;">明白各种类型的</span>Active Record<span style="font-family: DejaVu Sans;">关系</span></li>
    <li>Use the methods added to your models by creating associations <span style="font-family: DejaVu Sans;">通过添加方法到</span>models<span style="font-family: DejaVu Sans;">（的形式）来创建关系</span></li>
</ul>


<h2>Active Record Query Interface<span style="font-family: WenQuanYi Micro Hei;">（基于）活动记录的查询接口</span></h2>


<p>This guide covers different ways to retrieve data from the database using Active Record. By referring to this guide, you will be able to:</p>

<p><span style="font-family: DejaVu Sans;">这个教程涵盖了使用基于</span>Active Record <span style="font-family: DejaVu Sans;">的不同方式从数据库检索数据。同过参考这个教程，你可以掌握：</span></p>

<ul>
    <li>Find records using a variety of methods and conditions <span style="font-family: DejaVu Sans;">使用各种方法和条件查找记录</span></li>
    <li>Specify the order, retrieved attributes, grouping, and other properties of the found records<span style="font-family: DejaVu Sans;">对查找的记录指定顺序，检索属性，组，和其他属性</span></li>
    <li>Use eager<span style="font-family: DejaVu Sans;">急于</span>loading to reduce the number of database queries needed for data retrieval <span style="font-family: DejaVu Sans;">使用预先加载，以减少数据检索所需的数据库查询数量</span></li>
    <li>Use dynamic finders methods <span style="font-family: DejaVu Sans;">使用多元搜索方法</span></li>
    <li>Check for the existence of particular records <span style="font-family: DejaVu Sans;">在特定的记录部分检查存在的记录</span></li>
    <li>Perform various calculations on Active Record models <span style="font-family: DejaVu Sans;">在</span>Active Record <span style="font-family: DejaVu Sans;">模型中执行各种计算</span></li>
</ul>


<p><span style="color: #800000;">This</span><span style="color: #800000;">Guide</span><span style="color: #800000;">is</span><span style="color: #800000;">based</span><span style="color: #800000;">on</span><span style="color: #800000;">Rails</span><span style="color: #800000;">3.0.</span><span style="color: #800000;">Some</span><span style="color: #800000;">of</span><span style="color: #800000;">the</span><span style="color: #800000;">code</span><span style="color: #800000;">shown</span><span style="color: #800000;">here</span><span style="color: #800000;">will</span><span style="color: #800000;">not</span><span style="color: #800000;">work</span><span style="color: #800000;">in</span><span style="color: #800000;">other</span><span style="color: #800000;">versions</span><span style="color: #800000;">of</span><span style="color: #800000;">Rails.</span></p>

<p>If you’re used to using raw SQL to find database records then, generally, you will find that there are better ways to carry out<span style="font-family: DejaVu Sans;">进行</span>the same operations in Rails. Active Record insulates you from the need to use SQL in most cases.<span style="font-family: DejaVu Sans;">如果你使用过原生的</span>SQL<span style="font-family: DejaVu Sans;">（语句）来查询数据库，那么，一般情况下，你将会发现（对数据库）进行同样的操作在</span>Rails<span style="font-family: DejaVu Sans;">中会有这更好的方法。</span>Active Record<span style="font-family: DejaVu Sans;">在大多数情况下会让你远离你（以前）需要使用的</span>SQL<span style="font-family: DejaVu Sans;">查询语句。</span></p>

<p>Code examples throughout this guide will refer to one or more of the following models:<span style="font-family: DejaVu Sans;">贯穿这个教材代码示例将会参考一个或多个下面的模型：</span></p>

<p>All of the following models use <tt>id</tt> as the primary key, unless specified otherwise.<span style="font-family: DejaVu Sans;">所有的模型都会使用</span>id<span style="font-family: DejaVu Sans;">作为主键，除非指定了其他主键。</span></p>

<p><em>class Client &lt; ActiveRecord::Base</em></p>

<p><em>has_one :address</em></p>

<p><em>has_many :orders</em></p>

<p><em>has_and_belongs_to_many :roles</em></p>

<p><em>end</em></p>

<p>&nbsp;</p>

<p><em>class Address &lt; ActiveRecord::Base</em></p>

<p><em>belongs_to :client</em></p>

<p><em>end</em></p>

<p>&nbsp;</p>

<p><em>class Order &lt; ActiveRecord::Base</em></p>

<p><em>belongs_to :client, :counter_cache =&gt; true</em></p>

<p><em>end</em></p>

<p>&nbsp;</p>

<p><em>class Role &lt; ActiveRecord::Base</em></p>

<p><em>has_and_belongs_to_many :clients</em></p>

<p><em>end</em></p>

<p>Active Record will perform queries on the database for you and is compatible<span style="font-family: DejaVu Sans;">兼容</span>with most database systems (MySQL, PostgreSQL and SQLite to name a few). Regardless of which database system you’re using, the Active Record method format will always be the same.</p>

<p>Active Record<span style="font-family: DejaVu Sans;">将会为你在数据库中执行查询并且它兼容大多数的数据库系统（</span>MySQL, PostgreSQL and SQLite<span style="font-family: DejaVu Sans;">这里仅仅列举这些）。不管你使用的是何种数据库系统，</span>Active Record<span style="font-family: DejaVu Sans;">的方法格式通常是相同的。</span></p>

<h3><a name="retrieving-objects-from-the-database"></a> 1 Retrieving Objects from the Database<span style="font-family: WenQuanYi Micro Hei;">在数据库中检索对象</span></h3>


<p>To retrieve objects from the database, Active Record provides several finder methods. Each finder method allows you to pass arguments into it to perform certain queries on your database without writing raw SQL.</p>

<p><span style="font-family: DejaVu Sans;">为了从数据库中检索对象，</span>Active Record<span style="font-family: DejaVu Sans;">提供了一些查询方法。每个查询方法都运行你带入参数并在数据库中执行查询而不用写</span>SQL<span style="font-family: DejaVu Sans;">自身的语句。</span></p>

<p>The methods are:</p>

<ul>
    <li><tt>where</tt></li>
    <li><tt>select</tt></li>
    <li><tt>group</tt></li>
    <li><tt>order</tt></li>
    <li><tt>reorder</tt></li>
    <li><tt>reverse_order</tt> <span style="font-family: DejaVu Sans;">逆向排序</span></li>
    <li><tt>limit</tt></li>
    <li><tt>offset</tt> <span style="font-family: DejaVu Sans;">偏移</span></li>
    <li><tt>joins</tt></li>
    <li><tt>includes</tt></li>
    <li><tt>lock</tt></li>
    <li><tt>readonly</tt></li>
    <li><tt>from</tt></li>
    <li><tt>having</tt></li>
</ul>


<p>All of the above methods return an instance of <tt>ActiveRecord::Relation</tt>.<span style="font-family: DejaVu Sans;">所有以上方法会返回一个</span><tt>ActiveRecord::Relation</tt><span style="font-family: DejaVu Sans;"><tt>的实例。</tt></span></p>

<p>Primary operation of <tt>Model.find(options)</tt> can be summarized as:</p>

<p><tt>Model.find(options)</tt><span style="font-family: DejaVu Sans;"><tt>主要的操作可以被概括为：</tt></span></p>

<ul>
    <li>Convert the supplied options to an equivalent SQL query. <span style="font-family: DejaVu Sans;">转换提供的（查询）选项为等同的</span>SQL<span style="font-family: DejaVu Sans;">查询</span></li>
    <li>Fire the SQL query and retrieve the corresponding results from the database. <span style="font-family: DejaVu Sans;">开始</span>SQL<span style="font-family: DejaVu Sans;">查询并且检索从数据库相应的结果</span></li>
    <li>Instantiate the equivalent Ruby object of the appropriate model for every resulting row. <span style="font-family: DejaVu Sans;">把每个（数据库中原生的）结果实例化等同的</span>Ruby<span style="font-family: DejaVu Sans;">对象</span></li>
    <li>Run <tt>after_find</tt> callbacks if any. <span style="font-family: DejaVu Sans;">运行</span><tt>after_find</tt><span style="font-family: DejaVu Sans;"><tt>进行回调如果需要</tt></span></li>
</ul>


<h4><a name="retrieving-a-single-object"></a>1.1 Retrieving a Single Object<span style="font-family: WenQuanYi Micro Hei;">检索单个对象</span></h4>


<p>Active Record lets you retrieve a single object using five different ways.</p>

<p>Active Record<span style="font-family: DejaVu Sans;">让你可以使用五种不同的方法检索单个对象。</span></p>

<h5><a name="using-a-primary-key"></a>1.1.1 Using a Primary Key<span style="font-family: WenQuanYi Micro Hei;">使用主键查询</span></h5>


<p>Using <tt>Model.find(primary_key)</tt>, you can retrieve the object corresponding to the supplied <em>primary</em><em> </em><em>key</em> and matching the supplied options (if any). For example:</p>

<p><span style="font-family: DejaVu Sans;"><tt>使用</tt></span><tt>Model.find(primary_key)</tt><span style="font-family: DejaVu Sans;"><tt>，你可以检索对象通过提供相应的主键或者匹配提供的其他选项（如果存在）。例如：</tt></span></p>

<p><tt><em>#</em></tt><tt><em> </em></tt><tt><em>Find</em></tt><tt><em> </em></tt><tt><em>the</em></tt><tt><em> </em></tt><tt><em>client</em></tt><tt><em> </em></tt><tt><em>with</em></tt><tt><em> </em></tt><tt><em>primary</em></tt><tt><em> </em></tt><tt><em>key</em></tt><tt><em> </em></tt><tt><em>(id)</em></tt><tt><em> </em></tt><tt><em>1.</em></tt></p>

<p><tt><em>rails</em></tt><tt><em> </em></tt><tt><em>console</em></tt></p>

<p><tt><em>Loading development environment (Rails 3.1.1)</em></tt></p>

<p><tt><em>irb(main):001:0&gt; p=Post.find(1)</em></tt></p>

<p><tt> </tt><tt><em>Post Load (9.0ms) SELECT &ldquo;posts&rdquo;.* FROM &ldquo;posts&rdquo; WHERE &ldquo;posts&rdquo;.&ldquo;id&rdquo; = ? LIMIT 1 [[&ldquo;id&rdquo;, 1]]</em></tt></p>

<p><tt><em>=&gt; #&lt;Post id: 1, name: &ldquo;</em></tt><span style="font-family: DejaVu Sans;"><tt><em>阿飞姐姐</em></tt></span><tt><em>&rdquo;, title: &ldquo;</em></tt><span style="font-family: DejaVu Sans;"><tt><em>接口姐姐</em></tt></span><tt><em>&rdquo;, content: &ldquo;12342424&rdquo;, created_at: &ldquo;2011-11-05 15:10:41&rdquo;, updated_at: &ldquo;2011-11-05 15:10:41&rdquo;&gt;</em></tt></p>

<p><tt>SQL</tt><tt> </tt><tt>equivalent</tt><tt> </tt><tt>of</tt><tt> </tt><tt>the</tt><tt> </tt><tt>above</tt><tt> </tt><tt>is:</tt></p>

<p><tt><em>SELECT * FROM posts WHERE (posts.id = 1)</em></tt></p>

<p><tt>Model.find(primary_key)</tt> will raise an <tt>ActiveRecord::RecordNotFound</tt> exception if no matching record is found.</p>

<p><tt>Model.find(primary_key)</tt><span style="font-family: DejaVu Sans;"><tt>如果没有记录匹配则会抛出一个</tt><tt></tt></span><tt>ActiveRecord::RecordNotFound</tt><span style="font-family: DejaVu Sans;"><tt>异常。</tt></span></p>

<h5><a name="first"></a>1.1.2 <tt>first</tt></h5>


<p><tt>Model.first</tt> finds the first record matched by the supplied options. For example:</p>

<p><tt>Model.first</tt><span style="font-family: DejaVu Sans;"><tt>找到与提供的选项匹配的第一条记录。例如：</tt></span></p>

<p><tt><em>client = Client.first</em></tt></p>

<p><tt><em>=&gt; #&lt;Client id: 1, first_name: &ldquo;Lifo&rdquo;&gt;</em></tt></p>

<p><tt><em>irb(main):018:0&gt; Post.first</em></tt></p>

<p><tt> </tt><tt><em>Post Load (0.4ms) SELECT &ldquo;posts&rdquo;.* FROM &ldquo;posts&rdquo; LIMIT 1</em></tt></p>

<p><tt><em>=&gt; #&lt;Post id: 2, name: &ldquo;jhjguxin&rdquo;, title: &ldquo;test console&rdquo;, content: &ldquo;A new post to test console&rdquo;, created_at: &ldquo;2011-11-05 15:55:17&rdquo;, updated_at: &ldquo;2011-11-05 15:55:17&rdquo;</em></tt></p>

<p>SQL equivalent of the above is:</p>

<p><tt><em>SELECT * FROM clients LIMIT 1</em></tt></p>

<p><tt>Model.first</tt> returns <tt>nil</tt> if no matching record is found. No exception will be raised.</p>

<p><span style="font-family: DejaVu Sans;"><tt>如果没有记录匹配</tt></span><tt>Model.first</tt><span style="font-family: DejaVu Sans;"><tt>会返回</tt></span><tt>nil</tt><span style="font-family: DejaVu Sans;"><tt>。不会抛出异常。</tt></span></p>

<h5><a name="last"></a>1.1.3 <tt>last</tt></h5>


<p><tt>Model.last</tt> finds the last record matched by the supplied options. For example:</p>

<p><tt><em>client = Client.last</em></tt></p>

<p><tt><em>=&gt; #&lt;Client id: 221, first_name: &ldquo;Russel&rdquo;&gt;</em></tt></p>

<p>SQL equivalent of the above is:<span style="font-family: DejaVu Sans;">上面等同的</span>SQL<span style="font-family: DejaVu Sans;">语句是：</span></p>

<p><tt><em>SELECT * FROM clients ORDER BY clients.id DESC LIMIT 1</em></tt></p>

<p><tt><em>##SELECT &ldquo;posts&rdquo;.* FROM &ldquo;posts&rdquo; ORDER BY &ldquo;posts&rdquo;.&ldquo;id&rdquo; DESC LIMIT 1</em></tt></p>

<p><tt>Model.last</tt> returns <tt>nil</tt> if no matching record is found. No exception will be raised.</p>

<p><span style="font-family: DejaVu Sans;">如果没有记录匹配</span><tt>Model.last</tt><span style="font-family: DejaVu Sans;"><tt>会返回</tt></span><tt>nil</tt><span style="font-family: DejaVu Sans;"><tt>。不会抛出异常。</tt></span></p>

<h4><a name="retrieving-multiple-objects"></a>1.2 Retrieving Multiple Objects<span style="font-family: WenQuanYi Micro Hei;">检索多个目标</span></h4>


<h5><a name="using-multiple-primary-keys"></a>1.2.1 Using Multiple Primary Keys<span style="font-family: WenQuanYi Micro Hei;">使用多个主键</span></h5>


<p><tt>Model.find(array_of_primary_key)</tt> also accepts an array of <em>primary</em><em> </em><em>keys</em>. An array of all the matching records for the supplied <em>primary</em><em> </em><em>keys</em> is returned. For example:</p>

<p><tt>Model.find(array_of_primary_key)</tt><span style="font-family: DejaVu Sans;"><tt>也接受一个主键数组。将会返回一个由所有与提供的主键匹配的记录组成的数组。例如：</tt></span></p>

<p><tt><em># Find the clients with primary keys 1 and 10.</em></tt></p>

<p><tt><em>client = Client.find(1, 10) # Or even Client.find([1, 10])</em></tt></p>

<p><tt><em>=&gt; [#&lt;Client id: 1, first_name: =&gt; &ldquo;Lifo&rdquo;&gt;, #&lt;Client id: 10, first_name: =&gt; &ldquo;Ryan&rdquo;&gt;]</em></tt></p>

<p>SQL equivalent of the above is:</p>

<p><tt><em>SELECT * FROM clients WHERE (clients.id IN (1,10))</em></tt></p>

<p><tt><span style="color: #800000;">Model.find(array_of_primary_key)</span></tt><span style="color: #800000;">will</span><span style="color: #800000;">raise</span><span style="color: #800000;">an</span><tt><span style="color: #800000;">ActiveRecord::RecordNotFound</span></tt><span style="color: #800000;">exception</span><span style="color: #800000;">unless</span><span style="color: #800000;">a</span><span style="color: #800000;">matching</span><span style="color: #800000;">record</span><span style="color: #800000;">is</span><span style="color: #800000;">found</span><span style="color: #800000;">for</span><strong><span style="color: #800000;">all</span></strong><span style="color: #800000;">of</span><span style="color: #800000;">the</span><span style="color: #800000;">supplied</span><span style="color: #800000;">primary</span><span style="color: #800000;">keys.</span></p>

<p><tt><span style="color: #800000;">Model.find(array_of_primary_key)</span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;">只要有一条记录没有找到就会抛出</span></tt><tt></tt></span><tt><span style="color: #800000;">ActiveRecord::RecordNotFound</span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;">异常</span></tt></span></p>

<p><tt><span style="color: #800000;">ActiveRecord::RecordNotFound:</span></tt><tt></tt><tt><span style="color: #800000;">Couldn&rsquo;t</span></tt><tt></tt><tt><span style="color: #800000;">find</span></tt><tt></tt><tt><span style="color: #800000;">all</span></tt><tt></tt><tt><span style="color: #800000;">Posts</span></tt><tt></tt><tt><span style="color: #800000;">with</span></tt><tt></tt><tt><span style="color: #800000;">IDs</span></tt><tt></tt><tt><span style="color: #800000;">(2,</span></tt><tt></tt><tt><span style="color: #800000;">4,</span></tt><tt></tt><tt><span style="color: #800000;">5)</span></tt><tt></tt><tt><span style="color: #800000;">(found</span></tt><tt></tt><tt><span style="color: #800000;">2</span></tt><tt></tt><tt><span style="color: #800000;">results,</span></tt><tt></tt><tt><span style="color: #800000;">but</span></tt><tt></tt><tt><span style="color: #800000;">was</span></tt><tt></tt><tt><span style="color: #800000;">looking</span></tt><tt></tt><tt><span style="color: #800000;">for</span></tt><tt></tt><tt><span style="color: #800000;">3)</span></tt></p>

<h4><a name="retrieving-multiple-objects-in-batches"></a> 1.3 Retrieving Multiple Objects in Batches<span style="font-family: WenQuanYi Micro Hei;">分批次的检索多个目标</span></h4>


<p>Sometimes you need to iterate<span style="font-family: DejaVu Sans;">反复重复</span>over a large set of records. For example to send a newsletter to all users, to export some data, etc.</p>

<p><span style="font-family: DejaVu Sans;">有时候你需要遍历大量的记录，例如发送一条业务通讯给所有的用户，输出一些数据，等等。</span></p>

<p>The following may seem very straight forward at first:</p>

<p><span style="font-family: DejaVu Sans;">首先（通过）以下内容看起来会非常直观</span></p>

<p><tt><em># Very inefficient when users table has thousands of rows.</em></tt></p>

<p><tt><em>User.all.each do |user|</em></tt></p>

<p><tt> </tt><tt><em>NewsLetter.weekly_deliver(user)</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>But if the total number of rows in the table is very large, the above approach may vary from being under performant to just plain<span style="font-family: DejaVu Sans;">平原</span>impossible.</p>

<p><span style="font-family: DejaVu Sans;">但是如果（数据）表单的行有非常大的量，上面的方法在执行（的时候）不可能性能（还是那么）平稳。</span></p>

<p>This is because <tt>User.all.each</tt> makes Active Record fetch <em>the</em><em> </em><em>entire</em><em> </em><em>table</em>, build a model object per row, and keep the entire array in the memory. Sometimes that is just too many objects and demands too much memory.</p>

<p><span style="font-family: DejaVu Sans;">这是因为</span><tt>User.all.each</tt><span style="font-family: DejaVu Sans;"><tt>使得</tt><tt></tt></span><tt>Active</tt><tt> </tt><tt>Record</tt><span style="font-family: DejaVu Sans;"><tt>获取整个表单，给每一行数据创建一个</tt></span><tt>object</tt><tt> </tt><tt>model</tt><span style="font-family: DejaVu Sans;"><tt>，并且保留整个数组在内存中。有时会有太多的对象并且需要太多的内存。</tt></span></p>

<p>&nbsp;</p>

<p><strong>Configuring</strong><strong> </strong><strong>the</strong><strong> </strong><strong>batch</strong><strong> </strong><strong>size<span style="font-family: DejaVu Sans;">配置批次大小</span></strong></p>

<p>Behind the scenes <tt>find_each</tt> fetches rows in batches of <tt>1000</tt> and yields them one by one. The size of the underlying batches is configurable via the <tt>:batch_size</tt> option.<span style="font-family: DejaVu Sans;">在使用</span><tt>find_each</tt><span style="font-family: DejaVu Sans;"><tt>获取</tt></span><tt>1000</tt><span style="font-family: DejaVu Sans;"><tt>次记录行并且一个接一个的</tt></span><tt>yield</tt><span style="font-family: DejaVu Sans;"><tt>它们的情况中。（确定）下面（查找）批次的大小是通过配置</tt></span><tt>:batch_size</tt><span style="font-family: DejaVu Sans;"><tt>选项。</tt></span></p>

<p>To fetch <tt>User</tt> records in batch size of <tt>5000</tt>:</p>

<p><tt><em>User.find_each(:batch_size =&gt; 5000) do |user|</em></tt></p>

<p><tt> </tt><tt><em>NewsLetter.weekly_deliver(user)</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>&nbsp;</p>

<p><strong>Starting</strong><strong> </strong><strong>batch</strong><strong> </strong><strong>find</strong><strong> </strong><strong>from</strong><strong> </strong><strong>a</strong><strong> </strong><strong>specific</strong><strong> </strong><strong>primary</strong><strong> </strong><strong>key<span style="font-family: DejaVu Sans;">通过一个指定的主键开始批次查找</span></strong></p>

<p>Records are fetched in ascending order on the primary key, which must be an integer. The <tt>:start</tt> option allows you to configure the first ID of the sequence if the lowest is not the one you need. This may be useful for example to be able to resume an interrupted batch process if it saves the last processed ID as a checkpoint.<span style="font-family: DejaVu Sans;">这会非常有用比如能够减少因为设置最后处理的</span>ID<span style="font-family: DejaVu Sans;">作为</span>checkpoint<span style="font-family: DejaVu Sans;">引起的中断。</span></p>

<p><span style="font-family: DejaVu Sans;">（这里）是按照主键值的升序排列获取记录的，主键值必须是整数。</span><tt>:start</tt><span style="font-family: DejaVu Sans;"><tt>选项允许你配置序列的开始</tt></span><tt>ID</tt><span style="font-family: DejaVu Sans;"><tt>如果排序最低的（记录）不是你需要的。</tt></span></p>

<p>To send newsletters only to users with the primary key starting from <tt>2000</tt>:</p>

<p>User.find_each(:batch_size =&gt; 5000, :start =&gt; 2000) do |user|</p>

<p>NewsLetter.weekly_deliver(user)</p>

<p>end</p>

<p><strong>Additional</strong><strong> </strong><strong>options<span style="font-family: DejaVu Sans;">其他（附加）选项</span></strong></p>

<p><tt>find_each</tt> accepts the same options as the regular <tt>find</tt> method. However, <tt>:order</tt> and <tt>:limit</tt> are needed internally and hence not allowed to be passed explicitly.</p>

<p><tt>find_each</tt><span style="font-family: DejaVu Sans;"><tt>接受和正则</tt></span><tt>find</tt><span style="font-family: DejaVu Sans;"><tt>方法相同的选项。</tt></span></p>

<h5><a name="find_in_batches"></a>1.3.2 <tt>find_in_batches</tt></h5>


<p>You can also work by chunks instead of row by row using <tt>find_in_batches</tt>. This method is analogous to <tt>find_each</tt>, but it yields arrays of models instead:</p>

<p><span style="font-family: DejaVu Sans;"><tt>通过使用</tt></span><tt>find_in_batches</tt><span style="font-family: DejaVu Sans;">你也可以用</span>chunks<span style="font-family: DejaVu Sans;"><span style="font-family: Liberation Serif,Times New Roman,serif;">替代数据行。这个方法类似于 </span></span><tt>find_each</tt><span style="font-family: DejaVu Sans;"><tt>，但是作为替代它（会输出）到一个数组区域：</tt></span></p>

<p><tt><em># Works in chunks of 1000 invoices at a time.</em></tt></p>

<p><tt><em>Invoice.find_in_batches(:include =&gt; :invoice_lines) do |invoices|</em></tt></p>

<p><tt> </tt><tt><em>export.add_invoices(invoices)</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>The above will yield the supplied block with <tt>1000</tt> invoices every time.<span style="font-family: DejaVu Sans;">上面的语句每次会提供给语句</span>1000invoices<span style="font-family: DejaVu Sans;">。</span></p>

<h3><a name="conditions"></a>2 Conditions<span style="font-family: WenQuanYi Micro Hei;">条件</span></h3>


<p>The <tt>where</tt> method allows you to specify conditions to limit the records returned, representing the <tt>WHERE</tt>-part of the SQL statement. Conditions can either be specified as a string, array, or hash.</p>

<p>where<span style="font-family: DejaVu Sans;">方法允许你指定条件限制记录返回（的内容），表示</span>SQL<span style="font-family: DejaVu Sans;">部分的</span>WHERE<span style="font-family: DejaVu Sans;">部分。条件可以指定为一个字符串，数组，或者</span>hash<span style="font-family: DejaVu Sans;">（字典）。</span></p>

<h4><a name="pure-string-conditions"></a>2.1 Pure String Conditions<span style="font-family: WenQuanYi Micro Hei;">纯字符串条件</span></h4>


<p>If you’d like to add conditions to your find, you could just specify them in there, just like <tt>Client.where(&ldquo;orders_count</tt><tt> </tt><tt>=</tt><tt> </tt><tt>&lsquo;2&rsquo;&rdquo;)</tt>. This will find all clients <strong>where</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>orders_count</strong></tt><strong> </strong><strong>field</strong><strong>’</strong><strong>s</strong><strong> </strong><strong>value</strong><strong> </strong><strong>is</strong><strong> </strong><strong>2</strong>.</p>

<p><strong>Building</strong><strong> </strong><strong>your</strong><strong> </strong><strong>own</strong><strong> </strong><strong>conditions</strong><strong> </strong><strong>as</strong><strong> </strong><strong>pure</strong><strong> </strong><strong>strings</strong><strong> </strong><strong>can</strong><strong> </strong><strong>leave</strong><strong> </strong><strong>you</strong><strong> </strong><strong>vulnerable</strong><span style="font-family: DejaVu Sans;"><strong>脆弱</strong></span><strong>to</strong><strong> </strong><strong>SQL</strong><strong> </strong><strong>injection</strong><span style="font-family: DejaVu Sans;"><strong>注入</strong></span><strong>exploits</strong><span style="font-family: DejaVu Sans;"><strong>漏洞</strong></span><strong>.</strong> For example, <tt>Client.where(&ldquo;first_name</tt><tt> </tt><tt>LIKE</tt><tt> </tt><tt>&lsquo;%#{params[:first_name]}%&rsquo;&rdquo;)</tt> is not safe. See the next section for the preferred way to handle conditions using an array.</p>

<h4><a name="array-conditions"></a>2.2 Array Conditions</h4>


<p>Now what if that number could vary, say as an argument from somewhere? The find then becomes something like:</p>

<p><span style="font-family: DejaVu Sans;">现在，如果这个数字可能会有所不同，（比如说）作为某个地方的一个参数？查找会变成如下：</span></p>

<p><tt><span style="color: #000000;"><span style="font-size: small;"><em>Client.where(&ldquo;orders_count = ?&rdquo;, params[:orders])</em></span></span></tt></p>

<p>Active Record will go through the first element in the conditions value and any additional elements will replace the question marks <tt>(?)</tt> in the first element.</p>

<p>Active Record<span style="font-family: DejaVu Sans;">将会在第一个元素中表示条件（语句）并且其他元素取代第一个元素中的问号。</span></p>

<p>Or if you want to specify two conditions, you can do it like:</p>

<p><tt><em>Client.where(&ldquo;orders_count = ? AND locked = ?&rdquo;, params[:orders], false)</em></tt></p>

<p>In this example, the first question mark will be replaced with the value in <tt>params[:orders]</tt> and the second will be replaced with the SQL representation of <tt>false</tt>, which depends on the adapter.</p>

<p>The reason for doing code like:</p>

<p><tt><em>Client.where(&ldquo;orders_count = ?&rdquo;, params[:orders])</em></tt></p>

<p>instead of:</p>

<p><tt><em>Client.where(&ldquo;orders_count = #{params[:orders]}&rdquo;)</em></tt></p>

<p>is because of argument safety. Putting the variable directly into the conditions string will pass the variable to the database <strong>as-is</strong>. This means that it will be an unescaped variable directly from a user who may have malicious intent. If you do this, you put your entire database at risk because once a user finds out he or she can exploit your database they can do just about anything to it. Never ever put your arguments directly inside the conditions string.</p>

<p><span style="font-family: DejaVu Sans;">（这里）是基于参数安全（考虑）。将变量直接放入条件字符串将会（原封不动的传送变量）到数据库。他的意思是这个参数有可能将会是以一个来自用户的恶意的非转义的变量。如果你这样做，你就把整个数据库放在了风险之中，因为一旦有用户找到他们或者它可以利用（漏洞）对你数据库做任何操作。永远不要直接把你的参数放在条件字符串中。</span></p>

<p>For more information on the dangers of SQL injection, see the <a href="http://guides.rubyonrails.org/security.html#sql-injection"><span style="color: #000080;"><span style="text-decoration: underline;">Ruby</span></span><span style="color: #000080;"><span style="text-decoration: underline;">on</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Rails</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Security</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Guide</span></span></a>.</p>

<h5><a name="placeholder-conditions"></a>2.2.1 Placeholder Conditions<span style="font-family: WenQuanYi Micro Hei;">条件（参数）占位符</span></h5>


<p>Similar to the <tt>(?)</tt> replacement style of params, you can also specify keys/values hash in your array conditions:<span style="font-family: DejaVu Sans;">最简单的是使用（？）替代参数的形式，你也可以指定</span>keys/values hash<span style="font-family: DejaVu Sans;">在你的条件语句数组中：</span></p>

<p><tt><em>Client.where(&ldquo;created_at &gt;= :start_date AND created_at &lt;= :end_date&rdquo;,</em></tt></p>

<p><tt> </tt><tt><em>{:start_date =&gt; params[:start_date], :end_date =&gt; params[:end_date]})</em></tt></p>

<p>This makes for clearer readability if you have a large number of variable conditions.<span style="font-family: DejaVu Sans;">当你有大量的条件变量时这样表示更加简洁和可读性更好。</span></p>

<h5><a name="array-range_conditions"></a>2.2.2 Range Conditions<span style="font-family: WenQuanYi Micro Hei;">范围条件</span></h5>


<p>If you’re looking for a range inside of a table (for example, users created in a certain timeframe) you can use the conditions option coupled with the <tt>IN</tt> SQL statement for this. If you had two dates coming in from a controller you could do something like this to look for a range:</p>

<p><span style="font-family: DejaVu Sans;">如果你正在一个表中限定一个条件范围查找（例如，用户限定在一定的时间表中创建）你可以使用条件选项加上（这个参数的）</span>IN SQL<span style="font-family: DejaVu Sans;">声明。如果有来自一个</span>controller<span style="font-family: DejaVu Sans;">的两个日期，你可以做些事情查找一个范围：</span></p>

<p><tt><em>Client.where(:created_at =&gt; (params[:start_date].to_date)..(params[:end_date].to_date))</em></tt></p>

<p><tt><em>This query will generate something similar to the following SQL:</em></tt></p>

<p><tt><em>SELECT &ldquo;clients&rdquo;.* FROM &ldquo;clients&rdquo; WHERE (&ldquo;clients&rdquo;.&ldquo;created_at&rdquo; BETWEEN &lsquo;2010-09-29&rsquo; AND &lsquo;2010-11-30&rsquo;)</em></tt></p>

<h4><a name="hash-conditions"></a>2.3 Hash Conditions Hash<span style="font-family: WenQuanYi Micro Hei;">字典条件</span></h4>


<p>Active Record also allows you to pass in hash conditions which can increase the readability of your conditions syntax. With hash conditions, you pass in a hash with keys of the fields you want conditionalised and the values of how you want to conditionalise them:</p>

<p>Active Record<span style="font-family: DejaVu Sans;">同样也允许你通过</span>hash<span style="font-family: DejaVu Sans;">条件来增加你条件语句的可读性。在</span>hash<span style="font-family: DejaVu Sans;">条件，以键作为你的条件化参数并且相应的值则是具体的条件限制。</span></p>

<p>Only equality, range and subset checking are possible with Hash conditions.</p>

<h5><a name="equality-conditions"></a>2.3.1 Equality Conditions<span style="font-family: WenQuanYi Micro Hei;">等同条件</span></h5>


<p><tt><em>Client.where(:locked =&gt; true)</em></tt></p>

<p><strong>The</strong><strong> </strong><strong>field</strong><strong> </strong><strong>name</strong><strong> </strong><strong>can</strong><strong> </strong><strong>also</strong><strong> </strong><strong>be</strong><strong> </strong><strong>a</strong><strong> </strong><strong>string:</strong></p>

<p><tt><em>Client.where(&lsquo;locked&rsquo; =&gt; true)</em></tt></p>

<h5><a name="hash-range_conditions"></a>2.3.2 Range Conditions</h5>


<p>The good thing about this is that we can pass in a range for our fields without it generating a large query as shown in the preamble of this section.</p>

<p><tt><em>Client.where(:created_at =&gt; (Time.now.midnight – 1.day)..Time.now.midnight)</em></tt></p>

<p>This will find all clients created yesterday by using a <tt>BETWEEN</tt> SQL statement:</p>

<p><span style="font-family: DejaVu Sans;">这将会通过使用一个</span><tt>BETWEEN</tt> SQL<span style="font-family: DejaVu Sans;">声明查找</span>client<span style="font-family: DejaVu Sans;">中昨天创建的记录。</span></p>

<p><tt><em>SELECT * FROM clients WHERE (clients.created_at BETWEEN &lsquo;2008-12-21 00:00:00&rsquo; AND &lsquo;2008-12-22 00:00:00&rsquo;)</em></tt></p>

<p>This demonstrates a shorter syntax for the examples in <a href="http://guides.rubyonrails.org/active_record_querying.html#array-conditions"><span style="color: #000080;"><span style="text-decoration: underline;">Array</span></span><span style="color: #000080;"><span style="text-decoration: underline;">Conditions</span></span></a></p>

<h5><a name="subset-conditions"></a>2.3.3 Subset Conditions<span style="font-family: WenQuanYi Micro Hei;">子集条件</span></h5>


<p>If you want to find records using the <tt>IN</tt> expression you can pass an array to the conditions hash:</p>

<p><span style="font-family: DejaVu Sans;">如果想使用</span>IN<span style="font-family: DejaVu Sans;">表达式查找记录你可以在条件</span>hash<span style="font-family: DejaVu Sans;">字典中加上一个数组：</span></p>

<p><tt><em>Client.where(:orders_count =&gt; [1,3,5])</em></tt></p>

<p>This code will generate SQL like this:</p>

<p><tt><em>SELECT * FROM clients WHERE (clients.orders_count IN (1,3,5))</em></tt></p>

<h3><a name="ordering"></a>3 Ordering<span style="font-family: WenQuanYi Micro Hei;">排序</span></h3>


<p>To retrieve records from the database in a specific order, you can use the <tt><strong>order</strong></tt> method.</p>

<p><span style="font-family: DejaVu Sans;">如果你想检索记录从数据库中并且以一种指定的方式排序，你可以使用</span>order<span style="font-family: DejaVu Sans;">方法。</span></p>

<p>For example, if you’re getting a set of records and want to order them in ascending order by the <tt>created_at</tt> field in your table:</p>

<p><tt><em>Client.order(&ldquo;created_at&rdquo;)</em></tt></p>

<p><tt><em>You could specify ASC or DESC as well:</em></tt></p>

<p><tt><em>Client.order(&ldquo;created_at DESC&rdquo;)</em></tt></p>

<p><tt><em># OR</em></tt></p>

<p><tt><em>Client.order(&ldquo;created_at ASC&rdquo;)</em></tt></p>

<p>Or ordering by multiple fields:<span style="font-family: DejaVu Sans;">或者按照多个</span>fields<span style="font-family: DejaVu Sans;">排序：</span></p>

<p><tt><em>Client.order(&ldquo;orders_count ASC, created_at DESC&rdquo;)</em></tt></p>

<h3><a name="selecting-specific-fields"></a>4 Selecting Specific Fields</h3>


<p>By default, <tt>Model.find</tt> selects all the fields from the result set using <tt>select</tt><tt> </tt><tt>*</tt>.</p>

<p><span style="font-family: DejaVu Sans;">默认情况中，</span><tt>Model.find</tt><span style="font-family: DejaVu Sans;"><tt>会选择所有的</tt></span><tt>fields</tt><span style="font-family: DejaVu Sans;"><tt>作为结果并且（对数据库执行）</tt></span><tt>select</tt><tt> </tt><tt>*</tt><span style="font-family: DejaVu Sans;"><tt>。</tt></span></p>

<p>To select only a subset of fields from the result set, you can specify the subset via the <tt>select</tt> method.</p>

<p><span style="font-family: DejaVu Sans;">要想只选中</span>fields<span style="font-family: DejaVu Sans;">中的一个子集作为结果，你可以通过</span>select<span style="font-family: DejaVu Sans;">方法指定子集。</span></p>

<p><span style="color: #800000;">If</span><span style="color: #800000;">the</span><tt><span style="color: #800000;">select</span></tt><span style="color: #800000;">method</span><span style="color: #800000;">is</span><span style="color: #800000;">used,</span><span style="color: #800000;">all</span><span style="color: #800000;">the</span><span style="color: #800000;">returning</span><span style="color: #800000;">objects</span><span style="color: #800000;">will</span><span style="color: #800000;">be</span><a href="http://guides.rubyonrails.org/active_record_querying.html#readonly-objects"><span style="color: #000080;"><span style="text-decoration: underline;">read</span></span><span style="color: #000080;"><span style="text-decoration: underline;">only</span></span></a><span style="color: #800000;">.</span></p>

<p>For example, to select only <tt>viewable_by</tt> and <tt>locked</tt> columns:</p>

<p><tt><em>Client.select(&ldquo;viewable_by, locked&rdquo;)</em></tt></p>

<p>The SQL query used by this find call will be somewhat like:</p>

<p><tt><em>SELECT viewable_by, locked FROM clients</em></tt></p>

<p>Be careful because this also means you’re initializing a model object with only the fields that you’ve selected. <strong>If</strong><strong> </strong><strong>you</strong><strong> </strong><strong>attempt</strong><strong> </strong><strong>to</strong><strong> </strong><strong>access</strong><strong> </strong><strong>a</strong><strong> </strong><strong>field</strong><strong> </strong><strong>that</strong><strong> </strong><strong>is</strong><strong> </strong><strong>not</strong><strong> </strong><strong>in</strong><strong> </strong><strong>the</strong><strong> </strong><strong>initialized</strong><strong> </strong><strong>record</strong><strong> </strong><strong>you</strong><strong>’</strong><strong>ll</strong><strong> </strong><strong>receive</strong>:</p>

<p>ActiveModel::MissingAttributeError: missing attribute: &lt;attribute&gt;</p>

<p><strong>Where</strong><strong> </strong><tt><strong>&lt;attribute&gt;</strong></tt><strong> </strong><strong>is</strong><strong> </strong><strong>the</strong><strong> </strong><strong>attribute</strong><strong> </strong><strong>you</strong><strong> </strong><strong>asked</strong><strong> </strong><strong>for.</strong> The <tt>id</tt> method will not raise the <tt>ActiveRecord::MissingAttributeError</tt>, so just be careful when working with associations because they need the <tt>id</tt> method to function properly.</p>

<p>You can also call SQL functions within the select option. For example, if you would like to only grab a single record per unique value in a certain field by using the <tt>DISTINCT</tt> function you can do it like this:</p>

<p><tt><em>Client.select(&ldquo;DISTINCT(name)&rdquo;)</em></tt></p>

<p>&nbsp;</p>

<h3><a name="limit-and-offset"></a>5 Limit and Offset</h3>


<p>To apply <tt>LIMIT</tt> to the SQL fired by the <tt>Model.find</tt>, <strong>you</strong><strong> </strong><strong>can</strong><strong> </strong><strong>specify</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>LIMIT</strong></tt><strong> </strong><strong>using</strong><strong> </strong><tt><strong>limit</strong></tt><strong> </strong><strong>and</strong><strong> </strong><tt><strong>offset</strong></tt><strong> </strong><strong>methods</strong><strong> </strong><strong>on</strong><strong> </strong><strong>the</strong><strong> </strong><strong>relation.</strong></p>

<p>You can use <tt>limit</tt> to specify the number of records to be retrieved, and use <tt>offset</tt> to specify the number of records to skip before starting to return the records. For example</p>

<p><tt><em>Client.limit(5)</em></tt></p>

<p>will return a maximum of 5 clients and because it specifies no offset it will return the first 5 in the table. The SQL it executes looks like this:</p>

<p><tt><em>SELECT * FROM clients LIMIT 5</em></tt></p>

<p>Adding <tt>offset</tt> to that</p>

<p><tt><em>Client.limit(5).offset(30)</em></tt></p>

<p>will return instead a maximum of 5 clients beginning with the 31st. The SQL looks like:</p>

<p><span style="font-family: DejaVu Sans;">将会返回最大</span>5<span style="font-family: DejaVu Sans;">个</span>clients<span style="font-family: DejaVu Sans;">并且从第</span>31<span style="font-family: DejaVu Sans;">个开始。这个</span>SQL<span style="font-family: DejaVu Sans;">看起来是：</span></p>

<p><tt><em>SELECT * FROM clients LIMIT 5 OFFSET 30</em></tt></p>

<h3><a name="group"></a>6 Group</h3>


<p>To apply a <tt>GROUP</tt><tt> </tt><tt>BY</tt> clause to the SQL fired by the finder, you can specify the <tt>group</tt> method on the find.</p>

<p>For example, if you want to find a collection of the dates orders were created on:</p>

<p><tt><em>Order.select(&ldquo;date(created_at) as ordered_date, sum(price) as total_price&rdquo;).group(&ldquo;date(created_at)&rdquo;)</em></tt></p>

<p>And this will give you a single <tt>Order</tt><span style="font-family: DejaVu Sans;"><tt>生产者</tt></span>object for each date where there are orders in the database.</p>

<p>The SQL that would be executed would be something like this:</p>

<p><tt><em>SELECT date(created_at) as ordered_date, sum(price) as total_price FROM orders GROUP BY date(created_at)</em></tt></p>

<h3><a name="having"></a>7 Having</h3>


<p>SQL uses the <tt>HAVING</tt> clause<span style="font-family: DejaVu Sans;">短语</span>to specify conditions on the <tt>GROUP</tt><tt> </tt><tt>BY</tt> fields. You can add the <tt>HAVING</tt> clause to the SQL fired by the <tt>Model.find</tt> by adding the <tt>:having</tt> option to the find.</p>

<p>For example:</p>

<p><tt><em>Order.select(&ldquo;date(created_at) as ordered_date, sum(price) as total_price&rdquo;).group(&ldquo;date(created_at)&rdquo;).having(&ldquo;sum(price) &gt; ?&rdquo;, 100)</em></tt></p>

<p>The SQL that would be executed would be something like this:</p>

<p><tt><em>SELECT date(created_at) as ordered_date, sum(price) as total_price FROM orders GROUP BY date(created_at) HAVING sum(price) &gt; 100</em></tt></p>

<p>This will return single order objects for each day, but only those that are ordered more than $100 in a day.</p>

<h3><a name="overriding-conditions"></a>8 Overriding Conditions<span style="font-family: WenQuanYi Micro Hei;">覆盖条件</span></h3>


<h4><a name="except"></a>8.1 <tt>except</tt><span style="font-family: WenQuanYi Micro Hei;"><tt>排除</tt></span></h4>


<p>You can specify certain conditions to be excepted by using the <tt>except</tt> method. For example:</p>

<p><tt><em>Post.where(&lsquo;id &gt; 10&rsquo;).limit(20).order(&lsquo;id asc&rsquo;).except(:order)#</em></tt><span style="font-family: DejaVu Sans;"><tt><em>取消排序</em></tt></span></p>

<p><tt><em>The SQL that would be executed:</em></tt></p>

<p><tt><em>SELECT * FROM posts WHERE id &gt; 10 LIMIT 20</em></tt></p>

<p><tt><em>irb(main):006:0&gt; Post.where(&lsquo;id &gt; 1&rsquo;).limit(20).order(&lsquo;id desc&rsquo;)</em></tt></p>

<p><tt> </tt><tt><em>Post Load (0.4ms) SELECT &ldquo;posts&rdquo;.* FROM &ldquo;posts&rdquo; WHERE (id &gt; 1) ORDER BY id desc LIMIT 20</em></tt></p>

<p><tt><em>=&gt; [#&lt;Post id: 4, name: &ldquo;2134&rdquo;, title: &ldquo;2134&rdquo;, content: &ldquo;21343242134&rdquo;, created_at: &ldquo;2011-11-09 10:25:38&rdquo;, updated_at: &ldquo;2011-11-09 10:25:38&rdquo;&gt;, #&lt;Post id: 2, name: &ldquo;jhjguxin&rdquo;, title: &ldquo;test console&rdquo;, content: &ldquo;A new post to test console&rdquo;, created_at: &ldquo;2011-11-05 15:55:17&rdquo;, updated_at: &ldquo;2011-11-05 15:55:17&rdquo;&gt;]</em></tt></p>

<p><tt><em>irb(main):007:0&gt; Post.where(&lsquo;id &gt; 1&rsquo;).limit(20).order(&lsquo;id desc&rsquo;).except(:order)</em></tt></p>

<p><tt> </tt><tt><em>Post Load (0.4ms) SELECT &ldquo;posts&rdquo;.* FROM &ldquo;posts&rdquo; WHERE (id &gt; 1) LIMIT 20</em></tt></p>

<p><tt><em>=&gt; [#&lt;Post id: 2, name: &ldquo;jhjguxin&rdquo;, title: &ldquo;test console&rdquo;, content: &ldquo;A new post to test console&rdquo;, created_at: &ldquo;2011-11-05 15:55:17&rdquo;, updated_at: &ldquo;2011-11-05 15:55:17&rdquo;&gt;, #&lt;Post id: 4, name: &ldquo;2134&rdquo;, title: &ldquo;2134&rdquo;, content: &ldquo;21343242134&rdquo;, created_at: &ldquo;2011-11-09 10:25:38&rdquo;, updated_at: &ldquo;2011-11-09 10:25:38&rdquo;&gt;]</em></tt></p>

<h4><a name="only"></a>8.2 <tt>only</tt></h4>


<p>You can also override conditions using the <tt>only</tt> method. For example:</p>

<p><tt><em>Post.where(&lsquo;id &gt; 10&rsquo;).limit(20).order(&lsquo;id desc&rsquo;).only(:order, :where)</em></tt></p>

<p>The SQL that would be executed:</p>

<p><tt><em>SELECT * FROM posts WHERE id &gt; 10 ORDER BY id DESC</em></tt></p>

<h4><a name="reorder"></a>8.3 <tt>reorder</tt></h4>


<p>The <tt>reorder</tt> method overrides the default scope order. For example:</p>

<p><tt><em>class Post &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>..</em></tt></p>

<p><tt> </tt><tt><em>..</em></tt></p>

<p><tt> </tt><tt><em>has_many :comments, :order =&gt; &lsquo;posted_at DESC&rsquo;</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>Post.find(10).comments.reorder(&lsquo;name&rsquo;)</em></tt></p>

<p>The SQL that would be executed:</p>

<p><tt><em>SELECT * FROM posts WHERE id = 10 ORDER BY name</em></tt></p>

<p>In case the <tt>reorder</tt> clause is not used, the SQL executed would be:</p>

<p><tt><em>SELECT * FROM posts WHERE id = 10 ORDER BY posted_at DESC</em></tt></p>

<p>If no ordering clause is specified in the query, the <tt>reverse_order</tt> orders by the primary key in reverse<span style="font-family: DejaVu Sans;">撤销</span>order.</p>

<p><tt><em>Client.where(&ldquo;orders_count &gt; 10&rdquo;).reverse_order</em></tt></p>

<p>The SQL that would be executed:</p>

<p><tt><em>SELECT * FROM clients WHERE orders_count &gt; 10 ORDER BY clients.id DESC</em></tt></p>

<p><strong>This</strong><strong> </strong><strong>method</strong><strong> </strong><strong>accepts</strong><strong> </strong><strong><strong>no</strong></strong><strong> </strong><strong>arguments.</strong></p>

<h3><a name="readonly-objects"></a>9 Readonly Objects</h3>


<p>Active Record provides <tt>readonly</tt> method on a relation to explicitly disallow modification or deletion of any of the returned object. Any attempt to alter or destroy a readonly record will not succeed, raising an <tt>ActiveRecord::ReadOnlyRecord</tt> exception.</p>

<p><tt><em>client = Client.readonly.first</em></tt></p>

<p><tt><em>client.visits += 1</em></tt></p>

<p><tt><em>client.save</em></tt></p>

<p><strong>As</strong><strong> </strong><tt><strong>client</strong></tt><strong> </strong><strong>is</strong><strong> </strong><strong>explicitly</strong><strong> </strong><strong>set</strong><strong> </strong><strong>to</strong><strong> </strong><strong>be</strong><strong> </strong><strong>a</strong><strong> </strong><strong>readonly</strong><strong> </strong><strong>object</strong>, the above code will raise an <tt>ActiveRecord::ReadOnlyRecord</tt> exception when<strong> </strong><strong>calling</strong><strong> </strong><tt><strong>client.save</strong></tt><strong> </strong><strong>with</strong><strong> </strong><strong>an</strong><strong> </strong><strong>updated</strong><strong> </strong><strong>value</strong><strong> </strong><strong>of</strong><strong> </strong><em><strong>visits</strong></em>.</p>

<h3><a name="locking-records-for-update"></a>10 Locking Records for Update</h3>


<p>Locking is helpful for preventing race conditions when updating records in the database and ensuring atomic updates.</p>

<p>Active Record provides two locking mechanisms:</p>

<ul>
    <li>Optimistic<span style="font-family: DejaVu Sans;">乐观</span>Locking</li>
    <li>Pessimistic<span style="font-family: DejaVu Sans;">悲观</span>Locking</li>
</ul>


<h4><a name="optimistic-locking"></a>10.1 Optimistic Locking</h4>


<p><strong>Optimistic</strong><strong> </strong><strong>locking</strong><strong> </strong><strong>allows</strong><strong> </strong><strong>multiple</strong><strong> </strong><strong>users</strong><strong> </strong><strong>to</strong><strong> </strong><strong>access</strong><strong> </strong><strong>the</strong><strong> </strong><strong>same</strong><strong> </strong><strong>record</strong><strong> </strong><strong>for</strong><strong> </strong><strong>edits</strong>, and assumes<span style="font-family: DejaVu Sans;">假定</span>a minimum of conflicts with the data. It does this by <strong>checking</strong><strong> </strong><strong>whether</strong><strong> </strong><strong>another</strong><strong> </strong><strong>process</strong><strong> </strong><strong>has</strong><strong> </strong><strong>made</strong><strong> </strong><strong>changes</strong> to a record <strong>since</strong><strong> </strong><strong>it</strong><strong> </strong><strong>was</strong><strong> </strong><strong>opened</strong>. An <tt>ActiveRecord::StaleObjectError</tt> exception is thrown if that has occurred<span style="font-family: DejaVu Sans;">发生</span>and the update is ignored.</p>

<p><strong>Optimistic</strong><strong> </strong><strong>locking</strong><strong> </strong><strong>column</strong></p>

<p><strong>In</strong><strong> </strong><strong>order</strong><strong> </strong><strong>to</strong><strong> </strong><strong>use</strong><strong> </strong><strong>optimistic</strong><strong> </strong><strong>locking</strong>, the table <strong>needs</strong><strong> </strong><strong>to</strong><strong> </strong><strong>have</strong><strong> </strong><strong>a</strong><strong> </strong><strong>column</strong><strong> </strong><strong>called</strong><strong> </strong><tt><strong>lock_version</strong></tt>. Each time the record is <strong>updated</strong>, Active Record increments the <tt><strong>lock_version</strong></tt> column. If an update request is made with a lower value in the <tt>lock_version</tt> field than is currently in the <tt>lock_version</tt> column in the database, the update request will fail with an <tt>ActiveRecord::StaleObjectError</tt>. Example:</p>

<p><tt><em>c1 = Client.find(1)</em></tt></p>

<p><tt><em>c2 = Client.find(1)</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>c1.first_name = &ldquo;Michael&rdquo;</em></tt></p>

<p><tt><em>c1.save</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>c2.name = &ldquo;should fail&rdquo;</em></tt></p>

<p><tt><em>c2.save # Raises a ActiveRecord::StaleObjectError</em></tt></p>

<p>You’re then responsible<span style="font-family: DejaVu Sans;">有责任</span>for dealing<span style="font-family: DejaVu Sans;">处理</span>with the conflict by rescuing the exception and either rolling back, merging, or otherwise apply the business logic needed to resolve the conflict.</p>

<p><span style="color: #800000;">You</span><span style="color: #800000;">must</span><span style="color: #800000;">ensure</span><span style="color: #800000;">that</span><span style="color: #800000;">your</span><span style="color: #800000;">database</span><span style="color: #800000;">schema</span><span style="color: #800000;">defaults</span><span style="color: #800000;">the</span><tt><span style="color: #800000;">lock_version</span></tt><span style="color: #800000;">column</span><span style="color: #800000;">to</span><tt><span style="color: #800000;">0</span></tt><span style="color: #800000;">.</span></p>

<p>This behavior can be turned off by setting <tt><strong>ActiveRecord::Base.lock_optimistically</strong></tt><tt><strong> </strong></tt><tt><strong>=</strong></tt><tt><strong> </strong></tt><tt><strong>false</strong></tt><strong>.</strong></p>

<p><strong>To</strong><strong> </strong><strong>override</strong><strong> </strong><strong>the</strong><strong> </strong><strong>name</strong><strong> </strong><strong>of</strong><strong> </strong><strong>the</strong><strong> </strong><tt><strong>lock_version</strong></tt><strong> </strong><strong>column</strong>, <tt>ActiveRecord::Base</tt> provides a class method called <tt>set_locking_column</tt>:</p>

<p><tt><em>class Client &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>set_locking_column :lock_client_column</em></tt></p>

<p><tt><em>end</em></tt></p>

<h4><a name="pessimistic-locking"></a>10.2 Pessimistic Locking</h4>


<p>Pessimistic locking uses a locking mechanism provided by the underlying<span style="font-family: DejaVu Sans;">底层</span>database. Using <tt>lock</tt> when building a relation obtains an exclusive lock on the selected rows. Relations using <tt>lock</tt> are usually wrapped inside a transaction for preventing deadlock conditions.</p>

<p><span style="font-family: DejaVu Sans;">在语句块的一个流程中使用</span>lock<span style="font-family: DejaVu Sans;">通常是为了防止死锁情况出现。</span></p>

<p>For example:</p>

<p><tt><em>Item.transaction do</em></tt></p>

<p><tt> </tt><tt><em>i = Item.lock.first</em></tt></p>

<p><tt> </tt><tt><em>i.name = &lsquo;Jones&rsquo;</em></tt></p>

<p><tt> </tt><tt><em>i.save</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>The above session produces the following SQL for a MySQL backend:</p>

<p>You can also pass raw SQL to the <tt>lock</tt> method for allowing different types of locks. For example, MySQL has an expression called <tt>LOCK</tt><tt> </tt><tt>IN</tt><tt> </tt><tt>SHARE</tt><tt> </tt><tt>MODE</tt> where you can lock a record but still allow other queries to read it. To specify this expression just pass it in as the lock option:</p>

<p><tt><em>SQL (0.2ms) BEGIN</em></tt></p>

<p><tt><em>Item Load (0.3ms) SELECT * FROM <code>items</code> LIMIT 1 FOR UPDATE</em></tt></p>

<p><tt><em>Item Update (0.4ms) UPDATE <code>items</code> SET <code>updated_at</code> = &lsquo;2009-02-07 18:05:56&rsquo;, <code>name</code> = &lsquo;Jones&rsquo; WHERE <code>id</code> = 1</em></tt></p>

<p><tt><em>SQL (0.8ms) COMMIT</em></tt></p>

<p>You can also pass raw SQL to the <tt>lock</tt> method for allowing different types of locks. For example, MySQL has an expression called <tt>LOCK</tt><tt> </tt><tt>IN</tt><tt> </tt><tt>SHARE</tt><tt> </tt><tt>MODE</tt> <strong>where</strong><strong> </strong><strong>you</strong><strong> </strong><strong>can</strong><strong> </strong><strong>lock</strong><strong> </strong><strong>a</strong><strong> </strong><strong>record</strong><strong> </strong><strong>but</strong><strong> </strong><strong>still</strong><strong> </strong><strong>allow</strong><strong> </strong><strong>other</strong><strong> </strong><strong>queries</strong><strong> </strong><strong>to</strong><strong> </strong><strong>read</strong><strong> </strong><strong>it</strong>. To specify this expression just pass it in as the lock option:</p>

<p><tt><em>Item.transaction do</em></tt></p>

<p><tt> </tt><tt><em>i = Item.lock(&ldquo;LOCK IN SHARE MODE&rdquo;).find(1)</em></tt></p>

<p><tt> </tt><tt><em>i.increment!(:views)</em></tt></p>

<p><tt><em>end</em></tt></p>

<h3><a name="joining-tables"></a>11 Joining Tables</h3>


<p>Active Record provides a finder method called <tt>joins</tt> for specifying <tt>JOIN</tt> clauses<span style="font-family: DejaVu Sans;">短语</span>on the resulting SQL. There are multiple ways to use the <tt>joins</tt> method.</p>

<h4><a name="using-a-string-sql-fragment"></a>11.1 Using a String SQL Fragment</h4>


<p>You can just supply the raw SQL specifying the <tt><strong>JOIN</strong></tt><strong> </strong>clause to <tt>joins</tt>:</p>

<p><tt><em>Client.joins(&lsquo;LEFT OUTER JOIN addresses ON addresses.client_id = clients.id&rsquo;)</em></tt></p>

<p>This will result in the following SQL:</p>

<p><tt><em>SELECT clients.* FROM clients LEFT OUTER JOIN addresses ON addresses.client_id = clients.id</em></tt></p>

<h4><a name="using-array-hash-of-named-associations"></a> 11.2 Using Array/Hash of Named Associations</h4>


<p><span style="color: #800000;">This</span><span style="color: #800000;">method</span><span style="color: #800000;">only</span><span style="color: #800000;">works</span><span style="color: #800000;">with</span><tt><span style="color: #800000;">INNER</span></tt><tt></tt><tt><span style="color: #800000;">JOIN</span></tt><span style="color: #800000;">.</span></p>

<p>Active Record lets you use the names of the <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/association_basics.html">associations</a></span></span> defined on the model as a shortcut for specifying <tt>JOIN</tt> clause for those associations when using the <tt>joins</tt> method.</p>

<p>For example, consider the following <tt>Category</tt>, <tt>Post</tt>, <tt>Comments</tt> and <tt>Guest</tt> models:</p>

<p><tt><em>class Category &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>has_many :posts</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>class Post &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>belongs_to :category</em></tt></p>

<p><tt> </tt><tt><em>has_many :comments</em></tt></p>

<p><tt> </tt><tt><em>has_many :tags</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>class Comment &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>belongs_to :post</em></tt></p>

<p><tt> </tt><tt><em>has_one :guest</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>class Guest &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>belongs_to :comment</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>class Tag &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>belongs_to :post</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>Now all of the following will produce the expected join queries using <tt>INNER</tt><tt> </tt><tt>JOIN</tt>:</p>

<h5><a name="joining-a-single-association"></a>11.2.1 Joining a Single Association</h5>


<p><tt><em>Category.joins(:posts)</em></tt></p>

<p>This produces:</p>

<p><tt><em>SELECT categories.* FROM categories</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN posts ON posts.category_id = categories.id</em></tt></p>

<p>Or, in English: “return a Category object for <strong>all</strong><strong> </strong><strong>categories</strong><strong> </strong><strong>with</strong><strong> </strong><strong>posts</strong>”. Note that you will see duplicate categories if more than one post has the same category. If you want unique<span style="font-family: DejaVu Sans;">唯一的</span>categories, you can use Category.joins(:post).select(“distinct(categories.id)”).</p>

<p><span style="font-family: DejaVu Sans;">或者，用英语说：<span style="font-family: Liberation Serif,Times New Roman,serif;">“</span>返回所有</span>posts<span style="font-family: DejaVu Sans;">的所有</span>categories<span style="font-family: DejaVu Sans;">到</span>Category<span style="font-family: DejaVu Sans;">对象<span style="font-family: Liberation Serif,Times New Roman,serif;">”</span>。请注意，如果超过一个</span>post<span style="font-family: DejaVu Sans;">具有相同的</span>categories<span style="font-family: DejaVu Sans;">，你会看到重复的</span>categories<span style="font-family: DejaVu Sans;">。如果你想要唯一的</span>categories<span style="font-family: DejaVu Sans;">，你可以使用</span>Category.joins(:post).select(“distinct(categories.id)”)<span style="font-family: DejaVu Sans;">。</span></p>

<h5><a name="joining-multiple-associations"></a>11.2.2 Joining Multiple Associations</h5>


<p><tt><em>Post.joins(:category, :comments)#</em></tt><span style="font-family: DejaVu Sans;"><tt><em>两个参数之间是与关系</em></tt></span></p>

<p>This produces:</p>

<p><tt><em>SELECT posts.* FROM posts</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN categories ON posts.category_id = categories.id</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN comments ON comments.post_id = posts.id</em></tt></p>

<p>Or, in English: “return all posts that have a category and at<strong> </strong><strong>least</strong><strong> </strong><strong>one</strong><strong> </strong><strong>comment</strong>”. Note again that posts with multiple comments will show up multiple times.</p>

<h5><a name="joining-nested-associations-single-level"></a> 11.2.3 Joining Nested Associations (Single Level)</h5>


<p>&nbsp;</p>

<p><tt><em>Post.joins(:comments =&gt; :guest)</em></tt></p>

<p>This produces:</p>

<p><tt><em>SELECT posts.* FROM posts</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN comments ON comments.post_id = posts.id</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN guests ON guests.comment_id = comments.id</em></tt></p>

<p>Or, in English: “return all posts that have<strong> </strong><strong>a</strong><strong> </strong><strong>comment</strong><strong> </strong><strong>made</strong><strong> </strong><strong>by</strong><strong> </strong><strong>a</strong><strong> </strong><strong>guest</strong>.”</p>

<h5><a name="joining-nested-associations-multiple-lev"></a> 11.2.4 Joining Nested Associations (Multiple Level)</h5>


<p><tt><em>Category.joins(:posts =&gt; [{:comments =&gt; :guest}, :tags])</em></tt></p>

<p>This produces:</p>

<p><tt><em>SELECT categories.* FROM categories</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN posts ON posts.category_id = categories.id</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN comments ON comments.post_id = posts.id</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN guests ON guests.comment_id = comments.id</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN tags ON tags.post_id = posts.id</em></tt></p>

<p><span style="font-family: DejaVu Sans;">返回</span>post<span style="font-family: DejaVu Sans;">的</span>category<span style="font-family: DejaVu Sans;">，并且这个</span>post<span style="font-family: DejaVu Sans;">至少有一个</span>commit<span style="font-family: DejaVu Sans;">是</span>guest<span style="font-family: DejaVu Sans;">提交而且这个</span>post<span style="font-family: DejaVu Sans;">至少有一个</span>tag<span style="font-family: DejaVu Sans;">。</span></p>

<h4><a name="specifying-conditions-on-the-joined-tabl"></a> 11.3 Specifying Conditions on the Joined Tables</h4>


<p>You can specify conditions on the joined tables using the regular <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/active_record_querying.html#array-conditions">Array</a></span></span> and <span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/active_record_querying.html#pure-string-conditions">String</a></span></span> conditions. <a href="http://guides.rubyonrails.org/active_record_querying.html#hash-conditions"><span style="color: #000080;"><span style="text-decoration: underline;">Hash</span></span><span style="color: #000080;"><span style="text-decoration: underline;">conditions</span></span></a> provides a special syntax for specifying conditions for the joined tables:</p>

<p><span style="font-family: DejaVu Sans;">你可以在</span>joined tables <span style="font-family: DejaVu Sans;">的时候通过使用正则数组和字符串条件（表达式）来指定条件。</span>Hash<span style="font-family: DejaVu Sans;">条件提供了一个特殊的语法来指定</span>joined tables<span style="font-family: DejaVu Sans;">的条件：</span></p>

<p><tt><em>time_range = (Time.now.midnight &ndash; 1.day)..Time.now.midnight</em></tt></p>

<p><tt><em>Client.joins(:orders).where(&lsquo;orders.created_at&rsquo; =&gt; time_range)</em></tt></p>

<p>An alternative and cleaner syntax is to nest the hash conditions:<span style="font-family: DejaVu Sans;">一个更简洁的替代语法是将条件嵌入</span>Hash<span style="font-family: DejaVu Sans;">条件中。</span></p>

<p><tt><em>time_range = (Time.now.midnight &ndash; 1.day)..Time.now.midnight</em></tt></p>

<p><tt><em>Client.joins(:orders).where(:orders =&gt; {:created_at =&gt; time_range})</em></tt></p>

<p>This will find all clients who have orders that were created yesterday, again using a <tt>BETWEEN</tt> SQL expression.<span style="font-family: DejaVu Sans;">这将会查找所有的</span>clients<span style="font-family: DejaVu Sans;">，它们都有</span>orders<span style="font-family: DejaVu Sans;">并且，</span>order<span style="font-family: DejaVu Sans;">在昨天创建，再一次使用</span>BETWEEN SQL<span style="font-family: DejaVu Sans;">语句。</span></p>

<h3><a name="eager-loading-associations"></a>12 Eager Loading Associations</h3>


<p>Eager loading<span style="font-family: DejaVu Sans;">快速导入</span>is the mechanism for loading the associated records of the objects returned by <tt>Model.find</tt> using as few queries as possible.</p>

<p>Eager loading<span style="font-family: DejaVu Sans;">快速导入是一个导入记录的关系的机器，它通过</span><tt>Model.find</tt><span style="font-family: DejaVu Sans;"><tt>返回对象，并使用尽可能少的查询。</tt></span></p>

<p><strong>N</strong><strong> </strong><strong>+</strong><strong> </strong><strong>1</strong><strong> </strong><strong>queries</strong><strong> </strong><strong>problem</strong></p>

<p>Consider the following code, which finds 10 clients and prints their postcodes:</p>

<p><tt><em>clients = Client.limit(10)</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>clients.each do |client|</em></tt></p>

<p><tt> </tt><tt><em>puts client.address.postcode</em></tt></p>

<p><tt><em>end</em></tt></p>

<p><strong>This</strong><strong> </strong><strong>code</strong><strong> </strong><strong>looks</strong><strong> </strong><strong>fine</strong><strong> </strong><strong>at</strong><strong> </strong><strong>the</strong><strong> </strong><strong>first</strong><strong> </strong><strong>sight</strong>. But the problem lies within the total number of queries executed. The above code executes 1 ( to find 10 clients ) + 10 ( one per each client to load the address ) = <strong>11</strong> queries in total.<span style="font-family: DejaVu Sans;">上面的代码执行一次（找到</span>10<span style="font-family: DejaVu Sans;">个</span>clients<span style="font-family: DejaVu Sans;">）</span>+10<span style="font-family: DejaVu Sans;">（每一个</span>client<span style="font-family: DejaVu Sans;">导入地址）</span></p>

<p><strong>Solution</strong><strong> </strong><strong>to</strong><strong> </strong><strong>N</strong><strong> </strong><strong>+</strong><strong> </strong><strong>1</strong><strong> </strong><strong>queries</strong><strong> </strong><strong>problem</strong></p>

<p>Active Record lets you specify in advance all the associations that are going to be loaded. This is possible by specifying the <tt>includes</tt> method of the <tt>Model.find</tt> call. With <tt>includes</tt>, Active Record ensures that all of the specified associations are loaded using the minimum possible number of queries.</p>

<p>Revisiting the above case, we could rewrite <tt>Client.all</tt> to use eager load addresses:</p>

<p><tt><em>clients = Client.includes(:address).limit(10)</em></tt></p>

<p>&nbsp;</p>

<p><tt><em>clients.each do |client|</em></tt></p>

<p><tt> </tt><tt><em>puts client.address.postcode</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>The above code will execute just <strong>2</strong> queries, as opposed to <strong>11</strong> queries in the previous case:</p>

<p><span style="font-family: DejaVu Sans;">上面的代码将执行</span>2<span style="font-family: DejaVu Sans;">查询，而不是在以前的情况下，以</span>11<span style="font-family: DejaVu Sans;">查询：</span></p>

<p><tt><em>SELECT * FROM clients LIMIT 10</em></tt></p>

<p><tt><em>SELECT addresses.* FROM addresses</em></tt></p>

<p><tt> </tt><tt><em>WHERE (addresses.client_id IN (1,2,3,4,5,6,7,8,9,10))</em></tt></p>

<h4><a name="eager-loading-multiple-associations"></a> 12.1 Eager Loading Multiple Associations</h4>


<p>Active Record lets you eager load any number of associations with a single <tt>Model.find</tt> call by using an array, hash, or a nested hash of array/hash with the <tt>includes</tt> method.</p>

<p>Active Record<span style="font-family: DejaVu Sans;">可以通过</span>includes<span style="font-family: DejaVu Sans;">方法加上数组，</span>hash<span style="font-family: DejaVu Sans;">或者使用数组和</span>hash<span style="font-family: DejaVu Sans;">嵌套的</span>hash<span style="font-family: DejaVu Sans;">字典调用单个</span><tt>Model.find</tt><span style="font-family: DejaVu Sans;"><tt>方法快速导入任何数目的关系。</tt></span></p>

<h5><a name="array-of-multiple-associations"></a>12.1.1 Array of Multiple Associations</h5>


<p><tt><em>Post.includes(:category, :comments)</em></tt></p>

<p>This loads all the posts and the associated category and comments for each post.</p>

<h5><a name="nested-associations-hash"></a>12.1.2 Nested Associations Hash</h5>


<p><tt><em>Category.includes(:posts =&gt; [{:comments =&gt; :guest}, :tags]).find(1)</em></tt></p>

<p>This will find the <strong>category</strong><strong> </strong><strong>with</strong><strong> </strong><strong>id</strong><strong> </strong><strong>1</strong> and <strong>eager</strong><strong> </strong><strong>load</strong> all of the associated posts<span style="font-family: DejaVu Sans;">以及快速导入分类为</span>id<span style="font-family: DejaVu Sans;">为</span>1<span style="font-family: DejaVu Sans;">的</span>post, the associated posts’ tags and comments<span style="font-family: DejaVu Sans;">和</span>post<span style="font-family: DejaVu Sans;">的</span>tags<span style="font-family: DejaVu Sans;">和</span>comments, and every comment’s guest association<span style="font-family: DejaVu Sans;">并且每个</span>comments<span style="font-family: DejaVu Sans;">是由</span>guest<span style="font-family: DejaVu Sans;">创建的</span>.</p>

<h4><a name="specifying-conditions-on-eager-loaded-as"></a> 12.2 Specifying Conditions on Eager Loaded Associations</h4>


<p>Even though Active Record lets you specify conditions on the eager loaded associations just like <tt>joins</tt>, <strong>the</strong><strong> </strong><strong>recommended</strong><strong> </strong><strong>way</strong><strong> </strong><strong>is</strong><strong> </strong><strong>to</strong><strong> </strong><strong>use</strong><strong> </strong><span style="color: #000080;"><span style="text-decoration: underline;"><a href="http://guides.rubyonrails.org/active_record_querying.html#joining-tables"><strong>joins</strong></a></span></span><strong> </strong><strong>instead.</strong></p>

<p>However if you must do this, you may use <tt>where</tt> as you would normally.</p>

<p><tt><em>Post.includes(:comments).where(&ldquo;comments.visible&rdquo;, true)</em></tt></p>

<p>This would generate a query which contains a <tt>LEFT</tt><tt> </tt><tt>OUTER</tt><tt> </tt><tt>JOIN</tt> whereas the <tt>joins</tt> method would generate one using the <tt>INNER</tt><tt> </tt><tt>JOIN</tt> function instead.</p>

<p><tt><em>SELECT &ldquo;posts&rdquo;.&ldquo;id&rdquo; AS t0_r0, &hellip; &ldquo;comments&rdquo;.&ldquo;updated_at&rdquo; AS t1_r5 FROM &ldquo;posts&rdquo; LEFT OUTER JOIN &ldquo;comments&rdquo; ON &ldquo;comments&rdquo;.&ldquo;post_id&rdquo; = &ldquo;posts&rdquo;.&ldquo;id&rdquo; WHERE (comments.visible = 1)</em></tt></p>

<p>If there was no <tt>where</tt> condition, this would generate the normal set of two queries.</p>

<p>If, in the case of this <tt>includes</tt> query,<strong> </strong><strong>there</strong><strong> </strong><strong>were</strong><strong> </strong><strong>no</strong><strong> </strong><strong>comments</strong><strong> </strong><strong>for</strong><strong> </strong><strong>any</strong><strong> </strong><strong>posts</strong>, all the posts would <strong>still</strong><strong> </strong><strong>be</strong><strong> </strong><strong>loaded</strong>. <span style="color: #800000;">By</span><span style="color: #800000;">using</span><tt><span style="color: #800000;">joins</span></tt> (an INNER JOIN), the join conditions <strong>must</strong> match, <strong>otherwise</strong><strong> </strong><strong>no</strong><strong> </strong><strong>records</strong><strong> </strong><strong>will</strong><strong> </strong><strong>be</strong><strong> </strong><strong>returned.</strong></p>

<h3><a name="scopes"></a>13 Scopes<span style="font-family: WenQuanYi Micro Hei;">作用域</span></h3>


<p>Scoping allows you to specify commonly-used ARel<span style="font-family: DejaVu Sans;">（</span>Arel is a relational algebra engine for Ruby</p>

<p><span style="font-family: DejaVu Sans;">） </span>queries which can be referenced as method calls on the association objects or models. With these scopes, you can use every method previously covered such as <tt>where</tt>, <tt>joins</tt> and <tt>includes</tt>. All scope methods will return an <tt>ActiveRecord::Relation</tt> object which will allow for further methods (such as other scopes) to be called on it.</p>

<p><span style="font-family: DejaVu Sans;">作用域允许你指定通常使用的</span>Arel<span style="font-family: DejaVu Sans;">（</span>Arel<span style="font-family: DejaVu Sans;">是一个用于</span>Ruby<span style="font-family: DejaVu Sans;">的关系代数引擎）查询它可以在对象或模型调用方法的时候被引用。通过这些作用域，你可以使用比如</span>where<span style="font-family: DejaVu Sans;">，</span>joins<span style="font-family: DejaVu Sans;">和</span>includes<span style="font-family: DejaVu Sans;">这些方法覆盖以前的（方法）。所有的</span>scope<span style="font-family: DejaVu Sans;">方法将会返回一个 </span><tt>ActiveRecord::Relation</tt><span style="font-family: DejaVu Sans;"><tt>对象它将允许一些以后的方法（例如其他的作用域）被其调用。</tt></span></p>

<p>To define a simple scope, we use the <tt>scope</tt> method inside the class, passing the ARel query that we’d like run when this scope is called:</p>

<p><tt><em>class Post &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>scope :published, where(:published =&gt; true)</em></tt></p>

<p><tt><em>end</em></tt></p>

<p><tt><em>Just like before, these methods are also chainable</em></tt><span style="font-family: DejaVu Sans;"><tt><em>可链式的</em></tt></span><tt><em>:</em></tt></p>

<p><tt><em>class Post &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>scope :published, where(:published =&gt; true).joins(:category)</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>Scopes are also chainable within scopes:<span style="font-family: DejaVu Sans;">作用域对作用域中也是可链式的：</span></p>

<p><tt><em>class Post &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>scope :published, where(:published =&gt; true)</em></tt></p>

<p><tt> </tt><tt><em>scope :published_and_commented, published.and(self.arel_table[:comments_count].gt(0))</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>To call this <tt>published</tt> scope we can call it on either the class:<span style="font-family: DejaVu Sans;">调用这个</span>published<span style="font-family: DejaVu Sans;">作用域我们可以在类中调用：</span></p>

<p><tt><em>Post.published =&gt; [published posts]</em></tt></p>

<p>Or on an association consisting of <tt>Post</tt> objects:<span style="font-family: DejaVu Sans;">或者是在组成</span>Post<span style="font-family: DejaVu Sans;">对象的关系（成员）中调用：</span></p>

<p><tt><em>category = Category.first</em></tt></p>

<p><tt><em>category.posts.published =&gt; [published posts belonging to this category]</em></tt></p>

<h4><a name="working-with-times"></a>13.1 Working with times<span style="font-family: WenQuanYi Micro Hei;">工作中的时间（字段）</span></h4>


<p>If you’re working with dates or times within scopes, due to how they are evaluated, you will need to use a lambda so that the scope is evaluated every time.</p>

<p><span style="font-family: DejaVu Sans;">如果你在工作中遇到时间（字段）或者包含有时间（字段）的作用域，由于他们的求值方式，你将需要使用一个匿名函数来使得每次调用域都会计算时间的值。</span></p>

<p><tt><em>class Post &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>scope :last_week, lambda { where(&ldquo;created_at &lt; ?&rdquo;, Time.zone.now ) }</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>Without the <tt>lambda</tt>, this <tt>Time.zone.now</tt> will only be called once.</p>

<h4><a name="passing-in-arguments"></a>13.2 Passing in arguments</h4>


<p>When a <tt>lambda</tt> is used for a <tt>scope</tt>, it can take arguments:</p>

<p><tt><em>class Post &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>scope :1_week_before, lambda { |time| where(&ldquo;created_at &lt; ?&rdquo;, time)</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>This may then be called using this:</p>

<p><tt><em>Post.1_week_before(Time.zone.now)</em></tt></p>

<p>However, this is just duplicating<span style="font-family: DejaVu Sans;">复制 </span>the functionality<span style="font-family: DejaVu Sans;">功能 </span>that would be provided to you by a class method.<span style="font-family: DejaVu Sans;">然而，这样仅仅通过一个类方法提供给来复制（使用）这个功能。</span></p>

<p><tt><em>class Post &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>def self.1_week_before(time)</em></tt></p>

<p><tt> </tt><tt><em>where(&ldquo;created_at &lt; ?&rdquo;, time)</em></tt></p>

<p><tt> </tt><tt><em>end</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>Using a class method is the preferred way to accept arguments for scopes. These methods will still be accessible<span style="font-family: DejaVu Sans;">访问 </span>on the association objects:</p>

<p><span style="font-family: DejaVu Sans;">使用一个类方法是一个完美的方法来让</span>scopes<span style="font-family: DejaVu Sans;">获取参数。这个方法仍然访问</span>objects<span style="font-family: DejaVu Sans;">的</span>association<span style="font-family: DejaVu Sans;">。</span></p>

<p><tt><em>category.posts.1_week_before(time)</em></tt></p>

<h4><a name="working-with-scopes"></a>13.3 Working with scopes<span style="font-family: WenQuanYi Micro Hei;">使用作用域来工作</span></h4>


<p>Where a relational object is required, the <tt>scoped</tt> method may come in handy. This will return an <tt>ActiveRecord::Relation</tt> object which can have further scoping applied to it afterwards. A place where this may come in handy is on associations</p>

<p><tt><em>client = Client.find_by_first_name(&ldquo;Ryan&rdquo;)</em></tt></p>

<p><tt><em>orders = client.orders.scoped</em></tt></p>

<p>With this new <tt>orders</tt> object, we are able to ascertain that this object can have more scopes applied to it. For instance,<strong> if we wanted to return orders only in the last 30 days at a later point</strong>.</p>

<p><tt><em>orders.where(&ldquo;created_at &gt; ?&rdquo;, 30.days.ago)</em></tt></p>

<h4><a name="applying-a-default-scope"></a>13.4 Applying a default scope</h4>


<p>If we wish for <strong>a scope</strong> to be <strong>applied</strong> across <strong>all queries</strong><span style="font-family: DejaVu Sans;"><strong>所有查询</strong> </span>to the model we can use the <tt><strong>default_scope</strong></tt> method within the model itself.</p>

<p><tt><em>class Client &lt; ActiveRecord::Base</em></tt></p>

<p><tt> </tt><tt><em>default_scope where(&ldquo;removed_at IS NULL&rdquo;)</em></tt></p>

<p><tt><em>end</em></tt></p>

<p>When queries are executed on this model, the SQL query will now look something like this:</p>

<p><tt><em>SELECT * FROM clients WHERE removed_at IS NULL</em></tt></p>

<h4><a name="removing-all-scoping"></a>13.5 Removing all scoping</h4>


<p>If we wish to remove scoping for any reason we can use the <tt>unscoped</tt> method. This is especially useful if a <tt>default_scope</tt> is specified in the model and should not be applied for this particular query.</p>

<p><tt><em>Client.unscoped.all</em></tt></p>

<p>This method removes all scoping and will do a normal query on the table.</p>

<h3><a name="dynamic-finders"></a>14 Dynamic Finders<span style="font-family: WenQuanYi Micro Hei;">动态查询</span></h3>


<p>For every field (also known as an attribute) you define in your table, Active Record provides a finder method. If you have a field called <tt>first_name</tt> on your <tt>Client</tt> model for example, you get <tt>find_by_first_name</tt> and <tt>find_all_by_first_name</tt> for free from Active Record. If you have a <tt>locked</tt> field on the <tt>Client</tt> model, you also get <tt>find_by_locked</tt> and <tt>find_all_by_locked</tt> methods.</p>

<p><span style="font-family: DejaVu Sans;">在你表中定义的每个</span>field<span style="font-family: DejaVu Sans;">（通常被看着一个属性）， </span>Active Record<span style="font-family: DejaVu Sans;">都提供了一个</span>finder<span style="font-family: DejaVu Sans;">方法。例如，如果你有一个</span>field<span style="font-family: DejaVu Sans;">名叫</span>first_name<span style="font-family: DejaVu Sans;">在你的</span>Client<span style="font-family: DejaVu Sans;">模型中，你会免费的从</span>Active Record <span style="font-family: DejaVu Sans;">得到</span>find_by_first_name<span style="font-family: DejaVu Sans;">和</span>find_all_by_first_name<span style="font-family: DejaVu Sans;">方法。如果你在</span>Client<span style="font-family: DejaVu Sans;">模型中有一个</span>locked field<span style="font-family: DejaVu Sans;">，你也会获得</span>find_by_locked<span style="font-family: DejaVu Sans;">和</span>find_all_by_locked<span style="font-family: DejaVu Sans;">方法。</span></p>

<p>You can also use <tt>find_last_by_*</tt> methods which will find the last record matching your argument.</p>

<p><span style="font-family: DejaVu Sans;"><strong>你也可以使用</strong></span><strong>find_last_by_*</strong><span style="font-family: DejaVu Sans;"><strong>方法，它将会查找在机器中匹配你的参数的最后的记录。</strong></span></p>

<p>You can specify an exclamation point (<tt>!</tt>) on the end of the dynamic finders to get them to raise an <tt>ActiveRecord::RecordNotFound</tt> error if they do not return any records, like <tt>Client.find_by_name!(&ldquo;Ryan&rdquo;)</tt></p>

<p><span style="font-family: DejaVu Sans;">你也可以在动态</span>finders<span style="font-family: DejaVu Sans;">末尾指定一个感叹号来来的到查询结果或者如果他们没有返回任何参数则抛出一个 </span><tt>ActiveRecord::RecordNotFound</tt><span style="font-family: DejaVu Sans;"><tt>错误。</tt></span></p>

<p><strong>If you want to find both by name and locked</strong>, you can chain these finders together by simply typing <tt>and</tt> between the fields. For example, <tt>Client.find_by_first_name_and_locked(&ldquo;Ryan&rdquo;, true).</tt></p>

<p><span style="color: #800000;">Up to and including Rails 3.1, when the number of arguments passed to a dynamic finder method is lesser than the number of fields, say </span><tt><span style="color: #800000;">Client.find_by_name_and_locked(“Ryan”)</span></tt><span style="color: #800000;">, the behavior is to pass </span><tt><span style="color: #800000;">nil</span></tt><span style="color: #800000;"> as the missing argument.<span style="font-family: DejaVu Sans;">如果参数少于动态</span></span><span style="color: #800000;">finder<span style="font-family: DejaVu Sans;">的</span></span><span style="color: #800000;">fields<span style="font-family: DejaVu Sans;">的数目，习惯上是对缺少的</span></span><span style="color: #800000;">fields<span style="font-family: DejaVu Sans;">传递一个</span></span><span style="color: #800000;">nil<span style="font-family: DejaVu Sans;">。 </span></span><span style="color: #800000;">This is </span><strong><span style="color: #800000;">unintentional</span></strong><span style="color: #800000;"> and this behavior will be changed in Rails 3.2 to throw an </span><tt><span style="color: #800000;">ArgumentError</span></tt><span style="color: #800000;">.<span style="font-family: DejaVu Sans;">这样做是没有意义的并且这个约定将会在</span></span><span style="color: #800000;">Rails 3.2<span style="font-family: DejaVu Sans;">中修改成抛出一个 </span></span><tt><span style="color: #800000;">ArgumentError</span></tt><span style="font-family: DejaVu Sans;"><tt><span style="color: #800000;">错误。</span></tt></span></p>

<p>There’s another set of dynamic finders that let you find or create/initialize objects if they aren’t found. These work in a similar fashion to the other finders and can be used like <tt>find_or_create_by_first_name(params[:first_name])</tt>. Using this will first perform a find and then create if the find returns <tt>nil</tt>. The SQL looks like this for <tt>Client.find_or_create_by_first_name(&ldquo;Ryan&rdquo;)</tt>:</p>

<p>&nbsp;</p>

<p><tt><em>SELECT * FROM clients WHERE (clients.first_name = &lsquo;Ryan&rsquo;) LIMIT 1</em></tt></p>

<p><tt><em>BEGIN</em></tt></p>

<p><tt><em>INSERT INTO clients (first_name, updated_at, created_at, orders_count, locked)</em></tt></p>

<p><tt> </tt><tt><em>VALUES(&lsquo;Ryan&rsquo;, &lsquo;2008-09-28 15:39:12&rsquo;, &lsquo;2008-09-28 15:39:12&rsquo;, 0, &lsquo;0&rsquo;)</em></tt></p>

<p><tt><em>COMMIT</em></tt></p>

<p><tt><em>irb(main):134:0&gt; p=Post.find_or_create_by_name_and_title_and_content(&lsquo;1111111&rsquo;,&lsquo;111111111&rsquo;,&lsquo;11111111&rsquo;)</em></tt></p>

<p><tt> </tt><tt><em>Post Load (0.4ms) SELECT &ldquo;posts&rdquo;.* FROM &ldquo;posts&rdquo; WHERE &ldquo;posts&rdquo;.&ldquo;title&rdquo; = &lsquo;111111111&rsquo; AND &ldquo;posts&rdquo;.&ldquo;content&rdquo; = &lsquo;11111111&rsquo; AND &ldquo;posts&rdquo;.&ldquo;name&rdquo; = &lsquo;1111111&rsquo; LIMIT 1</em></tt></p>

<p><tt> </tt><tt><em>SQL (429.0ms) INSERT INTO &ldquo;posts&rdquo; (&ldquo;content&rdquo;, &ldquo;created_at&rdquo;, &ldquo;name&rdquo;, &ldquo;title&rdquo;, &ldquo;updated_at&rdquo;) VALUES (?, ?, ?, ?, ?) [[&ldquo;content&rdquo;, &ldquo;11111111&rdquo;], [&ldquo;created_at&rdquo;, Fri, 02 Dec 2011 08:42:39 UTC +00:00], [&ldquo;name&rdquo;, &ldquo;1111111&rdquo;], [&ldquo;title&rdquo;, &ldquo;111111111&rdquo;], [&ldquo;updated_at&rdquo;, Fri, 02 Dec 2011 08:42:39 UTC +00:00]]</em></tt></p>

<p><tt><em>=&gt; #&lt;Post id: 5, name: &ldquo;1111111&rdquo;, title: &ldquo;111111111&rdquo;, content: &ldquo;11111111&rdquo;, created_at: &ldquo;2011-12-02 08:42:39&rdquo;, updated_at: &ldquo;2011-12-02 08:42:39&rdquo;&gt;</em></tt></p>

<p>&nbsp;</p>

<p><tt>find_or_create</tt>’s sibling, <tt>find_or_initialize</tt>, will find an object and if it does not exist will act similarly to calling <tt>new</tt> with the arguments you passed in. For example:</p>

<p>client = Client.find_or_initialize_by_first_name(&lsquo;Ryan&rsquo;)</p>

<p>will either assign an existing client object with the name “Ryan” to the client local variable, or initialize a new object similar to calling <tt>Client.new(:first_name =&gt; &lsquo;Ryan&rsquo;)</tt>. From here, you can modify other fields in client by calling the attribute setters on it: <tt>client.locked = true</tt> and when you want to write it to the database just call <tt>save</tt> on it.</p>

<h3><a name="finding-by-sql"></a>15 Finding by SQL</h3>


<p>If you’d like to use your own SQL to find records in a table you can use <tt>find_by_sql</tt>. The <tt>find_by_sql</tt> method will return an array of objects even if the underlying query returns just a single record. For example you could run this query:</p>

<p><tt><em>Client.find_by_sql(&ldquo;SELECT * FROM clients</em></tt></p>

<p><tt> </tt><tt><em>INNER JOIN orders ON clients.id = orders.client_id</em></tt></p>

<p><tt> </tt><tt><em>ORDER clients.created_at desc&#8221;)</em></tt></p>

<p><tt>find_by_sql</tt> provides you with a simple way of making custom calls to the database and retrieving instantiated objects.</p>

<h3><a name="select_all"></a>16 <tt>select_all</tt></h3>


<p><tt>find_by_sql</tt> has a close relative called <tt>connection#select_all</tt>. <tt>select_all</tt> will retrieve objects from the database using custom SQL just like <tt>find_by_sql</tt> but will not instantiate them. Instead, you will get an array of hashes where each hash indicates<span style="font-family: DejaVu Sans;">指示 </span>a record.</p>

<p><tt><em>Client.connection.select_all(&ldquo;SELECT * FROM clients WHERE id = &lsquo;1&rsquo;&rdquo;)</em></tt></p>

<h3><tt><span style="color: #000000;">15</span></tt><span style="font-family: WenQuanYi Micro Hei;"><tt><span style="color: #000000;">和</span></tt></span><tt><span style="color: #000000;">16 </span></tt><span style="font-family: WenQuanYi Micro Hei;"><tt><span style="color: #000000;">综合比较</span></tt></span></h3>


<p><tt><em>irb(main):174:0&gt; p=Post.find_by_sql(&ldquo;SELECT * FROM posts WHERE (posts.id = 1)&rdquo;) Post Load (1.7ms) SELECT * FROM posts WHERE (posts.id = 1)</em></tt></p>

<p><tt><em>=&gt; [#&lt;Post id: 1, name: &ldquo;name111111111111111&rdquo;, title: &ldquo;title111111111111111&rdquo;, content: &ldquo;content111111111111111&rdquo;, created_at: &ldquo;2011-12-02 08:56:33&rdquo;, updated_at: &ldquo;2011-12-02 08:56:33&rdquo;&gt;] </em></tt></p>

<p><tt><em>irb(main):175:0&gt; puts p</em></tt></p>

<p><tt><em>#&lt;Post:0xb6bf4d64&gt;</em></tt></p>

<p><tt><em>=&gt; nil</em></tt></p>

<p><tt><em>irb(main):176:0&gt; p=Post.connection.select_all(&ldquo;SELECT * FROM posts WHERE id = &lsquo;1&rsquo;&rdquo;)</em></tt></p>

<p><tt> </tt><tt><em>(0.6ms) SELECT * FROM posts WHERE id = &lsquo;1&rsquo;</em></tt></p>

<p><tt><em>=&gt; [{&ldquo;name&rdquo;=&gt;&ldquo;name111111111111111&rdquo;, &ldquo;created_at&rdquo;=&gt;&ldquo;2011-12-02 08:56:33.397313&rdquo;, &ldquo;title&rdquo;=&gt;&ldquo;title111111111111111&rdquo;, &ldquo;updated_at&rdquo;=&gt;&ldquo;2011-12-02 08:56:33.397313&rdquo;, &ldquo;id&rdquo;=&gt;1, &ldquo;content&rdquo;=&gt;&ldquo;content111111111111111&rdquo;}]</em></tt></p>

<p><tt><em>irb(main):177:0&gt; puts p</em></tt></p>

<p><tt><em>namename111111111111111created_at2011-12-02 08:56:33.397313titletitle111111111111111updated_at2011-12-02 08:56:33.397313id1contentcontent111111111111111</em></tt></p>

<p><tt><em>=&gt; nil</em></tt></p>

<h3><a name="existence-of-objects"></a>17 Existence of Objects<span style="font-family: WenQuanYi Micro Hei;">目标是否存在</span></h3>


<p>If you simply want to check for the existence of the object there’s a method called <tt>exists?</tt>. This method will query the database using the same query as <tt>find</tt>, but instead of returning an object or collection of objects it will return either <tt>true</tt> or <tt>false</tt>.</p>

<p><tt><em>Client.exists?(1)</em></tt></p>

<p>The <tt>exists?</tt> method also takes multiple ids, but the catch is that it will return true if any one of those records exists.</p>

<p><tt><em>Client.exists?(1,2,3)</em></tt></p>

<p><tt><em># or</em></tt></p>

<p><tt><em>Client.exists?([1,2,3])</em></tt></p>

<p>It’s even possible to use <tt>exists?</tt> without any arguments on a model or a relation.</p>

<p><tt><em>Client.where(:first_name =&gt; &lsquo;Ryan&rsquo;).exists?</em></tt></p>

<p>The above returns <tt>true</tt> if there is at least one client with the <tt>first_name</tt> ‘Ryan’ and <tt>false</tt> otherwise.</p>

<p><tt><em>Client.exists?</em></tt></p>

<p><strong>The above returns </strong><tt><strong>false</strong></tt><strong> if the </strong><tt><strong>clients</strong></tt><strong> table is empty and </strong><tt><strong>true</strong></tt><strong> otherwise.</strong></p>

<p>You can also use <tt>any?</tt> and <tt>many?</tt> to check for existence on a model or relation.</p>

<p><tt><em># via a model</em></tt></p>

<p><tt><em>Post.any?</em></tt></p>

<p><tt><em>Post.many?</em></tt></p>

<p>&nbsp;</p>

<p><tt><em># via a named scope</em></tt></p>

<p><tt><em>Post.recent.any?</em></tt></p>

<p><tt><em>Post.recent.many?</em></tt></p>

<p>&nbsp;</p>

<p><tt><em># via a relation</em></tt></p>

<p><tt><em>Post.where(:published =&gt; true).any?</em></tt></p>

<p><tt><em>Post.where(:published =&gt; true).many?</em></tt></p>

<p>&nbsp;</p>

<p><tt><em># via an association</em></tt></p>

<p><tt><em>Post.first.categories.any?#</em></tt><span style="font-family: DejaVu Sans;"><tt><em>第一个</em></tt></span><tt><em>post</em></tt><span style="font-family: DejaVu Sans;"><tt><em>的</em></tt></span><tt><em>category</em></tt><span style="font-family: DejaVu Sans;"><tt><em>是否存在</em></tt></span></p>

<p><tt><em>Post.first.categories.many?</em></tt></p>

<h3><a name="calculations"></a>18 Calculations</h3>


<p>This section uses count as an example method in this preamble, but the options described apply to all sub-sections.</p>

<p>All calculation methods work directly on a model:</p>

<p><tt><em>Client.count</em></tt></p>

<p><tt><em># SELECT count(*) AS count_all FROM clients</em></tt></p>

<p>Or on a relation:</p>

<p><tt><em>Client.where(:first_name =&gt; &lsquo;Ryan&rsquo;).count</em></tt></p>

<p><tt><em># SELECT count(*) AS count_all FROM clients WHERE (first_name = &lsquo;Ryan&rsquo;)</em></tt></p>

<p><tt><em>Post.first.tags.count</em></tt></p>

<p>You can also use various finder methods on a relation for performing complex calculations:</p>

<p><tt><em>Client.includes(&ldquo;orders&rdquo;).where(:first_name =&gt; &lsquo;Ryan&rsquo;, :orders =&gt; {:status =&gt; &lsquo;received&rsquo;}).count</em></tt></p>

<p><tt><em>#Post.includes(&lsquo;tags&rsquo;).where(:id=&gt;&ldquo;2&rdquo;,:tags=&gt;{:name=&gt;&lsquo;123&rsquo;}).count</em></tt></p>

<p>Which will execute:</p>

<p><tt><em>SELECT count(DISTINCT clients.id) AS count_all FROM clients</em></tt></p>

<p><tt> </tt><tt><em>LEFT OUTER JOIN orders ON orders.client_id = client.id WHERE</em></tt></p>

<p><tt> </tt><tt><em>(clients.first_name = &lsquo;Ryan&rsquo; AND orders.status = &lsquo;received&rsquo;)</em></tt></p>

<h4><a name="count"></a>18.1 Count</h4>


<p>If you want to see how many records are in your model’s table you could call <tt>Client.count</tt> and that will return the number. If you want to be more specific and find all the clients with their age present in the database you can use <tt>Client.count(:age)</tt>.</p>

<p>For options, please see the parent section, <a href="http://guides.rubyonrails.org/active_record_querying.html#calculations">Calculations</a>.</p>

<h4><a name="average"></a>18.2 Average<span style="font-family: WenQuanYi Micro Hei;">平均值</span></h4>


<p>If you want to see the average of a certain number in one of your tables you can call the <tt>average</tt> method on the class that relates to the table. This method call will look something like this:</p>

<p><tt><em>Client.average(&ldquo;orders_count&rdquo;)</em></tt></p>

<p><tt><em>irb(main):215:0&gt; puts Post.average(&lsquo;created_at&rsquo;)</em></tt></p>

<p><tt> </tt><tt><em>(1.4ms) SELECT AVG(&ldquo;posts&rdquo;.&ldquo;created_at&rdquo;) AS avg_id FROM &ldquo;posts&rdquo; </em></tt></p>

<p><tt><em>2011.0</em></tt></p>

<h4><a name="minimum"></a>18.3 Minimum</h4>


<p>If you want to find the minimum value of a field in your table you can call the <tt>minimum</tt> method on the class that relates to the table. This method call will look something like this:</p>

<p><tt><em>Client.minimum(&ldquo;age&rdquo;)</em></tt></p>

<p>For options, please see the parent section, <a href="http://guides.rubyonrails.org/active_record_querying.html#calculations">Calculations</a>.</p>

<h4><a name="maximum"></a>18.4 Maximum</h4>


<p>If you want to find the maximum value of a field in your table you can call the <tt>maximum</tt> method on the class that relates to the table. This method call will look something like this:</p>

<p><tt><em>Client.maximum(&ldquo;age&rdquo;)</em></tt></p>

<p>For options, please see the parent section, <a href="http://guides.rubyonrails.org/active_record_querying.html#calculations">Calculations</a>.</p>

<h4><a name="sum1"></a>18.5 Sum</h4>


<p>If you want to find the sum of a field for all records in your table you can call the <tt>sum</tt> method on the class that relates to the table. This method call will look something like this:</p>

<p><a name="sum"></a><tt><em>Client.sum(&ldquo;orders_count&rdquo;)</em></tt></p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/14/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/12/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/08/tong-guo-mongodumphe-mongorestoreshi-xian-mongodbbei-fen-he-hui-fu-by-chenzhou123520/">通过mongodump和mongorestore实现Mongodb备份和恢复 &#8211;by Chenzhou123520</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/ruby-on-rails-4-dot-0-release-notes/">Ruby on Rails 4.0 Release Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/rails-active-record-named-scopes/">Rails Active Record Named Scopes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/27/shai-shai-wo-men-de-kai-yuan-xiang-mu-iteyekai-yuan-dai-ma/">晒晒我们的开源项目 ITEYE开源代码</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/26/single-sign-on-dan-dian-deng-lu-sso/">Single Sign-on 单点登录 Sso</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jhjguxin">@jhjguxin</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jhjguxin',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Francis Jiang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
